"use strict";var AH=Object.create;var Oa=Object.defineProperty;var OH=Object.getOwnPropertyDescriptor;var NH=Object.getOwnPropertyNames;var bH=Object.getPrototypeOf,yH=Object.prototype.hasOwnProperty;var a=(e,t)=>Oa(e,"name",{value:t,configurable:!0});var Te=(e,t)=>()=>(e&&(t=e(e=0)),t);var T=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),qe=(e,t)=>{for(var r in t)Oa(e,r,{get:t[r],enumerable:!0})},gR=(e,t,r,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of NH(t))!yH.call(e,n)&&n!==r&&Oa(e,n,{get:()=>t[n],enumerable:!(s=OH(t,n))||s.enumerable});return e};var M=(e,t,r)=>(r=e!=null?AH(bH(e)):{},gR(t||!e||!e.__esModule?Oa(r,"default",{value:e,enumerable:!0}):r,e)),Z=e=>gR(Oa({},"__esModule",{value:!0}),e);var OR=T((Wse,AR)=>{var IH=require("fast-glob"),{statSync:uE,existsSync:lE,readFileSync:wH,writeFileSync:CH}=require("fs"),{spawnSync:LH,spawn:DH,execFileSync:Kse}=require("child_process"),{isMainThread:UH}=require("worker_threads"),{join:Mn,relative:RR}=require("path"),{PACKAGE_ROOT:ts}=y(),{tmpdir:MH,platform:PH}=require("os");require("source-map-support").install();var vH=["resources","server","dataLayer","components"],Na="ts-build",_E,BH=__filename.endsWith("tsBuild.js");if(BH){if(UH){let r;try{uE(Mn(ts,Na)),r=!0}catch{}if(r)for(let s of IH.sync(vH.map(n=>n+"/**/*.ts"),{cwd:ts})){let n=0,i=0;try{n=uE(Mn(ts,s)).mtimeMs-5e3,i=uE(Mn(ts,Na,s.replace(/.ts$/,".js"))).mtimeMs}catch{}if(n>i){console.warn(`TypeScript ${s} is not compiled`+(i?` (TS source file was modified at ${new Date(n)} and compiled file at ${new Date(i)})`:"")+", consider enabling auto-compilation of TypeScript in your IDE), compiling now."),_E=!0;break}}else console.log("TypeScript modules are not compiled, compiling now"),_E=!0;if(_E){let s=Mn(ts,"node_modules/.bin/tsc");PH()==="win32"&&(s+=".cmd");let n=LH(s,{cwd:ts});if(n.stdout.length&&console.log(n.stdout.toString()),n.stderr.length&&console.log(n.stderr.toString()),r){let i=Mn(MH(),"harperdb-tsc.pid"),o;if(lE(i))try{process.kill(+wH(i,{encoding:"utf8"}),0),o=!0}catch{}if(!o){console.log("starting tsc background process");let c=DH(s,["--watch"],{cwd:ts,detached:!0,stdio:"ignore"});CH(i,c.pid.toString()),c.unref()}}}}let e=AR.constructor,t=e._findPath;e._findPath=function(r,s,n){if(r.startsWith(".")&&!n&&s.length===1&&s[0].startsWith(ts)&&!s[0].includes("node_modules")){let i=RR(ts,s[0]),o;i.startsWith(Na)?o=Mn(ts,RR(Na,i)):o=Mn(ts,Na,i);let c=Mn(o,r),u=c+".js";if(lE(u))return u;if(c.includes(".")&&lE(c))return c}return t(r,s,n)}}});var y=T((Jse,HR)=>{"use strict";var Mr=require("path"),HH=require("fs"),{relative:Qse,join:zse}=Mr,{existsSync:qH}=HH;function FH(){let e=__dirname;for(;!qH(Mr.join(e,"package.json"));){let t=Mr.dirname(e);if(t===e)throw new Error("Could not find package root");e=t}return e}a(FH,"getHDBPackageRoot");var Pn=FH(),NR="js",Xu=NR,GH="harperdb-config.yaml",xH="defaultConfig.yaml",kH="hdb",bR=`harperdb.${Xu}`,yR=`customFunctionsServer.${Xu}`,VH=`restartHdb.${Xu}`,fE="HarperDB",Ju="Custom Functions",ju="Clustering Hub",Zu="Clustering Leaf",$H="Clustering Ingest Service",YH="Clustering Reply Service",KH="foreground.pid",WH="hdb.pid",QH="data",zH={HDB:fE,CLUSTERING_HUB:ju,CLUSTERING_LEAF:Zu,CLUSTERING_INGEST_SERVICE:$H,CLUSTERING_REPLY_SERVICE:YH,CUSTOM_FUNCTIONS:Ju,RESTART_HDB:"Restart HDB",INSTALL:"Install",RUN:"Run",STOP:"Stop",UPGRADE:"Upgrade",REGISTER:"Register",JOB:"Job",CLUSTERING_UPGRADE_4_0_0:"Upgrade-4-0-0"},JH={HDB:"hdb.log",INSTALL:"install.log",CLUSTERING_HUB:"clustering_hub.log",CLUSTERING_LEAF:"clustering_leaf.log"},XH={NOTIFY:"notify",FATAL:"fatal",ERROR:"error",WARN:"warn",INFO:"info",DEBUG:"debug",TRACE:"trace"},jH={harperdb:fE,"clustering hub":ju,"clustering leaf":Zu,"custom functions":Ju,custom_functions:Ju,clustering:"clustering","clustering config":"clustering config",clustering_config:"clustering_config",http_workers:"http_workers"},ZH={CLUSTERING_HUB_PROC_DESCRIPTOR:ju,CLUSTERING_LEAF_PROC_DESCRIPTOR:Zu},dE={HDB:Mr.join(Pn,"server/harperdb"),CUSTOM_FUNCTIONS:Mr.join(Pn,"server/customFunctions"),CLUSTERING_HUB:Mr.join(Pn,"server/nats"),CLUSTERING_LEAF:Mr.join(Pn,"server/nats")},eq={HDB:Mr.join(dE.HDB,bR),CUSTOM_FUNCTIONS:Mr.join(dE.CUSTOM_FUNCTIONS,yR)},tq={MAIN:"bin/harperdb.js",NATS_INGEST_SERVICE:Mr.join(Pn,"launchServiceScripts/launchNatsIngestService.js"),NATS_REPLY_SERVICE:Mr.join(Pn,"launchServiceScripts/launchNatsReplyService.js"),NODES_UPGRADE_4_0_0:Mr.join(Pn,"launchServiceScripts/launchUpdateNodes4-0-0.js")},rq={SUPER_USER:"super_user",CLUSTER_USER:"cluster_user"},IR="support@harperdb.io",sq="customer-success@harperdb.io",wR=1,nq=4141,CR="https://harperdbhelp.zendesk.com/hc/en-us/requests/new",iq="https://www.harperdb.io/product",oq=`For support, please submit a request at ${CR} or contact ${IR}`,LR=`For license support, please contact ${sq}`,aq="None of the specified records were found.",cq="hash attribute not found",uq=`Your current license only supports ${wR} role.  ${LR}`,lq="Your current license only supports 3 connections to a node.",_q="127.0.0.1",dq=1,fq=/^\.$/,Eq=/^\.\.$/,hq="U+002E",mq=/\//g,pq="U+002F",Sq=/U\+002F/g,Tq=/^U\+002E$/,gq=/^U\+002EU\+002E$/,Rq="d",Aq=999999,Oq="*",Nq="--max-old-space-size=",bq="system",yq="__hdb_hash",Iq=".harperdb",wq=".hdb",Cq="keys",Lq="hdb_boot_properties.file",Dq=".updateConfig.json",Uq="SIGTSTP",Mq=24,Pq=6e4,vq=448,Bq="blob",Hq="trash",qq="database",Fq="schema",Gq="transactions",xq=".count",kq="id",Vq="PROCESS_NAME",DR={SETTINGS_PATH_KEY:"settings_path"},UR=require("lodash"),$q={TC_AGREEMENT:"TC_AGREEMENT",CLUSTERING_USER:"CLUSTERING_USER",CLUSTERING_PASSWORD:"CLUSTERING_PASSWORD",HDB_ADMIN_USERNAME:"HDB_ADMIN_USERNAME",HDB_ADMIN_PASSWORD:"HDB_ADMIN_PASSWORD",OPERATIONSAPI_ROOT:"OPERATIONSAPI_ROOT",ROOTPATH:"ROOTPATH",OPERATIONSAPI_NETWORK_PORT:"OPERATIONSAPI_NETWORK_PORT",CLUSTERING_NODENAME:"CLUSTERING_NODENAME",CLUSTERING_ENABLED:"CLUSTERING_ENABLED",HDB_CONFIG:"HDB_CONFIG",CLUSTERING_PORT:"CLUSTERING_PORT",HDB_ROOT:"HDB_ROOT",SERVER_PORT:"SERVER_PORT",NODE_NAME:"NODE_NAME",CLUSTERING:"CLUSTERING"},Yq={HDB_PATH_KEY:"HDB_INTERNAL_PATH",HDB_AUTH_HEADER:"hdb_auth_header",HDB_USER_DATA_KEY:"hdb_user",CHUNK_SIZE:1e3,MAX_CHARACTER_SIZE:250},Kq={DATA_VERSION:"data_version",UPGRADE_VERSION:"upgrade_version"},Wq={JOB_TABLE_NAME:"hdb_job",NODE_TABLE_NAME:"hdb_nodes",ATTRIBUTE_TABLE_NAME:"hdb_attribute",LICENSE_TABLE_NAME:"hdb_license",ROLE_TABLE_NAME:"hdb_role",SCHEMA_TABLE_NAME:"hdb_schema",TABLE_TABLE_NAME:"hdb_table",USER_TABLE_NAME:"hdb_user",INFO_TABLE_NAME:"hdb_info"},Qq={JOB_TABLE_HASH_ATTRIBUTE:"id",NODE_TABLE_HASH_ATTRIBUTE:"name",ATTRIBUTE_TABLE_HASH_ATTRIBUTE:"id",LICENSE_TABLE_HASH_ATTRIBUTE:"license_key",ROLE_TABLE_HASH_ATTRIBUTE:"id",SCHEMA_TABLE_HASH_ATTRIBUTE:"name",TABLE_TABLE_HASH_ATTRIBUTE:"id",USER_TABLE_HASH_ATTRIBUTE:"username",INFO_TABLE_ATTRIBUTE:"info_id"},dr="hdb_internal:",zq={CREATE_SCHEMA:dr+"create_schema",CREATE_TABLE:dr+"create_table",CREATE_ATTRIBUTE:dr+"create_attribute",ADD_USER:dr+"add_user",ALTER_USER:dr+"alter_user",DROP_USER:dr+"drop_user",HDB_NODES:dr+"hdb_nodes",HDB_USERS:dr+"hdb_users",HDB_WORKERS:dr+"hdb_workers",CATCHUP:dr+"catchup",SCHEMA_CATCHUP:dr+"schema_catchup",WORKER_ROOM:dr+"cluster_workers"},Jq={ATTR_ATTRIBUTE_KEY:"attribute",ATTR_CREATEDDATE_KEY:"createddate",ATTR_HASH_ATTRIBUTE_KEY:"hash_attribute",ATTR_ID_KEY:"id",ATTR_NAME_KEY:"name",ATTR_PASSWORD_KEY:"password",ATTR_RESIDENCE_KEY:"residence",ATTR_ROLE_KEY:"role",ATTR_SCHEMA_KEY:"schema",ATTR_SCHEMA_TABLE_KEY:"schema_table",ATTR_TABLE_KEY:"table",ATTR_USERNAME_KEY:"username"},Xq="060493.ks",jq=".license",Zq={CREATED:"CREATED",IN_PROGRESS:"IN_PROGRESS",COMPLETE:"COMPLETE",ERROR:"ERROR"},J={INSERT:"insert",UPDATE:"update",UPSERT:"upsert",SEARCH_BY_CONDITIONS:"search_by_conditions",SEARCH_BY_HASH:"search_by_hash",SEARCH_BY_ID:"search_by_id",SEARCH_BY_VALUE:"search_by_value",SEARCH:"search",SQL:"sql",CSV_DATA_LOAD:"csv_data_load",CSV_FILE_LOAD:"csv_file_load",CSV_URL_LOAD:"csv_url_load",CREATE_SCHEMA:"create_schema",CREATE_DATABASE:"create_database",CREATE_TABLE:"create_table",CREATE_ATTRIBUTE:"create_attribute",DROP_SCHEMA:"drop_schema",DROP_DATABASE:"drop_database",DROP_TABLE:"drop_table",DESCRIBE_SCHEMA:"describe_schema",DESCRIBE_DATABASE:"describe_database",DESCRIBE_TABLE:"describe_table",DESCRIBE_ALL:"describe_all",DELETE:"delete",ADD_USER:"add_user",ALTER_USER:"alter_user",DROP_USER:"drop_user",LIST_USERS:"list_users",LIST_ROLES:"list_roles",ADD_ROLE:"add_role",ALTER_ROLE:"alter_role",DROP_ROLE:"drop_role",USER_INFO:"user_info",READ_LOG:"read_log",ADD_NODE:"add_node",UPDATE_NODE:"update_node",EXPORT_TO_S3:"export_to_s3",IMPORT_FROM_S3:"import_from_s3",DELETE_FILES_BEFORE:"delete_files_before",DELETE_RECORDS_BEFORE:"delete_records_before",EXPORT_LOCAL:"export_local",SEARCH_JOBS_BY_START_DATE:"search_jobs_by_start_date",GET_JOB:"get_job",DELETE_JOB:"delete_job",UPDATE_JOB:"update_job",GET_FINGERPRINT:"get_fingerprint",SET_LICENSE:"set_license",GET_REGISTRATION_INFO:"registration_info",CONFIGURE_CLUSTER:"configure_cluster",SET_CONFIGURATION:"set_configuration",CLUSTER_STATUS:"cluster_status",CLUSTER_NETWORK:"cluster_network",DROP_ATTRIBUTE:"drop_attribute",REMOVE_NODE:"remove_node",RESTART:"restart",RESTART_SERVICE:"restart_service",CATCHUP:"catchup",SYSTEM_INFORMATION:"system_information",DELETE_AUDIT_LOGS_BEFORE:"delete_audit_logs_before",READ_AUDIT_LOG:"read_audit_log",CREATE_AUTHENTICATION_TOKENS:"create_authentication_tokens",LOGIN:"login",LOGOUT:"logout",REFRESH_OPERATION_TOKEN:"refresh_operation_token",GET_CONFIGURATION:"get_configuration",CUSTOM_FUNCTIONS_STATUS:"custom_functions_status",GET_CUSTOM_FUNCTIONS:"get_custom_functions",GET_CUSTOM_FUNCTION:"get_custom_function",SET_CUSTOM_FUNCTION:"set_custom_function",GET_COMPONENTS:"get_components",GET_COMPONENT_FILE:"get_component_file",SET_COMPONENT_FILE:"set_component_file",DROP_COMPONENT:"drop_component",DROP_CUSTOM_FUNCTION:"drop_custom_function",ADD_CUSTOM_FUNCTION_PROJECT:"add_custom_function_project",ADD_COMPONENT:"add_component",DROP_CUSTOM_FUNCTION_PROJECT:"drop_custom_function_project",PACKAGE_CUSTOM_FUNCTION_PROJECT:"package_custom_function_project",DEPLOY_CUSTOM_FUNCTION_PROJECT:"deploy_custom_function_project",PACKAGE_COMPONENT:"package_component",DEPLOY_COMPONENT:"deploy_component",CLUSTER_SET_ROUTES:"cluster_set_routes",CLUSTER_DELETE_ROUTES:"cluster_delete_routes",CLUSTER_GET_ROUTES:"cluster_get_routes",READ_TRANSACTION_LOG:"read_transaction_log",DELETE_TRANSACTION_LOGS_BEFORE:"delete_transaction_logs_before",INSTALL_NODE_MODULES:"install_node_modules",AUDIT_NODE_MODULES:"audit_node_modules",PURGE_STREAM:"purge_stream",GET_BACKUP:"get_backup"},eF={CSV:".csv",JSON:".json"},tF={AWS_ACCESS_KEY:"aws_access_key_id",AWS_SECRET:"aws_secret_access_key",AWS_BUCKET:"bucket",AWS_FILE_KEY:"key",REGION:"region"},rF={SELECT:"select",INSERT:"insert",UPDATE:"update",DELETE:"delete"},ba={};ba[J.INSERT]=J.INSERT;ba[J.UPDATE]=J.UPDATE;ba[J.UPSERT]=J.UPSERT;ba[J.DELETE]=J.DELETE;var ye=Object.create(null);ye[J.DESCRIBE_ALL]=J.DESCRIBE_ALL;ye[J.DESCRIBE_TABLE]=J.DESCRIBE_TABLE;ye[J.DESCRIBE_SCHEMA]=J.DESCRIBE_SCHEMA;ye[J.READ_LOG]=J.READ_LOG;ye[J.ADD_NODE]=J.ADD_NODE;ye[J.LIST_USERS]=J.LIST_USERS;ye[J.LIST_ROLES]=J.LIST_ROLES;ye[J.USER_INFO]=J.USER_INFO;ye[J.SQL]=J.SQL;ye[J.GET_JOB]=J.GET_JOB;ye[J.SEARCH_JOBS_BY_START_DATE]=J.SEARCH_JOBS_BY_START_DATE;ye[J.DELETE_FILES_BEFORE]=J.DELETE_FILES_BEFORE;ye[J.EXPORT_LOCAL]=J.EXPORT_LOCAL;ye[J.EXPORT_TO_S3]=J.EXPORT_TO_S3;ye[J.CLUSTER_STATUS]=J.CLUSTER_STATUS;ye[J.REMOVE_NODE]=J.REMOVE_NODE;ye[J.RESTART]=J.RESTART;ye[J.CUSTOM_FUNCTIONS_STATUS]=J.CUSTOM_FUNCTIONS_STATUS;ye[J.GET_CUSTOM_FUNCTIONS]=J.GET_CUSTOM_FUNCTIONS;ye[J.GET_CUSTOM_FUNCTION]=J.GET_CUSTOM_FUNCTION;ye[J.SET_CUSTOM_FUNCTION]=J.SET_CUSTOM_FUNCTION;ye[J.DROP_CUSTOM_FUNCTION]=J.DROP_CUSTOM_FUNCTION;ye[J.ADD_CUSTOM_FUNCTION_PROJECT]=J.ADD_CUSTOM_FUNCTION_PROJECT;ye[J.DROP_CUSTOM_FUNCTION_PROJECT]=J.DROP_CUSTOM_FUNCTION_PROJECT;ye[J.PACKAGE_CUSTOM_FUNCTION_PROJECT]=J.PACKAGE_CUSTOM_FUNCTION_PROJECT;ye[J.DEPLOY_CUSTOM_FUNCTION_PROJECT]=J.DEPLOY_CUSTOM_FUNCTION_PROJECT;var sF={DEV:"dev",RUN:"run",START:"start",INSTALL:"install",REGISTER:"register",STOP:"stop",RESTART:"restart",VERSION:"version",UPGRADE:"upgrade",HELP:"help",STATUS:"status"},nF={point:"point",lineString:"lineString",multiLineString:"multiLineString",multiPoint:"multiPoint",multiPolygon:"multiPolygon",polygon:"polygon"},MR={HDB_ROOT_KEY:"HDB_ROOT",SERVER_PORT_KEY:"SERVER_PORT",CERT_KEY:"CERTIFICATE",PRIVATE_KEY_KEY:"PRIVATE_KEY",HTTP_SECURE_ENABLED_KEY:"HTTPS_ON",CORS_ENABLED_KEY:"CORS_ON",CORS_WHITELIST_KEY:"CORS_WHITELIST",LOG_LEVEL_KEY:"LOG_LEVEL",LOGGER_KEY:"LOGGER",LOG_PATH_KEY:"LOG_PATH",LOG_ROTATE:"LOG_ROTATE",LOG_ROTATE_MAX_SIZE:"LOG_ROTATE_MAX_SIZE",LOG_ROTATE_RETAIN:"LOG_ROTATE_RETAIN",LOG_ROTATE_COMPRESS:"LOG_ROTATE_COMPRESS",LOG_ROTATE_DATE_FORMAT:"LOG_ROTATE_DATE_FORMAT",LOG_ROTATE_ROTATE_MODULE:"LOG_ROTATE_ROTATE_MODULE",LOG_ROTATE_WORKER_INTERVAL:"LOG_ROTATE_WORKER_INTERVAL",LOG_ROTATE_ROTATE_INTERVAL:"LOG_ROTATE_ROTATE_INTERVAL",LOG_ROTATE_TIMEZONE:"LOG_ROTATE_TIMEZONE",LOG_DAILY_ROTATE_KEY:"LOG_DAILY_ROTATE",LOG_MAX_DAILY_FILES_KEY:"LOG_MAX_DAILY_FILES",PROPS_ENV_KEY:"NODE_ENV",SETTINGS_PATH_KEY:"settings_path",CLUSTERING_PORT_KEY:"CLUSTERING_PORT",CLUSTERING_NODE_NAME_KEY:"NODE_NAME",CLUSTERING_ENABLED_KEY:"CLUSTERING",ALLOW_SELF_SIGNED_SSL_CERTS:"ALLOW_SELF_SIGNED_SSL_CERTS",MAX_HDB_PROCESSES:"MAX_HDB_PROCESSES",INSTALL_USER:"install_user",CLUSTERING_USER_KEY:"CLUSTERING_USER",MAX_CLUSTERING_PROCESSES:"MAX_CLUSTERING_PROCESSES",SERVER_TIMEOUT_KEY:"SERVER_TIMEOUT_MS",SERVER_KEEP_ALIVE_TIMEOUT_KEY:"SERVER_KEEP_ALIVE_TIMEOUT",SERVER_HEADERS_TIMEOUT_KEY:"SERVER_HEADERS_TIMEOUT",DISABLE_TRANSACTION_LOG_KEY:"DISABLE_TRANSACTION_LOG",OPERATION_TOKEN_TIMEOUT_KEY:"OPERATION_TOKEN_TIMEOUT",REFRESH_TOKEN_TIMEOUT_KEY:"REFRESH_TOKEN_TIMEOUT",CUSTOM_FUNCTIONS_ENABLED_KEY:"CUSTOM_FUNCTIONS",CUSTOM_FUNCTIONS_PORT_KEY:"CUSTOM_FUNCTIONS_PORT",CUSTOM_FUNCTIONS_DIRECTORY_KEY:"CUSTOM_FUNCTIONS_DIRECTORY",MAX_CUSTOM_FUNCTION_PROCESSES:"MAX_CUSTOM_FUNCTION_PROCESSES",LOG_TO_FILE:"LOG_TO_FILE",LOG_TO_STDSTREAMS:"LOG_TO_STDSTREAMS",RUN_IN_FOREGROUND:"RUN_IN_FOREGROUND",LOCAL_STUDIO_ON:"LOCAL_STUDIO_ON",STORAGE_WRITE_ASYNC:"STORAGE_WRITE_ASYNC"},iF=UR.invert(MR),oF={CUSTOMFUNCTIONS_ENABLED:"customFunctions_enabled",CUSTOMFUNCTIONS_NETWORK_PORT:"customFunctions_network_port",CUSTOMFUNCTIONS_TLS_CERTIFICATE:"customFunctions_tls_certificate",CUSTOMFUNCTIONS_NETWORK_CORS:"customFunctions_network_cors",CUSTOMFUNCTIONS_NETWORK_CORSACCESSLIST:"customFunctions_network_corsAccessList",CUSTOMFUNCTIONS_NETWORK_HEADERSTIMEOUT:"customFunctions_network_headersTimeout",CUSTOMFUNCTIONS_NETWORK_HTTPS:"customFunctions_network_https",CUSTOMFUNCTIONS_NETWORK_KEEPALIVETIMEOUT:"customFunctions_network_keepAliveTimeout",CUSTOMFUNCTIONS_TLS_PRIVATEKEY:"customFunctions_tls_privateKey",CUSTOMFUNCTIONS_TLS_CERT_AUTH:"customFunctions_tls_certificateAuthority",CUSTOMFUNCTIONS_NETWORK_TIMEOUT:"customFunctions_network_timeout",CUSTOMFUNCTIONS_NODEENV:"customFunctions_nodeEnv",CUSTOMFUNCTIONS_ROOT:"customFunctions_root"},N={ANALYTICS_AGGREGATEPERIOD:"analytics_aggregatePeriod",AUTHENTICATION_AUTHORIZELOCAL:"authentication_authorizeLocal",AUTHENTICATION_CACHETTL:"authentication_cacheTTL",AUTHENTICATION_ENABLESESSIONS:"authentication_enableSessions",AUTHENTICATION_OPERATIONTOKENTIMEOUT:"authentication_operationTokenTimeout",AUTHENTICATION_REFRESHTOKENTIMEOUT:"authentication_refreshTokenTimeout",CLUSTERING_USER:"clustering_user",CLUSTERING_ENABLED:"clustering_enabled",CLUSTERING_HUBSERVER_CLUSTER_NAME:"clustering_hubServer_cluster_name",CLUSTERING_HUBSERVER_CLUSTER_NETWORK_PORT:"clustering_hubServer_cluster_network_port",CLUSTERING_HUBSERVER_CLUSTER_NETWORK_ROUTES:"clustering_hubServer_cluster_network_routes",CLUSTERING_HUBSERVER_LEAFNODES_NETWORK_PORT:"clustering_hubServer_leafNodes_network_port",CLUSTERING_HUBSERVER_NETWORK_PORT:"clustering_hubServer_network_port",CLUSTERING_LEAFSERVER_NETWORK_PORT:"clustering_leafServer_network_port",CLUSTERING_LEAFSERVER_NETWORK_ROUTES:"clustering_leafServer_network_routes",CLUSTERING_LEAFSERVER_STREAMS_MAXAGE:"clustering_leafServer_streams_maxAge",CLUSTERING_LEAFSERVER_STREAMS_MAXBYTES:"clustering_leafServer_streams_maxBytes",CLUSTERING_LEAFSERVER_STREAMS_MAXMSGS:"clustering_leafServer_streams_maxMsgs",CLUSTERING_LEAFSERVER_STREAMS_PATH:"clustering_leafServer_streams_path",CLUSTERING_NODENAME:"clustering_nodeName",CLUSTERING_TLS_CERTIFICATE:"clustering_tls_certificate",CLUSTERING_TLS_PRIVATEKEY:"clustering_tls_privateKey",CLUSTERING_TLS_CERT_AUTH:"clustering_tls_certificateAuthority",CLUSTERING_TLS_INSECURE:"clustering_tls_insecure",CLUSTERING_TLS_VERIFY:"clustering_tls_verify",CLUSTERING_LOGLEVEL:"clustering_logLevel",CLUSTERING_REPUBLISHMESSAGES:"clustering_republishMessages",CLUSTERING_DATABASELEVEL:"clustering_databaseLevel",CUSTOMFUNCTIONS_NETWORK_HTTPS:"customFunctions_network_https",THREADS:"threads",HTTP_SESSIONAFFINITY:"http_sessionAffinity",HTTP_COMPRESSIONTHRESHOLD:"http_compressionThreshold",HTTP_CORS:"http_cors",HTTP_CORSACCESSLIST:"http_corsAccessList",HTTP_HEADERSTIMEOUT:"http_headersTimeout",HTTP_KEEPALIVETIMEOUT:"http_keepAliveTimeout",HTTP_TIMEOUT:"http_timeout",HTTP_PORT:"http_port",HTTP_SECUREPORT:"http_securePort",LOCALSTUDIO_ENABLED:"localStudio_enabled",LOGGING_FILE:"logging_file",LOGGING_LEVEL:"logging_level",LOGGING_ROOT:"logging_root",LOGGING_ROTATION_ENABLED:"logging_rotation_enabled",LOGGING_ROTATION_COMPRESS:"logging_rotation_compress",LOGGING_ROTATION_INTERVAL:"logging_rotation_interval",LOGGING_ROTATION_MAXSIZE:"logging_rotation_maxSize",LOGGING_ROTATION_PATH:"logging_rotation_path",LOGGING_STDSTREAMS:"logging_stdStreams",LOGGING_AUDITLOG:"logging_auditLog",LOGGING_AUDITRETENTION:"logging_auditRetention",LOGGING_AUDITAUTHEVENTS_LOGFAILED:"logging_auditAuthEvents_logFailed",LOGGING_AUDITAUTHEVENTS_LOGSUCCESSFUL:"logging_auditAuthEvents_logSuccessful",OPERATIONSAPI_NETWORK_CORS:"operationsApi_network_cors",OPERATIONSAPI_NETWORK_CORSACCESSLIST:"operationsApi_network_corsAccessList",OPERATIONSAPI_NETWORK_HEADERSTIMEOUT:"operationsApi_network_headersTimeout",OPERATIONSAPI_NETWORK_HTTPS:"operationsApi_network_https",OPERATIONSAPI_NETWORK_KEEPALIVETIMEOUT:"operationsApi_network_keepAliveTimeout",OPERATIONSAPI_NETWORK_PORT:"operationsApi_network_port",OPERATIONSAPI_NETWORK_SECUREPORT:"operationsApi_network_securePort",OPERATIONSAPI_TLS_CERTIFICATE:"operationsApi_tls_certificate",OPERATIONSAPI_TLS_PRIVATEKEY:"operationsApi_tls_privateKey",OPERATIONSAPI_TLS_CERTIFICATEAUTHORITY:"operationsApi_tls_certificateAuthority",OPERATIONSAPI_NETWORK_TIMEOUT:"operationsApi_network_timeout",ROOTPATH:"rootPath",STORAGE_WRITEASYNC:"storage_writeAsync",STORAGE_OVERLAPPINGSYNC:"storage_overlappingSync",STORAGE_CACHING:"storage_caching",STORAGE_COMPRESSION:"storage_compression",STORAGE_NOREADAHEAD:"storage_noReadAhead",STORAGE_PREFETCHWRITES:"storage_prefetchWrites",STORAGE_ENCRYPTION:"storage_encryption",STORAGE_PATH:"storage_path",STORAGE_AUDIT_PATH:"storage_audit_path",DATABASES:"databases",IGNORE_SCRIPTS:"ignoreScripts",MQTT_NETWORK_PORT:"mqtt_network_port",MQTT_WEBSOCKET:"mqtt_webSocket",MQTT_NETWORK_SECUREPORT:"mqtt_network_securePort",MQTT_REQUIREAUTHENTICATION:"mqtt_requireAuthentication",COMPONENTSROOT:"componentsRoot",TLS_CERTIFICATE:"tls_certificate",TLS_PRIVATEKEY:"tls_privateKey",TLS_CERTIFICATEAUTHORITY:"tls_certificateAuthority"},PR={settings_path:DR.SETTINGS_PATH_KEY,hdb_root_key:N.ROOTPATH,hdb_root:N.ROOTPATH,rootpath:N.ROOTPATH,server_port_key:N.OPERATIONSAPI_NETWORK_PORT,server_port:N.OPERATIONSAPI_NETWORK_PORT,cert_key:N.TLS_CERTIFICATE,certificate:N.TLS_CERTIFICATE,private_key_key:N.TLS_PRIVATEKEY,private_key:N.TLS_PRIVATEKEY,http_secure_enabled_key:N.OPERATIONSAPI_NETWORK_HTTPS,https_on:N.OPERATIONSAPI_NETWORK_HTTPS,cors_enabled_key:N.OPERATIONSAPI_NETWORK_CORS,cors_on:N.OPERATIONSAPI_NETWORK_CORS,cors_whitelist_key:N.OPERATIONSAPI_NETWORK_CORSACCESSLIST,cors_whitelist:N.OPERATIONSAPI_NETWORK_CORSACCESSLIST,cors_accesslist_key:N.OPERATIONSAPI_NETWORK_CORSACCESSLIST,cors_accesslist:N.OPERATIONSAPI_NETWORK_CORSACCESSLIST,log_level_key:N.LOGGING_LEVEL,log_level:N.LOGGING_LEVEL,log_path_key:N.LOGGING_ROOT,log_path:N.LOGGING_ROOT,clustering_node_name_key:N.CLUSTERING_NODENAME,node_name:N.CLUSTERING_NODENAME,clustering_enabled_key:N.CLUSTERING_ENABLED,clustering:N.CLUSTERING_ENABLED,max_http_threads:N.THREADS,max_hdb_processes:N.THREADS,server_timeout_key:N.OPERATIONSAPI_NETWORK_TIMEOUT,server_timeout_ms:N.OPERATIONSAPI_NETWORK_TIMEOUT,server_keep_alive_timeout_key:N.OPERATIONSAPI_NETWORK_KEEPALIVETIMEOUT,server_keep_alive_timeout:N.OPERATIONSAPI_NETWORK_KEEPALIVETIMEOUT,server_headers_timeout_key:N.OPERATIONSAPI_NETWORK_HEADERSTIMEOUT,server_headers_timeout:N.OPERATIONSAPI_NETWORK_HEADERSTIMEOUT,disable_transaction_log_key:N.LOGGING_AUDITLOG,disable_transaction_log:N.LOGGING_AUDITLOG,operation_token_timeout_key:N.AUTHENTICATION_OPERATIONTOKENTIMEOUT,operation_token_timeout:N.AUTHENTICATION_OPERATIONTOKENTIMEOUT,refresh_token_timeout_key:N.AUTHENTICATION_REFRESHTOKENTIMEOUT,refresh_token_timeout:N.AUTHENTICATION_REFRESHTOKENTIMEOUT,custom_functions_port_key:N.HTTP_PORT,custom_functions_port:N.HTTP_PORT,custom_functions_directory_key:N.COMPONENTSROOT,custom_functions_directory:N.COMPONENTSROOT,max_custom_function_processes:N.THREADS,log_to_file:N.LOGGING_FILE,log_to_stdstreams:N.LOGGING_STDSTREAMS,local_studio_on:N.LOCALSTUDIO_ENABLED,clustering_port:N.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_PORT,clustering_user:N.CLUSTERING_USER,clustering_enabled:N.CLUSTERING_ENABLED,clustering_hubserver_cluster_name:N.CLUSTERING_HUBSERVER_CLUSTER_NAME,clustering_hubserver_cluster_network_port:N.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_PORT,clustering_hubserver_cluster_network_routes:N.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_ROUTES,clustering_hubserver_leafnodes_network_port:N.CLUSTERING_HUBSERVER_LEAFNODES_NETWORK_PORT,clustering_hubserver_network_port:N.CLUSTERING_HUBSERVER_NETWORK_PORT,clustering_leafserver_network_port:N.CLUSTERING_LEAFSERVER_NETWORK_PORT,clustering_leafserver_network_routes:N.CLUSTERING_LEAFSERVER_NETWORK_ROUTES,clustering_leafserver_streams_maxage:N.CLUSTERING_LEAFSERVER_STREAMS_MAXAGE,clustering_leafserver_streams_maxbytes:N.CLUSTERING_LEAFSERVER_STREAMS_MAXBYTES,clustering_leafserver_streams_maxmsgs:N.CLUSTERING_LEAFSERVER_STREAMS_MAXMSGS,clustering_leafserver_streams_path:N.CLUSTERING_LEAFSERVER_STREAMS_PATH,clustering_nodename:N.CLUSTERING_NODENAME,clustering_tls_certificate:N.CLUSTERING_TLS_CERTIFICATE,clustering_tls_privatekey:N.CLUSTERING_TLS_PRIVATEKEY,clustering_tls_certificateauthority:N.CLUSTERING_TLS_CERT_AUTH,clustering_tls_insecure:N.CLUSTERING_TLS_INSECURE,clustering_tls_verify:N.CLUSTERING_TLS_VERIFY,clustering_loglevel:N.CLUSTERING_LOGLEVEL,clustering_republishmessages:N.CLUSTERING_REPUBLISHMESSAGES,clustering_databaselevel:N.CLUSTERING_DATABASELEVEL,customfunctions_network_port:N.HTTP_PORT,customfunctions_tls_certificate:N.TLS_CERTIFICATE,customfunctions_network_cors:N.HTTP_CORS,customfunctions_network_corsaccesslist:N.HTTP_CORSACCESSLIST,customfunctions_network_headerstimeout:N.HTTP_HEADERSTIMEOUT,customfunctions_network_https:N.CUSTOMFUNCTIONS_NETWORK_HTTPS,customfunctions_network_keepalivetimeout:N.HTTP_KEEPALIVETIMEOUT,customfunctions_tls_privatekey:N.TLS_PRIVATEKEY,customfunctions_tls_certificateauthority:N.TLS_CERTIFICATEAUTHORITY,customfunctions_network_timeout:N.HTTP_TIMEOUT,http_threads:N.THREADS,threads:N.THREADS,http_session_affinity:N.HTTP_SESSIONAFFINITY,http_compressionthreshold:N.HTTP_COMPRESSIONTHRESHOLD,http_cors:N.HTTP_CORS,http_corsaccesslist:N.HTTP_CORSACCESSLIST,http_headerstimeout:N.HTTP_HEADERSTIMEOUT,http_keepalivetimeout:N.HTTP_KEEPALIVETIMEOUT,http_timeout:N.HTTP_TIMEOUT,http_port:N.HTTP_PORT,http_secureport:N.HTTP_SECUREPORT,customfunctions_processes:N.THREADS,customfunctions_root:N.COMPONENTSROOT,localstudio_enabled:N.LOCALSTUDIO_ENABLED,logging_file:N.LOGGING_FILE,logging_level:N.LOGGING_LEVEL,logging_root:N.LOGGING_ROOT,logging_rotation_enabled:N.LOGGING_ROTATION_ENABLED,logging_rotation_compress:N.LOGGING_ROTATION_COMPRESS,logging_rotation_interval:N.LOGGING_ROTATION_INTERVAL,logging_rotation_maxsize:N.LOGGING_ROTATION_MAXSIZE,logging_rotation_path:N.LOGGING_ROTATION_PATH,logging_stdstreams:N.LOGGING_STDSTREAMS,logging_auditlog:N.LOGGING_AUDITLOG,logging_auditretention:N.LOGGING_AUDITRETENTION,logging_auditauthevents_logfailed:N.LOGGING_AUDITAUTHEVENTS_LOGFAILED,logging_auditauthevents_logsuccessful:N.LOGGING_AUDITAUTHEVENTS_LOGSUCCESSFUL,operationsapi_authentication_operationtokentimeout:N.AUTHENTICATION_OPERATIONTOKENTIMEOUT,operationsapi_authentication_refreshtokentimeout:N.AUTHENTICATION_REFRESHTOKENTIMEOUT,operationsapi_network_cors:N.OPERATIONSAPI_NETWORK_CORS,operationsapi_network_corsaccesslist:N.OPERATIONSAPI_NETWORK_CORSACCESSLIST,operationsapi_network_headerstimeout:N.OPERATIONSAPI_NETWORK_HEADERSTIMEOUT,operationsapi_network_https:N.OPERATIONSAPI_NETWORK_HTTPS,operationsapi_network_keepalivetimeout:N.OPERATIONSAPI_NETWORK_KEEPALIVETIMEOUT,operationsapi_network_port:N.OPERATIONSAPI_NETWORK_PORT,operationsapi_network_secureport:N.OPERATIONSAPI_NETWORK_SECUREPORT,operationsapi_tls_certificate:N.OPERATIONSAPI_TLS_CERTIFICATE,operationsapi_tls_privatekey:N.OPERATIONSAPI_TLS_PRIVATEKEY,operationsapi_tls_certificateauthority:N.OPERATIONSAPI_TLS_CERTIFICATEAUTHORITY,operationsapi_network_timeout:N.OPERATIONSAPI_NETWORK_TIMEOUT,operationsapi_root:N.ROOTPATH,databases:N.DATABASES,storage_path:N.STORAGE_PATH,ignorescripts:N.IGNORE_SCRIPTS,mqtt_network_port:N.MQTT_NETWORK_PORT,mqtt_websocket:N.MQTT_WEBSOCKET,mqtt_network_secureport:N.MQTT_NETWORK_SECUREPORT,mqtt_requireauthentication:N.MQTT_REQUIREAUTHENTICATION,analytics_aggregatePeriod:N.ANALYTICS_AGGREGATEPERIOD,authentication_authorizelocal:N.AUTHENTICATION_AUTHORIZELOCAL,authentication_cachettl:N.AUTHENTICATION_CACHETTL,authentication_enablesessions:N.AUTHENTICATION_ENABLESESSIONS,authentication_operationtokentimeout:N.AUTHENTICATION_OPERATIONTOKENTIMEOUT,authentication_refreshtokentimeout:N.AUTHENTICATION_REFRESHTOKENTIMEOUT,componentsroot:N.COMPONENTSROOT,tls_certificate:N.TLS_CERTIFICATE,tls_privatekey:N.TLS_PRIVATEKEY,tls_certificateauthority:N.TLS_CERTIFICATEAUTHORITY};for(let e in N){let t=N[e];PR[t.toLowerCase()]=t}var aF={TABLES:"tables",PATH:"path",AUDIT_PATH:"auditPath"},cF={csv_file_load:"csv_file_load",csv_data_load:J.CSV_DATA_LOAD,csv_url_load:J.CSV_URL_LOAD,delete_files_before:"delete_files_before",delete_records_before:"delete_records_before",delete_audit_logs_before:"delete_audit_logs_before",delete_transaction_logs_before:"delete_transaction_logs_before",empty_trash:"empty_trash",export_local:"export_local",export_to_s3:"export_to_s3",import_from_s3:"import_from_s3"},uF={CLUSTERING_PAYLOAD:"clustering_payload",DELEGATE_THREAD_RESPONSE:"delegate_thread_response",CLUSTERING:"clustering",SCHEMA:"schema",CLUSTER_STATUS:"cluster_status",JOB:"job",CHILD_STARTED:"child_started",CHILD_STOPPED:"child_stopped",USER:"user",RESTART:"restart"},lF={BIDIRECTIONAL:"BIDIRECTIONAL",OUTBOUND:"OUTBOUND",INBOUND:"INBOUND"},_F={VERSION_DEFAULT:"2.2.0"},dF={DEVELOPMENT:8192,DEFAULT:512},fF={IDENTIFY:"identify",AUTHENTICATE:"authenticate",AUTHENTICATE_OK:"authenticated",AUTHENTICATE_FAIL:"authenticate_fail",CONNECTION:"connection",CONNECT:"connect",CATCHUP_REQUEST:"catchup_request",CATCHUP_RESPONSE:"catchup",CONFIRM_MSG:"confirm_msg",ERROR:"error",DISCONNECT:"disconnect",SCHEMA_UPDATE_REQ:"schema_update_request",SCHEMA_UPDATE_RES:"schema_update_response",RECONNECT_ATTEMPT:"reconnect_attempt",CONNECT_ERROR:"connect_error",MESSAGE:"msg",VERSION_MISMATCH:"version_mismatch",DIRECTION_CHANGE:"direction_change"},EF={1e3:"SUCCESSFUL_SHUTDOWN",1001:"CLOSE_GOING_AWAY",1002:"CLOSE_PROTOCOL_ERROR",1003:"CLOSE_UNSUPPORTED",1005:"CLOSE_NO_STATUS",1006:"CLOSE_ABNORMAL",1007:"UNSUPPORTED_PAYLOAD",1008:"POLICY_VIOLATION",1009:"CLOSE_TOO_LARGE",1010:"MANDATORY_EXTENSION",1011:"SERVER_ERROR",1012:"SERVICE_RESTART",1013:"SERVER_BUSY",1014:"BAD_GATEWAY",1015:"HANDSHAKE_FAIL",4141:"LICENSE_LIMIT_REACHED"},hF={ENOENT:"ENOENT",EACCES:"EACCES",EEXIST:"EEXIST"},vR={CREATED_TIME:"__createdtime__",UPDATED_TIME:"__updatedtime__"},mF=Symbol("metadata"),pF="__clustering__",SF=Object.values(vR),TF=15984864e5,BR={LESS:"<",LESS_OR_EQ:"<=",GREATER:">",GREATER_OR_EQ:">=",BETWEEN:"..."},gF=UR.invert(BR),RF={GET_CLUSTER_STATUS:"GET_CLUSTER_STATUS",CLUSTER_STATUS_RESPONSE:"CLUSTER_STATUS_RESPONSE",ERROR_RESPONSE:"ERROR",ADD_USER:"ADD_USER",ALTER_USER:"ALTER_USER",DROP_USER:"DROP_USER",HDB_OPERATION:"HDB_OPERATION",ADD_NODE:"ADD_NODE",UPDATE_NODE:"UPDATE_NODE",REMOVE_NODE:"REMOVE_NODE",HDB_USERS_MSG:"HDB_USERS_MSG",HDB_WORKERS:"HDB_WORKERS",HDB_TRANSACTION:"HDB_TRANSACTION"},AF=111,OF=`\r
`,NF={READ:"read",INSERT:"insert",UPDATE:"update",DELETE:"delete"},bF=["*","%"],yF="unauthorized_access",IF="func_val",wF={HASH_VALUE:"hash_value",TIMESTAMP:"timestamp",USERNAME:"username"},CF={JWT_PRIVATE_KEY_NAME:".jwtPrivate.key",JWT_PUBLIC_KEY_NAME:".jwtPublic.key",JWT_PASSPHRASE_NAME:".jwtPass"},LF={SHUTDOWN:"shutdown",CHILD_STARTED:"child_started",CHILD_STOPPED:"child_stopped",SCHEMA:"schema",USER:"user",CLUSTER_STATUS_RESPONSE:"cluster_status_response",CLUSTER_STATUS_REQUEST:"cluster_status_request",METRICS:"metrics",GET_METRICS:"get_metrics",RESTART:"restart"},DF={HDB_CORE:"hdb_core",CUSTOM_FUNCTIONS:"custom_functions"},UF={HTTP:"http"},MF={STOPPED:"stopped",ONLINE:"online"},PF="3.x.x",vF={SUCCESS:"success",FAILURE:"failure"},BF={AUTHENTICATION:"authentication",AUTHORIZATION:"authorization"};HR.exports={LOCAL_HARPERDB_OPERATIONS:ye,HDB_SUPPORT_ADDRESS:IR,HDB_SUPPORT_URL:CR,HDB_PRICING_URL:iq,SUPPORT_HELP_MSG:oq,LICENSE_HELP_MSG:LR,HDB_PROC_NAME:bR,HDB_PROC_DESCRIPTOR:fE,CLUSTERING_LEAF_PROC_DESCRIPTOR:Zu,CLUSTERING_HUB_PROC_DESCRIPTOR:ju,SYSTEM_SCHEMA_NAME:bq,HASH_FOLDER_NAME:yq,HDB_HOME_DIR_NAME:Iq,UPDATE_FILE_NAME:Dq,LICENSE_KEY_DIR_NAME:Cq,BOOT_PROPS_FILE_NAME:Lq,JOB_TYPE_ENUM:cF,JOB_STATUS_ENUM:Zq,SYSTEM_TABLE_NAMES:Wq,SYSTEM_TABLE_HASH_ATTRIBUTES:Qq,OPERATIONS_ENUM:J,VALID_S3_FILE_TYPES:eF,S3_BUCKET_AUTH_KEYS:tF,VALID_SQL_OPS_ENUM:rF,GEO_CONVERSION_ENUM:nF,HDB_SETTINGS_NAMES:MR,HDB_SETTINGS_NAMES_REVERSE_LOOKUP:iF,SERVICE_ACTIONS_ENUM:sF,CLUSTER_MESSAGE_TYPE_ENUM:uF,CLUSTER_CONNECTION_DIRECTION_ENUM:lF,CLUSTER_EVENTS_DEFS_ENUM:fF,PERIOD_REGEX:fq,DOUBLE_PERIOD_REGEX:Eq,UNICODE_PERIOD:hq,FORWARD_SLASH_REGEX:mq,UNICODE_FORWARD_SLASH:pq,ESCAPED_FORWARD_SLASH_REGEX:Sq,ESCAPED_PERIOD_REGEX:Tq,ESCAPED_DOUBLE_PERIOD_REGEX:gq,REG_KEY_FILE_NAME:Xq,RESTART_TIMEOUT_MS:Pq,HDB_FILE_PERMISSIONS:vq,DATABASES_DIR_NAME:qq,LEGACY_DATABASES_DIR_NAME:Fq,TRANSACTIONS_DIR_NAME:Gq,LIMIT_COUNT_NAME:xq,ID_ATTRIBUTE_STRING:kq,INSERT_MODULE_ENUM:Yq,UPGRADE_JSON_FIELD_NAMES_ENUM:Kq,RESTART_CODE:Uq,RESTART_CODE_NUM:Mq,CLUSTER_OPERATIONS:ba,SYSTEM_DEFAULT_ATTRIBUTE_NAMES:Jq,HDB_INTERNAL_SC_CHANNEL_PREFIX:dr,INTERNAL_SC_CHANNELS:zq,CLUSTERING_MESSAGE_TYPES:RF,HDB_FILE_SUFFIX:wq,BLOB_FOLDER_NAME:Bq,HDB_TRASH_DIR:Hq,ORIGINATOR_SET_VALUE:AF,LICENSE_VALUES:_F,RAM_ALLOCATION_ENUM:dF,TIME_STAMP_NAMES_ENUM:vR,TIME_STAMP_NAMES:SF,PERMS_UPDATE_RELEASE_TIMESTAMP:TF,SEARCH_NOT_FOUND_MESSAGE:aq,SEARCH_ATTRIBUTE_NOT_FOUND:cq,LICENSE_ROLE_DENIED_RESPONSE:uq,LICENSE_MAX_CONNS_REACHED:lq,BASIC_LICENSE_MAX_NON_CU_ROLES:wR,BASIC_LICENSE_CLUSTER_CONNECTION_LIMIT_WS_ERROR_CODE:nq,VALUE_SEARCH_COMPARATORS:BR,VALUE_SEARCH_COMPARATORS_REVERSE_LOOKUP:gF,LICENSE_FILE_NAME:jq,WEBSOCKET_CLOSE_CODE_DESCRIPTION_LOOKUP:EF,NEW_LINE:OF,BASIC_LICENSE_MAX_CLUSTER_USER_ROLES:dq,MOMENT_DAYS_TAG:Rq,API_TURNOVER_SEC:Aq,LOOPBACK:_q,CODE_EXTENSION:Xu,WILDCARD_SEARCH_VALUE:Oq,NODE_ERROR_CODES:hF,JAVASCRIPT_EXTENSION:NR,PERMS_CRUD_ENUM:NF,UNAUTHORIZED_PERMISSION_NAME:yF,SEARCH_WILDCARDS:bF,FUNC_VAL:IF,READ_AUDIT_LOG_SEARCH_TYPES_ENUM:wF,JWT_ENUM:CF,CLUSTERING_FLAG:pF,ITC_EVENT_TYPES:LF,CUSTOM_FUNCTION_PROC_NAME:yR,CUSTOM_FUNCTION_PROC_DESCRIPTOR:Ju,SERVICES:DF,THREAD_TYPES:UF,MEM_SETTING_KEY:Nq,HDB_RESTART_SCRIPT:VH,PROCESS_DESCRIPTORS:zH,SERVICE_SERVERS:eq,SERVICE_SERVERS_CWD:dE,PROCESS_DESCRIPTORS_VALIDATE:jH,LAUNCH_SERVICE_SCRIPTS:tq,LOG_LEVELS:XH,PROCESS_NAME_ENV_PROP:Vq,LOG_NAMES:JH,PM2_PROCESS_STATUSES:MF,CONFIG_PARAM_MAP:PR,CONFIG_PARAMS:N,HDB_CONFIG_FILE:GH,HDB_DEFAULT_CONFIG_FILE:xH,ROLE_TYPES_ENUM:rq,BOOT_PROP_PARAMS:DR,INSTALL_PROMPTS:$q,HDB_ROOT_DIR_NAME:kH,CLUSTERING_PROCESSES:ZH,FOREGROUND_PID_FILE:KH,PACKAGE_ROOT:Pn,PRE_4_0_0_VERSION:PF,DATABASES_PARAM_CONFIG:aF,METADATA_PROPERTY:mF,AUTH_AUDIT_STATUS:vF,AUTH_AUDIT_TYPES:BF,HDB_PID_FILE:WH,DEFAULT_DATABASE_NAME:QH,LEGACY_CONFIG_PARAMS:oF};OR()});var EE=T((jse,GR)=>{"use strict";var qR=require("minimist");GR.exports=HF;function HF(e=[],t=!1){if(!Array.isArray(e))return{};let r,s;t?(r=FR(process.env),s=FR(qR(process.argv))):(r=process.env,s=qR(process.argv));let n={};for(let i=0,o=e.length;i<o;i++){let c=e[i];s[c]!==void 0?n[c]=s[c].toString().trim():r[c]!==void 0&&(n[c]=r[c].toString().trim())}return n}a(HF,"assignCMDENVVariables");function FR(e){let t,r=Object.keys(e),s=r.length,n={};for(;s--;)t=r[s],n[t.toLowerCase()]=e[t];return n}a(FR,"objKeysToLowerCase")});var G=T((ene,RE)=>{"use strict";var _i=require("fs-extra"),{workerData:qF,threadId:FF}=require("worker_threads"),js=require("path"),VR=require("yaml"),$R=require("properties-reader"),ct=y(),xR=EE(),GF=require("os"),{PACKAGE_ROOT:mE}=y(),{_assignPackageExport:xF}=require("../../index"),Ia={};for(let e in console)Ia[e]||(Ia[e]=console[e]);var Kt={notify:7,fatal:6,error:5,warn:4,info:3,debug:2,trace:1},YR={STDOUT:"stdOut",STDERR:"stdErr"},kF=js.join(mE,"logs"),VF=js.join(mE,"config/yaml/",ct.HDB_DEFAULT_CONFIG_FILE),$F=1e4,Xs,bs,Yt,el,tl,wa,so,ya;ya===void 0&&KR();RE.exports={notify:zR,fatal:JR,error:Ca,warn:gE,info:rl,debug:TE,trace:SE,setLogLevel:XF,log_level:Yt,loggerWithTag:YF,suppressLogging:KF,initLogSettings:KR,setupConsoleLogging:WR,logCustomLevel:zF,closeLogFile:pE,getLogFilePath:()=>wa,OUTPUTS:YR,AuthAuditLog:eG};xF("logger",RE.exports);function KR(e=!1){try{if(ya===void 0||e){pE();let t=JF(),r=xR(["ROOTPATH"]);try{ya=$R(t)}catch(s){if(!r.ROOTPATH||r.ROOTPATH&&!_i.pathExistsSync(js.join(r.ROOTPATH,ct.HDB_CONFIG_FILE)))throw s}({level:Yt,config_log_path:tl,to_file:Xs,to_stream:bs}=jF(r.ROOTPATH?js.join(r.ROOTPATH,ct.HDB_CONFIG_FILE):ya.get("settings_path"))),el=ct.LOG_NAMES.HDB,wa=js.join(tl,el)}}catch(t){if(ya=void 0,t.code===ct.NODE_ERROR_CODES.ENOENT){let r=xR(Object.keys(ct.CONFIG_PARAM_MAP),!0);for(let o in r){let c=ct.CONFIG_PARAM_MAP[o];c&&c.toLowerCase();let u=r[o];if(c===ct.CONFIG_PARAMS.LOGGING_LEVEL){Yt=u;continue}if(c===ct.CONFIG_PARAMS.LOGGING_STDSTREAMS){bs=u;continue}c===ct.CONFIG_PARAMS.LOGGING_FILE&&(Xs=c)}let{default_level:s,default_to_file:n,default_to_stream:i}=ZF();Xs=Xs===void 0?n:Xs,Xs=kR(Xs),bs=bs===void 0?i:bs,bs=kR(bs),Yt=Yt===void 0?s:Yt,tl=kF,el=ct.LOG_NAMES.INSTALL,wa=js.join(tl,el);return}throw Ca("Error initializing log settings"),Ca(t),t}process.env.DEV_MODE&&(bs=!0),WR()}a(KR,"initLogSettings");var hE=!0;function WR(){ro("error",Ca),ro("warn",gE),ro("log",rl),ro("info",rl),ro("debug",TE),ro("trace",SE)}a(WR,"setupConsoleLogging");function ro(e,t){console[e]=function(...r){if(hE&&t(...r),!/PM2 log:|App \[/.test(r[0]))return Ia[e](...r)}}a(ro,"logConsole");function YF(e){let t={tagName:e.replace(/ /g,"-")};return{notify:r(zR),fatal:r(JR),error:r(Ca),warn:r(gE),info:r(rl),debug:r(TE),trace:r(SE)};function r(s){return function(...n){return s(t,...n)}}}a(YF,"loggerWithTag");function KF(e){try{hE=!1,e()}finally{hE=!0}}a(KF,"suppressLogging");var WF=qF?.name?.replace(/ /g,"-")||"main";function Zs(e,t){let r=new Date(Date.now()).toISOString(),s="",n=t.length,i=n-1,o=[e],c=0,u;for(typeof t[0]=="object"&&(t[0]?.tagName?(o.push(t[0]?.tagName),c++):t[0]?.serviceName&&(u=t[0]?.serviceName,c++)),o.unshift(u||WF+"/"+FF);c<n;c++){let _=t[c];_ instanceof Error&&_.stack?s+=_.stack:typeof _=="object"?s+=JSON.stringify(_):s+=_,c<i&&(s+=" ")}return`${r} [${o.join("] [")}]: ${s}
`}a(Zs,"createLogRecord");function La(e){Xs&&QR(e),bs&&process.stdout.write(e)}a(La,"logStdOut");function sl(e){Xs&&QR(e),bs&&process.stderr.write(e)}a(sl,"logStdErr");function QR(e){QF(),so?_i.appendFileSync(so,e):Ia.log(e)}a(QR,"logToFile");function pE(){try{_i.closeSync(so)}catch{}so=null}a(pE,"closeLogFile");function QF(){if(!so){try{if(!wa)debugger;so=_i.openSync(wa,"a")}catch(e){Ia.error(e)}setTimeout(()=>{pE()},$F).unref()}}a(QF,"openLogFile");function rl(...e){Kt[Yt]<=Kt.info&&La(Zs("info",e))}a(rl,"info");function SE(...e){Kt[Yt]<=Kt.trace&&La(Zs("trace",e))}a(SE,"trace");function Ca(...e){Kt[Yt]<=Kt.error&&sl(Zs("error",e))}a(Ca,"error");function TE(...e){Kt[Yt]<=Kt.debug&&La(Zs("debug",e))}a(TE,"debug");function zR(...e){Kt[Yt]<=Kt.notify&&La(Zs("notify",e))}a(zR,"notify");function JR(...e){Kt[Yt]<=Kt.fatal&&sl(Zs("fatal",e))}a(JR,"fatal");function gE(...e){Kt[Yt]<=Kt.warn&&sl(Zs("warn",e))}a(gE,"warn");function zF(e,t,...r){t===YR.STDERR?sl(Zs(e,r)):La(Zs(e,r))}a(zF,"logCustomLevel");function JF(){let e;try{e=GF.homedir()}catch{e=process.env.HOME}e||(e="~/");let t=js.join(e,ct.HDB_HOME_DIR_NAME,ct.BOOT_PROPS_FILE_NAME);return _i.existsSync(t)||(t=js.join(mE,"utility/hdb_boot_properties.file")),t}a(JF,"getPropsFilePath");function XF(e){Yt=e}a(XF,"setLogLevel");function kR(e){return e===!0||typeof e=="string"&&e.toLowerCase()==="true"}a(kR,"autoCastBoolean");function jF(e){try{if(e.includes("config/settings.js")){let o=$R(e);return{level:o.get(ct.HDB_SETTINGS_NAMES.LOG_LEVEL_KEY),config_log_path:js.dirname(o.get(ct.HDB_SETTINGS_NAMES.LOG_PATH_KEY)),to_file:o.get(ct.HDB_SETTINGS_NAMES.LOG_TO_FILE),to_stream:o.get(ct.HDB_SETTINGS_NAMES.LOG_TO_STDSTREAMS)}}let t=VR.parseDocument(_i.readFileSync(e,"utf8")),r=t.getIn(["logging","level"]),s=t.getIn(["logging","root"]),n=t.getIn(["logging","file"]),i=t.getIn(["logging","stdStreams"]);return{level:r,config_log_path:s,to_file:n,to_stream:i}}catch(t){if(t.code===ct.NODE_ERROR_CODES.ENOENT)throw t;console.error("Error accessing config file for logging"),console.error(t)}}a(jF,"getLogConfig");function ZF(){try{let e=VR.parseDocument(_i.readFileSync(VF,"utf8")),t=e.getIn(["logging","level"]),r=e.getIn(["logging","file"]),s=e.getIn(["logging","stdStreams"]);return{default_level:t,default_to_file:r,default_to_stream:s}}catch(e){console.error("Error accessing default config file for logging"),console.error(e)}}a(ZF,"getDefaultConfig");function eG(e,t,r,s,n,i){this.username=e,this.status=t,this.type=r,this.originating_ip=s,this.request_method=n,this.path=i}a(eG,"AuthAuditLog")});var jR=T((rne,XR)=>{"use strict";var tG=require("util"),rG=require("path"),sG=require("child_process"),nG=tG.promisify(sG.execFile),iG=1e3*1e3*10;XR.exports={findPs:oG};async function oG(e){let t={};try{await Promise.all(["comm","args","ppid","uid","%cpu","%mem"].map(async r=>{let{stdout:s}=await nG("ps",["wwxo",`pid,${r}`],{maxBuffer:iG});for(let n of s.trim().split(`
`).slice(1)){n=n.trim();let[i]=n.split(" ",1),o=n.slice(i.length+1).trim();t[i]===void 0&&(t[i]={}),t[i][r]=o}}))}catch(r){throw r}return Object.entries(t).filter(([,r])=>r.comm&&r.args&&r.ppid&&r.uid&&r["%cpu"]&&r["%mem"]&&r.args.includes(e)).map(([r,s])=>({pid:Number.parseInt(r,10),name:rG.basename(s.comm),cmd:s.args,ppid:Number.parseInt(s.ppid,10),uid:Number.parseInt(s.uid,10),cpu:Number.parseFloat(s["%cpu"]),memory:Number.parseFloat(s["%mem"])}))}a(oG,"findPs")});var ze=T((nne,eA)=>{"use strict";var aG="__dbis__",cG="__txns__",uG="__environment_name__",lG="__dbi_defintion__",_G={EQUALS:"equals",STARTS_WITH:"startsWith",_STARTS_WITH:"starts_with",ENDS_WITH:"endsWith",_ENDS_WITH:"ends_with",CONTAINS:"contains",SEARCH_ALL:"searchAll",SEARCH_ALL_TO_MAP:"searchAllToMap",BATCH_SEARCH_BY_HASH:"batchSearchByHash",BATCH_SEARCH_BY_HASH_TO_MAP:"batchSearchByHashToMap",GREATER_THAN:"greaterThan",_GREATER_THAN:"greater_than",GREATER_THAN_EQUAL:"greaterThanEqual",_GREATER_THAN_EQUAL:"greater_than_equal",LESS_THAN:"lessThan",_LESS_THAN:"less_than",LESS_THAN_EQUAL:"lessThanEqual",_LESS_THAN_EQUAL:"less_than_equal",BETWEEN:"between"},dG=["__createdtime__","__updatedtime__"],fG="\uFFFF",ZR={TIMESTAMP:"timestamp",HASH_VALUE:"hash_value",USER_NAME:"user_name"},EG=Object.values(ZR);eA.exports={AUDIT_STORE_NAME:cG,INTERNAL_DBIS_NAME:aG,DBI_DEFINITION_NAME:lG,SEARCH_TYPES:_G,TIMESTAMP_NAMES:dG,MAX_SEARCH_KEY_LENGTH:256,ENVIRONMENT_NAME_KEY:uG,TRANSACTIONS_DBI_NAMES_ENUM:ZR,TRANSACTIONS_DBIS:EG,OVERFLOW_MARKER:fG}});var fr=T((ine,uA)=>{"use strict";var tA=y(),rA=ze(),sA={CONTINUE:100,OK:200,CREATED:201,BAD_REQUEST:400,UNAUTHORIZED:401,FORBIDDEN:403,NOT_FOUND:404,METHOD_NOT_ALLOWED:405,REQUEST_TIMEOUT:408,CONFLICT:409,TOO_MANY_REQUESTS:429,INTERNAL_SERVER_ERROR:500,NOT_IMPLEMENTED:501,BAD_GATEWAY:502,SERVICE_UNAVAILABLE:503,GATEWAY_TIMEOUT:504,HTTP_VERSION_NOT_SUPPORTED:505,INSUFFICIENT_STORAGE:507,NETWORK_AUTHENTICATION_REQUIRED:511},nA=a(e=>`${e} Check logs and try again.`,"CHECK_LOGS_WRAPPER"),iA={500:nA("There was an error processing your request."),400:"Invalid request"},hG=iA[sA.INTERNAL_SERVER_ERROR],mG={OP_NOT_SUPPORTED_FOR_FS:e=>`${e} is not available for this instance because it uses the File System data store.`,MISSING_VALUE:e=>`${e} is missing.`,INVALID_VALUE:e=>`${e} is invalid.`,NOT_FOUND:e=>`${e} not found.`},pG={CONFIG_VALIDATION:e=>`HarperDB config file validation error: ${e}`},SG={DEFAULT_BULK_LOAD_ERR:"There was an error during your bulk load into HarperDB.",DOWNLOAD_FILE_ERR:e=>`There was an error downloading '${e}'.`,INSERT_JSON_ERR:"There was an error inserting the downloaded JSON data.",INSERT_CSV_ERR:"There was an error inserting the downloaded CSV data.",INVALID_ACTION_PARAM_ERR:e=>`Bulk load operation failed - ${e} is not a valid 'action' parameter`,INVALID_FILE_EXT_ERR:e=>`Error selecting correct parser - valid file type not found in json - ${e}`,MAX_FILE_SIZE_ERR:(e,t)=>`File size is ${e} bytes, which exceeded the maximum size allowed of: ${t} bytes`,PAPA_PARSE_ERR:"There was an error parsing the downloaded CSV data.",S3_DOWNLOAD_ERR:e=>`There was an error downloading '${e}' from AWS.`,WRITE_TEMP_FILE_ERR:"Error writing temporary file to storage"},TG={BASE_PATH_REQUIRED:"base_path is required",DESTINATION_PATH_REQUIRED:"destination_path is required",ENV_NAME_REQUIRED:"env_name is required",INVALID_BASE_PATH:"invalid base_path",INVALID_DESTINATION_PATH:"invalid destination_path",INVALID_ENVIRONMENT:"invalid environment",ENV_REQUIRED:"env is required",DBI_NAME_REQUIRED:"dbi_name is required",DBI_DOES_NOT_EXIST:"dbi does not exist",HASH_ATTRIBUTE_REQUIRED:"hash_attribute is required",ID_REQUIRED:"id is required",IDS_REQUIRED:"ids is required",IDS_MUST_BE_ITERABLE:"ids must be iterable",FETCH_ATTRIBUTES_REQUIRED:"fetch_attributes is required",FETCH_ATTRIBUTES_MUST_BE_ARRAY:"fetch_attributes must be an array",ATTRIBUTE_REQUIRED:"attribute is required",SEARCH_VALUE_REQUIRED:"search_value is required",SEARCH_VALUE_TOO_LARGE:"search_value is too long",WRITE_ATTRIBUTES_REQUIRED:"write_attributes is required",WRITE_ATTRIBUTES_MUST_BE_ARRAY:"write_attributes must be an array",RECORDS_REQUIRED:"records is required",RECORDS_MUST_BE_ARRAY:"records must be an array",CANNOT_CREATE_INTERNAL_DBIS_NAME:`cannot create a dbi named ${rA.INTERNAL_DBIS_NAME}`,CANNOT_DROP_INTERNAL_DBIS_NAME:`cannot drop a dbi named ${rA.INTERNAL_DBIS_NAME}`,START_VALUE_REQUIRED:"start_value is required",END_VALUE_REQUIRED:"end_value is required",CANNOT_COMPARE_STRING_TO_NUMERIC_KEYS:"cannot compare a string to numeric keys",END_VALUE_MUST_BE_GREATER_THAN_START_VALUE:"end_value must be greater than or equal to start_value",UNKNOWN_SEARCH_TYPE:"unknown search type",CANNOT_DROP_TABLE_HASH_ATTRIBUTE:"cannot drop a table's hash attribute"},gG={ATTR_NAME_LENGTH_ERR:e=>`transaction aborted due to attribute name ${e} being too long. Attribute names cannot be longer than ${tA.INSERT_MODULE_ENUM.MAX_CHARACTER_SIZE} bytes.`,ATTR_NAME_NULLISH_ERR:"transaction aborted due to record(s) with an attribute name that is null, undefined or empty string",HASH_VAL_LENGTH_ERR:`transaction aborted due to record(s) with a hash value that exceeds ${tA.INSERT_MODULE_ENUM.MAX_CHARACTER_SIZE} bytes, check log for more info`,INVALID_FORWARD_SLASH_IN_HASH_ERR:"transaction aborted due to record(s) with a hash value that contains a forward slash, check log for more info",RECORD_MISSING_HASH_ERR:"transaction aborted due to record(s) with no hash value, check log for more info"},oA={GENERIC_AUTH_FAIL:"Login failed",USER_INACTIVE:"Cannot complete request: User is inactive",INVALID_TOKEN:"invalid token",NO_ENCRYPTION_KEYS:"unable to generate JWT as there are no encryption keys.  please contact your administrator",INVALID_CREDENTIALS:"invalid credentials",PASSWORD_REQUIRED:"password is required",USERNAME_REQUIRED:"username is required",REFRESH_TOKEN_REQUIRED:"refresh_token is required",INVALID_AUTH_OBJECT:"invalid auth_object",INVALID_BODY:"invalid body",TOKEN_EXPIRED:"token expired",REFRESH_TOKEN_SAVE_FAILED:"unable to store refresh_token"},RG={DEFAULT_INVALID_REQUEST:"Invalid request",OP_AUTH_PERMS_ERROR:"This operation is not authorized due to role restrictions and/or invalid database items",OP_IS_SU_ONLY:e=>`Operation '${e}' is restricted to 'super_user' roles`,OP_NOT_FOUND:e=>`Operation '${e}' not found`,SYSTEM_TIMESTAMP_PERMS_ERR:"Internal timestamp attributes - '__createdtime_' and '__updatedtime__' - cannot be inserted to or updated by HDB users.",UNKNOWN_OP_AUTH_ERROR:(e,t,r)=>`There was an error authorizing ${e} op on table '${t}.${r}'`,USER_HAS_NO_PERMS:e=>`User ${e} has no role or permissions.  Please assign the user a valid role.`,DROP_SYSTEM:"The 'system' database, tables and records are used internally by HarperDB and cannot be updated or removed."},AG={ATTR_PERM_MISSING:(e,t)=>`${e.toUpperCase()} attribute permission missing for '${t}'`,ATTR_PERM_MISSING_NAME:"Permission object in 'attribute_permission' missing an 'attribute_name'",ATTR_PERM_NOT_BOOLEAN:(e,t)=>`${e.toUpperCase()} attribute permission for '${t}' must be a boolean`,ATTR_PERMS_ARRAY_MISSING:"Missing 'attribute_permissions' array",ATTR_PERMS_NOT_ARRAY:"Value for 'attribute_permissions' must be an array",INVALID_ATTRIBUTE_IN_PERMS:e=>`Invalid attribute '${e}' in 'attribute_permissions'`,INVALID_PERM_KEY:e=>`Invalid table permission key value '${e}'`,INVALID_ATTR_PERM_KEY:e=>`Invalid attribute permission key value '${e}'`,INVALID_ROLE_JSON_KEYS:e=>`Invalid ${e.length>1?"keys":"key"} in JSON body - '${e.join("', '")}'`,MISMATCHED_TABLE_ATTR_PERMS:e=>`You have a conflict with TABLE permissions for '${e}' being false and ATTRIBUTE permissions being true`,OUTDATED_PERMS_TRANSLATION_ERROR:"This instance was recently upgraded and uses our new role permissions structure. Please login to this instance in HarperDB Studio, go to 'Roles', and click 'Update Role Permission' for all standard roles to migrate them to the new structure.",ROLE_ALREADY_EXISTS:e=>`A role with name '${e}' already exists`,ROLE_NOT_FOUND:"Role not found",ROLE_PERMS_ERROR:"Errors in the role permissions JSON provided",SCHEMA_PERM_ERROR:e=>`Your role does not have permission to view database metadata for '${e}'`,SCHEMA_TABLE_PERM_ERROR:(e,t)=>`Your role does not have permission to view database.table metadata for '${e}.${t}'`,SU_ROLE_MISSING_ERROR:"Missing 'super_user' key/value in permission set",SU_CU_ROLE_BOOLEAN_ERROR:e=>`Value for '${e}' permission must be a boolean`,STRUCTURE_USER_ROLE_TYPE_ERROR:e=>`Value for '${e}' permission must be a boolean or Array`,SU_CU_ROLE_NO_PERMS_ALLOWED:e=>`Roles with '${e}' set to true cannot have other permissions set.`,SU_CU_ROLE_COMBINED_ERROR:"Roles cannot have both 'super_user' and 'cluster_user' values included in their permissions set.",TABLE_PERM_MISSING:e=>`Missing table ${e.toUpperCase()} permission`,TABLE_PERM_NOT_BOOLEAN:e=>`Table ${e.toUpperCase()} permission must be a boolean`},OG={ATTR_NOT_FOUND:(e,t,r)=>`Attribute '${r}' does not exist on '${e}.${t}'`,ATTR_EXISTS_ERR:(e,t,r)=>`Attribute '${r}' already exists in ${e}.${t}'`,DESCRIBE_ALL_ERR:"There was an error during describeAll.  Please check the logs and try again.",INVALID_TABLE_ERR:e=>`Invalid table ${JSON.stringify(e)}`,SCHEMA_NOT_FOUND:e=>`database '${e}' does not exist`,SCHEMA_EXISTS_ERR:e=>`database '${e}' already exists`,TABLE_EXISTS_ERR:(e,t)=>`Table '${t}' already exists in '${e}'`,SCHEMA_REQUIRED_ERR:"database is required",TABLE_NOT_FOUND:(e,t)=>`Table '${e}.${t}' does not exist`,TABLE_REQUIRED_ERR:"table is required"},NG={OUTER_JOIN_TRANSLATION_ERROR:"There was an error translating the final SQL outer join data."},bG={ALTER_USER_DUP_ROLES:e=>`Update failed.  There are duplicates for the '${e}' role which is not allowed. Update your roles and try again.`,ALTER_USER_ROLE_NOT_FOUND:e=>`Update failed.  Requested '${e}' role not found.`,DUP_ROLES_FOUND:e=>`Multiple ${e} roles found.  Roles must have unique 'role' value. Please update and try again.`,ROLE_NAME_NOT_FOUND:e=>`${e} role not found`,USER_ALREADY_EXISTS:e=>`User ${e} already exists`,USER_NOT_EXIST:e=>`User ${e} does not exist`},aA={INVALID_DATE:"Invalid date, must be in ISO-8601 format (YYYY-MM-DD).",SEARCH_CONDITIONS_INVALID_SORT_ATTRIBUTE:e=>`invalid sort attribute '${e}', the attribute must either be the table's hash attribute or an attribute used in conditions.`},cA={INVALID_ITC_DATA_TYPE:"Invalid ITC event data type, must be an object",MISSING_TYPE:"ITC event missing 'type'",MISSING_MSG:"ITC event missing 'message'",MISSING_ORIGIN:"ITC event message missing 'originator' property",INVALID_EVENT:e=>`ITC server received invalid event type: ${e}`},yG={FUNCTION_STATUS:"Error getting custom function status, check the log for more details",GET_FUNCTIONS:"Error getting custom functions, check the log for more details",GET_FUNCTION:"Error getting custom function, check the log for more details",SET_FUNCTION:"Error setting custom function, check the log for more details",NO_PROJECT:"Project does not exist. Create one using 'add_custom_function_project'",PROJECT_EXISTS:"Project already exists",VALIDATION_ERR:"Error validating request, check the log for more details",NO_FILE:"File does not exist",BAD_FILE_NAME:"File name can only contain alphanumeric, dash and underscore characters",BAD_PROJECT_NAME:"Project name can only contain alphanumeric, dash and underscores characters",BAD_PACKAGE:"Packaged project must be base64-encoded tar file of project directory",DROP_FUNCTION:"Error dropping custom function, check the log for more details",ADD_FUNCTION:"Error adding custom function project, check the log for more details",DROP_FUNCTION_PROJECT:"Error dropping custom function project, check the log for more details",BAD_FILE_PATH:"Filepath must be valid, and contain the name of the tarball you wish to write",NOT_ENABLED:"Custom functions is not enabled, to enable set fastifyRoutes enabled to true in hdb/harperdb-config.yaml file."},IG={CLUSTERING_NOT_ENABLED:"Clustering must be enabled to perform this operation."},wG={...oA,...SG,...mG,...RG,...AG,...OG,...NG,...bG,...gG,...aA,...cA,...yG,...IG,...pG};uA.exports={CHECK_LOGS_WRAPPER:nA,HDB_ERROR_MSGS:wG,DEFAULT_ERROR_MSGS:iA,DEFAULT_ERROR_RESP:hG,HTTP_STATUS_CODES:sA,LMDB_ERRORS_ENUM:TG,AUTHENTICATION_ERROR_MSGS:oA,VALIDATION_ERROR_MSGS:aA,ITC_ERRORS:cA}});var j=T((ane,dA)=>{"use strict";var no=fr(),CG=G(),LG=y(),nl=class extends Error{static{a(this,"HdbError")}constructor(t,r,s,n,i){super(),Error.captureStackTrace(this,lA),this.statusCode=s||no.HTTP_STATUS_CODES.INTERNAL_SERVER_ERROR,this.http_resp_msg=r||(no.DEFAULT_ERROR_MSGS[s]?no.DEFAULT_ERROR_MSGS[s]:no.DEFAULT_ERROR_MSGS[no.HTTP_STATUS_CODES.INTERNAL_SERVER_ERROR]),this.message=t.message?t.message:this.http_resp_msg,this.type=t.name,n&&(this.logLevel=n),typeof this.message!="string"&&(this.stack=t.stack),i&&CG[n](i)}},AE=class extends Error{static{a(this,"ClientError")}constructor(t,r){if(t instanceof Error)return t.statusCode=r||400,t;super(t),this.statusCode=r||400}},OE=class extends Error{static{a(this,"ServerError")}constructor(t,r){super(t),this.statusCode=r||500}};function lA(e,t,r,s=LG.LOG_LEVELS.ERROR,n=null,i=!1){if(_A(e))return e;let o=new nl(e,t,r,s,n);return i&&delete o.stack,o}a(lA,"handleHDBError");function _A(e){return e.__proto__.constructor.name===nl.name}a(_A,"isHDBError");dA.exports={isHDBError:_A,handleHDBError:lA,ClientError:AE,ServerError:OE,hdb_errors:no}});var ve=T((une,TA)=>{"use strict";var va=y(),DG=$(),Wt=X(),Ba=require("path"),UG=require("minimist"),fA=require("fs-extra"),EA=require("lodash");Wt.initSync();var{CONFIG_PARAMS:vn,DATABASES_PARAM_CONFIG:Da,SYSTEM_SCHEMA_NAME:il}=va,Ua,Ma,Pa;function hA(){if(Ua!==void 0)return Ua;if(Wt.getHdbBasePath()!==void 0)return Ua=Wt.get(vn.STORAGE_PATH)||Ba.join(Wt.getHdbBasePath(),va.DATABASES_DIR_NAME),Ua}a(hA,"getBaseSchemaPath");function mA(){if(Ma!==void 0)return Ma;if(Wt.getHdbBasePath()!==void 0)return Ma=SA(il),Ma}a(mA,"getSystemSchemaPath");function pA(){if(Pa!==void 0)return Pa;if(Wt.getHdbBasePath()!==void 0)return Pa=Wt.get(va.CONFIG_PARAMS.STORAGE_AUDIT_PATH)||Ba.join(Wt.getHdbBasePath(),va.TRANSACTIONS_DIR_NAME),Pa}a(pA,"getTransactionAuditStoreBasePath");function MG(e,t){let r=Wt.get(vn.DATABASES)?.[e];return t&&r?.tables?.[t]?.auditPath||r?.auditPath||Ba.join(pA(),e.toString())}a(MG,"getTransactionAuditStorePath");function SA(e,t){e=e.toString(),t=t&&t.toString();let r=Wt.get(va.CONFIG_PARAMS.DATABASES)?.[e];return t&&r?.tables?.[t]?.path||r?.path||Ba.join(hA(),e)}a(SA,"getSchemaPath");function PG(e,t){e=e.toString(),t=t.toString();let r=process.env;Object.assign(r,UG(process.argv));let s=r[vn.DATABASES.toUpperCase()];if(s){let i;try{i=JSON.parse(s)}catch(o){if(!DG.isObject(s))throw o;i=s}for(let o of i){let c=o[il];if(!c)continue;let u=Wt.get(vn.DATABASES);u=u??{};let _=c?.tables?.[t]?.[Da.PATH];if(_)return EA.set(u,[il,Da.TABLES,t,Da.PATH],_),Wt.setProperty(vn.DATABASES,u),_;let l=c?.[Da.PATH];if(l)return EA.set(u,[il,Da.PATH],l),Wt.setProperty(vn.DATABASES,u),l}}let n=r[vn.STORAGE_PATH.toUpperCase()];if(n){if(!fA.pathExistsSync(n))throw new Error(n+" does not exist");let i=Ba.join(n,e);return fA.mkdirsSync(i),Wt.setProperty(vn.STORAGE_PATH,n),i}return mA()}a(PG,"initSystemSchemaPaths");function vG(){Ua=void 0,Ma=void 0,Pa=void 0}a(vG,"resetPaths");TA.exports={getBaseSchemaPath:hA,getSystemSchemaPath:mA,getTransactionAuditStorePath:MG,getTransactionAuditStoreBasePath:pA,getSchemaPath:SA,initSystemSchemaPaths:PG,resetPaths:vG}});var Er=T((fne,NA)=>{"use strict";var BG=fr().LMDB_ERRORS_ENUM,_ne=require("lmdb"),HG=ze(),dne=require("buffer").Buffer,{OVERFLOW_MARKER:gA,MAX_SEARCH_KEY_LENGTH:ol}=HG,RA=["number","string","symbol","boolean","bigint"];function qG(e){if(e=e?.primaryStore||e,!e)throw new Error(BG.ENV_REQUIRED)}a(qG,"validateEnv");function FG(e){if(e==null)return null;let t;try{t=typeof e=="object"?JSON.stringify(e):e.toString()}catch{t=e.toString()}return t}a(FG,"stringifyData");function GG(e){return e instanceof Date?e.valueOf():e}a(GG,"convertKeyValueToWrite");function xG(e){if(e==null)return;if(RA.includes(typeof e))return e.length>ol?[e.slice(0,ol)+gA]:[e];let t;if(Array.isArray(e)){t=[];for(let r=0,s=e.length;r<s;r++){let n=e[r];if(RA.includes(typeof n))n.length>ol?t.push(n.slice(0,ol)+gA):t.push(n);else if(n instanceof Date)return t.push(n.getTime())}}else if(e instanceof Date)return[e.getTime()];return t}a(xG,"getIndexedValues");var al=0,AA=0;function OA(){AA=Date.now()-performance.now()}a(OA,"adjustStartTime");OA();var kG=6e4;setInterval(OA,kG).unref();function VG(){let e=performance.now()+AA;return e>al?(al=e,e):(al+=488e-6,al)}a(VG,"getNextMonotonicTime");NA.exports={validateEnv:qG,stringifyData:FG,convertKeyValueToWrite:GG,getNextMonotonicTime:VG,getIndexedValues:xG}});var bA,rs,NE,Ha=Te(()=>{bA=require("events"),rs=class extends bA.EventEmitter{static{a(this,"IterableEventQueue")}resolveNext;queue;hasDataListeners;[Symbol.asyncIterator](){let t=new NE;return t.queue=this,t}push(t){this.send(t)}send(t){this.resolveNext?(this.resolveNext({value:t}),this.resolveNext=null):this.hasDataListeners?this.emit("data",t):(this.queue||(this.queue=[]),this.queue.push(t))}getNextMessage(){return this.queue?.shift()}on(t,r){if(t==="data"&&!this.hasDataListeners)for(this.hasDataListeners=!0;this.queue?.length>0;)r(this.queue.shift());return super.on(t,r)}},NE=class{static{a(this,"EventQueueIterator")}queue;push(t){this.queue.send(t)}next(){let t=this.queue.getNextMessage();return t?{value:t}:new Promise(r=>this.queue.resolveNext=r)}return(t){return this.queue.emit("close"),{value:t,done:!0}}throw(t){return this.queue.emit("close",t),{done:!0}}}});function Pr(e){return e[Ht]||(e[Ht]=Object.create(null))}function _l(e,t){let r=e.prototype,s={},n=t.attributes||t.properties||[];for(let o of n){let c=o.name,u;switch(o.type){case"String":u=a(function(l){if(!(typeof l=="string"||l==null&&o.nullable!==!1))throw new ss.ClientError(`${c} must be a string, attempt to assign ${l}`);Pr(this)[c]=l},"set");break;case"ID":u=a(function(l){if(!(typeof l=="string"||l?.length>0&&l.every?.(d=>typeof d=="string")||l==null&&o.nullable!==!1))throw new ss.ClientError(`${c} must be a string, attempt to assign ${l}`);Pr(this)[c]=l},"set");break;case"Float":u=a(function(l){if(!(typeof l=="number"||l==null&&o.nullable!==!1))throw new ss.ClientError(`${c} must be a number, attempt to assign ${l}`);Pr(this)[c]=l},"set");break;case"Int":u=a(function(l){if(!(l>>0===l||l==null&&o.nullable!==!1))if(typeof l=="number"&&Math.abs((l>>0)-l)<=1)l=Math.round(l);else throw new ss.ClientError(`${c} must be an integer between -2147483648 and 2147483647, attempt to assign ${l}`);Pr(this)[c]=l},"set");break;case"Long":u=a(function(l){if(!(Math.round(l)===l&&Math.abs(l)<=9007199254740992||l==null&&o.nullable!==!1))if(typeof l=="number"&&Math.abs(l)<=9007199254740992)l=Math.round(l);else throw new ss.ClientError(`${c} must be an integer between -9007199254740992 and 9007199254740992, attempt to assign ${l}`);Pr(this)[c]=l},"set");break;case"Boolean":u=a(function(l){if(!(typeof l=="boolean"||l==null&&o.nullable!==!1))throw new ss.ClientError(`${c} must be a boolean, attempt to assign ${l}`);Pr(this)[c]=l},"set");break;case"Date":u=a(function(l){if(!(l instanceof Date||l==null&&o.nullable!==!1))if(typeof l=="string"||typeof l=="number")l=new Date(l);else throw new ss.ClientError(`${c} must be a Date, attempt to assign ${l}`);Pr(this)[c]=l},"set");break;case"Bytes":u=a(function(l){if(!(l instanceof Uint8Array||l==null&&o.nullable!==!1))throw new ss.ClientError(`${c} must be a Buffer or Uint8Array, attempt to assign ${l}`);Pr(this)[c]=l},"set");break;case"Any":case void 0:u=a(function(l){Pr(this)[c]=l},"set");break;default:u=a(function(l){if(!(typeof l=="object"||l==null&&o.nullable!==!1))throw new ss.ClientError(`${c} must be an object, attempt to assign ${l}`);Pr(this)[c]=l},"set")}let _=s[c]={get(){let l=this[Ht];if(l&&c in l)return l[c];let d=this[ge]?.[c];if(d&&typeof d=="object"){let f=yA(d,o);if(f)return l||(l=this[Ht]=Object.create(null)),l[c]=f}return d},set:u,enumerable:!0,configurable:!0};_.get.isAttribute=!0,(!(c in r)||Object.getOwnPropertyDescriptor(r,c)?.get?.isAttribute)&&Object.defineProperty(r,c,_)}i("getProperty",function(o){let c=s[o];if(c)return c.get.call(this);let u=this[Ht];return u?.[o]!==void 0?u[o]:this[ge]?.[o]}),i("set",function(o,c){let u=s[o];if(u)return u.set.call(this,c);if(t.sealed)throw new ss.ClientError("Can not add a property to a sealed table schema");Pr(this)[o]=c}),i("deleteProperty",function(o){Pr(this)[o]=void 0}),i("toJSON",function(){let o=this[Ht],c;for(let _ in o)c||(c=Object.assign({},this[ge])),c[_]=o[_];return Object.keys(this).length>0&&(c||(c=Object.assign({},this[ge])),Object.assign(c,this)),c||this[ge]}),r.get||i("get",r.getProperty),r.delete||i("delete",r.deleteProperty);function i(o,c){Object.defineProperty(r,o,{value:c,configurable:!0})}a(i,"setMethod")}function yA(e,t){let r;switch(e.constructor){case Object:return t?((r=t.TrackedObject)||(t.TrackedObject=r=class{static{a(this,"TrackedObject")}constructor(n){this[ge]=n}},_l(r,t)),new r(e)):new cl(e);case Array:let s=new ll(e.length);s[ge]=e;for(let n=0,i=e.length;n<i;n++){let o=e[n];o&&typeof o=="object"&&(o=yA(o,t?.elements)),s[n]=o}return s}}function dl(e){let t=e[Ht],r;for(let n in t){r||(r=Object.assign({},e[ge]));let i=t[n];i&&typeof i=="object"&&(i=dl(i)),r[n]=i}return Object.keys(e).length>0&&(r||(r=Object.assign({},e[ge])),Object.assign(r,e)),r||e[ge]}function qa(e){let t;if(e[ge]&&e.constructor===Array&&!Object.isFrozen(e)){t=e;for(let s=0,n=e.length;s<n;s++){let i=e[s];if(i&&typeof i=="object"){let o=qa(i);o!==i&&t===e&&(t=e.slice(0)),i=o}t[s]=i}return Object.freeze(t)}let r=e[Ht];for(let s in r){t||(t=Object.assign({},e[ge]));let n=r[s];n&&typeof n=="object"&&(n=qa(n)),t[s]=n}return t?Object.freeze(t):e[ge]||(e.buffer?e:Object.freeze(e))}function ul(e){let t=e[ge];if(t===void 0)return!0;if(e.constructor===Array){if(!t||e[di]||e.length!==t.length)return!0;for(let r=0,s=e.length;r<s;r++){let n=t[r],i=e[r];if(n&&i?.[ge]===n){if(ul(i))return!0}else return!0}}else{let r=e[Ht];if(r&&!t)return!0;for(let s in r){let n=r[s];if(n&&typeof n=="object"){let i=t[s];if(i&&n[ge]===i){if(ul(n))return!0}else return!0}else return!0}}return!1}var ss,Ht,cl,di,ll,fl=Te(()=>{ns();ss=M(j()),Ht=Symbol("own-data");a(Pr,"getChanges");a(_l,"assignTrackedAccessors");a(yA,"trackObject");cl=class{static{a(this,"GenericTrackedObject")}constructor(t){this[ge]=t}};_l(cl,{});a(dl,"collapseData");a(qa,"deepFreeze");a(ul,"hasChanges");di=Symbol.for("has-array-changes"),ll=class extends Array{static{a(this,"TrackedArray")}[di];constructor(t){super(t)}splice(...t){return this[di]=!0,super.splice(...t)}push(...t){return this[di]=!0,super.push(...t)}pop(){return this[di]=!0,super.pop()}unshift(...t){return this[di]=!0,super.unshift(...t)}shift(){return this[di]=!0,super.shift()}};ll.prototype.constructor=Array});function WG(){KG=setInterval(function(){for(let e of bE)if(e.stale){let t=e[fe]?.url;IA.error(`Transaction was open too long and has been aborted, from table: ${e.lmdbDb?.name+(t?" path: "+t:"")}`),e.resetReadSnapshot()}else e.stale=!0},YG).unref()}var yE,IA,$G,bE,fi,El,YG,KG,IE=Te(()=>{yE=M(Er()),IA=M(G());ns();$G=100,bE=new Set,fi=class{static{a(this,"DatabaseTransaction")}writes=[];lmdbDb;readTxn;readTxnRefCount;validated=0;timestamp=0;open=!0;getReadTxn(){return this.readTxnRefCount=(this.readTxnRefCount||0)+1,this.stale&&(this.stale=!1),this.readTxn?this.readTxn:(this.readTxn=this.lmdbDb.useReadTransaction(),bE.add(this),this.readTxn)}disregardReadTxn(){--this.readTxnRefCount===0&&this.resetReadSnapshot()}resetReadSnapshot(){this.readTxn&&(bE.delete(this),this.readTxn.done(),this.readTxn=null)}addWrite(t){this.writes.push(t)}removeWrite(t){let r=this.writes.indexOf(t);r>-1&&(this.writes[r]=null)}commit(t={}){let r=this.timestamp;r||(r=this.timestamp=t.timestamp=t.timestamp||(0,yE.getNextMonotonicTime)());let s=t.retries||0;if(this.resetReadSnapshot(),this.validated<this.writes.length){let l=this.validated;this.validated=this.writes.length;for(let f=l;f<this.validated;f++)this.writes[f]?.validate?.(this.timestamp);let d;for(let f=l;f<this.validated;f++){let E=this.writes[f];E&&(E.before||E.beforeIntermediate)&&(d=!0)}if(d)return(async()=>{for(let f=0;f<2;f++){let E;for(let h=l;h<this.validated;h++){let p=this.writes[h];if(!p)continue;let S=p[f===0?"before":"beforeIntermediate"];if(S){let g=S();E?E.push?E.push(g):E=[E,g]:E=g}}E&&await(E.push?Promise.all(E):E)}return this.commit(t)})()}t?.close&&(this.open=!1);let n,i=[],o=0;this.writes=this.writes.filter(l=>l);let c=a(l=>{l.commit(r,l.entry,s)},"doWrite"),u=a(()=>{let l=this.writes[o++];if(l)if(l.key){s>0&&(l.entry=l.store.getEntry(l.key));let d=l.store.ifVersion(l.key,l.entry?.version??null,u);n=n||d}else u();else for(let d of this.writes)c(d)},"nextCondition");if(this.writes.length<$G>>s?u():n=this.writes[0].store.transaction(()=>{for(let l of this.writes)l.entry=l.store.getEntry(l.key),c(l);return!0}),n)return n.then(l=>l?(this.next&&i.push(this.next.commit(t)),t?.flush&&i.push(this.writes[0].store.flushed),this.writes=[],this.next=null,Promise.all(i).then(()=>({txnTime:r}))):(t?t.retries=s+1:t={retries:1},this.commit(t)));let _={txnTime:r};if(this.next){let l=this.next?.commit(t);if(l?.then)return l?.then(d=>({txnTime:r,next:d}));_.next=l}return _}abort(){this.resetReadSnapshot(),this.writes=[]}},El=class extends fi{static{a(this,"ImmediateTransaction")}_timestamp;addWrite(t){super.addWrite(t),this.commit()}get timestamp(){return this._timestamp||(this._timestamp=(0,yE.getNextMonotonicTime)())}getReadTxn(){}},YG=3e4;a(WG,"startMonitoringTxns");WG()});function Ge(e,t,r){if(!t)t=e,e={};else if(!e)e={};else if(e?.transaction&&typeof t=="function")return t(e.transaction);if(typeof t!="function")throw new Error("Callback function must be provided to transaction");let s=e.transaction=new fi;e.timestamp&&(s.timestamp=e.timestamp),s[fe]=e,e.resourceCache||(e.resourceCache=[]);let n;try{if(n=t(s),n?.then)return n.then(i,o)}catch(c){o(c)}return i(n);function i(c){let u=s.commit({close:!0});return u.then?u.then(()=>(r?.resetTransaction&&(e.transaction=null),c)):(r?.resetTransaction&&(e.transaction=null),c)}function o(c){throw s.abort(),r?.resetTransaction&&(e.transaction=null),c}}var wA,Ei=Te(()=>{wA=require("../../index");ns();IE();a(Ge,"transaction");(0,wA._assignPackageExport)("transaction",Ge);Ge.commit=function(e){let t=(e[fe]||e)?.transaction;if(!t)throw new Error("No active transaction is available to commit");return t.commit()};Ge.abort=function(e){let t=(e[fe]||e)?.transaction;if(!t)throw new Error("No active transaction is available to abort");return t.abort()}});function LE(e,t,r,s,n){let i=e[0]??e.attribute,o,c,u,_,l=e[1]??e.value;l instanceof Date&&(l=l.getTime());let d=e.comparator,f;switch(DA[d]||d){case"lt":o=!0,c=l;break;case"le":o=!0,c=l,u=!0;break;case"gt":o=l,_=!0;break;case"ge":o=l;break;case"prefix":o=l,c=l.slice(0),c[c.length-1]=Is.MAXIMUM_KEY;break;case"starts_with":o=l.toString(),c=l+String.fromCharCode(65535);break;case"between":o=l[0],o instanceof Date&&(o=o.getTime()),c=l[1],c instanceof Date&&(c=c.getTime()),u=!0;break;case ht.SEARCH_TYPES.EQUALS:case void 0:o=l,c=l,u=!0;break;case"ne":case"contains":case"ends_with":f=!0;break}if(r){let S=o;o=c,c=S,S=!_,_=!u,u=S}let E=i===s.primaryKey||i==null,h=E?s.primaryStore:s.indices[i];if(!h||h.isIndexing||f){if(!n)throw new wE.ClientError(`"${i}" is not indexed${h?.isIndexing?" yet":""}, can not search for this attribute`,404);let S=DE(e);if(!S)throw new wE.ClientError(`Unknown search operator ${e.comparator}`);return s.primaryStore.getRange({start:!0,transaction:t,reverse:r}).map(({key:g,value:b})=>new Promise((O,Y)=>setImmediate(()=>{try{O(b&&S(b)?g:LA.SKIP)}catch(Q){Y(Q)}})))}let p={start:o,end:c,inclusiveEnd:u,exclusiveStart:_,values:!E,transaction:t,reverse:r};return E?h.getRange(p):h.getRange(p).map(({value:S})=>S)}function DE(e){let t=e.comparator,r=e[0]??e.attribute,s=e[1]??e.value;switch(s instanceof Date&&(s=s.getTime()),DA[t]||t){case ht.SEARCH_TYPES.EQUALS:case void 0:return ys(r,n=>n===s);case ht.SEARCH_TYPES.CONTAINS:return ys(r,n=>n?.toString().includes(s));case ht.SEARCH_TYPES.ENDS_WITH:case ht.SEARCH_TYPES._ENDS_WITH:return ys(r,n=>n?.toString().endsWith(s));case ht.SEARCH_TYPES.STARTS_WITH:case ht.SEARCH_TYPES._STARTS_WITH:return ys(r,n=>typeof n=="string"&&n.startsWith(s));case ht.SEARCH_TYPES.BETWEEN:return s[0]instanceof Date&&(s[0]=s[0].getTime()),s[1]instanceof Date&&(s[1]=s[1].getTime()),ys(r,n=>(0,Is.compareKeys)(n,s[0])>=0&&(0,Is.compareKeys)(n,s[1])<=0);case"gt":case ht.SEARCH_TYPES.GREATER_THAN:case ht.SEARCH_TYPES._GREATER_THAN:return ys(r,n=>(0,Is.compareKeys)(n,s)>0);case"ge":case ht.SEARCH_TYPES.GREATER_THAN_EQUAL:case ht.SEARCH_TYPES._GREATER_THAN_EQUAL:return ys(r,n=>(0,Is.compareKeys)(n,s)>=0);case ht.SEARCH_TYPES.LESS_THAN:case"lt":case ht.SEARCH_TYPES._LESS_THAN:return ys(r,n=>(0,Is.compareKeys)(n,s)<0);case"le":case ht.SEARCH_TYPES.LESS_THAN_EQUAL:case ht.SEARCH_TYPES._LESS_THAN_EQUAL:return ys(r,n=>(0,Is.compareKeys)(n,s)<=0);case"ne":return ys(r,n=>(0,Is.compareKeys)(n,s)!==0);default:return}}function ys(e,t){return r=>{let s=r[e];return typeof s!="object"||!s?t(s):Array.isArray(s)?s.some(t):s instanceof Date?t(s.getTime()):!1}}function hl(e){if(!e)return;let t=new CE,r,s,n,i,o,c=CA;for(;r=c.exec(e);){i=c.lastIndex;let[,u,_]=r;switch(_){case")":case")&":switch(o){case"limit":if(u.indexOf(",")>-1){let[l,d]=u.split(",");t.offset=+l,t.limit=d-t.offset}else t.limit=+u;break;case"select":if(u[0]==="["){if(u[u.length-1]!=="]")throw new Error("Unmatched brackets");t.select=u.slice(1,-1).split(","),t.select.asArray=!0}else u.indexOf(",")>-1?t.select=(u.endsWith(",")?u.slice(0,-1):u).split(","):t.select=u;break;case"group-by":throw new Error("Group by is not implemented yet");case"sort":t.sort=u.split(",").map(l=>{switch(l[0]){case"-":return{attribute:l.slice(1),descending:!0};case"+":return{attribute:l.slice(1),descending:!1};default:return{attribute:l,descending:!1}}});break;default:throw new Error(`Unknown query function call ${o}`)}s=void 0;break;case"(":o=u;break;case"=":s?u.length<=2&&(n=u):(n="equals",s=decodeURIComponent(u));break;case"!=":case"<":case"<=":case">":case">=":n=QG[_],s=decodeURIComponent(u);break;case"=*":n="ends_with",s=decodeURIComponent(u);break;case"*":case"*&":t.conditions.push({comparator:n==="ends_with"?"contains":"starts_with",attribute:s,value:decodeURIComponent(u)}),s=null;break;case"":case void 0:case"&":case"|":if(!s)throw new Error(`Unable to parse query, no part before ${_} at ${i} in ${e}`);t.conditions.push({comparator:n,attribute:s,value:decodeURIComponent(u)}),s=void 0;break;default:throw new Error(`Unknown operator ${_} in query ${e}`)}c=s?zG:CA,c.lastIndex=i}if(i!==e.length)throw new Error(`Unable to parse query, unexpected end in ${e}`);return t}var wE,ht,Is,LA,QG,DA,CA,zG,CE,ml=Te(()=>{wE=M(j()),ht=M(ze()),Is=require("ordered-binary"),LA=require("lmdb"),QG={"<":"lt","<=":"le",">":"gt",">=":"ge","!=":"ne"};a(LE,"idsForCondition");DA={greater_than:"gt",greater_than_equal:"ge",less_than:"lt",less_than_equal:"le",not_equal:"ne",">":"gt",">=":"ge","<":"lt","<=":"le","...":"between"};a(DE,"filterByType");a(ys,"attributeComparator");CA=/([^?&|=<>!()*]+)([&|=<>!()*]*)/g,zG=/([^&|*=]+)([&|*=]*)/g;a(hl,"parseQuery");CE=class{static{a(this,"Query")}constructor(){this.conditions=[]}[Symbol.iterator](){return this.conditions[Symbol.iterator]()}get(t){for(let r=0;r<this.conditions.length;r++){let s=this.conditions[r];if(s.attribute===t)return s.value}}}});var PE={};qe(PE,{CONTEXT:()=>fe,ID_PROPERTY:()=>Ie,IS_COLLECTION:()=>ws,RECORD_PROPERTY:()=>ge,Resource:()=>Ot,SAVE_UPDATES_PROPERTY:()=>HA,snake_case:()=>XG});function XG(e){return e[0].toLowerCase()+e.slice(1).replace(/[a-z][A-Z][a-z]/g,t=>t[0]+"_"+t.slice(1))}function UA(e,t){if(e=e.slice(1),e.indexOf("/")===-1)return e.startsWith("$")&&(e=parseInt(e,36)),t.coerceId(decodeURIComponent(e));let r=e.split("/"),s=new ME(r.length);for(let n=0;n<r.length;n++)s[n]=t.coerceId(decodeURIComponent(r[n]));return s}function vr(e,t){s.reliesOnPrototype=!0;let r=t.hasContent;return s;function s(n,i,o){let c,u,_;if(r?o?(_=i,o=o[fe]||o):i?typeof n=="object"&&n&&(!Array.isArray(n)||typeof n[0]=="object")?(_=n,c=_[this.primaryKey]??null,o=i[fe]||i):_=i:(_=n,c=_[Ie]??_[this.primaryKey]??null):i?o=i[fe]||i:n&&typeof n=="object"&&!Array.isArray(n)&&(o=n),c===void 0)if(typeof n=="string")c=n;else if(typeof n=="object"&&n)if(u=n,n[Symbol.iterator]){c=[];for(let f of n){if(typeof f=="object"&&f)break;c.push(f)}c.length===0?c=null:(c.length===1&&(c=c[0]),u.slice&&(u=u.slice(c.length,u.length),u.length===0&&(u=null)))}else{if(typeof(c=n.url)=="string"){let f=c.indexOf("?");if(f>-1){let h=this.parseQuery(c.slice(f+1));u?u=Object.assign(h,u):u=h,c=c.slice(0,f)}let E=this.parsePath(c,o,u);E?.query?(u=E.query,c=E.id):c=E}c===void 0&&(c=n.id??null)}else c=n??null;o||(o={});let l;if(u?.ensureLoaded!=null||u?.async?(l=Object.assign({},t),u?.ensureLoaded!=null&&(l.ensureLoaded=u.ensureLoaded),u.async&&(l.async=u.async)):l=t,o.transaction){let f=this.getResource(c,o,l);return f.then?f.then(d):d(f)}else return Ge(o,()=>{let f=this.getResource(c,o,l);return f.then?f.then(d):d(f)},l);function d(f){if(t.type==="read"&&(f[HA]=!1),o.authorize){o.authorize=!1;let E=t.type==="read"?f.allowRead(o.user,o):t.type==="update"?f.doesExist?.()===!1?f.allowCreate(o.user,o):f.allowUpdate(o.user,o):t.type==="create"?f.allowCreate(o.user,o):f.allowDelete(o.user,o);if(E?.then)return E.then(h=>{if(!h)throw new pl(o.user);return typeof _?.then=="function"?_.then(p=>e(f,u,o,p)):e(f,u,o,_)});if(!E)throw new pl(o.user)}return typeof _?.then=="function"?_.then(E=>e(f,u,o,E)):e(f,u,o,_)}a(d,"authorizeActionOnResource")}}function Br(e,t){let r=new BA.ClientError(`The ${e.constructor.name} does not have a ${t} method implemented`,405);r.allow=[],r.method=t;for(let s of["get","put","post","delete","query","move","copy"])typeof e[s]=="function"&&r.allow.push(s);throw r}function UE(e){let t=e[ge];if(t){let r=e[Ht];return s=>{let n;return e.hasOwnProperty(s)&&typeof(n=e[s])!="function"?n:r&&s in r?r[s]:t[s]}}else return r=>e[r]}function MA(e){if(typeof e=="string")return t=>UE(t)(e);if(typeof e=="object"){if(e.asArray)return r=>{let s=[],n=UE(r);for(let i of e)s.push(n(i));return s};let t=e.forceNulls;return r=>{let s={},n=UE(r);for(let i of e){let o=n(i);o===void 0&&t&&(o=null),s[i]=o}return s}}else throw new Error("Invalid select argument type "+typeof e)}var PA,vA,BA,fe,Ie,ws,HA,ge,JG,Ot,pl,ME,ns=Te(()=>{PA=require("crypto");Ha();vA=require("../../index"),BA=M(j());fl();Ei();ml();fe=Symbol.for("context"),Ie=Symbol.for("primary-key"),ws=Symbol("is-collection"),HA=Symbol("save-updates"),ge=Symbol("stored-record"),JG={json:"application/json",cbor:"application/cbor",msgpack:"application/x-msgpack",csv:"text/csv"},Ot=class{static{a(this,"Resource")}static transactions;constructor(t,r){this[Ie]=t;let s=r?.[fe];this[fe]=s!==void 0?s:r||null}static get=vr(function(t,r,s,n){let i=t.get?.(r);if(i?.then)return i.then(o);return o(i);function o(c){let u;if((u=r?.select)&&c!=null){let _=MA(u);return typeof c?.map=="function"?c.map(_):_(c)}return c}},{type:"read",resetTransaction:!0,ensureLoaded:!0,async:!0});static put=vr(function(t,r,s,n){if(Array.isArray(n)&&t[ws]){let i=[],o=s.authorize;for(let c of n){let u=t.constructor,_=u.getResource(c[u.primaryKey],s,{async:!0});_.then?i.push(_.then(l=>l.put(c,s))):i.push(_.put(c,s))}return Promise.all(i)}return t.put?t.put(n,r):Br(t,"put")},{hasContent:!0,type:"update"});static delete=vr(function(t,r,s,n){return t.delete?t.delete(r):Br(t,"delete")},{hasContent:!1,type:"delete"});static getNewId(){return(0,PA.randomUUID)()}static create(t,r,s){let n;return t==null?n=this.getNewId():Array.isArray(t)&&typeof t[0]!="object"?n=[...t,this.getNewId()]:typeof t!="object"?n=[t,this.getNewId()]:(n=this.getNewId(),s=r,r=t),Ge(s,()=>{let i=new this(n,s),o=i.put?i.put(r):Br(i,"put");return s.newLocation=n,s.createdResource=!0,o?.then?o.then(()=>n):n})}static invalidate=vr(function(t,r,s,n){return t.invalidate?t.invalidate(r):Br(t,"delete")},{hasContent:!1,type:"update"});static post=vr(function(t,r,s,n){return t[Ie]!=null&&t.update?.(),t.post(n,r)},{hasContent:!0,type:"create"});static connect=vr(function(t,r,s,n){return t.connect?t.connect(n,r):Br(t,"connect")},{hasContent:!0,type:"read"});static subscribe=vr(function(t,r,s,n){return t.subscribe?t.subscribe(r):Br(t,"subscribe")},{type:"read"});static publish=vr(function(t,r,s,n){return t[Ie]!=null&&t.update?.(),t.publish?t.publish(n,r):Br(t,"publish")},{hasContent:!0,type:"create"});static search=vr(function(t,r,s,n){let i=t.search?t.search(r):Br(t,"search"),o=s.select;if(o&&s.hasOwnProperty("select")&&i!=null){let c=MA(o);return i.map(c)}return i},{type:"read"});static query=vr(function(t,r,s,n){return t.search?t.search(n,r):Br(t,"search")},{hasContent:!0,type:"read"});static copy=vr(function(t,r,s,n){return t.copy?t.copy(n,r):Br(t,"copy")},{type:"create"});static move=vr(function(t,r,s,n){return t.move?t.move(n,r):Br(t,"move")},{type:"delete"});post(t){if(this[ws])return this.constructor.create(this[Ie],t,this[fe]);Br(this,"post")}static isCollection(t){return t?.[ws]}static coerceId(t){return t}static parseQuery(t){return hl(t)}static parsePath(t,r,s){let n=t.indexOf(".");if(n>-1){let i=t.slice(n+1);t=t.slice(0,n);let o=r?.headers&&JG[i];if(o)r.headers.set("accept",o);else if(s)s.property=i;else return{query:{property:i},id:UA(t,this)}}return UA(t,this)}static getResource(t,r,s){let n,i=r[fe],o;typeof r.isCollection=="boolean"&&r.hasOwnProperty("isCollection")?o=r.isCollection:o=t==null||Array.isArray(t)&&t[t.length-1]==null;let c=o&&this.Collection||this;if(i||(i=i===void 0?r:{}),i.transaction){let u;if(i.resourceCache?u=i.resourceCache:u=i.resourceCache=[],u.asMap){let _=u.asMap.get(t);if(n=_?.find(l=>l.constructor===c),n)return n;_||u.asMap.set(t,_=[]),_.push(n=new c(t,i))}else{if(n=u.find(_=>_[Ie]===t&&_.constructor===c),n)return n;if(u.push(n=new c(t,i)),u.length>10){let _=new Map;for(let l of u){let d=l[Ie],f=_.get(d);f?f.push(l):_.set(d,[l])}i.resourceCache.length=0,i.resourceCache.asMap=_}}}else n=new c(t,i);return o&&(n[ws]=!0),n}subscribe(t){return new rs}connect(t){return t?.subscribe!==!1?this.subscribe?.(t):new rs}allowRead(t){return t?.role.permission.super_user}allowUpdate(t){return t?.role.permission.super_user}allowCreate(t){return t?.role.permission.super_user}allowDelete(t){return t?.role.permission.super_user}getId(){return this[Ie]}getContext(){return this[fe]}};Ot.prototype[fe]=null;(0,vA._assignPackageExport)("Resource",Ot);a(XG,"snake_case");pl=class extends Error{static{a(this,"AccessError")}constructor(t){t?(super("Unauthorized access to resource"),this.statusCode=403):(super("Must login"),this.statusCode=401)}};a(UA,"pathToId");ME=class extends Array{static{a(this,"MulitPartId")}toString(){return this.join("/")}};a(vr,"transactional");a(Br,"missingMethod");a(UE,"selectFromObject");a(MA,"transformForSelect")});var hi={};qe(hi,{server:()=>ut});var qA,ut,hr=Te(()=>{qA=require("../../index"),ut={};(0,qA._assignPackageExport)("server",ut)});var BE={};qe(BE,{loadGQLSchema:()=>ex,start:()=>vE,startOnMainThread:()=>ZG});function vE({ensureTable:e}){return{handleFile:t,setupFile:t};async function t(r,s,n,i){let{parse:o,Source:c,Kind:u,NamedTypeNode:_,StringValueNode:l}=await import("graphql"),d=o(new c(r.toString(),n)),f=new Map,E=[],h;for(let S of d.definitions)switch(S.kind){case u.OBJECT_TYPE_DEFINITION:let Q=function(F){if(F.kind==="NonNullType"){let B=Q(F.type);return B.nullable=!1,B}if(F.kind==="ListType")return{type:"array",elements:Q(F.type)};let K={type:F.name?.value};return Object.defineProperty(K,"location",{value:F.loc.startToken}),K};a(Q,"getProperty");let g=S.name.value,b=[],O={table:null,database:null,properties:b};f.set(g,O);for(let F of S.directives){if(F.name.value==="table"){for(let w of F.arguments)O[w.name.value]=w.value.value;O.schema&&(O.database=O.schema),O.table||(O.table=g),O.audit&&(O.audit=O.audit!=="false"),O.attributes=O.properties,E.push(O)}if(F.name.value==="sealed"&&(O.sealed=!0),F.name.value==="export"){O.export=!0;for(let w of F.arguments)w.name.value==="name"&&(O.export={name:w.value.value})}}let Y=!1;for(let F of S.fields){let w=Q(F.type);w.name=F.name.value,b.push(w);for(let K of F.directives)if(K.name.value==="primaryKey")Y?console.warn("Can not define two attributes as a primary key"):(w.isPrimaryKey=!0,Y=!0);else if(K.name.value==="indexed")w.indexed=!0;else if(K.name.value==="createdTime")w.assignCreatedTime=!0;else if(K.name.value==="updatedTime")w.assignUpdatedTime=!0;else if(K.name.value==="expiresAt")w.expiresAt=!0;else if(K.name.value==="allow"){let B=w.authorizedRoles=[];for(let x of K.arguments)x.name.value==="role"&&B.push(x.value.value)}}O.typeName=g,g==="Query"&&(h=O)}function p(S){let g=f.get(S.type);g?S.properties=g.properties:S.type==="array"?p(S.elements):jG.includes(S.type)||(0,FA.getWorkerIndex)()===0&&console.error(`The type ${S.type} is unknown at line ${S.location.line}, column ${S.location.column}, in ${n}`)}a(p,"connectPropertyType");for(let S of f.values())for(let g of S.properties)p(g);for(let S of E)S.tableClass=e(S),S.export&&(S.export.name===""?i.set((0,Sl.dirname)(s),S.tableClass):i.set((0,Sl.dirname)(s)+"/"+(S.export.name||S.typeName),S.tableClass));if(h)for(let S of h.properties){let g=f.get(S.type);if(!g)throw new Error(`${S.type} was not found as a Query export`);i.set((0,Sl.dirname)(s)+"/"+S.name,g.tableClass)}}}var Sl,FA,jG,ZG,ex,GA=Te(()=>{Sl=require("path");Ee();FA=M(Je()),jG=["ID","Int","Float","Long","String","Boolean","Date","Bytes","Any"];a(vE,"start");ZG=vE,ex=vE({ensureTable:et}).handleFile});async function Tl(e){return tx?(Fa||(Fa=rx(nx)),(await(await Fa).import(e)).namespace):import(e)}async function rx(e){let{StaticModuleRecord:t}=await import("@endo/static-module-record");return require("ses"),lockdown({domainTaming:"unsafe",consoleTaming:"unsafe",errorTaming:"unsafe",errorTrapping:"none",stackFiltering:"verbose"}),Fa=new Compartment({console,Math,Date,fetch:sx,...e()},{},{name:"h-dapp",resolveHook(r,s){return r==="harperdb"?"harperdb":(r=new URL(r,s).toString(),(0,kA.extname)(r)||(r+=".js"),r)},importHook:async r=>{if(r==="harperdb")return{imports:[],exports:["Resource","tables","databases"],execute(n){Object.assign(n,{Resource:Ot,tables:mr,databases:xe})}};let s=await(0,xA.readFile)(new URL(r),{encoding:"utf-8"});return new t(s,r)}}),Fa}function sx(e,t){let r=typeof e=="string"||e.url;if(new URL(r).protocol!="https")throw new Error("Only https is allowed in fetch");return fetch(e,t)}function nx(){return{Resource:Ot,tables:mr}}var xA,kA,tx,Fa,HE=Te(()=>{ns();Ee();xA=require("fs/promises"),kA=require("path"),tx=!1;a(Tl,"secureImport");a(rx,"getCompartment");a(sx,"secureOnlyFetch");a(nx,"getGlobalVars")});var FE={};qe(FE,{handleFile:()=>ix});async function ix(e,t,r,s){let n=new Map,i=(0,VA.pathToFileURL)(r).toString(),o=await Tl(i);u(o.default)&&s.set((0,qE.dirname)(t),o.default),c(o,(0,qE.dirname)(t));function c(_,l){for(let d in _){let f=_[d];u(f)?s.set(l+"/"+d,f):typeof f=="object"&&c(f,l+"/"+d)}}a(c,"recurseForResources");function u(_){return typeof _=="function"&&(_.get||_.put||_.post||_.delete)}return a(u,"isResource"),n}var VA,qE,$A=Te(()=>{VA=require("url");HE();qE=require("path");a(ix,"handleFile")});var xE={};qe(xE,{start:()=>ox});function ox({resources:e}){e.set("login",GE),e.loginPath=t=>"/login?redirect="+encodeURIComponent(t.url)}var GE,YA=Te(()=>{ns();a(ox,"start");GE=class extends Ot{static{a(this,"Login")}static async get(t,r,s){}static async post(t,r,s){let{username:n,password:i,redirect:o}=r;return{data:await s.login(n,i)}}}});var VE=T((Yne,QA)=>{"use strict";var{Readable:ax}=require("stream"),cx=1e4;QA.exports={streamAsJSON(e){return new kE({value:e})}};var kE=class extends ax{static{a(this,"JSONStream")}constructor(t){super(t),this.buffer=[],this.bufferSize=0,this.iterator=this.serialize(t.value,!0),this.activeIterators=[]}*serialize(t){if(t&&typeof t=="object"){let r=t[Symbol.asyncIterator],s=t[Symbol.iterator];if((s||r)&&!t.then){yield"[";let n=!0;if((r||s)&&!(t instanceof Array)){let i=r?t[Symbol.asyncIterator]():t[Symbol.iterator]();this.activeIterators.push(i);let o;for(;;)if(o=i.next(),o.then&&(yield o.then(c=>(o=c,""))),o.done){this.activeIterators.splice(this.activeIterators.indexOf(i),1),yield"]";return}else n?n=!1:yield",",yield*this.serialize(o.value)}for(let i of t)n?n=!1:yield",",yield*this.serialize(i);yield"]";return}if(t.then)try{yield t.then(n=>this.serialize(n),KA)}catch(n){yield KA(n)}else yield JSON.stringify(t)}else yield JSON.stringify(t)}_read(){if(!this._amReading){if(this._amReading=!0,this.done)return this.push(null);WA(this.readIterator(this.iterator),t=>{t?(this.done=!0,this.push(null)):this._amReading=!1},t=>{console.error(t),this.done=!0,this.push(t.toString()),this.push(null)})}}push(t){return t===null||t instanceof Buffer?(this.bufferSize>0&&this.flush(),super.push(t)):(this.bufferSize+=t.length||t.toString().length,this.buffer.push(t),this.bufferSize>cx?this.flush():!0)}flush(){let t=super.push(this.buffer.join(""));return this.buffer=[],this.bufferSize=0,t}readIterator(t){try{let r;if(t.childIterator)return WA(this.readIterator(t.childIterator),s=>{if(s)return t.childIterator=null,this.readIterator(t)});do{let s=t.next();if(s.done)return!0;if(r=s.value,r==null)r="null";else{if(r.then)return this.flush(),Promise.resolve(r).then(n=>{if(n&&typeof n.return=="function")return t.childIterator=n,this.readIterator(t);if(this.push(n+""))return this.readIterator(t)});if(typeof r.return=="function")return t.childIterator=r,this.readIterator(t)}}while(this.push(r))}catch(r){return console.error(r),this.push(r.toString()),this.push(null),!0}}_destroy(t,r){for(let s of this.activeIterators)t?s.throw(t):s.return();r()}};function KA(e){return console.error(e),JSON.stringify(e.toString())}a(KA,"handleError");function WA(e,t,r){return e&&e.then?r?e.then(t,r):e.then(t):t(e)}a(WA,"when")});var aO=T((Qne,oO)=>{"use strict";var $E=require("recursive-iterator"),ux=require("alasql"),YE=require("clone"),zA=$(),{handleHDBError:JA,hdb_errors:lx}=j(),{HDB_ERROR_MSGS:XA,HTTP_STATUS_CODES:jA}=lx,{getDatabases:_x}=(Ee(),Z(Ce)),dx=["DISTINCT_ARRAY"],ZA=Symbol("validateTables"),KE=Symbol("validateTable"),Wne=Symbol("getAllColumns"),eO=Symbol("validateAllColumns"),gl=Symbol("findColumn"),tO=Symbol("validateOrderBy"),Ga=Symbol("validateSegment"),WE=Symbol("validateColumn"),rO=Symbol("setColumnsForTable"),sO=Symbol("checkColumnsForAsterisk"),nO=Symbol("validateGroupBy"),iO=Symbol("hasColumns"),QE=class{static{a(this,"SelectValidator")}constructor(t){this.statement=t,this.attributes=[]}validate(){if(!this.statement)throw new Error("invalid sql statement");this[ZA](),this[sO](),this[eO]()}[ZA](){if(this[iO]()){if(!this.statement.from||this.statement.from.length===0)throw"no from clause";this.statement.from.forEach(t=>{this[KE](t)}),this.statement.joins&&this.statement.joins.forEach(t=>{t.table.as=t.as,this[KE](t.table)})}}[iO](){let t=!1,r=new $E(this.statement);for(let{node:s,path:n}of r)if(s&&s.columnid){t=!0;break}return t}[KE](t){if(!t.databaseid)throw`schema not defined for table ${t.tableid}`;let r=_x();if(!r[t.databaseid])throw JA(new Error,XA.SCHEMA_NOT_FOUND(t.databaseid),jA.NOT_FOUND);if(!r[t.databaseid][t.tableid])throw JA(new Error,XA.TABLE_NOT_FOUND(t.databaseid,t.tableid),jA.NOT_FOUND);r[t.databaseid][t.tableid].attributes.forEach(n=>{let i=YE(n);i.table=YE(t),this.attributes.push(i)})}[gl](t){return this.attributes.filter(r=>t.tableid?(r.table.as===t.tableid||r.table.tableid===t.tableid)&&r.attribute===t.columnid:r.attribute===t.columnid)}[sO](){let t=new $E(this.statement.columns);for(let{node:r,path:s}of t)r&&r.columnid==="*"&&s.indexOf("expression")<0&&this[rO](r.tableid)}[rO](t){this.attributes.forEach(r=>{(!t||t&&(r.table.tableid===t||r.table.as===t))&&this.statement.columns.push(new ux.yy.Column({columnid:r.attribute,tableid:r.table.as?r.table.as:r.table.tableid}))})}[eO](){this[Ga](this.statement.columns,!1),this[Ga](this.statement.joins,!1),this[Ga](this.statement.where,!1),this[nO](this.statement.group,!1),this[Ga](this.statement.order,!0)}[Ga](t,r){if(!t)return;let s=new $E(t),n=[];for(let{node:i,path:o}of s)!zA.isEmpty(i)&&!zA.isEmpty(i.columnid)&&i.columnid!=="*"&&(r?this[tO](i):n.push(this[WE](i)));return n}[nO](t){if(!t)return;let r=[];if(this.statement.columns.forEach(s=>{if(!(s.funcid&&dx.indexOf(s.funcid.toUpperCase())>=0)){if(!s.aggregatorid&&!s.columnid){let n=YE(s);delete n.as,r.push(n)}else if(s.columnid){let n=this[gl](s)[0];n&&r.push(n)}}}),this.statement.group.forEach(s=>{let n=null;if(!s.columnid)r.forEach((i,o)=>{if(i.toString()===s.toString()){n=i,r.splice(o,1);return}});else{let i=this[gl](s);if(!i||i.length===0)throw`unknown column '${s.toString()}' in group by`;if(i.length>1)throw`ambiguously defined column '${s.toString()}' in group by`;r.forEach((o,c)=>{if(o.attribute===i[0].attribute&&o.table.tableid===i[0].table.tableid){n=o,r.splice(c,1);return}})}if(!n)throw`group by column '${s.toString()}' must be in select`}),r.length>0)throw`select column '${r[0].attribute?r[0].attribute:r[0].toString()}' must be in group by`}[tO](t){let r=this.statement.columns.filter(s=>s.as===t.columnid);if(r.length>1)throw`ambiguous column reference ${(t.tableid?t.tableid+".":"")+t.columnid} in order by`;r.length===0&&this[WE](t)}[WE](t){let r=this[gl](t),s=(t.tableid?t.tableid+".":"")+t.columnid;if(r.length===0)throw`unknown column ${s}`;if(r.length>1)throw`ambiguous column reference ${s}`;return r[0]}};oO.exports=QE});var uO=T((Jne,cO)=>{"use strict";var zE=class{static{a(this,"BridgeMethods")}createSchema(){throw new Error("createSchema bridge method is not defined")}dropSchema(){throw new Error("dropSchema bridge method is not defined")}createTable(){throw new Error("createTable bridge method is not defined")}dropTable(){throw new Error("dropTable bridge method is not defined")}createRecords(){throw new Error("createRecords bridge method is not defined")}updateRecords(){throw new Error("updateRecords bridge method is not defined")}async upsertRecords(){throw new Error("upsertRecords bridge method is not defined")}deleteRecords(){throw new Error("deleteRecords bridge method is not defined")}createAttribute(){throw new Error("createAttribute bridge method is not defined")}dropAttribute(){throw new Error("dropAttribute bridge method is not defined")}searchByConditions(){throw new Error("searchByConditions bridge method is not defined")}searchByHash(){throw new Error("searchByHash bridge method is not defined")}searchByValue(){throw new Error("searchByValue bridge method is not defined")}getDataByHash(){throw new Error("getDataByHash bridge method is not defined")}getDataByValue(){throw new Error("getDataByValue bridge method is not defined")}deleteRecordsBefore(){throw new Error("deleteRecordsBefore bridge method is not defined")}deleteAuditLogsBefore(){throw new Error("deleteAuditLogsBefore bridge method is not defined")}async readAuditLog(){throw new Error("readAuditLog bridge method is not defined")}};cO.exports=zE});var _O=T((jne,lO)=>{"use strict";var JE=class{static{a(this,"DBIDefinition")}constructor(t=!1,r=!1){this.dup_sort=t,this.is_hash_attribute=r,this.useVersions=r}};lO.exports=JE});var OO={};qe(OO,{AUDIT_STORE_OPTIONS:()=>RO,createAuditEntry:()=>Ol,openAuditStore:()=>Al,readAuditEntry:()=>pr,setAuditRetention:()=>fx,transactionKeyEncoder:()=>gO});function Al(e){let t=e.auditStore=e.openDB(mO.AUDIT_STORE_NAME,RO);t.rootStore=e;let r=[];return t.addDeleteRemovalCallback=function(s,n){return r[s]=n,{remove(){delete r[s]}}},(0,SO.getWorkerIndex)()===0&&e.on("aftercommit",()=>{xa||(xa=setTimeout(()=>{if(xa=null,t.rootStore.status!=="closed")for(let{key:s,value:n}of t.getRange({start:0,end:Date.now()-XE})){if((n[0]&15)===ZE){let i=pr(n),o=i.tableId;r[o]?.(i.recordId)}t.remove(s)}},XE/10).unref())}),t}function fx(e){clearTimeout(xa),xa=null,XE=e}function Ol(e,t,r,s,n,i,o){let c=AO[i],u=1;s&&(s>1?io.setFloat64(0,s):Hr.set(rh),u=9),f(0),f(t),d(r),io.setFloat64(u,e),u+=8,n?d(n):Hr[u++]=0,Hr[s?8:0]=c;let l=Hr.subarray(0,u);if(o)return Buffer.concat([l,o]);return l;function d(E){let h=u;u+=1,u=(0,oo.writeKey)(E,Hr,u);let p=u-h-1;p>127?p>16383?(th.error("Key or username was too large for audit entry",E),u=h+1,Hr[h]=0):(Hr.copyWithin(h+2,h+1,u),io.setUint16(h,p|32768),u++):Hr[h]=p}function f(E){E<128?Hr[u++]=E:E<16384?(io.setUint16(u,E|32768),u+=2):E<1056964608?(io.setUint32(u,E|3221225472),u+=4):(Hr[u]=255,io.setUint32(u+1,E),u+=5)}}function pr(e){try{let t=e.dataView||(e.dataView=new eh(e.buffer,e.byteOffset,e.byteLength)),r;e[0]==66&&(r=t.readFloat64());let s=t.readInt(),n=t.readInt(),i=t.readInt(),o=t.readInt(),c=t.position,u=t.position+=o,_=t.readFloat64();o=t.readInt();let l=t.position,d=t.position+=o;return{type:AO[s&7],tableId:i,get recordId(){return hO(e,c,u)},version:_,previousLocalTime:r,get user(){return d>l?hO(e,l,d):void 0},getValue(f){return s&jE?f.decoder.decode(e.subarray(t.position)):void 0}}}catch{return th.error("Reading audit entry error",e),{}}}function hO(e,t,r){let s=e.subarray(t,r);return(0,oo.readKey)(s,0,r-t)}var oo,Rl,mO,pO,SO,TO,th,Hr,io,gO,RO,XE,xa,jE,dO,ZE,fO,EO,AO,eh,ao=Te(()=>{oo=require("ordered-binary"),Rl=M(X()),mO=M(ze()),pO=M(y()),SO=M(Je()),TO=M($());Va();th=M(G());(0,Rl.initSync)();Hr=Buffer.alloc(1024),io=new DataView(Hr.buffer,Hr.byteOffset,1024),gO={writeKey(e,t,r){return e===ka?(t.set(ka,r),r+8):typeof e=="number"?((t.dataView||(t.dataView=new DataView(t.buffer,t.byteOffset,t.byteLength))).setFloat64(r,e),r+8):(0,oo.writeKey)(e,t,r)},readKey(e,t,r){return e[t]===66?(e.dataView||(e.dataView=new DataView(e.buffer,e.byteOffset,e.byteLength))).getFloat64(t):(0,oo.readKey)(e,t,r)}},RO={encoding:"binary",keyEncoder:gO},XE=(0,TO.convertToMS)((0,Rl.get)(pO.CONFIG_PARAMS.LOGGING_AUDITRETENTION))||86400*3,xa=null;a(Al,"openAuditStore");a(fx,"setAuditRetention");jE=16,dO=1,ZE=2,fO=3,EO=4,AO={put:dO|jE,[dO]:"put",delete:ZE,[ZE]:"delete",message:fO|jE,[fO]:"message",invalidate:EO,[EO]:"invalidate"};a(Ol,"createAuditEntry");a(pr,"readAuditEntry");eh=class extends DataView{static{a(this,"Decoder")}position=0;readInt(){let t=this.getUint8(this.position++);return t>=128?t>=192?t===255?(t=this.getUint32(this.position),this.position+=4,t):(t=this.getUint32(this.position-1)&1073741823,this.position+=3,t):(t=this.getUint16(this.position-1)&32767,this.position++,t):t}readFloat64(){try{let t=this.getFloat64(this.position);return this.position+=8,t}catch{debugger}}};a(hO,"readKeySafely")});var CO={};qe(CO,{HAS_EXPIRATION:()=>ch,LAST_TIMESTAMP_PLACEHOLDER:()=>ka,LOCAL_TIMESTAMP:()=>Ex,METADATA:()=>$a,NO_TIMESTAMP:()=>sh,PREVIOUS_TIMESTAMP_PLACEHOLDER:()=>rh,RecordEncoder:()=>ah,TIMESTAMP_ASSIGN_LAST:()=>mx,TIMESTAMP_ASSIGN_NEW:()=>yO,TIMESTAMP_ASSIGN_PREVIOUS:()=>IO,TIMESTAMP_PLACEHOLDER:()=>Nl,TIMESTAMP_RECORD_PREVIOUS:()=>nh,getUpdateRecord:()=>uh,handleLocalTimeForGets:()=>Il});function wO(){return uo[0]=uo[0]^64,hx.getFloat64(0)}function Il(e){let t=e.getEntry;e.getEntry=function(i,o){let c=t.call(this,i,o),u=c?.value,_=u?.[$a];return _>=0&&(c.metadataFlags=_,c.localTime=u.localTime,c.value=u.value,u.expiresAt>0&&(c.expiresAt=u.expiresAt)),c};let r=e.get;e.get=function(i,o){let c=r.call(this,i,o);return c?.[$a]>=0?c.value:c};let s=e.getRange;e.getRange=function(i){let o=s.call(this,i);return i.valuesForKey?o.map(c=>c?.value):i.values===!1?o:o.map(c=>{let u=c.value,_=u[$a];return _>=0&&(c.metadataFlags=_,c.localTime=u.localTime,c.value=u.value,u.expiresAt>0&&(c.expiresAt=u.expiresAt)),c})},e.env.metadataRetriever||(e.env.metadataRetriever=!0,e.on("aftercommit",({next:i,last:o})=>{do{let c=i.meta,u=c&&c.store;if(u&&!(i.flag&67108864)){let _=u.cache;if(c.key){let l=px.call(_,c.key);if(l&&l.timestampBytes){let d=l.timestampOffset;l.timestampBytes[d]===2&&(l.timestampBytes.copy(uo,0,d),l.timestampBytes=null,l.localTime=wO())}}}}while(i!=o&&(i=i.next))}));let n=e.useReadTransaction();if(n.done(),!n.done.isTracked){let i=n.constructor,o=n.use,c=n.done;i.prototype.use=function(){this.timerTracked||(this.timerTracked=!0,mi.push(new WeakRef(this))),o.call(this)},i.prototype.done=function(){if(c.call(this),this.isDone)for(let u=0;u<mi.length;u++){let _=mi[u].deref();(!_||_===this||_.isDone||_.isCommitted)&&mi.splice(u--,1)}},i.prototype.done.isTracked=!0}return e}function uh(e,t,r){return function(s,n,i,o,c=-1,u,_,l,d="put",f,E){if(f||u==null?co=i?.localTime?nh|IO:sh:co=u?i?.localTime?nh|16384:yO|16384:sh,l>0&&(c|=ch),yl=c,oh=l,i?.version===o&&u===!1)throw new Error("Must retain local time if version is not changed");let h={version:o,instructedWrite:co>0},p;try{f&&(h.ifVersion=p=i?.version??null);let S=e.put(s,n,h);if(e.cache&&S.result!==!1){let g=e.cache.get(s);g&&(c>=0?g.metadataFlags=c:g.metadataFlags>=0&&(g.metadataFlags=void 0),(l||!g.expiresAt)&&(g.expiresAt=l),h.instructedWrite&&(g.localTime||(g.localTime=1),g.timestampBytes=ih,g.timestampOffset=ih.start||0))}if(u){let g=_?.user?.username;if(E&&(bl=e.encoder.encode(E)),f&&i?.localTime){let b=i?.localTime,O=r.get(b);if(O){let Y=pr(O).previousLocalTime;return r.put(b,Ol(o,t,s,Y,g,d,bl),{ifVersion:p}),S}}r.put(ka,Ol(o,t,s,i?.localTime?1:0,g,d,bl),{append:d!=="invalidate",instructedWrite:!0,ifVersion:p})}return S}catch(S){throw S.message+=" id: "+s+" options: "+h,S}}}var NO,bO,Nl,ka,rh,Ex,$a,uo,hx,sh,yO,mx,IO,nh,ch,ih,bl,co,yl,oh,ah,px,mi,Va=Te(()=>{NO=require("msgpackr");ao();bO=M(G()),Nl=new Uint8Array([1,1,1,1,4,64,0,0]),ka=new Uint8Array([1,1,1,1,1,0,0,0]),rh=new Uint8Array([1,1,1,1,3,64,0,0]),Ex=Symbol("local-timestamp"),$a=Symbol("metadata"),uo=new Uint8Array(8),hx=new DataView(uo.buffer,0,8),sh=0,yO=0,mx=1,IO=3,nh=4,ch=16,co=0,yl=-1,oh=0,ah=class extends NO.Encoder{static{a(this,"RecordEncoder")}constructor(t){super(t);let r=this.encode;this.encode=function(s,n){if(co||yl>=0){let i=0,o=co;o&&(i+=8,co=0);let c=yl,u=oh;c>=0&&(i+=2,yl=-1,u&&(i+=8,oh=0));let _=ih=r.call(this,s,n|2048|i);bl=_.subarray((_.start||0)+i,_.end);let l=_.start||0;return o&&(Nl[4]=o,Nl[5]=o>>8,_.set(Nl,l),l+=8),c>=0&&(_[l++]=c,_[l++]=0,u&&(_.dataView||(_.dataView=new DataView(_.buffer,_.byteOffset,_.byteLength))).setFloat64(l,u)),_}else return r.call(this,s,n)}}decode(t,r){let s=r?.start||0,n=r>-1?r:r?.end||t.length,i=t[s],o=0;try{if(i<32&&n>2){let c=s,u;if(i===2){if(t.copy)t.copy(uo,0,c),c+=8;else for(let d=0;d<8;d++)uo[d]=t[c++];u=wO(),i=t[c]}let _;i<32&&(o=i,c+=2,o&ch&&(_=(t.dataView||(t.dataView=new DataView(t.buffer,t.byteOffset,t.byteLength))).getFloat64(c),c+=8));let l=super.decode(t.subarray(c,n),n-c);return{localTime:u,value:l,[$a]:o,expiresAt:_}}return super.decode(t,r)}catch(c){throw c.message+=", data: "+t.slice(0,40).toString("hex"),c}}};a(wO,"getTimestamp");px=Map.prototype.get;a(Il,"handleLocalTimeForGets");mi=[];setInterval(()=>{for(let e=0;e<mi.length;e++){let t=mi[e].deref();!t||t.isDone||t.isCommitted?mi.splice(e--,1):t.notCurrent&&(t.openTimer?(t.openTimer>3&&bO.error("Read transaction detected that has been open too long (over one minute), make sure read transactions are quickly closed",t,Array.from(t.activeQueries||[]).map(r=>({url:r.url,headers:r.headers,method:r.method,conditions:r.conditions}))),t.openTimer++):t.openTimer=1)}},15e3).unref();a(uh,"getUpdateRecord")});var wl=T((nie,LO)=>{"use strict";var _h=X(),dh=y(),{RecordEncoder:Sx}=(Va(),Z(CO));_h.initSync();var Tx=_h.get(dh.CONFIG_PARAMS.STORAGE_COMPRESSION),gx=_h.get(dh.CONFIG_PARAMS.STORAGE_CACHING)!==!1,Rx=dh.UPDATES_PROPERTY,lh=class{static{a(this,"OpenDBIObject")}constructor(t,r=!1){this.dupSort=t===!0,this.encoding=t?"ordered-binary":"msgpack",this.useVersions=r,this.compression=Tx&&r&&{startingOffset:32},this.sharedStructuresKey=Symbol.for("structures"),r&&(this.cache=gx&&{validated:!0},this.randomAccessStructure=!0,this.freezeData=!0,this.encoder={Encoder:Sx},this.alwaysLazyProperty=s=>s===Rx)}};LO.exports=lh});var Ll=T((oie,UO)=>{"use strict";var lo=X(),Ya=y();lo.initSync();var Ax=lo.get(Ya.CONFIG_PARAMS.STORAGE_WRITEASYNC)===!0||lo.get(Ya.CONFIG_PARAMS.STORAGE_WRITEASYNC)==="true"||lo.get(Ya.CONFIG_PARAMS.STORAGE_WRITEASYNC)==="TRUE",DO=lo.get(Ya.CONFIG_PARAMS.STORAGE_OVERLAPPINGSYNC),Ox=lo.get(Ya.CONFIG_PARAMS.STORAGE_NOREADAHEAD),Cl=class{static{a(this,"OpenEnvironmentObject")}constructor(t,r=!1){this.path=t,this.mapSize=1073741824,this.maxDbs=1e4,this.maxReaders=1e3,this.sharedStructuresKey=Symbol.for("structures"),this.readOnly=r,this.trackMetrics=!0,this.noSync=Ax,this.noFSAccess=!0,DO!==void 0&&(this.overlappingSync=DO),this.noReadAhead=Ox}};UO.exports=Cl;Cl.MAX_DBS=1e4});var De=T((cie,kO)=>{"use strict";var Eh=require("lmdb"),is=require("fs-extra"),Sr=require("path"),Dl=Er(),vO=G(),Qt=fr().LMDB_ERRORS_ENUM,Ul=_O(),hh=wl(),BO=Ll(),Bn=ze(),MO=y(),{table:Nx,resetDatabases:bx}=(Ee(),Z(Ce)),PO=X(),os=Bn.INTERNAL_DBIS_NAME,HO=Bn.DBI_DEFINITION_NAME,yx="data.mdb",Ix="lock.mdb",Ka=".mdb",wx="-lock",fh=class{static{a(this,"TransactionCursor")}constructor(t,r,s=!1){this.dbi=qr(t,r),this.key_type=this.dbi[Bn.DBI_DEFINITION_NAME].key_type,this.is_hash_attribute=this.dbi[Bn.DBI_DEFINITION_NAME].is_hash_attribute,this.txn=t.beginTxn({readOnly:s===!1}),this.cursor=new Eh.Cursor(this.txn,this.dbi)}close(){this.cursor.close(),this.txn.abort()}commit(){this.cursor.close(),this.txn.commit()}};function Ml(e,t){if(e===void 0)throw new Error(Qt.BASE_PATH_REQUIRED);if(t===void 0)throw new Error(Qt.ENV_NAME_REQUIRED)}a(Ml,"pathEnvNameValidation");async function mh(e,t,r=!0){try{await is.access(e)}catch(s){throw s.code==="ENOENT"?new Error(Qt.INVALID_BASE_PATH):s}try{let s=Sr.join(e,t+Ka);return await is.access(s,is.constants.R_OK|is.constants.F_OK),s}catch(s){if(s.code==="ENOENT")if(r)try{return await is.access(Sr.join(e,t,yx),is.constants.R_OK|is.constants.F_OK),Sr.join(e,t)}catch(n){if(n.code==="ENOENT")throw new Error(Qt.INVALID_ENVIRONMENT)}else throw new Error(Qt.INVALID_ENVIRONMENT);throw s}}a(mh,"validateEnvironmentPath");function Pl(e,t){if(Dl.validateEnv(e),t===void 0)throw new Error(Qt.DBI_NAME_REQUIRED)}a(Pl,"validateEnvDBIName");async function Cx(e,t,r=!1,s=!1){Ml(e,t);let n=Sr.basename(e);t=t.toString();let i=PO.get(MO.CONFIG_PARAMS.DATABASES);i||PO.setProperty(MO.CONFIG_PARAMS.DATABASES,i={}),i[n]||(i[n]={}),i[n].path=e;try{return await mh(e,t,s),qO(e,t,r)}catch(o){if(o.message===Qt.INVALID_ENVIRONMENT){let c=Sr.join(e,t);await is.mkdirp(s?c:e);let u=new BO(s?c:c+Ka,!1),_=Eh.open(u);_.dbis=Object.create(null);let l=new hh(!1);_.openDB(os,l),global.lmdb_map===void 0&&(global.lmdb_map=Object.create(null));let d=ph(e,t,r);return _[Bn.ENVIRONMENT_NAME_KEY]=d,global.lmdb_map[d]=_,_}throw o}}a(Cx,"createEnvironment");async function Lx(e,t,r,s=!0){Ml(e,t),t=t.toString();let n=Sr.join(e,t);return Nx({table:t,database:Sr.parse(e).name,path:n,attributes:[{name:"id",isPrimaryKey:!0}]})}a(Lx,"copyEnvironment");async function qO(e,t,r=!1){Ml(e,t),t=t.toString();let s=ph(e,t,r);if(global.lmdb_map===void 0&&(global.lmdb_map=Object.create(null)),global.lmdb_map[s]!==void 0)return global.lmdb_map[s];let n=await mh(e,t),i=Sr.join(e,t+Ka),o=n!=i,c=new BO(n,o),u=Eh.open(c);u.dbis=Object.create(null);let _=GO(u);for(let l=0;l<_.length;l++)qr(u,_[l]);return u[Bn.ENVIRONMENT_NAME_KEY]=s,global.lmdb_map[s]=u,u}a(qO,"openEnvironment");async function Dx(e,t,r=!1){Ml(e,t),t=t.toString();let s=Sr.join(e,t+Ka),n=await mh(e,t);if(global.lmdb_map!==void 0){let i=ph(e,t,r);if(global.lmdb_map[i]){let o=global.lmdb_map[i];await FO(o),delete global.lmdb_map[i]}}await is.remove(n),await is.remove(n===s?n+wx:Sr.join(Sr.dirname(n),Ix))}a(Dx,"deleteEnvironment");async function FO(e){Dl.validateEnv(e);let t=e[Bn.ENVIRONMENT_NAME_KEY];await e.close(),t!==void 0&&global.lmdb_map!==void 0&&delete global.lmdb_map[t]}a(FO,"closeEnvironment");function ph(e,t,r=!1){let n=`${Sr.basename(e)}.${t}`;return r===!0&&(n=`txn.${n}`),n}a(ph,"getCachedEnvironmentName");function Ux(e){Dl.validateEnv(e);let t=Object.create(null),r=qr(e,os);for(let{key:s,value:n}of r.getRange({start:!1}))if(s!==os)try{t[s]=Object.assign(new Ul,n)}catch{vO.warn(`an internal error occurred: unable to parse DBI Definition for ${s}`)}return t}a(Ux,"listDBIDefinitions");function GO(e){Dl.validateEnv(e);let t=[],r=qr(e,os);for(let{key:s}of r.getRange({start:!1}))s!==os&&t.push(s);return t}a(GO,"listDBIs");function Mx(e,t){let s=qr(e,os).getEntry(t),n=new Ul;if(s!==void 0){try{n=Object.assign(n,s.value)}catch{vO.warn(`an internal error occurred: unable to parse DBI Definition for ${s}`)}return n}}a(Mx,"getDBIDefinition");function xO(e,t,r,s=!r){if(Pl(e,t),t=t.toString(),t===os)throw new Error(Qt.CANNOT_CREATE_INTERNAL_DBIS_NAME);try{return qr(e,t)}catch(n){if(n.message===Qt.DBI_DOES_NOT_EXIST){let i=new hh(r,s===!0),o=e.openDB(t,i),c=new Ul(r===!0,s);return o[HO]=c,qr(e,os).putSync(t,c),e.dbis[t]=o,o}throw n}}a(xO,"createDBI");function qr(e,t){if(Pl(e,t),t=t.toString(),e.dbis[t]!==void 0)return e.dbis[t];let r;if(t!==os?r=Mx(e,t):r=new Ul,r===void 0)throw new Error(Qt.DBI_DOES_NOT_EXIST);let s;try{let n=new hh(r.dup_sort,r.useVersions);if(s=e.openDB(t,n),s.db===void 0)throw new Error("MDB_NOTFOUND")}catch(n){throw n.message.includes("MDB_NOTFOUND")===!0?new Error(Qt.DBI_DOES_NOT_EXIST):n}return s[HO]=r,e.dbis[t]=s,s}a(qr,"openDBI");function Px(e,t){Pl(e,t),t=t.toString();let r=qr(e,t),s=r.getStats();return r[Bn.DBI_DEFINITION_NAME].is_hash_attribute&&s.entryCount>0&&s.entryCount--,s}a(Px,"statDBI");async function vx(e,t){try{let r=Sr.join(e,t+Ka);return(await is.stat(r)).size}catch{throw new Error(Qt.INVALID_ENVIRONMENT)}}a(vx,"environmentDataSize");function Bx(e,t){if(Pl(e,t),t=t.toString(),t===os)throw new Error(Qt.CANNOT_DROP_INTERNAL_DBIS_NAME);qr(e,t).dropSync(),e.dbis!==void 0&&delete e.dbis[t],qr(e,os).removeSync(t)}a(Bx,"dropDBI");function Hx(e,t,r){let s;for(let n=0;n<r.length;n++){let i=r[n];if(!e.dbis[i])try{qr(e,i)}catch(o){if(o.message===Qt.DBI_DOES_NOT_EXIST)xO(e,i,i!==t,i===t),s=!0;else throw o}}s&&bx()}a(Hx,"initializeDBIs");kO.exports={openDBI:qr,openEnvironment:qO,createEnvironment:Cx,listDBIs:GO,listDBIDefinitions:Ux,createDBI:xO,dropDBI:Bx,statDBI:Px,deleteEnvironment:Dx,initializeDBIs:Hx,TransactionCursor:fh,environmentDataSize:vx,copyEnvironment:Lx,closeEnvironment:FO}});var $O=T((lie,VO)=>{"use strict";var Sh=class{static{a(this,"InsertRecordsResponseObject")}constructor(t=[],r=[],s=void 0){this.written_hashes=t,this.skipped_hashes=r,this.txn_time=s}};VO.exports=Sh});var KO=T((die,YO)=>{"use strict";var Th=class{static{a(this,"UpdateRecordsResponseObject")}constructor(t=[],r=[],s=void 0,n=[]){this.written_hashes=t,this.skipped_hashes=r,this.txn_time=s,this.original_records=n}};YO.exports=Th});var QO=T((Eie,WO)=>{"use strict";var gh=class{static{a(this,"UpsertRecordsResponseObject")}constructor(t=[],r=void 0,s=[]){this.written_hashes=t,this.txn_time=r,this.original_records=s}};WO.exports=gh});var _o=T((Tie,XO)=>{"use strict";var qx=De(),Fx=$O(),Gx=KO(),xx=QO(),Cs=Er(),Wa=fr().LMDB_ERRORS_ENUM,kx=ze(),en=y(),Vx=$(),$x=require("uuid"),mie=require("lmdb"),{handleHDBError:Yx,hdb_errors:Kx}=j(),{OVERFLOW_MARKER:pie,MAX_SEARCH_KEY_LENGTH:Sie}=kx,zO=X();zO.initSync();var vl=zO.get(en.CONFIG_PARAMS.STORAGE_PREFETCHWRITES),Rh=en.TIME_STAMP_NAMES_ENUM.CREATED_TIME,pi=en.TIME_STAMP_NAMES_ENUM.UPDATED_TIME;async function Wx(e,t,r,s,n=Cs.getNextMonotonicTime()){bh(e,t,r,s),Ah(e,t,r);let i=new Fx,o=[],c=[];for(let u=0;u<s.length;u++){let _=s[u];JO(_,!0,n);let l=Qx(e,t,r,_),d=_[t];o.push(l),c.push(d)}return Oh(o,c,s,i,n)}a(Wx,"insertRecords");function Qx(e,t,r,s){let n=s[t];return e.dbis[t].ifNoExists(n,()=>{for(let i=0;i<r.length;i++){let o=r[i];if(o===t||s.hasOwnProperty(o)===!1)continue;let c=s[o];if(typeof c=="function"){let l=c([[{}]]);Array.isArray(l)&&(c=l[0][en.FUNC_VAL],s[o]=c)}let u=Cs.getIndexedValues(c),_=e.dbis[o];if(u){vl&&_.prefetch(u.map(l=>({key:l,value:n})),Bl);for(let l=0,d=u.length;l<d;l++)_.put(u[l],n)}}vl&&e.dbis[t].prefetch([n],Bl),e.dbis[t].put(n,s,s[pi])})}a(Qx,"insertRecord");function zx(e,t=[]){let r=0;for(let s=0;s<t.length;s++){let n=t[s];e.splice(n-r,1),r++}}a(zx,"removeSkippedRecords");function JO(e,t,r){let s=r>0;(s||!Number.isInteger(e[pi]))&&(e[pi]=r||(r=Cs.getNextMonotonicTime())),t===!0?(s||!Number.isInteger(e[Rh]))&&(e[Rh]=r||Cs.getNextMonotonicTime()):delete e[Rh]}a(JO,"setTimestamps");function Ah(e,t,r){r.indexOf(en.TIME_STAMP_NAMES_ENUM.CREATED_TIME)<0&&r.push(en.TIME_STAMP_NAMES_ENUM.CREATED_TIME),r.indexOf(en.TIME_STAMP_NAMES_ENUM.UPDATED_TIME)<0&&r.push(en.TIME_STAMP_NAMES_ENUM.UPDATED_TIME),qx.initializeDBIs(e,t,r)}a(Ah,"initializeTransaction");async function Jx(e,t,r,s,n=Cs.getNextMonotonicTime()){bh(e,t,r,s),Ah(e,t,r);let i=new Gx,o=[],c=[],u=[];for(let _=0;_<s.length;_++){let l=s[_],d=l[t],f;try{f=Nh(e,t,l,d,i,!0,n)}catch{i.skipped_hashes.push(d),o.push(_);continue}c.push(f),u.push(d)}return Oh(c,u,s,i,n,o)}a(Jx,"updateRecords");async function Xx(e,t,r,s,n=Cs.getNextMonotonicTime()){try{bh(e,t,r,s)}catch(u){throw Yx(u,u.message,Kx.HTTP_STATUS_CODES.BAD_REQUEST)}Ah(e,t,r);let i=new xx,o=[],c=[];for(let u=0;u<s.length;u++){let _=s[u],l;Vx.isEmpty(_[t])?(l=$x.v4(),_[t]=l):l=_[t];let d=Nh(e,t,_,l,i,!1,n);o.push(d),c.push(l)}return Oh(o,c,s,i,n)}a(Xx,"upsertRecords");async function Oh(e,t,r,s,n,i=[]){let o=await Promise.all(e);for(let c=0,u=o.length;c<u;c++)o[c]===!0?s.written_hashes.push(t[c]):(s.skipped_hashes.push(t[c]),i.push(c));return s.txn_time=n||Cs.getNextMonotonicTime(),zx(r,i),s}a(Oh,"finalizeWrite");function Nh(e,t,r,s,n,i=!1,o){let c=e.dbis[t],u=c.getEntry(s),_=u?.value,l=_;if(!_){if(i)return!1;_={}}if(JO(r,!l,o),Number.isInteger(r[pi])&&_[pi]>r[pi])return!1;l&&n.original_records.push(_);let d,f=a(()=>{for(let h in r){if(!r.hasOwnProperty(h)||h===t)continue;let p=r[h],S=e.dbis[h];if(S===void 0)continue;let g=_[h];if(typeof p=="function"){let O=p([[_]]);Array.isArray(O)&&(p=O[0][en.FUNC_VAL],r[h]=p)}if(p===g)continue;let b=Cs.getIndexedValues(g);if(b){vl&&S.prefetch(b.map(O=>({key:O,value:s})),Bl);for(let O=0,Y=b.length;O<Y;O++)S.remove(b[O],s)}if(b=Cs.getIndexedValues(p),b){vl&&S.prefetch(b.map(O=>({key:O,value:s})),Bl);for(let O=0,Y=b.length;O<Y;O++)S.put(b[O],s)}}let E=Object.assign({},_,r);c.put(s,E,E[pi])},"do_put");return u?d=c.ifVersion(s,u.version,f):d=c.ifNoExists(s,f),d.then(E=>E?!0:Nh(e,t,r,s,n,i,o))}a(Nh,"updateUpsertRecord");function jx(e,t,r){if(Cs.validateEnv(e),t===void 0)throw new Error(Wa.HASH_ATTRIBUTE_REQUIRED);if(!Array.isArray(r))throw r===void 0?new Error(Wa.WRITE_ATTRIBUTES_REQUIRED):new Error(Wa.WRITE_ATTRIBUTES_MUST_BE_ARRAY)}a(jx,"validateBasic");function bh(e,t,r,s){if(jx(e,t,r),!Array.isArray(s))throw s===void 0?new Error(Wa.RECORDS_REQUIRED):new Error(Wa.RECORDS_MUST_BE_ARRAY)}a(bh,"validateWrite");function Bl(){}a(Bl,"noop");XO.exports={insertRecords:Wx,updateRecords:Jx,upsertRecords:Xx}});var Si=T((Rie,Zx)=>{Zx.exports={hdb_table:{hash_attribute:"id",name:"hdb_table",schema:"system",residence:["*"],attributes:[{attribute:"id"},{attribute:"name"},{attribute:"hash_attribute"},{attribute:"schema"},{attribute:"residence"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_attribute:{hash_attribute:"id",name:"hdb_attribute",schema:"system",residence:["*"],attributes:[{attribute:"id"},{attribute:"schema"},{attribute:"table"},{attribute:"attribute"},{attribute:"schema_table"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_schema:{hash_attribute:"name",name:"hdb_schema",schema:"system",residence:["*"],attributes:[{attribute:"name"},{attribute:"createddate"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_user:{hash_attribute:"username",name:"hdb_user",schema:"system",residence:["*"],attributes:[{attribute:"username"},{attribute:"password"},{attribute:"role"},{attribute:"active"},{attribute:"hash"},{attribute:"refresh_token"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_role:{hash_attribute:"id",name:"hdb_role",schema:"system",attributes:[{attribute:"id"},{attribute:"role"},{attribute:"permission"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}],residence:["*"]},hdb_job:{hash_attribute:"id",name:"hdb_job",schema:"system",attributes:[{attribute:"id"},{attribute:"user"},{attribute:"type"},{attribute:"status"},{attribute:"start_datetime"},{attribute:"end_datetime"},{attribute:"message"},{attribute:"created_datetime"},{attribute:"request"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_license:{hash_attribute:"license_key",name:"hdb_license",schema:"system",attributes:[{attribute:"license_key"},{attribute:"company"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_info:{hash_attribute:"info_id",name:"hdb_info",schema:"system",attributes:[{attribute:"info_id"},{attribute:"data_version_num"},{attribute:"hdb_version_num"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_nodes:{hash_attribute:"name",name:"hdb_nodes",schema:"system",attributes:[{attribute:"name"},{attribute:"subscriptions"},{attribute:"system_info"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_analytics:{hash_attribute:"id",name:"hdb_analytics",schema:"system",audit:!1,attributes:[{attribute:"id"},{attribute:"time"},{attribute:"metric"}]},hdb_raw_analytics:{hash_attribute:"id",name:"hdb_raw_analytics",schema:"system",audit:!1,attributes:[{attribute:"id"},{attribute:"time"},{attribute:"metrics"}]},hdb_temp:{hash_attribute:"id",name:"hdb_temp",schema:"system",attributes:[{attribute:"id"}]}}});var Ls=T((Aie,eN)=>{"use strict";var ZO=$(),jO=y(),fo=/^[\x20-\x2E|\x30-\x5F|\x61-\x7E]*$/,tn=require("joi"),Hn={schema_format:{pattern:fo,message:"names cannot include backticks or forward slashes"},schema_length:{minimum:1,maximum:250,tooLong:"cannot exceed 250 characters"}},ek=tn.alternatives(tn.string().min(1).max(Hn.schema_length.maximum).pattern(fo).messages({"string.pattern.base":"{:#label} "+Hn.schema_format.message}),tn.number()).required(),tk=tn.alternatives(tn.string().min(1).max(Hn.schema_length.maximum).pattern(fo).messages({"string.pattern.base":"{:#label} "+Hn.schema_format.message}),tn.number()),rk=tn.alternatives(tn.string().min(1).max(Hn.schema_length.maximum).pattern(fo).messages({"string.pattern.base":"{:#label} "+Hn.schema_format.message}),tn.number()).required();function sk(e,t){return t?typeof t!="string"?`'${e}' must be a string`:t.length?t.length>Hn.schema_length.maximum?`'${e}' maximum of 250 characters`:fo.test(t)?"":`'${e}' has illegal characters`:`'${e}' must be at least one character`:`'${e}' is required`}a(sk,"checkValidTable");function nk(e,t){return ZO.doesSchemaExist(e)?e:t.message(`Database '${e}' does not exist`)}a(nk,"validateSchemaExists");function ik(e,t){let r=t.state.ancestors[0].schema;return ZO.doesTableExist(r,e)?e:t.message(`Table '${e}' does not exist`)}a(ik,"validateTableExists");function ok(e,t){return e.toLowerCase()===jO.SYSTEM_SCHEMA_NAME?t.message(`'subscriptions[${t.state.path[1]}]' invalid database name, '${jO.SYSTEM_SCHEMA_NAME}' name is reserved`):e}a(ok,"validateSchemaName");eN.exports={common_validators:Hn,schema_regex:fo,hdb_schema_table:ek,validateSchemaExists:nk,validateTableExists:ik,validateSchemaName:ok,checkValidTable:sk,hdb_database:tk,hdb_table:rk}});var ke=T((Nie,tN)=>{"use strict";var zt=require("validate.js");zt.validators.type=function(e,t,r,s){return e===null||typeof e>"u"||zt.validators.type.checks[t](e)?null:` must be a '${t}' value`};zt.validators.type.checks={Object:function(e){return zt.isObject(e)&&!zt.isArray(e)},Array:zt.isArray,Integer:zt.isInteger,Number:zt.isNumber,String:zt.isString,Date:zt.isDate,Boolean:function(e){return typeof e=="boolean"}};zt.validators.hasValidFileExt=function(e,t){return zt.isString(e)?e===""?"can't be blank":t.filter(r=>e.endsWith(r)).length>0?null:`must include one of the following valid file extensions - '${t.join("', '")}'`:null};tN.exports={validateObject:ak,validateObjectAsync:ck,validateBySchema:uk};function ak(e,t){if(!e||!t)return new Error("validateObject parameters were null");let r=zt(e,t,{format:"flat"});return r?new Error(r):null}a(ak,"validateObject");async function ck(e,t){if(!e||!t)return new Error("validateObject parameters were null");try{await zt.async(e,t,{format:"flat"})}catch(r){let s=r.join(",");return new Error(s)}return null}a(ck,"validateObjectAsync");function uk(e,t){let r=t.validate(e,{allowUnknown:!0,abortEarly:!1,errors:{wrap:{label:"'"}}});if(r.error)return new Error(r.error.message)}a(uk,"validateBySchema")});var Hl=T((yie,rN)=>{var{common_validators:Ds}=Ls(),za=ke(),Qa="is required",tt={database:{presence:!1,format:Ds.schema_format,length:Ds.schema_length},schema:{presence:!1,format:Ds.schema_format,length:Ds.schema_length},table:{presence:!0,format:Ds.schema_format,length:Ds.schema_length},attribute:{presence:!0,format:Ds.schema_format,length:Ds.schema_length},hash_attribute:{presence:!0,format:Ds.schema_format,length:Ds.schema_length}};function Ja(e){for(let t in e)e[t]=e[t]===null||e[t]===void 0||typeof e[t]=="object"?e[t]:e[t].toString();return e}a(Ja,"makeAttributesStrings");function lk(e){return e=Ja(e),tt.table.presence=!1,tt.attribute.presence=!1,tt.hash_attribute.presence=!1,za.validateObject(e,tt)}a(lk,"schema_object");function _k(e){return e=Ja(e),tt.table.presence={message:Qa},tt.attribute.presence=!1,tt.hash_attribute.presence=!1,za.validateObject(e,tt)}a(_k,"table_object");function dk(e){return e=Ja(e),tt.table.presence={message:Qa},tt.attribute.presence=!1,za.validateObject(e,tt)}a(dk,"create_table_object");function fk(e){return e=Ja(e),tt.table.presence={message:Qa},tt.attribute.presence={message:Qa},tt.hash_attribute.presence=!1,za.validateObject(e,tt)}a(fk,"attribute_object");function Ek(e){return e=Ja(e),tt.table.presence={message:Qa},tt.attribute.presence=!1,tt.hash_attribute.presence=!1,za.validateObject(e,tt)}a(Ek,"describe_table");function hk(e){if(e){if(!Array.isArray(e))throw new Error("residence must be a string array");if(e.length===0)throw new Error("residence cannot be an empty array");for(let t=0;t<e.length;t++)if(typeof e[t]!="string")throw new Error(`residence must be a string array, item '${e[t]}' is not a string`)}}a(hk,"validateTableResidence");rN.exports={schema_object:lk,create_table_object:dk,table_object:_k,attribute_object:fk,describe_table:Ek,validateTableResidence:hk}});var nN=T((wie,sN)=>{"use strict";var mk=require("uuid"),yh=class{static{a(this,"CreateAttributeObject")}constructor(t,r,s,n){this.schema=t,this.table=r,this.attribute=s,this.id=n||mk.v4(),this.schema_table=`${this.schema}.${this.table}`}};sN.exports=yh});var ql=T((Lie,iN)=>{"use strict";var pk=nN(),Ih=class extends pk{static{a(this,"LMDBCreateAttributeObject")}constructor(t,r,s,n,i=!0,o=!1){super(t,r,s,n),this.dup_sort=i,this.is_hash_attribute=o}};iN.exports=Ih});var aN=T((Uie,oN)=>{"use strict";oN.exports=Tk;var Sk="inserted";function Tk(e,t,r,s){let n={message:`${e} ${t.length} of ${r.records.length} records`,skipped_hashes:s};return e===Sk?(n.inserted_hashes=t,n):(n.update_hashes=t,n)}a(Tk,"returnObject")});var Fl=T((Pie,dN)=>{"use strict";var gk=y(),wh=De(),Rk=_o(),{getSystemSchemaPath:Ak,getSchemaPath:Ok}=ve(),Nk=Si(),bk=Hl(),yk=ql(),Ik=aN(),{handleHDBError:cN,hdb_errors:lN}=j(),uN=$(),{HTTP_STATUS_CODES:wk}=lN,Ch=Nk.hdb_attribute,_N=[];for(let e=0;e<Ch.attributes.length;e++)_N.push(Ch.attributes[e].attribute);var Ck="inserted";dN.exports=Lk;async function Lk(e){let t=bk.attribute_object(e);if(t)throw cN(new Error,t.message,lN.HTTP_STATUS_CODES.BAD_REQUEST,void 0,void 0,!0);let r=!e.skip_table_check&&uN.checkGlobalSchemaTable(e.schema,e.table);if(r)throw cN(new Error,r,wk.NOT_FOUND);e.is_hash_attribute=e.is_hash_attribute=="true",e.dup_sort=uN.isEmpty(e.dup_sort)||e.dup_sort=="true";let s=[];if(global.hdb_schema[e.schema]&&global.hdb_schema[e.schema][e.table]&&(s=global.hdb_schema[e.schema][e.table].attributes),Array.isArray(s)&&s.length>0){for(let i of s)if(i.attribute===e.attribute)throw new Error(`attribute '${i.attribute}' already exists in ${e.schema}.${e.table}`)}let n=new yk(e.schema,e.table,e.attribute,e.id);try{let i=await wh.openEnvironment(Ok(e.schema,e.table),e.table);if(i.dbis[e.attribute]!==void 0)throw new Error(`attribute '${e.attribute}' already exists in ${e.schema}.${e.table}`);wh.createDBI(i,e.attribute,e.dup_sort,e.is_hash_attribute);let o=await wh.openEnvironment(Ak(),gk.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME),{written_hashes:c,skipped_hashes:u}=await Rk.insertRecords(o,Ch.hash_attribute,_N,[n]);return Ik(Ck,c,{records:[n]},u)}catch(i){throw i}}a(Lk,"lmdbCreateAttribute")});var Dh=T((Bie,EN)=>{var{hdb_table:Dk,hdb_database:fN}=Ls(),Uk=ke(),Lh=require("joi"),Mk={undefined:"undefined",null:"null"},Pk=a((e,t)=>{let r=Object.keys(e),s=r.length,n;for(let i=0;i<s;i++){let o=r[i];(!o||o.length===0||Mk[o]!==void 0)&&(n===void 0?n=`Invalid attribute name: '${o}'`:n+=`. Invalid attribute name: '${o}'`)}return n?t.message(n):e},"custom_records_val"),vk=Lh.object({database:fN,schema:fN,table:Dk,records:Lh.array().items(Lh.object().custom(Pk)).required()});EN.exports=function(e){return Uk.validateBySchema(e,vk)}});var Xa=T((Fie,mN)=>{"use strict";var rn=$(),hN=G(),qie=Dh(),{getDatabases:Bk}=(Ee(),Z(Ce)),{ClientError:Ti}=j();mN.exports=Hk;function Hk(e){if(rn.isEmpty(e))throw new Ti("invalid update parameters defined.");if(rn.isEmptyOrZeroLength(e.schema))throw new Ti("invalid schema specified.");if(rn.isEmptyOrZeroLength(e.table))throw new Ti("invalid table specified.");if(!Array.isArray(e.records))throw new Ti("records must be an array");let t=Bk()[e.schema]?.[e.table];if(rn.isEmpty(t))throw new Ti(`could not retrieve schema:${e.schema} and table ${e.table}`);let r=t.primaryKey,s=new Set,n={},i=!1;return e.operation==="update"&&(i=!0),e.records.forEach(o=>{if(i&&rn.isEmptyOrZeroLength(o[r]))throw hN.error("a valid hash attribute must be provided with update record:",o),new Ti("a valid hash attribute must be provided with update record, check log for more info");if(!rn.isEmptyOrZeroLength(o[r])&&(o[r]==="null"||o[r]==="undefined"))throw hN.error(`a valid hash value must be provided with ${e.operation} record:`,o),new Ti(`Invalid hash value: '${o[r]}' is not a valid hash attribute value, check log for more info`);!rn.isEmpty(o[r])&&o[r]!==""&&s.has(rn.autoCast(o[r]))&&(o.skip=!0),s.add(rn.autoCast(o[r]));for(let c in o)n[c]=1}),n[r]=1,{schema_table:t,hashes:Array.from(s),attributes:Object.keys(n)}}a(Hk,"insertUpdateValidate")});var ja=T((xie,pN)=>{"use strict";var qk=y().OPERATIONS_ENUM,Uh=class{static{a(this,"InsertObject")}constructor(t,r,s,n,i=void 0){this.operation=qk.INSERT,this.schema=t,this.table=r,this.hash_attribute=s,this.records=n,this.__origin=i}};pN.exports=Uh});var rc=T(($ie,SN)=>{"use strict";var Vie=ja(),Gl=y(),Ph=$(),Mh=G(),Fk=require("uuid"),{handleHDBError:Za,hdb_errors:Gk}=j(),{HDB_ERROR_MSGS:ec,HTTP_STATUS_CODES:tc}=Gk;SN.exports=xk;function xk(e,t,r){for(let n=0;n<t.length;n++)kk(t[n]);let{records:s}=e;for(let n=0;n<s.length;n++){let i=s[n];Vk(i,r,e.operation)}}a(xk,"processRows");function kk(e){if(Buffer.byteLength(String(e))>Gl.INSERT_MODULE_ENUM.MAX_CHARACTER_SIZE)throw Za(new Error,ec.ATTR_NAME_LENGTH_ERR(e),tc.BAD_REQUEST,void 0,void 0,!0);if(Ph.isEmptyOrZeroLength(e)||Ph.isEmpty(e.trim()))throw Za(new Error,ec.ATTR_NAME_NULLISH_ERR,tc.BAD_REQUEST,void 0,void 0,!0)}a(kk,"validateAttribute");function Vk(e,t,r){if(!e.hasOwnProperty(t)||Ph.isEmptyOrZeroLength(e[t])){if(r===Gl.OPERATIONS_ENUM.INSERT||r===Gl.OPERATIONS_ENUM.UPSERT){e[t]=Fk.v4();return}throw Mh.error("Update transaction aborted due to record with no hash value:",e),Za(new Error,ec.RECORD_MISSING_HASH_ERR,tc.BAD_REQUEST,void 0,void 0,!0)}if(Buffer.byteLength(String(e[t]))>Gl.INSERT_MODULE_ENUM.MAX_CHARACTER_SIZE)throw Mh.error(e),Za(new Error,ec.HASH_VAL_LENGTH_ERR,tc.BAD_REQUEST,void 0,void 0,!0);if(isNaN(e[t])&&e[t].includes("/"))throw Mh.error(e),Za(new Error,ec.INVALID_FORWARD_SLASH_IN_HASH_ERR,tc.BAD_REQUEST,void 0,void 0,!0)}a(Vk,"validateHash")});var gN=T((Kie,TN)=>{"use strict";var vh=class{static{a(this,"ITCEventObject")}constructor(t,r){this.type=t,this.message=r}};TN.exports=vh});var ON=T((Qie,AN)=>{"use strict";var Bh=De(),$k=G(),RN=fr().LMDB_ERRORS_ENUM;AN.exports=Yk;async function Yk(e){try{if(global.lmdb_map!==void 0&&e.operation!==void 0){let t=Object.keys(global.lmdb_map),r;switch(e.operation){case"drop_schema":for(let i=0;i<t.length;i++){let o=t[i];if(o.startsWith(`${e.schema}.`)||o.startsWith(`txn.${e.schema}.`))try{await Bh.closeEnvironment(global.lmdb_map[o])}catch(c){if(c.message!==RN.ENV_REQUIRED)throw c}}break;case"drop_table":let s=`${e.schema}.${e.table}`,n=`txn.${s}`;try{await Bh.closeEnvironment(global.lmdb_map[s]),await Bh.closeEnvironment(global.lmdb_map[n])}catch(i){if(i.message!==RN.ENV_REQUIRED)throw i}break;case"drop_attribute":r=global.lmdb_map[`${e.schema}.${e.table}`],r!==void 0&&typeof r.dbis=="object"&&r.dbis[`${e.attribute}`]!==void 0&&delete r.dbis[`${e.attribute}`];break;default:break}}}catch(t){$k.error(t)}}a(Yk,"cleanLMDBMap")});var sn=T((Jie,IN)=>{"use strict";var sc=require("crypto"),Kk=X(),{CONFIG_PARAMS:Wk}=y(),bN="aes-256-cbc",Qk=32,zk=16,Hh=64,yN=32,Jk=Hh+yN,NN=new Map;IN.exports={encrypt:Xk,decrypt:jk,createNatsTableStreamName:Zk};function Xk(e){let t=sc.randomBytes(Qk),r=sc.randomBytes(zk),s=sc.createCipheriv(bN,Buffer.from(t),r),n=s.update(e);n=Buffer.concat([n,s.final()]);let i=t.toString("hex"),o=r.toString("hex"),c=n.toString("hex");return i+o+c}a(Xk,"encrypt");function jk(e){let t=e.substr(0,Hh),r=e.substr(Hh,yN),s=e.substr(Jk,e.length),n=Buffer.from(r,"hex"),i=Buffer.from(s,"hex"),o=sc.createDecipheriv(bN,Buffer.from(t,"hex"),n),c=o.update(i);return c=Buffer.concat([c,o.final()]),c.toString()}a(jk,"decrypt");function Zk(e,t){let r=Kk.get(Wk.CLUSTERING_DATABASELEVEL)?e:`${e}.${t}`,s=NN.get(r);return s||(s=sc.createHash("md5").update(r).digest("hex"),NN.set(r,s)),s}a(Zk,"createNatsTableStreamName")});var gi=T((Zie,CN)=>{"use strict";var jie=Fr(),xl=G(),wN=Hl(),eV=sn(),kl=$(),{handleHDBError:Vl,hdb_errors:tV}=j(),{HDB_ERROR_MSGS:$l,HTTP_STATUS_CODES:qh}=tV,rV=X();rV.initSync();var{getDatabases:Fh}=(Ee(),Z(Ce));CN.exports={describeAll:sV,describeTable:Yl,describeSchema:nV};async function sV(e){try{let t=kl.isEmptyOrZeroLength(e),r,s;t||(r=e.hdb_user.role.permission,s=r.super_user||r.cluster_user);let n=Fh(),i={},o={},c=[],u=e?.exact_count;for(let l in n){i[l]=!0,!t&&!s&&(o[l]=e.hdb_user.role.permission[l].describe);let d=n[l];for(let f in d)try{let E;if(t||s)E=await Yl({schema:l,table:f,exact_count:u});else if(r&&r[l].describe&&r[l].tables[f].describe){let h=r[l].tables[f].attribute_permissions;E=await Yl({schema:l,table:f,exact_count:u},h)}E&&c.push(E)}catch(E){xl.error(E)}}let _={};for(let l in c)t||s?(_[c[l].schema]==null&&(_[c[l].schema]={}),_[c[l].schema][c[l].name]=c[l],i[c[l].schema]&&delete i[c[l].schema]):o[c[l].schema]&&(_[c[l].schema]==null&&(_[c[l].schema]={}),_[c[l].schema][c[l].name]=c[l],i[c[l].schema]&&delete i[c[l].schema]);for(let l in i)t||s?_[l]={}:o[l]&&(_[l]={});return _}catch(t){return xl.error("Got an error in describeAll"),xl.error(t),Vl(new Error,$l.DESCRIBE_ALL_ERR)}}a(sV,"describeAll");async function Yl(e,t){kl.transformReq(e);let{schema:r,table:s}=e;r=r?.toString(),s=s?.toString();let n=t;e.hdb_user&&!e.hdb_user.role.permission.super_user&&(n=e.hdb_user.role.permission[r].tables[s].attribute_permissions);let i=wN.describe_table(e);if(i)throw i;let c=Fh()[r];if(!c)throw Vl(new Error,$l.SCHEMA_NOT_FOUND(e.schema),qh.NOT_FOUND);let u=c[s];if(!u)throw Vl(new Error,$l.TABLE_NOT_FOUND(e.schema,e.table),qh.NOT_FOUND);function _(f){l.push(Object.assign({},{attribute:f.attribute,type:f.type,elements:f.elements?.type,indexed:f.indexed,is_primary_key:f.isPrimaryKey,assigned_created_time:f.assignCreatedTime,assigned_updated_time:f.assignUpdatedTime,nullable:f.nullable,properties:f.properties?f.properties.map(E=>({type:E.type,name:E.name})):void 0}))}a(_,"pushAtt");let l=[];if(n){let f={};n.forEach(E=>{E.describe&&(f[E.attribute_name]=!0)}),u.attributes.forEach(E=>{f[E.name]&&_(E)})}else u.attributes?.forEach(f=>_(f));let d={schema:r,name:u.tableName,hash_attribute:u.attributes.find(f=>f.isPrimaryKey||f.is_hash_attribute)?.name,audit:u.audit,schema_defined:u.schemaDefined,attributes:l};d.clustering_stream_name=eV.createNatsTableStreamName(d.schema,d.name);try{let f=u.getRecordCount({exactCount:e.exact_count==="true"});d.record_count=f.recordCount,d.estimated_record_range=f.estimatedRange;let E=u.auditStore;if(E)for(let h of E.getKeys({reverse:!0,limit:1}))d.last_updated_record=h[0];if(!d.last_updated_record&&u.indices.__updatedtime__)for(let h of u.indices.__updatedtime__.getKeys({reverse:!0,limit:1}))d.last_updated_record=h}catch(f){xl.warn(`unable to stat table dbi due to ${f}`)}return d}a(Yl,"descTable");async function nV(e){kl.transformReq(e);let t=wN.schema_object(e);if(t)throw t;let r;e.hdb_user&&!e.hdb_user.role.permission.super_user&&(r=e.hdb_user.role.permission[e.schema]);let s=e.schema.toString(),i=Fh()[s];if(!i)throw Vl(new Error,$l.SCHEMA_NOT_FOUND(e.schema),qh.NOT_FOUND);let o={};for(let c in i){let u;if(r&&r.tables[c]&&(u=r.tables[c]),kl.isEmpty(u)||u.describe){let _=await Yl({schema:e.schema,table:c,exact_count:e.exact_count},u?u.attribute_permissions:null);_&&(o[_.name]=_)}}return o}a(nV,"describeSchema")});var qn=T((soe,PN)=>{var iV=Si(),{callbackify:DN,promisify:oV}=require("util"),{getDatabases:UN}=(Ee(),Z(Ce));PN.exports={setSchemaDataToGlobal:LN,getTableSchema:aV,getSystemSchema:cV,setSchemaDataToGlobalAsync:oV(LN)};var MN=gi(),toe=DN(MN.describeAll),roe=DN(MN.describeTable);function LN(e){global.hdb_schema=UN(),e&&e()}a(LN,"setSchemaDataToGlobal");function aV(e,t,r){let s=UN()[e];if(!s)return r(`schema ${e} does not exist`);let n=s[t];return n?r(null,{schema:e,name:t,hash_attribute:n.primaryKey}):r(`table ${e}.${t} does not exist`)}a(aV,"getTableSchema");function cV(){return iV}a(cV,"getSystemSchema")});var Gr=T((ioe,qN)=>{"use strict";var Wl=Dh(),Nt=$(),uV=require("util"),Ql=as(),lV=qn(),vN=G(),{handleHDBError:Ri,hdb_errors:_V}=j(),{HTTP_STATUS_CODES:Ai}=_V,dV=uV.promisify(lV.getTableSchema),fV="updated",BN="inserted",HN="upserted";qN.exports={insert:hV,update:mV,upsert:pV,validation:EV,flush:SV};async function EV(e){if(Nt.isEmpty(e))throw new Error("invalid update parameters defined.");if(Nt.isEmptyOrZeroLength(e.schema))throw new Error("invalid database specified.");if(Nt.isEmptyOrZeroLength(e.table))throw new Error("invalid table specified.");let t=await dV(e.schema,e.table),r=Wl(e);if(r)throw r;if(!Array.isArray(e.records))throw new Error("records must be an array");let s=t.hash_attribute,n=new Set,i={},o=!1;return e.operation==="update"&&(o=!0),e.records.forEach(c=>{if(o&&Nt.isEmptyOrZeroLength(c[s]))throw vN.error("a valid hash attribute must be provided with update record:",c),new Error("a valid hash attribute must be provided with update record");if(!Nt.isEmptyOrZeroLength(c[s])&&(c[s]==="null"||c[s]==="undefined"))throw vN.error(`a valid hash value must be provided with ${e.operation} record:`,c),new Error(`"${c[s]}" is not a valid hash attribute value`);!Nt.isEmpty(c[s])&&c[s]!==""&&n.has(Nt.autoCast(c[s]))&&(c.skip=!0),n.add(Nt.autoCast(c[s]));for(let u in c)i[u]=1}),i[s]=1,{schema_table:t,hashes:Array.from(n),attributes:Object.keys(i)}}a(EV,"validation");async function hV(e){if(e.operation!=="insert")throw new Error("invalid operation, must be insert");let t=Wl(e);if(t)throw Ri(new Error,t.message,Ai.BAD_REQUEST);Nt.transformReq(e);let r=Nt.checkSchemaTableExist(e.schema,e.table);if(r)throw Ri(new Error,r,Ai.BAD_REQUEST);let s=await Ql.createRecords(e);return Kl(BN,s.written_hashes,e,s.skipped_hashes,s.new_attributes,s.txn_time)}a(hV,"insertData");async function mV(e){if(e.operation!=="update")throw new Error("invalid operation, must be update");let t=Wl(e);if(t)throw Ri(new Error,t.message,Ai.BAD_REQUEST);Nt.transformReq(e);let r=Nt.checkSchemaTableExist(e.schema,e.table);if(r)throw Ri(new Error,r,Ai.BAD_REQUEST);let s=await Ql.updateRecords(e);return Nt.isEmpty(s.existing_rows)?Kl(fV,s.written_hashes,e,s.skipped_hashes,s.new_attributes,s.txn_time):Kl(s.update_action,[],e,s.hashes,void 0,s.txn_time)}a(mV,"updateData");async function pV(e){if(e.operation!=="upsert")throw Ri(new Error,"invalid operation, must be upsert",Ai.INTERNAL_SERVER_ERROR);let t=Wl(e);if(t)throw Ri(new Error,t.message,Ai.BAD_REQUEST);Nt.transformReq(e);let r=Nt.checkSchemaTableExist(e.schema,e.table);if(r)throw Ri(new Error,r,Ai.BAD_REQUEST);let s=await Ql.upsertRecords(e);return Kl(HN,s.written_hashes,e,[],s.new_attributes,s.txn_time)}a(pV,"upsertData");function Kl(e,t,r,s,n,i){let o={message:`${e} ${t.length} of ${t.length+s.length} records`,new_attributes:n,txn_time:i};return e===BN?(o.inserted_hashes=t,o.skipped_hashes=s,o):e===HN?(o.upserted_hashes=t,o):(o.update_hashes=t,o.skipped_hashes=s,o)}a(Kl,"returnObject");function SV(e){return Nt.transformReq(e),Ql.flush(e.schema,e.table)}a(SV,"flush")});var xh=T((aoe,xN)=>{var TV=ke(),Gh=require("joi"),{hdb_table:gV,hdb_database:FN}=Ls(),GN={schema:FN,database:FN,table:gV},RV={date:Gh.date().iso().required()},AV={timestamp:Gh.date().timestamp().required().messages({"date.format":"'timestamp' is invalid"})};xN.exports=function(e,t){let r=t==="timestamp"?{...GN,...AV}:{...GN,...RV},s=Gh.object(r);return TV.validateBySchema(e,s)}});var $N=T((coe,VN)=>{var OV=ke(),kh=require("joi"),{hdb_table:NV,hdb_database:kN}=Ls(),bV=kh.object({schema:kN,database:kN,table:NV,hash_values:kh.array().required(),ids:kh.array()});VN.exports=function(e){return OV.validateBySchema(e,bV)}});var KN=T((uoe,YN)=>{"use strict";var Vh=class{static{a(this,"InsertObject")}constructor(t,r,s,n,i){this.operation=t,this.schema=r,this.table=s,this.hash_attribute=n,this.records=i}},$h=class{static{a(this,"NoSQLSeachObject")}constructor(t,r,s,n,i,o){this.schema=t,this.table=r,this.search_attribute=s,this.hash_attribute=n,this.get_attributes=i,this.search_value=o}},Yh=class{static{a(this,"DeleteResponseObject")}constructor(){this.message=void 0,this.deleted_hashes=[],this.skipped_hashes=[]}};YN.exports={InsertObject:Vh,NoSQLSeachObject:$h,DeleteResponseObject:Yh}});var bi=T((_oe,XN)=>{"use strict";var QN=xh(),yV=$N(),Oi=$(),WN=require("moment"),zN=G(),{promisify:IV,callbackify:wV}=require("util"),Ni=y(),CV=qn(),Kh=IV(CV.getTableSchema),Wh=as(),{DeleteResponseObject:LV}=KN(),{handleHDBError:Fn,hdb_errors:DV}=j(),{HDB_ERROR_MSGS:zl,HTTP_STATUS_CODES:Gn}=DV,UV="records successfully deleted",MV=wV(JN);XN.exports={delete:MV,deleteRecord:JN,deleteFilesBefore:PV,deleteAuditLogsBefore:vV};async function PV(e){let t=QN(e,"date");if(t)throw Fn(t,t.message,Gn.BAD_REQUEST,void 0,void 0,!0);if(Oi.transformReq(e),!WN(e.date,WN.ISO_8601).isValid())throw Fn(new Error,zl.INVALID_DATE,Gn.BAD_REQUEST,Ni.LOG_LEVELS.ERROR,zl.INVALID_DATE,!0);let s=Oi.checkSchemaTableExist(e.schema,e.table);if(s)throw Fn(new Error,s,Gn.NOT_FOUND,Ni.LOG_LEVELS.ERROR,s,!0);let n=await Wh.deleteRecordsBefore(e);if(await Kh(e.schema,e.table),zN.info(`Finished deleting files before ${e.date}`),n&&n.message)return n.message}a(PV,"deleteFilesBefore");async function vV(e){let t=QN(e,"timestamp");if(t)throw Fn(t,t.message,Gn.BAD_REQUEST,void 0,void 0,!0);if(Oi.transformReq(e),isNaN(e.timestamp))throw Fn(new Error,zl.INVALID_VALUE("Timestamp"),Gn.BAD_REQUEST,Ni.LOG_LEVELS.ERROR,zl.INVALID_VALUE("Timestamp"),!0);let r=Oi.checkSchemaTableExist(e.schema,e.table);if(r)throw Fn(new Error,r,Gn.NOT_FOUND,Ni.LOG_LEVELS.ERROR,r,!0);let s=await Wh.deleteAuditLogsBefore(e);return await Kh(e.schema,e.table),zN.info(`Finished deleting audit logs before ${e.timestamp}`),s}a(vV,"deleteAuditLogsBefore");async function JN(e){e.ids&&(e.hash_values=e.ids);let t=yV(e);if(t)throw Fn(t,t.message,Gn.BAD_REQUEST,void 0,void 0,!0);Oi.transformReq(e);let r=Oi.checkSchemaTableExist(e.schema,e.table);if(r)throw Fn(new Error,r,Gn.NOT_FOUND,Ni.LOG_LEVELS.ERROR,r,!0);try{await Kh(e.schema,e.table);let s=await Wh.deleteRecords(e);return Oi.isEmptyOrZeroLength(s.message)&&(s.message=`${s.deleted_hashes.length} of ${e.hash_values.length} ${UV}`),s}catch(s){if(s.message===Ni.SEARCH_NOT_FOUND_MESSAGE){let n=new LV;return n.message=Ni.SEARCH_NOT_FOUND_MESSAGE,n.skipped_hashes=e.hash_values.length,n.deleted_hashes=0,n}throw s}}a(JN,"deleteRecord")});var Jl=T((foe,eb)=>{var BV=require("crypto"),jN=9;function HV(e){let t=FV(jN),r=ZN(e+t);return t+r}a(HV,"createHash");function qV(e,t){let r=e.substr(0,jN),s=r+ZN(t+r);return e===s}a(qV,"validateHash");function FV(e){let t="0123456789abcdefghijklmnopqurstuvwxyzABCDEFGHIJKLMNOPQURSTUVWXYZ",r=t.length,s="";for(let n=0;n<e;n++){let i=Math.floor(Math.random()*r);s+=t[i]}return s}a(FV,"generateSalt");function ZN(e){return BV.createHash("md5").update(e).digest("hex")}a(ZN,"md5");eb.exports={hash:HV,validate:qV}});var rb=T((hoe,tb)=>{var Qh=ke(),qt={username:{presence:!0,format:"[\\w\\-\\_]+",exclusion:{within:["system"],message:"You cannot create tables within the system schema"}},password:{presence:!0},role:{presence:!0,format:"[\\w\\-\\_]+"},active:{presence:!0,inclusion:{within:[!0,!1],message:"must be a boolean"}}};function GV(e){return qt.password.presence=!0,qt.username.presence=!0,qt.role.presence=!0,qt.active.presence=!0,Qh.validateObject(e,qt)}a(GV,"addUserValidation");function xV(e){return qt.password.presence=!1,qt.username.presence=!0,qt.role.presence=!1,qt.active.presence=!1,Qh.validateObject(e,qt)}a(xV,"alterUserValidation");function kV(e){return qt.password.presence=!1,qt.username.presence=!0,qt.role.presence=!1,qt.active.presence=!1,Qh.validateObject(e,qt)}a(kV,"dropUserValidation");tb.exports={addUserValidation:GV,alterUserValidation:xV,dropUserValidation:kV}});var Ve=T((Soe,nb)=>{"use strict";var{platform:poe}=require("os"),VV="nats-server.zip",zh="nats-server",$V=process.platform==="win32"?`${zh}.exe`:zh,Jh="HDB",YV=/^[^\s.,*>]+$/,sb="__request__",KV=a(e=>`${e}.${sb}`,"REQUEST_SUBJECT"),WV={NATS_MSG_ID:"Nats-Msg-Id",ORIGIN:"origin",TRANSACTED_NODES:"transacted_nodes"},QV={HUB_SERVER:"hub.json",LEAF_SERVER:"leaf.json"},zV={HUB:"hub.pid",LEAF:"leaf.pid"},JV={HUB:"-hub",LEAF:"-leaf",ADMIN:"-admin"},XV={stream_name:"__HARPERDB_WORK_QUEUE__",durable_name:"HDB_WORK_QUEUE",deliver_group:Jh,deliver_subject:"__HDB__.WORKQUEUE"},jV={stream_name:"__HARPERDB_SCHEMA_QUEUE__",durable_name:"HDB_SCHEMA_QUEUE",deliver_group:Jh,deliver_subject:"HDB.SCHEMAQUEUE"},ZV={stream_name:"__HARPERDB_USER_QUEUE__",durable_name:"HDB_USER_QUEUE",deliver_group:Jh,deliver_subject:"HDB.USERQUEUE"},e$={SUCCESS:"success",ERROR:"error"},t$={OPEN:"open",CLOSED:"closed",NO_RESPONDERS:"NoResponders",TIMEOUT:"Timeout"},r$={TXN:"txn",MSGID:"msgid"},Eo={ERR:"error",WRN:"warn",INF:"info",DBG:"debug",TRC:"trace"},s$={[Eo.ERR]:1,[Eo.WRN]:2,[Eo.INF]:3,[Eo.DBG]:4,[Eo.TRC]:5},n$={debug:"-D",trace:"-DVV"};nb.exports={NATS_SERVER_ZIP:VV,NATS_SERVER_NAME:zh,NATS_BINARY_NAME:$V,PID_FILES:zV,NATS_CONFIG_FILES:QV,SERVER_SUFFIX:JV,WORK_QUEUE_CONSUMER_NAMES:XV,SCHEMA_QUEUE_CONSUMER_NAMES:jV,USER_QUEUE_CONSUMER_NAMES:ZV,NATS_TERM_CONSTRAINTS_RX:YV,REQUEST_SUFFIX:sb,UPDATE_REMOTE_RESPONSE_STATUSES:e$,CLUSTER_STATUS_STATUSES:t$,REQUEST_SUBJECT:KV,SUBJECT_PREFIXES:r$,MSG_HEADERS:WV,LOG_LEVELS:Eo,LOG_LEVEL_FLAGS:n$,LOG_LEVEL_HIERARCHY:s$}});var ob=T((goe,ib)=>{"use strict";var i$={key:"-----BEGIN RSA PRIVATE KEY-----\rMIIEowIBAAKCAQEArBFJQRfFiJku/KwhV1Ssp7cX61vvuKmd4Rp6A9jB2QLgx8nj\r/+Xhp2hPRkISnOA8BuAxr4dMD9syGJwX4kNy9mbZ5Q0fWZCiEGBpVcU1J+k+N5K4\rSuZ2SqgxeN2IN2RLzt3GyQY4imcdHgNv7aHoXUrEwBx0MeYEw3IIDXtrYKCR2D8I\rvWBfwMUgWa24G8lpWILWA5hd9srRz9NxlAiHSjhbgT7B0xruEpHRCHSyKjvaIJVt\rWBR+amejYsAKVrD/hgrqjsA1123Y6++YqvU6vwg64xhS2kz5r3dkNKhvwbWgpZdI\rIaRvsiB77f4kLGo0vi8RFgJ1ZRjGg3RRK2w1LQIDAQABAoIBAQCEOmh78EOpnGZC\rYBjjHrvrysVD5gvLcfVUtl8Ls7gMB60re1eOIF+PoZZCHKZnDd6zPfiQtj1adg0C\rYnnsM/8VoaZS4gm0b3RLd3ubIQifWhuo40RissY2yxfxlPSH9LhZCY8ojnJG0cTL\resK579E8WCfopjUY33XLqEbN7Ylv39J+DSqInjqV3efJZUa+HqUJ98VxxzodcKMD\rP3bwUU4gHoSSp4pAsOFH5sQhaIWH1IcNjrAwpee2cJQuh4G157RRIuuUpagtaEG/\rXJIiAyBguJyu3JQFnIBQF01N5+omJgXYJ1L0m54543/iIRThmF3zDCDgCyUzmOk+\rH6As9fv1AoGBANOpOtOZLSAScjGsgJamT3ceJ2wCa86g2j8Oxu8lJUmUp5s3tA0v\rBFW5O3S4KR1EXwkLMBUMrfFM8YvzHWxsXBI6XV8azGLvyqPHxr65OhmpGYkGZMXu\rn9okgjkqlewnY2I073gvyK7ppX51UL5y9fF1vlsk+UlW+Rgx/vMHbdcjAoGBANAc\rxRUsxs4QJpbS4zD3JOkHjr24a97TrS3kCybAHUMpR2NrEHPZw9zex0/aphOJUHfL\rIMkOZdpfDqMfxWy4FAEmqBEMkO2SB+h0Wp4P+qp81ax4vGFiB0cD3wtixr11U1tt\rlZ/ZTdv4VDpDFNK1KaplhTDeyuCjeYfS3/GJia9vAoGAcOsAgjBevZR5rXx84WH6\rVO8WUu37u7FenXNxt9VWTinrPMh72uixZFY8nOk+rely1e1NCn3IMko9Ns9NbDFm\r8SaH95vhXArXTYbfxZIlp9jp0YtCqcHDL+p4Oq04bFMbFyJseu7rHj1x18QYfnHw\rOY/6LL/N6k1m+Hx7qgXVmIcCgYB/w0nTCBw84XlvWqSTqQaF8VfWbWP79mP5KmkW\rLxdH5g2noVEGbohqDnK6OXd/wusdwByukiJBf94Skyy25AOT+VFwthA7aU1ljhkb\rtJ+lDuJ28eBkwLPLCzthWBC+u0qjdJFJAzVjd/7tjcU43nNn4s90AzL12iaAFhvZ\rwyA+DQKBgGc/4cdyGJ3YkcA8150gQBawgJZ7q8V1JND87ggWA8wnK3cHn7rMZQl2\r3emDp9HEFXFex5dbGDDqZFAoesZCDxjknIn9oNfW4PvaWS8q7b6ZKLZG1p03Pu7/\rtYaD0kPbo0kysfFT/co+NgHbdykvIyboomfGdNLTUjYuy6lpwpvs\r-----END RSA PRIVATE KEY-----\r".replace(/\r/g,String.fromCharCode(13,10)),cert:"-----BEGIN CERTIFICATE-----\rMIIDXDCCAkSgAwIBAgIFNTE4MzQwDQYJKoZIhvcNAQELBQAwXTEXMBUGA1UEAxMO\rSGFycGVyREIsIEluYy4xCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJDTzEPMA0GA1UE\rBxMGRGVudmVyMRcwFQYDVQQKEw5IYXJwZXJEQiwgSW5jLjAeFw0yMjAzMTEyMzAz\rNDlaFw0yNzAzMTAyMzAzNDlaMF0xFzAVBgNVBAMTDkhhcnBlckRCLCBJbmMuMQsw\rCQYDVQQGEwJVUzELMAkGA1UECBMCQ08xDzANBgNVBAcTBkRlbnZlcjEXMBUGA1UE\rChMOSGFycGVyREIsIEluYy4wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIB\rAQCsEUlBF8WImS78rCFXVKyntxfrW++4qZ3hGnoD2MHZAuDHyeP/5eGnaE9GQhKc\r4DwG4DGvh0wP2zIYnBfiQ3L2ZtnlDR9ZkKIQYGlVxTUn6T43krhK5nZKqDF43Yg3\rZEvO3cbJBjiKZx0eA2/toehdSsTAHHQx5gTDcggNe2tgoJHYPwi9YF/AxSBZrbgb\ryWlYgtYDmF32ytHP03GUCIdKOFuBPsHTGu4SkdEIdLIqO9oglW1YFH5qZ6NiwApW\rsP+GCuqOwDXXbdjr75iq9Tq/CDrjGFLaTPmvd2Q0qG/BtaCll0ghpG+yIHvt/iQs\rajS+LxEWAnVlGMaDdFErbDUtAgMBAAGjIzAhMA8GA1UdEwEB/wQFMAMBAf8wDgYD\rVR0PAQH/BAQDAgIEMA0GCSqGSIb3DQEBCwUAA4IBAQASR4YW/rPK7PNArHVe9zzM\rb0rKNX/2T9/0nybRhmE/+hdlSgliTAeebmwkUS2APckmekYt/q2ZY2NS65Fo/jjp\rG8TJrtcF4h+ylVqUp0ZXQLFtIsr7r2JZA7hJ6njW6G4DHSZ0gxtECLi4CBlTjzm5\rNmnmIDObvGRTuqmcdAZmXeObbta/He2XIzietukPAYX062pNM+G5XT5UM1eG/Vlp\rN86vjhpyI+ffKy+C60SJqxmKM3ydgN7oLscE7+2wLPN25XqN4W99OwGsp5dTdu/f\r5lPtFayXdJ55e/sNQKmGN+UGLrL05c2MWgjb8U/LFilnupUianceoeSERZmVjzKX\r-----END CERTIFICATE-----\r".replace(/\r/g,String.fromCharCode(13,10))},o$="certificate.pem",a$="privateKey.pem",c$="ca.pem";ib.exports={CERTIFICATE_VALUES:i$,CERTIFICATE_PEM_NAME:o$,PRIVATEKEY_PEM_NAME:a$,CA_PEM_NAME:c$}});var jh=T((Aoe,_b)=>{"use strict";var lb=require("fs-extra"),ue=require("joi"),u$=require("os"),{boolean:we,string:Us,number:bt,array:Xh}=ue.types(),{totalmem:ab}=require("os"),ho=require("path"),l$=G(),jl=$(),Roe=ob(),cb=y(),_$=ke(),ub="log",d$="components",f$="Invalid logging.rotation.maxSize unit. Available units are G, M or K",E$="Invalid logging.rotation.interval unit. Available units are D, H or M (minutes)",h$="Invalid logging.rotation.maxSize value. Value should be a number followed by unit e.g. '10M'",m$="Invalid logging.rotation.interval value. Value should be a number followed by unit e.g. '10D'",p$="rootPath config parameter is undefined",S$="clustering.enabled config parameter is undefined",yi=bt.min(0).required(),Zl=Xh.items({host:Us.required(),port:yi}).empty(null),nn;_b.exports={configValidator:T$,routesValidator:b$,route_constraints:Zl};function T$(e){if(nn=e.rootPath,jl.isEmpty(nn))throw p$;let t=we.required(),r=bt.min(0).max(1e3).empty(null).default(N$),s=Us.pattern(/^[\\\/]$|([\\\/][a-zA-Z_0-9\:-]+)+$/,"directory path").empty(null).default(Xl),n=Us.optional().empty(null),i=Us.pattern(/^[^\s.,*>]+$/).messages({"string.pattern.base":"{:#label} invalid, must not contain ., * or >"}).empty(null).required(),o=ue.string().empty(null).default(Xl),c=ue.custom(R$).empty(null).default(Xl),u=e.clustering?.enabled;if(jl.isEmpty(u))throw S$;let _;return u===!0?_=ue.object({enabled:t,hubServer:ue.object({cluster:ue.object({name:ue.required().empty(null),network:ue.object({port:yi,routes:Zl}).required()}).required(),leafNodes:ue.object({network:ue.object({port:yi}).required()}).required(),network:ue.object({port:yi}).required()}).required(),leafServer:ue.object({network:ue.object({port:yi,routes:Zl}).required(),streams:ue.object({maxAge:bt.min(120).allow(null).optional(),maxBytes:bt.min(1).allow(null).optional(),maxMsgs:bt.min(1).allow(null).optional(),path:o}).required()}).required(),logLevel:ue.valid("error","warn","info","debug","trace"),nodeName:i,republishMessages:we.optional(),databaseLevel:we.optional(),tls:ue.object({certificate:n,certificateAuthority:n,privateKey:n,insecure:we.required(),verify:we.optional()}),user:Us.optional().empty(null)}).required():_=ue.object({enabled:t,tls:ue.object({certificate:n,certificateAuthority:n,privateKey:n,insecure:we.required()})}).required(),ue.object({authentication:ue.object({authorizeLocal:we,cacheTTL:bt.required(),enableSessions:we}),analytics:ue.object({aggregatePeriod:bt}),componentsRoot:s.optional(),clustering:_,localStudio:ue.object({enabled:t}).required(),logging:ue.object({auditAuthEvents:ue.object({logFailed:we,logSuccessful:we}),file:we.required(),level:ue.valid("notify","fatal","error","warn","info","debug","trace"),rotation:ue.object({enabled:we.optional(),compress:we.optional(),interval:Us.custom(O$).optional().empty(null),maxSize:Us.custom(A$).optional().empty(null),path:Us.optional().empty(null).default(Xl)}).required(),root:s,stdStreams:we.required(),auditLog:we.required()}).required(),operationsApi:ue.object({network:ue.object({cors:we.optional(),corsAccessList:Xh.optional(),headersTimeout:bt.min(1).optional(),keepAliveTimeout:bt.min(1).optional(),port:bt.optional().empty(null),securePort:bt.optional().empty(null),timeout:bt.min(1).optional()}).optional(),tls:ue.object({certificate:n,certificateAuthority:n,privateKey:n})}).required(),rootPath:Us.pattern(/^[\\\/]$|([\\\/][a-zA-Z_0-9\:-]+)+$/,"directory path").required(),mqtt:ue.object({network:ue.object({port:yi,securePort:yi}).required(),webSocket:we.optional(),requireAuthentication:we.optional()}),http:ue.object({compressionThreshold:bt.optional(),cors:we.optional(),corsAccessList:Xh.optional(),headersTimeout:bt.min(1).optional(),port:bt.min(0).optional().empty(null),securePort:bt.min(0).optional().empty(null)}).required(),threads:r.optional(),storage:ue.object({writeAsync:we.required(),overlappingSync:we.optional(),caching:we.optional(),compression:we.optional(),noReadAhead:we.optional(),path:c,prefetchWrites:we.optional()}).required(),ignoreScripts:we.optional(),tls:ue.object({certificate:n.optional(),certificateAuthority:n.optional(),privateKey:n.optional()})}).validate(e,{allowUnknown:!0,abortEarly:!1,errors:{wrap:{label:"'"}}})}a(T$,"configValidator");function g$(e){return lb.existsSync(e)?null:`Specified path ${e} does not exist.`}a(g$,"doesPathExist");function R$(e,t){ue.assert(e,Us.pattern(/^[\\\/]$|([\\\/][a-zA-Z_0-9\:-]+)+$/,"directory path"));let r=g$(e);if(r)return t.message(r)}a(R$,"validatePath");function A$(e,t){let r=e.slice(-1);if(r!=="G"&&r!=="M"&&r!=="K")return t.message(f$);let s=e.slice(0,-1);return isNaN(parseInt(s))?t.message(h$):e}a(A$,"validateRotationMaxSize");function O$(e,t){let r=e.slice(-1);if(r!=="D"&&r!=="H"&&r!=="M")return t.message(E$);let s=e.slice(0,-1);return isNaN(parseInt(s))?t.message(m$):e}a(O$,"validateRotationInterval");function N$(e,t){let r=t.state.path.join("."),s=u$.cpus().length,n=s-1;n<=2&&(n=2);let i=process.constrainedMemory?.()||ab();return i=Math.round(Math.min(i,ab())/1e6),n=Math.max(Math.min(n,Math.round((i-750)/300)),1),l$.info(`Detected ${s} cores and ${i}MB on this machine, defaulting ${r} to ${n}`),n}a(N$,"setDefaultThreads");function Xl(e,t){if(!jl.isEmpty(t.original))return t.original;let r=t.state.path.join(".");if(jl.isEmpty(nn))throw new Error(`Error setting default root for: ${r}. HDB root is not defined`);switch(r){case"componentsRoot":return ho.join(nn,d$);case"logging.root":return ho.join(nn,ub);case"clustering.leafServer.streams.path":return ho.join(nn,"clustering","leaf");case"storage.path":let s=ho.join(nn,cb.LEGACY_DATABASES_DIR_NAME);return lb.existsSync(s)?s:ho.join(nn,cb.DATABASES_DIR_NAME);case"logging.rotation.path":return ho.join(nn,ub);default:throw new Error(`Error setting default root for config parameter: ${r}. Unrecognized config parameter`)}}a(Xl,"setDefaultRoot");function b$(e){let t=ue.object({routes:Zl});return _$.validateBySchema({routes:e},t)}a(b$,"routesValidator")});var gr=T((boe,gb)=>{"use strict";var Tr=y(),mt=$(),lt=G(),{configValidator:y$,routesValidator:db}=jh(),Jt=require("fs-extra"),I$=require("yaml"),cs=require("path"),w$=require("is-number"),Eb=require("properties-reader"),C$=require("lodash"),{handleHDBError:L$}=j(),{HTTP_STATUS_CODES:D$,HDB_ERROR_MSGS:e_}=fr(),Noe=require("minimist"),{server:U$}=(hr(),Z(hi)),{DATABASES_PARAM_CONFIG:nc,CONFIG_PARAMS:on,CONFIG_PARAM_MAP:us}=Tr,M$="Unable to get config value because config is uninitialized",P$="Config successfully initialized",v$="Error backing up config file",B$="Empty parameter sent to getConfigValue",hb=cs.join(Tr.PACKAGE_ROOT,"config","yaml",Tr.HDB_DEFAULT_CONFIG_FILE),H$="Configuration successfully set. You must restart HarperDB for new config settings to take effect.",fb={logging_rotation_retain:"logging.rotation.retain",logging_rotation_rotate:"logging.rotation.rotate",logging_rotation_rotateinterval:"logging.rotation.rotateInterval",logging_rotation_rotatemodule:"logging.rotation.rotateModule",logging_rotation_timezone:"logging.rotation.timezone",logging_rotation_workerinterval:"logging.rotation.workerInterval"},t_,yt,r_;gb.exports={createConfigFile:q$,getDefaultConfig:F$,getConfigValue:pb,initConfig:em,flattenConfig:mo,updateConfigValue:Sb,updateConfigObject:x$,getConfiguration:$$,setConfiguration:Y$,readConfigFile:rm,getClusteringRoutes:K$,initOldConfig:Tb,getConfigFromFile:W$,getConfigFilePath:Ii,addConfig:Q$,deleteConfigFromFile:z$,getConfigObj:J$};function q$(e){let t=xn(hb);t_=mo(t.toJSON());let r;for(let o in e){let c=us[o.toLowerCase()];if(c===on.DATABASES){r=e[o];continue}if(!c&&o.endsWith("_package")&&(c=o),c!==void 0){let u=c.split("_"),_=Zh(c,e[o]);c==="rootPath"&&_?.endsWith("/")&&(_=_.slice(0,-1));try{t.setIn([...u],_)}catch(l){lt.error(l)}}}r&&mb(t,r),tm(t);let s=t.toJSON();yt=mo(s);let n=t.getIn(["rootPath"]),i=cs.join(n,Tr.HDB_CONFIG_FILE);Jt.createFileSync(i),Jt.writeFileSync(i,String(t)),lt.trace(`Config file written to ${i}`)}a(q$,"createConfigFile");function mb(e,t){let r;try{try{r=JSON.parse(t)}catch(s){if(!mt.isObject(t))throw s;r=t}for(let s of r){let n=Object.keys(s)[0];if(s[n].hasOwnProperty(nc.TABLES))for(let i in s[n][nc.TABLES])for(let o in s[n][nc.TABLES][i]){let c=s[n][nc.TABLES][i][o],u=[on.DATABASES,n,nc.TABLES,i,o];e.hasIn(u)?e.setIn(u,c):e.addIn(u,c)}else for(let i in s[n]){let o=s[n][i],c=[on.DATABASES,n,i];e.hasIn(c)?e.setIn(c,o):e.addIn(c,o)}}}catch(s){lt.error("Error parsing schemas CLI/env config arguments",s)}}a(mb,"setSchemasConfig");function F$(e){if(t_===void 0){let r=xn(hb);t_=mo(r.toJSON())}let t=us[e.toLowerCase()];if(t!==void 0)return t_[t.toLowerCase()]}a(F$,"getDefaultConfig");function pb(e){if(e==null){lt.error(B$);return}if(yt===void 0){lt.trace(M$);return}let t=us[e.toLowerCase()];if(t!==void 0)return yt[t.toLowerCase()]}a(pb,"getConfigValue");function Ii(e=mt.getPropsFilePath()){let t=mt.getEnvCliRootPath();return t?cs.join(t,Tr.HDB_CONFIG_FILE):Eb(e).get(Tr.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY)}a(Ii,"getConfigFilePath");function em(e=!1){if(yt===void 0||e){let t;if(!mt.noBootFile()){t=mt.getPropsFilePath();try{Jt.accessSync(t,Jt.constants.F_OK|Jt.constants.R_OK)}catch(i){throw lt.error(i),new Error(`HarperDB properties file at path ${t} does not exist`)}}let r=Ii(t),s;if(r.includes("config/settings.js"))try{Tb(r);return}catch(i){if(i.code!==Tr.NODE_ERROR_CODES.ENOENT)throw i}try{s=xn(r)}catch(i){if(i.code===Tr.NODE_ERROR_CODES.ENOENT){lt.trace(`HarperDB config file not found at ${r}. 
				This can occur during early stages of install where the config file has not yet been created`);return}else throw lt.error(i),new Error(`Error reading HarperDB config file at ${r}`)}G$(s,r),tm(s);let n=s.toJSON();if(U$.config=n,yt=mo(n),yt.logging_rotation_rotate)for(let i in fb)yt[i]&&lt.error(`Config ${fb[i]} has been deprecated. Please check https://docs.harperdb.io/docs/ for further details.`);lt.trace(P$)}}a(em,"initConfig");function G$(e,t){let r=e.getIn(["rootPath"]),s=!1;e.hasIn(["storage","path"])||(e.setIn(["storage","path"],cs.join(r,"database")),s=!0),e.hasIn(["clustering","leafServer","streams","path"])||(e.setIn(["clustering","leafServer","streams","path"],cs.join(r,"clustering","leaf")),s=!0),e.hasIn(["logging","rotation","path"])||(e.setIn(["logging","rotation","path"],cs.join(r,"log")),s=!0),e.hasIn(["clustering","tls","verify"])||(e.setIn(["clustering","tls","verify"],!0),s=!0),s&&(lt.trace("Updating config file with missing config params"),Jt.writeFileSync(t,String(e)))}a(G$,"checkForUpdatedConfig");function tm(e){let t=e.toJSON();t.componentsRoot=t.componentsRoot??t?.customFunctions?.root,t.threads=t.threads??t?.http?.threads;let r=y$(t);if(r.error)throw e_.CONFIG_VALIDATION(r.error.message);e.setIn(["threads"],r.value.threads),e.setIn(["componentsRoot"],r.value.componentsRoot),e.setIn(["logging","root"],r.value.logging.root),e.setIn(["storage","path"],r.value.storage.path),e.setIn(["logging","rotation","path"],r.value.logging.rotation.path),e.setIn(["clustering","leafServer","streams","path"],r.value.clustering.leafServer.streams?.path)}a(tm,"validateConfig");function x$(e,t){yt===void 0&&(yt={});let r=us[e.toLowerCase()];if(r===void 0){lt.trace(`Unable to update config object because config param '${e}' does not exist`);return}yt[r.toLowerCase()]=t}a(x$,"updateConfigObject");function Sb(e,t,r=void 0,s=!1,n=!1,i=!1){yt===void 0&&em();let o=pb(us.hdb_root),c=cs.join(o,Tr.HDB_CONFIG_FILE),u=xn(c),_;if(r===void 0&&e.toLowerCase()===on.DATABASES)_=t;else if(r===void 0){let f;if(i)f=e;else if(f=us[e.toLowerCase()],f===void 0)throw new Error(`Unable to update config, unrecognized config parameter: ${e}`);let E=f.split("_"),h=Zh(f,t);u.setIn([...E],h)}else for(let f in r){let E=us[f.toLowerCase()];if(E===on.DATABASES){_=r[f];continue}if(!E&&f.endsWith("_package")&&(E=f),E!==void 0){let h=E.split("_"),p=Tr.LEGACY_CONFIG_PARAMS[f.toUpperCase()];p&&p.startsWith("customFunctions")&&u.hasIn(p.split("_"))&&(E=p,h=p.split("_"));let S=Zh(E,r[f]);E==="rootPath"&&S?.endsWith("/")&&(S=S.slice(0,-1));try{u.setIn([...h],S)}catch(g){lt.error(g)}}}_&&mb(u,_),tm(u);let l=u.getIn(["rootPath"]),d=cs.join(l,Tr.HDB_CONFIG_FILE);s===!0&&k$(c,l),Jt.writeFileSync(d,String(u)),n&&(yt=mo(u.toJSON())),lt.trace(`Config parameter: ${e} updated with value: ${t}`)}a(Sb,"updateConfigValue");function k$(e,t){try{let r=cs.join(t,"backup",`${Tr.HDB_CONFIG_FILE}.bak`);Jt.copySync(e,r),lt.trace(`Config file: ${e} backed up to: ${r}`)}catch(r){lt.error(v$),lt.error(r)}}a(k$,"backupConfigFile");var V$=["databases"];function mo(e){return e.http&&Object.assign(e.http,e?.customFunctions?.network),e?.operationsApi?.network&&(e.operationsApi.network=Object.assign({},e.http,e.operationsApi.network)),e?.operationsApi&&(e.operationsApi.tls=Object.assign({},e.tls,e.operationsApi.tls)),r_=e,r(e);function r(s){let n={};for(let i in s)if(s.hasOwnProperty(i))if(typeof s[i]=="object"&&s[i]!==null&&!Array.isArray(s[i])&&!V$.includes(i)){let o=r(s[i]);for(let c in o){if(!o.hasOwnProperty(c))continue;c!=="package"&&(i=i.toLowerCase());let u=i+"_"+c;!on[u.toUpperCase()]&&us[u]&&(n[us[u].toLowerCase()]=o[c]),n[u]=o[c]}}else n[i.toLowerCase()]=s[i];return n}a(r,"squashObj")}a(mo,"flattenConfig");function Zh(e,t){if(e===on.CLUSTERING_NODENAME||e===on.CLUSTERING_USER){if(t==null)return t;if(!isNaN(t))return t.toString();if(typeof t=="string"&&t.toLowerCase()==="true"||typeof t=="string"&&t.toLowerCase()==="false")return t}else{if(w$(t))return parseFloat(t);if(t===!0||t===!1||Array.isArray(t)||mt.isObject(t)||t===null)return t;if(typeof t=="string"&&t.toLowerCase()==="true")return!0;if(typeof t=="string"&&t.toLowerCase()==="false")return!1}if(t===void 0||t.toLowerCase()==="undefined")return null;if(typeof t=="string"&&(t.startsWith("{")&&t.endsWith("}")||t.startsWith("[")&&t.endsWith("]")))try{return JSON.parse(t)}catch{}return mt.autoCast(t)}a(Zh,"castConfigValue");function $$(){let e=mt.getPropsFilePath(),t=Ii(e);return xn(t).toJSON()}a($$,"getConfiguration");async function Y$(e){let{operation:t,hdb_user:r,hdb_auth_header:s,...n}=e;try{return Sb(void 0,void 0,n,!0),H$}catch(i){throw typeof i=="string"||i instanceof String?L$(i,i,D$.BAD_REQUEST,void 0,void 0,!0):i}}a(Y$,"setConfiguration");function rm(){let e=mt.getPropsFilePath();try{Jt.accessSync(e,Jt.constants.F_OK|Jt.constants.R_OK)}catch(s){if(!mt.noBootFile())throw lt.error(s),new Error(`HarperDB properties file at path ${e} does not exist`)}let t=Ii(e);return xn(t).toJSON()}a(rm,"readConfigFile");function xn(e){return I$.parseDocument(Jt.readFileSync(e,"utf8"),{simpleKeys:!0})}a(xn,"parseYamlDoc");function K$(){let e=rm(),t=e?.clustering?.hubServer?.cluster?.network?.routes;t=mt.isEmptyOrZeroLength(t)?[]:t;let r=db(t);if(r)throw e_.CONFIG_VALIDATION(r.message);let s=e?.clustering?.leafServer?.network?.routes;s=mt.isEmptyOrZeroLength(s)?[]:s;let n=db(s);if(n)throw e_.CONFIG_VALIDATION(n.message);if(!mt.isEmptyOrZeroLength(s)&&!mt.isEmptyOrZeroLength(t)){let i=t.filter(o=>s.some(c=>c.host===o.host&&c.port===o.port));if(!mt.isEmptyOrZeroLength(i)){let o=`Duplicate hub and leaf routes found ${JSON.stringify(i)}`;throw e_.CONFIG_VALIDATION(o)}}return{hub_routes:t,leaf_routes:s}}a(K$,"getClusteringRoutes");function Tb(e){let t=Eb(e);yt={};for(let r in us){let s=t.get(r.toUpperCase());if(mt.isEmpty(s)||typeof s=="string"&&s.trim().length===0)continue;let n=us[r].toLowerCase();n===on.LOGGING_ROOT?yt[n]=cs.dirname(s):yt[n]=s}return yt}a(Tb,"initOldConfig");function W$(e){let t=rm();return C$.get(t,e.replaceAll("_","."))}a(W$,"getConfigFromFile");async function Q$(e,t){let r=xn(Ii());r.hasIn([e])?r.setIn([e],t):r.addIn([e],t),await Jt.writeFile(Ii(),String(r))}a(Q$,"addConfig");function z$(e){let t=Ii(mt.getPropsFilePath()),r=xn(t);r.deleteIn(e);let s=r.getIn(["rootPath"]),n=cs.join(s,Tr.HDB_CONFIG_FILE);Jt.writeFileSync(n,String(r))}a(z$,"deleteConfigFromFile");function J$(){return r_||(em(),r_)}a(J$,"getConfigObj")});var Ab=T((Ioe,Rb)=>{"use strict";var s_=y(),n_=class{static{a(this,"BaseLicense")}constructor(t=0,r=s_.RAM_ALLOCATION_ENUM.DEFAULT,s=s_.LICENSE_VALUES.VERSION_DEFAULT,n){this.exp_date=t,this.ram_allocation=r,this.version=s,this.fingerprint=n}},sm=class extends n_{static{a(this,"ExtendedLicense")}constructor(t=0,r=s_.RAM_ALLOCATION_ENUM.DEFAULT,s=s_.LICENSE_VALUES.VERSION_DEFAULT,n,i=!1){super(t,r,s,n),this.enterprise=i}};Rb.exports={BaseLicense:n_,ExtendedLicense:sm}});var ic=T((Coe,wb)=>{"use strict";var So=require("fs-extra"),Ob=Jl(),Nb=require("crypto"),X$=require("moment"),j$=require("uuid").v4,Ft=G(),im=require("path"),Z$=$(),kn=y(),eY=Ab().ExtendedLicense,po="invalid license key format",tY="061183",rY="mofi25",sY="aes-256-cbc",nY=16,iY=32,bb=X();bb.initSync();var nm;wb.exports={validateLicense:yb,generateFingerPrint:aY,licenseSearch:Ib,getLicense:lY};function om(){return im.join(bb.getHdbBasePath(),kn.LICENSE_KEY_DIR_NAME,kn.LICENSE_FILE_NAME)}a(om,"getLicenseDirPath");function oY(){let e=om();return im.join(e,kn.LICENSE_FILE_NAME)}a(oY,"getLicenseFilePath");function am(){let e=om();return im.join(e,kn.REG_KEY_FILE_NAME)}a(am,"getFingerPrintFilePath");async function aY(){let e=am();try{return await So.readFile(e,"utf8")}catch(t){if(t.code==="ENOENT")return await cY();throw Ft.error(`Error writing fingerprint file to ${e}`),Ft.error(t),new Error("There was an error generating the fingerprint")}}a(aY,"generateFingerPrint");async function cY(){let e=j$(),t=Ob.hash(e),r=am();try{await So.mkdirp(om()),await So.writeFile(r,t)}catch(s){if(s.code==="EEXIST")return t;throw Ft.error(`Error writing fingerprint file to ${r}`),Ft.error(s),new Error("There was an error generating the fingerprint")}return t}a(cY,"writeFingerprint");function yb(e,t){let r={valid_license:!1,valid_date:!1,valid_machine:!1,exp_date:null,ram_allocation:kn.RAM_ALLOCATION_ENUM.DEFAULT,version:kn.LICENSE_VALUES.VERSION_DEFAULT};if(!e)return Ft.error("empty license key passed to validate."),r;let s=am(),n=!1;try{n=So.statSync(s)}catch(i){Ft.error(i)}if(n){let i;try{i=So.readFileSync(s,"utf8")}catch{Ft.error("error validating this machine in the license"),r.valid_machine=!1;return}let o=e.split(rY),c=o[1];c=Buffer.concat([Buffer.from(c)],nY);let u=Buffer.concat([Buffer.from(i)],iY),_=Nb.createDecipheriv(sY,u,c);r.valid_date=!0,r.valid_license=!0,r.valid_machine=!0;let l=null;try{l=_.update(o[0],"hex","utf8"),l.trim(),l+=_.final("utf8")}catch{let E=uY(o[0],i);if(E)l=E;else throw r.valid_license=!1,r.valid_machine=!1,console.error(po),Ft.error(po),new Error(po)}let d;if(isNaN(l))try{d=JSON.parse(l),r.version=d.version,r.exp_date=d.exp_date,isNaN(r.exp_date)&&(r.exp_date=new Date(r.exp_date).getTime()),d.ram_allocation&&(r.ram_allocation=d.ram_allocation)}catch{throw console.error(po),Ft.error(po),new Error(po)}else r.exp_date=l;r.exp_date<X$().valueOf()&&(r.valid_date=!1),Ob.validate(o[1],`${tY}${i}${t}`)||(r.valid_license=!1)}else r.valid_license=!1,r.valid_machine=!1;return r.valid_license&&r.valid_machine&&r.valid_date||Ft.error("Invalid licence"),r}a(yb,"validateLicense");function uY(e,t){try{let r=Nb.createDecipher("aes192",t),s=r.update(e,"hex","utf8");return s.trim(),s+=r.final("utf8"),s}catch{Ft.warn("Check old license failed")}}a(uY,"checkOldLicense");function Ib(){let e=new eY,t=[];try{t=So.readFileSync(oY(),"utf-8").split(kn.NEW_LINE)}catch(r){r.code==="ENOENT"?Ft.info("no license file found"):Ft.error(`could not search for licenses due to: '${r.message}`)}for(let r=0;r<t.length;++r){let s=t[r];try{if(Z$.isEmptyOrZeroLength(s))continue;let n=JSON.parse(s),i=yb(n.license_key,n.company);i.valid_machine===!0&&i.valid_date===!0&&i.valid_machine===!0&&(e.exp_date=i.exp_date>e.exp_date?i.exp_date:e.exp_date,e.ram_allocation=i.ram_allocation,e.enterprise=!0)}catch(n){Ft.error("There was an error parsing the license string."),Ft.error(n),e.ram_allocation=kn.RAM_ALLOCATION_ENUM.DEFAULT,e.enterprise=!1}}return nm=e,e}a(Ib,"licenseSearch");async function lY(){return nm||await Ib(),nm}a(lY,"getLicense")});var xr=T((Poe,$b)=>{"use strict";var Ub="username is required",Mb="nothing to update, must supply active, role or password to update",Pb="password cannot be an empty string",vb="If role is specified, it cannot be empty.",Bb="active must be true or false";$b.exports={addUser:TY,alterUser:gY,dropUser:AY,getSuperUser:yY,userInfo:OY,listUsers:o_,listUsersExternal:NY,setUsersToGlobal:go,findAndValidateUser:kb,getClusterUser:IY,USERNAME_REQUIRED:Ub,ALTERUSER_NOTHING_TO_UPDATE:Mb,EMPTY_PASSWORD:Pb,EMPTY_ROLE:vb,ACTIVE_BOOLEAN:Bb};var Hb=Gr(),_Y=bi(),lm=Jl(),qb=rb(),Fb=Fr(),_m=an(),Rr=$(),Gb=require("validate.js"),le=G(),{promisify:dY}=require("util"),dm=sn(),Cb=y(),Lb=Ve(),fY=gr(),Doe=X(),Uoe=ic(),EY=Si(),{table:Moe}=(Ee(),Z(Ce)),{handleHDBError:Ms,hdb_errors:hY}=j(),{HTTP_STATUS_CODES:Ps,AUTHENTICATION_ERROR_MSGS:cm,HDB_ERROR_MSGS:To}=hY,{UserEventMsg:fm}=ls(),um=require("lodash"),{server:Em}=(hr(),Z(hi)),mY=G();Em.getUser=kb;var xb={username:!0,active:!0,role:!0,password:!0},Db=new Map,i_=Fb.searchByValue,pY=Fb.searchByHash,SY=dY(_Y.delete);async function TY(e){let t=Gb.cleanAttributes(e,xb),r=qb.addUserValidation(t);if(r)throw Ms(new Error,r.message,Ps.BAD_REQUEST,void 0,void 0,!0);let s={schema:"system",table:"hdb_role",search_attribute:"role",search_value:t.role,get_attributes:["id","permission","role"]},n;try{n=await i_(s),n=n&&Array.from(n)}catch(u){throw le.error("There was an error searching for a role in add user"),le.error(u),u}if(!n||n.length<1)throw Ms(new Error,To.ROLE_NAME_NOT_FOUND(t.role),Ps.NOT_FOUND,void 0,void 0,!0);if(n.length>1)throw Ms(new Error,To.DUP_ROLES_FOUND(t.role),Ps.CONFLICT,void 0,void 0,!0);n[0].permission.cluster_user===!0&&(t.hash=dm.encrypt(t.password)),t.password=lm.hash(t.password),t.role=n[0].id;let i={operation:"insert",schema:"system",table:"hdb_user",records:[t]},o;try{o=await Hb.insert(i)}catch(u){throw le.error("There was an error searching for a user."),le.error(u),u}le.debug(o);try{await go()}catch(u){throw le.error("Got an error setting users to global"),le.error(u),u}if(o.skipped_hashes.length===1)throw Ms(new Error,To.USER_ALREADY_EXISTS(t.username),Ps.CONFLICT,void 0,void 0,!0);let c=Object.assign({},t);return c.role=n[0],_m.signalUserChange(new fm(process.pid)),`${c.username} successfully added`}a(TY,"addUser");async function gY(e){let t=Gb.cleanAttributes(e,xb);if(Rr.isEmptyOrZeroLength(t.username))throw new Error(Ub);if(Rr.isEmptyOrZeroLength(t.password)&&Rr.isEmptyOrZeroLength(t.role)&&Rr.isEmptyOrZeroLength(t.active))throw new Error(Mb);if(!Rr.isEmpty(t.password)&&Rr.isEmptyOrZeroLength(t.password.trim()))throw new Error(Pb);if(!Rr.isEmpty(t.active)&&!Rr.isBoolean(t.active))throw new Error(Bb);let r=RY(t.username);if(!Rr.isEmpty(t.password)&&!Rr.isEmptyOrZeroLength(t.password.trim())&&(r&&(t.hash=dm.encrypt(t.password)),t.password=lm.hash(t.password)),t.role==="")throw new Error(vb);if(t.role){let i={schema:"system",table:"hdb_role",search_attribute:"role",search_value:t.role,get_attributes:["*"]},o;try{o=Array.from(await i_(i)||[])}catch(c){throw le.error("Got an error searching for a role."),le.error(c),c}if(!o||o.length===0){let c=To.ALTER_USER_ROLE_NOT_FOUND(t.role);throw le.error(c),Ms(new Error,c,Ps.NOT_FOUND,void 0,void 0,!0)}if(o.length>1){let c=To.ALTER_USER_DUP_ROLES(t.role);throw le.error(c),Ms(new Error,c,Ps.CONFLICT,void 0,void 0,!0)}t.role=o[0].id}let s={operation:"update",schema:"system",table:"hdb_user",records:[t]},n;try{n=await Hb.update(s)}catch(i){throw le.error("Error during update."),le.error(i),i}try{await go()}catch(i){throw le.error("Got an error setting users to global"),le.error(i),i}return _m.signalUserChange(new fm(process.pid)),n}a(gY,"alterUser");function RY(e){let t=!1,r=global.hdb_users.get(e);return r&&r.role.permission.cluster_user===!0&&(t=!0),t}a(RY,"isClusterUser");async function AY(e){try{let t=qb.dropUserValidation(e);if(t)throw new Error(t);let r={table:"hdb_user",schema:"system",hash_values:[e.username]};if(Rr.isEmpty(global.hdb_users.get(e.username)))throw Ms(new Error,To.USER_NOT_EXIST(e.username),Ps.NOT_FOUND,void 0,void 0,!0);let s;try{s=await SY(r)}catch(n){throw le.error("Got an error deleting a user."),le.error(n),n}le.debug(s);try{await go()}catch(n){throw le.error("Got an error setting users to global."),le.error(n),n}return _m.signalUserChange(new fm(process.pid)),`${e.username} successfully deleted`}catch(t){throw t}}a(AY,"dropUser");async function OY(e){let t={};try{if(!e||!e.hdb_user)return"There was no user info in the body";t=um.cloneDeep(e.hdb_user);let r={schema:"system",table:"hdb_role",hash_values:[t.role.id],get_attributes:["*"]},s;try{s=await pY(r)}catch(n){throw le.error("Got an error searching for a role."),le.error(n),n}t.role=s[0],delete t.password,delete t.refresh_token,delete t.hash}catch(r){throw le.error(r),r}return t}a(OY,"userInfo");async function NY(){let e;try{e=await o_()}catch(t){throw le.error("Got an error listing users."),le.error(t),t}try{e.forEach(t=>{delete t.password,delete t.hash,delete t.refresh_token})}catch{throw new Error("there was an error massaging the user data")}return[...e.values()]}a(NY,"listUsersExternal");async function o_(){try{let e={schema:"system",table:"hdb_role",search_value:"*",search_attribute:"role",get_attributes:["*"]},t;try{t=await i_(e)}catch(o){throw le.error("Got an error searching for roles."),le.error(o),o}let r={};for(let o of t)r[o.id]=um.cloneDeep(o);if(Object.keys(r).length===0)return null;let s={schema:"system",table:"hdb_user",search_value:"*",search_attribute:"username",get_attributes:["*"]},n;try{n=await i_(s)}catch(o){throw le.error("Got an error searching for users."),le.error(o),o}let i=new Map;for(let o of n)o=um.cloneDeep(o),o.role=r[o.role],bY(o.role),i.set(o.username,o);return i}catch(e){throw le.error("got an error listing users"),le.error(e),Rr.errorizeMessage(e)}return null}a(o_,"listUsers");function bY(e){try{if(!e){le.error("invalid user role found.");return}e.permission.system||(e.permission.system={}),e.permission.system.tables||(e.permission.system.tables={});for(let t of Object.keys(EY)){let r={read:!!e.permission.super_user,insert:!1,update:!1,delete:!1,attribute_permissions:[]};e.permission.system.tables[t]=r}}catch(t){le.error("Got an error trying to set system permissions."),le.error(t)}}a(bY,"appendSystemTablesToRole");async function go(){try{let e=await o_();global.hdb_users=e}catch(e){throw le.error(e),e}}a(go,"setUsersToGlobal");async function kb(e,t,r=!0){global.hdb_users||await go();let s=global.hdb_users.get(e);if(!s)throw Ms(new Error,cm.GENERIC_AUTH_FAIL,Ps.UNAUTHORIZED,void 0,void 0,!0);if(s&&!s.active)throw Ms(new Error,cm.USER_INACTIVE,Ps.UNAUTHORIZED,void 0,void 0,!0);let n={active:s.active,username:s.username};if(s.refresh_token&&(n.refresh_token=s.refresh_token),s.role&&(n.role=s.role),r===!0){if(Db.get(t)===s.password)return n;if(lm.validate(s.password,t))Db.set(t,s.password);else throw Ms(new Error,cm.GENERIC_AUTH_FAIL,Ps.UNAUTHORIZED,void 0,void 0,!0)}return n}a(kb,"findAndValidateUser");async function yY(){global.hdb_users||await go();for(let[,e]of global.hdb_users)if(e.role.role==="super_user")return e}a(yY,"getSuperUser");async function IY(){let e=await o_(),t=fY.getConfigFromFile(Cb.CONFIG_PARAMS.CLUSTERING_USER),r=e.get(t);if(!Rr.isEmpty(r)&&r?.role?.role===Cb.ROLE_TYPES_ENUM.CLUSTER_USER)return r.decrypt_hash=dm.decrypt(r.hash),r.uri_encoded_d_hash=encodeURIComponent(r.decrypt_hash),r.uri_encoded_name=encodeURIComponent(r.username),r.sys_name=r.username+Lb.SERVER_SUFFIX.ADMIN,r.sys_name_encoded=r.uri_encoded_name+Lb.SERVER_SUFFIX.ADMIN,r}a(IY,"getClusterUser");var Vb=[];Em.invalidateUser=function(e){for(let t of Vb)try{t(e)}catch(r){mY.error("Error invalidating user",r)}};Em.onInvalidatedUser=function(e){Vb.push(e)}});var ac=T((qoe,Qb)=>{"use strict";var wi=G(),Ar=y(),wY=ON(),Boe=qn(),Hoe=gi(),CY=xr(),{validateEvent:Yb}=ls(),oc=as(),LY=require("process"),{resetDatabases:DY}=(Ee(),Z(Ce)),UY={[Ar.ITC_EVENT_TYPES.SCHEMA]:MY,[Ar.ITC_EVENT_TYPES.USER]:Wb};async function MY(e){let t=Yb(e);if(t){wi.error(t);return}wi.trace("ITC schemaHandler received schema event:",e),await wY(e.message),await PY(e.message)}a(MY,"schemaHandler");async function PY(e){try{oc.resetReadTxn(Ar.SYSTEM_SCHEMA_NAME,Ar.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME),oc.resetReadTxn(Ar.SYSTEM_SCHEMA_NAME,Ar.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME),oc.resetReadTxn(Ar.SYSTEM_SCHEMA_NAME,Ar.SYSTEM_TABLE_NAMES.SCHEMA_TABLE_NAME);let t=DY();e.table&&e.database&&await t[e.database][e.table].put(Symbol.for("write-verify"),null)}catch(t){wi.error(t)}}a(PY,"syncSchemaMetadata");var Kb=[];async function Wb(e){try{try{oc.resetReadTxn(Ar.SYSTEM_SCHEMA_NAME,Ar.SYSTEM_TABLE_NAMES.USER_TABLE_NAME),oc.resetReadTxn(Ar.SYSTEM_SCHEMA_NAME,Ar.SYSTEM_TABLE_NAMES.ROLE_TABLE_NAME)}catch(r){wi.warn(r)}let t=Yb(e);if(t){wi.error(t);return}wi.trace(`ITC userHandler ${Ar.HDB_ITC_CLIENT_PREFIX}${LY.pid} received user event:`,e),await CY.setUsersToGlobal();for(let r of Kb)r()}catch(t){wi.error(t)}}a(Wb,"userHandler");Wb.addListener=function(e){Kb.push(e)};Qb.exports=UY});var ls=T(($oe,Jb)=>{"use strict";var Goe=G(),hm=$(),vY=y(),{ITC_ERRORS:cc}=fr(),{parentPort:xoe,threadId:BY,isMainThread:HY,workerData:koe}=require("worker_threads"),{onMessageFromWorkers:qY,broadcast:Voe,broadcastWithAcknowledgement:FY}=Je();Jb.exports={sendItcEvent:GY,validateEvent:zb,SchemaEventMsg:xY,UserEventMsg:kY};var a_;qY(async(e,t)=>{a_=a_||ac(),zb(e),a_[e.type]&&await a_[e.type](e),e.requestId&&t&&t.postMessage({type:"ack",id:e.requestId})});function GY(e){return!HY&&e.message&&(e.message.originator=BY),FY(e)}a(GY,"sendItcEvent");function zb(e){if(typeof e!="object")return cc.INVALID_ITC_DATA_TYPE;if(!e.hasOwnProperty("type")||hm.isEmpty(e.type))return cc.MISSING_TYPE;if(!e.hasOwnProperty("message")||hm.isEmpty(e.message))return cc.MISSING_MSG;if(!e.message.hasOwnProperty("originator")||hm.isEmpty(e.message.originator))return cc.MISSING_ORIGIN;if(vY.ITC_EVENT_TYPES[e.type.toUpperCase()]===void 0)return cc.INVALID_EVENT(e.type)}a(zb,"validateEvent");function xY(e,t,r,s=void 0,n=void 0){this.originator=e,this.operation=t,this.schema=r,this.table=s,this.attribute=n}a(xY,"SchemaEventMsg");function kY(e){this.originator=e}a(kY,"UserEventMsg")});var an=T((Woe,ey)=>{"use strict";var Xb=y(),Koe=$(),c_=G(),jb=gN(),Ro,{sendItcEvent:Zb}=ls();function VY(e){try{c_.trace("signalSchemaChange called with message:",e),Ro=Ro||ac();let t=new jb(Xb.ITC_EVENT_TYPES.SCHEMA,e);return Ro.schema(t),Zb(t)}catch(t){c_.error(t)}}a(VY,"signalSchemaChange");function $Y(e){try{c_.trace("signalUserChange called with message:",e),Ro=Ro||ac();let t=new jb(Xb.ITC_EVENT_TYPES.USER,e);return Ro.user(t),Zb(t)}catch(t){c_.error(t)}}a($Y,"signalUserChange");ey.exports={signalSchemaChange:VY,signalUserChange:$Y}});var u_=T((zoe,ry)=>{"use strict";var ty=$(),YY=y(),KY=G(),WY=Fl(),QY=ql(),zY=an(),{SchemaEventMsg:JY}=ls(),XY="already exists in";ry.exports=jY;async function jY(e,t,r){if(ty.isEmptyOrZeroLength(r))return r;let s=[];ty.isEmptyOrZeroLength(t.attributes)||t.attributes.forEach(i=>{s.push(i.attribute)});let n=r.filter(i=>s.indexOf(i)<0);return n.length===0||await Promise.all(n.map(async i=>{await ZY(e,t.schema,t.name,i)})),n}a(jY,"lmdbCheckForNewAttributes");async function ZY(e,t,r,s){let n=new QY(t,r,s,void 0,!0);e&&(n.hdb_auth_header=e);try{await e1(n)}catch(i){if(typeof i=="object"&&i.message!==void 0&&i.message.includes(XY))KY.warn(`attribute ${t}.${r}.${s} already exists`);else throw i}}a(ZY,"createNewAttribute");async function e1(e){let t;return t=await WY(e),zY.signalSchemaChange(new JY(process.pid,YY.OPERATIONS_ENUM.CREATE_ATTRIBUTE,e.schema,e.table,e.attribute)),t}a(e1,"createAttribute")});var Ao=T((Xoe,sy)=>{"use strict";var mm=class{static{a(this,"LMDBTransactionObject")}constructor(t,r,s,n,i=void 0){this.operation=t,this.user_name=r,this.timestamp=s,this.hash_values=n,this.origin=i}};sy.exports=mm});var iy=T((Zoe,ny)=>{"use strict";var t1=Ao(),r1=y().OPERATIONS_ENUM,pm=class extends t1{static{a(this,"LMDBInsertTransactionObject")}constructor(t,r,s,n,i=void 0){super(r1.INSERT,r,s,n,i),this.records=t}};ny.exports=pm});var ay=T((tae,oy)=>{"use strict";var s1=Ao(),n1=y().OPERATIONS_ENUM,Sm=class extends s1{static{a(this,"LMDBUpdateTransactionObject")}constructor(t,r,s,n,i,o=void 0){super(n1.UPDATE,s,n,i,o),this.records=t,this.original_records=r}};oy.exports=Sm});var uy=T((sae,cy)=>{"use strict";var i1=Ao(),o1=y().OPERATIONS_ENUM,Tm=class extends i1{static{a(this,"LMDBUpsertTransactionObject")}constructor(t,r,s,n,i,o=void 0){super(o1.UPSERT,s,n,i,o),this.records=t,this.original_records=r}};cy.exports=Tm});var _y=T((iae,ly)=>{"use strict";var a1=Ao(),c1=y().OPERATIONS_ENUM,gm=class extends a1{static{a(this,"LMDBDeleteTransactionObject")}constructor(t,r,s,n,i=void 0){super(c1.DELETE,s,n,t,i),this.original_records=r}};ly.exports=gm});var uc=T((cae,hy)=>{"use strict";var aae=require("path"),dy=De(),u1=iy(),l1=ay(),_1=uy(),d1=_y(),Oo=ze(),fy=$(),{CONFIG_PARAMS:f1}=y(),Ey=X();Ey.initSync();var l_=y().OPERATIONS_ENUM,{getTransactionAuditStorePath:E1}=ve();hy.exports=h1;async function h1(e,t){if(Ey.get(f1.LOGGING_AUDITLOG)===!1)return;let r=E1(e.schema,e.table),s=await dy.openEnvironment(r,e.table,!0),n=m1(e,t);if(!(n===void 0||n.hash_values.length===0)&&s!==void 0){dy.initializeDBIs(s,Oo.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP,Oo.TRANSACTIONS_DBIS);let i=n.timestamp;return await s.dbis[Oo.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP].ifNoExists(i,()=>{s.dbis[Oo.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP].put(i,n),fy.isEmpty(n.user_name)||s.dbis[Oo.TRANSACTIONS_DBI_NAMES_ENUM.USER_NAME].put(n.user_name,i);for(let o=0;o<n.hash_values.length;o++)s.dbis[Oo.TRANSACTIONS_DBI_NAMES_ENUM.HASH_VALUE].put(n.hash_values[o],i)})}}a(h1,"writeTransaction");function m1(e,t){let r=fy.isEmpty(e.hdb_user)?void 0:e.hdb_user.username;if(e.operation===l_.INSERT)return new u1(e.records,r,t.txn_time,t.written_hashes,e.__origin);if(e.operation===l_.UPDATE)return new l1(e.records,t.original_records,r,t.txn_time,t.written_hashes,e.__origin);if(e.operation===l_.UPSERT)return new _1(e.records,t.original_records,r,t.txn_time,t.written_hashes,e.__origin);if(e.operation===l_.DELETE)return new d1(t.deleted,t.original_records,r,t.txn_time,e.__origin)}a(m1,"createTransactionObject")});var Rm=T((_ae,my)=>{"use strict";var p1=Xa(),lae=ja(),lc=y(),S1=rc(),T1=_o().insertRecords,g1=De(),R1=G(),A1=u_(),{getSchemaPath:O1}=ve(),N1=uc();my.exports=b1;async function b1(e){try{let{schema_table:t,attributes:r}=p1(e);S1(e,r,t.hash_attribute),e.schema!==lc.SYSTEM_SCHEMA_NAME&&(r.includes(lc.TIME_STAMP_NAMES_ENUM.CREATED_TIME)||r.push(lc.TIME_STAMP_NAMES_ENUM.CREATED_TIME),r.includes(lc.TIME_STAMP_NAMES_ENUM.UPDATED_TIME)||r.push(lc.TIME_STAMP_NAMES_ENUM.UPDATED_TIME));let s=await A1(e.hdb_auth_header,t,r),n=O1(e.schema,e.table),i=await g1.openEnvironment(n,e.table),o=await T1(i,t.hash_attribute,r,e.records,e.__origin?.timestamp);try{await N1(e,o)}catch(c){R1.error(`unable to write transaction due to ${c.message}`)}return{written_hashes:o.written_hashes,skipped_hashes:o.skipped_hashes,schema_table:t,new_attributes:s,txn_time:o.txn_time}}catch(t){throw t}}a(b1,"lmdbCreateRecords")});var Ty=T((fae,Sy)=>{"use strict";var py=y(),y1=Rm(),I1=ja(),w1=require("fs-extra"),{getSchemaPath:C1}=ve();Sy.exports=L1;async function L1(e){let t=[{name:e.schema,createddate:Date.now()}],r=new I1(py.SYSTEM_SCHEMA_NAME,py.SYSTEM_TABLE_NAMES.SCHEMA_TABLE_NAME,void 0,t);await y1(r),await w1.mkdirp(C1(e.schema))}a(L1,"lmdbCreateSchema")});var Ry=T((hae,gy)=>{"use strict";var Am=class{static{a(this,"DeleteRecordsResponseObject")}constructor(t=[],r=[],s=void 0,n=[]){this.deleted=t,this.skipped=r,this.txn_time=s,this.original_records=n}};gy.exports=Am});var by=T((gae,Ny)=>{"use strict";var Ay=De(),Om=Er(),Nm=fr().LMDB_ERRORS_ENUM,D1=ze(),Oy=G(),pae=$(),U1=require("lmdb"),M1=Ry(),P1=y(),{OVERFLOW_MARKER:Sae,MAX_SEARCH_KEY_LENGTH:Tae}=D1,v1=P1.TIME_STAMP_NAMES_ENUM.UPDATED_TIME;async function B1(e,t,r,s){if(Om.validateEnv(e),t===void 0)throw new Error(Nm.HASH_ATTRIBUTE_REQUIRED);if(!Array.isArray(r))throw r===void 0?new Error(Nm.IDS_REQUIRED):new Error(Nm.IDS_MUST_BE_ITERABLE);try{let n=Ay.listDBIs(e);Ay.initializeDBIs(e,t,n);let i=new M1,o,c=[],u=[];for(let f=0,E=r.length;f<E;f++)try{o=r[f];let h=e.dbis[t].get(o);if(!h||s&&h[v1]>s){i.skipped.push(o);continue}let p=e.dbis[t].ifVersion(o,U1.IF_EXISTS,()=>{e.dbis[t].remove(o);for(let S=0;S<n.length;S++){let g=n[S];if(!h.hasOwnProperty(g)||g===t)continue;let b=e.dbis[g],O=h[g];if(O!=null)try{let Y=Om.getIndexedValues(O);if(Y)for(let Q=0,F=Y.length;Q<F;Q++)b.remove(Y[Q],o)}catch{Oy.warn(`cannot delete from attribute: ${g}, ${O}:${o}`)}}});c.push(p),u.push(o),i.original_records.push(h)}catch(h){Oy.warn(h),i.skipped.push(o)}let _=[],l=await Promise.all(c);for(let f=0,E=l.length;f<E;f++)l[f]===!0?i.deleted.push(u[f]):(i.skipped.push(u[f]),_.push(f));let d=0;for(let f=0;f<_.length;f++){let E=_[f];i.original_records.splice(E-d,1),d++}return i.txn_time=Om.getNextMonotonicTime(),i}catch(n){throw n}}a(B1,"deleteRecords");Ny.exports={deleteRecords:B1}});var _c=T((Aae,Iy)=>{"use strict";var No=$(),H1=by(),q1=De(),{getSchemaPath:F1}=ve(),G1=uc(),x1=G();Iy.exports=k1;async function k1(e,t=!0){let s=global.hdb_schema[e.schema][e.table].hash_attribute;if(No.isEmpty(s))throw new Error(`could not retrieve hash attribute for schema:${e.schema} and table ${e.table}`);try{if(No.isEmptyOrZeroLength(e.hash_values)&&!No.isEmptyOrZeroLength(e.records)){e.hash_values=[];for(let c=0;c<e.records.length;c++){let u=e.records[c][s];No.isEmpty(u)||e.hash_values.push(u)}}if(No.isEmptyOrZeroLength(e.hash_values))return yy([],[]);if(!Array.isArray(e.hash_values))throw new Error("hash_values must be an array");if(No.isEmptyOrZeroLength(e.records)){e.records=[];for(let c=0;c<e.hash_values.length;c++)e.records[c]={[s]:e.hash_values[c]}}let n=F1(e.schema,e.table),i=await q1.openEnvironment(n,e.table),o=await H1.deleteRecords(i,s,e.hash_values,e.__origin?.timestamp);try{t===!0&&await G1(e,o)}catch(c){x1.error(`unable to write transaction due to ${c.message}`)}return yy(o.deleted,o.skipped,o.txn_time)}catch(n){throw n}}a(k1,"lmdbDeleteRecords");function yy(e,t,r){let s=e.length+t.length,n=s===1?"record":"records";return{message:`${e.length} of ${s} ${n} successfully deleted`,deleted_hashes:e,skipped_hashes:t,txn_time:r}}a(yy,"createDeleteResponse")});var ym=T((bae,wy)=>{"use strict";var V1=y(),Nae=Er();function bm(e,t){let r=Object.create(null);if(t.length===1&&V1.SEARCH_WILDCARDS.indexOf(t[0])>=0)Object.assign(r,e);else for(let s=0;s<t.length;s++){let n=t[s],i=e[n];r[n]=i===void 0?null:i}return r}a(bm,"parseRow");function $1(e,t,r,s){let n=bm(r,e);s.push(n)}a($1,"searchAll");function Y1(e,t,r,s){let n=bm(r,e);s[t]=n}a(Y1,"searchAllToMap");function K1(e,t,r){r[e]===void 0&&(r[e]=[]),r[e].push(t)}a(K1,"iterateDBI");function Ci(e,t,r,s,n){let i=Object.create(null);i[n]=e;let o;s===n?o=e:(o=t,s!==void 0&&(i[s]=o)),r[0].push(o),r[1].push(i)}a(Ci,"pushResults");function W1(e,t,r,s,n,i){t.toString().endsWith(e)&&Ci(t,r,s,n,i)}a(W1,"endsWith");function Q1(e,t,r,s,n,i){t.toString().includes(e)&&Ci(t,r,s,n,i)}a(Q1,"contains");function z1(e,t,r,s,n,i){t>e&&Ci(t,r,s,n,i)}a(z1,"greaterThanCompare");function J1(e,t,r,s,n,i){t>=e&&Ci(t,r,s,n,i)}a(J1,"greaterThanEqualCompare");function X1(e,t,r,s,n,i){t<e&&Ci(t,r,s,n,i)}a(X1,"lessThanCompare");function j1(e,t,r,s,n,i){t<=e&&Ci(t,r,s,n,i)}a(j1,"lessThanEqualCompare");wy.exports={parseRow:bm,searchAll:$1,searchAllToMap:Y1,iterateDBI:K1,endsWith:W1,contains:Q1,greaterThanCompare:z1,greaterThanEqualCompare:J1,lessThanCompare:X1,lessThanEqualCompare:j1,pushResults:Ci}});var bo=T((Lae,vy)=>{"use strict";var Vn=De(),Iae=G(),Or=Er(),__=ze(),Xe=fr().LMDB_ERRORS_ENUM,wae=$(),Z1=y(),d_=ym(),{parseRow:eK}=d_,Cae=require("lmdb"),{OVERFLOW_MARKER:Cy,MAX_SEARCH_KEY_LENGTH:tK}=__;function Ly(e,t,r,s=!1,n=void 0,i=void 0){return Li(e,t,r,(o,c)=>c.getRange({transaction:o,start:s?void 0:!1,end:s?!1:void 0,limit:n,offset:i,reverse:s}))}a(Ly,"iterateFullIndex");function dc(e,t,r,s,n,i=!1,o=void 0,c=void 0,u=!1,_=!1){return Li(e,t,r,(l,d,f,E)=>{let b={transaction:l,start:i===!0?n:s,end:i===!0?s:n,reverse:i,limit:o,offset:c,inclusiveEnd:i===!0?!u:!_,exclusiveStart:i===!0?_:u};return E===r?(b.values=!1,d.getRange(b).map(O=>({value:O}))):d.getRange(b)})}a(dc,"iterateRangeBetween");function Li(e,t,r,s){let n=e.database||e,i=Vn.openDBI(n,r);i[__.DBI_DEFINITION_NAME].is_hash_attribute?t=r:t&&Vn.openDBI(n,t);let o;e.database?o=e:(o=e.useReadTransaction(),o.database=e);let c=s(o,i,n,t);return c.transaction=o,e.database||(c.onDone=()=>{o.done()}),c}a(Li,"setupTransaction");function Dy(e,t,r,s){let n;return function(i,o){if(typeof i=="string"&&i.endsWith(Cy)){if(!n)if(r)n=Vn.openDBI(e,r);else{let u=Vn.listDBIs(e);for(let _=0,l=u.length;_<l&&(n=Vn.openDBI(e,u[_]),!n[__.DBI_DEFINITION_NAME].is_hash_attribute);_++);}i=n.get(o,{transaction:t,lazy:!0})[s]}return i}}a(Dy,"getOverflowCheck");function rK(e,t,r,s=!1,n=void 0,i=void 0){if(Or.validateEnv(e),t===void 0)throw new Error(Xe.HASH_ATTRIBUTE_REQUIRED);return Li(e,t,t,(o,c,u)=>(f_(r),r=fc(u,r),c.getRange({transaction:o,start:s?void 0:!1,end:s?!1:void 0,limit:n,offset:i,reverse:s}).map(_=>eK(_.value,r))))}a(rK,"searchAll");function sK(e,t,r,s=!1,n=void 0,i=void 0){if(Or.validateEnv(e),t===void 0)throw new Error(Xe.HASH_ATTRIBUTE_REQUIRED);f_(r),r=fc(e.database||e,r);let o=new Map;for(let{key:c,value:u}of Ly(e,t,t,s,n,i))o.set(c,d_.parseRow(u,r));return o}a(sK,"searchAllToMap");function nK(e,t,r=!1,s=void 0,n=void 0){if(Or.validateEnv(e),t===void 0)throw new Error(Xe.ATTRIBUTE_REQUIRED);let i=Object.create(null),o=Ly(e,void 0,t,r,s,n),c=o.transaction,u=Dy(c.database,c,void 0,t);for(let{key:_,value:l}of o){let d=u(_,l);i[d]===void 0&&(i[d]=[]),i[d].push(l)}return i}a(nK,"iterateDBI");function iK(e,t){if(Or.validateEnv(e),t===void 0)throw new Error(Xe.HASH_ATTRIBUTE_REQUIRED);return Vn.statDBI(e,t).entryCount}a(iK,"countAll");function oK(e,t,r,s,n=!1,i=void 0,o=void 0){return $n(e,r,s),Li(e,t,r,(c,u,_,l)=>(s=Or.convertKeyValueToWrite(s),l===r?u.get(s,{transaction:c,lazy:!0})===void 0?[]:[{key:s,value:s}]:u.getValues(s,{transaction:c,reverse:n,limit:i,offset:o}).map(d=>({key:s,value:d}))))}a(oK,"equals");function aK(e,t,r){return $n(e,t,r),Vn.openDBI(e,t).getValuesCount(r)}a(aK,"count");function cK(e,t,r,s,n=!1,i=void 0,o=void 0){return $n(e,r,s),Li(e,null,r,(c,u)=>{s=Or.convertKeyValueToWrite(s);let _=!0;typeof s=="number"&&(_=!1);let l;if(n===!0){let d;for(let f of u.getKeys({transaction:c,start:s}))if(!f.startsWith(s)){d=f;break}return d!==void 0&&(Number.isInteger(o)?o++:i++),l=u.getRange({transaction:c,start:d,end:void 0,reverse:n,limit:i,offset:o}).map(f=>{let{key:E}=f;if(E!==d){if(E.toString().startsWith(s))return f;if(_===!0)return l.DONE}}),l.filter(f=>f)}else return l=u.getRange({transaction:c,start:s,reverse:n,limit:i,offset:o}).map(d=>{if(d.key.toString().startsWith(s))return d;if(_===!0)return l.DONE}),_?l:l.filter(d=>d)})}a(cK,"startsWith");function uK(e,t,r,s,n=!1,i=void 0,o=void 0){return Uy(e,t,r,s,n,i,o,!0)}a(uK,"endsWith");function Uy(e,t,r,s,n=!1,i=void 0,o=void 0,c=!1){return $n(e,r,s),Li(e,null,r,(u,_,l,d)=>{let f=Dy(l,u,d,r);return o=Number.isInteger(o)?o:0,_.getKeys({transaction:u,end:n?!1:void 0,reverse:n}).flatMap(E=>{let h=E.toString();return h.endsWith(Cy)?_.getValues(E,{transaction:u}).map(p=>{let S=f(E,p);if(c?S.endsWith(s):S.includes(s))return{key:S,value:p}}).filter(p=>p):(c?h.endsWith(s):h.includes(s))?_[__.DBI_DEFINITION_NAME].is_hash_attribute?{key:E,value:E}:_.getValues(E,{transaction:u}).map(p=>({key:E,value:p})):[]}).slice(o,i===void 0?void 0:i+(o||0))})}a(Uy,"contains");function lK(e,t,r,s,n=!1,i=void 0,o=void 0){$n(e,r,s);let c=typeof s,u;return c==="string"?u="\uFFFF":c==="number"?u=1/0:c==="boolean"&&(u=!0),dc(e,t,r,s,u,n,i,o,!0,!1)}a(lK,"greaterThan");function _K(e,t,r,s,n=!1,i=void 0,o=void 0){$n(e,r,s);let c=typeof s,u;return c==="string"?u="\uFFFF":c==="number"?u=1/0:c==="boolean"&&(u=!0),dc(e,t,r,s,u,n,i,o,!1,!1)}a(_K,"greaterThanEqual");function dK(e,t,r,s,n=!1,i=void 0,o=void 0){$n(e,r,s);let c=typeof s,u;return c==="string"?u="\0":c==="number"?u=-1/0:c==="boolean"&&(u=!1),dc(e,t,r,u,s,n,i,o,!1,!0)}a(dK,"lessThan");function fK(e,t,r,s,n=!1,i=void 0,o=void 0){$n(e,r,s);let c=typeof s,u;return c==="string"?u="\0":c==="number"?u=-1/0:c==="boolean"&&(u=!1),dc(e,t,r,u,s,n,i,o,!1,!1)}a(fK,"lessThanEqual");function EK(e,t,r,s,n,i=!1,o=void 0,c=void 0){if(Or.validateEnv(e),r===void 0)throw new Error(Xe.ATTRIBUTE_REQUIRED);if(s===void 0)throw new Error(Xe.START_VALUE_REQUIRED);if(n===void 0)throw new Error(Xe.END_VALUE_REQUIRED);if(s=Or.convertKeyValueToWrite(s),n=Or.convertKeyValueToWrite(n),s>n)throw new Error(Xe.END_VALUE_MUST_BE_GREATER_THAN_START_VALUE);return dc(e,t,r,s,n,i,o,c)}a(EK,"between");function hK(e,t,r,s){Or.validateEnv(e);let n=e.database||e,i=e.database?e:null;if(t===void 0)throw new Error(Xe.HASH_ATTRIBUTE_REQUIRED);if(f_(r),r=fc(n,r),s===void 0)throw new Error(Xe.ID_REQUIRED);let o=null,c=n.dbis[t].get(s,{transaction:i,lazy:r.length<3});return c&&(o=d_.parseRow(c,r)),o}a(hK,"searchByHash");function mK(e,t,r){Or.validateEnv(e);let s=e.database||e,n=e.database?e:null;if(t===void 0)throw new Error(Xe.HASH_ATTRIBUTE_REQUIRED);if(r===void 0)throw new Error(Xe.ID_REQUIRED);let i=!0;return s.dbis[t].get(r,{transaction:n,lazy:!0})===void 0&&(i=!1),i}a(mK,"checkHashExists");function pK(e,t,r,s,n=[]){return Py(e,t,r,s,n),My(e,t,r,s,n).map(i=>i[1])}a(pK,"batchSearchByHash");function SK(e,t,r,s,n=[]){Py(e,t,r,s,n);let i=new Map;for(let[o,c]of My(e,t,r,s,n))i.set(o,c);return i}a(SK,"batchSearchByHashToMap");function My(e,t,r,s,n=[]){return Li(e,t,t,(i,o,c)=>{r=fc(c,r);let u=r.length<3;return s.map(_=>{let l=c.dbis[t].get(_,{transaction:i,lazy:u});if(l)return[_,d_.parseRow(l,r)];n.push(_)}).filter(_=>_)})}a(My,"batchHashSearch");function Py(e,t,r,s,n){if(Or.validateEnv(e),t===void 0)throw new Error(Xe.HASH_ATTRIBUTE_REQUIRED);if(f_(r),s==null)throw new Error(Xe.IDS_REQUIRED);if(!s[Symbol.iterator])throw new Error(Xe.IDS_MUST_BE_ITERABLE)}a(Py,"initializeBatchSearchByHash");function f_(e){if(!Array.isArray(e))throw e===void 0?new Error(Xe.FETCH_ATTRIBUTES_REQUIRED):new Error(Xe.FETCH_ATTRIBUTES_MUST_BE_ARRAY)}a(f_,"validateFetchAttributes");function $n(e,t,r){if(Or.validateEnv(e),t===void 0)throw new Error(Xe.ATTRIBUTE_REQUIRED);if(r===void 0)throw new Error(Xe.SEARCH_VALUE_REQUIRED);if(r?.length>tK)throw new Error(Xe.SEARCH_VALUE_TOO_LARGE)}a($n,"validateComparisonFunctions");function fc(e,t){return t.length===1&&Z1.SEARCH_WILDCARDS.indexOf(t[0])>=0&&(t=Vn.listDBIs(e)),t}a(fc,"setGetWholeRowAttributes");vy.exports={searchAll:rK,searchAllToMap:sK,count:aK,countAll:iK,equals:oK,startsWith:cK,endsWith:uK,contains:Uy,searchByHash:hK,setGetWholeRowAttributes:fc,batchSearchByHash:pK,batchSearchByHashToMap:SK,checkHashExists:mK,iterateDBI:nK,greaterThan:lK,greaterThanEqual:_K,lessThan:dK,lessThanEqual:fK,between:EK}});var yo=T((Uae,Gy)=>{var By=require("lodash"),Hy=ke(),Be=require("joi"),TK=$(),{hdb_schema_table:E_,checkValidTable:qy,hdb_table:Fy,hdb_database:h_}=Ls(),{handleHDBError:gK,hdb_errors:RK}=j(),{getDatabases:AK}=(Ee(),Z(Ce)),{HTTP_STATUS_CODES:OK}=RK,NK=Be.object({database:h_,schema:h_,table:Fy,search_attribute:E_,search_value:Be.any().required(),get_attributes:Be.array().min(1).items(E_).optional(),desc:Be.bool(),limit:Be.number().integer().min(1),offset:Be.number().integer().min(0)}),bK=Be.object({database:h_,schema:h_,table:Fy,operator:Be.string().valid("and","or").default("and").lowercase(),offset:Be.number().integer().min(0),limit:Be.number().integer().min(1),get_attributes:Be.array().min(1).items(E_).optional(),conditions:Be.array().min(1).items(Be.object({search_attribute:E_,search_type:Be.string().valid("equals","contains","starts_with","ends_with","greater_than","greater_than_equal","less_than","less_than_equal","between").optional(),search_value:Be.when("search_type",{switch:[{is:"equals",then:Be.any()},{is:"between",then:Be.array().items(Be.alternatives([Be.string(),Be.number()])).length(2)}],otherwise:Be.alternatives(Be.string(),Be.number())}).required()})).required()});Gy.exports=function(e,t){let r=null;switch(t){case"value":r=Hy.validateBySchema(e,NK);break;case"hashes":let i=function(o){n?n+=". "+o:n=o};var s=i;a(i,"addError");let n;i(qy("database",e.schema)),i(qy("table",e.table)),e.hash_values?Array.isArray(e.hash_values)?e.hash_values.every(o=>typeof o=="string"||typeof o=="number")||i("'hash_values' must be strings or numbers"):i("'hash_values' must be an array"):i("'hash_values' is required"),e.get_attributes?Array.isArray(e.get_attributes)?e.get_attributes.length===0?i("'get_attributes' must contain at least 1 item"):e.get_attributes.every(o=>typeof o=="string"||typeof o=="number")||i("'get_attributes' must be strings or numbers"):i("'get_attributes' must be an array"):i("'get_attributes' is required"),n&&(r=new Error(n.trim()));break;case"conditions":r=Hy.validateBySchema(e,bK);break;default:throw new Error(`Error validating search, unknown type: ${t}`)}if(!r&&e.schema!=="system"){let n=TK.checkGlobalSchemaTable(e.schema,e.table);if(n)return gK(new Error,n,OK.NOT_FOUND);let o=AK()[e.schema][e.table].attributes,c=e.get_attributes?[...e.get_attributes]:[];if(t==="value"&&c.push(e.search_attribute),t==="conditions")for(let _=0,l=e.conditions.length;_<l;_++){let d=e.conditions[_];c.push(d.search_attribute)}let u=By.filter(c,_=>_!=="*"&&_.attribute!=="*"&&!By.some(o,l=>l===_||l.attribute===_||l.attribute===_.attribute));if(u&&u.length>0){let _=u.join(", ");return _=_.replace(/,([^,]*)$/," and$1"),new Error(`unknown attribute '${_}'`)}}return r}});var Im=T((Pae,xy)=>{"use strict";var yK=De(),IK=yo(),{getSchemaPath:wK}=ve();xy.exports=CK;function CK(e){let t=IK(e,"hashes");if(t)throw t;let r=wK(e.schema,e.table);return yK.openEnvironment(r,e.table)}a(CK,"initialize")});var wm=T((Bae,ky)=>{"use strict";var LK=bo(),DK=Im();ky.exports=UK;async function UK(e){let t=await DK(e),r=t.useReadTransaction();r.database=t;let s=global.hdb_schema[e.schema][e.table];try{return LK.batchSearchByHashToMap(r,s.hash_attribute,e.get_attributes,e.hash_values)}finally{r.done()}}a(UK,"lmdbGetDataByHash")});var Io=T((qae,Vy)=>{"use strict";var Cm=class{static{a(this,"SearchByHashObject")}constructor(t,r,s,n){this.schema=t,this.table=r,this.hash_values=s,this.get_attributes=n}};Vy.exports=Cm});var Yy=T((xae,$y)=>{"use strict";var Gae=Io(),MK=bo(),PK=Im();$y.exports=vK;async function vK(e){let t=await PK(e),r=global.hdb_schema[e.schema][e.table];return MK.batchSearchByHash(t,r.hash_attribute,e.get_attributes,e.hash_values)}a(vK,"lmdbSearchByHash")});var vs=T((Vae,Ky)=>{"use strict";var Lm=class{static{a(this,"SearchObject")}constructor(t,r,s,n,i,o,c,u=!1,_=void 0,l=void 0){this.schema=t,this.table=r,this.search_attribute=s,this.search_value=n,this.hash_attribute=i,this.get_attributes=o,this.end_value=c,this.reverse=u,this.limit=_,this.offset=l}};Ky.exports=Lm});var m_=T((Yae,jy)=>{"use strict";var Gt=bo(),BK=De(),HK=$(),ae=ze(),Di=y(),qK=Si(),Wy=fr().LMDB_ERRORS_ENUM,{getSchemaPath:FK}=ve(),cn=Di.SEARCH_WILDCARDS;async function GK(e,t,r){let s;e.schema===Di.SYSTEM_SCHEMA_NAME?s=qK[e.table]:s=global.hdb_schema[e.schema][e.table];let n=Xy(e,s.hash_attribute,r,t);return zy(e,n,s.hash_attribute,r)}a(GK,"prepSearch");async function zy(e,t,r,s){let n=FK(e.schema,e.table),i=await BK.openEnvironment(n,e.table),o=Jy(i,e,t,r),c=o.transaction||i;if([ae.SEARCH_TYPES.BATCH_SEARCH_BY_HASH,ae.SEARCH_TYPES.BATCH_SEARCH_BY_HASH_TO_MAP,ae.SEARCH_TYPES.SEARCH_ALL,ae.SEARCH_TYPES.SEARCH_ALL_TO_MAP].indexOf(t)>=0)return o;if(xK(e,r)===!1){let l=e.search_attribute;if(l===r)return s?Qy(o,()=>!0):o.map(f=>({[r]:f.key}));let d=a(f=>({[r]:f.value,[l]:f.key}),"toObject");return s?Qy(o,d):o.map(d)}let _=e.search_attribute===r?o.map(l=>l.key):o.map(l=>l.value);return s===!0?Gt.batchSearchByHashToMap(c,r,e.get_attributes,_):Gt.batchSearchByHash(c,r,e.get_attributes,_)}a(zy,"executeSearch");function Jy(e,t,r,s){let n,i=s;t.get_attributes.indexOf(s)<0&&(i=void 0);let{reverse:o,limit:c,offset:u}=t;switch(o=typeof o=="boolean"?o:!1,c=Number.isInteger(c)?c:void 0,u=Number.isInteger(u)?u:void 0,r){case ae.SEARCH_TYPES.EQUALS:n=Gt.equals(e,i,t.search_attribute,t.search_value,o,c,u);break;case ae.SEARCH_TYPES.CONTAINS:n=Gt.contains(e,i,t.search_attribute,t.search_value,o,c,u);break;case ae.SEARCH_TYPES.ENDS_WITH:case ae.SEARCH_TYPES._ENDS_WITH:n=Gt.endsWith(e,i,t.search_attribute,t.search_value,o,c,u);break;case ae.SEARCH_TYPES.STARTS_WITH:case ae.SEARCH_TYPES._STARTS_WITH:n=Gt.startsWith(e,i,t.search_attribute,t.search_value,o,c,u);break;case ae.SEARCH_TYPES.BATCH_SEARCH_BY_HASH:return Gt.batchSearchByHash(e,t.search_attribute,t.get_attributes,[t.search_value]);case ae.SEARCH_TYPES.BATCH_SEARCH_BY_HASH_TO_MAP:return Gt.batchSearchByHashToMap(e,t.search_attribute,t.get_attributes,[t.search_value]);case ae.SEARCH_TYPES.SEARCH_ALL:return Gt.searchAll(e,s,t.get_attributes,o,c,u);case ae.SEARCH_TYPES.SEARCH_ALL_TO_MAP:return Gt.searchAllToMap(e,s,t.get_attributes,o,c,u);case ae.SEARCH_TYPES.BETWEEN:n=Gt.between(e,i,t.search_attribute,t.search_value,t.end_value,o,c,u);break;case ae.SEARCH_TYPES.GREATER_THAN:case ae.SEARCH_TYPES._GREATER_THAN:n=Gt.greaterThan(e,i,t.search_attribute,t.search_value,o,c,u);break;case ae.SEARCH_TYPES.GREATER_THAN_EQUAL:case ae.SEARCH_TYPES._GREATER_THAN_EQUAL:n=Gt.greaterThanEqual(e,i,t.search_attribute,t.search_value,o,c,u);break;case ae.SEARCH_TYPES.LESS_THAN:case ae.SEARCH_TYPES._LESS_THAN:n=Gt.lessThan(e,i,t.search_attribute,t.search_value,o,c,u);break;case ae.SEARCH_TYPES.LESS_THAN_EQUAL:case ae.SEARCH_TYPES._LESS_THAN_EQUAL:n=Gt.lessThanEqual(e,i,t.search_attribute,t.search_value,o,c,u);break;default:return Object.create(null)}return n}a(Jy,"searchByType");function Qy(e,t){let r=new Map;for(let s of e)r.set(s.value,t(s));return r}a(Qy,"createMapFromIterable");function xK(e,t){if(e.get_attributes.length===1&&e.get_attributes[0]==="*")return!0;let r=[e.search_attribute];e.get_attributes.indexOf(t)>=0&&r.push(t);let s=!1;for(let n=0;n<e.get_attributes.length;n++)if(r.indexOf(e.get_attributes[n])<0){s=!0;break}return s}a(xK,"checkToFetchMore");function Xy(e,t,r,s){if(HK.isEmpty(s)){let n=e.search_value;typeof n=="object"?n=JSON.stringify(n):n=n.toString();let i=n.charAt(0),o=n.charAt(n.length-1),c=!1;if(e.search_attribute===t&&(c=!0),cn.indexOf(n)>-1)return r===!0?ae.SEARCH_TYPES.SEARCH_ALL_TO_MAP:ae.SEARCH_TYPES.SEARCH_ALL;if(n.indexOf(cn[0])<0&&n.indexOf(cn[1])<0)return c===!0?r===!0?ae.SEARCH_TYPES.BATCH_SEARCH_BY_HASH_TO_MAP:ae.SEARCH_TYPES.BATCH_SEARCH_BY_HASH:ae.SEARCH_TYPES.EQUALS;if(cn.indexOf(i)>=0&&cn.indexOf(o)>=0)return e.search_value=e.search_value.slice(1,-1),ae.SEARCH_TYPES.CONTAINS;if(cn.indexOf(i)>=0)return e.search_value=e.search_value.substr(1),ae.SEARCH_TYPES.ENDS_WITH;if(cn.indexOf(o)>=0)return e.search_value=e.search_value.slice(0,-1),ae.SEARCH_TYPES.STARTS_WITH;if(n.includes(cn[0])||n.includes(cn[1]))return ae.SEARCH_TYPES.EQUALS;throw new Error(Wy.UNKNOWN_SEARCH_TYPE)}else switch(s){case Di.VALUE_SEARCH_COMPARATORS.BETWEEN:return ae.SEARCH_TYPES.BETWEEN;case Di.VALUE_SEARCH_COMPARATORS.GREATER:return ae.SEARCH_TYPES.GREATER_THAN;case Di.VALUE_SEARCH_COMPARATORS.GREATER_OR_EQ:return ae.SEARCH_TYPES.GREATER_THAN_EQUAL;case Di.VALUE_SEARCH_COMPARATORS.LESS:return ae.SEARCH_TYPES.LESS_THAN;case Di.VALUE_SEARCH_COMPARATORS.LESS_OR_EQ:return ae.SEARCH_TYPES.LESS_THAN_EQUAL;default:throw new Error(Wy.UNKNOWN_SEARCH_TYPE)}}a(Xy,"createSearchTypeFromSearchObject");jy.exports={executeSearch:zy,createSearchTypeFromSearchObject:Xy,prepSearch:GK,searchByType:Jy}});var eI=T((Qae,Zy)=>{"use strict";var Wae=vs(),kK=yo(),VK=$(),$K=y(),YK=m_();Zy.exports=KK;function KK(e,t){if(!VK.isEmpty(t)&&$K.VALUE_SEARCH_COMPARATORS_REVERSE_LOOKUP[t]===void 0)throw new Error(`Value search comparator - ${t} - is not valid`);let s=kK(e,"value");if(s)throw s;let n=!0;return YK.prepSearch(e,t,n)}a(KK,"lmdbGetDataByValue")});var Ec=T((Xae,tI)=>{"use strict";var Jae=vs(),WK=yo(),QK=$(),zK=y(),JK=m_();tI.exports=XK;async function XK(e,t){if(!QK.isEmpty(t)&&zK.VALUE_SEARCH_COMPARATORS_REVERSE_LOOKUP[t]===void 0)throw new Error(`Value search comparator - ${t} - is not valid`);let s=WK(e,"value");if(s)throw s;return JK.prepSearch(e,t,!1)}a(XK,"lmdbSearchByValue")});var sI=T((ece,rI)=>{"use strict";var Zae=ze(),Dm=class{static{a(this,"SearchByConditionsObject")}constructor(t,r,s,n,i=void 0,o=void 0,c="and"){this.schema=t,this.table=r,this.get_attributes=s,this.limit=i,this.offset=o,this.conditions=n,this.operator=c}},Um=class{static{a(this,"SearchCondition")}constructor(t,r,s){this.search_attribute=t,this.search_type=r,this.search_value=s}},Mm=class{static{a(this,"SortAttribute")}constructor(t,r){this.attribute=t,this.desc=r}};rI.exports={SearchByConditionsObject:Dm,SearchCondition:Um,SortAttribute:Mm}});var cI=T((nce,aI)=>{"use strict";var rce=sI().SearchByConditionsObject,jK=vs(),ZK=yo(),Pm=bo(),p_=ze(),{Resource:sce}=(ns(),Z(PE)),oI=m_(),eW=ym(),tW=require("lodash"),{getSchemaPath:rW}=ve(),nI=De(),{handleHDBError:sW,hdb_errors:nW}=j(),{HTTP_STATUS_CODES:iW}=nW,oW=1e8;aI.exports=aW;async function aW(e){let t=ZK(e,"conditions");if(t)throw sW(t,t.message,iW.BAD_REQUEST,void 0,void 0,!0);e.operator=e.operator?e.operator.toLowerCase():void 0,e.offset=Number.isInteger(e.offset)?e.offset:0;let r=rW(e.schema,e.table),s=await nI.openEnvironment(r,e.table),n=global.hdb_schema[e.schema][e.table];for(let _ of e.conditions)nI.openDBI(s,_.search_attribute);let i=tW.sortBy(e.conditions,_=>{if(_.estimated_count===void 0){let l=_.search_type;l===p_.SEARCH_TYPES.EQUALS?_.estimated_count=Pm.count(s,_.search_attribute,_.search_value):l===p_.SEARCH_TYPES.CONTAINS||l===p_.SEARCH_TYPES.ENDS_WITH?_.estimated_count=1/0:_.estimated_count=oW}return _.estimated_count}),o=s.useReadTransaction();o.database=s;let c=await iI(o,e,i[0],n.hash_attribute),u;if(!e.operator||e.operator.toLowerCase()==="and"){let _=s.dbis[n.hash_attribute],l=i.slice(1).map(oI.filterByType),d=l.length,f=Pm.setGetWholeRowAttributes(s,e.get_attributes);u=c.map(E=>_.get(E,{transaction:o,lazy:!0})),d>0&&(u=u.filter(E=>{for(let h=0;h<d;h++)if(!l[h](E))return!1;return!0})),(e.offset||e.limit!==void 0)&&(u=u.slice(e.offset,e.limit!==void 0?(e.offset||0)+e.limit:void 0)),u=u.map(E=>eW.parseRow(E,f))}else{for(let d=1;d<i.length;d++){let f=i[d],E=await iI(o,e,f,n.hash_attribute);c=c.concat(E)}let _=new Set,l=e.offset||0;c=c.filter(d=>_.has(d)?!1:(_.add(d),!0)).slice(l,e.limit&&e.limit+l),u=Pm.batchSearchByHash(o,n.hash_attribute,e.get_attributes,c)}return u.onDone=()=>{o.done()},u}a(aW,"lmdbSearchByConditions");async function iI(e,t,r,s){let n=new jK(t.schema,t.table,void 0,void 0,s,t.get_attributes),i=r.search_type;return n.search_attribute=r.search_attribute,i===p_.SEARCH_TYPES.BETWEEN?(n.search_value=r.search_value[0],n.end_value=r.search_value[1]):n.search_value=r.search_value,oI.searchByType(e,n,i,s).map(o=>o.value)}a(iI,"executeConditionSearch")});var hc=T((oce,uI)=>{"use strict";var cW=y().OPERATIONS_ENUM,vm=class{static{a(this,"DeleteObject")}constructor(t,r,s,n=void 0){this.operation=cW.DELETE,this.schema=t,this.table=r,this.hash_values=s,this.__origin=n}};uI.exports=vm});var Bm=T((cce,pI)=>{"use strict";var fI=vs(),EI=hc(),hI=Ec(),mI=_c(),Xt=y(),lI=$(),_I=De(),{getTransactionAuditStorePath:uW,getSchemaPath:lW}=ve(),dI=G();pI.exports=_W;async function _W(e){try{if(lI.isEmpty(global.hdb_schema[e.schema])||lI.isEmpty(global.hdb_schema[e.schema][e.table]))throw new Error(`unknown schema:${e.schema} and table ${e.table}`);await dW(e),await fW(e);let t=lW(e.schema,e.table);try{await _I.deleteEnvironment(t,e.table)}catch(r){if(r.message==="invalid environment")dI.warn(`cannot delete environment for ${e.schema}.${e.table}, environment not found`);else throw r}try{let r=uW(e.schema,e.table);await _I.deleteEnvironment(r,e.table,!0)}catch(r){if(r.message==="invalid environment")dI.warn(`cannot delete environment for ${e.schema}.${e.table}, environment not found`);else throw r}}catch(t){throw t}}a(_W,"lmdbDropTable");async function dW(e){let t=new fI(Xt.SYSTEM_SCHEMA_NAME,Xt.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME,Xt.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_SCHEMA_TABLE_KEY,`${e.schema}.${e.table}`,void 0,[Xt.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ID_KEY]),r=Array.from(await hI(t)),s=[];for(let i=0;i<r.length;i++){let o=r[i];s.push(o.id)}if(s.length===0)return;let n=new EI(Xt.SYSTEM_SCHEMA_NAME,Xt.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME,s);await mI(n)}a(dW,"deleteAttributesFromSystem");async function fW(e){let t=new fI(Xt.SYSTEM_SCHEMA_NAME,Xt.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME,Xt.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_NAME_KEY,e.table,void 0,[Xt.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_NAME_KEY,Xt.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_SCHEMA_KEY,Xt.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ID_KEY]),r,s;try{r=Array.from(await hI(t))}catch(i){throw i}for(let i=0;i<r.length;i++){let o=r[i];o.name===e.table&&o.schema===e.schema&&(s=o)}if(!s)throw new Error(`${e.schema}.${e.table} was not found`);let n=new EI(Xt.SYSTEM_SCHEMA_NAME,Xt.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME,[s.id]);try{await mI(n)}catch(i){throw i}}a(fW,"dropTableFromSystem")});var TI=T((lce,SI)=>{"use strict";var EW=require("fs-extra"),hW=vs(),mW=Io(),pW=hc(),SW=Bm(),TW=_c(),gW=wm(),RW=Ec(),un=y(),{getSchemaPath:AW}=ve(),{handleHDBError:OW,hdb_errors:NW}=j(),{HDB_ERROR_MSGS:bW,HTTP_STATUS_CODES:yW}=NW;SI.exports=IW;async function IW(e){let t;try{t=await wW(e.schema);let r=new hW(un.SYSTEM_SCHEMA_NAME,un.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME,un.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_SCHEMA_KEY,t,void 0,[un.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_NAME_KEY]),s=Array.from(await RW(r));for(let o=0;o<s.length;o++){let c={schema:t,table:s[o].name};try{await SW(c)}catch(u){if(u.message!=="invalid environment")throw u}}let n=new pW(un.SYSTEM_SCHEMA_NAME,un.SYSTEM_TABLE_NAMES.SCHEMA_TABLE_NAME,[t]);await TW(n);let i=AW(t);await EW.remove(i)}catch(r){throw r}}a(IW,"lmdbDropSchema");async function wW(e){let t=new mW(un.SYSTEM_SCHEMA_NAME,un.SYSTEM_TABLE_NAMES.SCHEMA_TABLE_NAME,[e],[un.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_NAME_KEY]),r,s;try{r=Array.from(await gW(t))}catch(n){throw n}for(let[,n]of r)n.name===e&&(s=e);if(!s)throw OW(new Error,bW.SCHEMA_NOT_FOUND(e),yW.NOT_FOUND,void 0,void 0,!0);return s}a(wW,"validateDropSchema")});var qm=T((dce,gI)=>{"use strict";var Hm=class{static{a(this,"CreateTableObject")}constructor(t,r,s){this.schema=t,this.table=r,this.hash_attribute=s}};gI.exports=Hm});var AI=T((hce,RI)=>{"use strict";var CW=require("fs-extra"),S_=De(),{getTransactionAuditStorePath:LW}=ve(),Fm=ze(),Ece=qm();RI.exports=DW;async function DW(e){let t;try{let r=LW(e.schema,e.table);await CW.mkdirp(r),t=await S_.createEnvironment(r,e.table,!0)}catch(r){throw r.message=`unable to create transactions audit environment for ${e.schema}.${e.table} due to: ${r.message}`,r}try{S_.createDBI(t,Fm.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP,!1,!0),S_.createDBI(t,Fm.TRANSACTIONS_DBI_NAMES_ENUM.HASH_VALUE,!0,!1),S_.createDBI(t,Fm.TRANSACTIONS_DBI_NAMES_ENUM.USER_NAME,!0,!1)}catch(r){throw r.message=`unable to create dbi for ${e.schema}.${e.table} due to: ${r.message}`,r}return t}a(DW,"createTransactionsAuditEnvironment")});var yI=T((pce,bI)=>{"use strict";var Gm=y(),OI=De(),UW=_o(),{getSystemSchemaPath:MW,getSchemaPath:PW}=ve(),vW=Si(),BW=Fl(),xm=ql(),HW=G(),qW=AI(),Vm=vW.hdb_table,NI=[];for(let e=0;e<Vm.attributes.length;e++)NI.push(Vm.attributes[e].attribute);bI.exports=FW;async function FW(e,t){let r=PW(t.schema,t.table),s=new xm(t.schema,t.table,Gm.TIME_STAMP_NAMES_ENUM.CREATED_TIME,void 0,!0),n=new xm(t.schema,t.table,Gm.TIME_STAMP_NAMES_ENUM.UPDATED_TIME,void 0,!0),i=new xm(t.schema,t.table,t.hash_attribute,void 0,!1,!0);try{if(await OI.createEnvironment(r,t.table),e!==void 0){let o=await OI.openEnvironment(MW(),Gm.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME);await UW.insertRecords(o,Vm.hash_attribute,NI,[e]),s.skip_table_check=!0,n.skip_table_check=!0,i.skip_table_check=!0,await km(s),await km(n),await km(i)}await qW(t)}catch(o){throw o}}a(FW,"lmdbCreateTable");async function km(e){try{await BW(e)}catch(t){HW.warn(`failed to create attribute ${e.attribute} due to ${t.message}`)}}a(km,"createAttribute")});var wI=T((Tce,II)=>{"use strict";var GW=Xa(),xW=rc(),kW=u_(),mc=y(),VW=_o().updateRecords,$W=De(),{getSchemaPath:YW}=ve(),KW=uc(),WW=G();II.exports=QW;async function QW(e){try{let{schema_table:t,attributes:r}=GW(e);xW(e,r,t.hash_attribute),e.schema!==mc.SYSTEM_SCHEMA_NAME&&(r.includes(mc.TIME_STAMP_NAMES_ENUM.CREATED_TIME)||r.push(mc.TIME_STAMP_NAMES_ENUM.CREATED_TIME),r.includes(mc.TIME_STAMP_NAMES_ENUM.UPDATED_TIME)||r.push(mc.TIME_STAMP_NAMES_ENUM.UPDATED_TIME));let s=await kW(e.hdb_auth_header,t,r),n=YW(e.schema,e.table),i=await $W.openEnvironment(n,e.table),o=await VW(i,t.hash_attribute,r,e.records,e.__origin?.timestamp);try{await KW(e,o)}catch(c){WW.error(`unable to write transaction due to ${c.message}`)}return{written_hashes:o.written_hashes,skipped_hashes:o.skipped_hashes,schema_table:t,new_attributes:s,txn_time:o.txn_time}}catch(t){throw t}}a(QW,"lmdbUpdateRecords")});var LI=T((Rce,CI)=>{"use strict";var zW=y().OPERATIONS_ENUM,$m=class{static{a(this,"UpsertObject")}constructor(t,r,s,n=void 0){this.operation=zW.UPSERT,this.schema=t,this.table=r,this.records=s,this.__origin=n}};CI.exports=$m});var UI=T((Nce,DI)=>{"use strict";var Oce=LI(),JW=Xa(),XW=rc(),jW=u_(),pc=y(),ZW=_o().upsertRecords,eQ=De(),{getSchemaPath:tQ}=ve(),rQ=uc(),sQ=G(),{handleHDBError:nQ,hdb_errors:iQ}=j();DI.exports=oQ;async function oQ(e){let t;try{t=JW(e)}catch(u){throw nQ(u,u.message,iQ.HTTP_STATUS_CODES.BAD_REQUEST,void 0,void 0,!0)}let{schema_table:r,attributes:s}=t;XW(e,s,r.hash_attribute),e.schema!==pc.SYSTEM_SCHEMA_NAME&&(s.includes(pc.TIME_STAMP_NAMES_ENUM.CREATED_TIME)||s.push(pc.TIME_STAMP_NAMES_ENUM.CREATED_TIME),s.includes(pc.TIME_STAMP_NAMES_ENUM.UPDATED_TIME)||s.push(pc.TIME_STAMP_NAMES_ENUM.UPDATED_TIME));let n=await jW(e.hdb_auth_header,r,s),i=tQ(e.schema,e.table),o=await eQ.openEnvironment(i,e.table),c=await ZW(o,r.hash_attribute,s,e.records,e.__origin?.timestamp);try{await rQ(e,c)}catch(u){sQ.error(`unable to write transaction due to ${u.message}`)}return{written_hashes:c.written_hashes,schema_table:r,new_attributes:n,txn_time:c.txn_time}}a(oQ,"lmdbUpsertRecords")});var PI=T((yce,MI)=>{"use strict";var Ym=class{static{a(this,"DeleteBeforeObject")}constructor(t,r,s){this.schema=t,this.table=r,this.timestamp=s}};MI.exports=Ym});var BI=T((wce,vI)=>{"use strict";var Km=class{static{a(this,"DeleteAuditLogsBeforeResults")}constructor(t=void 0,r=void 0,s=0){this.start_timestamp=t,this.end_timestamp=r,this.transactions_deleted=s}};vI.exports=Km});var FI=T((Dce,qI)=>{"use strict";var Wm=De(),{getTransactionAuditStorePath:aQ}=ve(),Lce=PI(),Sc=ze(),cQ=$(),HI=BI(),uQ=require("util").promisify,lQ=uQ(setTimeout),_Q=1e4,dQ=100;qI.exports=fQ;async function fQ(e){let t=aQ(e.schema,e.table),r=await Wm.openEnvironment(t,e.table,!0),s=Wm.listDBIs(r);Wm.initializeDBIs(r,Sc.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP,s);let n,i=new HI;do n=await EQ(r,e.timestamp),i.start_timestamp===void 0&&(i.start_timestamp=n.start_timestamp),n.end_timestamp!==void 0&&(i.end_timestamp=n.end_timestamp),i.transactions_deleted+=n.transactions_deleted,await lQ(dQ);while(n.transactions_deleted>0);return i}a(fQ,"deleteAuditLogsBefore");async function EQ(e,t){let r=new HI;try{let s=e.dbis[Sc.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP],n;for(let{key:i,value:o}of s.getRange({start:!1})){if(i>=t)break;r.start_timestamp===void 0&&(r.start_timestamp=i),n=s.remove(i);let c=o[Sc.TRANSACTIONS_DBI_NAMES_ENUM.USER_NAME];cQ.isEmpty(c)||(n=e.dbis[Sc.TRANSACTIONS_DBI_NAMES_ENUM.USER_NAME].remove(c,i));for(let u=0;u<o.hash_values.length;u++)n=e.dbis[Sc.TRANSACTIONS_DBI_NAMES_ENUM.HASH_VALUE].remove(o.hash_values[u],i);if(r.transactions_deleted++,r.end_timestamp=i,r.transactions_deleted>_Q)break}return await n,r}catch(s){throw s}}a(EQ,"deleteTransactions")});var xI=T((Mce,GI)=>{"use strict";var Qm=class{static{a(this,"DropAttributeObject")}constructor(t,r,s){this.schema=t,this.table=r,this.attribute=s}};GI.exports=Qm});var VI=T((Bce,kI)=>{"use strict";var hQ=vs(),mQ=hc(),vce=xI(),Bs=y(),pQ=$(),zm=De(),SQ=Si(),TQ=Ec(),gQ=_c(),{getSchemaPath:RQ}=ve();kI.exports=AQ;async function AQ(e,t=!0){let r;e.schema===Bs.SYSTEM_SCHEMA_NAME?r=SQ[e.table]:r=global.hdb_schema[e.schema][e.table];let s=await NQ(e),n=RQ(e.schema,e.table),i=await zm.openEnvironment(n,e.table);return t===!0&&await OQ(e,i,r.hash_attribute),zm.dropDBI(i,e.attribute),s}a(AQ,"lmdbDropAttribute");async function OQ(e,t,r){let s=zm.openDBI(t,r),n,i=e.attribute;for(let{key:o,value:c,version:u}of s.getRange({start:!1,versions:!0})){let _={};for(let l in c)l!==i&&(_[l]=c[l]);n=t.dbis[r].put(o,_,u)}await n}a(OQ,"removeAttributeFromAllObjects");async function NQ(e){let t=new hQ(Bs.SYSTEM_SCHEMA_NAME,Bs.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME,Bs.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_SCHEMA_TABLE_KEY,`${e.schema}.${e.table}`,void 0,[Bs.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ID_KEY,Bs.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ATTRIBUTE_KEY]),s=Array.from(await TQ(t)).filter(o=>o[Bs.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ATTRIBUTE_KEY]===e.attribute);if(pQ.isEmptyOrZeroLength(s))throw new Error(`Attribute '${e.attribute}' was not found in '${e.schema}.${e.table}'`);let n=s.map(o=>o[Bs.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ID_KEY]),i=new mQ(Bs.SYSTEM_SCHEMA_NAME,Bs.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME,n);return gQ(i)}a(NQ,"dropAttributeFromSystem")});var zI=T((Fce,QI)=>{"use strict";var Jm=De(),wo=ze(),qce=Er(),Xm=y(),$I=$(),{getTransactionAuditStorePath:bQ}=ve(),yQ=bo(),T_=Ao(),IQ=G();QI.exports=wQ;async function wQ(e){let t=bQ(e.schema,e.table),r=await Jm.openEnvironment(t,e.table,!0),s=Jm.listDBIs(r);Jm.initializeDBIs(r,wo.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP,s);let n;switch(e.search_type){case Xm.READ_AUDIT_LOG_SEARCH_TYPES_ENUM.TIMESTAMP:return YI(r,e.search_values);case Xm.READ_AUDIT_LOG_SEARCH_TYPES_ENUM.HASH_VALUE:return n=global.hdb_schema[e.schema][e.table].hash_attribute,LQ(r,e.search_values,n);case Xm.READ_AUDIT_LOG_SEARCH_TYPES_ENUM.USERNAME:return CQ(r,e.search_values);default:return YI(r)}}a(wQ,"readAuditLog");function YI(e,t=[0,Date.now()]){$I.isEmpty(t[0])&&(t[0]=0),$I.isEmpty(t[1])&&(t[1]=Date.now());let r=e.dbis[wo.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP],s;for(let n of r.getKeys({start:t[1]}))if(n!==t[1]){s=n;break}return r.getRange({start:t[0],end:s}).map(({value:n})=>Object.assign(new T_,n))}a(YI,"searchTransactionsByTimestamp");function CQ(e,t=[]){let r=new Map;for(let s=0;s<t.length;s++){let n=t[s],i=[];for(let o of e.dbis[wo.TRANSACTIONS_DBI_NAMES_ENUM.USER_NAME].getValues(n))i.push(o);r.set(n,WI(e,i))}return Object.fromEntries(r)}a(CQ,"searchTransactionsByUsername");function LQ(e,t,r){let s=new Map;for(let c=0,u=t.length;c<u;c++){let _=t[c],l=yQ.equals(e,wo.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP,wo.TRANSACTIONS_DBI_NAMES_ENUM.HASH_VALUE,_);for(let{value:d}of l){let f=Number(d);s.has(f)?s.get(f).push(_.toString()):s.set(f,[_.toString()])}}let n=Array.from(s.keys()),i=WI(e,n),o=new Map;for(let c=0;c<i.length;c++){let u=i[c],_=u.timestamp,l=s.get(_);KI(u,"records",r,l,o),KI(u,"original_records",r,l,o)}return Object.fromEntries(o)}a(LQ,"searchTransactionsByHashValues");function KI(e,t,r,s,n){let i=e.timestamp;if(e[t])for(let o=0;o<e[t].length;o++){let c=e[t][o],u=c[r].toString();if(s.indexOf(u)>=0)if(n.has(u)){let _=n.get(u),l=_[_.length-1];if(l.timestamp===i)l[t]=[c];else{let d=new T_(e.operation,e.user_name,i,void 0);d[t]=[c],_.push(d)}}else{let _=new T_(e.operation,e.user_name,i,void 0);_[t]=[c],n.set(u,[_])}}}a(KI,"loopRecords");function WI(e,t){let r=[];try{let s=e.dbis[wo.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP];for(let n=0;n<t.length;n++)try{let i=s.get(t[n]);if(i){let o=Object.assign(new T_,i);r.push(o)}}catch(i){IQ.warn(i)}return r}catch(s){throw s}}a(WI,"batchSearchTransactions")});var XI=T((Vce,JI)=>{"use strict";var{getSchemaPath:xce}=ve(),kce=De(),{database:DQ}=(Ee(),Z(Ce));JI.exports={writeTransaction:UQ};async function UQ(e,t,r){return DQ({database:e,table:t}).transaction(r)}a(UQ,"writeTransaction")});var tw=T((Yce,ew)=>{"use strict";var{getSchemaPath:jI}=ve(),ZI=De();ew.exports={flush:MQ,resetReadTxn:PQ};async function MQ(e,t){return(await ZI.openEnvironment(jI(e,t),t.toString())).flushed}a(MQ,"flush");async function PQ(e,t){try{(await ZI.openEnvironment(jI(e,t),t.toString())).resetReadTxn()}catch{}}a(PQ,"resetReadTxn")});var iw=T((Wce,nw)=>{"use strict";var{Readable:vQ}=require("stream"),{getDatabases:BQ}=(Ee(),Z(Ce)),{readSync:HQ,openSync:qQ,createReadStream:rw}=require("fs"),{open:FQ}=require("lmdb"),sw=wl(),GQ=Ll(),{AUDIT_STORE_OPTIONS:xQ}=(ao(),Z(OO)),{INTERNAL_DBIS_NAME:kQ,AUDIT_STORE_NAME:VQ}=ze();nw.exports=YQ;var jm=32768,$Q=100;async function YQ(e){let t=e.database||e.schema||"data",r=BQ()[t],s=new Date().toISOString(),n=e.tables||e.table&&[e.table];if(n){let _=r[n[0]];if(!_)throw new Error(`Can not find table ${n[0]}`);let l=_.dbisDB,d=FQ({noSync:!0,maxDbs:GQ.MAX_DBS}),f,E=d.openDB(kQ,new sw(!1)),h=l.useReadTransaction(),p=0,S=a(async function(b,O){O.encoding="binary",O.encoder=void 0;let Y=d.openDB(b,O),Q=l.openDB(b,O);for(let{key:F,version:w,value:K}of Q.getRange({transaction:h,versions:Q.useVersions}))f=Y.put(F,K,w),p++%$Q===0&&(await new Promise(B=>setTimeout(B,20)),h.openTimer&&(h.openTimer=0))},"copyDatabase");for(let{key:b,value:O}of l.getRange({transaction:h,start:!1}))if(n.some(Y=>b.startsWith?.(Y+"/"))){E.put(b,O);let[,Y]=b.split("/"),Q=!Y,F=new sw(!Q,Q);await S(b,F)}e.include_audit&&await S(VQ,Object.assign({},xQ)),await f;let g=rw(d.path);return g.headers=u(),g.on("close",()=>{h.done(),d.close()}),g}let o=r[Object.keys(r)[0]].primaryStore,c=qQ(o.path);return o.transaction(()=>{let _=Buffer.alloc(jm);HQ(c,_,0,jm);let l=o.useReadTransaction(),d=rw(null,{fd:c,start:jm}),f=new vQ.from(async function*(){yield _;for await(let E of d)l.openTimer&&(l.openTimer=0),yield E;l.done()}());return f.headers=u(),f});function u(){let _=new Map;return _.set("content-type","application/octet-stream"),_.set("content-disposition",`attachment; filename="${t}"`),_.set("date",s),_}}a(YQ,"getBackup")});var cw=T((zce,aw)=>{"use strict";var KQ=G(),{handleHDBError:WQ}=j(),QQ=uO(),zQ=Fl(),JQ=Rm(),XQ=Ty(),jQ=_c(),ZQ=wm(),ez=Yy(),tz=eI(),rz=Ec(),sz=cI(),nz=TI(),iz=yI(),oz=wI(),az=UI(),cz=FI(),uz=Bm(),lz=VI(),_z=zI(),dz=XI(),ow=tw(),fz=iw(),Zm=class extends QQ{static{a(this,"LMDBBridge")}async searchByConditions(t){return sz(t)}async getDataByHash(t){return await ZQ(t)}async searchByHash(t){return await ez(t)}async getDataByValue(t,r){return await tz(t,r)}async searchByValue(t){return await rz(t)}async createSchema(t){return await XQ(t)}async dropSchema(t){return await nz(t)}async createTable(t,r){return await iz(t,r)}async dropTable(t){return await uz(t)}async createAttribute(t){return await zQ(t)}async createRecords(t){return await JQ(t)}async updateRecords(t){return await oz(t)}async upsertRecords(t){try{return await az(t)}catch(r){throw WQ(r,null,null,KQ.ERR,r)}}async deleteRecords(t){return await jQ(t)}async dropAttribute(t){return await lz(t)}async deleteAuditLogsBefore(t){return await cz(t)}async readAuditLog(t){return await _z(t)}writeTransaction(t,r,s){return dz.writeTransaction(t,r,s)}flush(t,r){return ow.flush(t,r)}resetReadTxn(t,r){return ow.resetReadTxn(t,r)}getBackup(t){return fz(t)}};aw.exports=Zm});var pw={};qe(pw,{ResourceBridge:()=>rp});function sp({get_attributes:e},t){if(e){if(e[0]==="*"){if(t.schemaDefined)return;e=t.attributes.map(r=>r.name)}return e.forceNulls=!0,e}}function lw(e,t){let r=Hs(e),s=sp(e,r);if(!r)throw new _s.ClientError(`Table ${e.table} not found`);let n;s&&r.attributes.length-s.length>2&&s.length<5&&(n=!0);let i={user:e.hdb_user},o;Ge(i,()=>new Promise(_=>o=_));let c=e.ids||e.hash_values,u=0;return{[Symbol.asyncIterator](){return{async next(){if(u<c.length){let _=c[u++],l=await r.get({id:_,lazy:n,select:s},i);return l=l&&dl(l),t?{value:{key:_,value:l}}:{value:l}}else return o(),{done:!0}},return(_){return o(),{value:_,done:!0}},throw(_){return o(),{done:!0}}}}}}function Hs(e){let t=e.database||e.schema||hz,r=ds()[t];if(!r)throw(0,_s.handleHDBError)(new Error,Ez.SCHEMA_NOT_FOUND(t),404);return r[e.table]}function _w(e,t,r){let s=e.length+t.length,n=s===1?"record":"records";return{message:`${e.length} of ${s} ${n} successfully deleted`,deleted_hashes:e,skipped_hashes:t,txn_time:r}}async function*dw(e,t,r){let s;for await(let n of e.getHistory(t,r)){let i=n.type;i==="put"&&(i="upsert");let{id:o,version:c,value:u}=n;s?.timestamp===c?(s.hash_values.push(o),s.records.push(u)):(s&&(yield s),s={operation:i,user_name:n.user,timestamp:c,hash_values:[o],records:[u]})}s&&(yield s)}var fw,g_,_s,Ew,hw,Es,ep,tp,mw,Ez,hz,mz,pz,uw,rp,Sw=Te(()=>{"use strict";fw=M(cw()),g_=M(yo()),_s=M(j());Ee();Ew=M(Xa()),hw=M(rc()),Es=M(y()),ep=M(an()),tp=M(ls()),mw=M($());Ei();fl();({HDB_ERROR_MSGS:Ez}=_s.hdb_errors),hz="data",mz=1e4,pz=10,rp=class extends fw.default{static{a(this,"ResourceBridge")}constructor(t){super(t),uw=this}async searchByConditions(t){let r=(0,g_.default)(t,"conditions");if(r)throw(0,_s.handleHDBError)(r,r.message,400,void 0,void 0,!0);let s=Hs(t);if(!s)throw new _s.ClientError(`Table ${t.table} not found`);let n=t.conditions.map(i=>({attribute:i.search_attribute,comparator:i.search_type,value:i.search_value}));return s.search({conditions:n,operator:t.operator?t.operator.toLowerCase():void 0,limit:t.limit,offset:t.offset,reverse:t.reverse,select:sp(t,s),allowFullScan:!0})}async createTable(t,r){let s=r.attributes,n=!!s,i=r.primary_key||r.hash_attribute;if(s)for(let o of s)o.is_primary_key?(o.isPrimaryKey=!0,delete o.is_primary_key):o.name===i&&i&&(o.isPrimaryKey=!0);else{if(!i)throw new _s.ClientError("A primary key must be specified with a `primary_key` property or with `attributes`");s=[{name:i,isPrimaryKey:!0},{name:"__createdtime__",indexed:!0},{name:"__updatedtime__",indexed:!0}]}et({database:r.schema,table:r.table,attributes:s,schemaDefined:n,expiration:r.expiration})}async createAttribute(t){return await Hs(t).addAttributes([{name:t.attribute,indexed:t.indexed??!0}]),`attribute ${t.schema}.${t.table}.${t.attribute} successfully created.`}async dropAttribute(t){let r=Hs(t);if(await r.removeAttributes([t.attribute]),!r.schemaDefined){let s=t.attribute,n,i=a((o,c,u)=>(c=Object.assign({},c),delete c[s],r.primaryStore.ifVersion(o,u,()=>r.primaryStore.put(o,c,u)).then(_=>{if(!_){let{value:l,version:d}=r.primaryStore.getEntry(o);return i(o,l,d)}})),"deleteRecord");for(let{key:o,value:c,version:u}of r.primaryStore.getRange({start:!0,versions:!0}))n=i(o,c,u),await new Promise(_=>setImmediate(_));await n}return`successfully deleted ${t.schema}.${t.table}.${t.attribute}`}dropTable(t){Hs(t).dropTable()}createSchema(t){return Tc({database:t.schema,table:null}),ep.signalSchemaChange(new tp.SchemaEventMsg(process.pid,Es.OPERATIONS_ENUM.CREATE_SCHEMA,t.schema))}async dropSchema(t){await np(t.schema),ep.signalSchemaChange(new tp.SchemaEventMsg(process.pid,Es.OPERATIONS_ENUM.DROP_SCHEMA,t.schema))}async updateRecords(t){return t.requires_existing=!0,this.upsertRecords(t)}async createRecords(t){return t.requires_no_existing=!0,uw.upsertRecords(t)}async upsertRecords(t){let{schema_table:r,attributes:s}=(0,Ew.default)(t);(0,hw.default)(t,s,r.primaryKey);let n,i=ds()[t.schema][t.table],o={user:t.hdb_user,expiresAt:t.expiresAt};return Ge(o,async c=>{if(!i.schemaDefined){n=[];for(let l of s)i.attributes.find(f=>f.name==l)||n.push(l);n.length>0&&await i.addAttributes(n.map(l=>({name:l,indexed:!0})))}let u=[],_=[];for(let l of t.records){let d=await i.get(l[i.primaryKey],o);if(t.requires_existing&&!d||t.requires_no_existing&&d){_.push(l[i.primaryKey]);continue}d&&(d=dl(d));for(let f in l)if(Object.prototype.hasOwnProperty.call(l,f)){let E=l[f];if(typeof E=="function")try{let h=E([[d]]);Array.isArray(h)&&(E=h[0].func_val,l[f]=E)}catch(h){throw h.message+="Trying to set key "+f+" on object"+JSON.stringify(l),h}}if(d)for(let f in d)Object.prototype.hasOwnProperty.call(l,f)||(l[f]=d[f]);await i.put(l,o),u.push(l[i.primaryKey])}return{txn_time:c.timestamp,written_hashes:u,new_attributes:n,skipped_hashes:_}})}async deleteRecords(t){let r=ds()[t.schema][t.table],s={user:t.hdb_user};return Ge(s,async n=>{let i=t.hash_values||t.records.map(u=>u[r.primaryKey]),o=[],c=[];for(let u of i)await r.delete(u,s)?o.push(u):c.push(u);return _w(o,c,n.timestamp)})}async deleteRecordsBefore(t){let r=ds()[t.schema][t.table];if(!r.createdTimeProperty)throw new _s.ClientError("Table must have a '__createdtime__' attribute or @createdTime timestamp defined to perform this operation");let s=await r.search({conditions:[{attribute:r.createdTimeProperty.name,value:Date.parse(t.date),comparator:Es.VALUE_SEARCH_COMPARATORS.LESS}]}),n=!1,i=[],o=[],c=0,u=[],_=a(async()=>{let l=await this.deleteRecords({schema:t.schema,table:t.table,hash_values:u});i.push(...l.deleted_hashes),o.push(...l.skipped_hashes),await(0,mw.async_set_timeout)(pz),u=[],n=!0},"chunkDelete");for await(let l of s)u.push(l[r.primaryKey]),c++,c%mz===0&&await _();return u.length>0&&await _(),n?_w(i,o,void 0):{message:"No records found to delete"}}searchByHash(t){let r=(0,g_.default)(t,"hashes");if(r)throw r;return lw(t)}async getDataByHash(t){let r=new Map;t._returnKeyValue=!0;for await(let{key:s,value:n}of lw(t,!0))r.set(s,n);return r}searchByValue(t,r){if(r&&Es.VALUE_SEARCH_COMPARATORS_REVERSE_LOOKUP[r]===void 0)throw new Error(`Value search comparator - ${r} - is not valid`);let s=(0,g_.default)(t,"value");if(s)throw s;let n=Hs(t);if(!n)throw new _s.ClientError(`Table ${t.table} not found`);let i=t.search_value;i.includes?.("*")&&(i.startsWith("*")?i.endsWith("*")?i!=="*"&&(r="contains",i=i.slice(1,-1)):(r="ends_with",i=i.slice(1)):i.endsWith("*")&&(r="starts_with",i=i.slice(0,-1))),r===Es.VALUE_SEARCH_COMPARATORS.BETWEEN&&(i=[i,t.end_value]);let o=i==="*"?[]:[{attribute:t.search_attribute,value:i,comparator:r}];return n.search({conditions:o,allowFullScan:!0,limit:t.limit,offset:t.offset,reverse:t.reverse,select:sp(t,n)})}async getDataByValue(t,r){let s=new Map,n=Hs(t);t.get_attributes&&!t.get_attributes.includes(n.primaryKey)&&t.get_attributes[0]!=="*"&&t.get_attributes.push(n.primaryKey);for await(let i of this.searchByValue(t,r))s.set(i[n.primaryKey],i);return s}resetReadTxn(t,r){Hs({schema:t,table:r})?.primaryStore.resetReadTxn()}async deleteAuditLogsBefore(t){return Hs(t).deleteHistory(t.timestamp)}async readAuditLog(t){let r=Hs(t),s={};switch(t.search_type){case Es.READ_AUDIT_LOG_SEARCH_TYPES_ENUM.HASH_VALUE:for(let i of t.search_values)s[i]=(await r.getHistoryOfRecord(i)).map(o=>{let c=o.type;return c==="put"&&(c="upsert"),{operation:c,timestamp:o.version,user_name:o.user,hash_values:[i],records:[o.value]}});return s;case Es.READ_AUDIT_LOG_SEARCH_TYPES_ENUM.USERNAME:let n=t.search_values;for await(let i of dw(r))n.includes(i.user_name)&&(s[i.user_name]||(s[i.user_name]=[])).push(i);return s;default:return dw(r,t.search_values?.[0],t.search_values?.[1])}}};a(sp,"getSelect");a(lw,"getRecords");a(Hs,"getTable");a(_w,"createDeleteResponse");a(dw,"groupRecordsInHistory")});var as=T((tue,Tw)=>{"use strict";var{ResourceBridge:Sz}=(Sw(),Z(pw)),Tz=X();Tz.initSync();var R_;function gz(){return R_||(R_=new Sz,R_)}a(gz,"getBridge");Tw.exports=gz()});var Ow=T((sue,Aw)=>{"use strict";var gw=require("lodash"),gc=require("mathjs"),Rz=require("jsonata"),Rw=$();Aw.exports={distinct_array:e=>Array.isArray(e)&&e.length>1?gw.uniqWith(e,gw.isEqual):e,searchJSON:Az,mad:Rc.bind(null,gc.mad),mean:Rc.bind(null,gc.mean),mode:Rc.bind(null,gc.mode),prod:Rc.bind(null,gc.prod),median:Rc.bind(null,gc.median)};function Rc(e,t,r,s){return s===1?t==null?[]:[t]:s===2?(t!=null&&r.push(t),r):r!=null&&r.length>0?e(r):null}a(Rc,"aggregateFunction");function Az(e,t){if(typeof e!="string"||e.length===0)throw new Error("search json expression must be a non-empty string");let r="__"+e+"__";if(Rw.isEmpty(this.__ala__.res)&&(this.__ala__.res={}),Rw.isEmpty(this.__ala__.res[r])){let s=Rz(e);this.__ala__.res[r]=s}return this.__ala__.res[r].evaluate(t)}a(Az,"searchJSON")});var bw=T((iue,Nw)=>{"use strict";var rt=require("moment"),ip="YYYY-MM-DDTHH:mm:ss.SSSZZ";rt.suppressDeprecationWarnings=!0;Nw.exports={current_date:()=>rt().utc().format("YYYY-MM-DD"),current_time:()=>rt().utc().format("HH:mm:ss.SSS"),extract:(e,t)=>{switch(t.toLowerCase()){case"year":return rt(e).utc().format("YYYY");case"month":return rt(e).utc().format("MM");case"day":return rt(e).utc().format("DD");case"hour":return rt(e).utc().format("HH");case"minute":return rt(e).utc().format("mm");case"second":return rt(e).utc().format("ss");case"millisecond":return rt(e).utc().format("SSS");default:break}},date:e=>rt(e).utc().format(ip),date_format:(e,t)=>rt(e).utc().format(t),date_add:(e,t,r)=>rt(e).utc().add(t,r).valueOf(),date_sub:(e,t,r)=>rt(e).utc().subtract(t,r).valueOf(),date_diff:(e,t,r)=>{let s=rt(e).utc(),n=rt(t).utc();return r?s.diff(n,r,!0):s.diff(n)},now:()=>rt().utc().valueOf(),get_server_time:()=>rt().format(ip),offset_utc:(e,t)=>rt(e).utc().utcOffset(t).format(ip)}});var Cw=T((oue,ww)=>{"use strict";var Oz=require("@turf/area"),Nz=require("@turf/length"),bz=require("@turf/circle"),yz=require("@turf/difference"),Iz=require("@turf/distance"),wz=require("@turf/boolean-contains"),Cz=require("@turf/boolean-equal"),Lz=require("@turf/boolean-disjoint"),Dz=require("@turf/helpers"),yw=y(),_e=$();ww.exports={geoArea:Uz,geoLength:Mz,geoCircle:Pz,geoDifference:vz,geoDistance:Iw,geoNear:Bz,geoContains:Hz,geoEqual:qz,geoCrosses:Fz,geoConvert:Gz};var op="geo1 is required",ap="geo2 is required";function Uz(e){if(_e.isEmpty(e))throw new Error("geoJSON is required");return typeof e=="string"&&(e=_e.autoCastJSON(e)),Oz.default(e)}a(Uz,"geoArea");function Mz(e,t){if(_e.isEmpty(e))throw new Error("geoJSON is required");return typeof e=="string"&&(e=_e.autoCastJSON(e)),Nz.default(e,{units:t||"kilometers"})}a(Mz,"geoLength");function Pz(e,t,r){if(_e.isEmpty(e))throw new Error("point is required");if(_e.isEmpty(t))throw new Error("radius is required");return typeof e=="string"&&(e=_e.autoCastJSON(e)),bz.default(e,t,{units:r||"kilometers"})}a(Pz,"geoCircle");function vz(e,t){if(_e.isEmpty(e))throw new Error("poly1 is required");if(_e.isEmpty(t))throw new Error("poly2 is required");return typeof e=="string"&&(e=_e.autoCastJSON(e)),typeof t=="string"&&(t=_e.autoCastJSON(t)),yz(e,t)}a(vz,"geoDifference");function Iw(e,t,r){if(_e.isEmpty(e))throw new Error("point1 is required");if(_e.isEmpty(t))throw new Error("point2 is required");return typeof e=="string"&&(e=_e.autoCastJSON(e)),typeof t=="string"&&(t=_e.autoCastJSON(t)),Iz.default(e,t,{units:r||"kilometers"})}a(Iw,"geoDistance");function Bz(e,t,r,s){if(_e.isEmpty(e))throw new Error("point1 is required");if(_e.isEmpty(t))throw new Error("point2 is required");if(_e.isEmpty(r))throw new Error("distance is required");if(typeof e=="string"&&(e=_e.autoCastJSON(e)),typeof t=="string"&&(t=_e.autoCastJSON(t)),isNaN(r))throw new Error("distance must be a number");return Iw(e,t,s)<=r}a(Bz,"geoNear");function Hz(e,t){if(_e.isEmpty(e))throw new Error(op);if(_e.isEmpty(e))throw new Error(ap);return typeof e=="string"&&(e=_e.autoCastJSON(e)),typeof t=="string"&&(t=_e.autoCastJSON(t)),wz.default(e,t)}a(Hz,"geoContains");function qz(e,t){if(_e.isEmpty(e))throw new Error(op);if(_e.isEmpty(e))throw new Error(ap);return typeof e=="string"&&(e=_e.autoCastJSON(e)),typeof t=="string"&&(t=_e.autoCastJSON(t)),Cz.default(e,t)}a(qz,"geoEqual");function Fz(e,t){if(_e.isEmpty(e))throw new Error(op);if(_e.isEmpty(e))throw new Error(ap);return typeof e=="string"&&(e=_e.autoCastJSON(e)),typeof t=="string"&&(t=_e.autoCastJSON(t)),!Lz.default(e,t)}a(Fz,"geoCrosses");function Gz(e,t,r){if(_e.isEmptyOrZeroLength(e))throw new Error("coordinates is required");if(_e.isEmpty(t))throw new Error("geo_type is required");if(_e.isEmpty(yw.GEO_CONVERSION_ENUM[t]))throw new Error(`geo_type of ${t} is invalid please use one of the following types: ${Object.keys(yw.GEO_CONVERSION_ENUM).join(",")}`);return Dz[t](e,r)}a(Gz,"geoConvert")});var A_=T((cue,Lw)=>{var Ui=Ow(),Nr=bw(),qs=Cw();Lw.exports=e=>{e.aggr.mad=e.aggr.MAD=Ui.mad,e.aggr.mean=e.aggr.MEAN=Ui.mean,e.aggr.mode=e.aggr.MODE=Ui.mode,e.aggr.prod=e.aggr.PROD=Ui.prod,e.aggr.median=e.aggr.MEDIAN=Ui.median,e.fn.distinct_array=e.fn.DISTINCT_ARRAY=Ui.distinct_array,e.fn.search_json=e.fn.SEARCH_JSON=Ui.searchJSON,e.fn.__ala__=e,e.fn.current_date=e.fn.CURRENT_DATE=Nr.current_date,e.fn.current_time=e.fn.CURRENT_TIME=Nr.current_time,e.fn.extract=e.fn.EXTRACT=Nr.extract,e.fn.date=e.fn.DATE=Nr.date,e.fn.date_format=e.fn.DATE_FORMAT=Nr.date_format,e.fn.date_add=e.fn.DATE_ADD=Nr.date_add,e.fn.date_sub=e.fn.DATE_SUB=Nr.date_sub,e.fn.date_diff=e.fn.DATE_DIFF=e.fn.datediff=e.fn.DATEDIFF=Nr.date_diff,e.fn.now=e.fn.NOW=Nr.now,e.fn.offset_utc=e.fn.OFFSET_UTC=Nr.offset_utc,e.fn.get_server_time=e.fn.GET_SERVER_TIME=Nr.get_server_time,e.fn.getdate=e.fn.GETDATE=Nr.now,e.fn.current_timestamp=e.fn.CURRENT_TIMESTAMP=Nr.now,e.fn.geoarea=e.fn.GEOAREA=e.fn.geoArea=qs.geoArea,e.fn.geocircle=e.fn.GEOCIRCLE=e.fn.geoCircle=qs.geoCircle,e.fn.geocontains=e.fn.GEOCONTAINS=e.fn.geoContains=qs.geoContains,e.fn.geoconvert=e.fn.GEOCONVERT=e.fn.geoConvert=qs.geoConvert,e.fn.geocrosses=e.fn.GEOCROSSES=e.fn.geoCrosses=qs.geoCrosses,e.fn.geodifference=e.fn.GEODIFFERENCE=e.fn.geoDifference=qs.geoDifference,e.fn.geodistance=e.fn.GEODISTANCE=e.fn.geoDistance=qs.geoDistance,e.fn.geoequal=e.fn.GEOEQUAL=e.fn.geoEqual=qs.geoEqual,e.fn.geolength=e.fn.GEOLENGTH=e.fn.geoLength=qs.geoLength,e.fn.geonear=e.fn.GEONEAR=e.fn.geoNear=qs.geoNear}});var Pw=T((uue,Mw)=>{"use strict";var Ac=require("lodash"),It=require("alasql");It.options.cache=!1;var xz=A_(),Dw=require("clone"),O_=require("recursive-iterator"),re=G(),ie=$(),Co=as(),kz=y(),{hdb_errors:Vz}=j(),{getDatabases:Uw}=(Ee(),Z(Ce)),$z="IS NULL",hs="There was a problem performing this search. Please check the logs and try again.";xz(It);var cp=class{static{a(this,"SQLSearch")}constructor(t,r){if(ie.isEmpty(t))throw re.error("AST statement for SQL select process cannot be empty"),"statement cannot be null";this.statement=t,this.columns={},this.all_table_attributes=r,this.fetch_attributes=[],this.exact_search_values={},this.comparator_search_values={},this.tables=[],this.data={},this.has_aggregator=!1,this.has_ordinal=!1,this.has_outer_join=!1,this._getColumns(),this._getTables(),this._conditionsToFetchAttributeValues(),this._setAliasesForColumns(),ie.backtickASTSchemaItems(this.statement)}async search(){let t;try{let s=await this._checkEmptySQL();if(!ie.isEmptyOrZeroLength(s))return re.trace("No results returned from checkEmptySQL SQLSearch method."),s}catch(s){throw re.error("Error thrown from checkEmptySQL in SQLSearch class method search."),re.error(s),new Error(hs)}try{let s=await this._getFetchAttributeValues();if(s)return s}catch(s){throw re.error("Error thrown from getFetchAttributeValues in SQLSearch class method search."),re.error(s),new Error(hs)}if(Object.keys(this.data).length===0)return re.trace('SQLSearch class field: "data" is empty.'),[];let r;try{r=await this._processJoins()}catch(s){throw re.error("Error thrown from processJoins in SQLSearch class method search."),re.error(s),new Error(hs)}try{await this._getFinalAttributeData(r.existing_attributes,r.joined_length)}catch(s){throw re.error("Error thrown from getFinalAttributeData in SQLSearch class method search."),re.error(s),new Error(hs)}try{return t=await this._finalSQL(),t}catch(s){throw re.error("Error thrown from finalSQL in SQLSearch class method search."),re.error(s),new Error(hs)}}_getColumns(){let t=new O_(this.statement);for(let{node:r,path:s}of t)r&&r.columnid&&(this.columns[s[0]]||(this.columns[s[0]]=[]),this.columns[s[0]].push(Dw(r)))}_getTables(){let t=[];this.all_table_attributes.forEach(r=>{t.push(r.table)}),this.tables=Ac.uniqBy(t,r=>[r.databaseid,r.tableid,r.as].join()),this.tables.forEach(r=>{let s=`${r.databaseid}_${r.as?r.as:r.tableid}`;this.data[s]={},this.data[s].__hash_name=Uw()[r.databaseid][r.tableid].primaryKey,this.data[s].__merged_data={},this.data[s].__merged_attributes=[],this.data[s].__merged_attr_map={}})}_conditionsToFetchAttributeValues(){if(ie.isEmpty(this.statement.where)){re.trace('AST "where" statement is empty.');return}let t=!1;for(let{node:r}of new O_(this.statement.where))if(r&&r.op&&r.op==="OR"&&(t=!0),!ie.isEmpty(r)&&r.right)if(ie.isNotEmptyAndHasValue(r.right.value)){let s=ie.autoCast(r.right.value);[!0,!1].indexOf(s)>=0?r.right=new It.yy.LogicValue({value:s}):r.right instanceof It.yy.StringValue&&!ie.isEmpty(s)&&ie.autoCasterIsNumberCheck(s.toString())&&(r.right=new It.yy.NumValue({value:s}))}else Array.isArray(r.right)&&r.right.forEach((s,n)=>{let i=ie.autoCast(s.value);[!0,!1].indexOf(i)>=0?r.right[n]=new It.yy.LogicValue({value:i}):s instanceof It.yy.StringValue&&ie.autoCasterIsNumberCheck(i.toString())&&(r.right[n]=new It.yy.NumValue({value:i}))});if(t){re.trace('Where clause contains "OR", exact match search not performed on attributes.');return}for(let{node:r}of new O_(this.statement.where))if(r&&r.left&&r.right&&(r.left.columnid||r.right.value)&&r.op){let s=new Set,n=r.left.columnid?r.left:r.right,i=this._findColumn(n);if(!i)continue;let o=[i.table.databaseid,i.table.tableid,i.attribute].join("/");if(!ie.isEmpty(kz.VALUE_SEARCH_COMPARATORS_REVERSE_LOOKUP[r.op])){if(ie.isEmpty(this.comparator_search_values[o])&&(this.comparator_search_values[o]={ignore:!1,comparators:[]}),!this.comparator_search_values[o].ignore){if(ie.isEmptyOrZeroLength(r.left.columnid)||ie.isEmptyOrZeroLength(r.right.value)){this.comparator_search_values[o].ignore=!0,this.comparator_search_values[o].comparators=[];continue}this.comparator_search_values[o].comparators.push({attribute:r.left.columnid,operation:r.op,search_value:r.right.value})}continue}if(ie.isEmpty(this.exact_search_values[o])&&(this.exact_search_values[o]={ignore:!1,values:new Set}),!this.exact_search_values[o].ignore){let c=!1;switch(r.op){case"=":!ie.isEmpty(r.right.value)||!ie.isEmpty(r.left.value)?s.add(ie.isEmpty(r.right.value)?r.left.value:r.right.value):c=!0;break;case"IN":let u=Array.isArray(r.right)?r.right:r.left;for(let _=0;_<u.length;_++)if(u[_].value)s.add(u[_].value);else{c=!0;break}break;default:c=!0;break}this.exact_search_values[o].ignore=c,c?this.exact_search_values[o].values=new Set:this.exact_search_values[o].values=new Set([...this.exact_search_values[o].values,...s])}}}_setAliasesForColumns(){if(ie.isEmptyOrZeroLength(this.all_table_attributes)&&ie.isEmptyOrZeroLength(this.statement.from)&&ie.isEmptyOrZeroLength(this.columns.columns))return;let t=[],r={};this.statement.columns.forEach((s,n)=>{if(s.columnid==="*"){t.push(n);return}if(s.aggregatorid&&(this.has_aggregator=!0),!s.aggregatorid&&!s.funcid)if(s.as_orig=s.as?s.as:s.columnid,this.statement.joins)if(r[s.as_orig]>=0){let i=r[s.as_orig]+1;s.as=`[${s.as_orig+i}]`,r[s.as_orig]=i}else s.as=`[${s.as_orig}]`,r[s.as_orig]=0;else s.as=`[${s.as_orig}]`;!s.aggregatorid&&s.funcid&&s.args&&(s.as_orig=s.as?s.as:s.toString().replace(/'/g,'"'),s.as=`[${s.as_orig}]`),s.aggregatorid&&s.expression.columnid!=="*"&&(s.as_orig=s.as?s.as:s.expression.tableid?`${s.aggregatorid}(${s.expression.tableid}.${s.expression.columnid})`:`${s.aggregatorid}(${s.expression.columnid})`,s.as=`[${s.as_orig}]`)}),this.statement.columns.length>1&&t.length>0&&Ac.pullAt(this.statement.columns,t)}_findColumn(t){let r=this.all_table_attributes.filter(s=>{if(t.columnid_orig&&t.tableid_orig)return(s.table.as===t.tableid_orig||s.table.tableid===t.tableid_orig)&&s.attribute===t.columnid_orig;if(t.tableid)return(s.table.as===t.tableid||s.table.tableid===t.tableid)&&s.attribute===t.columnid;let n=t.columnid_orig?t.columnid_orig:t.columnid;return s.attribute===n});if(ie.isEmptyOrZeroLength(r)){let s=this.columns.columns.filter(n=>n.as?t.columnid===n.as:!1);ie.isEmptyOrZeroLength(s)||(r=this.all_table_attributes.filter(n=>n.attribute===s[0].columnid&&s[0].tableid&&s[0].tableid===(n.table.as?n.table.as:n.table.tableid)))}return r[0]}async _checkEmptySQL(){let t=[];if(ie.isEmptyOrZeroLength(this.all_table_attributes)&&!ie.isEmptyOrZeroLength(this.columns.columns))return t;if(ie.isEmptyOrZeroLength(this.all_table_attributes)&&ie.isEmptyOrZeroLength(this.statement.from))try{let r=this._buildSQL(!1);t=await It.promise(r)}catch(r){throw re.error("Error thrown from AlaSQL in SQLSearch class method checkEmptySQL."),re.error(r),new Error("There was a problem with the SQL statement")}return t}_addFetchColumns(t){t&&t.length>0&&t.forEach(r=>{let s=this._findColumn(r);s&&this.fetch_attributes.push(Dw(s))})}_addColumnToMergedAttributes(t,r){this.data[t].__merged_attributes.push(r),this.data[t].__merged_attr_map[r]=this.data[t].__merged_attributes.length-1}_setMergedHashAttribute(t,r){this.data[t].__merged_data[r].splice(0,1,r)}_updateMergedAttribute(t,r,s,n){let i=this.data[t].__merged_attr_map[s];this.data[t].__merged_data[r].splice(i,1,n)}async _getFetchAttributeValues(){if(ie.isEmptyOrZeroLength(Object.keys(this.columns)))return[];this._addFetchColumns(this.columns.joins);let t=null;try{t=this.statement.where?this.statement.where.toString():""}catch{throw new Error("Could not generate proper where clause")}this.columns.where&&this._addFetchColumns(this.columns.where);let r=this._isSimpleSelect();if(r?this._addFetchColumns(this.columns.columns):(!this.columns.where&&this.fetch_attributes.length===0)|t.indexOf($z)>-1&&this.tables.forEach(n=>{let i={columnid:Uw()[n.databaseid][n.tableid].primaryKey,tableid:n.tableid};this._addFetchColumns([i])}),this.statement.order&&(this._updateOrderByToAliases(),this._addNonAggregatorsToFetchColumns()),this.fetch_attributes=Ac.uniqBy(this.fetch_attributes,n=>[n.table.databaseid,n.table.as?n.table.as:n.table.tableid,n.attribute].join()),r)return await this._simpleSQLQuery();let s=this.fetch_attributes.reduce((n,i)=>{let o=`${i.table.databaseid}_${i.table.as?i.table.as:i.table.tableid}`,c=this.data[o].__hash_name;return n[o]||(n[o]=[],n[o].push(null),this._addColumnToMergedAttributes(o,c)),i.attribute!==c&&(n[o].push(null),this._addColumnToMergedAttributes(o,i.attribute)),n},{});for(let n of this.fetch_attributes){let i=`${n.table.databaseid}_${n.table.as?n.table.as:n.table.tableid}`,o=this.data[i].__hash_name,c={schema:n.table.databaseid,table:n.table.tableid,get_attributes:[n.attribute]},u=!1,_=[n.table.databaseid,n.table.tableid,n.attribute].join("/");if(n.attribute===o&&(u=!0),!ie.isEmpty(this.exact_search_values[_])&&!this.exact_search_values[_].ignore&&!ie.isEmptyOrZeroLength(this.exact_search_values[_].values))if(u)try{c.hash_values=Array.from(this.exact_search_values[_].values);let l=await Co.getDataByHash(c);for(let d of c.hash_values)l.get(d)&&!this.data[i].__merged_data[d]&&(this.data[i].__merged_data[d]=[...s[i]],this._setMergedHashAttribute(i,d))}catch(l){throw re.error("Error thrown from getDataByHash function in SQLSearch class method getFetchAttributeValues exact match."),re.error(l),new Error(hs)}else try{c.search_attribute=n.attribute,await Promise.all(Array.from(this.exact_search_values[_].values).map(async l=>{let d=Object.assign({},c);d.search_value=l;let f=await Co.getDataByValue(d);for(let[E,h]of f)this.data[i].__merged_data[E]?this._updateMergedAttribute(i,E,n.attribute,h[n.attribute]):(this.data[i].__merged_data[E]=[...s[i]],this._updateMergedAttribute(i,E,n.attribute,h[n.attribute]),this._setMergedHashAttribute(i,ie.autoCast(E)))}))}catch(l){throw re.error("Error thrown from getDataByValue function in SQLSearch class method getFetchAttributeValues exact match."),re.error(l),new Error(hs)}else if(!ie.isEmpty(this.comparator_search_values[_])&&!this.comparator_search_values[_].ignore&&!ie.isEmptyOrZeroLength(this.comparator_search_values[_].comparators))try{let l=this.comparator_search_values[_].comparators;for(let d=0,f=l.length;d<f;d++){let E=l[d];c.search_attribute=E.attribute,c.search_value=E.search_value;let h=await Co.getDataByValue(c,E.operation);if(u)for(let[p]of h)this.data[i].__merged_data[p]||(this.data[i].__merged_data[p]=[...s[i]],this._setMergedHashAttribute(i,ie.autoCast(p)));else for(let[p,S]of h)this.data[i].__merged_data[p]?this._updateMergedAttribute(i,p,n.attribute,S[n.attribute]):(this.data[i].__merged_data[p]=[...s[i]],this._updateMergedAttribute(i,p,n.attribute,S[n.attribute]),this._setMergedHashAttribute(i,ie.autoCast(p)))}}catch(l){throw re.error("Error thrown from getDataByValue function in SQLSearch class method getFetchAttributeValues comparator search values."),re.error(l),new Error(hs)}else try{c.search_attribute=n.attribute,c.search_value="*";let l=await Co.getDataByValue(c);if(u)for(let[d]of l)this.data[i].__merged_data[d]||(this.data[i].__merged_data[d]=[...s[i]],this._setMergedHashAttribute(i,ie.autoCast(d)));else for(let[d,f]of l)this.data[i].__merged_data[d]?this._updateMergedAttribute(i,d,n.attribute,f[n.attribute]):(this.data[i].__merged_data[d]=[...s[i]],this._updateMergedAttribute(i,d,n.attribute,f[n.attribute]),this._setMergedHashAttribute(i,ie.autoCast(d)))}catch(l){throw re.error("Error thrown from getDataByValue function in SQLSearch class method getFetchAttributeValues no comparator search values."),re.error(l),new Error(hs)}}}_isSimpleSelect(){let t=!0;return Object.keys(this.statement).length!==2||!this.statement.columns||!this.statement.from||this.statement.from.length!==1?(t=!1,t):(this.statement.columns.forEach(r=>{r instanceof It.yy.Column||(t=!1)}),t)}_updateOrderByToAliases(){this.statement.order.forEach(t=>{if(t.expression.aggregatorid){t.is_aggregator=!0;return}if(t.expression.value){t.is_ordinal=!0,this.has_ordinal=!0;return}else t.is_ordinal=!1;let r=this.statement.columns.filter(n=>{let i=n.aggregatorid?n.expression:n,o=n.aggregatorid?n.as_orig:i.as_orig;return t.expression.tableid?i.columnid_orig===t.expression.columnid_orig&&i.tableid_orig===t.expression.tableid_orig:i.columnid_orig===t.expression.columnid_orig||t.expression.columnid_orig===o});r[0]||r.push(this._findColumn(t.expression));let s=r[0];if(t.is_func=!!s.funcid,t.is_aggregator=!!s.aggregatorid,s.as)if(s.as&&!t.expression.tableid)t.expression.columnid=s.as,t.expression.columnid_orig=s.as_orig;else{let n=new It.yy.Column;n.columnid=s.as,n.columnid_orig=s.as_orig,t.expression=n}else{t.initial_select_column=Object.assign(new It.yy.Column,t.expression),t.initial_select_column.as=`[${t.expression.columnid_orig}]`,t.expression.columnid=t.initial_select_column.as;return}if(!t.is_aggregator){let n=t.is_func?new It.yy.FuncValue:new It.yy.Column;t.initial_select_column=Object.assign(n,s)}})}_addNonAggregatorsToFetchColumns(){let r=this.statement.order.filter(s=>!s.is_aggregator&&!s.is_ordinal).map(s=>s.is_func?{columnid:s.initial_select_column.args.filter(i=>!!i.columnid_orig)[0].columnid_orig}:{columnid:s.expression.columnid_orig});this._addFetchColumns(r)}async _processJoins(){let t=[],r=[],s=this.statement.from[0],n=[s],i=["? "+(s.as?" AS "+s.as:s.tableid)];t.push(Object.values(this.data[`${s.databaseid_orig}_${s.as?s.as_orig:s.tableid_orig}`].__merged_data)),this.statement.joins&&this.statement.joins.forEach(E=>{E.joinmode&&E.joinmode!=="INNER"&&(this.has_outer_join=!0),n.push(E.table);let h=E.joinmode+" JOIN ? AS "+(E.as?E.as:E.table.tableid);E.on&&(h+=" ON "+E.on.toString()),i.push(h),t.push(Object.values(this.data[`${E.table.databaseid_orig}_${E.table.as?E.table.as_orig:E.table.tableid_orig}`].__merged_data))});let o=[],c={};n.forEach(E=>{let h=this.data[`${E.databaseid_orig}_${E.as?E.as_orig:E.tableid_orig}`].__hash_name,p=E.as?E.as_orig:E.tableid_orig;o.push({key:`'${p}.${h}'`,schema:E.databaseid_orig,table:E.as?E.as_orig:E.tableid_orig,keys:new Set}),r.push(`${E.as?E.as:E.tableid}.\`${h}\` AS "${p}.${h}"`),c[E.as?E.as_orig:E.tableid_orig]=this.data[`${E.databaseid_orig}_${E.as?E.as_orig:E.tableid_orig}`].__merged_attributes});let u=this.statement.where?"WHERE "+this.statement.where:"",_="";this.statement.order&&!this.has_ordinal&&!this.has_aggregator&&!this.statement.group&&this.statement.limit&&(_="ORDER BY "+this.statement.order.toString(),this.statement.order.forEach(E=>{E.is_func?r.push(E.initial_select_column.toString()):E.initial_select_column.tableid?r.push(`${E.initial_select_column.tableid}.${E.initial_select_column.columnid} AS ${E.expression.columnid}`):r.push(`${E.initial_select_column.columnid} AS ${E.expression.columnid}`)}));let l="",d="";!this.has_aggregator&&!this.statement.group&&!this.has_ordinal&&(l=this.statement.limit?"LIMIT "+this.statement.limit:"",d=this.statement.offset?"OFFSET "+this.statement.offset:"");let f=[];try{let E=`SELECT ${r.join(", ")} FROM ${i.join(" ")} ${u} ${_} ${l} ${d}`,h=this._convertColumnsToIndexes(E,n);f=await It.promise(h,t),t=null}catch(E){throw re.error("Error thrown from AlaSQL in SQLSearch class method processJoins."),re.error(E),new Error("There was a problem processing the data.")}if(f&&f.length>0){for(let E=0,h=f.length;E<h;E++){let p=f[E];o.forEach(S=>{p[S.key]!==null&&p[S.key]!==void 0&&S.keys.add(p[S.key])})}o.forEach(E=>{let h=Object.keys(this.data[`${E.schema}_${E.table}`].__merged_data),p=Ac.difference(h,[...E.keys].map(S=>S.toString()));for(let S=0,g=p.length;S<g;S++){let b=p[S];delete this.data[`${E.schema}_${E.table}`].__merged_data[b]}})}return{existing_attributes:c,joined_length:f?f.length:0}}async _getFinalAttributeData(t,r){if(r===0)return;let s=[],n=new O_(this.columns);for(let{node:i}of n)if(i&&i.columnid){let o=this._findColumn(i);if(o){let c=o.table.as?o.table.as:o.table.tableid;(!t[c]||t[c].indexOf(o.attribute)<0)&&s.push(o)}}s=Ac.uniqBy(s,i=>[i.table.databaseid,i.table.as?i.table.as:i.table.tableid,i.attribute].join());try{await this._getData(s)}catch(i){throw re.error("Error thrown from getData in SQLSearch class method getFinalAttributeData."),re.error(i),new Error(hs)}}async _getData(t){try{let r=t.reduce((s,n)=>{let i=`${n.table.databaseid}_${n.table.as?n.table.as:n.table.tableid}`;return s[i]?s[i].columns.push(n.attribute):s[i]={schema:n.table.databaseid,table:n.table.tableid,columns:[n.attribute]},s},{});for(let s in r){let n=r[s],i=this.data[s].__merged_data,o=[];for(let l in i)o.push(i[l][0]);this.data[s].__merged_attributes.push(...n.columns);let c={schema:n.schema,table:n.table,hash_values:o,get_attributes:n.columns},u=await Co.getDataByHash(c),_=n.columns.length;for(let l=0,d=o.length;l<d;l++){let f=o[l],E=u.get(f);for(let h=0;h<_;h++){let p=n.columns[h],S=E[p]===void 0?null:E[p];this.data[s].__merged_data[f].push(S)}}}}catch(r){throw re.error("Error thrown from getDataByHash function in SQLSearch class method getData."),re.error(r),r}}async _finalSQL(){let t=[],r=this.statement.from[0];t.push(Object.values(this.data[`${r.databaseid_orig}_${r.as?r.as_orig:r.tableid_orig}`].__merged_data)),r.as=r.as?r.as:r.tableid,r.databaseid="",r.tableid="?",this.statement.joins&&this.statement.joins.forEach(n=>{n.as=n.as?n.as:n.table.tableid,t.push(Object.values(this.data[`${n.table.databaseid_orig}_${n.table.as?n.table.as_orig:n.table.tableid_orig}`].__merged_data)),n.table.databaseid="",n.table.tableid="?"}),this.statement.order&&this.statement.order.forEach(n=>{if(n.is_ordinal)return;this.statement.columns.filter(o=>{let c=o.aggregatorid?o.expression:o,u=o.aggregatorid?o.as_orig:c.as_orig;return n.expression.tableid?c.columnid_orig===n.expression.columnid_orig&&c.tableid_orig===n.expression.tableid_orig:c.columnid_orig===n.expression.columnid_orig||n.expression.columnid_orig===u}).length===0&&(n.expression.columnid=n.initial_select_column.columnid)}),!this.has_aggregator&&!this.statement.group&&!this.has_ordinal&&(this.statement.limit&&delete this.statement.limit,this.statement.offset&&delete this.statement.offset);let s;try{let n=this._buildSQL();re.trace(`Final SQL: ${n}`),s=await It.promise(n,t),this.has_outer_join&&(s=this._translateUndefinedValues(s)),re.trace(`Final AlaSQL results data included ${s.length} rows`)}catch(n){throw re.error("Error thrown from AlaSQL in SQLSearch class method finalSQL."),re.error(n),new Error("There was a problem running the generated sql.")}return s}_translateUndefinedValues(t){try{let r=[];for(let s of t){let n=Object.create(null);Object.keys(s).forEach(i=>{s[i]===void 0?n[i]=null:n[i]=s[i]}),r.push(n)}return r}catch(r){return re.error(Vz.HDB_ERROR_MSGS.OUTER_JOIN_TRANSLATION_ERROR),re.trace(r.stack),t}}_buildSQL(t=!0){let r=this.statement.toString();return this.statement.columns.forEach(s=>{if(s.funcid&&s.as){let n=s.toString().replace(" AS "+s.as,"");r=r.replace(s.toString(),n)}}),t===!0?this._convertColumnsToIndexes(r,this.tables):r}_convertColumnsToIndexes(t,r){let s=t,n={};r.forEach(i=>{i.databaseid_orig?n[`${i.databaseid_orig}_${i.as?i.as_orig:i.tableid_orig}`]=i.as?i.as:i.tableid:n[`${i.databaseid}_${i.as?i.as:i.tableid}`]=`\`${i.as?i.as:i.tableid}\``});for(let i in this.data)this.data[i].__merged_attributes.forEach((o,c)=>{let u=n[i],_=new RegExp(`${u}.\`${o}\``,"g"),l=`${u}.[${c}]`;s=s.replace(_,l)});for(let i in this.data)this.data[i].__merged_attributes.forEach((o,c)=>{let u=new RegExp(`\`${o}\``,"g"),_=`[${c}]`;s=s.replace(u,_)});return s}async _simpleSQLQuery(){let t=this.statement.columns.reduce((s,n)=>(n.as_orig&&n.as_orig!=n.columnid_orig?s[n.columnid_orig]=n.as_orig:s[n.columnid_orig]||(s[n.columnid_orig]=n.columnid_orig),s),{}),r=this.fetch_attributes.reduce((s,n)=>{let i=`${n.table.databaseid}_${n.table.as?n.table.as:n.table.tableid}`;return s[i]||(s[i]={}),s[i][t[n.attribute]]=null,s},{});for(let s of this.fetch_attributes){let n=`${s.table.databaseid}_${s.table.as?s.table.as:s.table.tableid}`,i={schema:s.table.databaseid,table:s.table.tableid,get_attributes:[s.attribute]};try{i.search_attribute=s.attribute,i.search_value="*";let o=await Co.getDataByValue(i);for(let[c,u]of o)this.data[n].__merged_data[c]||(u[s.attribute]===void 0&&(u[s.attribute]=null),this.data[n].__merged_data[c]=Object.assign({},r[n])),this.data[n].__merged_data[c][t[s.attribute]]=u[s.attribute]??null}catch(o){throw re.error("There was an error when processing this SQL operation.  Check your logs"),re.error(o),new Error(hs)}}return Object.values(Object.values(this.data)[0].__merged_data)}};Mw.exports=cp});var Fr=T((_ue,vw)=>{"use strict";var Yz=aO();vw.exports={searchByConditions:Wz,searchByHash:Qz,searchByValue:zz,search:Jz};var up=as(),{transformReq:lp}=$(),Kz=Pw();async function Wz(e){return lp(e),up.searchByConditions(e)}a(Wz,"searchByConditions");async function Qz(e){lp(e),e.ids&&(e.hash_values=e.ids);let t=[];for await(let r of up.searchByHash(e))r&&t.push(r);return t}a(Qz,"searchByHash");async function zz(e){lp(e),e.hasOwnProperty("desc")===!0&&(e.reverse=e.desc);let t=[];for await(let r of up.searchByValue(e))t.push(r);return t}a(zz,"searchByValue");function Jz(e,t){try{let r=new Yz(e);r.validate(),new Kz(r.statement,r.attributes).search().then(n=>{t(null,n)}).catch(n=>{t(n,null)})}catch(r){return t(r)}}a(Jz,"search")});var N_=T((fue,Bw)=>{"use strict";var Xz=as();Bw.exports={writeTransaction:jz};function jz(e,t,r){return Xz.writeTransaction(e,t,r)}a(jz,"writeTransaction")});var Gw=T((mue,Fw)=>{"use strict";var Zz=Fr(),e2=qn(),Hw=G(),t2=Gr(),hue=N_(),r2=require("clone"),dp=require("alasql"),s2=A_(),qw=require("util"),n2=qw.promisify(e2.getTableSchema),i2=qw.promisify(Zz.search),o2=y(),_p=$();s2(dp);Fw.exports={update:c2};var a2="There was a problem performing this update. Please check the logs and try again.";async function c2({statement:e,hdb_user:t}){let r=await n2(e.table.databaseid,e.table.tableid),s=u2(e.columns);_p.backtickASTSchemaItems(e);let{table:n,where:i}=e,o=r2(n),c=_p.isEmpty(i)?"":` WHERE ${i.toString()}`,u=`SELECT ${r.hash_attribute} FROM ${n.toString()} ${c}`,_=dp.parse(u).statements[0],l=await i2(_),d=l2(s,l);return _2(o,d,t)}a(c2,"update");function u2(e){try{let t={};return e.forEach(r=>{"value"in r.expression?t[r.column.columnid]=r.expression.value??null:t[r.column.columnid]=dp.compile(`SELECT ${r.expression.toString()} AS [${o2.FUNC_VAL}] FROM ?`)}),t}catch(t){throw Hw.error(t),new Error(a2)}}a(u2,"createUpdateRecord");function l2(e,t){return _p.isEmptyOrZeroLength(t)?[]:t.map(r=>Object.assign(r,e))}a(l2,"buildUpdateRecords");async function _2(e,t,r){let s={operation:"update",schema:e.databaseid_orig,table:e.tableid_orig,records:t,hdb_user:r},n=await t2.update(s);try{delete n.new_attributes,delete n.txn_time}catch(i){Hw.error(`Error delete new_attributes from update response: ${i}`)}return n}a(_2,"updateRecords")});var kw=T((gue,xw)=>{var d2=require("alasql"),f2=Fr(),E2=G(),h2=as(),Ep=require("util"),fp=$(),m2=y(),p2=qn(),Sue=N_(),Tue=Gr(),S2="record",T2="successfully deleted",g2=Ep.callbackify(N2),R2=Ep.promisify(f2.search),A2=Ep.promisify(p2.getTableSchema);xw.exports={convertDelete:g2};function O2(e){return`${e.deleted_hashes.length} ${S2}${e.deleted_hashes.length===1?"":"s"} ${T2}`}a(O2,"generateReturnMessage");async function N2({statement:e,hdb_user:t}){let r=await A2(e.table.databaseid,e.table.tableid);fp.backtickASTSchemaItems(e);let{table:s,where:n}=e,i=fp.isEmpty(n)?"":` WHERE  ${n.toString()}`,o=`SELECT ${r.hash_attribute} FROM ${s.toString()} ${i}`,c=d2.parse(o).statements[0],u={operation:m2.OPERATIONS_ENUM.DELETE,schema:s.databaseid_orig,table:s.tableid_orig,hdb_user:t};try{u.records=await R2(c);let _=await h2.deleteRecords(u);return fp.isEmptyOrZeroLength(_.message)&&(_.message=O2(_)),delete _.txn_time,_}catch(_){throw E2.error(_),_.hdb_code?_.message:_}}a(N2,"convertDelete")});var Ww=T((Aue,Kw)=>{"use strict";var b2=gi(),{hdb_errors:Vw}=j(),{getDatabases:$w}=(Ee(),Z(Ce));Kw.exports={checkSchemaExists:Yw,checkSchemaTableExists:y2,schema_describe:b2};async function Yw(e){if(!$w()[e])return Vw.HDB_ERROR_MSGS.SCHEMA_NOT_FOUND(e)}a(Yw,"checkSchemaExists");async function y2(e,t){let r=await Yw(e);if(r)return r;if(!$w()[e][t])return Vw.HDB_ERROR_MSGS.TABLE_NOT_FOUND(e,t)}a(y2,"checkSchemaTableExists")});var Oc=T((Nue,I2)=>{I2.exports={name:"harperdb",version:"4.2.0",description:"HarperDB is a distributed SQL & NoSQL data platform focused on speed, flexibility, and ease of use.",keywords:["database","sql","nosql","api","distributed","cloud","enterprise","Fastify","NATS"],main:"harperdb.js",bin:{harperdb:"./bin/harperdb.js"},engines:{"minimum-node":"16.0.0","go-lang":"1.21.3","nats-server":"2.10.3"},exports:{".":"./index.js"},homepage:"https://www.harperdb.io/",bugs:"support@harperdb.io",author:{name:"HarperDB",email:"support@harperdb.io"},license:"SEE LICENSE IN LICENSE",scripts:{submodules:"git submodule update --init --recursive",build:"eslint -c ./.eslintbuild bin/ dataLayer/ security/ server/ sqlTranslator/ upgrade/ utility/ validation/",pretty:"eslint --fix bin/ dataLayer/ security/ server/ sqlTranslator/ upgrade/ utility/ validation/","cover:test":"pm2 kill && rimraf ./.nyc_output/* && node utility/devops/register.js --reset_license && nyc --no-clean --reporter=lcovonly npm run test:apitests && nyc --no-clean --reporter=lcovonly npm run test:logging && nyc --no-clean --reporter=lcovonly npm run test:upgrade && nyc --no-clean --reporter=lcovonly npm run test:nats && nyc --no-clean --reporter=lcovonly npm run test:cfserver && nyc --no-clean --reporter=lcovonly npm run test:hdbserver && nyc --no-clean --reporter=lcovonly npm run test:main && nyc merge .nyc_output coverage.json && node ./utility/devops/register.js --reset_license",test:"pm2 kill && rimraf ./.nyc_output/* && node utility/devops/register.js --reset_license && npm run test:apitests && npm run test:logging && npm run test:upgrade && npm run test:nats && npm run test:cfserver && npm run test:hdbserver && npm run test:main && nyc merge .nyc_output coverage.json && node ./utility/devops/register.js --reset_license","test:main":"cd bin/ && ../node_modules/mocha/bin/_mocha '../unitTests/**/*.js' --config '../unitTests/.mocharc-main.json'","test:lmdbbridge":"cd bin/ && ../node_modules/mocha/bin/_mocha '../unitTests/dataLayer/harperBridge/lmdbBridge/**/*.js' --config '../unitTests/.mocharc.json'","test:lmdbutility":"cd bin/ && ../node_modules/mocha/bin/_mocha '../unitTests/utility/lmdb/**/*.js' --config '../unitTests/.mocharc.json'","test:hdbserver":"cd bin/ && ../node_modules/mocha/bin/_mocha '../unitTests/server/harperdb/hdbServer-test.js' --config '../unitTests/.mocharc.json'","test:cfserver":"npm run submodules && cd bin/ && ../node_modules/mocha/bin/_mocha '../unitTests/server/fastifyRoutes/customFunctionsServer-test.js' --config '../unitTests/.mocharc.json'","test:nats":"cd bin/ && ../node_modules/mocha/bin/_mocha '../unitTests/server/nats/**/*.js' --config '../unitTests/.mocharc.json'","test:upgrade":"cd bin/ && ../node_modules/mocha/bin/_mocha '../unitTests/upgrade/**/*.js' --config '../unitTests/.mocharc.json'","test:apitests":"pm2 kill && cd bin/ && ../node_modules/mocha/bin/_mocha '../unitTests/apiTests/**/*-test.mjs' --config '../unitTests/.mocharc.json'","test:logging":"cd bin/ && ../node_modules/mocha/bin/_mocha '../unitTests/utility/logging/*.js' --config '../unitTests/.mocharc.json'","test:ci":" cd bin/ && ../node_modules/mocha/bin/_mocha '../unitTests/**/*.js' --retries 3 --config '../unitTests/.mocharc-main.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/dataLayer/harperBridge/lmdbBridge/**/*.js' --parallel --retries 3 --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/utility/lmdb/**/*.js' --parallel --retries 3 --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/server/harperdb/hdbServer-test.js' --parallel --retries 3 --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/server/customFunctions/customFunctionsServer-test.js' --parallel --retries 3 --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/upgrade/**/*.js' --parallel --retries 3 --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/server/nats/**/*.js' --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter","hdb-check":"./utility/devops/hdb-check.sh","download-prebuilds":"node ./utility/devops/build/download-prebuilds.js",prebuild:"date",postinstall:"node ./launchServiceScripts/launchInstallNATSServer.js",build_nats_dependency:"node ./utility/devops/nats/builder.js",coverage:"nyc --reporter=lcov npm test"},dependencies:{"@aws-sdk/abort-controller":"3.374.0","@aws-sdk/client-s3":"3.425.0","@aws-sdk/lib-storage":"3.418.0","@endo/static-module-record":"^0.8.1","@fastify/autoload":"~5.7.1","@fastify/compress":"~6.4.0","@fastify/cors":"~8.4.0","@fastify/static":"~6.11.0","@turf/area":"6.5.0","@turf/boolean-contains":"6.5.0","@turf/boolean-disjoint":"6.5.0","@turf/boolean-equal":"6.5.0","@turf/circle":"6.5.0","@turf/difference":"6.5.0","@turf/distance":"6.5.0","@turf/helpers":"6.5.0","@turf/length":"6.5.0",alasql:"1.7.4","cbor-x":"1.5.4",chalk:"4.1.2","cli-progress":"3.12.0",clone:"2.1.2","fast-glob":"3.3.1",fastify:"~4.23.2","fastify-plugin":"~4.5.0","fs-extra":"11.1.1",graphql:"^16.8.0","human-readable-ids":"1.0.4",inquirer:"8.2.6","is-number":"7.0.0",joi:"17.11.0",json2csv:"5.0.7",jsonata:"1.8.6",jsonwebtoken:"9.0.2",lmdb:"2.9.0-beta.2",lodash:"4.17.21",mathjs:"11.11.1",minimist:"1.2.8",mkcert:"1.5.1",moment:"2.29.4","mqtt-packet":"~8.2.0",msgpackr:"1.9.9",nats:"2.17.0",needle:"3.2.0","node-stream-zip":"1.15.0","node-unix-socket":"^0.2.5","normalize-path":"^3.0.0",ora:"5.4.1","ordered-binary":"1.4.1",papaparse:"5.4.1",passport:"0.6.0","passport-http":"0.3.0","passport-local":"1.0.0",pino:"8.15.6",pm2:"5.3.0",prompt:"1.3.0","properties-reader":"2.3.0","recursive-iterator":"3.3.0",semver:"7.5.4",send:"^0.18.0",ses:"^0.18.1","stream-chain":"2.2.5","stream-json":"1.8.0",systeminformation:"5.21.10","tar-fs":"2.1.1",ulidx:"0.5.0",uuid:"9.0.1","validate.js":"0.13.1",ws:"^8.14.1",yaml:"2.3.2"},devDependencies:{"@tsconfig/node16":"^1.0.3","@types/node":"latest","@typescript-eslint/eslint-plugin":"^5.55.0","@typescript-eslint/parser":"^5.55.0",axios:"0.27.2",chai:"4.3.7","chai-integer":"0.1.0",esbuild:"^0.19.1",eslint:"8.22.0","eslint-config-prettier":"8.3.0","eslint-plugin-prettier":"3.4.1","eslint-plugin-radar":"0.2.1",eventsource:"^2.0.2","hook-std":"3.0.0","intercept-stdout":"0.1.2",mocha:"^10.2.0","mocha-teamcity-reporter":"3.0.0","mock-require":"3.0.3","mock-stdin":"1.0.0",mqtt:"~4.3.7",newman:"5.3.2","newman-reporter-html":"1.0.5","newman-reporter-htmlextra":"^1.22.11","newman-reporter-teamcity":"^0.1.12","node-fetch":"2.6.7",nyc:"15.1.0",prettier:"2.8.4",rewire:"5.0.0",rimraf:"3.0.2",sinon:"10.0.0","sinon-chai":"3.7.0","source-map-support":"^0.5.21",typescript:"^5.2.2","why-is-node-still-running":"^1.0.0"},overrides:{"eslint-plugin-radar":{eslint:"8.22.0"},"newman-reporter-html":{newman:"5.3.2"},alasql:{xlsx:"0.18.5"}},optionalDependencies:{bufferutil:"^4.0.7","utf-8-validate":"^5.0.10"}}});var Ic={};qe(Ic,{addAnalyticsListener:()=>yc,recordAction:()=>br,recordActionBinary:()=>kr,setAnalyticsEnabled:()=>w2});function w2(e){sC=e}function br(e,t,r,s,n){if(!sC)return;let i=t+(r?"-"+r:"");s!==void 0&&(i+="-"+s),n!==void 0&&(i+="-"+n);let o=I_.get(i);if(o)if(typeof e=="number"){let c=o.values,u=c.index++;if(u>=c.length){let _=c;o.values=c=new Float32Array(u*2),c.set(_),c.index=u+1}c[u]=e,o.total+=e}else if(typeof e=="boolean")e&&o.total++,o.count++;else if(typeof e=="function")o.count++;else throw new TypeError("Invalid metric value type "+typeof e);else{if(typeof e=="number")o={total:e,values:new Float32Array(4)},o.values.index=1,o.values[0]=e,o.total=e;else if(typeof e=="boolean")o={},o.total=e?1:0,o.count=1;else if(typeof e=="function")o={},o.count=1,o.callback=e;else throw new TypeError("Invalid metric value type "+typeof e);o.description={metric:t,path:r,method:s,type:n},I_.set(i,o)}b_||C2()}function kr(e,t,r,s,n){br(!!e,t,r,s,n)}function yc(e){oC.push(e)}function C2(){b_=performance.now(),setTimeout(async()=>{let e=performance.now()-b_;b_=0;let t=[],r={time:Date.now(),period:e,threadId:Mi.threadId,metrics:t};for(let[n,i]of I_){if(i.values){let o=i.values.subarray(0,i.values.index);o.sort();let c=o.length,u=0,_=[],l;for(let d of aC){let f=Math.floor(c*d),E=o[f-1];if(f>u){let h=f-u;if(E===l){let p=_[_.length-1];typeof p=="number"?_[_.length-1]={value:p,count:1+h}:p.count+=h}else _.push(h>1?{value:E,count:h}:E),l=E;u=f}}t.push(Object.assign(i.description,{mean:i.total/c,distribution:_,count:c}))}else i.callback?t.push(Object.assign(i.description,i.callback(i))):t.push(Object.assign(i.description,{total:i.total,count:i.count}));await cC()}let s=process.memoryUsage();t.push({metric:"memory",threadId:Mi.threadId,byThread:!0,...s});for(let n of oC)n(t);I_=new Map,Mi.parentPort?Mi.parentPort.postMessage({type:iC,report:r}):_C({report:r})},nC).unref()}async function L2(e,t=6e4){let r=pp(),s=uC(),n;for(let h of s.primaryStore.getRange({start:1/0,end:!1,reverse:!0}))if(h.value?.time){n=h.value.time;break}if(Date.now()-t<n)return;let i,o=new Map,c=new Map,u=[],_;for(let{key:h,value:p}of r.primaryStore.getRange({start:n||!1,exclusiveStart:!0,end:1/0})){if(!p)continue;if(i){if(h>i+t)break}else i=h;_=h;let{metrics:S,threadId:g}=p;for(let b of S||[]){let{path:O,method:Y,type:Q,metric:F,count:w,total:K,distribution:B,threads:x,...te}=b;w||(w=1);let be=F+(O?"-"+O:"");Y!==void 0&&(be+="-"+Y),Q!==void 0&&(be+="-"+Q);let se=o.get(be);if(se){if(se.threads){let Pe=se.threads[g];if(Pe)se=Pe;else{se.threads[g]=Object.assign({},te);continue}}se.count||(se.count=1);let vt=se.count;for(let Pe in te){let At=te[Pe];typeof At=="number"&&(se[Pe]=(se[Pe]*vt+At*w)/(vt+w))}se.count+=w,K>=0&&(se.total+=K,se.ratio=se.total/se.count)}else se=Object.assign({period:t},b),delete se.distribution,o.set(be,se),se.byThread&&(se.threads=[],se.threads[g]=Object.assign({},te),u.push(se));if(B){B=B.map(Pe=>typeof Pe=="number"?{value:Pe,count:1}:Pe);let vt=c.get(be);vt?vt.push(...B):c.set(be,B)}}await cC()}for(let h of u){let{path:p,method:S,type:g,metric:b,count:O,total:Y,distribution:Q,threads:F,...w}=h;F=F.filter(K=>K);for(let K in w){if(typeof h[K]!="number")continue;let B=0;for(let x of F){let te=x[K];typeof te=="number"&&(B+=te)}h[K]=B}h.count=F.length,delete h.threads,delete h.byThread}for(let[h,p]of c){let S=o.get(h);p.sort((Pe,At)=>Pe.value>At.value?1:-1);let g=S.count-1,b=[],O=0,Y=0,Q;for(let Pe of aC){let At=g*Pe;for(;O<At;)Q=p[Y++],O+=Q.count,Y===1&&O--;let es=p[Y>1?Y-2:0];Q||(Q=p[0]),b.push(Q.value-(Q.value-es.value)*(O-At)/Q.count)}let[F,w,K,B,x,te,be,se,vt]=b;Object.assign(S,{p1:F,p10:w,p25:K,median:B,p75:x,p90:te,p95:be,p99:se,p999:vt})}let l;for(let[h,p]of o)p.id=(0,y_.getNextMonotonicTime)(),p.time=_,s.primaryStore.put(p.id,p,{append:!0}).then(S=>{S||s.primaryStore.put(p.id,p)}),l=!0;let d=Date.now(),{idle:f,active:E}=performance.eventLoopUtilization();if(l||E*10>f){let h=(0,y_.getNextMonotonicTime)(),p={id:h,metric:"main-thread-utilization",idle:f-Qw,active:E-zw,time:d,...process.memoryUsage()};s.primaryStore.put(h,p,{append:!0}).then(S=>{S||s.primaryStore.put(h,p)})}Qw=f,zw=E}async function Jw(e,t){let r=Date.now()-t;for(let s of e.primaryStore.getKeys({start:!1,end:r}))e.primaryStore.remove(s)}function pp(){return Xw||(Xw=et({table:"hdb_raw_analytics",database:"system",audit:!1,trackDeletes:!1,attributes:[{name:"id",isPrimaryKey:!0},{name:"action"},{name:"metrics"}]}))}function uC(){return jw||(jw=et({table:"hdb_analytics",database:"system",audit:!1,trackDeletes:!1,attributes:[{name:"id",isPrimaryKey:!0},{name:"metric"},{name:"path"},{name:"method"},{name:"type"}]}))}function M2(){lC=!0;let e=(0,bc.get)(mp.CONFIG_PARAMS.ANALYTICS_AGGREGATEPERIOD)*1e3;e&&setInterval(async()=>{await L2(nC,e),await Jw(pp(),D2),await Jw(uC(),U2)},Math.min(e/2,2147483647)).unref()}function _C(e,t){let r=e.report;r.threadId=t?.threadId||Mi.threadId;for(let s of r.metrics)s.metric==="bytes-sent"&&(Zw+=s.mean*s.count);r.totalBytesProcessed=Zw,t&&(r.metrics.push({metric:"utilization",...t.performance.eventLoopUtilization(eC.get(t))}),eC.set(t,t.performance.eventLoopUtilization())),r.id=(0,y_.getNextMonotonicTime)(),pp().primaryStore.put(r.id,r),lC||M2(),P2&&(dC=B2(r))}async function B2(e){if(await dC,!Yn){let r=(0,Nc.dirname)((0,rC.getLogFilePath)());try{Yn=await(0,hp.open)((0,Nc.join)(r,"analytics.log"),"r+")}catch{Yn=await(0,hp.open)((0,Nc.join)(r,"analytics.log"),"w+")}}let t=(await Yn.stat()).size;if(t>v2){let r=Buffer.alloc(t);await Yn.read(r,{position:0}),r=r.subarray(r.indexOf(10,r.length/2)+1),await Yn.write(r,{position:0}),await Yn.truncate(r.length),t=r.length}await Yn.write(JSON.stringify(e)+`
`,t)}var Mi,tC,rC,Nc,hp,y_,bc,mp,I_,sC,b_,nC,iC,oC,aC,Qw,zw,cC,D2,U2,Xw,jw,lC,Zw,eC,P2,dC,Yn,v2,ln=Te(()=>{Mi=require("worker_threads"),tC=M(Je());Ee();rC=M(G()),Nc=require("path"),hp=require("fs/promises"),y_=M(Er()),bc=M(X()),mp=M(y());hr();(0,bc.initSync)();I_=new Map,sC=(0,bc.get)(mp.CONFIG_PARAMS.ANALYTICS_AGGREGATEPERIOD)>-1;a(w2,"setAnalyticsEnabled");a(br,"recordAction");ut.recordAnalytics=br;a(kr,"recordActionBinary");b_=0,nC=1e3,iC="analytics-report",oC=[];a(yc,"addAnalyticsListener");aC=[.01,.1,.25,.5,.75,.9,.95,.99,.999,1];a(C2,"sendAnalytics");a(L2,"aggregation");Qw=0,zw=0,cC=a(()=>new Promise(setImmediate),"rest");a(Jw,"cleanup");D2=36e5,U2=31536e6;a(pp,"getRawAnalyticsTable");a(uC,"getAnalyticsTable");(0,tC.setChildListenerByType)(iC,_C);a(M2,"startScheduledTasks");Zw=0,eC=new Map,P2=!1;a(_C,"recordAnalytics");v2=1e6;a(B2,"logAnalytics")});var _t=T((que,DC)=>{"use strict";var wt=X();wt.initSync();var H2=require("fs-extra"),q2=require("semver"),Lc=require("path"),{monotonicFactory:F2}=require("ulidx"),EC=F2(),G2=require("util"),hC=require("child_process"),x2=G2.promisify(hC.exec),k2=hC.spawn,Re=Ve(),Oe=y(),Rp=$(),Vr=G(),w_=sn(),V2=N_(),wc=gr(),{onMessageByType:$2}=Je(),{isMainThread:Y2}=require("worker_threads"),{Encoder:K2,decode:Ap}=require("msgpackr"),mC=new K2,{isEmpty:Pi}=Rp,pC=xr(),W2=48*36e11,Q2=5e9;Y2&&$2(Oe.ITC_EVENT_TYPES.RESTART,()=>{ms=void 0,Uo=void 0});var{connect:z2,StorageType:SC,RetentionPolicy:TC,AckPolicy:C_,DeliverPolicy:L_,DiscardPolicy:J2,NatsConnection:Pue,JetStreamManager:vue,JetStreamClient:Bue,StringCodec:Hue,JSONCodec:X2,createInbox:Op,headers:j2,ErrorCode:fC}=require("nats"),{PACKAGE_ROOT:Z2}=y(),eJ=Oc(),{recordAction:tJ}=(ln(),Z(Ic)),gC=X2(),rJ="clustering",sJ=eJ.engines[Re.NATS_SERVER_NAME],nJ=Lc.join(Z2,"dependencies"),gp=Lc.join(nJ,`${process.platform}-${process.arch}`,Re.NATS_BINARY_NAME),Sp,Tp,Cc,Lo,Do;DC.exports={runCommand:RC,checkNATSServerInstalled:iJ,createConnection:Np,getConnection:D_,getJetStreamManager:Dc,getJetStream:AC,getNATSReferences:jt,getServerList:aJ,createLocalStream:bp,listStreams:OC,deleteLocalStream:cJ,getServerConfig:Uc,listRemoteStreams:uJ,viewStream:lJ,viewStreamIterator:_J,publishToStream:dJ,createWorkQueueStream:fJ,addSourceToWorkStream:bC,request:hJ,removeSourceFromWorkStream:IC,reloadNATS:yp,reloadNATSHub:mJ,reloadNATSLeaf:pJ,extractServerName:yC,requestErrorHandler:SJ,updateWorkStream:TJ,createLocalTableStream:CC,createTableStreams:gJ,purgeTableStream:LC,purgeSchemaTableStreams:RJ,getStreamInfo:AJ,updateLocalStreams:NJ,closeConnection:oJ,getJsmServerName:Mc,addNatsMsgHeader:NC,updateIngestStreamConsumer:EJ};async function RC(e,t=void 0){let{stdout:r,stderr:s}=await x2(e,{cwd:t});if(s)throw new Error(s.replace(`
`,""));return r.replace(`
`,"")}a(RC,"runCommand");async function iJ(){try{await H2.access(gp)}catch{return!1}let e=await RC(`${gp} --version`,void 0),t=e.substring(e.lastIndexOf("v")+1,e.length);return q2.eq(t,sJ)}a(iJ,"checkNATSServerInstalled");async function Np(e,t,r,s=!0,n="127.0.0.1"){if(!t&&!r){let o=await pC.getClusterUser();if(Pi(o))throw new Error("Unable to get nats connection. Cluster user is undefined.");t=o.username,r=o.decrypt_hash}Vr.trace("create nats connection called");let i=await z2({name:n,port:e,user:t,pass:r,maxReconnectAttempts:-1,waitOnFirstConnect:s,timeout:2e5,tls:{keyFile:wt.get(Oe.CONFIG_PARAMS.CLUSTERING_TLS_PRIVATEKEY),certFile:wt.get(Oe.CONFIG_PARAMS.CLUSTERING_TLS_CERTIFICATE),caFile:wt.get(Oe.CONFIG_PARAMS.CLUSTERING_TLS_CERT_AUTH),rejectUnauthorized:!1}});return Vr.trace("create connection established a nats client connection with id",i?.info?.client_id),i}a(Np,"createConnection");async function oJ(){ms&&(await ms.drain(),ms=void 0,Lo=void 0,Do=void 0,Uo=void 0)}a(oJ,"closeConnection");var ms,Uo;async function D_(){return Uo||(Uo=Np(wt.get(Oe.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_NETWORK_PORT),void 0,void 0),ms=await Uo),ms||Uo}a(D_,"getConnection");async function Dc(){if(Lo)return Lo;Pi(ms)&&await D_();let{domain:e}=Uc(Oe.PROCESS_DESCRIPTORS.CLUSTERING_LEAF);if(Pi(e))throw new Error("Error getting JetStream domain. Unable to get JetStream manager.");return Lo=await ms.jetstreamManager({domain:e}),Lo}a(Dc,"getJetStreamManager");async function AC(){if(Do)return Do;Pi(ms)&&await D_();let{domain:e}=Uc(Oe.PROCESS_DESCRIPTORS.CLUSTERING_LEAF);if(Pi(e))throw new Error("Error getting JetStream domain. Unable to get JetStream manager.");return Do=ms.jetstream({domain:e}),Do}a(AC,"getJetStream");async function jt(){let e=ms||await D_(),t=Lo||await Dc(),r=Do||await AC();return{connection:e,jsm:t,js:r}}a(jt,"getNATSReferences");async function aJ(e){let t=wt.get(Oe.CONFIG_PARAMS.CLUSTERING_HUBSERVER_NETWORK_PORT),{sys_name:r,decrypt_hash:s}=await pC.getClusterUser(),n=await Np(t,r,s),i=Op(),o=n.subscribe(i),c=[],u,_=(async()=>{for await(let l of o){let d=gC.decode(l.data);d.response_time=Date.now()-u,c.push(d)}})();return u=Date.now(),await n.publish("$SYS.REQ.SERVER.PING.VARZ",void 0,{reply:i}),await n.publish("$SYS.REQ.SERVER.PING",void 0,{reply:i}),await n.flush(),await Rp.async_set_timeout(e),await o.drain(),await n.close(),await _,c}a(aJ,"getServerList");async function bp(e,t){let{jsm:r}=await jt(),s=wt.get(Oe.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_STREAMS_MAXAGE);s=s===null?0:s*1e9;let n=wt.get(Oe.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_STREAMS_MAXMSGS);n=n===null?-1:n;let i=wt.get(Oe.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_STREAMS_MAXBYTES);i=i===null?-1:i,await r.streams.add({name:e,storage:SC.File,retention:TC.Limits,subjects:t,discard:J2.Old,max_msgs:n,max_bytes:i,max_age:s})}a(bp,"createLocalStream");async function OC(){let{jsm:e}=await jt(),t=await e.streams.list().next(),r=[];return t.forEach(s=>{r.push(s)}),r}a(OC,"listStreams");async function cJ(e){let{jsm:t}=await jt();await t.streams.delete(e)}a(cJ,"deleteLocalStream");async function uJ(e){let{connection:t}=await jt(),r=[],s=Op(),n=t.subscribe(s),i=(async()=>{for await(let o of n)r.push(gC.decode(o.data))})();return await t.publish(`$JS.${e}.API.STREAM.LIST`,void 0,{reply:s}),await t.flush(),await n.drain(),await i,r}a(uJ,"listRemoteStreams");async function lJ(e,t=void 0,r=void 0){let{jsm:s,js:n}=await jt(),i=EC(),o={durable_name:i,ack_policy:C_.Explicit};t&&(o.deliver_policy=L_.StartTime,o.opt_start_time=new Date(t).toISOString()),await s.consumers.add(e,o);let c=await n.consumers.get(e,i),u=r?await c.fetch({max_messages:r,expires:2e3}):await c.consume();if(c._info.num_pending===0)return[];let _=[];for await(let l of u){let d=Ap(l.data),f={nats_timestamp:l.info.timestampNanos,nats_sequence:l.info.streamSequence,entry:d};if(l.headers&&(f.origin=l.headers.get(Re.MSG_HEADERS.ORIGIN)),_.push(f),l.ack(),l.info.pending===0)break}return await c.delete(),_}a(lJ,"viewStream");async function*_J(e,t=void 0,r=void 0){let{jsm:s,js:n}=await jt(),i=EC(),o={durable_name:i,ack_policy:C_.Explicit};t&&(o.deliver_policy=L_.StartTime,o.opt_start_time=new Date(t).toISOString()),await s.consumers.add(e,o);let c=await n.consumers.get(e,i),u=r?await c.fetch({max_messages:r,expires:2e3}):await c.consume();if(c._info.num_pending===0)return[];for await(let _ of u){let l=Ap(_.data);l[0]||(l=[l]);for(let d of l){let f={nats_timestamp:_.info.timestampNanos,nats_sequence:_.info.streamSequence,entry:d};_.headers&&(f.origin=_.headers.get(Re.MSG_HEADERS.ORIGIN)),yield f}if(_.ack(),_.info.pending===0)break}await c.delete()}a(_J,"viewStreamIterator");async function dJ(e,t,r,s){Vr.trace(`publishToStream called with subject: ${e}, stream: ${t}, entries:`,s.operation),r=NC(s,r);let{js:n}=await jt(),i=await Mc(),o=`${e}.${i}`,c=s instanceof Uint8Array?s:mC.encode(s);try{Vr.trace(`publishToStream publishing to subject: ${o}`),tJ(c.length,"bytes-sent",e,s.operation,"replication"),await n.publish(o,c,{headers:r})}catch(u){if(u.code&&u.code.toString()==="503")return wC(async()=>{try{await n.publish(o,c,{headers:r})}catch{if(u.code&&u.code.toString()==="503"){Vr.trace(`publishToStream creating stream: ${t}`);let l=o.split(".");l[2]="*",await bp(t,[o]),await n.publish(o,c,{headers:r})}else throw u}});throw u}}a(dJ,"publishToStream");function NC(e,t){t===void 0&&(t=j2());let r=wt.get(Oe.CONFIG_PARAMS.CLUSTERING_NODENAME);return!t.has(Re.MSG_HEADERS.ORIGIN)&&r&&t.append(Re.MSG_HEADERS.ORIGIN,r),t}a(NC,"addNatsMsgHeader");function Uc(e){e=e.toLowerCase();let t=Lc.join(wt.get(Oe.CONFIG_PARAMS.ROOTPATH),rJ);if(e===Oe.PROCESS_DESCRIPTORS.CLUSTERING_HUB.toLowerCase())return Pi(Tp)&&(Tp={port:wc.getConfigFromFile(Oe.CONFIG_PARAMS.CLUSTERING_HUBSERVER_NETWORK_PORT),server_name:wc.getConfigFromFile(Oe.CONFIG_PARAMS.CLUSTERING_NODENAME)+Re.SERVER_SUFFIX.HUB,config_file:Re.NATS_CONFIG_FILES.HUB_SERVER,pid_file_path:Lc.join(t,Re.PID_FILES.HUB),hdb_nats_path:t}),Tp;if(e===Oe.PROCESS_DESCRIPTORS.CLUSTERING_LEAF.toLowerCase())return Pi(Sp)&&(Sp={port:wc.getConfigFromFile(Oe.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_NETWORK_PORT),server_name:wc.getConfigFromFile(Oe.CONFIG_PARAMS.CLUSTERING_NODENAME)+Re.SERVER_SUFFIX.LEAF,config_file:Re.NATS_CONFIG_FILES.LEAF_SERVER,domain:wc.getConfigFromFile(Oe.CONFIG_PARAMS.CLUSTERING_NODENAME)+Re.SERVER_SUFFIX.LEAF,pid_file_path:Lc.join(t,Re.PID_FILES.LEAF),hdb_nats_path:t}),Sp;Vr.error(`Unable to get Nats server config. Unrecognized process: ${e}`)}a(Uc,"getServerConfig");async function fJ(e){let{jsm:t}=await jt(),r=await Mc();try{await t.streams.add({name:e.stream_name,storage:SC.File,retention:TC.Limits,max_age:W2,max_bytes:Q2,subjects:[`${Re.SUBJECT_PREFIXES.TXN}.${e.stream_name}.${r}`]})}catch(s){if(s.code!=="400")throw s}try{await t.consumers.info(e.stream_name,e.durable_name)}catch(s){if(s.code.toString()==="404")await t.consumers.add(e.stream_name,{ack_policy:C_.Explicit,durable_name:e.durable_name,deliver_policy:L_.All,max_ack_pending:1e4});else throw s}}a(fJ,"createWorkQueueStream");async function EJ(){let{jsm:e}=await jt();(await e.consumers.info(Re.WORK_QUEUE_CONSUMER_NAMES.stream_name,Re.WORK_QUEUE_CONSUMER_NAMES.durable_name)).config.deliver_subject&&(Vr.info("Removing old nats push consumer from ingest stream"),await e.consumers.delete(Re.WORK_QUEUE_CONSUMER_NAMES.stream_name,Re.WORK_QUEUE_CONSUMER_NAMES.durable_name),Vr.info("Adding pull consumer to ingest stream"),await e.consumers.add(Re.WORK_QUEUE_CONSUMER_NAMES.stream_name,{ack_policy:C_.Explicit,durable_name:Re.WORK_QUEUE_CONSUMER_NAMES.durable_name,deliver_policy:L_.All,max_ack_pending:1e4}))}a(EJ,"updateIngestStreamConsumer");async function bC(e,t,r){let{jsm:s}=await jt(),n=await s.streams.info(t),i=yC(s.prefix),o=r.start_time?r.start_time:new Date(Date.now()).toISOString(),{schema:c,table:u}=r,_=w_.createNatsTableStreamName(c,u),l=i===e,d,f,E=!1;if(!Array.isArray(n.config.sources)||n.config.sources.length===0)n.config.sources=[];else for(let p=0,S=n.config.sources.length;p<S;p++)if(d=n.config.sources[p],f=p,l&&d.name===_||!l&&d.name===_&&d.external&&d.external.api===`$JS.${e}.API`){E=!0;break}if(E===!0){if(d.opt_start_time===o)return;let p=`txn.${c}.${u}.${e}`;await s.streams.purge(t,{filter:p}),n.config.sources.splice(f,1),await s.streams.update(t,n.config)}let h={name:_,opt_start_time:o,filter_subject:`${Re.SUBJECT_PREFIXES.TXN}.>`};l||(h.external={api:`$JS.${e}.API`,deliver:""}),n.config.sources.push(h),await s.streams.update(t,n.config)}a(bC,"addSourceToWorkStream");function yC(e){return e.split(".")[1]}a(yC,"extractServerName");async function IC(e,t,r){let{jsm:s}=await jt(),{schema:n,table:i}=r,o=`txn.${n}.${i}.${e}`;await s.streams.purge(t,{filter:o});let c=w_.createNatsTableStreamName(n,i),u=await s.streams.info(t);if(!Array.isArray(u.config.sources)||u.config.sources.length===0)return;let _=u.config.sources.length,l;for(;_--;)if(l=u.config.sources[_],l.name===c&&l.external.api===`$JS.${e}.API`){u.config.sources.splice(_,1);break}await s.streams.update(t,u.config)}a(IC,"removeSourceFromWorkStream");async function hJ(e,t,r=2e4,s=Op()){if(!Rp.isObject(t))throw new Error("data param must be an object");let n=mC.encode(t),{connection:i}=await jt(),o={timeout:r};s&&(o.reply=s,o.noMux=!0);let c=await i.request(e,n,o);return Ap(c.data)}a(hJ,"request");function yp(e){return new Promise(async(t,r)=>{let s=k2(gp,["--signal",`reload=${e}`],{cwd:__dirname}),n,i;s.on("error",o=>{r(o)}),s.stdout.on("data",o=>{i+=o.toString()}),s.stderr.on("data",o=>{n+=o.toString()}),s.stderr.on("close",o=>{n&&r(n),t(i)})})}a(yp,"reloadNATS");async function mJ(){let{pid_file_path:e}=Uc(Oe.PROCESS_DESCRIPTORS.CLUSTERING_HUB);await yp(e)}a(mJ,"reloadNATSHub");async function pJ(){let{pid_file_path:e}=Uc(Oe.PROCESS_DESCRIPTORS.CLUSTERING_LEAF);await yp(e)}a(pJ,"reloadNATSLeaf");function SJ(e,t,r){let s;switch(e.code){case fC.NoResponders:s=`Unable to ${t}, node '${r}' is not listening.`;break;case fC.Timeout:s=`Unable to ${t}, node '${r}' is listening but did not respond.`;break;default:s=e.message;break}return s}a(SJ,"requestErrorHandler");async function TJ(e,t){let r=t+Re.SERVER_SUFFIX.LEAF;await wC(async()=>{e.subscribe===!0?await bC(r,Re.WORK_QUEUE_CONSUMER_NAMES.stream_name,e):await IC(r,Re.WORK_QUEUE_CONSUMER_NAMES.stream_name,e)})}a(TJ,"updateWorkStream");function wC(e){return V2.writeTransaction(Oe.SYSTEM_SCHEMA_NAME,Oe.SYSTEM_TABLE_NAMES.NODE_TABLE_NAME,e)}a(wC,"exclusiveLock");async function CC(e,t){let r=w_.createNatsTableStreamName(e,t),s=await Mc(),n=OJ(e,t,s);await bp(r,[n])}a(CC,"createLocalTableStream");async function gJ(e){for(let t=0,r=e.length;t<r;t++){let s=e[t].schema,n=e[t].table;await CC(s,n)}}a(gJ,"createTableStreams");async function LC(e,t){if(wt.get(Oe.CONFIG_PARAMS.CLUSTERING_ENABLED))try{let r=w_.createNatsTableStreamName(e,t),{jsm:s}=await jt();await s.streams.purge(r)}catch(r){if(r.message==="stream not found")Vr.warn(r);else throw r}}a(LC,"purgeTableStream");async function RJ(e,t){if(wt.get(Oe.CONFIG_PARAMS.CLUSTERING_ENABLED))for(let r=0,s=t.length;r<s;r++)await LC(e,t[r])}a(RJ,"purgeSchemaTableStreams");async function AJ(e){return(await Dc()).streams.info(e)}a(AJ,"getStreamInfo");function OJ(e,t,r){return`${Re.SUBJECT_PREFIXES.TXN}.${e}${t?"."+t:""}.${r}`}a(OJ,"createSubjectName");async function Mc(){if(Cc)return Cc;if(Cc=(await Dc())?.nc?.info?.server_name,Cc===void 0)throw new Error("Unable to get jetstream manager server name");return Cc}a(Mc,"getJsmServerName");async function NJ(){let e=await Dc(),t=await Mc(),r=await OC();for(let s of r){let n=s.config,i=n.subjects[0];if(!i)continue;let o=bJ(s),c=i.split(".");if(!(c[c.length-1]===t&&!o)){if(n.name===Re.SCHEMA_QUEUE_CONSUMER_NAMES.stream_name){let _=`${Re.SCHEMA_QUEUE_CONSUMER_NAMES.deliver_subject}.${t}`;Vr.trace(`Updating stream subject name from: ${i} to: ${_}`),n.subjects[0]=_}else if(n.name===Re.WORK_QUEUE_CONSUMER_NAMES.stream_name){let _=`${Re.WORK_QUEUE_CONSUMER_NAMES.stream_name}.${t}`;Vr.trace(`Updating stream subject name from: ${i} to: ${_}`),n.subjects[0]=_}else{let _=i.split(".");_[_.length-1]=t;let l=_.join(".");Vr.trace(`Updating stream subject name from: ${i} to: ${l}`),n.subjects[0]=l}await e.streams.update(n.name,n)}}}a(NJ,"updateLocalStreams");function bJ(e){let{config:t}=e,r=!1;if(t.name===Re.SCHEMA_QUEUE_CONSUMER_NAMES.stream_name||t.name===Re.WORK_QUEUE_CONSUMER_NAMES.stream_name)return r;let s=wt.get(Oe.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_STREAMS_MAXAGE);s=s===null?0:s*1e9;let n=wt.get(Oe.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_STREAMS_MAXBYTES);n=n===null?-1:n;let i=wt.get(Oe.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_STREAMS_MAXMSGS);return i=i===null?-1:i,s!==t.max_age&&(t.max_age=s,r=!0),n!==t.max_bytes&&(t.max_bytes=n,r=!0),i!==t.max_msgs&&(t.max_msgs=i,r=!0),r}a(bJ,"updateStreamLimits")});var v_=T((xue,vC)=>{"use strict";var Mo=Hl(),Po=Ww(),yJ=G(),IJ=require("uuid").v4,Gue=require("clone"),M_=an(),vo=y(),wJ=require("util"),Kn=as(),{handleHDBError:Zt,hdb_errors:CJ}=j(),{HDB_ERROR_MSGS:U_,HTTP_STATUS_CODES:er}=CJ,{SchemaEventMsg:P_}=ls(),UC=_t(),{getDatabases:LJ}=(Ee(),Z(Ce)),{transformReq:Bo}=$();vC.exports={createSchema:DJ,createSchemaStructure:MC,createTable:UJ,createTableStructure:PC,createAttribute:HJ,dropSchema:MJ,dropTable:PJ,dropAttribute:vJ,getBackup:qJ};async function DJ(e){let t=await MC(e);return M_.signalSchemaChange(new P_(process.pid,e.operation,e.schema)),t}a(DJ,"createSchema");async function MC(e){let t=Mo.schema_object(e);if(t)throw Zt(t,t.message,er.BAD_REQUEST,void 0,void 0,!0);if(Bo(e),!await Po.checkSchemaExists(e.schema))throw Zt(new Error,U_.SCHEMA_EXISTS_ERR(e.schema),er.BAD_REQUEST,vo.LOG_LEVELS.ERROR,U_.SCHEMA_EXISTS_ERR(e.schema),!0);return await Kn.createSchema(e),`database '${e.schema}' successfully created`}a(MC,"createSchemaStructure");async function UJ(e){return Bo(e),e.hash_attribute=e.primary_key??e.hash_attribute,await PC(e)}a(UJ,"createTable");async function PC(e){let t=Mo.create_table_object(e);if(t)throw Zt(t,t.message,er.BAD_REQUEST,void 0,void 0,!0);if(Mo.validateTableResidence(e.residence),!await Po.checkSchemaTableExists(e.schema,e.table))throw Zt(new Error,U_.TABLE_EXISTS_ERR(e.schema,e.table),er.BAD_REQUEST,vo.LOG_LEVELS.ERROR,U_.TABLE_EXISTS_ERR(e.schema,e.table),!0);let s={name:e.table,schema:e.schema,id:IJ(),hash_attribute:e.hash_attribute};try{if(e.residence)if(global.clustering_on)s.residence=e.residence,await Kn.createTable(s,e);else throw Zt(new Error,"Clustering does not appear to be enabled. Cannot insert table with property 'residence'.",er.BAD_REQUEST);else await Kn.createTable(s,e);return`table '${e.schema}.${e.table}' successfully created.`}catch(n){throw n}}a(PC,"createTableStructure");async function MJ(e){let t=!e.schema&&!e.database?new Error("database is required"):void 0,r=Mo.schema_object(e),s=t??r;if(s)throw Zt(s,s.message,er.BAD_REQUEST,void 0,void 0,!0);Bo(e);let n=await Po.checkSchemaExists(e.schema);if(n)throw Zt(new Error,n,er.NOT_FOUND,vo.LOG_LEVELS.ERROR,n,!0);let i=await Po.schema_describe.describeSchema({schema:e.schema}),o=Object.keys(global.hdb_schema[e.schema]);return await Kn.dropSchema(e),M_.signalSchemaChange(new P_(process.pid,e.operation,e.schema)),await UC.purgeSchemaTableStreams(e.schema,o),`successfully deleted '${e.schema}'`}a(MJ,"dropSchema");async function PJ(e){let t=Mo.table_object(e);if(t)throw Zt(t,t.message,er.BAD_REQUEST,void 0,void 0,!0);Bo(e);let r=await Po.checkSchemaTableExists(e.schema,e.table);if(r)throw Zt(new Error,r,er.NOT_FOUND,vo.LOG_LEVELS.ERROR,r,!0);return await Kn.dropTable(e),await UC.purgeTableStream(e.schema,e.table),`successfully deleted table '${e.schema}.${e.table}'`}a(PJ,"dropTable");async function vJ(e){let t=Mo.attribute_object(e);if(t)throw Zt(t,t.message,er.BAD_REQUEST,void 0,void 0,!0);Bo(e);let r=await Po.checkSchemaTableExists(e.schema,e.table);if(r)throw Zt(new Error,r,er.NOT_FOUND,vo.LOG_LEVELS.ERROR,r,!0);if(e.attribute===global.hdb_schema[e.schema][e.table].hash_attribute)throw Zt(new Error,"You cannot drop a hash attribute",er.BAD_REQUEST,void 0,void 0,!0);if(vo.TIME_STAMP_NAMES.indexOf(e.attribute)>=0)throw Zt(new Error,`cannot drop internal timestamp attribute: ${e.attribute}`,er.BAD_REQUEST,void 0,void 0,!0);try{return await Kn.dropAttribute(e),BJ(e),M_.signalSchemaChange(new P_(process.pid,e.operation,e.schema,e.table,e.attribute)),`successfully deleted attribute '${e.attribute}'`}catch(s){throw yJ.error(`Got an error deleting attribute ${wJ.inspect(e)}.`),s}}a(vJ,"dropAttribute");function BJ(e){let t=Object.values(global.hdb_schema[e.schema][e.table].attributes);for(let r=0;r<t.length;r++)t[r].attribute===e.attribute&&global.hdb_schema[e.schema][e.table].attributes.splice(r,1)}a(BJ,"dropAttributeFromGlobal");async function HJ(e){Bo(e);let t=LJ()[e.schema][e.table].attributes;for(let{name:r}of t)if(r===e.attribute)throw Zt(new Error,`attribute '${e.attribute}' already exists in ${e.schema}.${e.table}`,er.BAD_REQUEST,void 0,void 0,!0);return await Kn.createAttribute(e),M_.signalSchemaChange(new P_(process.pid,e.operation,e.schema,e.table,e.attribute)),`attribute '${e.schema}.${e.table}.${e.attribute}' successfully created.`}a(HJ,"createAttribute");function qJ(e){return Kn.getBackup(e)}a(qJ,"getBackup")});var HC=T((Vue,BC)=>{"use strict";var{OPERATIONS_ENUM:FJ}=y(),Ip=class{static{a(this,"ReadAuditLogObject")}constructor(t,r,s=void 0,n=void 0){this.operation=FJ.READ_AUDIT_LOG,this.schema=t,this.table=r,this.search_type=s,this.search_values=n}};BC.exports=Ip});var wp=T((Kue,kC)=>{"use strict";var GJ=as(),Yue=HC(),B_=$(),H_=y(),xJ=X(),{handleHDBError:qC,hdb_errors:kJ}=j(),{HDB_ERROR_MSGS:FC,HTTP_STATUS_CODES:GC}=kJ,VJ=Object.values(H_.READ_AUDIT_LOG_SEARCH_TYPES_ENUM),xC="To use this operation audit log must be enabled in harperdb-config.yaml";kC.exports=$J;async function $J(e){if(B_.isEmpty(e.schema))throw new Error(FC.SCHEMA_REQUIRED_ERR);if(B_.isEmpty(e.table))throw new Error(FC.TABLE_REQUIRED_ERR);if(!xJ.get(H_.CONFIG_PARAMS.LOGGING_AUDITLOG))throw qC(new Error,xC,GC.BAD_REQUEST,H_.LOG_LEVELS.ERROR,xC,!0);let t=B_.checkSchemaTableExist(e.schema,e.table);if(t)throw qC(new Error,t,GC.NOT_FOUND,H_.LOG_LEVELS.ERROR,t,!0);if(!B_.isEmpty(e.search_type)&&VJ.indexOf(e.search_type)<0)throw new Error(`Invalid search_type '${e.search_type}'`);return await GJ.readAuditLog(e)}a($J,"readAuditLog")});var $C=T((Que,VC)=>{"use strict";var{OPERATIONS_ENUM:YJ}=y(),Cp=class{static{a(this,"GetBackupObject")}constructor(t,r,s=void 0,n=void 0){this.operation=YJ.GET_BACKUP,this.schema=t,this.table=r}};VC.exports=Cp});var WC=T((jue,KC)=>{"use strict";var KJ=as(),Jue=$C(),Lp=$(),WJ=y(),Xue=X(),{handleHDBError:QJ,hdb_errors:zJ}=j(),{HDB_ERROR_MSGS:YC,HTTP_STATUS_CODES:JJ}=zJ;KC.exports=XJ;async function XJ(e){if(Lp.isEmpty(e.schema))throw new Error(YC.SCHEMA_REQUIRED_ERR);if(Lp.isEmpty(e.table))throw new Error(YC.TABLE_REQUIRED_ERR);let t=Lp.checkSchemaTableExist(e.schema,e.table);if(t)throw QJ(new Error,t,JJ.NOT_FOUND,WJ.LOG_LEVELS.ERROR,t,!0);return await KJ.getBackup(read_audit_log_object)}a(XJ,"getBackup")});var ZC=T((ele,jC)=>{var Wn=require("validate.js"),zC=ke(),Ho=y(),{handleHDBError:jJ,hdb_errors:ZJ}=j(),{HDB_ERROR_MSGS:je,HTTP_STATUS_CODES:e4}=ZJ,Dp=a(()=>({role:{presence:!0,format:"[\\w\\-\\_]+"},id:{presence:!0,format:"[\\w\\-\\_]+"},permission:{presence:!0}}),"constraintsTemplate"),t4={STRUCTURE_USER:"structure_user"},QC=Object.values(Ho.ROLE_TYPES_ENUM),r4="attribute_permissions",s4="attribute_name",{PERMS_CRUD_ENUM:qo}=Ho,n4=[r4,...Object.values(qo)],JC=[qo.READ,qo.INSERT,qo.UPDATE],i4=[s4,...JC];function o4(e){let t=Dp();return t.role.presence=!0,t.id.presence=!1,t.permission.presence=!0,XC(e,t)}a(o4,"addRoleValidation");function a4(e){let t=Dp();return t.role.presence=!1,t.id.presence=!0,t.permission.presence=!0,XC(e,t)}a(a4,"alterRoleValidation");function c4(e){let t=Dp();return t.role.presence=!1,t.id.presence=!0,t.permission.presence=!1,zC.validateObject(e,t)}a(c4,"dropRoleValidation");var u4=["operation","role","id","permission","hdb_user","hdb_auth_header"];function XC(e,t){let r={main_permissions:[],schema_permissions:{}},s=Object.keys(e),n=[];for(let o=0,c=s.length;o<c;o++)u4.includes(s[o])||n.push(s[o]);n.length>0&&st(je.INVALID_ROLE_JSON_KEYS(n),r);let i=zC.validateObject(e,t);if(i&&i.message.split(",").forEach(o=>{st(o,r)}),e.permission){let o=l4(e);o&&st(o,r),QC.forEach(c=>{e.permission[c]&&!Wn.isBoolean(e.permission[c])&&st(je.SU_CU_ROLE_BOOLEAN_ERROR(c),r)})}for(let o in e.permission)if(QC.indexOf(o)<0){if(o===t4.STRUCTURE_USER){let u=e.permission[o];if(typeof u=="boolean")continue;if(Array.isArray(u)){for(let _=0,l=u.length;_<l;_++){let d=u[_];global.hdb_schema[d]||st(je.SCHEMA_NOT_FOUND(d),r)}continue}st(je.STRUCTURE_USER_ROLE_TYPE_ERROR(o),r);continue}let c=e.permission[o];if(!o||!global.hdb_schema[o]){st(je.SCHEMA_NOT_FOUND(o),r);continue}if(c.tables)for(let u in c.tables){let _=c.tables[u];if(!u||!global.hdb_schema[o][u]){st(je.TABLE_NOT_FOUND(o,u),r);continue}if(Object.keys(_).forEach(l=>{n4.includes(l)||st(je.INVALID_PERM_KEY(l),r,o,u)}),Object.values(qo).forEach(l=>{Wn.isDefined(_[l])?Wn.isBoolean(_[l])||st(je.TABLE_PERM_NOT_BOOLEAN(l),r,o,u):st(je.TABLE_PERM_MISSING(l),r,o,u)}),Wn.isDefined(_.attribute_permissions)){if(!Wn.isArray(_.attribute_permissions)){st(je.ATTR_PERMS_NOT_ARRAY,r,o,u);continue}}else{st(je.ATTR_PERMS_ARRAY_MISSING,r,o,u);continue}if(_.attribute_permissions){let l=global.hdb_schema[o][u].attributes.map(({attribute:f})=>f),d={read:!1,insert:!1,update:!1};for(let f in _.attribute_permissions){let E=_.attribute_permissions[f];if(Object.keys(E).forEach(p=>{!i4.includes(p)&&p!==qo.DELETE&&st(je.INVALID_ATTR_PERM_KEY(p),r,o,u)}),!Wn.isDefined(E.attribute_name)){st(je.ATTR_PERM_MISSING_NAME,r,o,u);continue}let h=E.attribute_name;if(!l.includes(h)){st(je.INVALID_ATTRIBUTE_IN_PERMS(h),r,o,u);continue}JC.forEach(p=>{Wn.isDefined(E[p])?Wn.isBoolean(E[p])||st(je.ATTR_PERM_NOT_BOOLEAN(p,h),r,o,u):st(je.ATTR_PERM_MISSING(p,h),r,o,u)}),!d.read&&E.read===!0&&(d.read=!0),!d.insert&&E.insert===!0&&(d.insert=!0),!d.update&&E.update===!0&&(d.update=!0)}if(_.read===!1&&d.read===!0||_.insert===!1&&d.insert===!0||_.update===!1&&d.update===!0){let f=`${o}.${u}`;st(je.MISMATCHED_TABLE_ATTR_PERMS(f),r,o,u)}}}}return _4(r)}a(XC,"customValidate");jC.exports={addRoleValidation:o4,alterRoleValidation:a4,dropRoleValidation:c4};function l4(e){let{operation:t,permission:r}=e;if(t===Ho.OPERATIONS_ENUM.ADD_ROLE||t===Ho.OPERATIONS_ENUM.ALTER_ROLE){let s=r.super_user===!0,n=r.cluster_user===!0;if(Object.keys(r).length>1&&(s||n)){if(n&&s)return je.SU_CU_ROLE_COMBINED_ERROR;{let o=r.super_user?Ho.ROLE_TYPES_ENUM.SUPER_USER:Ho.ROLE_TYPES_ENUM.CLUSTER_USER;return je.SU_CU_ROLE_NO_PERMS_ALLOWED(o)}}}return null}a(l4,"validateNoSUPerms");function _4(e){let{main_permissions:t,schema_permissions:r}=e;if(t.length>0||Object.keys(r).length>0){let s={error:je.ROLE_PERMS_ERROR,...e};return jJ(new Error,s,e4.BAD_REQUEST)}else return null}a(_4,"generateRolePermResponse");function st(e,t,r,s){if(!r)t.main_permissions.push(e);else{let n=s?r+"_"+s:r;t.schema_permissions[n]?t.schema_permissions[n].push(e):t.schema_permissions[n]=[e]}}a(st,"addPermError")});var Hp=T((rle,sL)=>{"use strict";var eL=Gr(),tL=Fr(),d4=bi(),Mp=ZC(),Pp=an(),f4=require("uuid").v4,E4=require("util"),q_=y(),h4=$(),vp=tL.searchByValue,m4=tL.searchByHash,p4=E4.promisify(d4.delete),S4=vs(),T4=Io(),{hdb_errors:g4,handleHDBError:Fo}=j(),{HDB_ERROR_MSGS:rL,HTTP_STATUS_CODES:F_}=g4,{UserEventMsg:Bp}=ls();sL.exports={addRole:R4,alterRole:A4,dropRole:O4,listRoles:N4};function Up(e){try{e.hdb_auth_header&&delete e.hdb_auth_header,e.HDB_INTERNAL_PATH&&delete e.HDB_INTERNAL_PATH,e.operation&&delete e.operation,e.hdb_user&&delete e.hdb_user}catch{}return e}a(Up,"scrubRoleDetails");async function R4(e){let t=Mp.addRoleValidation(e);if(t)throw t;e=Up(e);let r={schema:"system",table:"hdb_role",search_attribute:"role",search_value:e.role,hash_attribute:"id",get_attributes:["*"]},s;try{s=Array.from(await vp(r)||[])}catch(i){throw Fo(i)}if(s&&s.length>0)throw Fo(new Error,rL.ROLE_ALREADY_EXISTS(e.role),F_.CONFLICT,void 0,void 0,!0);e.id||(e.id=f4());let n={operation:"insert",schema:"system",table:"hdb_role",hash_attribute:"id",records:[e]};return await eL.insert(n),Pp.signalUserChange(new Bp(process.pid)),e=Up(e),e}a(R4,"addRole");async function A4(e){let t=Mp.alterRoleValidation(e);if(t)throw t;e=Up(e);let r={operation:"update",schema:"system",table:"hdb_role",records:[e]},s;try{s=await eL.update(r)}catch(n){throw Fo(n)}if(s&&s?.message==="updated 0 of 1 records")throw Fo(new Error,"Invalid role id",F_.BAD_REQUEST,void 0,void 0,!0);return await Pp.signalUserChange(new Bp(process.pid)),e}a(A4,"alterRole");async function O4(e){let t=Mp.dropRoleValidation(e);if(t)throw Fo(new Error,t,F_.BAD_REQUEST,void 0,void 0,!0);let r=new T4(q_.SYSTEM_SCHEMA_NAME,q_.SYSTEM_TABLE_NAMES.ROLE_TABLE_NAME,[e.id],["role"]),s=Array.from(await m4(r));if(s.length===0)throw Fo(new Error,rL.ROLE_NOT_FOUND,F_.NOT_FOUND,void 0,void 0,!0);let n=new S4(q_.SYSTEM_SCHEMA_NAME,q_.SYSTEM_TABLE_NAMES.USER_TABLE_NAME,"role",e.id,void 0,["username","active"]),i=Array.from(await vp(n)),o=!1;if(h4.isEmptyOrZeroLength(i)===!1){for(let u=0;u<i.length;u++)if(i[u].active===!0){o=!0;break}}if(o===!0)throw new Error(`Cannot drop role ${s[0].role} as it has active user(s) tied to this role`);let c={table:"hdb_role",schema:"system",hash_values:[e.id]};return await p4(c),Pp.signalUserChange(new Bp(process.pid)),`${s[0].role} successfully deleted`}a(O4,"dropRole");async function N4(){return vp({table:"hdb_role",schema:"system",hash_attribute:"id",search_attribute:"id",search_value:"*",get_attributes:["*"]})}a(N4,"listRoles")});var aL=T((nle,oL)=>{"use strict";var b4=X(),Qn=require("joi"),y4=ke(),nL=require("moment"),I4=require("fs-extra"),qp=require("path"),w4=require("lodash"),Pc=y(),{LOG_LEVELS:vi}=y(),C4="YYYY-MM-DD hh:mm:ss",L4=qp.resolve(__dirname,"../logs");oL.exports=function(e){return y4.validateBySchema(e,D4)};var D4=Qn.object({from:Qn.custom(iL),until:Qn.custom(iL),level:Qn.valid(vi.NOTIFY,vi.FATAL,vi.ERROR,vi.WARN,vi.INFO,vi.DEBUG,vi.TRACE),order:Qn.valid("asc","desc"),limit:Qn.number().min(1),start:Qn.number().min(0),log_name:Qn.custom(U4)});function iL(e,t){if(nL(e,nL.ISO_8601).format(C4)==="Invalid date")return t.message(`'${t.state.path[0]}' date '${e}' is invalid.`)}a(iL,"validateDatetime");function U4(e,t){if(w4.invert(Pc.LOG_NAMES)[e]===void 0)return t.message(`'log_name' '${e}' is invalid.`);let s=b4.get(Pc.HDB_SETTINGS_NAMES.LOG_PATH_KEY),n=e===void 0?Pc.LOG_NAMES.HDB:e,i=n===Pc.LOG_NAMES.INSTALL?qp.join(L4,Pc.LOG_NAMES.INSTALL):qp.join(s,n);return I4.existsSync(i)?null:t.message(`'log_name' '${e}' does not exist.`)}a(U4,"validateReadLogPath")});var Gp=T((ole,uL)=>{"use strict";var G_=y(),M4=G(),P4=X(),v4=aL(),Fp=require("path"),cL=require("fs-extra"),{once:B4}=require("events"),{handleHDBError:H4,hdb_errors:q4}=j(),{PACKAGE_ROOT:F4}=y(),G4=Fp.join(F4,"logs"),x4=1e3,k4=200;uL.exports=V4;async function V4(e){let t=v4(e);if(t)throw H4(t,t.message,q4.HTTP_STATUS_CODES.BAD_REQUEST,void 0,void 0,!0);let r=P4.get(G_.HDB_SETTINGS_NAMES.LOG_PATH_KEY),s=e.log_name===void 0?G_.LOG_NAMES.HDB:e.log_name,n=s===G_.LOG_NAMES.INSTALL?Fp.join(G4,G_.LOG_NAMES.INSTALL):Fp.join(r,s),i=e.level!==void 0,o=i?e.level:void 0,c=e.from!==void 0,u=c?new Date(e.from):void 0,_=e.until!==void 0,l=_?new Date(e.until):void 0,d=e.limit===void 0?x4:e.limit,f=e.order===void 0?void 0:e.order,E=e.start===void 0?0:e.start,h=E+d,p=0;f==="desc"&&!u&&!l&&(p=Math.max(cL.statSync(n).size-(h+5)*k4,0));let S=cL.createReadStream(n,{start:p});S.on("error",F=>{M4.error(F)});let g=0,b=[],O="",Y;S.on("data",F=>{let w=/(?:^|\n)(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:[\d\.]+Z) \[(.+?)]: /g;F=O+F;let K=0,B;for(;(B=w.exec(F))&&!S.destroyed;){Y&&(Y.message=F.slice(K,B.index),Q(Y));let[x,te,be]=B,se=be.split("] ["),vt=se[0],Pe=se[1];se.splice(0,2),Y={timestamp:te,thread:vt,level:Pe,tags:se,message:""},K=B.index+x.length}O=F.slice(K)}),S.on("end",F=>{S.destroyed||Y&&(Y.message=O.trim(),Q(Y))}),S.resume();function Q(F){let w,K,B;switch(!0){case(i&&c&&_):w=new Date(F.timestamp),K=new Date(u),B=new Date(l),F.level===o&&w>=K&&w<=B&&g<E?g++:F.level===o&&w>=K&&w<=B&&(zn(F,f,b),g++,g===h&&S.destroy());break;case(i&&c):w=new Date(F.timestamp),K=new Date(u),F.level===o&&w>=K&&g<E?g++:F.level===o&&w>=K&&(zn(F,f,b),g++,g===h&&S.destroy());break;case(i&&_):w=new Date(F.timestamp),B=new Date(l),F.level===o&&w<=B&&g<E?g++:F.level===o&&w<=B&&(zn(F,f,b),g++,g===h&&S.destroy());break;case(c&&_):w=new Date(F.timestamp),K=new Date(u),B=new Date(l),w>=K&&w<=B&&g<E?g++:w>=K&&w<=B&&(zn(F,f,b),g++,g===h&&S.destroy());break;case i:F.level===o&&g<E?g++:F.level===o&&(zn(F,f,b),g++,g===h&&S.destroy());break;case c:w=new Date(F.timestamp),K=new Date(u),w>=K&&g<E?g++:w>=K&&g>=E&&(zn(F,f,b),g++,g===h&&S.destroy());break;case _:w=new Date(F.timestamp),B=new Date(l),w<=B&&g<E?g++:w<=B&&g>=E&&(zn(F,f,b),g++,g===h&&S.destroy());break;default:g<E?g++:(zn(F,f,b),g++,g===h&&S.destroy())}}return a(Q,"onLogMessage"),await B4(S,"close"),b}a(V4,"readLog");function zn(e,t,r){t==="desc"?$4(e,r):t==="asc"?Y4(e,r):r.push(e)}a(zn,"pushLineToResult");function $4(e,t){let r=new Date(e.timestamp),s=0,n=t.length;for(;s<n;){let i=s+n>>>1;new Date(t[i].timestamp)>r?s=i+1:n=i}t.splice(s,0,e)}a($4,"insertDescending");function Y4(e,t){let r=new Date(e.timestamp),s=0,n=t.length;for(;s<n;){let i=s+n>>>1;new Date(t[i].timestamp)<r?s=i+1:n=i}t.splice(s,0,e)}a(Y4,"insertAscending")});var k_=T((_le,fL)=>{"use strict";var xp=require("joi"),{string:x_,boolean:lL,date:K4}=xp.types(),W4=ke(),{validateSchemaExists:cle,validateTableExists:ule,validateSchemaName:lle}=Ls(),Q4=y(),z4=Ve(),_L=X();_L.initSync();var J4=x_.invalid(_L.get(Q4.CONFIG_PARAMS.CLUSTERING_NODENAME)).pattern(z4.NATS_TERM_CONSTRAINTS_RX).messages({"string.pattern.base":"{:#label} invalid, must not contain ., * or >","any.invalid":"'node_name' cannot be this nodes name"}).empty(null).required(),dL={operation:x_.valid("add_node","update_node"),node_name:J4,subscriptions:xp.array().items({table:x_.optional(),schema:x_.required(),subscribe:lL.required(),publish:lL.required().custom(j4),start_time:K4.iso()}).min(1).required()};function X4(e){return W4.validateBySchema(e,xp.object(dL))}a(X4,"addUpdateNodeValidator");function j4(e,t){if(t.state.ancestors[2].operation==="add_node"&&e===!1&&t.state.ancestors[0].subscribe===!1)return t.message(`'subscriptions[${t.state.path[1]}]' subscribe and/or publish must be set to true when adding a node`)}a(j4,"checkForFalsy");fL.exports={addUpdateNodeValidator:X4,validation_schema:dL}});var hL=T((fle,EL)=>{var Z4=ke(),e3={user:{presence:!0},schema:{presence:!0},table:{presence:!0},operation:{presence:!0}};EL.exports=function(e){return Z4.validateObject(e,e3)}});var Vp=T((Ele,mL)=>{"use strict";var t3=y().OPERATIONS_ENUM,kp=class{static{a(this,"UpdateObject")}constructor(t,r,s,n=void 0){this.operation=t3.UPDATE,this.schema=t,this.table=r,this.records=s,this.__origin=n}};mL.exports=kp});var SL=T((mle,pL)=>{"use strict";var r3={OPERATION:"operation",REFRESH:"refresh"},$p=class{static{a(this,"JWTTokens")}constructor(t,r){this.operation_token=t,this.refresh_token=r}},Yp=class{static{a(this,"JWTRSAKeys")}constructor(t,r,s){this.public_key=t,this.private_key=r,this.passphrase=s}};pL.exports={JWTTokens:$p,TOKEN_TYPE_ENUM:r3,JWTRSAKeys:Yp}});var Hc=T((Sle,AL)=>{"use strict";var Bc=require("jsonwebtoken"),Kp=require("fs-extra"),Wp=$(),$r=y(),{handleHDBError:tr,hdb_errors:s3}=j(),{HTTP_STATUS_CODES:rr,AUTHENTICATION_ERROR_MSGS:sr}=s3,vc=G(),TL=Jl(),Jp=xr(),n3=Gr().update,i3=Vp(),o3=an(),{UserEventMsg:a3}=ls(),Jn=X();Jn.initSync();var Qp=require("path"),{JWTTokens:c3,JWTRSAKeys:u3,TOKEN_TYPE_ENUM:V_}=SL(),l3=Jn.get($r.HDB_SETTINGS_NAMES.OPERATION_TOKEN_TIMEOUT_KEY)?Jn.get($r.HDB_SETTINGS_NAMES.OPERATION_TOKEN_TIMEOUT_KEY):"1d",_3=Jn.get($r.HDB_SETTINGS_NAMES.REFRESH_TOKEN_TIMEOUT_KEY)?Jn.get($r.HDB_SETTINGS_NAMES.REFRESH_TOKEN_TIMEOUT_KEY):"30d",$_="RS256",zp;AL.exports={createTokens:d3,validateOperationToken:E3,refreshOperationToken:f3,validateRefreshToken:RL};async function d3(e){if(Wp.isEmpty(e)||typeof e!="object")throw tr(new Error,sr.INVALID_AUTH_OBJECT,rr.BAD_REQUEST,void 0,void 0,!0);if(Wp.isEmpty(e.username))throw tr(new Error,sr.USERNAME_REQUIRED,rr.BAD_REQUEST,void 0,void 0,!0);if(Wp.isEmpty(e.password))throw tr(new Error,sr.PASSWORD_REQUIRED,rr.BAD_REQUEST,void 0,void 0,!0);let t;try{if(t=await Jp.findAndValidateUser(e.username,e.password),!t)throw tr(new Error,sr.INVALID_CREDENTIALS,rr.UNAUTHORIZED,void 0,void 0,!0)}catch(f){throw vc.error(f),tr(new Error,sr.INVALID_CREDENTIALS,rr.UNAUTHORIZED,void 0,void 0,!0)}let r=await Y_(),s=!1,n=!1;t.role&&t.role.permission&&(s=t.role.permission.super_user===!0,n=t.role.permission.cluster_user===!0);let i={username:e.username,super_user:s,cluster_user:n},o=await gL(i,r.private_key,r.passphrase),c=await Bc.sign(i,{key:r.private_key,passphrase:r.passphrase},{expiresIn:_3,algorithm:$_,subject:V_.REFRESH}),u=TL.hash(c),_=new i3($r.SYSTEM_SCHEMA_NAME,$r.SYSTEM_TABLE_NAMES.USER_TABLE_NAME,[{username:e.username,refresh_token:u}]),l,d;try{l=await n3(_)}catch(f){vc.error(f),d=f}if(d!==void 0||l.skipped_hashes.length>0)throw tr(new Error,sr.REFRESH_TOKEN_SAVE_FAILED,rr.INTERNAL_SERVER_ERROR);return o3.signalUserChange(new a3(process.pid)),new c3(o,c)}a(d3,"createTokens");async function gL(e,t,r){return await Bc.sign(e,{key:t,passphrase:r},{expiresIn:l3,algorithm:$_,subject:V_.OPERATION})}a(gL,"signOperationToken");async function Y_(){if(zp===void 0)try{let e=Qp.join(Jn.getHdbBasePath(),$r.LICENSE_KEY_DIR_NAME,$r.JWT_ENUM.JWT_PASSPHRASE_NAME),t=Qp.join(Jn.getHdbBasePath(),$r.LICENSE_KEY_DIR_NAME,$r.JWT_ENUM.JWT_PRIVATE_KEY_NAME),r=Qp.join(Jn.getHdbBasePath(),$r.LICENSE_KEY_DIR_NAME,$r.JWT_ENUM.JWT_PUBLIC_KEY_NAME),s=(await Kp.readFile(e)).toString(),n=(await Kp.readFile(t)).toString(),i=(await Kp.readFile(r)).toString();zp=new u3(i,n,s)}catch(e){throw vc.error(e),tr(new Error,sr.NO_ENCRYPTION_KEYS,rr.INTERNAL_SERVER_ERROR)}return zp}a(Y_,"getJWTRSAKeys");async function f3(e){if(!e)throw tr(new Error,sr.INVALID_BODY,rr.BAD_REQUEST,void 0,void 0,!0);if(!e.refresh_token)throw tr(new Error,sr.REFRESH_TOKEN_REQUIRED,rr.BAD_REQUEST,void 0,void 0,!0);await RL(e.refresh_token);let t=await Y_(),r=await Bc.decode(e.refresh_token);return{operation_token:await gL({username:r.username,super_user:r.super_user,cluster_user:r.cluster_user},t.private_key,t.passphrase)}}a(f3,"refreshOperationToken");async function E3(e){try{let t=await Y_(),r=await Bc.verify(e,t.public_key,{algorithms:$_,subject:V_.OPERATION});return await Jp.findAndValidateUser(r.username,void 0,!1)}catch(t){throw vc.warn(t),t.name&&t.name==="TokenExpiredError"?tr(new Error,sr.TOKEN_EXPIRED,rr.FORBIDDEN):tr(new Error,sr.INVALID_TOKEN,rr.UNAUTHORIZED)}}a(E3,"validateOperationToken");async function RL(e){let t;try{let r=await Y_(),s=await Bc.verify(e,r.public_key,{algorithms:$_,subject:V_.REFRESH});t=await Jp.findAndValidateUser(s.username,void 0,!1)}catch(r){throw vc.warn(r),r.name&&r.name==="TokenExpiredError"?tr(new Error,sr.TOKEN_EXPIRED,rr.FORBIDDEN):tr(new Error,sr.INVALID_TOKEN,rr.UNAUTHORIZED)}if(!TL.validate(t.refresh_token,e))throw tr(new Error,sr.INVALID_TOKEN,rr.UNAUTHORIZED);return t}a(RL,"validateRefreshToken")});var Xp=T((Rle,bL)=>{"use strict";var h3=hL(),Go=require("passport"),m3=require("passport-local").Strategy,p3=require("passport-http").BasicStrategy,S3=require("util"),T3=xr(),NL=S3.callbackify(T3.findAndValidateUser),gle=fr(),g3=y(),OL=Hc();Go.use(new m3(function(e,t,r){NL(e,t,r)}));Go.use(new p3(function(e,t,r){NL(e,t,r)}));Go.serializeUser(function(e,t){t(null,e)});Go.deserializeUser(function(e,t){t(null,e)});function R3(e,t,r){if(e.raw?.user!==void 0)return r(null,e.raw.user);let s,n;if(e.headers?.authorization){let o=e.headers.authorization.split(" ");s=o[0],n=o[1]}function i(o,c){return o?r(o):c?r(null,c):r("Must login")}switch(a(i,"handleResponse"),s){case"Basic":Go.authenticate("basic",{session:!1},(o,c)=>{i(o,c)})(e,t,r);break;case"Bearer":e.body?.operation&&e.body.operation===g3.OPERATIONS_ENUM.REFRESH_OPERATION_TOKEN?OL.validateRefreshToken(n).then(o=>{e.body.refresh_token=n,r(null,o)}).catch(o=>{r(o)}):OL.validateOperationToken(n).then(o=>{r(null,o)}).catch(o=>{r(o)});break;default:Go.authenticate("local",{session:!1},function(o,c){i(o,c)})(e,t,r);break}}a(R3,"authorize");function A3(e,t){let r=h3(e);if(r){t(r);return}let s={authorized:!0,messages:[]},n=e.user.role;if(!n?.permission)return t("Invalid role");let i=JSON.parse(n.permission);if(i.super_user)return t(null,s);if(!i[e.schema])return s.authorized=!1,s.messages.push(`Not authorized to access ${e.schema} schema`),t(null,s);if(!i[e.schema].tables[e.table])return s.authorized=!1,s.messages.push(`Not authorized to access ${e.table} table`),t(null,s);if(!i[e.schema].tables[e.table][e.operation])return s.authorized=!1,s.messages.push(`Not authorized to access ${e.operation} on ${e.table} table`),t(null,s);if(i[e.schema].tables[e.table].attribute_permissions&&!e.attributes)return s.authorized=!1,s.messages.push(`${e.schema}.${e.table} has attribute permissions. Missing attributes to validate`),t(null,s);if(i[e.schema].tables[e.table].attribute_permissions&&e.attributes){let o=i[e.schema].tables[e.table].attribute_permissions;for(let c in o)e.attributes.indexOf(o[c].attribute_name)>-1&&!o[c][e.operation]&&(s.authorized=!1,s.messages.push(`Not authorized to ${e.operation} ${o[c].attribute_name} `))}return t(null,s)}a(A3,"checkPermissions");bL.exports={authorize:R3,checkPermissions:A3}});var xo=T((Ole,yL)=>{"use strict";var jp=class{static{a(this,"Node")}constructor(t,r,s){this.name=t,this.subscriptions=r,this.system_info=s}},Zp=class{static{a(this,"NodeSubscription")}constructor(t,r,s,n){this.schema=t,this.table=r,this.publish=s,this.subscribe=n}};yL.exports={Node:jp,NodeSubscription:Zp}});var wL=T((ble,IL)=>{"use strict";var O3=y().OPERATIONS_ENUM,eS=class{static{a(this,"UpsertObject")}constructor(t,r,s,n=void 0){this.operation=O3.UPSERT,this.schema=t,this.table=r,this.records=s,this.__origin=n}};IL.exports=eS});var qc=T((Ile,CL)=>{"use strict";var tS=class{static{a(this,"RemotePayloadObject")}constructor(t,r,s,n){this.operation=t,this.node_name=r,this.subscriptions=s,this.system_info=n}},rS=class{static{a(this,"RemotePayloadSubscription")}constructor(t,r,s,n,i,o,c){this.schema=t,this.table=r,this.hash_attribute=s,this.publish=n,this.subscribe=i,this.start_time=o,c!==void 0&&(this.attributes=c)}};CL.exports={RemotePayloadObject:tS,RemotePayloadSubscription:rS}});var DL=T((Cle,LL)=>{"use strict";var sS=class{static{a(this,"TableSizeObject")}constructor(t,r,s=0,n=0,i=0,o=0){this.schema=t,this.table=r,this.table_size=s,this.record_count=n,this.transaction_log_size=i,this.transaction_log_record_count=o}};LL.exports=sS});var PL=T((Ple,ML)=>{"use strict";var N3=DL(),Dle=ze(),UL=De(),b3=G(),{getSchemaPath:Ule,getTransactionAuditStorePath:Mle}=ve(),{getDatabases:y3}=(Ee(),Z(Ce));ML.exports=I3;async function I3(e){let t=new N3;try{let r=y3()[e.schema]?.[e.name],s=r.primaryStore.getStats(),n=r.auditStore?.getStats(),i=await UL.environmentDataSize(schema_path,e.name),o=await UL.environmentDataSize(txn_path,e.name);t.schema=e.schema,t.table=e.name,t.table_size=i,t.record_count=s.entryCount,t.transaction_log_size=o,t.transaction_log_record_count=n.entryCount}catch(r){b3.warn(`unable to stat table dbi due to ${r}`)}return t}a(I3,"lmdbGetTableSize")});var BL=T((Ble,vL)=>{"use strict";var nS=class{static{a(this,"SystemInformationObject")}constructor(t,r,s,n,i,o,c){this.system=t,this.time=r,this.cpu=s,this.memory=n,this.disk=i,this.network=o,this.harperdb_processes=c}};vL.exports=nS});var ko=T((Gle,GL)=>{"use strict";var w3=require("fs-extra"),C3=require("path"),xt=require("systeminformation"),Xn=G(),L3=_t(),iS=Ve(),W_=y(),D3=PL(),FL=gi(),{getThreadInfo:HL}=Je(),hS=X();hS.initSync();var U3=BL(),{openEnvironment:qle}=De(),{getSchemaPath:Fle}=ve(),{database:M3}=(Ee(),Z(Ce)),K_;GL.exports={getHDBProcessInfo:uS,getNetworkInfo:_S,getDiskInfo:lS,getMemoryInfo:cS,getCPUInfo:aS,getTimeInfo:oS,getSystemInformation:dS,systemInformation:P3,getTableSize:fS,getMetrics:ES};function oS(){return xt.time()}a(oS,"getTimeInfo");async function aS(){try{let{family:e,model:t,stepping:r,revision:s,voltage:n,speedmin:i,speedmax:o,governor:c,socket:u,cache:_,...l}=await xt.cpu();l.cpu_speed=await xt.cpuCurrentSpeed();let{raw_currentload:d,raw_currentload_idle:f,raw_currentload_irq:E,raw_currentload_nice:h,raw_currentload_system:p,raw_currentload_user:S,cpus:g,...b}=await xt.currentLoad();return b.cpus=[],g.forEach(O=>{let{raw_load:Y,raw_load_idle:Q,raw_load_irq:F,raw_load_nice:w,raw_load_system:K,raw_load_user:B,...x}=O;b.cpus.push(x)}),l.current_load=b,l}catch(e){return Xn.error(`error in getCPUInfo: ${e}`),{}}}a(aS,"getCPUInfo");async function cS(){try{let{buffers:e,cached:t,slab:r,buffcache:s,...n}=await xt.mem();return Object.assign(n,process.memoryUsage())}catch(e){return Xn.error(`error in getMemoryInfo: ${e}`),{}}}a(cS,"getMemoryInfo");async function uS(){let e={core:[],clustering:[]};try{let t=await xt.processes(),r;try{r=Number.parseInt(await w3.readFile(C3.join(hS.get(W_.CONFIG_PARAMS.ROOTPATH),W_.HDB_PID_FILE),"utf8"))}catch(s){if(s.code===W_.NODE_ERROR_CODES.ENOENT)Xn.error("Unable to locate 'hdb.pid' file, try stopping and starting HarperDB");else throw s}t.list.forEach(s=>{s.pid===r?e.core.push(s):s.name==="nats-server"&&e.clustering.push(s)});for(let s of e.core)for(let n of t.list)n.pid===s.parentPid&&(n.name==="PM2"||n.command==="PM2")&&(s.parent="PM2");return e}catch(t){return Xn.error(`error in getHDBProcessInfo: ${t}`),e}}a(uS,"getHDBProcessInfo");async function lS(){let e={};try{let{rIO_sec:t,wIO_sec:r,tIO_sec:s,ms:n,...i}=await xt.disksIO();e.io=i;let{rx_sec:o,tx_sec:c,wx_sec:u,..._}=await xt.fsStats();return e.read_write=_,e.size=await xt.fsSize(),e}catch(t){return Xn.error(`error in getDiskInfo: ${t}`),e}}a(lS,"getDiskInfo");async function _S(){let e={default_interface:null,latency:{},interfaces:[],stats:[],connections:[]};try{return e.default_interface=await xt.networkInterfaceDefault(),e.latency=await xt.inetChecksite("google.com"),(await xt.networkInterfaces()).forEach(s=>{let{internal:n,virtual:i,mtu:o,dhcp:c,dnsSuffix:u,ieee8021xAuth:_,ieee8021xState:l,carrier_changes:d,...f}=s;e.interfaces.push(f)}),(await xt.networkStats()).forEach(s=>{let{rx_sec:n,tx_sec:i,ms:o,...c}=s;e.stats.push(c)}),e}catch(t){return Xn.error(`error in getNetworkInfo: ${t}`),e}}a(_S,"getNetworkInfo");async function dS(){if(K_!==void 0)return K_;let e={};try{let{codepage:t,logofile:r,serial:s,build:n,servicepack:i,uefi:o,...c}=await xt.osInfo();e=c;let u=await xt.versions("node, npm");return e.node_version=u.node,e.npm_version=u.npm,K_=e,K_}catch(t){return Xn.error(`error in getSystemInformation: ${t}`),e}}a(dS,"getSystemInformation");async function fS(){let e=[],t=await FL.describeAll();for(let r of Object.values(t))for(let s of Object.values(r))e.push(await D3(s));return e}a(fS,"getTableSize");async function ES(){let e=await FL.describeAll(),t={};for(let r in e){let s=t[r]={};for(let n in e[r])try{let i=M3({database:r,table:n}),o=i.getStats();o.readers=i.readerList().split(/\n\s+/).slice(1).map(c=>{let[u,_,l]=c.trim().split(" ");return{pid:u,thread:_,txnid:l}}),s[n]=o}catch(i){Xn.notify(`Error getting stats for table ${n}: ${i}`)}}return t}a(ES,"getMetrics");async function qL(){if(hS.get(W_.CONFIG_PARAMS.CLUSTERING_ENABLED)){let{js:e,jsm:t}=await L3.getNATSReferences(),r=await t.streams.info(iS.WORK_QUEUE_CONSUMER_NAMES.stream_name),s=await e.consumers.get(iS.WORK_QUEUE_CONSUMER_NAMES.stream_name,iS.WORK_QUEUE_CONSUMER_NAMES.durable_name),n={ingest:{stream:{...r.state},consumer:{num_ack_pending:s._info.num_ack_pending,num_redelivered:s._info.num_redelivered,num_waiting:s._info.num_waiting,num_pending:s._info.num_pending}}};return r.config?.sources&&(n.ingest.stream.sources=r.config.sources),n}}a(qL,"getNatsStreamInfo");async function P3(e){let t=new U3;if(!Array.isArray(e.attributes)||e.attributes.length===0)return t.system=await dS(),t.time=oS(),t.cpu=await aS(),t.memory=await cS(),t.disk=await lS(),t.network=await _S(),t.harperdb_processes=await uS(),t.table_size=await fS(),t.metrics=await ES(),t.threads=await HL(),t.replication=await qL(),t;for(let r=0;r<e.attributes.length;r++)switch(e.attributes[r]){case"system":t.system=await dS();break;case"time":t.time=oS();break;case"cpu":t.cpu=await aS();break;case"memory":t.memory=await cS();break;case"disk":t.disk=await lS();break;case"network":t.network=await _S();break;case"harperdb_processes":t.harperdb_processes=await uS();break;case"table_size":t.table_size=await fS();break;case"database_metrics":case"metrics":t.metrics=await ES();break;case"threads":t.threads=await HL();break;case"replication":t.replication=await qL();break;default:break}return t}a(P3,"systemInformation")});var mS=T((kle,xL)=>{"use strict";xL.exports={version:v3,printVersion:B3};var Q_=Oc();function v3(){if(Q_)return Q_.version}a(v3,"version");function B3(){Q_&&console.log(`HarperDB Version ${Q_.version}`)}a(B3,"printVersion")});var _n=T((Kle,YL)=>{"use strict";var H3=Gr(),pS=$(),q3=require("util"),Bi=y(),kL=X();kL.initSync();var F3=Xp(),VL=Fr(),{Node:$le,NodeSubscription:Yle}=xo(),G3=Io(),x3=wL(),{RemotePayloadObject:k3,RemotePayloadSubscription:V3}=qc(),{handleHDBError:$3,hdb_errors:Y3}=j(),{HTTP_STATUS_CODES:K3,HDB_ERROR_MSGS:W3}=Y3,Q3=vs(),z3=ko(),J3=mS(),{getDatabases:X3}=(Ee(),Z(Ce)),j3=q3.promisify(F3.authorize),Z3=VL.searchByHash,eX=VL.searchByValue;YL.exports={authHeaderToUser:tX,isEmpty:rX,getNodeRecord:sX,upsertNodeRecord:nX,buildNodePayloads:iX,checkClusteringEnabled:oX,getAllNodeRecords:aX,getSystemInfo:cX,reverseSubscription:$L};async function tX(e){let t={headers:{authorization:e.hdb_auth_header}};return e.hdb_user=await j3(t,null),e}a(tX,"authHeaderToUser");function rX(e){return e==null}a(rX,"isEmpty");async function sX(e){let t=new G3(Bi.SYSTEM_SCHEMA_NAME,Bi.SYSTEM_TABLE_NAMES.NODE_TABLE_NAME,[e],["*"]);return Z3(t)}a(sX,"getNodeRecord");async function nX(e){let t=new x3(Bi.SYSTEM_SCHEMA_NAME,Bi.SYSTEM_TABLE_NAMES.NODE_TABLE_NAME,[e]);return H3.upsert(t)}a(nX,"upsertNodeRecord");function $L(e){if(pS.isEmpty(e.subscribe)||pS.isEmpty(e.publish))throw new Error("Received invalid subscription object");let{schema:t,table:r,hash_attribute:s}=e,n={schema:t,table:r,hash_attribute:s};return e.subscribe===!0&&e.publish===!1?(n.subscribe=!1,n.publish=!0):e.subscribe===!1&&e.publish===!0?(n.subscribe=!0,n.publish=!1):(n.subscribe=e.subscribe,n.publish=e.publish),n}a($L,"reverseSubscription");function iX(e,t,r,s){let n=[];for(let i=0,o=e.length;i<o;i++){let c=e[i],{schema:u,table:_}=c,l=pS.getTableHashAttribute(u,_),{subscribe:d,publish:f}=$L(c),E=X3()[u]?.[_],h=new V3(u,_,l,f,d,c.start_time,E.schemaDefined?E.attributes:void 0);n.push(h)}return new k3(r,t,n,s)}a(iX,"buildNodePayloads");function oX(){if(!kL.get(Bi.CONFIG_PARAMS.CLUSTERING_ENABLED))throw $3(new Error,W3.CLUSTERING_NOT_ENABLED,K3.BAD_REQUEST,void 0,void 0,!0)}a(oX,"checkClusteringEnabled");async function aX(){let e=new Q3(Bi.SYSTEM_SCHEMA_NAME,Bi.SYSTEM_TABLE_NAMES.NODE_TABLE_NAME,"name","*",void 0,["*"]);return Array.from(await eX(e))}a(aX,"getAllNodeRecords");async function cX(){let e=await z3.getSystemInformation();return{hdb_version:J3.version(),node_version:e.node_version,platform:e.platform}}a(cX,"getSystemInfo")});var SS=T((Qle,ZL)=>{"use strict";var z_=_t(),KL=$(),WL=Ve(),QL=y(),J_=G(),zL=v_(),uX=qm(),{RemotePayloadObject:lX}=qc(),{handleHDBError:JL,hdb_errors:_X}=j(),{HTTP_STATUS_CODES:XL}=_X,{NodeSubscription:jL}=xo();ZL.exports=dX;async function dX(e,t){let r;try{r=await z_.request(`${t}.${WL.REQUEST_SUFFIX}`,new lX(QL.OPERATIONS_ENUM.DESCRIBE_ALL,t,void 0,void 0)),J_.trace("Response from remote describe all request:",r)}catch(o){J_.error(`addNode received error from describe all request to remote node: ${o}`);let c=z_.requestErrorHandler(o,"add_node",t);throw JL(new Error,c,XL.INTERNAL_SERVER_ERROR,"error",c)}if(r.status===WL.UPDATE_REMOTE_RESPONSE_STATUSES.ERROR){let o=`Error returned from remote node ${t}: ${r.message}`;throw JL(new Error,o,XL.INTERNAL_SERVER_ERROR,"error",o)}let s=r.message,n=[],i=[];for(let o of e){let{schema:c,table:u}=o;if(c===QL.SYSTEM_SCHEMA_NAME){await z_.createLocalTableStream(c,u);let h=new jL(c,u,o.publish,o.subscribe);h.start_time=o.start_time,i.push(h);continue}let _=KL.doesSchemaExist(c),l=s[c]!==void 0,d=u?KL.doesTableExist(c,u):!0,f=u?s?.[c]?.[u]!==void 0:!0;if(!_&&!l||!d&&!f){n.push(o);continue}if(!_&&l&&(J_.trace(`addNode creating schema: ${c}`),await zL.createSchema({operation:"create_schema",schema:c})),!d&&f){J_.trace(`addNode creating table: ${u} in schema: ${c} with attributes ${JSON.stringify(s[c][u].attributes)}`);let h=new uX(c,u,s[c][u].hash_attribute);s[c][u].attributes&&(h.attributes=s[c][u].attributes),await zL.createTable(h)}await z_.createLocalTableStream(c,u);let E=new jL(c,u,o.publish,o.subscribe);E.start_time=o.start_time,i.push(E)}return{added:i,skipped:n}}a(dX,"reviewSubscriptions")});var Z_=T((Jle,rD)=>{"use strict";var{handleHDBError:X_,hdb_errors:fX}=j(),{HTTP_STATUS_CODES:j_}=fX,{addUpdateNodeValidator:EX}=k_(),Fc=G(),tD=y(),eD=Ve(),hX=$(),TS=_t(),Gc=_n(),mX=X(),pX=SS(),{Node:SX,NodeSubscription:TX}=xo(),{broadcast:gX}=Je(),RX="Unable to create subscriptions due to schema and/or tables not existing on the local or remote node",AX="Some subscriptions were unsuccessful due to schema and/or tables not existing on the local or remote node",OX=mX.get(tD.CONFIG_PARAMS.CLUSTERING_NODENAME);rD.exports=NX;async function NX(e,t=!1){Fc.trace("addNode called with:",e),Gc.checkClusteringEnabled();let r=EX(e);if(r)throw X_(r,r.message,j_.BAD_REQUEST,void 0,void 0,!0);let s=e.node_name;if(!t){let d=await Gc.getNodeRecord(s);if(!hX.isEmptyOrZeroLength(d))throw X_(new Error,`Node '${s}' has already been added, perform update_node to proceed.`,j_.BAD_REQUEST,void 0,void 0,!0)}let{added:n,skipped:i}=await pX(e.subscriptions,s),o={message:void 0,added:n,skipped:i};if(n.length===0)return o.message=RX,o;let c=Gc.buildNodePayloads(n,OX,tD.OPERATIONS_ENUM.ADD_NODE,await Gc.getSystemInfo());Fc.trace("addNode sending remote payload:",c);let u;try{u=await TS.request(`${s}.${eD.REQUEST_SUFFIX}`,c)}catch(d){Fc.error(`addNode received error from request: ${d}`);let f=TS.requestErrorHandler(d,"add_node",s);throw X_(new Error,f,j_.INTERNAL_SERVER_ERROR,"error",f)}if(u.status===eD.UPDATE_REMOTE_RESPONSE_STATUSES.ERROR){let d=`Error returned from remote node ${s}: ${u.message}`;throw X_(new Error,d,j_.INTERNAL_SERVER_ERROR,"error",d)}Fc.trace(u);let _=[];for(let d=0,f=n.length;d<f;d++){let E=n[d];Fc.trace("Add node updating work stream for node:",s,"subscriptions:",E),await TS.updateWorkStream(E,s),n[d].start_time===void 0&&delete n[d].start_time,_.push(new TX(E.schema,E.table,E.publish,E.subscribe))}let l=new SX(s,_,u.system_info);return await Gc.upsertNodeRecord(l),gX({type:"nats_update"}),i.length>0?o.message=AX:o.message=`Successfully added '${s}' to manifest`,o}a(NX,"addNode")});var RS=T((jle,iD)=>{"use strict";var{handleHDBError:ed,hdb_errors:bX}=j(),{HTTP_STATUS_CODES:td}=bX,{addUpdateNodeValidator:yX}=k_(),xc=G(),nD=y(),sD=Ve(),IX=$(),gS=_t(),kc=_n(),wX=X(),{cloneDeep:CX}=require("lodash"),LX=SS(),{NodeSubscription:DX}=xo(),{broadcast:UX}=Je(),MX="Unable to update subscriptions due to schema and/or tables not existing on the local or remote node",PX="Some subscriptions were unsuccessful due to schema and/or tables not existing on the local or remote node",vX=wX.get(nD.CONFIG_PARAMS.CLUSTERING_NODENAME);iD.exports=BX;async function BX(e){xc.trace("updateNode called with:",e),kc.checkClusteringEnabled();let t=yX(e);if(t)throw ed(t,t.message,td.BAD_REQUEST,void 0,void 0,!0);let r=e.node_name,s=CX(await kc.getNodeRecord(r));if(IX.isEmptyOrZeroLength(s))throw ed(new Error,`Node '${r}' has not been added, perform add_node to proceed.`,td.BAD_REQUEST,void 0,void 0,!0);let{added:n,skipped:i}=await LX(e.subscriptions,r),o={message:void 0,updated:n,skipped:i};if(n.length===0)return o.message=MX,o;let c=kc.buildNodePayloads(n,vX,nD.OPERATIONS_ENUM.UPDATE_NODE,await kc.getSystemInfo());xc.trace("updateNode sending remote payload:",c);let u;try{u=await gS.request(`${r}.${sD.REQUEST_SUFFIX}`,c)}catch(_){xc.error(`updateNode received error from request: ${_}`);let l=gS.requestErrorHandler(_,"update_node",r);throw ed(new Error,l,td.INTERNAL_SERVER_ERROR,"error",l)}if(u.status===sD.UPDATE_REMOTE_RESPONSE_STATUSES.ERROR){let _=`Error returned from remote node ${r}: ${u.message}`;throw ed(new Error,_,td.INTERNAL_SERVER_ERROR,"error",_)}xc.trace(u);for(let _=0,l=n.length;_<l;_++){let d=n[_];xc.trace(`updateNode updating work stream for node: ${r} subscription:`,d),await gS.updateWorkStream(d,r),n[_].start_time===void 0&&delete n[_].start_time}return await HX(s[0],n,u.system_info),i.length>0?o.message=PX:o.message=`Successfully updated '${r}'`,o}a(BX,"updateNode");async function HX(e,t,r){let s=e;for(let n=0,i=t.length;n<i;n++){let o=t[n],c=!1;for(let u=0,_=e.subscriptions.length;u<_;u++){let l=s.subscriptions[u];if(l.schema===o.schema&&l.table===o.table){l.publish=o.publish,l.subscribe=o.subscribe,c=!0;break}}c||s.subscriptions.push(new DX(o.schema,o.table,o.publish,o.subscribe))}s.system_info=r,await kc.upsertNodeRecord(s),UX({type:"nats_update"})}a(HX,"updateNodeTable")});var lD=T((e_e,uD)=>{"use strict";var cD=require("joi"),{string:oD}=cD.types(),qX=ke(),aD=y(),FX=X(),GX=Ve();uD.exports=xX;function xX(e){let t=oD.invalid(FX.get(aD.CONFIG_PARAMS.CLUSTERING_NODENAME)).pattern(GX.NATS_TERM_CONSTRAINTS_RX).messages({"string.pattern.base":"{:#label} invalid, must not contain ., * or >","any.invalid":"'node_name' cannot be this nodes name"}).empty(null),r=cD.object({operation:oD.valid(aD.OPERATIONS_ENUM.REMOVE_NODE).required(),node_name:t});return qX.validateBySchema(e,r)}a(xX,"removeNodeValidator")});var sd=T((r_e,mD)=>{"use strict";var{handleHDBError:_D,hdb_errors:kX}=j(),{HTTP_STATUS_CODES:dD}=kX,VX=lD(),Vc=G(),fD=_n(),$X=$(),rd=y(),ED=Ve(),hD=_t(),YX=X(),{RemotePayloadObject:KX}=qc(),{NodeSubscription:WX}=xo(),QX=hc(),zX=bi(),{broadcast:JX}=Je(),XX=YX.get(rd.CONFIG_PARAMS.CLUSTERING_NODENAME);mD.exports=jX;async function jX(e){Vc.trace("removeNode called with:",e),fD.checkClusteringEnabled();let t=VX(e);if(t)throw _D(t,t.message,dD.BAD_REQUEST,void 0,void 0,!0);let r=e.node_name,s=await fD.getNodeRecord(r);if($X.isEmptyOrZeroLength(s))throw _D(new Error,`Node '${r}' was not found.`,dD.BAD_REQUEST,void 0,void 0,!0);s=s[0];let n=new KX(rd.OPERATIONS_ENUM.REMOVE_NODE,XX,[]),i,o=!1;try{i=await hD.request(`${r}.${ED.REQUEST_SUFFIX}`,n),Vc.trace("Remove node reply from remote node:",r,i)}catch(u){Vc.error("removeNode received error from request:",u),o=!0}for(let u=0,_=s.subscriptions.length;u<_;u++){let l=s.subscriptions[u];Vc.trace(`Remove node removing subscription: ${l.schema}.${l.table} for node: ${r}`);let d=new WX(l.schema,l.table,!1,!1);await hD.updateWorkStream(d,r)}let c=new QX(rd.SYSTEM_SCHEMA_NAME,rd.SYSTEM_TABLE_NAMES.NODE_TABLE_NAME,[r]);return await zX.deleteRecord(c),JX({type:"nats_update"}),i?.status===ED.UPDATE_REMOTE_RESPONSE_STATUSES.ERROR||o?(Vc.error("Error returned from remote node:",r,i?.message),`Successfully removed '${r}' from local manifest, however there was an error reaching remote node. Check the logs for more details.`):`Successfully removed '${r}' from manifest`}a(jX,"removeNode")});var TD=T((n_e,SD)=>{"use strict";var pD=require("joi"),{string:ZX,array:ej}=pD.types(),tj=ke(),rj=k_();SD.exports=sj;function sj(e){let t=pD.object({operation:ZX.valid("configure_cluster").required(),connections:ej.items(rj.validation_schema).required()});return tj.validateBySchema(e,t)}a(sj,"configureClusterValidator")});var AS=T((o_e,ND)=>{"use strict";var nj=y(),nd=G(),ij=$(),oj=sd(),aj=Z_(),gD=_n(),cj=TD(),{handleHDBError:RD,hdb_errors:uj}=j(),{HTTP_STATUS_CODES:AD}=uj,lj="Configure cluster complete.",_j="Failed to configure the cluster. Check the logs for more details.",dj="Configure cluster was partially successful. Errors occurred when attempting to configure the following nodes. Check the logs for more details.";ND.exports=fj;async function fj(e){nd.trace("configure cluster called with:",e),gD.checkClusteringEnabled();let t=cj(e);if(t)throw RD(t,t.message,AD.BAD_REQUEST,void 0,void 0,!0);let r=await gD.getAllNodeRecords(),s=[];for(let f=0,E=r.length;f<E;f++)s.push(OD(oj,{operation:nj.OPERATIONS_ENUM.REMOVE_NODE,node_name:r[f].name},r[f].name));let n=await Promise.allSettled(s);nd.trace("All results from configure_cluster remove node:",n);let i=[],o=e.connections.length;for(let f=0;f<o;f++){let E=e.connections[f];i.push(OD(aj,E,E.node_name))}let c=await Promise.allSettled(i);nd.trace("All results from configure_cluster add node:",c);let u=[],_=[],l=!1,d=n.concat(c);for(let f=0,E=d.length;f<E;f++){let h=d[f];h.status==="rejected"&&(nd.error(h.reason),u.includes(h.reason.node_name)||u.push(h.reason.node_name)),h.status==="fulfilled"&&(l=!0);let p=h?.value?.result;typeof p=="string"&&p.includes("Successfully removed")||h.status==="rejected"||_.push({node_name:h?.value?.node_name,subscriptions:h?.value?.result})}if(ij.isEmptyOrZeroLength(u))return{message:lj,connections:_};if(l)return{message:dj,failed_nodes:u,connections:_};throw RD(new Error,_j,AD.INTERNAL_SERVER_ERROR,void 0,void 0,!0)}a(fj,"configureCluster");async function OD(e,t,r){try{return{node_name:r,result:await e(t)}}catch(s){throw{node_name:r,error:s}}}a(OD,"functionWrapper")});var yD=T((c_e,bD)=>{"use strict";var id=require("joi"),Ej=ke(),{validateSchemaExists:hj,validateTableExists:mj,validateSchemaName:pj}=Ls(),Sj=id.object({operation:id.string().valid("purge_stream"),schema:id.string().custom(hj).custom(pj).required(),table:id.string().custom(mj).required()});function Tj(e){return Ej.validateBySchema(e,Sj)}a(Tj,"purgeStreamValidator");bD.exports=Tj});var OS=T((l_e,ID)=>{"use strict";var{handleHDBError:gj,hdb_errors:Rj}=j(),{HTTP_STATUS_CODES:Aj}=Rj,Oj=yD(),Nj=_t(),bj=_n();ID.exports=yj;async function yj(e){let t=Oj(e);if(t)throw gj(t,t.message,Aj.BAD_REQUEST,void 0,void 0,!0);bj.checkClusteringEnabled();let{schema:r,table:s}=e;return await Nj.purgeTableStream(r,s),`Successfully purged table '${r}.${s}'`}a(yj,"purgeStream")});var yS=T((d_e,MD)=>{"use strict";var bS=_n(),Ij=_t(),LD=X(),od=y(),Hi=Ve(),wj=$(),NS=G(),{RemotePayloadObject:Cj}=qc(),{ErrorCode:wD}=require("nats"),CD=LD.get(od.CONFIG_PARAMS.CLUSTERING_ENABLED),DD=LD.get(od.CONFIG_PARAMS.CLUSTERING_NODENAME);MD.exports={clusterStatus:Lj,buildNodeStatus:UD};async function Lj(){let e={node_name:DD,is_enabled:CD,connections:[]};if(!CD)return e;let t=await bS.getAllNodeRecords();if(wj.isEmptyOrZeroLength(t))return e;let r=[];for(let s=0,n=t.length;s<n;s++)r.push(UD(t[s],e.connections));return await Promise.allSettled(r),e}a(Lj,"clusterStatus");async function UD(e,t){let r=e.name,s=new Cj(od.OPERATIONS_ENUM.CLUSTER_STATUS,DD,void 0,await bS.getSystemInfo()),n,i,o=Hi.CLUSTER_STATUS_STATUSES.OPEN;try{let u=Date.now();n=await Ij.request(Hi.REQUEST_SUBJECT(r),s),i=Date.now()-u,n.status===Hi.UPDATE_REMOTE_RESPONSE_STATUSES.ERROR&&(o=Hi.CLUSTER_STATUS_STATUSES.CLOSED,NS.error(`Error getting node status from ${r} `,n))}catch(u){NS.warn(`Error getting node status from ${r}`,u),u.code===wD.NoResponders?o=Hi.CLUSTER_STATUS_STATUSES.NO_RESPONDERS:u.code===wD.Timeout?o=Hi.CLUSTER_STATUS_STATUSES.TIMEOUT:o=Hi.CLUSTER_STATUS_STATUSES.CLOSED}let c=new Dj(r,o,n?.message?.ports?.clustering,n?.message?.ports?.operations_api,i,n?.message?.uptime,e.subscriptions,n?.message?.system_info);try{let u={name:r,system_info:n?.message?.system_info};e.system_info?.hdb_version!==od.PRE_4_0_0_VERSION&&await bS.upsertNodeRecord(u)}catch(u){NS.error("Cluster status encountered an error updating system info for node:",r,u)}t.push(c)}a(UD,"buildNodeStatus");function Dj(e,t,r,s,n,i,o,c){this.node_name=e,this.status=t,this.ports={clustering:r,operations_api:s},this.latency_ms=n,this.uptime=i,this.subscriptions=o,this.system_info=c}a(Dj,"NodeStatusObject")});var wS=T((E_e,PD)=>{"use strict";var{handleHDBError:Uj,hdb_errors:Mj}=j(),{HTTP_STATUS_CODES:Pj}=Mj,vj=_t(),Bj=_n(),IS=$(),ad=require("joi"),Hj=ke(),qj=2e3,Fj=ad.object({timeout:ad.number().min(1),connected_nodes:ad.boolean(),routes:ad.boolean()});PD.exports=Gj;async function Gj(e){Bj.checkClusteringEnabled();let t=Hj.validateBySchema(e,Fj);if(t)throw Uj(t,t.message,Pj.BAD_REQUEST,void 0,void 0,!0);let{timeout:r,connected_nodes:s,routes:n}=e,i=s===void 0||IS.autoCastBoolean(s),o=n===void 0||IS.autoCastBoolean(n),c={nodes:[]},u=await vj.getServerList(r??qj),_={};if(i)for(let l=0,d=u.length;l<d;l++){let f=u[l].statsz;f&&(_[u[l].server.name]=f.routes)}for(let l=0,d=u.length;l<d;l++){if(u[l].statsz)continue;let f=u[l].server,E=u[l].data;if(f.name.endsWith("-hub")){let h={name:f.name.slice(0,-4),response_time:u[l].response_time};i&&(h.connected_nodes=[],_[f.name]&&_[f.name].forEach(p=>{h.connected_nodes.includes(p.name.slice(0,-4))||h.connected_nodes.push(p.name.slice(0,-4))})),o&&(h.routes=E.cluster?.urls?E.cluster?.urls.map(p=>({host:p.split(":")[0],port:IS.autoCast(p.split(":")[1])})):[]),c.nodes.push(h)}}return c}a(Gj,"clusterNetwork")});var qD=T((m_e,HD)=>{"use strict";var CS=require("joi"),vD=ke(),{route_constraints:BD}=jh();HD.exports={setRoutesValidator:xj,deleteRoutesValidator:kj};function xj(e){let t=CS.object({server:CS.valid("hub","leaf").required(),routes:BD.required()});return vD.validateBySchema(e,t)}a(xj,"setRoutesValidator");function kj(e){let t=CS.object({routes:BD.required()});return vD.validateBySchema(e,t)}a(kj,"deleteRoutesValidator")});var DS=T((S_e,kD)=>{"use strict";var qi=gr(),LS=$(),cd=y(),FD=qD(),{handleHDBError:GD,hdb_errors:Vj}=j(),{HTTP_STATUS_CODES:xD}=Vj,$j="cluster routes successfully set",Yj="cluster routes successfully deleted";kD.exports={setRoutes:Kj,getRoutes:Wj,deleteRoutes:Qj};function Kj(e){let t=FD.setRoutesValidator(e);if(t)throw GD(t,t.message,xD.BAD_REQUEST,void 0,void 0,!0);let r=qi.getClusteringRoutes(),s=e.server==="hub"?r.hub_routes:r.leaf_routes,n=e.server==="hub"?r.leaf_routes:r.hub_routes,i=[],o=[];for(let c=0,u=e.routes.length;c<u;c++){let _=e.routes[c];_.port=LS.autoCast(_.port);let l=s.some(f=>f.host===_.host&&f.port===_.port),d=n.some(f=>f.host===_.host&&f.port===_.port);l||d?i.push(_):(s.push(_),o.push(_))}return e.server==="hub"?qi.updateConfigValue(cd.CONFIG_PARAMS.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_ROUTES,s):qi.updateConfigValue(cd.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_NETWORK_ROUTES,s),{message:$j,set:o,skipped:i}}a(Kj,"setRoutes");function Wj(){let e=qi.getClusteringRoutes();return{hub:e.hub_routes,leaf:e.leaf_routes}}a(Wj,"getRoutes");function Qj(e){let t=FD.deleteRoutesValidator(e);if(t)throw GD(t,t.message,xD.BAD_REQUEST,void 0,void 0,!0);let r=qi.getClusteringRoutes(),s=r.hub_routes,n=r.leaf_routes,i=[],o=[],c=!1,u=!1;for(let _=0,l=e.routes.length;_<l;_++){let d=e.routes[_],f=!1;for(let E=0,h=s.length;E<h;E++){let p=s[E];if(d.host===p.host&&d.port===p.port){s.splice(E,1),f=!0,c=!0,i.push(d);break}}if(!f){let E=!0;for(let h=0,p=n.length;h<p;h++){let S=n[h];if(d.host===S.host&&d.port===S.port){n.splice(h,1),u=!0,E=!1,i.push(d);break}}E&&o.push(d)}}return c&&(s=LS.isEmptyOrZeroLength(s)?null:s,qi.updateConfigValue(cd.CONFIG_PARAMS.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_ROUTES,s)),u&&(n=LS.isEmptyOrZeroLength(n)?null:n,qi.updateConfigValue(cd.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_NETWORK_ROUTES,n)),{message:Yj,deleted:i,skipped:o}}a(Qj,"deleteRoutes")});var $D=T((g_e,VD)=>{"use strict";var $c=require("alasql"),Fi=require("recursive-iterator"),ps=G(),zj=$(),Yc=y(),US=class{static{a(this,"sql_statement_bucket")}constructor(t){this.ast=t,this.affected_attributes=new Map,this.table_lookup=new Map,this.schema_lookup=new Map,this.table_to_schema_lookup=new Map,Xj(this.ast,this.affected_attributes,this.table_lookup,this.schema_lookup,this.table_to_schema_lookup)}getAttributesBySchemaTableName(t,r){if(!t||!r||!this.affected_attributes)return[];if(this.affected_attributes.has(t))return!this.affected_attributes.get(t).has(r)&&(r=this.table_lookup.get(r),!r)?[]:this.affected_attributes.get(t).get(r)}getAllTables(){let t=[];if(!this.affected_attributes)return t;for(let r of this.affected_attributes.keys())t.push(Array.from(this.affected_attributes.get(r).keys()));return t}getTablesBySchemaName(t){return!t||!this.affected_attributes?[]:Array.from(this.affected_attributes.get(t).keys())}getSchemas(){return this.affected_attributes?Array.from(this.affected_attributes.keys()):[]}getAst(){return this.ast}updateAttributeWildcardsForRolePerms(t){let r=this.ast.columns.filter(n=>Yc.SEARCH_WILDCARDS.includes(n.columnid));if(r.length===0)return this.ast;let s=this.ast.from[0].databaseid;return this.ast.columns=this.ast.columns.filter(n=>!Yc.SEARCH_WILDCARDS.includes(n.columnid)),r.forEach(n=>{let i=this.table_to_schema_lookup.has(n.tableid)?this.table_to_schema_lookup.get(n.tableid):s,o=this.table_lookup.has(n.tableid)?this.table_lookup.get(n.tableid):this.ast.from[0].tableid;if(t[i]&&t[i].tables[o]&&t[i].tables[o][Yc.PERMS_CRUD_ENUM.READ]){let c;t[i].tables[o].attribute_permissions.length>0?c=Jj(t[i].tables[o].attribute_permissions):c=global.hdb_schema[i][o].attributes.map(_=>({attribute_name:_.attribute}));let u=this.affected_attributes.get(i).get(o).filter(_=>!Yc.SEARCH_WILDCARDS.includes(_));c.forEach(({attribute_name:_})=>{let l=new $c.yy.Column({columnid:_});n.tableid&&(l.tableid=n.tableid),this.ast.columns.push(l),u.includes(_)||u.push(_)}),this.affected_attributes.get(i).set(o,u)}}),this.ast}};function Jj(e){return e.filter(t=>t[Yc.PERMS_CRUD_ENUM.READ])}a(Jj,"filterReadRestrictedAttrs");function Xj(e,t,r,s,n){jj(e,t,r,s,n)}a(Xj,"interpretAST");function Kc(e,t,r,s,n){if(!(!e||!e.databaseid)&&(t.has(e.databaseid)||t.set(e.databaseid,new Map),t.get(e.databaseid).has(e.tableid)||t.get(e.databaseid).set(e.tableid,[]),e.as&&(r.has(e.as)||r.set(e.as,e.tableid),s&&!s.has(e.as)&&s.set(e.as,e.databaseid)),n)){let i=e.databaseid,o=e.tableid;e.as&&(o=e.as),n.set(o,i)}}a(Kc,"addSchemaTableToMap");function jj(e,t,r,s,n){if(!e){ps.info("getRecordAttributesAST: invalid SQL syntax tree");return}e instanceof $c.yy.Insert?rZ(e,t,r):e instanceof $c.yy.Select?Zj(e,t,r,s,n):e instanceof $c.yy.Update?eZ(e,t,r):e instanceof $c.yy.Delete?tZ(e,t,r):ps.error("AST in getRecordAttributesAST() is not a valid SQL type.")}a(jj,"getRecordAttributesAST");function Zj(e,t,r,s,n){if(!e){ps.info("getSelectAttributes: invalid SQL syntax tree");return}if(!e.from||e.from[0]===void 0)return;let i=e.from[0].databaseid;if(zj.isEmptyOrZeroLength(i)){ps.error("No schema specified");return}e.from.forEach(c=>{Kc(c,t,r,s,n)}),e.joins&&e.joins.forEach(c=>{c.as&&(c.table.as=c.as),Kc(c.table,t,r,s,n)});let o=new Fi(e.columns);for(let{node:c}of o)if(c&&c.columnid){let u=c.tableid,_=s.has(u)?s.get(u):i;if(u||(u=e.from[0].tableid),!t.get(_).has(u))if(r.has(u))u=r.get(u);else{ps.info(`table specified as ${u} not found.`);return}t.get(_).get(u).indexOf(c.columnid)<0&&t.get(_).get(u).push(c.columnid)}if(e.where){let c=new Fi(e.where),u=e.from[0].tableid;for(let{node:_}of c)if(_&&_.columnid){let l=_.tableid?_.tableid:u;if(!t.get(i).has(l))if(r.has(l))l=r.get(l);else{ps.info(`table specified as ${l} not found.`);continue}t.get(i).get(l).indexOf(_.columnid)<0&&t.get(i).get(l).push(_.columnid)}}if(e.joins&&e.joins.forEach(c=>{let u=new Fi(c.on);for(let{node:_}of u)if(_&&_.columnid){let l=_.tableid,d=n.get(l);if(!t.get(d).has(l))if(r.has(l))l=r.get(l);else{ps.info(`table specified as ${l} not found.`);continue}t.get(d).get(l).indexOf(_.columnid)<0&&t.get(d).get(l).push(_.columnid)}}),e.order){let c=new Fi(e.order);for(let{node:u}of c)if(u&&u.columnid){let _=u.tableid,l=s.has(_)?s.get(_):i;if(_||(_=e.from[0].tableid),!t.get(l).has(_))if(r.has(_))_=r.get(_);else{ps.info(`table specified as ${_} not found.`);return}t.get(l).get(_).indexOf(u.columnid)<0&&t.get(l).get(_).push(u.columnid)}}}a(Zj,"getSelectAttributes");function eZ(e,t,r){if(!e){ps.info("getUpdateAttributes: invalid SQL syntax tree");return}let s=new Fi(e.columns),n=e.table.databaseid;Kc(e.table,t,r);for(let{node:i}of s)i&&i.columnid&&MS(e.table.tableid,n,i.columnid,t,r)}a(eZ,"getUpdateAttributes");function tZ(e,t,r){if(!e){ps.info("getDeleteAttributes: invalid SQL syntax tree");return}let s=new Fi(e.where),n=e.table.databaseid;Kc(e.table,t,r);for(let{node:i}of s)i&&i.columnid&&MS(e.table.tableid,n,i.columnid,t,r)}a(tZ,"getDeleteAttributes");function rZ(e,t,r){if(!e){ps.info("getInsertAttributes: invalid SQL syntax tree");return}let s=new Fi(e.columns),n=e.into.databaseid;Kc(e.into,t,r);for(let{node:i}of s)i&&i.columnid&&MS(e.into.tableid,n,i.columnid,t,r)}a(rZ,"getInsertAttributes");function MS(e,t,r,s,n){if(!s.get(t))return;let i=e;s.get(t).has(i)||(i=n.get(i)),s.get(t).get(i).push(r)}a(MS,"pushAttribute");VD.exports=US});var BS=T((A_e,QD)=>{var ud=ic(),YD=require("chalk"),yr=G(),KD=require("prompt"),{promisify:sZ}=require("util"),PS=y(),nZ=require("fs-extra"),iZ=require("path"),oZ=$(),aZ=mS(),WD=X();WD.initSync();var cZ=require("moment"),uZ=sZ(KD.get),lZ=iZ.join(WD.getHdbBasePath(),PS.LICENSE_KEY_DIR_NAME,PS.LICENSE_FILE_NAME,PS.LICENSE_FILE_NAME);QD.exports={getFingerprint:dZ,setLicense:_Z,parseLicense:vS,register:fZ,getRegistrationInfo:hZ};async function _Z(e){if(e&&e.key&&e.company){try{yr.info(`parsing license key: ${e.key} and `);let t=e.company.toString();await vS(e.key.trim(),t.trim())}catch(t){let r="There was an error parsing the license key.";throw yr.error(r),yr.error(t),new Error(r)}return"Wrote license key file.  Registration successful."}throw new Error("Invalid key or company specified for license file.")}a(_Z,"setLicense");async function dZ(){let e={};try{e=await ud.generateFingerPrint()}catch(t){let r="Error generating fingerprint.";throw yr.error(r),yr.error(t),new Error(r)}return e}a(dZ,"getFingerprint");async function vS(e,t){if(!e||!t)throw new Error("Invalid entries for License Key and Customer Company");yr.info("Validating license input...");let r=ud.validateLicense(e,t);if(yr.info("checking for valid license..."),!r.valid_license)throw new Error("Invalid license found.");if(yr.info("checking valid license date..."),!r.valid_date)throw new Error("This License has expired.");if(yr.info(`checking for valid machine license ${r.valid_machine}`),!r.valid_machine)throw new Error("This license is in use on another machine.");try{yr.info("writing license to disk"),await nZ.writeFile(lZ,JSON.stringify({license_key:e,company:t}))}catch(s){throw yr.error("Failed to write License"),s}return"Registration successful."}a(vS,"parseLicense");async function fZ(){let e=await EZ();return vS(e.HDB_LICENSE,e.CUSTOMER_COMPANY)}a(fZ,"register");async function EZ(){let e=await ud.generateFingerPrint(),t={properties:{CUSTOMER_COMPANY:{description:YD.magenta("[COMPANY] Please enter your company name"),required:!0},HDB_LICENSE:{description:YD.magenta(`[HDB_LICENSE] Your fingerprint is ${e} Please enter your license key`),required:!0}}};try{KD.start()}catch(s){yr.error(s)}let r;try{r=await uZ(t)}catch(s){throw console.error("There was a problem prompting for registration input.  Exiting."),s}return r}a(EZ,"promptForRegistration");async function hZ(){let e={registered:!1,version:null,ram_allocation:null,license_expiration_date:null},t;try{t=await ud.getLicense()}catch(r){throw yr.error(`There was an error when searching licenses due to: ${r.message}`),r}if(oZ.isEmptyOrZeroLength(t))throw new Error("There were no licenses found.");if(e.registered=t.enterprise,e.version=aZ.version(),e.ram_allocation=t.ram_allocation,isNaN(t.exp_date))e.license_expiration_date=t.enterprise?t.exp_date:null;else{let r=cZ.utc(t.exp_date).format("YYYY-MM-DD");e.license_expiration_date=t.enterprise?r:null}return e}a(hZ,"getRegistrationInfo")});var JD=T((N_e,zD)=>{"use strict";var mZ=Ve(),HS=class{static{a(this,"HubConfigObject")}constructor(t,r,s,n,i,o,c,u,_,l,d,f,E,h){this.port=t,o===null&&(o=void 0),this.server_name=r+mZ.SERVER_SUFFIX.HUB,this.pid_file=s,this.max_payload=67108864,this.jetstream={enabled:!1},this.tls={cert_file:n,key_file:i,ca_file:o,insecure:c,verify:u},this.leafnodes={port:_,tls:{cert_file:n,key_file:i,ca_file:o,insecure:c}},this.cluster={name:l,port:d,routes:f,tls:{cert_file:n,key_file:i,ca_file:o,insecure:c,verify:u}},this.accounts={SYS:{users:E},HDB:{users:h}},this.system_account="SYS"}};zD.exports=HS});var ZD=T((y_e,jD)=>{"use strict";var XD=Ve(),qS=class{static{a(this,"LeafConfigObject")}constructor(t,r,s,n,i,o,c,u,_,l,d){this.port=t,d===null&&(d=void 0),this.server_name=r+XD.SERVER_SUFFIX.LEAF,this.pid_file=s,this.max_payload=67108864,this.jetstream={enabled:!0,store_dir:n,domain:r+XD.SERVER_SUFFIX.LEAF},this.tls={cert_file:_,key_file:l,ca_file:d,insecure:!0},this.leafnodes={remotes:[{tls:{ca_file:d,insecure:!0},urls:i,account:"SYS"},{tls:{ca_file:d,insecure:!0},urls:o,account:"HDB"}]},this.accounts={SYS:{users:c},HDB:{users:u,jetstream:"enabled"}},this.system_account="SYS"}};jD.exports=qS});var tU=T((w_e,eU)=>{"use strict";var FS=class{static{a(this,"HdbUserObject")}constructor(t,r){this.user=t,this.password=r}};eU.exports=FS});var sU=T((L_e,rU)=>{"use strict";var pZ=Ve(),GS=class{static{a(this,"SysUserObject")}constructor(t,r){this.user=t+pZ.SERVER_SUFFIX.ADMIN,this.password=r}};rU.exports=GS});var VS=T((U_e,oU)=>{"use strict";var Vo=require("path"),dd=require("fs-extra"),SZ=JD(),TZ=ZD(),gZ=tU(),RZ=sU(),xS=xr(),Yo=$(),nr=gr(),_d=y(),Wc=Ve(),{CONFIG_PARAMS:Ze}=_d,Qc=G(),zc=X(),nU=sn(),kS=_t(),$o="clustering",AZ=1e4,iU=5;oU.exports={generateNatsConfig:NZ,removeNatsConfig:bZ,getHubConfigPath:OZ};function OZ(){let e=zc.get(Ze.ROOTPATH);return Vo.join(e,$o,Wc.NATS_CONFIG_FILES.HUB_SERVER)}a(OZ,"getHubConfigPath");async function NZ(e=!1,t=void 0){zc.initSync();let r=zc.get(Ze.ROOTPATH),s=Vo.join(r,$o,Wc.PID_FILES.HUB),n=Vo.join(r,$o,Wc.PID_FILES.LEAF),i=nr.getConfigFromFile(Ze.CLUSTERING_LEAFSERVER_STREAMS_PATH),o=Vo.join(r,$o,Wc.NATS_CONFIG_FILES.HUB_SERVER),c=Vo.join(r,$o,Wc.NATS_CONFIG_FILES.LEAF_SERVER),u=nr.getConfigFromFile(Ze.CLUSTERING_TLS_CERTIFICATE),_=nr.getConfigFromFile(Ze.CLUSTERING_TLS_PRIVATEKEY),l=nr.getConfigFromFile(Ze.CLUSTERING_TLS_CERT_AUTH),d=nr.getConfigFromFile(Ze.CLUSTERING_TLS_INSECURE),f=nr.getConfigFromFile(Ze.CLUSTERING_TLS_VERIFY),E=nr.getConfigFromFile(Ze.CLUSTERING_NODENAME),h=nr.getConfigFromFile(Ze.CLUSTERING_HUBSERVER_LEAFNODES_NETWORK_PORT);await kS.checkNATSServerInstalled()||fd("nats-server dependency is either missing or the wrong version. Run 'npm install' to fix");let p=await xS.listUsers(),S=nr.getConfigFromFile(Ze.CLUSTERING_USER),g=await xS.getClusterUser();(Yo.isEmpty(g)||g.active!==!0)&&fd(`Invalid cluster user '${S}'. A valid user with the role 'cluster_user' must be defined under clustering.user in harperdb-config.yaml`),e||(await ld(Ze.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_PORT),await ld(Ze.CLUSTERING_HUBSERVER_LEAFNODES_NETWORK_PORT),await ld(Ze.CLUSTERING_HUBSERVER_NETWORK_PORT),await ld(Ze.CLUSTERING_LEAFSERVER_NETWORK_PORT));let b=[],O=[];for(let[x,te]of p.entries())te.role.role===_d.ROLE_TYPES_ENUM.CLUSTER_USER&&te.active&&(b.push(new RZ(te.username,nU.decrypt(te.hash))),O.push(new gZ(te.username,nU.decrypt(te.hash))));let Y=[],{hub_routes:Q}=nr.getClusteringRoutes();if(!Yo.isEmptyOrZeroLength(Q))for(let x of Q)Y.push(`tls://${g.sys_name_encoded}:${g.uri_encoded_d_hash}@${x.host}:${x.port}`);let F=new SZ(nr.getConfigFromFile(Ze.CLUSTERING_HUBSERVER_NETWORK_PORT),E,s,u,_,l,d,f,h,nr.getConfigFromFile(Ze.CLUSTERING_HUBSERVER_CLUSTER_NAME),nr.getConfigFromFile(Ze.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_PORT),Y,b,O);l==null&&(delete F.tls.ca_file,delete F.leafnodes.tls.ca_file),t=Yo.isEmpty(t)?void 0:t.toLowerCase(),(t===void 0||t===_d.PROCESS_DESCRIPTORS.CLUSTERING_HUB.toLowerCase())&&(await dd.writeJson(o,F),Qc.trace(`Hub server config written to ${o}`));let w=`tls://${g.sys_name_encoded}:${g.uri_encoded_d_hash}@0.0.0.0:${h}`,K=`tls://${g.uri_encoded_name}:${g.uri_encoded_d_hash}@0.0.0.0:${h}`,B=new TZ(nr.getConfigFromFile(Ze.CLUSTERING_LEAFSERVER_NETWORK_PORT),E,n,i,[w],[K],b,O,u,_,l,d);l==null&&delete B.tls.ca_file,(t===void 0||t===_d.PROCESS_DESCRIPTORS.CLUSTERING_LEAF.toLowerCase())&&(await dd.writeJson(c,B),Qc.trace(`Leaf server config written to ${c}`))}a(NZ,"generateNatsConfig");async function ld(e){let t=zc.get(e);return Yo.isEmpty(t)&&fd(`port undefined for '${e}'`),await Yo.isPortTaken(t)&&fd(`'${e}' port '${t}' is is in use by another process, check to see if HarperDB is already running or another process is using this port.`),!0}a(ld,"isPortAvailable");function fd(e){let t=`Error generating clustering config: ${e}`;Qc.error(t),console.error(t),process.exit(1)}a(fd,"generateNatsConfigError");async function bZ(e){let{port:t,config_file:r}=kS.getServerConfig(e),{username:s,decrypt_hash:n}=await xS.getClusterUser(),i=0,o=2e3;for(;i<iU;){try{let _=await kS.createConnection(t,s,n,!1);if(_.protocol.connected===!0){_.close();break}}catch(_){Qc.trace(`removeNatsConfig waiting for ${e}. Caught and swallowed error ${_}`)}if(i++,i>=iU)throw new Error(`Operations API timed out attempting to connect to ${e}. This is commonly caused by incorrect clustering config. Check hdb.log for further details.`);await Yo.async_set_timeout(o*(i*2))}let c="0".repeat(AZ),u=Vo.join(zc.get(Ze.ROOTPATH),$o,r);await dd.writeFile(u,c),await dd.remove(u),Qc.notify(e,"started.")}a(bZ,"removeNatsConfig")});var dU=T((P_e,_U)=>{"use strict";var Ir=X(),yZ=ic(),ce=y(),Jc=Ve(),dn=require("path"),{PACKAGE_ROOT:hd}=y(),aU=X(),Ed=$(),Ko="/dev/null",IZ=dn.join(hd,"launchServiceScripts"),cU=dn.join(hd,"utility/scripts"),wZ=dn.join(cU,ce.HDB_RESTART_SCRIPT),uU=dn.resolve(hd,"dependencies",`${process.platform}-${process.arch}`,Jc.NATS_BINARY_NAME);function lU(){let t=yZ.licenseSearch().ram_allocation||ce.RAM_ALLOCATION_ENUM.DEFAULT,r=ce.MEM_SETTING_KEY+t,s={[ce.PROCESS_NAME_ENV_PROP]:ce.PROCESS_DESCRIPTORS.HDB,IS_SCRIPTED_SERVICE:!0};return Ed.noBootFile()&&(s[ce.CONFIG_PARAMS.ROOTPATH.toUpperCase()]=Ed.getEnvCliRootPath()),{name:ce.PROCESS_DESCRIPTORS.HDB,script:ce.LAUNCH_SERVICE_SCRIPTS.MAIN,exec_mode:"fork",env:s,node_args:r,cwd:hd}}a(lU,"generateMainServerConfig");var CZ=9930;function LZ(){Ir.initSync(!0);let e=Ir.get(ce.CONFIG_PARAMS.ROOTPATH),t=dn.join(e,"clustering",Jc.NATS_CONFIG_FILES.HUB_SERVER),r=dn.join(Ir.get(ce.HDB_SETTINGS_NAMES.LOG_PATH_KEY),ce.LOG_NAMES.HDB),s=aU.get(ce.CONFIG_PARAMS.CLUSTERING_HUBSERVER_NETWORK_PORT),n=Jc.LOG_LEVEL_FLAGS[Ir.get(ce.CONFIG_PARAMS.CLUSTERING_LOGLEVEL)]??void 0,i={name:ce.PROCESS_DESCRIPTORS.CLUSTERING_HUB+(s!==CZ?"-"+s:""),script:uU,args:n?`${n} -c ${t}`:`-c ${t}`,exec_mode:"fork",env:{[ce.PROCESS_NAME_ENV_PROP]:ce.PROCESS_DESCRIPTORS.CLUSTERING_HUB},merge_logs:!0,out_file:r,error_file:r,instances:1};return Ir.get(ce.HDB_SETTINGS_NAMES.LOG_TO_FILE)||(i.out_file=Ko,i.error_file=Ko),i}a(LZ,"generateNatsHubServerConfig");var DZ=9940;function UZ(){Ir.initSync(!0);let e=Ir.get(ce.CONFIG_PARAMS.ROOTPATH),t=dn.join(e,"clustering",Jc.NATS_CONFIG_FILES.LEAF_SERVER),r=dn.join(Ir.get(ce.HDB_SETTINGS_NAMES.LOG_PATH_KEY),ce.LOG_NAMES.HDB),s=aU.get(ce.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_NETWORK_PORT),n=Jc.LOG_LEVEL_FLAGS[Ir.get(ce.CONFIG_PARAMS.CLUSTERING_LOGLEVEL)]??void 0,i={name:ce.PROCESS_DESCRIPTORS.CLUSTERING_LEAF+(s!==DZ?"-"+s:""),script:uU,args:n?`${n} -c ${t}`:`-c ${t}`,exec_mode:"fork",env:{[ce.PROCESS_NAME_ENV_PROP]:ce.PROCESS_DESCRIPTORS.CLUSTERING_LEAF},merge_logs:!0,out_file:r,error_file:r,instances:1};return Ir.get(ce.HDB_SETTINGS_NAMES.LOG_TO_FILE)||(i.out_file=Ko,i.error_file=Ko),i}a(UZ,"generateNatsLeafServerConfig");function MZ(){Ir.initSync();let e=dn.join(Ir.get(ce.CONFIG_PARAMS.LOGGING_ROOT),ce.LOG_NAMES.HDB),t={name:ce.PROCESS_DESCRIPTORS.CLUSTERING_UPGRADE_4_0_0,script:ce.LAUNCH_SERVICE_SCRIPTS.NODES_UPGRADE_4_0_0,exec_mode:"fork",env:{[ce.PROCESS_NAME_ENV_PROP]:ce.PROCESS_DESCRIPTORS.CLUSTERING_UPGRADE_4_0_0},merge_logs:!0,out_file:e,error_file:e,instances:1,cwd:IZ,autorestart:!1};return Ir.get(ce.HDB_SETTINGS_NAMES.LOG_TO_FILE)||(t.out_file=Ko,t.error_file=Ko),t}a(MZ,"generateClusteringUpgradeV4ServiceConfig");function PZ(){let e={[ce.PROCESS_NAME_ENV_PROP]:ce.PROCESS_DESCRIPTORS.RESTART_HDB};return Ed.noBootFile()&&(e[ce.CONFIG_PARAMS.ROOTPATH.toUpperCase()]=Ed.getEnvCliRootPath()),{...{name:ce.PROCESS_DESCRIPTORS.RESTART_HDB,exec_mode:"fork",env:e,instances:1,autorestart:!1,cwd:cU},script:wZ}}a(PZ,"generateRestart");function vZ(){return{apps:[lU()]}}a(vZ,"generateAllServiceConfigs");_U.exports={generateAllServiceConfigs:vZ,generateMainServerConfig:lU,generateRestart:PZ,generateNatsHubServerConfig:LZ,generateNatsLeafServerConfig:UZ,generateClusteringUpgradeV4ServiceConfig:MZ}});var yU=T((H_e,bU)=>{"use strict";var Ae=y(),BZ=$(),fn=VS(),Xc=_t(),Fs=Ve(),jn=dU(),md=X(),Zn=G(),HZ=_n(),{startWorker:fU,onMessageFromWorkers:qZ}=Je(),FZ=ko(),B_e=require("util"),GZ=require("child_process"),xZ=require("fs"),{execFile:kZ}=GZ,pe;bU.exports={enterPM2Mode:VZ,start:ei,stop:$S,reload:hU,restart:mU,list:YS,describe:SU,connect:En,kill:QZ,startAllServices:zZ,startService:KS,getUniqueServicesList:TU,restartAllServices:JZ,isServiceRegistered:gU,reloadStopStart:RU,restartHdb:pU,deleteProcess:KZ,startClusteringProcesses:OU,startClusteringThreads:NU,isHdbRestartRunning:WZ,isClusteringRunning:jZ,stopClustering:XZ,reloadClustering:ZZ};var jc=!1;qZ(e=>{e.type==="restart"&&md.initSync(!0)});function VZ(){jc=!0}a(VZ,"enterPM2Mode");function En(){return pe||(pe=require("pm2")),new Promise((e,t)=>{pe.connect((r,s)=>{Zn.setupConsoleLogging(),r&&t(r),e(s)})})}a(En,"connect");var ir,$Z=10,EU;function ei(e,t=!1){if(jc)return YZ(e);let r=kZ(e.script,e.args.split(" "),e);r.name=e.name,r.on("exit",async i=>{let o=ir.indexOf(r);o>-1&&ir.splice(o,1),!EU&&i!==0&&(e.restarts=(e.restarts||0)+1,e.restarts<$Z&&(xZ.existsSync(fn.getHubConfigPath())?ei(e):(await fn.generateNatsConfig(!0),ei(e),await new Promise(c=>setTimeout(c,3e3)),await fn.removeNatsConfig(Ae.PROCESS_DESCRIPTORS.CLUSTERING_HUB),await fn.removeNatsConfig(Ae.PROCESS_DESCRIPTORS.CLUSTERING_LEAF))))});let s={serviceName:e.name.replace(/ /g,"-")};function n(i){let o=md.get(Ae.CONFIG_PARAMS.CLUSTERING_LOGLEVEL),c=/\[\d+][^\[]+\[(\w+)]/g,u,_=0,l;for(;u=c.exec(i);){if(u.index&&Fs.LOG_LEVEL_HIERARCHY[o]>=Fs.LOG_LEVEL_HIERARCHY[l||"info"]){let E=l===Fs.LOG_LEVELS.ERR||l===Fs.LOG_LEVELS.WRN?Zn.OUTPUTS.STDERR:Zn.OUTPUTS.STDOUT;Zn.logCustomLevel(l||"info",E,s,i.slice(_,u.index).trim())}let[d,f]=u;_=u.index+d.length,l=Fs.LOG_LEVELS[f]}if(Fs.LOG_LEVEL_HIERARCHY[o]>=Fs.LOG_LEVEL_HIERARCHY[l||"info"]){let d=l===Fs.LOG_LEVELS.ERR||l===Fs.LOG_LEVELS.WRN?Zn.OUTPUTS.STDERR:Zn.OUTPUTS.STDOUT;Zn.logCustomLevel(l||"info",d,s,i.slice(_).trim())}}if(a(n,"extractMessages"),r.stdout.on("data",n),r.stderr.on("data",n),r.unref(),ir=[],!ir&&!t){let i=a(()=>{EU=!0,ir&&(ir.map(o=>o.kill()),process.exit(0))},"kill_children");process.on("exit",i),process.on("SIGINT",i),process.on("SIGQUIT",i),process.on("SIGTERM",i)}ir.push(r)}a(ei,"start");function YZ(e){return new Promise(async(t,r)=>{try{await En()}catch(s){r(s)}pe.start(e,(s,n)=>{s&&(pe.disconnect(),r(s)),pe.disconnect(),t(n)})})}a(YZ,"startWithPM2");function $S(e){if(!jc){for(let t of ir||[])t.name===e&&(ir.splice(ir.indexOf(t),1),t.kill());return}return new Promise(async(t,r)=>{try{await En()}catch(s){r(s)}pe.stop(e,async(s,n)=>{s&&(pe.disconnect(),r(s)),pe.delete(e,(i,o)=>{i&&(pe.disconnect(),r(s)),pe.disconnect(),t(o)})})})}a($S,"stop");function hU(e){return new Promise(async(t,r)=>{try{await En()}catch(s){r(s)}pe.reload(e,(s,n)=>{s&&(pe.disconnect(),r(s)),pe.disconnect(),t(n)})})}a(hU,"reload");function mU(e){if(!jc)for(let t of ir||[])t.name===e&&t.kill();return new Promise(async(t,r)=>{try{await En()}catch(s){r(s)}pe.restart(e,(s,n)=>{pe.disconnect(),t(n)})})}a(mU,"restart");function KZ(e){return new Promise(async(t,r)=>{try{await En()}catch(s){r(s)}pe.delete(e,(s,n)=>{s&&(pe.disconnect(),r(s)),pe.disconnect(),t(n)})})}a(KZ,"deleteProcess");async function pU(){await ei(jn.generateRestart())}a(pU,"restartHdb");async function WZ(){let e=await YS();for(let t in e)if(e[t].name===Ae.PROCESS_DESCRIPTORS.RESTART_HDB)return!0;return!1}a(WZ,"isHdbRestartRunning");function YS(){return new Promise(async(e,t)=>{try{await En()}catch(r){t(r)}pe.list((r,s)=>{r&&(pe.disconnect(),t(r)),pe.disconnect(),e(s)})})}a(YS,"list");function SU(e){return new Promise(async(t,r)=>{try{await En()}catch(s){r(s)}pe.describe(e,(s,n)=>{s&&(pe.disconnect(),r(s)),pe.disconnect(),t(n)})})}a(SU,"describe");function QZ(){if(!jc){for(let e of ir||[])e.kill();ir=[];return}return new Promise(async(e,t)=>{try{await En()}catch(r){t(r)}pe.killDaemon((r,s)=>{r&&(pe.disconnect(),t(r)),pe.disconnect(),e(s)})})}a(QZ,"kill");async function zZ(){try{await OU(),await NU(),await ei(jn.generateAllServiceConfigs())}catch(e){throw pe?.disconnect(),e}}a(zZ,"startAllServices");async function KS(e,t=!1){try{let r;switch(e=e.toLowerCase(),e){case Ae.PROCESS_DESCRIPTORS.HDB.toLowerCase():r=jn.generateMainServerConfig();break;case Ae.PROCESS_DESCRIPTORS.CLUSTERING_INGEST_SERVICE.toLowerCase():r=jn.generateNatsIngestServiceConfig();break;case Ae.PROCESS_DESCRIPTORS.CLUSTERING_REPLY_SERVICE.toLowerCase():r=jn.generateNatsReplyServiceConfig();break;case Ae.PROCESS_DESCRIPTORS.CLUSTERING_HUB.toLowerCase():r=jn.generateNatsHubServerConfig(),await ei(r,t),await fn.removeNatsConfig(e);return;case Ae.PROCESS_DESCRIPTORS.CLUSTERING_LEAF.toLowerCase():r=jn.generateNatsLeafServerConfig(),await ei(r,t),await fn.removeNatsConfig(e);return;case Ae.PROCESS_DESCRIPTORS.CLUSTERING_UPGRADE_4_0_0.toLowerCase():r=jn.generateClusteringUpgradeV4ServiceConfig();break;default:throw new Error(`Start service called with unknown service config: ${e}`)}await ei(r)}catch(r){throw pe?.disconnect(),r}}a(KS,"startService");async function TU(){try{let e=await YS(),t={};for(let r=0,s=e.length;r<s;r++){let n=e[r];t[n.name]===void 0&&(t[n.name]={name:n.name,exec_mode:n.pm2_env.exec_mode})}return t}catch(e){throw pe?.disconnect(),e}}a(TU,"getUniqueServicesList");async function JZ(e=[]){try{let t=!1,r=await TU();for(let s=0,n=Object.values(r).length;s<n;s++){let o=Object.values(r)[s].name;e.includes(o)||(o===Ae.PROCESS_DESCRIPTORS.HDB?t=!0:await mU(o))}t&&await RU(Ae.PROCESS_DESCRIPTORS.HDB)}catch(t){throw pe?.disconnect(),t}}a(JZ,"restartAllServices");async function gU(e){if(ir?.find(r=>r.name===e))return!0;let t=await FZ.getHDBProcessInfo();return t.core.length&&t.core[0]?.parent==="PM2"}a(gU,"isServiceRegistered");async function RU(e){let t=e===Ae.PROCESS_DESCRIPTORS.HDB?md.get(Ae.HDB_SETTINGS_NAMES.MAX_HDB_PROCESSES):md.get(Ae.HDB_SETTINGS_NAMES.MAX_CUSTOM_FUNCTION_PROCESSES),r=await SU(e),s=BZ.isEmptyOrZeroLength(r)?0:r.length;t!==s?(await $S(e),await KS(e)):e===Ae.PROCESS_DESCRIPTORS.HDB?await pU():await hU(e)}a(RU,"reloadStopStart");var AU;async function OU(e=!1){for(let t in Ae.CLUSTERING_PROCESSES){let r=Ae.CLUSTERING_PROCESSES[t];await KS(r,e)}}a(OU,"startClusteringProcesses");async function NU(){AU=fU(Ae.LAUNCH_SERVICE_SCRIPTS.NATS_REPLY_SERVICE,{name:Ae.PROCESS_DESCRIPTORS.CLUSTERING_REPLY_SERVICE}),await Xc.createWorkQueueStream(Fs.WORK_QUEUE_CONSUMER_NAMES),await Xc.updateIngestStreamConsumer(),await Xc.updateLocalStreams();let e=await HZ.getAllNodeRecords();for(let t=0,r=e.length;t<r;t++)if(e[t].system_info?.hdb_version===Ae.PRE_4_0_0_VERSION){Zn.info("Starting clustering upgrade 4.0.0 process"),fU(Ae.LAUNCH_SERVICE_SCRIPTS.NODES_UPGRADE_4_0_0,{name:"Upgrade-4-0-0"});break}}a(NU,"startClusteringThreads");async function XZ(){for(let e in Ae.CLUSTERING_PROCESSES)if(e!==Ae.CLUSTERING_PROCESSES.CLUSTERING_INGEST_PROC_DESCRIPTOR)if(e===Ae.CLUSTERING_PROCESSES.CLUSTERING_REPLY_SERVICE_DESCRIPTOR)await AU.terminate();else{let t=Ae.CLUSTERING_PROCESSES[e];await $S(t)}}a(XZ,"stopClustering");async function jZ(){for(let e in Ae.CLUSTERING_PROCESSES){let t=Ae.CLUSTERING_PROCESSES[e];if(await gU(t)===!1)return!1}return!0}a(jZ,"isClusteringRunning");async function ZZ(){await fn.generateNatsConfig(!0),await Xc.reloadNATSHub(),await Xc.reloadNATSLeaf(),await fn.removeNatsConfig(Ae.PROCESS_DESCRIPTORS.CLUSTERING_HUB.toLowerCase()),await fn.removeNatsConfig(Ae.PROCESS_DESCRIPTORS.CLUSTERING_LEAF.toLowerCase())}a(ZZ,"reloadClustering")});var gd=T((F_e,MU)=>{"use strict";var e5=require("minimist"),{isMainThread:zS,parentPort:CU}=require("worker_threads"),$e=y(),{PROCESS_DESCRIPTORS_VALIDATE:Zc}=$e,Gs=G(),JS=$(),pd=VS(),Wo=_t(),WS=Ve(),LU=gr(),xs=yU(),IU=ko(),t5=EE(),{restartWorkers:Sd,onMessageByType:r5}=Je(),{handleHDBError:s5,hdb_errors:n5}=j(),{HTTP_STATUS_CODES:i5}=n5,Td=X();Td.initSync();var eu=`Restarting HarperDB. This may take up to ${$e.RESTART_TIMEOUT_MS/1e3} seconds.`,o5="Restart is not available from the CLI when running in non-pm2 mode. Either call restart from the API or stop and start HarperDB.",wU="Clustering is not enabled so cannot be restarted",a5="Invalid service",Qo,Yr;MU.exports={restart:DU,restartService:XS};zS&&r5($e.ITC_EVENT_TYPES.RESTART,e=>{e.workerType?XS({service:e.workerType}):DU({operation:"restart"})});async function DU(e){Yr=Object.keys(e).length===0,Qo=await xs.isServiceRegistered($e.HDB_PROC_DESCRIPTOR);let t=e5(process.argv);if(t.service){await XS(t);return}if(Yr&&!Qo){console.error(o5);return}if(Yr&&console.log(eu),Qo){xs.enterPM2Mode(),Gs.notify(eu);let r=t5(Object.keys($e.CONFIG_PARAM_MAP),!0);return JS.isEmptyOrZeroLength(Object.keys(r))||LU.updateConfigValue(void 0,void 0,r,!0,!0),u5(),eu}return zS?(Gs.notify(eu),setTimeout(()=>{Sd()},50)):CU.postMessage({type:$e.ITC_EVENT_TYPES.RESTART}),eu}a(DU,"restart");async function XS(e){let{service:t}=e;if($e.PROCESS_DESCRIPTORS_VALIDATE[t]===void 0)throw s5(new Error,a5,i5.BAD_REQUEST,void 0,void 0,!0);if(Qo=await xs.isServiceRegistered($e.HDB_PROC_DESCRIPTOR),!zS)return CU.postMessage({type:$e.ITC_EVENT_TYPES.RESTART,workerType:t}),t==="custom_functions"&&(t="Custom Functions"),`Restarting ${t}`;let r;switch(t){case Zc.clustering:if(!Td.get($e.CONFIG_PARAMS.CLUSTERING_ENABLED)){r=wU;break}Yr&&console.log("Restarting clustering"),Gs.notify("Restarting clustering"),await UU();break;case Zc.clustering_config:case Zc["clustering config"]:if(!Td.get($e.CONFIG_PARAMS.CLUSTERING_ENABLED)){r=wU;break}Yr&&console.log("Restarting clustering_config"),Gs.notify("Restarting clustering_config"),await xs.reloadClustering();break;case"custom_functions":case"custom functions":case Zc.harperdb:case Zc.http_workers:if(Yr&&!Qo){r=`Restart ${t} is not available from the CLI when running in non-pm2 mode. Either call restart ${t} from the API or stop and start HarperDB.`;break}Yr&&console.log("Restarting http_workers"),Gs.notify("Restarting http_workers"),Yr?await xs.restart($e.HDB_PROC_DESCRIPTOR):setTimeout(()=>{Sd("http")},200);break;default:r=`Unrecognized service: ${t}`;break}return r?(Gs.error(r),Yr&&console.error(r),r):(t==="custom_functions"&&(t="Custom Functions"),`Restarting ${t}`)}a(XS,"restartService");async function c5(){await Wo.publishToStream(`${WS.SUBJECT_PREFIXES.TXN}.${WS.WORK_QUEUE_CONSUMER_NAMES.stream_name}`,WS.WORK_QUEUE_CONSUMER_NAMES.stream_name,Wo.addNatsMsgHeader({operation:"dummy_msg"},void 0),{operation:"dummy_msg"})}a(c5,"postDummyNatsMsg");async function u5(){await UU(),await xs.restart($e.HDB_PROC_DESCRIPTOR),await JS.async_set_timeout(2e3),Td.get($e.CONFIG_PARAMS.CLUSTERING_ENABLED)&&await QS(),Yr&&(await Wo.closeConnection(),process.exit(0))}a(u5,"restartPM2Mode");async function UU(){if(!LU.getConfigFromFile($e.CONFIG_PARAMS.CLUSTERING_ENABLED))return;if((await IU.getHDBProcessInfo()).clustering.length===0)Gs.trace("Clustering not running, restart will start clustering services"),await pd.generateNatsConfig(!0),await xs.startClusteringProcesses(),await xs.startClusteringThreads(),await QS(),Yr&&await Wo.closeConnection();else{await c5(),await pd.generateNatsConfig(!0),Qo?(Gs.trace("Restart clustering restarting PM2 managed Hub and Leaf servers"),await xs.restart($e.PROCESS_DESCRIPTORS.CLUSTERING_HUB),await xs.restart($e.PROCESS_DESCRIPTORS.CLUSTERING_LEAF)):(await IU.getHDBProcessInfo()).clustering.forEach(n=>{Gs.trace("Restart clustering killing process pid",n.pid),process.kill(n.pid)}),await JS.async_set_timeout(3e3),await QS(),await Wo.updateLocalStreams(),Yr&&await Wo.closeConnection(),Gs.trace("Restart clustering restarting ingest and reply service threads");let t=Sd($e.LAUNCH_SERVICE_SCRIPTS.NATS_INGEST_SERVICE),r=Sd($e.LAUNCH_SERVICE_SCRIPTS.NATS_REPLY_SERVICE);await t,await r}}a(UU,"restartClustering");async function QS(){await pd.removeNatsConfig($e.PROCESS_DESCRIPTORS.CLUSTERING_HUB),await pd.removeNatsConfig($e.PROCESS_DESCRIPTORS.CLUSTERING_LEAF)}a(QS,"removeNatsConfig")});var $U=T((k_e,VU)=>{"use strict";var x_e=require("lodash"),or=y(),{handleHDBError:PU,hdb_errors:l5}=j(),{HDB_ERROR_MSGS:_5,HTTP_STATUS_CODES:d5}=l5,jS=G();VU.exports={getRolePermissions:E5};var Gi=Object.create(null),f5=a(e=>({key:e,perms:{}}),"perms_template_obj"),qU=a((e=!1)=>({describe:e,tables:{}}),"schema_perms_template"),FU=a((e=!1,t=!1,r=!1,s=!1)=>({[or.PERMS_CRUD_ENUM.READ]:e,[or.PERMS_CRUD_ENUM.INSERT]:t,[or.PERMS_CRUD_ENUM.UPDATE]:r,[or.PERMS_CRUD_ENUM.DELETE]:s}),"permissions_template"),ZS=a((e=!1,t=!1,r=!1,s=!1,n=!1)=>({attribute_permissions:[],describe:e,...FU(t,r,s,n)}),"table_perms_template"),vU=a((e,t=FU())=>({attribute_name:e,describe:kU(t),[tu]:t[tu],[eT]:t[eT],[tT]:t[tT]}),"attr_perms_template"),BU=a((e,t=!1)=>({attribute_name:e,describe:t,[tu]:t}),"timestamp_attr_perms_template"),{READ:tu,INSERT:eT,UPDATE:tT}=or.PERMS_CRUD_ENUM,GU=Object.values(or.PERMS_CRUD_ENUM),xU=[tu,eT,tT];function E5(e){let t;try{if(e.permission.super_user||e.permission.cluster_user)return e.permission;let r=Object.assign({},global.hdb_schema);delete r[or.SYSTEM_SCHEMA_NAME],t=e.role;let s=JSON.stringify([e.__updatedtime__,r]);if(Gi[t]&&Gi[t].key===s)return Gi[t].perms;let n=h5(e,r);return Gi[t]?Gi[t].key=s:Gi[t]=f5(s),Gi[t].perms=n,n}catch(r){if(!e[or.TIME_STAMP_NAMES_ENUM.UPDATED_TIME]||e[or.TIME_STAMP_NAMES_ENUM.UPDATED_TIME]<or.PERMS_UPDATE_RELEASE_TIMESTAMP){let s=`Role permissions for role '${t}' must be updated to align with new structure from the 2.2.0 release.`;throw jS.error(s),jS.debug(r),PU(new Error,_5.OUTDATED_PERMS_TRANSLATION_ERROR,d5.BAD_REQUEST)}else{let s=`There was an error while translating role permissions for role: ${t}.
 ${r.stack}`;throw jS.error(s),PU(new Error)}}}a(E5,"getRolePermissions");function h5(e,t){let r=Object.create(null);r.super_user=!1;let s=e.permission;r[or.SYSTEM_SCHEMA_NAME]=s[or.SYSTEM_SCHEMA_NAME],r.structure_user=s.structure_user;let n=Array.isArray(e.permission.structure_user)||e.permission.structure_user===!0?e.permission.structure_user:[];return Object.keys(t).forEach(i=>{if(n===!0||n.indexOf(i)>-1){r[i]=m5(t[i]);return}r[i]=qU(),s[i]?(s[i].describe&&(r[i].describe=!0),Object.keys(t[i]).forEach(o=>{if(s[i].tables[o]){let c=s[i].tables[o],u=t[i][o],_=p5(c,u);r[i].describe||GU.forEach(l=>{_[l]&&(r[i].describe=!0)}),r[i].tables[o]=_}else r[i].tables[o]=ZS()})):Object.keys(t[i]).forEach(o=>{r[i].tables[o]=ZS()})}),r}a(h5,"translateRolePermissions");function m5(e){let t=qU(!0);return Object.keys(e).forEach(r=>{t.tables[r]=ZS(!0,!0,!0,!0,!0)}),t}a(m5,"createStructureUserPermissions");function p5(e,t){let{attribute_permissions:r}=e;if(r.length>0){let n=Object.assign({},e);n.attribute_permissions=[];let i=r.reduce((_,l)=>{let{attribute_name:d}=l,f=l;return or.TIME_STAMP_NAMES.includes(d)&&(f=BU(d,l[tu])),_[d]=f,_},{}),o=t.primaryKey||t.hash_attribute,c=!!i[o],u=vU(o);return t.attributes.forEach(({attribute:_})=>{if(i[_]){let l=i[_];l.describe=kU(l),n.attribute_permissions.push(l),c||S5(l,u)}else if(_!==o){let l;or.TIME_STAMP_NAMES.includes(_)?l=BU(_):l=vU(_),n.attribute_permissions.push(l)}}),c||n.attribute_permissions.push(u),n.describe=HU(n),n}else return e.describe=HU(e),e}a(p5,"getTableAttrPerms");function HU(e){return GU.filter(t=>e[t]).length>0}a(HU,"getSchemaTableDescribePerm");function kU(e){return xU.filter(t=>e[t]).length>0}a(kU,"getAttributeDescribePerm");function S5(e,t){xU.forEach(r=>{e[r]&&!t[r]&&(t[r]=!0,t.describe=!0)})}a(S5,"checkForHashPerms")});var YU={};qe(YU,{Resources:()=>Rd,keyArrayToString:()=>zo,resetResources:()=>T5,resources:()=>ti});function T5(){return ti=new Rd}function zo(e){return Array.isArray(e)?e[e.length-1]===null?e.slice(0,-1).join("/")+"/":e.join("/"):e}var Rd,ti,ru=Te(()=>{Ei();Rd=class extends Map{static{a(this,"Resources")}isWorker=!0;loginPath;set(t,r,s,n){if(!r)throw new Error("Must provide a resource");t.startsWith("/")&&(t=t.replace(/^\/+/,""));let i={Resource:r,path:t,type:s,hasSubPaths:!1,relativeURL:""},o=super.get(t);if(o&&(o.Resource.databaseName!==r.databaseName||o.Resource.tableName!==r.tableName)&&!n)throw new Error(`Conflicting paths for ${t}`);super.set(t,i);for(let[c,u]of this){let _=2;for(;(_=c.indexOf("/",_))>-1;){let l=this.get(c.slice(0,_));l&&(l.hasSubPaths=!0),_+=2}}}getMatch(t,r){let s=2,n;for(;(s=t.indexOf("/",s))>-1;){let c=t.slice(0,s),u=this.get(c);if(u){if(u.relativeURL=t.slice(s),!u.hasSubPaths)return u;n=u}s+=2}if(n)return n;let i=t.indexOf("?"),o=i>-1?t.slice(0,i):t;return n=this.get(o),n?n.relativeURL=i>-1?t.slice(i):"":n||(n=this.get(""),n&&(t[0]!=="/"&&(t="/"+t),n.relativeURL=t)),n}getResource(t,r){let s=this.getMatch(t);if(s)return t=s.relativeURL,s.Resource.getResource(this.pathToId(t,s.Resource),r)}call(t,r,s){return Ge(r,async()=>{let n=this.getMatch(t);if(n)return t=n.relativeURL,s(n.Resource,n.path,t)})}setRepresentation(t,r,s){}};a(T5,"resetResources");a(zo,"keyArrayToString")});var KU={};qe(KU,{Headers:()=>ri});var ri,Ad=Te(()=>{ri=class extends Map{static{a(this,"Headers")}set(t,r){return typeof t!="string"&&(t=""+t),typeof r!="string"&&(r=""+r),super.set(t.toLowerCase(),[t,r])}get(t){return typeof t!="string"&&(t=""+t),super.get(t.toLowerCase())?.[1]}has(t){return typeof t!="string"&&(t=""+t),super.has(t.toLowerCase())}setIfNone(t,r){typeof t!="string"&&(t=""+t),typeof r!="string"&&(r=""+r);let s=t.toLowerCase();if(!super.has(s))return super.set(s,[t,r])}append(t,r,s){typeof t!="string"&&(t=""+t),typeof r!="string"&&(r=""+r);let n=t.toLowerCase(),i=super.get(n);if(i){let o=i[1];s?r=(typeof o=="string"?o:o.join(", "))+", "+r:typeof o=="string"?r=[o,r]:o.push(r)}return super.set(n,[t,r])}[Symbol.iterator](){return super.values()[Symbol.iterator]()}}});var su={};qe(su,{authentication:()=>eM,bypassAuth:()=>y5,login:()=>w5,logout:()=>C5,start:()=>I5});function y5(){ZU=!0}async function eM(e,t){let r=e.headers.asObject,s=r.authorization,n=r.cookie,i=r.origin,o=[];try{if(i){let E=e.isOperationsServer?O5?A5:[]:R5?g5:[];if(E.includes(i)||E.includes("*")){if(e.method==="OPTIONS"){let h=new ri([["Access-Control-Allow-Methods","POST, GET, PUT, DELETE, PATCH, OPTIONS"],["Access-Control-Allow-Headers","Accept, Content-Type, Authorization"],["Access-Control-Allow-Origin",i]]);return Od&&h.set("Access-Control-Allow-Credentials","true"),{status:200,headers:h}}o.push("Access-Control-Allow-Origin",i),Od&&o.push("Access-Control-Allow-Credentials","true")}}let u,_;if(Od){let E=(i?i.replace(/^https?:\/\//,"").replace(/\W/,"_")+"-":"")+"hdb-session=",h=n?.indexOf(E);if(h>=0){let p=n.indexOf(";",h),S=n.indexOf("=",h);u=n.slice(S+1,p===-1?n.length:p),_=await QU.get(u)}e.session=_||(_={})}e.user=null;let l=a((E,h,p)=>{let S=new bd.AuthAuditLog(E,h,Ct.AUTH_AUDIT_TYPES.AUTHENTICATION,r["x-forwarded-for"]??e.ip,e.method,e.pathname);S.auth_strategy=p,u&&(S.session_id=u),r.referer&&(S.referer=r.referer),r.origin&&(S.origin=r.origin),h===Ct.AUTH_AUDIT_STATUS.SUCCESS?WU.notify(S):WU.error(S)},"authAuditLog"),d;if(s){if(d=xi.get(s),!d){let[E,h]=s.split(" "),p,S;try{switch(E){case"Basic":[p,S]=atob(h).split(":"),d=p||S?await ut.getUser(p,S):null;break;case"Bearer":try{d=await(0,Nd.validateOperationToken)(h)}catch(g){if(g.message==="invalid token")try{return await(0,Nd.validateRefreshToken)(h),c({status:-1})}catch{throw g}}break}}catch(g){return b5&&(xi.get(h)||(xi.set(h,h),l(p,Ct.AUTH_AUDIT_STATUS.FAILURE,E))),c({status:401,body:si({error:g.message},e)})}xi.set(s,d),N5&&l(d.username,Ct.AUTH_AUDIT_STATUS.SUCCESS,E)}e.user=d}else _?.user?e.user=await ut.getUser(_.user,null,!1):ZU&&(e.ip?.includes("127.0.0.1")||e.ip=="::1")&&(e.user=await(0,JU.getSuperUser)());Od&&(e.session.update=function(E){if(!u){u=(0,XU.v4)();let p=`${(i?i.replace(/^https?:\/\//,"").replace(/\W/,"_")+"-":"")+"hdb-session="}${u}; Path=/; Expires=Tue, 01 Oct 8307 19:33:20 GMT; HttpOnly${e.protocol==="https"?"; SameSite=None; Secure":""}`;o?o.push("Set-Cookie",p):f?.headers?.set&&f.headers.set("Set-Cookie",p)}return E.id=u,QU.put(E)},e.login=async function(E,h){e.user=await ut.getUser(E,h),e.session.update({user:e.user.username})},(d&&!_||_?.user?.username!==d?.username)&&r["user-agent"]?.startsWith("Mozilla")&&e.session.update({user:e.user.username}));let f=await t(e);return f&&(f.status===401&&(r["user-agent"]?.startsWith("Mozilla")&&r.accept?.startsWith("text/html")&&ti.loginPath?(f.status=302,f.headers.set("Location",ti.loginPath(e))):f.headers.set("WWW-Authenticate","Basic")),c(f))}catch(u){throw c(u)}function c(u){let _=o.length;if(_>0){let l=u.headers;l||(u.headers=l=new ri);for(let d=0;d<_;){let f=o[d++];l.set(f,o[d++])}}return o=null,u}a(c,"applyResponseHeaders")}function I5({server:e,port:t}){e.request(eM,{port:t||"all"}),zU||(zU=!0,setInterval(()=>{xi=new Map},Kr.get(Ct.CONFIG_PARAMS.AUTHENTICATION_CACHETTL)).unref(),jU.user.addListener(()=>{xi=new Map}))}async function w5(e){if(!e.baseRequest?.login)throw new Error("No session for login");return e.baseResponse.headers.set=(t,r)=>{e.fastifyResponse.header(t,r)},await e.baseRequest.login(e.username,e.password),"Login successful"}async function C5(e){if(!e.baseRequest.session)throw new Error("No session for logout");return await e.baseRequest.session.update({user:null}),"Logout successful"}var JU,Nd,XU,Kr,Ct,bd,jU,WU,g5,R5,A5,O5,QU,Od,ZU,N5,b5,xi,zU,yd=Te(()=>{JU=M(xr());hr();ru();Nd=M(Hc());Ee();XU=require("uuid"),Kr=M(X()),Ct=M(y()),bd=M(G()),jU=M(ac());Ad();Jo();WU=(0,bd.loggerWithTag)("auth-event");Kr.initSync();g5=Kr.get(Ct.CONFIG_PARAMS.HTTP_CORSACCESSLIST),R5=Kr.get(Ct.CONFIG_PARAMS.HTTP_CORS),A5=Kr.get(Ct.CONFIG_PARAMS.OPERATIONSAPI_NETWORK_CORSACCESSLIST),O5=Kr.get(Ct.CONFIG_PARAMS.OPERATIONSAPI_NETWORK_CORS),QU=et({table:"hdb_session",database:"system",attributes:[{name:"id",isPrimaryKey:!0},{name:"user"}]}),Od=Kr.get(Ct.CONFIG_PARAMS.AUTHENTICATION_ENABLESESSIONS)??!0,ZU=Kr.get(Ct.CONFIG_PARAMS.AUTHENTICATION_AUTHORIZELOCAL)??process.env.DEV_MODE,N5=Kr.get(Ct.CONFIG_PARAMS.LOGGING_AUDITAUTHEVENTS_LOGSUCCESSFUL)??!1,b5=Kr.get(Ct.CONFIG_PARAMS.LOGGING_AUDITAUTHEVENTS_LOGFAILED)??!1,xi=new Map;ut.onInvalidatedUser(()=>{xi=new Map});a(y5,"bypassAuth");a(eM,"authentication");a(I5,"start");a(w5,"login");a(C5,"logout")});var aM=T((Z_e,oM)=>{"use strict";var Se=require("joi"),tM=require("fs-extra"),rM=require("path"),mn=ke(),sM=X(),nM=y(),iM=G(),{hdb_errors:L5}=j(),{HDB_ERROR_MSGS:kt}=L5,hn=/^[a-zA-Z0-9-_]+$/;oM.exports={getDropCustomFunctionValidator:U5,setCustomFunctionValidator:M5,addComponentValidator:H5,dropCustomFunctionProjectValidator:q5,packageComponentValidator:F5,deployComponentValidator:G5,setComponentFileValidator:P5,getComponentFileValidator:B5,dropComponentFileValidator:v5};function Id(e,t,r){try{let s=sM.get(nM.CONFIG_PARAMS.COMPONENTSROOT),n=rM.join(s,t);return tM.existsSync(n)?e?t:r.message(kt.PROJECT_EXISTS):e?r.message(kt.NO_PROJECT):t}catch(s){return iM.error(s),r.message(kt.VALIDATION_ERR)}}a(Id,"checkProjectExists");function nu(e,t){return e.includes("..")?t.message("Invalid file path"):e}a(nu,"checkFilePath");function D5(e,t,r,s){try{let n=sM.get(nM.CONFIG_PARAMS.COMPONENTSROOT),i=rM.join(n,e,t,r+".js");return tM.existsSync(i)?r:s.message(kt.NO_FILE)}catch(n){return iM.error(n),s.message(kt.VALIDATION_ERR)}}a(D5,"checkFileExists");function U5(e){let t=Se.object({project:Se.string().pattern(hn).custom(Id.bind(null,!0)).required().messages({"string.pattern.base":kt.BAD_PROJECT_NAME}),type:Se.string().valid("helpers","routes").required(),file:Se.string().pattern(hn).custom(D5.bind(null,e.project,e.type)).custom(nu).required().messages({"string.pattern.base":kt.BAD_FILE_NAME})});return mn.validateBySchema(e,t)}a(U5,"getDropCustomFunctionValidator");function M5(e){let t=Se.object({project:Se.string().pattern(hn).custom(Id.bind(null,!0)).required().messages({"string.pattern.base":kt.BAD_PROJECT_NAME}),type:Se.string().valid("helpers","routes").required(),file:Se.string().custom(nu).required(),function_content:Se.string().required()});return mn.validateBySchema(e,t)}a(M5,"setCustomFunctionValidator");function P5(e){let t=Se.object({project:Se.string().pattern(hn).required().messages({"string.pattern.base":kt.BAD_PROJECT_NAME}),file:Se.string().custom(nu).required(),payload:Se.string().allow("").optional(),encoding:Se.string().valid("utf8","ASCII","binary","hex","base64","utf16le","latin1","ucs2").optional()});return mn.validateBySchema(e,t)}a(P5,"setComponentFileValidator");function v5(e){let t=Se.object({project:Se.string().pattern(hn).required().messages({"string.pattern.base":kt.BAD_PROJECT_NAME}),file:Se.string().custom(nu).optional()});return mn.validateBySchema(e,t)}a(v5,"dropComponentFileValidator");function B5(e){let t=Se.object({project:Se.string().required(),file:Se.string().custom(nu).required(),encoding:Se.string().valid("utf8","ASCII","binary","hex","base64","utf16le","latin1","ucs2").optional()});return mn.validateBySchema(e,t)}a(B5,"getComponentFileValidator");function H5(e){let t=Se.object({project:Se.string().pattern(hn).custom(Id.bind(null,!1)).required().messages({"string.pattern.base":kt.BAD_PROJECT_NAME})});return mn.validateBySchema(e,t)}a(H5,"addComponentValidator");function q5(e){let t=Se.object({project:Se.string().pattern(hn).custom(Id.bind(null,!0)).required().messages({"string.pattern.base":kt.BAD_PROJECT_NAME})});return mn.validateBySchema(e,t)}a(q5,"dropCustomFunctionProjectValidator");function F5(e){let t=Se.object({project:Se.string().pattern(hn).required().messages({"string.pattern.base":kt.BAD_PROJECT_NAME}),skip_node_modules:Se.boolean()});return mn.validateBySchema(e,t)}a(F5,"packageComponentValidator");function G5(e){let t=Se.object({project:Se.string().pattern(hn).required().messages({"string.pattern.base":kt.BAD_PROJECT_NAME}),payload:Se.string().optional().messages({"string.pattern.base":kt.BAD_PACKAGE}),package:Se.string().optional()});return mn.validateBySchema(e,t)}a(G5,"deployComponentValidator")});var Dd=T((tde,EM)=>{"use strict";var wd=require("joi"),Cd=require("path"),cM=require("fs-extra"),{exec:x5}=require("child_process"),k5=require("util"),uM=k5.promisify(x5),iu=y(),{handleHDBError:Xo,hdb_errors:V5}=j(),{HTTP_STATUS_CODES:jo}=V5,ou=X(),$5=ke(),Zo=G();ou.initSync();var rT=ou.get(iu.CONFIG_PARAMS.COMPONENTSROOT),lM="npm install --omit=dev --json",Y5=`${lM} --dry-run`;EM.exports={installModules:z5,auditModules:J5,installAllRootModules:K5,uninstallRootModule:W5,linkHarperdb:Q5};async function K5(e=!1){await Ld(),await au(e?"npm install --ignore-scripts":"npm install",ou.get(iu.CONFIG_PARAMS.ROOTPATH))}a(K5,"installAllRootModules");async function W5(e){await au(`npm uninstall ${e}`,ou.get(iu.CONFIG_PARAMS.ROOTPATH))}a(W5,"uninstallRootModule");async function Q5(){await Ld(),await au(`npm link ${iu.PACKAGE_ROOT}`,ou.get(iu.CONFIG_PARAMS.ROOTPATH))}a(Q5,"linkHarperdb");async function au(e,t=void 0){let r,s;try{({stdout:r,stderr:s}=await uM(e,{cwd:t}))}catch(n){throw new Error(n.stderr.replace(`
`,""))}return s&&!s.includes("Debugger listening")&&Zo.error("Error running NPM command:",e,s),Zo.trace(r,s),r.replace(`
`,"")}a(au,"runCommand");async function z5(e){Zo.info(`starting installModules for request: ${e}`);let t=fM(e);if(t)throw Xo(t,t.message,jo.BAD_REQUEST);let{projects:r,dry_run:s}=e,n=s===!0?Y5:lM;await Ld(),await dM(r);let i={};for(let o=0,c=r.length;o<c;o++){let u=r[o];i[u]={npm_output:null,npm_error:null};let _=Cd.join(rT,u),l,d=null;try{let{stdout:f,stderr:E}=await uM(n,{cwd:_});l=f?f.replace(`
`,""):null,d=E?E.replace(`
`,""):null}catch(f){f.stderr?i[u].npm_error=_M(f.stderr):i[u].npm_error=f.message;continue}try{i[u].npm_output=JSON.parse(l)}catch{i[u].npm_output=l}try{i[u].npm_error=JSON.parse(d)}catch{i[u].npm_error=d}}return Zo.info(`finished installModules with response ${i}`),i}a(z5,"installModules");function _M(e){let t='"error": {',r=e.indexOf('"error": {'),s=e.indexOf(`}
`);return r>-1&&s>-1?JSON.parse(e.substring(r+t.length-1,s+1)):e}a(_M,"parseNPMStdErr");async function J5(e){Zo.info(`starting auditModules for request: ${e}`);let t=fM(e);if(t)throw Xo(t,t.message,jo.BAD_REQUEST);let{projects:r}=e;await Ld(),await dM(r);let s={};for(let n=0,i=r.length;n<i;n++){let o=r[n],c=Cd.join(rT,o);s[o]={npm_output:null,npm_error:null};try{let u=await au("npm audit --json",c);s[o].npm_output=JSON.parse(u)}catch(u){s[o].npm_error=_M(u.stderr)}}return Zo.info(`finished auditModules with response ${s}`),s}a(J5,"auditModules");async function Ld(){try{return await au("npm -v"),!0}catch{throw Xo(new Error,"Unable to install project dependencies: npm is not installed on this instance of HarperDB.",jo.BAD_REQUEST,void 0,void 0,!0)}}a(Ld,"checkNPMInstalled");async function dM(e){if(!Array.isArray(e)||e.length===0)throw Xo(new Error,"projects argument must be an array with at least 1 element",jo.BAD_REQUEST,void 0,void 0,!0);let t=[],r=[];for(let s=0,n=e.length;s<n;s++){let i=e[s],o=Cd.join(rT,i.toString());if(!await cM.pathExists(o)){t.push(i);continue}let u=Cd.join(o,"package.json");await cM.pathExists(u)||r.push(i)}if(t.length>0)throw Xo(new Error,`Unable to install project dependencies: custom function projects '${t.join(",")}' does not exist.`,jo.BAD_REQUEST,void 0,void 0,!0);if(r.length>0)throw Xo(new Error,`Unable to install project dependencies: custom function projects '${r.join(",")}' do not have a package.json file.`,jo.BAD_REQUEST,void 0,void 0,!0)}a(dM,"checkProjectPaths");function fM(e){let t=wd.object({projects:wd.array().min(1).items(wd.string()).required(),dry_run:wd.boolean().default(!1)});return $5.validateBySchema(e,t)}a(fM,"modulesValidator")});var nT=T((sde,TM)=>{"use strict";var ea=require("fs-extra"),sT=require("path"),Ud=G(),hM=$(),Md=y(),SM=X(),X5=gr();TM.exports=j5;async function j5(){let e=Z5(),t=SM.get(Md.CONFIG_PARAMS.ROOTPATH),r=sT.join(t,"package.json"),s={dependencies:{harperdb:"file:"+Md.PACKAGE_ROOT}},n=sT.join(t,"node_modules");await ea.ensureDir(n);let i,o=!0,c=!1;try{i=await ea.readJson(r)}catch(u){if(hM.isEmptyOrZeroLength(e))return;if(u.code!==Md.NODE_ERROR_CODES.ENOENT)throw u;o=!1}if(!hM.isEmptyOrZeroLength(e)){for(let{name:u,package:_}of e){let l=await mM(_);s.dependencies[u]=l+_}if(!o){Ud.notify("Installing components"),await pM(r,s,null);return}for(let{name:u,package:_}of e){let l=i.dependencies[u],d=await mM(_);if(l===void 0||l!==d+_){c=!0;break}}}for(let u in i.dependencies)s.dependencies[u]===void 0&&(Ud.notify("Removing component",u),c=!0);c&&(Ud.notify("Updating components."),await pM(r,s,i))}a(j5,"installComponents");function Z5(){let e=X5.getConfiguration(),t=[];for(let r in e)e[r]?.package&&t.push(Object.assign(e[r],{name:r}));return t}a(Z5,"getComponentsConfig");async function mM(e){return e.includes(":")?"":e.startsWith("@")||!e.startsWith("@")&&!e.includes("/")?"npm:":sT.extname(e)||await ea.pathExists(e)?"file:":"github:"}a(mM,"getPkgPrefix");async function pM(e,t,r){Ud.trace("npm installing components package.json",t),await ea.writeFile(e,JSON.stringify(t,null,"  "));try{await Dd().installAllRootModules(SM.get(Md.CONFIG_PARAMS.IGNORE_SCRIPTS)===!0)}catch(s){throw r?await ea.writeFile(e,JSON.stringify(r,null,"  ")):await ea.unlink(e),s}}a(pM,"installPackages")});var aT=T((ode,OM)=>{"use strict";var Ue=require("fs-extra"),iT=require("fast-glob"),de=require("path"),RM=require("tar-fs"),ide=require("uuid").v4,oT=require("normalize-path"),ks=aM(),pt=G(),Me=y(),nt=X(),cu=gr(),e8=$(),{PACKAGE_ROOT:t8}=y(),{handleHDBError:St,hdb_errors:r8}=j(),{basename:s8}=require("path"),n8=nT(),AM=X(),i8=y(),{Readable:o8}=require("stream"),{HDB_ERROR_MSGS:ki,HTTP_STATUS_CODES:Tt}=r8,a8=de.join(t8,"application-template"),gM=de.join(nt.get(Me.HDB_SETTINGS_NAMES.HDB_ROOT_KEY),"tmp");function c8(){pt.trace("getting custom api status");let e={};try{e={port:nt.get(Me.CONFIG_PARAMS.HTTP_PORT),directory:nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),is_enabled:!0}}catch(t){throw St(new Error,ki.FUNCTION_STATUS,Tt.INTERNAL_SERVER_ERROR,pt.ERR,t)}return e}a(c8,"customFunctionsStatus");function u8(){pt.trace("getting custom api endpoints");let e={},t=nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT);try{iT.sync(oT(`${t}/*`),{onlyDirectories:!0}).forEach(s=>{let n=s.split("/").pop();e[n]={routes:iT.sync(oT(`${s}/routes/*.js`)).map(i=>i.split("/").pop().split(".js")[0]),helpers:iT.sync(oT(`${s}/helpers/*.js`)).map(i=>i.split("/").pop().split(".js")[0])}})}catch(r){throw St(new Error,ki.GET_FUNCTIONS,Tt.INTERNAL_SERVER_ERROR,pt.ERR,r)}return e}a(u8,"getCustomFunctions");function l8(e){e.project&&(e.project=de.parse(e.project).name),e.file&&(e.file=de.parse(e.file).name);let t=ks.getDropCustomFunctionValidator(e);if(t)throw St(t,t.message,Tt.BAD_REQUEST);pt.trace("getting custom api endpoint file content");let r=nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),{project:s,type:n,file:i}=e,o=de.join(r,s,n,i+".js");try{return Ue.readFileSync(o,{encoding:"utf8"})}catch(c){throw St(new Error,ki.GET_FUNCTION,Tt.INTERNAL_SERVER_ERROR,pt.ERR,c)}}a(l8,"getCustomFunction");function _8(e){e.project&&(e.project=de.parse(e.project).name),e.file&&(e.file=de.parse(e.file).name);let t=ks.setCustomFunctionValidator(e);if(t)throw St(t,t.message,Tt.BAD_REQUEST);pt.trace("setting custom function file content");let r=nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),{project:s,type:n,file:i,function_content:o}=e;try{return Ue.outputFileSync(de.join(r,s,n,i+".js"),o),`Successfully updated custom function: ${i}.js`}catch(c){throw St(new Error,ki.SET_FUNCTION,Tt.INTERNAL_SERVER_ERROR,pt.ERR,c)}}a(_8,"setCustomFunction");function d8(e){e.project&&(e.project=de.parse(e.project).name),e.file&&(e.file=de.parse(e.file).name);let t=ks.getDropCustomFunctionValidator(e);if(t)throw St(t,t.message,Tt.BAD_REQUEST);pt.trace("dropping custom function file");let r=nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),{project:s,type:n,file:i}=e;try{return Ue.unlinkSync(de.join(r,s,n,i+".js")),`Successfully deleted custom function: ${i}.js`}catch(o){throw St(new Error,ki.DROP_FUNCTION,Tt.INTERNAL_SERVER_ERROR,pt.ERR,o)}}a(d8,"dropCustomFunction");function f8(e){e.project&&(e.project=de.parse(e.project).name);let t=ks.addComponentValidator(e);if(t)throw St(t,t.message,Tt.BAD_REQUEST);pt.trace("adding component");let r=nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),{project:s}=e;try{let n=de.join(r,s);return Ue.mkdirSync(n,{recursive:!0}),Ue.copySync(a8,n),`Successfully added project: ${s}`}catch(n){throw St(new Error,ki.ADD_FUNCTION,Tt.INTERNAL_SERVER_ERROR,pt.ERR,n)}}a(f8,"addComponent");function E8(e){e.project&&(e.project=de.parse(e.project).name);let t=ks.dropCustomFunctionProjectValidator(e);if(t)throw St(t,t.message,Tt.BAD_REQUEST);pt.trace("dropping custom function project");let r=nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),{project:s}=e,n=nt.get(Me.CONFIG_PARAMS.APPS);if(!e8.isEmptyOrZeroLength(n)){let i=!1;for(let[o,c]of n.entries())if(c.name===s){n.splice(o,1),i=!0;break}if(i)return cu.updateConfigValue(Me.CONFIG_PARAMS.APPS,n),`Successfully deleted project: ${s}`}try{let i=de.join(r,s);return Ue.rmSync(i,{recursive:!0}),`Successfully deleted project: ${s}`}catch(i){throw St(new Error,ki.DROP_FUNCTION_PROJECT,Tt.INTERNAL_SERVER_ERROR,pt.ERR,i)}}a(E8,"dropCustomFunctionProject");async function h8(e){e.project&&(e.project=de.parse(e.project).name);let t=ks.packageComponentValidator(e);if(t)throw St(t,t.message,Tt.BAD_REQUEST);let r=nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),{project:s}=e;pt.trace("packaging component",s);let n;try{n=await Ue.realpath(de.join(r,s))}catch(u){if(u.code!==Me.NODE_ERROR_CODES.ENOENT)throw u;try{n=await Ue.realpath(de.join(nt.get(Me.CONFIG_PARAMS.ROOTPATH),"node_modules",s))}catch(_){if(_.code===Me.NODE_ERROR_CODES.ENOENT)throw new Error(`Unable to locate project '${s}'`)}}await Ue.ensureDir(gM);let i=de.join(gM,`${s}.tar`),o={};(e.skip_node_modules===!0||e.skip_node_modules==="true")&&(o={ignore:u=>u.includes(de.join(n,"node_modules"))}),RM.pack(n,o).pipe(Ue.createWriteStream(i,{overwrite:!0})),await new Promise(u=>setTimeout(u,2e3));let c=Ue.readFileSync(i,{encoding:"base64"});return await Ue.remove(i),{project:s,payload:c}}a(h8,"packageComponent");async function m8(e){e.project&&(e.project=de.parse(e.project).name);let t=ks.deployComponentValidator(e);if(t)throw St(t,t.message,Tt.BAD_REQUEST);let r=nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),{project:s,payload:n,package:i}=e;if(pt.trace("deploying component",s),!n&&!i)throw new Error("'payload' or 'package' must be provided");let o;if(n){o=de.join(r,s),i="file:"+o,await Ue.ensureDir(o);let f=o8.from(Buffer.from(n,"base64"));await new Promise((h,p)=>{f.pipe(RM.extract(o,{finish:h})).on("error",p)});let E=await Ue.readdir(o);E.length===1&&E[0]==="package"&&(await Ue.copy(de.join(o,"package"),o),await Ue.remove(de.join(o,"package")))}if(cu.updateConfigValue(`${s}_package`,i,void 0,!1,!1,!0),!n){await n8();let f=AM.get(i8.CONFIG_PARAMS.ROOTPATH);o=de.join(f,"node_modules",s)}let c=new Map;c.isWorker=!0;let u=(vd(),Z(Pd)),_;u.setErrorReporter(f=>_=f);let l=s8(o),d=u.component_errors.get(l);try{await u.loadComponent(o,c)}finally{u.component_errors.set(l,d)}if(_)throw _;return pt.info("Installed component"),`Successfully deployed: ${s}`}a(m8,"deployComponent");async function p8(){let e=cu.getConfiguration(),t=[];for(let o in e)if(e[o]?.package){if(e[o].package.startsWith("file:"))continue;t.push(Object.assign({},e[o],{name:o}))}let r=a(async(o,c)=>{let u=await Ue.readdir(o,{withFileTypes:!0});for(let _ of u){let l=_.name;if(l.startsWith(".")||l==="node_modules")continue;let d=de.join(o,l);if(_.isDirectory()||_.isSymbolicLink()){let f={name:l,entries:[]};c.entries.push(f),await r(d,f)}else{let f=await Ue.stat(d),E={name:de.basename(l),mtime:f.mtime,size:f.size};c.entries.push(E)}}return c},"walk_dir"),s=await r(nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),{name:nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT).split(de.sep).slice(-1).pop(),entries:t});for(let o of s.entries)if(o.package){let c=await r(de.join(nt.get(Me.CONFIG_PARAMS.ROOTPATH),"node_modules",o.name),{name:o.name,entries:[]});Object.assign(o,c)}let i=(vd(),Z(Pd)).component_errors;for(let o of t){let c=i.get(o.name);c?o.error=i.get(o.name):c===void 0&&(o.error="The component has not been loaded yet (may need a restart)")}return s}a(p8,"getComponents");async function S8(e){let t=ks.getComponentFileValidator(e);if(t)throw St(t,t.message,Tt.BAD_REQUEST);let s=cu.getConfigObj()[e.project]||e.project==="harperdb"?de.join(AM.get(Me.CONFIG_PARAMS.ROOTPATH),"node_modules"):nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),n=e.encoding?{encoding:e.encoding}:{encoding:"utf8"};try{return await Ue.readFile(de.join(s,e.project,e.file),n)}catch(i){throw i.code===Me.NODE_ERROR_CODES.ENOENT?new Error(`Component file not found '${de.join(e.project,e.file)}'`):i}}a(S8,"getComponentFile");async function T8(e){let t=ks.setComponentFileValidator(e);if(t)throw St(t,t.message,Tt.BAD_REQUEST);let r=e.encoding?{encoding:e.encoding}:{encoding:"utf8"},s=de.join(nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),e.project,e.file);return e.payload!==void 0?(await Ue.ensureFile(s),await Ue.outputFile(s,e.payload,r)):await Ue.ensureDir(s),"Successfully set component: "+e.file}a(T8,"setComponentFile");async function g8(e){let t=ks.dropComponentFileValidator(e);if(t)throw St(t,t.message,Tt.BAD_REQUEST);let r=e.file?de.join(e.project,e.file):e.project,s=de.join(nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),r);return await Ue.pathExists(s)&&await Ue.remove(s),cu.deleteConfigFromFile([e.project]),"Successfully dropped: "+r}a(g8,"dropComponent");OM.exports={customFunctionsStatus:c8,getCustomFunctions:u8,getCustomFunction:l8,setCustomFunction:_8,dropCustomFunction:d8,addComponent:f8,dropCustomFunctionProject:E8,packageComponent:h8,deployComponent:m8,getComponents:p8,getComponentFile:S8,setComponentFile:T8,dropComponent:g8}});var cT=T((cde,bM)=>{"use strict";var Vs=require("joi"),NM=ke();bM.exports={readTransactionLogValidator:R8,deleteTransactionLogsBeforeValidator:A8};function R8(e){let t=Vs.object({schema:Vs.string().required(),table:Vs.string().required(),from:Vs.date().timestamp(),to:Vs.date().timestamp(),limit:Vs.number().min(1)});return NM.validateBySchema(e,t)}a(R8,"readTransactionLogValidator");function A8(e){let t=Vs.object({schema:Vs.string().required(),table:Vs.string().required(),timestamp:Vs.date().timestamp().required()});return NM.validateBySchema(e,t)}a(A8,"deleteTransactionLogsBeforeValidator")});var Hd=T((lde,LM)=>{"use strict";var uT=y(),Bd=_t(),yM=$(),IM=X(),wM=sn(),{handleHDBError:ta,hdb_errors:O8}=j(),{HTTP_STATUS_CODES:ra}=O8,{readTransactionLogValidator:N8,deleteTransactionLogsBeforeValidator:b8}=cT(),CM="This operation relies on clustering and cannot run with it disable.",y8="Logs successfully deleted from transaction log.",I8="All logs successfully deleted from transaction log.";LM.exports={readTransactionLog:w8,deleteTransactionLogsBefore:C8};async function*w8(e){let t=N8(e);if(t)throw ta(t,t.message,ra.BAD_REQUEST,void 0,void 0,!0);if(!IM.get(uT.CONFIG_PARAMS.CLUSTERING_ENABLED))throw ta(new Error,CM,ra.NOT_FOUND,void 0,void 0,!0);let{schema:r,table:s}=e,n=yM.checkSchemaTableExist(r,s);if(n)throw ta(new Error,n,ra.NOT_FOUND,void 0,void 0,!0);let i=wM.createNatsTableStreamName(r,s),o=await Bd.viewStreamIterator(i,parseInt(e.from),e.limit);for await(let c of o){let u=Math.floor(c?.nats_timestamp/1e6);if(e.to&&u>e.to)break;let _={operation:c?.entry?.operation,user:c?.entry?.__origin?.user,timestamp:u,records:c?.entry?.records,attributes:c?.entry?.attributes};c?.entry?.operation===uT.OPERATIONS_ENUM.DELETE&&(_.hash_values=c?.entry?.hash_values),yield _}}a(w8,"readTransactionLog");async function C8(e){let t=b8(e);if(t)throw ta(t,t.message,ra.BAD_REQUEST,void 0,void 0,!0);if(!IM.get(uT.CONFIG_PARAMS.CLUSTERING_ENABLED))throw ta(new Error,CM,ra.NOT_FOUND,void 0,void 0,!0);let{schema:r,table:s,timestamp:n}=e,i=yM.checkSchemaTableExist(r,s);if(i)throw ta(new Error,i,ra.NOT_FOUND,void 0,void 0,!0);let o=wM.createNatsTableStreamName(r,s),{jsm:c}=await Bd.getNATSReferences(),u=await Bd.getStreamInfo(o),_=new Date(u.state.first_ts).getTime();if(n<=_)return`No transactions exist before: ${n}`;let l=y8,d,f=new Date(u.state.last_ts).getTime();return n>f?(d=u.state.last_seq+1,l=I8):d=(await Bd.viewStream(o,parseInt(n),1))[0].nats_sequence,await c.streams.purge(o,{seq:d}),l}a(C8,"deleteTransactionLogsBefore")});var UM=T((dde,DM)=>{"use strict";var lT=class{static{a(this,"PermissionTableResponseObject")}constructor(t,r,s=[],n=[]){this.schema=t,this.table=r,this.required_table_permissions=s,this.required_attribute_permissions=n}};DM.exports=lT});var PM=T((Ede,MM)=>{"use strict";var _T=class{static{a(this,"PermissionAttributeResponseObject")}constructor(t,r=[]){this.attribute_name=t,this.required_permissions=r}};MM.exports=_T});var fT=T((mde,BM)=>{"use strict";var vM=UM(),L8=PM(),{HDB_ERROR_MSGS:D8}=fr(),dT=class{static{a(this,"PermissionResponseObject")}constructor(){this.error=D8.OP_AUTH_PERMS_ERROR,this.unauthorized_access={},this.invalid_schema_items=[]}handleUnauthorizedItem(t){return this.invalid_schema_items=[],this.unauthorized_access=[t],this}handleInvalidItem(t){return this.invalid_schema_items=[t],this.unauthorized_access=[],this}addInvalidItem(t,r,s){if(r&&s){let n=`${r}_${s}`;if(this.unauthorized_access[n])return}this.invalid_schema_items.push(t)}addUnauthorizedTable(t,r,s){let n=new vM(t,r,s),i=`${t}_${r}`;this.unauthorized_access[i]=n}addUnauthorizedAttributes(t,r,s,n){let i=[];t.forEach(c=>{let u=new L8(c,n[c]);i.push(u)});let o=`${r}_${s}`;if(this.unauthorized_access[o])this.unauthorized_access[o].required_attribute_permissions=i;else{let c=new vM(r,s,[],i);this.unauthorized_access[o]=c}}getPermsResponse(){let t=Object.values(this.unauthorized_access);return t.length>0||this.invalid_schema_items.length>0?(this.unauthorized_access=t,this):null}};BM.exports=dT});var xd=T((Sde,jM)=>{"use strict";var ET=Gr(),qd=Fr(),Qr=v_(),_u=gi(),hT=bi(),U8=wp(),M8=WC(),du=xr(),Fd=Hp(),dt=G(),P8=Gp(),v8=Z_(),B8=RS(),H8=sd(),q8=AS(),F8=OS(),G8=yS(),x8=wS(),mT=DS(),pn=$(),k8=$D(),pT=BS(),FM=gd(),Wr=y(),GM=$U(),V8=ko(),xM=Hc(),kM=(yd(),Z(su)),VM=gr(),wr=aT(),$8=require("alasql"),$M=Hd(),YM=Dd(),KM=fT(),{handleHDBError:ar,hdb_errors:WM}=j(),{HDB_ERROR_MSGS:Lt,HTTP_STATUS_CODES:uu}=WM,v=new Map,QM="delete",ni="insert",Sn="read",Vi="update",lu="describe",HM=_u.describeSchema.name,qM=_u.describeTable.name,zM={delete:!0,deleteRecord:!0,update:!0,updateData:!0,dropAttribute:!0,dropTable:!0,dropSchema:!0,upsert:!0,upsertData:!0},Y8="catchup",K8="handleGetJob",W8="handleGetJobsByStartDate",Gd={CSV_DATA_LOAD:"csvDataLoad",CSV_URL_LOAD:"csvURLLoad",CSV_FILE_LOAD:"csvFileLoad",IMPORT_FROM_S3:"importFromS3"},Q8=[Qr.createTable.name,Qr.createAttribute.name,Qr.dropTable.name,Qr.dropAttribute.name],JM={EXPORT_TO_S3:"export_to_s3",EXPORT_LOCAL:"export_local"},q=class{static{a(this,"permission")}constructor(t,r){this.requires_su=t,this.perms=r}};v.set(ET.insert.name,new q(!1,[ni]));v.set(ET.update.name,new q(!1,[Vi]));v.set(ET.upsert.name,new q(!1,[ni,Vi]));v.set(qd.searchByConditions.name,new q(!1,[Sn]));v.set(qd.searchByHash.name,new q(!1,[Sn]));v.set(qd.searchByValue.name,new q(!1,[Sn]));v.set(qd.search.name,new q(!1,[Sn]));v.set(Qr.createSchema.name,new q(!0,[]));v.set(Qr.createTable.name,new q(!0,[]));v.set(Qr.createAttribute.name,new q(!1,[ni]));v.set(Qr.dropSchema.name,new q(!0,[]));v.set(Qr.dropTable.name,new q(!0,[]));v.set(Qr.dropAttribute.name,new q(!0,[]));v.set(_u.describeSchema.name,new q(!1,[Sn]));v.set(_u.describeTable.name,new q(!1,[Sn]));v.set(hT.deleteRecord.name,new q(!1,[QM]));v.set(du.addUser.name,new q(!0,[]));v.set(du.alterUser.name,new q(!0,[]));v.set(du.dropUser.name,new q(!0,[]));v.set(du.listUsersExternal.name,new q(!0,[]));v.set(Fd.listRoles.name,new q(!0,[]));v.set(Fd.addRole.name,new q(!0,[]));v.set(Fd.alterRole.name,new q(!0,[]));v.set(Fd.dropRole.name,new q(!0,[]));v.set(P8.name,new q(!0,[]));v.set(v8.name,new q(!0,[]));v.set(B8.name,new q(!0,[]));v.set(H8.name,new q(!0,[]));v.set(q8.name,new q(!0,[]));v.set(F8.name,new q(!0,[]));v.set(mT.setRoutes.name,new q(!0,[]));v.set(mT.getRoutes.name,new q(!0,[]));v.set(mT.deleteRoutes.name,new q(!0,[]));v.set(VM.setConfiguration.name,new q(!0,[]));v.set(G8.clusterStatus.name,new q(!0,[]));v.set(x8.name,new q(!0,[]));v.set(pT.getFingerprint.name,new q(!0,[]));v.set(pT.setLicense.name,new q(!0,[]));v.set(hT.deleteFilesBefore.name,new q(!0,[]));v.set(hT.deleteAuditLogsBefore.name,new q(!0,[]));v.set(FM.restart.name,new q(!0,[]));v.set(FM.restartService.name,new q(!0,[]));v.set(U8.name,new q(!0,[]));v.set(M8.name,new q(!0,[Sn]));v.set(V8.systemInformation.name,new q(!0,[]));v.set(VM.getConfiguration.name,new q(!0,[]));v.set($M.readTransactionLog.name,new q(!0,[]));v.set($M.deleteTransactionLogsBefore.name,new q(!0,[]));v.set(YM.installModules.name,new q(!0,[]));v.set(YM.auditModules.name,new q(!0,[]));v.set(xM.createTokens.name,new q(!1,[]));v.set(xM.refreshOperationToken.name,new q(!1,[]));v.set(kM.login.name,new q(!1,[]));v.set(kM.logout.name,new q(!1,[]));v.set(wr.customFunctionsStatus.name,new q(!0,[]));v.set(wr.getCustomFunctions.name,new q(!0,[]));v.set(wr.getComponents.name,new q(!0,[]));v.set(wr.getComponentFile.name,new q(!0,[]));v.set(wr.setComponentFile.name,new q(!0,[]));v.set(wr.dropComponent.name,new q(!0,[]));v.set(wr.getCustomFunction.name,new q(!0,[]));v.set(wr.setCustomFunction.name,new q(!0,[]));v.set(wr.dropCustomFunction.name,new q(!0,[]));v.set(wr.addComponent.name,new q(!0,[]));v.set(wr.dropCustomFunctionProject.name,new q(!0,[]));v.set(wr.packageComponent.name,new q(!0,[]));v.set(wr.deployComponent.name,new q(!0,[]));v.set(pT.getRegistrationInfo.name,new q(!1,[]));v.set(du.userInfo.name,new q(!1,[]));v.set(_u.describeAll.name,new q(!1,[]));v.set(K8,new q(!1,[]));v.set(W8,new q(!0,[]));v.set(Y8,new q(!0,[]));v.set(Gd.CSV_DATA_LOAD,new q(!1,[ni,Vi]));v.set(Gd.CSV_URL_LOAD,new q(!1,[ni,Vi]));v.set(Gd.CSV_FILE_LOAD,new q(!1,[ni,Vi]));v.set(Gd.IMPORT_FROM_S3,new q(!1,[ni,Vi]));v.set(JM.EXPORT_TO_S3,new q(!0,[]));v.set(JM.EXPORT_LOCAL,new q(!0,[]));v.set(Wr.VALID_SQL_OPS_ENUM.DELETE,new q(!1,[QM]));v.set(Wr.VALID_SQL_OPS_ENUM.SELECT,new q(!1,[Sn]));v.set(Wr.VALID_SQL_OPS_ENUM.INSERT,new q(!1,[ni]));v.set(Wr.VALID_SQL_OPS_ENUM.UPDATE,new q(!1,[Vi]));jM.exports={verifyPerms:J8,verifyPermsAst:z8,verifyBulkLoadAttributePerms:j8};function z8(e,t,r){if(pn.isEmptyOrZeroLength(e))throw dt.info("verify_perms_ast has an empty user parameter"),ar(new Error);if(pn.isEmptyOrZeroLength(t))throw dt.info("verify_perms_ast has an empty user parameter"),ar(new Error);if(pn.isEmptyOrZeroLength(r))throw dt.info("verify_perms_ast has a null operation parameter"),ar(new Error);try{let s=new KM,n=new k8(e),i=n.getSchemas(),o=new Map;if((!i||i.length===0)&&n.affected_attributes&&n.affected_attributes.size>0)throw dt.info("No schemas defined in verifyPermsAst(), will not continue."),ar(new Error);let c=!!t.role.permission.super_user,u=i.includes("system");if(u&&zM[r])throw ar(new Error,Lt.DROP_SYSTEM,uu.FORBIDDEN);if(c&&!u)return null;let _=GM.getRolePermissions(t.role);t.role.permission=_,!c&&e instanceof $8.yy.Select&&(e=n.updateAttributeWildcardsForRolePerms(_));for(let d=0;d<i.length;d++){let f=n.getTablesBySchemaName(i[d]);f&&o.set(i[d],f)}let l=XM(t,r,o,s);return l||(o.forEach((d,f)=>{for(let E=0;E<d.length;E++){let h=n.getAttributesBySchemaTableName(f,d[E]),p=TT(t.role.permission,f,d[E]);ST(h,p,r,d[E],f,s)}}),s.getPermsResponse())}catch(s){throw ar(s)}}a(z8,"verifyPermsAst");function J8(e,t){if(e===null||t===null||e.hdb_user===void 0||e.hdb_user===null)throw dt.info("null required parameter in verifyPerms"),ar(new Error,Lt.DEFAULT_INVALID_REQUEST,uu.BAD_REQUEST);let r;t instanceof Function?r=t.name:r=t;let s=e.action,n=e.schema,i=e.table,o=new Map;n&&i&&o.set(n,[i]);let c=new KM;if(pn.isEmptyOrZeroLength(e.hdb_user.role)||pn.isEmptyOrZeroLength(e.hdb_user.role.permission))return dt.info(`User ${e.hdb_user.username} has no role or permissions.  Please assign the user a valid role.`),c.handleUnauthorizedItem(Lt.USER_HAS_NO_PERMS(e.hdb_user.username));let u=!!e.hdb_user.role.permission.super_user,_=e.hdb_user.role.permission.structure_user,l=o.has(Wr.SYSTEM_SCHEMA_NAME)||n===Wr.SYSTEM_SCHEMA_NAME;if(l&&zM[r])throw ar(new Error,Lt.DROP_SYSTEM,uu.FORBIDDEN);if(u&&!l||_===!0&&(r===Qr.createSchema.name||r===Qr.dropSchema.name))return null;if(Q8.indexOf(r)>=0&&(_===!0||Array.isArray(_)))return _===!0||_.indexOf(n)>=0?null:c.handleUnauthorizedItem(`User does not have access to perform '${e.operation}' against schema '${n}'`);let d=GM.getRolePermissions(e.hdb_user.role);if(e.hdb_user.role.permission=d,r===HM||r===qM){if(n===Wr.SYSTEM_SCHEMA_NAME)return c.handleUnauthorizedItem(Lt.SCHEMA_PERM_ERROR(n));if(!d.super_user){if(r===HM&&(!d[n]||!d[n][lu]))return c.handleInvalidItem(Lt.SCHEMA_NOT_FOUND(n));if(r===qM&&(!d[n]||!d[n].tables[i]||!d[n].tables[i][lu]))return c.handleInvalidItem(Lt.TABLE_NOT_FOUND(n,i))}}let f=XM(e.hdb_user,r,o,c,s);if(f)return f;if(v.get(r)&&v.get(r).perms.length===0)return null;if(!u&&e.get_attributes&&Wr.SEARCH_WILDCARDS.includes(e.get_attributes[0])){let p=[],S=d[n].tables[i];S[Wr.PERMS_CRUD_ENUM.READ]&&(S.attribute_permissions.length>0?S.attribute_permissions.filter(b=>b[Wr.PERMS_CRUD_ENUM.READ]).forEach(b=>{p.push(b.attribute_name)}):p=global.hdb_schema[n][i].attributes.map(g=>g.attribute),e.get_attributes=p)}let E=X8(e),h=TT(e.hdb_user.role.permission,n,i);return ST(E,h,r,i,n,c,s),c.getPermsResponse()}a(J8,"verifyPerms");function XM(e,t,r,s,n){if(pn.arrayHasEmptyValues([e,t,r]))throw dt.info("hasPermissions has an invalid parameter"),ar(new Error);let i=r.has("system"),o=e.role.permission;if(o.super_user&&(!i||v.get(t).requires_su))return null;if(!v.get(t))throw dt.info(`operation ${t} not found.`),ar(new Error,Lt.OP_NOT_FOUND(t),uu.BAD_REQUEST);if(v.get(t)&&v.get(t).requires_su)return dt.info(`operation ${t} requires SU permissions.`),s.handleUnauthorizedItem(Lt.OP_IS_SU_ONLY(t));let c=r.keys();for(let u of c){try{if(u&&!o[u]||o[u][lu]===!1){s.addInvalidItem(Lt.SCHEMA_NOT_FOUND(u));continue}}catch{s.addInvalidItem(Lt.SCHEMA_NOT_FOUND(u));continue}let _=r.get(u);for(let l of _){let d=o[u].tables[l];if(!d||d[lu]===!1)s.addInvalidItem(Lt.TABLE_NOT_FOUND(u,l));else try{let f=[],E=v.get(t).perms;!pn.isEmpty(n)&&E.includes(n)&&(E=[n]);for(let h=0;h<E.length;h++){let p=E[h],S=d[p];(S==null||S===!1)&&(dt.info(`Required ${p} permission not found for ${t} ${n?`${n} `:""}operation in role ${e.role.id}`),f.push(p))}f.length>0&&s.addUnauthorizedTable(u,l,f)}catch(f){let E=Lt.UNKNOWN_OP_AUTH_ERROR(t,u,l);throw dt.error(E),dt.error(f),ar(WM.CHECK_LOGS_WRAPPER(E))}}}return r.size<2?s.getPermsResponse():null}a(XM,"hasPermissions");function ST(e,t,r,s,n,i,o){if(!e||!t)throw dt.info("no attributes specified in checkAttributePerms."),ar(new Error);let c=v.get(r).perms;if(!c||c==="")throw dt.info(`no permissions found for ${r} in checkAttributePerms().`),ar(new Error);if(pn.isEmptyOrZeroLength(t))return dt.info("No role permissions set (this is OK)."),null;o&&c.includes(o)&&(c=[o]);let u={};for(let l of e){let d=t.get(l);if(d){if(d[lu]===!1){i.addInvalidItem(Lt.ATTR_NOT_FOUND(n,s,l),n,s);continue}if(c)for(let f of c){if(Wr.TIME_STAMP_NAMES.includes(d.attribute_name)&&f!==Sn)throw ar(new Error,Lt.SYSTEM_TIMESTAMP_PERMS_ERR,uu.FORBIDDEN);d[f]===!1&&(u[d.attribute_name]?u[d.attribute_name].push(f):u[d.attribute_name]=[f])}}else i.addInvalidItem(Lt.ATTR_NOT_FOUND(n,s,l),n,s)}let _=Object.keys(u);_.length>0&&i.addUnauthorizedAttributes(_,n,s,u)}a(ST,"checkAttributePerms");function X8(e){let t=new Set;try{if(e.action)return t;if(e.operation===Wr.OPERATIONS_ENUM.SEARCH_BY_CONDITIONS&&e.conditions.forEach(r=>{t.add(r.search_attribute)}),e&&e.search_attribute&&t.add(e.search_attribute),!e.records||e.records.length===0){if(!e.get_attributes||!e.get_attributes.length===0)return t;for(let r=0;r<e.get_attributes.length;r++)t.add(e.get_attributes[r])}else for(let r=0;r<e.records.length;r++){let s=Object.keys(e.records[r]);for(let n=0;n<s.length;n++)t.add(s[n])}}catch(r){dt.info(r)}return t}a(X8,"getRecordAttributes");function TT(e,t,r){let s=new Map;if(pn.isEmpty(e))return dt.info("no hdb_user specified in getAttributePermissions"),s;if(e.super_user||!t||!r)return s;try{e[t].tables[r].attribute_permissions.forEach(n=>{s.has(n.attribute_name)||s.set(n.attribute_name,n)})}catch{dt.info(`No attribute permissions found for schema ${t} and table ${r}.`)}return s}a(TT,"getAttributePermissions");function j8(e,t,r,s,n,i,o){let c=new Set(i),u=TT(e,s,n);ST(c,u,t,n,s,o,r)}a(j8,"verifyBulkLoadAttributePerms")});var Vd=T((gde,sP)=>{"use strict";sP.exports={evaluateSQL:_6,processAST:rP,convertSQLToAST:tP,checkASTPermissions:eP};var Z8=Gr(),ZM=require("util"),e6=ZM.callbackify(Z8.insert),t6=Fr().search,r6=Gw().update,s6=ZM.callbackify(r6),n6=kw().convertDelete,ii=require("alasql"),i6=xd(),kd=G(),o6=A_(),a6=$(),fu=y(),{hdb_errors:c6,handleHDBError:gT}=j(),{HTTP_STATUS_CODES:RT}=c6;o6(ii);var u6=403,l6="There was a problem performing this insert. Please check the logs and try again.",AT=class{static{a(this,"ParsedSQLObject")}constructor(){this.ast=void 0,this.variant=void 0,this.permissions_checked=!1}};function _6(e,t){let r=e.parsed_sql_object;if(!r){r=tP(e.sql);let s,n=r.ast.statements[0];if(n instanceof ii.yy.Insert?s=n.into.databaseid:n instanceof ii.yy.Select?s=n.from?n.from[0].databaseid:null:n instanceof ii.yy.Update||n instanceof ii.yy.Delete?s=n.table.databaseid:kd.error("AST in evaluateSQL is not a valid SQL type."),!(n instanceof ii.yy.Select)&&a6.isEmptyOrZeroLength(s))return t("No schema specified",null)}rP(e,r,(s,n)=>{if(s)return t(s);t(null,n)})}a(_6,"evaluateSQL");function eP(e,t){let r;try{r=i6.verifyPermsAst(t.ast.statements[0],e.hdb_user,t.variant),t.permissions_checked=!0}catch(s){throw s}return r||null}a(eP,"checkASTPermissions");function tP(e){let t=new AT;if(!e)throw gT(new Error,"The 'sql' parameter is missing from the request body",RT.BAD_REQUEST);try{let r=e.trim(),s=ii.parse(r),n=r.split(" ")[0].toLowerCase();t.ast=s,t.variant=n}catch(r){let s=r.message.split(`
`);throw s[1]?gT(r,`Invalid SQL at: ${s[1]}. Please ensure your SQL is valid. Try adding backticks to reserved words and schema table references.`,RT.BAD_REQUEST):gT(r,"We had trouble parsing your request. Please ensure your SQL is valid. Try adding backticks to reserved words and schema table references.",RT.BAD_REQUEST)}return t}a(tP,"convertSQLToAST");function rP(e,t,r){try{let s=d6;if(!e.bypass_auth&&!t.permissions_checked){let i=eP(e,t);if(i&&i.length>0)return r(u6,i)}let n={statement:t.ast.statements[0],hdb_user:e.hdb_user};switch(t.variant){case fu.VALID_SQL_OPS_ENUM.SELECT:s=t6,n=t.ast.statements[0];break;case fu.VALID_SQL_OPS_ENUM.INSERT:s=f6;break;case fu.VALID_SQL_OPS_ENUM.UPDATE:s=s6;break;case fu.VALID_SQL_OPS_ENUM.DELETE:s=n6;break;default:throw new Error(`unsupported SQL type ${t.variant} in SQL: ${e}`)}s(n,(i,o)=>{if(i){r(i);return}r(null,o)})}catch(s){return r(s)}}a(rP,"processAST");function d6(e,t){kd.info(e),t("unknown sql statement")}a(d6,"nullFunction");function f6({statement:e,hdb_user:t},r){let s=e.into,n={schema:s.databaseid,table:s.tableid,operation:"insert",hdb_user:t},i=e.columns.map(o=>o.columnid);try{n.records=E6(i,e.values)}catch(o){return r(o)}e6(n,(o,c)=>{if(o)return r(o);try{delete c.new_attributes,delete c.txn_time}catch(u){kd.error(`Error delete new_attributes from insert response: ${u}`)}r(null,c)})}a(f6,"convertInsert");function E6(e,t){try{return t.map(r=>{if(e.length!==r.length)throw"number of values do not match number of columns in insert";let s={};return r.forEach((n,i)=>{if(n.columnid)throw"cannot use a column in insert value";"value"in n?s[e[i]]=n.value:s[e[i]]=ii.compile(`SELECT ${n.toString()} AS [${fu.FUNC_VAL}] FROM ?`)}),s})}catch(r){throw kd.error(r),new Error(l6)}}a(E6,"createDataObjects")});var OT=T((Ade,iP)=>{"use strict";var{S3:h6,GetObjectCommand:m6}=require("@aws-sdk/client-s3");iP.exports={getFileStreamFromS3:p6,getS3AuthObj:nP};async function p6(e){let{s3:t}=e,r={Bucket:t.bucket,Key:t.key};return(await nP(t.aws_access_key_id,t.aws_secret_access_key,t.region).send(new m6(r))).Body}a(p6,"getFileStreamFromS3");function nP(e,t,r){return new h6({credentials:{accessKeyId:e,secretAccessKey:t},region:r})}a(nP,"getS3AuthObj")});var $d=T((Nde,hP)=>{"use strict";var cP=Fr(),S6=Vd(),T6=OT(),{AsyncParser:g6,Transform:R6}=require("json2csv"),hu=require("stream"),Cr=$(),NT=require("fs-extra"),A6=require("path"),zr=G(),{promisify:uP}=require("util"),Eu=$(),{handleHDBError:it,hdb_errors:O6}=j(),{HDB_ERROR_MSGS:cr,HTTP_STATUS_CODES:ot}=O6,{streamAsJSON:N6}=VE(),{Upload:b6}=require("@aws-sdk/lib-storage"),oP=["search_by_value","search_by_hash","sql"],aP=["json","csv"],lP="json",_P="csv",y6="Successfully exported JSON locally.",I6="Successfully exported CSV locally.",w6=1e3,C6=cP.searchByHash,L6=cP.searchByValue,D6=uP(S6.evaluateSQL),U6=uP(hu.finished);hP.exports={export_to_s3:B6,export_local:M6,toCsvStream:dP};async function M6(e){zr.trace(`export_local request to path: ${e.path}, filename: ${e.filename}, format: ${e.format}`);let t=fP(e);if(!Cr.isEmpty(t))throw zr.error(t),it(new Error,t,ot.BAD_REQUEST,void 0,void 0,!0);if(Cr.isEmpty(e.path))throw zr.error(cr.MISSING_VALUE("path")),it(new Error,cr.MISSING_VALUE("path"),ot.BAD_REQUEST,void 0,void 0,!0);let r=(Cr.isEmpty(e.filename)?new Date().getTime():e.filename)+"."+e.format;e.path.endsWith(A6.sep)&&(e.path=e.path.substring(0,e.path.length-1));let s=Cr.buildFolderPath(e.path,r);await P6(e.path);let n=await EP(e);return await v6(s,e.format,n)}a(M6,"export_local");async function P6(e){if(zr.trace("in confirmPath"),Cr.isEmptyOrZeroLength(e))throw it(new Error,`Invalid path: ${e}`,ot.BAD_REQUEST,void 0,void 0,!0);let t;try{t=await NT.stat(e)}catch(r){let s;throw r.code==="ENOENT"?s=`path '${e}' does not exist`:r.code==="EACCES"?s=`access to path '${e}' is denied`:s=r.message,zr.error(s),it(new Error,s,ot.BAD_REQUEST,void 0,void 0,!0)}if(!t.isDirectory()){let r=`path '${e}' is not a directory, please supply a valid folder path`;throw zr.error(r),it(new Error,r,ot.BAD_REQUEST,void 0,void 0,!0)}return!0}a(P6,"confirmPath");async function v6(e,t,r){if(zr.trace("in saveToLocal"),Eu.isEmptyOrZeroLength(e))throw it(new Error,cr.INVALID_VALUE("file_path"),ot.BAD_REQUEST,void 0,void 0,!0);if(Eu.isEmptyOrZeroLength(t))throw it(new Error,cr.INVALID_VALUE("Source format"),ot.BAD_REQUEST,void 0,void 0,!0);if(Eu.isEmpty(r))throw it(new Error,cr.NOT_FOUND("Data"),ot.BAD_REQUEST,void 0,void 0,!0);if(t===lP){let s=NT.createWriteStream(e);return N6(r).pipe(s),await U6(s),{message:y6,path:e}}else if(t===_P){let s=NT.createWriteStream(e),n=hu.Readable.from(r),i={},o={objectMode:!0};return await new g6(i,o).fromInput(n).toOutput(s).promise(!1),{message:I6,path:e}}throw it(new Error,cr.INVALID_VALUE("format"),ot.BAD_REQUEST)}a(v6,"saveToLocal");async function B6(e){if(!e.s3||Object.keys(e.s3).length===0)throw it(new Error,cr.MISSING_VALUE("S3 object"),ot.BAD_REQUEST);if(Cr.isEmptyOrZeroLength(e.s3.aws_access_key_id))throw it(new Error,cr.MISSING_VALUE("aws_access_key_id"),ot.BAD_REQUEST);if(Cr.isEmptyOrZeroLength(e.s3.aws_secret_access_key))throw it(new Error,cr.MISSING_VALUE("aws_secret_access_key"),ot.BAD_REQUEST);if(Cr.isEmptyOrZeroLength(e.s3.bucket))throw it(new Error,cr.MISSING_VALUE("bucket"),ot.BAD_REQUEST);if(Cr.isEmptyOrZeroLength(e.s3.key))throw it(new Error,cr.MISSING_VALUE("key"),ot.BAD_REQUEST);if(Cr.isEmptyOrZeroLength(e.s3.region))throw it(new Error,cr.MISSING_VALUE("region"),ot.BAD_REQUEST);let t=fP(e);if(!Cr.isEmpty(t))throw it(new Error,t,ot.BAD_REQUEST);zr.trace(`called export_to_s3 to bucket: ${e.s3.bucket} and query ${e.search_operation.sql}`);let r;try{r=await EP(e)}catch(u){throw zr.error(u),u}let s,n=await T6.getS3AuthObj(e.s3.aws_access_key_id,e.s3.aws_secret_access_key,e.s3.region),i,o=new hu.PassThrough;if(e.format===_P){i=e.s3.key+".csv";let u=dP(r);u.on("error",_=>{throw _}),u.pipe(o)}else if(e.format===lP){i=e.s3.key+".json";let u=new hu.Readable;u.pipe(o),u.on("error",d=>{throw d}),u.push("[");let _=r.length,l="";for(let[d,f]of r.entries()){let E=d===_-1?JSON.stringify(f):JSON.stringify(f)+",";l+=E,d!==0&&d%w6===0&&(u.push(l),l="")}l.length!==0&&u.push(l),u.push("]"),u.push(null)}else throw it(new Error,cr.INVALID_VALUE("format"),ot.BAD_REQUEST);return new b6({client:n,params:{Bucket:e.s3.bucket,Key:i,Body:o}}).done()}a(B6,"export_to_s3");function dP(e){let t=hu.Readable.from(e?.[Symbol.iterator]||e?.[Symbol.asyncIterator]?e:[e]),r={},s={objectMode:!0},n=new R6(r,s);return t.pipe(n)}a(dP,"toCsvStream");function fP(e){if(zr.trace("in exportCoreValidation"),Cr.isEmpty(e.format))return"format missing";if(aP.indexOf(e.format)<0)return`format invalid. must be one of the following values: ${aP.join(", ")}`;let t=e.search_operation.operation;if(Cr.isEmpty(t))return"search_operation.operation missing";if(oP.indexOf(t)<0)return`search_operation.operation must be one of the following values: ${oP.join(", ")}`}a(fP,"exportCoreValidation");async function EP(e){zr.trace("in getRecords");let t,r;if(Eu.isEmpty(e.search_operation)||Eu.isEmptyOrZeroLength(e.search_operation.operation))throw it(new Error,cr.INVALID_VALUE("Search operation"),ot.BAD_REQUEST);switch(e.search_operation.operation){case"search_by_value":t=L6;break;case"search_by_hash":t=C6;break;case"sql":t=D6;break;default:throw r=`Operation ${e.search_operation.operation} is not support by export.`,zr.error(r),it(new Error,r,ot.BAD_REQUEST)}return e.search_operation.hdb_user=e.hdb_user,t(e.search_operation)}a(EP,"getRecords")});var OP={};qe(OP,{contentTypes:()=>yT,findBestSerializer:()=>Wd,getDeserializer:()=>sa,registerContentHandlers:()=>IT,serialize:()=>Qd,serializeMessage:()=>si});function H6(e){try{return e?.[0]===123?JSON.parse(e):e}catch{return e}}function IT(e){e.register(F6,{serializers:[{regex:/^application\/json$/,serializer:Yd.streamAsJSON},{regex:/^application\/cbor$/,serializer:function(t){return new $i.EncoderStream(mu).end(t)}},{regex:/^application\/(x-)?msgpack$/,serializer:function(t){return(t?.[Symbol.iterator]||t?.[Symbol.asyncIterator])&&!Array.isArray(t)?Kd.Readable.from((0,$s.encodeIter)(t,mu)):(0,$s.pack)(t)}},{regex:/^text\/csv$/,serializer:function(t){return this.header("Content-Disposition",'attachment; filename="data.csv"'),(0,bT.toCsvStream)(t)}}]}),e.addContentTypeParser("application/x-msgpack",{parseAs:"buffer"},(t,r,s)=>{try{s(null,(0,$s.unpack)(r))}catch(n){n.statusCode=400,s(n)}}),e.addContentTypeParser("application/cbor",{parseAs:"buffer"},(t,r,s)=>{try{s(null,(0,$i.decode)(r))}catch(n){n.statusCode=400,s(n)}})}function Wd(e){let r=(e.headers.asObject||e.headers).accept,s,n=0,i,o,c=r?r.toLowerCase().split(/\s*,\s*/):[];for(let u of c){let[_,...l]=u.split(/\s*;\s*/),d=1,f={q:1};for(let h of l){let p=h.indexOf("=");f[h.substring(0,p)]=h.substring(p+1)}d=+f.q;let E=Dt.get(_);if(E){let h=(E.q||1)*d;h>n&&(s=E,i=E.type||_,n=h,o=f)}}if(!s){if(r)return{serializer(){this.code(406).send("No supported content types found in Accept header, supported types include: "+Array.from(Dt.keys()).join(", "))}};s=Dt.get("application/json"),i="application/json"}return{serializer:s,type:i,parameters:o}}function Qd(e,t,r){let s=pP&&t.headers.asObject?.["accept-encoding"]?.includes("br"),n;if(e?.contentType!=null&&e.data!=null)r.headers.set("Content-Type",e.contentType),r.headers.set("Vary","Accept-Encoding"),n=e.data;else if(e instanceof Uint8Array)r.headers.set("Content-Type","application/octet-stream"),r.headers.set("Vary","Accept-Encoding"),n=e;else{let i=Wd(t);if(r.headers.set("Vary","Accept, Accept-Encoding"),r.headers.set("Content-Type",i.type),typeof e=="object"&&(e[Symbol.iterator]||e[Symbol.asyncIterator])&&i.serializer.serializeStream){let o=i.serializer.serializeStream(e);return s&&(r.headers.set("Content-Encoding","br"),o=o.pipe((0,Tn.createBrotliCompress)({params:{[Tn.constants.BROTLI_PARAM_MODE]:i.type.includes("json")||i.type.includes("text")?Tn.constants.BROTLI_MODE_TEXT:Tn.constants.BROTLI_MODE_GENERIC,[Tn.constants.BROTLI_PARAM_QUALITY]:2}}))),o}n=i.serializer.serialize(e)}return s&&n?.length>pP?(r.headers.set("Content-Encoding","br"),new Promise((i,o)=>(0,Tn.brotliCompress)(n,(c,u)=>{c?o(c):i(u)}))):n}function si(e,t){if(e?.contentType!=null&&e.data!=null)return e.data;if(!t)return JSON.stringify(e);let r=t.serialize;if(r)return r(e);let s=Wd(t);return r=t.serialize=s.serializer.serialize,r(e)}function G6(e){return new Promise((t,r)=>{let s=[];e.on("data",n=>s.push(n)),e.on("end",()=>t(Buffer.concat(s))),e.on("error",r)})}function sa(e,t){e||(e="");let r=e.indexOf(";"),s;r>-1&&(s=e.slice(r+1),e=e.slice(0,r));let n=Dt.get(e);if(t){if(n?.deserializeStream)return n.deserializeStream;let i=Dt.get(e)?.deserialize||SP(e,s);return o=>G6(o).then(i)}return e&&Dt.get(e)?.deserialize||SP(e,s)}function SP(e,t){if(e.startsWith("text/")){let r=t?.match(/charset=(.+)/)?.[1]||"utf-8";return s=>({contentType:e,data:s.toString(r)})}else return e==="application/octet-stream"?r=>r:r=>{if(!e)try{if(r?.[0]===123)return JSON.parse(r)}catch{}return{contentType:e||"application/octet-stream",data:r}}}function x6(e,t){return{[Symbol.asyncIterator](){let r=e[Symbol.asyncIterator]?e[Symbol.asyncIterator]():e[Symbol.iterator]();return{next(){let s=r.next();return s.then?s.then(n=>({value:t(n.value),done:n.done})):{value:t(s.value),done:s.done}},return(s){return r.return(s)},throw(s){return r.throw(s)}}}}}var Yd,bT,$s,$i,Tn,Kd,TP,gP,RP,mu,Dt,yT,mP,AP,q6,F6,pP,Jo=Te(()=>{Yd=M(VE()),bT=M($d()),$s=require("msgpackr"),$i=require("cbor-x"),Tn=require("zlib"),Kd=require("stream");hr();TP=require("../../index"),gP=M(X()),RP=M(y()),mu={useRecords:!1,useToJSON:!0},Dt=new Map,yT=Dt;ut.contentTypes=yT;(0,TP._assignPackageExport)("contentTypes",yT);Dt.set("application/json",{serializeStream:Yd.streamAsJSON,serialize:JSON.stringify,deserialize:JSON.parse,q:.8});mP=new $i.Encoder(mu);Dt.set("application/cbor",{serializeStream(e){return e[Symbol.asyncIterator]&&(e[Symbol.iterator]=null),new $i.EncoderStream(mu).end(e)},serialize:mP.encode,deserialize:mP.decode,q:1});Dt.set("application/x-msgpack",{serializeStream(e){return(e?.[Symbol.iterator]||e?.[Symbol.asyncIterator])&&!Array.isArray(e)?Kd.Readable.from((0,$s.encodeIter)(e,mu)):(0,$s.pack)(e)},serialize:$s.pack,deserialize:$s.unpack,q:.9});Dt.set("text/csv",{serializeStream(e){return this.header("Content-Disposition",'attachment; filename="data.csv"'),(0,bT.toCsvStream)(e)},q:.1});Dt.set("text/plain",{serialize(e){return e.toString()},deserialize(e){return e.toString()},q:.01});Dt.set("text/event-stream",{serializeStream:function(e){return Kd.Readable.from(x6(e,this.serialize))},serialize:function(e){if(e.acknowledge&&e.acknowledge(),typeof e=="object"&&"value"in e&&e.timestamp&&(e={data:e.value,event:e.type,id:e.timestamp}),e.data||e.event){let t="";if(e.event&&(t+="event: "+e.event+`
`),e.data){let r=e.data;typeof r=="object"&&(r=JSON.stringify(r)),t+="data: "+r+`
`}return e.id&&(t+="id: "+e.id+`
`),e.retry&&(t+="retry: "+e.retry+`
`),t+`
`}else return typeof e=="object"?`data: ${JSON.stringify(e)}

`:`data: ${e}

`},q:.8});Dt.set("application/x-www-form-urlencoded",{deserialize(e){let t={};for(let[r,s]of new URLSearchParams(e))if(t.hasOwnProperty(r)){let n=t[r];Array.isArray(n)?n.push(s):t.key=[n,s]}else t[r]=s},serialize(e){let t=new URLSearchParams;for(let r in e)t.set(r,e);return t.toString()}});AP={type:"application/json",serializeStream:Yd.streamAsJSON,serialize:JSON.stringify,deserialize:H6,q:.8};Dt.set("*/*",AP);Dt.set("",AP);a(H6,"tryJSONParse");a(IT,"registerContentHandlers");q6=require("fastify-plugin"),F6=q6(function(e,t,r){e.addHook("preSerialization",async(s,n)=>{if(n.raw.getHeader("content-type"))return;let{serializer:o,type:c}=Wd(s.raw);n.type(c),n.serializer(o.serializeStream||o.serialize)}),r()},{name:"content-type-negotiation"});a(Wd,"findBestSerializer");pP=gP.default.get(RP.CONFIG_PARAMS.HTTP_COMPRESSIONTHRESHOLD);a(Qd,"serialize");a(si,"serializeMessage");a(G6,"streamToBuffer");a(sa,"getDeserializer");a(SP,"deserializerUnknownType");a(x6,"transformIterable")});var zd={};qe(zd,{start:()=>$6});async function V6(e,t){let r=e.headers.asObject,s=r.accept==="text/event-stream"?"CONNECT":e.method;e.search&&hl(e);let n=new ri;try{e.responseHeaders=n;let i=e.url.slice(1),o=CT.getMatch(i);if(!o)return t(e);e.handlerPath=o.path;let c={url:o.relativeURL,async:!0},u=o.Resource,_=r["cache-control"];if(_){_=_.toLowerCase();let p=_.match(/max-age=(\d+)/)?.[1];p&&(e.expiresAt=p*1e3+Date.now()),_.includes("only-if-cached")&&(e.onlyIfCached=!0),_.includes("no-cache")&&(e.noCache=!0),_.includes("no-store")&&(e.noCacheStore=!0),_.includes("stale-if-error")&&(e.staleIfError=!0),_.includes("must-revalidate")&&(e.mustRevalidate=!0)}let l=await Ge(e,()=>{if(s==="POST"||s==="PUT"||s==="PATCH"||s==="QUERY")try{e.data=sa(r["content-type"],!0)(e.body)}catch(p){throw new Su.ClientError(p,400)}switch(e.authorize=!0,s){case"GET":case"HEAD":return u.get(c,e);case"POST":return u.post(c,e.data,e);case"PUT":return u.put(c,e.data,e);case"DELETE":return u.delete(c,e);case"PATCH":return u.patch(c,e.data,e);case"OPTIONS":n.setIfNone("Allow","GET, HEAD, POST, PUT, DELETE, PATCH, OPTIONS, TRACE, QUERY, COPY, MOVE");return;case"CONNECT":return u.connect(c,null,e);case"TRACE":return"HarperDB is the terminating server";case"QUERY":return u.query(c,e.data,e);case"COPY":return u.copy(c,r.destination,e);case"MOVE":return u.move(c,r.destination,e);case"BREW":throw new Su.ClientError("HarperDB is short and stout and can't brew coffee",418);default:throw new Su.ServerError(`Method ${s} is not recognized`,501)}}),d=200,f;if(l==null)d=s==="GET"||s==="HEAD"?404:204,wT.lastModified&&e.lastModified&&n.setIfNone("Last-Modified",new Date(e.lastModified).toUTCString());else if(f=e.lastModified){k6[0]=f;let p=String.fromCharCode(34,(Ut[0]&63)+62,(Ut[0]>>6)+(Ut[1]<<2&63)+62,(Ut[1]>>4)+(Ut[2]<<4&63)+62,(Ut[2]>>2)+62,(Ut[3]&63)+62,(Ut[3]>>6)+(Ut[4]<<2&63)+62,(Ut[4]>>4)+(Ut[5]<<4&63)+62,(Ut[5]>>2)+62,(Ut[6]&63)+62,(Ut[6]>>6)+(Ut[7]<<2&63)+62,34),S=r["if-none-match"];S&&p==S?(l?.onDone&&l.onDone(),d=304,l=void 0):n.setIfNone("ETag",p),wT.lastModified&&n.setIfNone("Last-Modified",new Date(f).toUTCString())}e.createdResource&&(d=201),e.newLocation&&n.setIfNone("Location",e.newLocation);let E={status:d,headers:n,body:void 0},h=l?.wasLoadedFromSource?.();return h!==void 0&&(E.wasCacheMiss=h,!h&&f&&n.setIfNone("Age",Math.round((Date.now()-(e.lastRefreshed||f))/1e3))),l!==void 0&&(E.body=Qd(l,e,E),s==="HEAD"&&(E.body=void 0)),E}catch(i){i.statusCode?i.statusCode===500?Yi.warn(i):Yi.info(i):Yi.error(i),i.statusCode===405&&(i.method&&(i.message+=` to handle HTTP method ${i.method.toUpperCase()||""}`),i.allow&&(i.allow.push("trace","head","options"),n.setIfNone("Allow",i.allow.map(c=>c.toUpperCase()).join(", "))));let o={status:i.statusCode||500,headers:n,body:void 0};return o.body=Qd(i.contentType?i:i.toString(),e,o),o}}function $6(e){wT=e,!NP&&(NP=!0,CT=e.resources,e.server.http(async(t,r)=>{if(!t.isWebSocket)return V6(t,r)}),e.server.ws(async(t,r,s)=>{pu++;let n=new rs;bP||(bP=!0,yc(l=>{pu>0&&l.push({metric:"ws-connections",connections:pu,byThread:!0})}));let i;t.on("error",l=>{i=!0,Yi.warn(l)});let o;t.on("message",a(function(d){o||(o=sa(r.headers.asObject["content-type"]));let f=o(d);n.push(f)},"message"));let c;t.on("close",()=>{pu--,kr(!i,"connection","ws","disconnect"),n.emit("close"),c&&c.return()}),await s;let u=r.url.slice(1),_=CT.getMatch(u);if(kr(!!_,"connection","ws","connect"),!_)t.send(si(`No resource was found to handle ${r.pathname}`,r));else{r.handlerPath=_.path,br(h=>({count:h.count,total:pu}),"connections",r.handlerPath,"connect","ws");let l={url:_.relativeURL,async:!0},d=_.Resource;c=(await Ge(r,()=>d.connect(l,n,r)))[Symbol.asyncIterator]();let E;for(;!(E=await c.next()).done;){let h=si(E.value,r);t.send(h),br(h.length,"bytes-sent",r.handlerPath,"message","ws")}}t.close()}))}var Yi,Su,Ut,k6,wT,NP,CT,bP,pu,yP=Te(()=>{Jo();ln();Yi=M(G()),Su=M(j());ml();Ha();Ei();Ad();Ut=new Uint8Array(8),k6=new Float64Array(Ut.buffer,0,1),wT={};a(V6,"http");pu=0;a($6,"start")});var LT=T((vde,IP)=>{var{recordAction:Jd,recordActionBinary:Y6}=(ln(),Z(Ic)),K6=require("fastify-plugin"),W6=200;IP.exports=K6(function(e,t,r){e.addHook("onResponse",async(s,n)=>{n.getResponseTime()}),e.addHook("onSend",async(s,n,i)=>{let o=n.getResponseTime(),c=performance.now(),u=n.context.config,_,l,d;u.isOperation?(_=s.body?.operation,l="operation"):(_=u.url,l="fastify-route",d=u.method),Jd(o,"duration",_,d,l),Y6(n.raw.statusCode<400,"success",_,d,l);let f=W6;i?.pipe?(i.on("data",h=>{f+=h.length}),i.on("end",()=>{Jd(performance.now()-c,"transfer",_,d,l),Jd(f,"bytes-sent",_,d,l)})):(f+=i?.length||0,Jd(f,"bytes-sent",_,d,l));let E=o.toFixed(3);n.header("Server-Timing",`db;dur=${E}`)}),r()},{name:"hdb-request-time"})});var PT=T((Bde,UP)=>{var tf=require("clone"),rf=ke(),Q6=$(),Zd=y(),z6=G(),Xd=require("fs"),DT=require("joi"),{string:ef}=DT.types(),{hdb_errors:J6,handleHDBError:Tu}=j(),{HDB_ERROR_MSGS:X6,HTTP_STATUS_CODES:jd}=J6,{common_validators:na}=Ls(),wP=1e9,CP=" is required",j6=["insert","update","upsert"],UT={database:{presence:!1,format:na.schema_format,length:na.schema_length},schema:{presence:!1,format:na.schema_format,length:na.schema_length},table:{presence:!0,format:na.schema_format,length:na.schema_length},action:{inclusion:{within:j6,message:"is required and must be either insert, update, or upsert"}},file_path:{},csv_url:{url:{allowLocal:!0}},data:{},passthrough_headers:{}},Z6={schema:ef.required(),table:ef.required(),action:ef.valid("insert","update","upsert")},{AWS_ACCESS_KEY:e9,AWS_SECRET:t9,AWS_BUCKET:r9,AWS_FILE_KEY:s9,REGION:n9}=Zd.S3_BUCKET_AUTH_KEYS,i9={s3:{presence:!0},[`s3.${e9}`]:{presence:!0,type:"String"},[`s3.${t9}`]:{presence:!0,type:"String"},[`s3.${r9}`]:{presence:!0,type:"String"},[`s3.${s9}`]:{presence:!0,type:"String",hasValidFileExt:[".csv",".json"]},[`s3.${n9}`]:{presence:!0,type:"String"}},LP=tf(UT);LP.data.presence={message:CP};var DP=tf(UT);DP.file_path.presence={message:CP};var o9=Object.assign(tf(UT),i9),MT=tf(Z6);MT.csv_url=ef.uri().messages({"string.uri":"'csv_url' must be a valid url"}).required();MT.passthrough_headers=DT.object();function a9(e){let t=rf.validateObject(e,LP);return sf(e,t)}a(a9,"dataObject");function c9(e){let t=rf.validateBySchema(e,DT.object(MT));return sf(e,t)}a(c9,"urlObject");function u9(e){let t=rf.validateObject(e,DP);return sf(e,t)}a(u9,"fileObject");function l9(e){let t=rf.validateObject(e,o9);return sf(e,t)}a(l9,"s3FileObject");function sf(e,t){if(!t){let r=Q6.checkGlobalSchemaTable(e.schema,e.table);if(r)return Tu(new Error,r,jd.BAD_REQUEST);if(e.operation===Zd.OPERATIONS_ENUM.CSV_FILE_LOAD){try{Xd.accessSync(e.file_path,Xd.constants.R_OK|Xd.constants.F_OK)}catch(s){return s.code===Zd.NODE_ERROR_CODES.ENOENT?Tu(s,`No such file or directory ${s.path}`,jd.BAD_REQUEST):s.code===Zd.NODE_ERROR_CODES.EACCES?Tu(s,`Permission denied ${s.path}`,jd.BAD_REQUEST):Tu(s)}try{let s=Xd.statSync(e.file_path).size;if(s>wP)return Tu(new Error,X6.MAX_FILE_SIZE_ERR(s,wP),jd.BAD_REQUEST)}catch(s){z6.error(s),console.error(s)}}}return t}a(sf,"postValidateChecks");UP.exports={dataObject:a9,urlObject:c9,fileObject:u9,s3FileObject:l9}});var vT=T((qde,MP)=>{"use strict";var gu=G(),nf=y();async function _9(e,t,r,s=void 0){if(!e||typeof e!="function")throw new Error("Invalid function parameter");let n;try{return n=await e(t),r&&await r(t,n,s),t.operation===nf.OPERATIONS_ENUM.INSERT||t.operation===nf.OPERATIONS_ENUM.UPDATE||t.operation===nf.OPERATIONS_ENUM.UPSERT?(delete n.new_attributes,delete n.txn_time):t.operation===nf.OPERATIONS_ENUM.DELETE&&delete n.txn_time,n}catch(i){throw i.message&&typeof i.message=="string"&&i.message.includes("already exists")?(gu.info(i.message),i):i.http_resp_msg?(gu.error(`Error calling operation: ${e.name}`),gu.error(i.http_resp_msg),i):(gu.error(`Error calling operation: ${e.name}`),gu.error(i),i)}}a(_9,"callOperationFunctionAsAwait");MP.exports={callOperationFunctionAsAwait:_9}});var vP=T((Gde,PP)=>{"use strict";var BT=class{static{a(this,"BulkLoadFileObject")}constructor(t,r,s,n,i,o,c=null){this.op=t,this.action=r,this.schema=s,this.table=n,this.file_path=i,this.file_type=o,this.role_perms=c}},HT=class{static{a(this,"BulkLoadDataObject")}constructor(t,r,s,n){this.action=t,this.schema=r,this.table=s,this.data=n}};PP.exports={BulkLoadFileObject:BT,BulkLoadDataObject:HT}});var HP=T((kde,BP)=>{"use strict";var qT=class{static{a(this,"ClusteringOriginObject")}constructor(t,r,s){this.timestamp=t,this.user=r,this.node_name=s}};BP.exports=qT});var $T=T((Qde,ev)=>{"use strict";var of=Gr(),cf=PT(),d9=require("needle"),Ss=y(),$de=Ve(),ia=$(),{handleHDBError:Ye,hdb_errors:KP}=j(),{HTTP_STATUS_CODES:Mt,HDB_ERROR_MSGS:ft,CHECK_LOGS_WRAPPER:Wi}=KP,oa=G(),FT=require("papaparse");ia.promisifyPapaParse();var Ts=require("fs-extra"),f9=require("path"),{chain:qP}=require("stream-chain"),FP=require("stream-json/streamers/StreamArray"),GP=require("stream-json/utils/Batch"),xP=require("stream-chain/utils/comp"),{finished:kP}=require("stream"),E9=X(),WP=vT(),h9=OT(),{BulkLoadFileObject:xT,BulkLoadDataObject:m9}=vP(),kT=fT(),{verifyBulkLoadAttributePerms:QP}=xd(),Yde=HP(),Kde=_t(),Wde=sn(),{databases:p9}=(Ee(),Z(Ce)),{coerceType:S9}=(uf(),Z(YT)),VP="No records parsed from csv file.",Ki=`${E9.get("HDB_ROOT")}/tmp`,{schema_regex:T9}=Ls(),$P=1024*1024*2,YP=5e3,g9={"text/csv":!0,"application/octet-stream":!0,"text/plain":!0,"application/vnd.ms-excel":!0};ev.exports={csvDataLoad:R9,csvURLLoad:A9,csvFileLoad:O9,importFromS3:N9};async function R9(e,t){let r=cf.dataObject(e);if(r)throw Ye(r,r.message,Mt.BAD_REQUEST,void 0,void 0,!0);let s={};try{let n=XP(e.schema,e.table),i=FT.parse(e.data,{header:!0,skipEmptyLines:!0,transform:GT.bind(null,n),dynamicTyping:!1}),o=new kT;e.hdb_user&&e.hdb_user.role&&e.hdb_user.role.permission&&e.hdb_user.role.permission.super_user!==!0&&QP(e.hdb_user.role.permission,this.job_operation_function.name,e.action,e.schema,e.table,i.meta.fields,o);let c=o.getPermsResponse();if(c)throw Ye(new Error,c,Mt.BAD_REQUEST,void 0,void 0,!0);let u=new m9(e.action,e.schema,e.table,i.data);return s=await WP.callOperationFunctionAsAwait(jP,u,null),s.message===VP?VP:ZP(s.records,s.number_written)}catch(n){throw Qi(n)}}a(R9,"csvDataLoad");async function A9(e){let t=cf.urlObject(e);if(t)throw Ye(t,t.message,Mt.BAD_REQUEST,void 0,void 0,!0);let r=`${Date.now()}.csv`,s=`${Ki}/${r}`;try{await b9(e,r)}catch(n){throw oa.error(ft.DOWNLOAD_FILE_ERR(r)+" - "+n),Ye(n,Wi(ft.DOWNLOAD_FILE_ERR(r)))}try{let n=new xT(this.job_operation_function.name,e.action,e.schema,e.table,s,Ss.VALID_S3_FILE_TYPES.CSV,e.hdb_user.role.permission),i=await VT(n);return await af(s),i}catch(n){throw await af(s),Qi(n)}}a(A9,"csvURLLoad");async function O9(e){let t=cf.fileObject(e);if(t)throw Ye(t,t.message,Mt.BAD_REQUEST,void 0,void 0,!0);let r=new xT(this.job_operation_function.name,e.action,e.schema,e.table,e.file_path,Ss.VALID_S3_FILE_TYPES.CSV,e.hdb_user.role.permission);try{return await VT(r)}catch(s){throw Qi(s)}}a(O9,"csvFileLoad");async function N9(e){let t=cf.s3FileObject(e);if(t)throw Ye(t,t.message,Mt.BAD_REQUEST,void 0,void 0,!0);let r;try{let s=f9.extname(e.s3.key),n=`${Date.now()}${s}`;r=`${Ki}/${n}`;let i=new xT(this.job_operation_function.name,e.action,e.schema,e.table,r,s,e.hdb_user.role.permission);await y9(n,e);let o=await VT(i);return await af(r),o}catch(s){throw await af(r),Qi(s)}}a(N9,"importFromS3");async function b9(e,t){let r;try{let s=e.passthrough_headers?{headers:e.passthrough_headers}:void 0;r=await d9("get",e.csv_url,s)}catch(s){let n=`Error downloading CSV file from ${e.csv_url}, status code: ${s.statusCode}. Check the log for more information.`;throw Ye(s,n,s.statusCode,Ss.LOG_LEVELS.ERROR,"Error downloading CSV file - "+s)}w9(r,e.csv_url),await I9(t,r.raw)}a(b9,"downloadCSVFile");async function y9(e,t){try{let r=`${Ki}/${e}`;await Ts.mkdirp(Ki),await Ts.writeFile(`${Ki}/${e}`,"",{flag:"a+"});let s=await Ts.createWriteStream(r),n=await h9.getFileStreamFromS3(t);await new Promise((i,o)=>{n.on("error",function(c){o(c)}),n.pipe(s).on("error",function(c){o(c)}).on("close",function(){oa.info(`${t.s3.key} successfully downloaded to ${r}`),i()})})}catch(r){throw oa.error(ft.S3_DOWNLOAD_ERR+" - "+r),Ye(r,Wi(ft.S3_DOWNLOAD_ERR))}}a(y9,"downloadFileFromS3");async function I9(e,t){try{await Ts.mkdirp(Ki),await Ts.writeFile(`${Ki}/${e}`,t)}catch(r){throw oa.error(ft.WRITE_TEMP_FILE_ERR),Ye(r,Wi(ft.DEFAULT_BULK_LOAD_ERR))}}a(I9,"writeFileToTempFolder");async function af(e){if(e)try{await Ts.access(e),await Ts.unlink(e)}catch{oa.warn(`could not delete temp csv file at ${e}, file does not exist`)}}a(af,"deleteTempFile");function w9(e,t){if(e.statusCode!==KP.HTTP_STATUS_CODES.OK)throw Ye(new Error,`CSV Load failed from URL: ${t}, status code: ${e.statusCode}, message: ${e.statusMessage}`,Mt.BAD_REQUEST);if(!g9[e.headers["content-type"]])throw Ye(new Error,`CSV Load failed from URL: ${t}, unsupported content type: ${e.headers["content-type"]}`,Mt.BAD_REQUEST);if(!e.raw)throw Ye(new Error,`CSV Load failed from URL: ${t}, no csv found at url`,Mt.BAD_REQUEST)}a(w9,"validateURLResponse");async function VT(e){try{let t;switch(e.file_type){case Ss.VALID_S3_FILE_TYPES.CSV:t=await C9(e);break;case Ss.VALID_S3_FILE_TYPES.JSON:t=await L9(e);break;default:throw Ye(new Error,ft.DEFAULT_BULK_LOAD_ERR,Mt.BAD_REQUEST,Ss.LOG_LEVELS.ERROR,ft.INVALID_FILE_EXT_ERR(e))}return ZP(t.records,t.number_written)}catch(t){throw Qi(t)}}a(VT,"fileLoad");async function zP(e,t,r,s,n){let i=s.data?s.data:s;if(i.length===0)return;n&&n.pause();let o={operation:e.action,schema:e.schema,table:e.table,records:i};try{let{attributes:c}=await of.validation(o);e.role_perms&&e.role_perms.super_user!==!0&&QP(e.role_perms,e.op,e.action,e.schema,e.table,c,t),n&&n.resume()}catch(c){let u=Ye(c);r(u)}}a(zP,"validateChunk");async function JP(e,t,r,s,n){let i=s.data?s.data:s;if(i.length===0)return;ia.autoCastJSONDeep(i),n&&n.pause();let o=s.meta?s.meta.fields:null;if(o)i.forEach(c=>{!ia.isEmpty(c)&&!ia.isEmpty(c.__parsed_extra)&&delete c.__parsed_extra});else{let c=new Set;i.forEach(u=>{Object.keys(u).forEach(_=>c.add(_))}),o=[...c]}try{let c={schema:e.schema,table:e.table,action:e.action,data:i},u=await WP.callOperationFunctionAsAwait(jP,c,null);t.records+=u.records,t.number_written+=u.number_written,n&&n.resume()}catch(c){let u=Ye(c,Wi(ft.INSERT_CSV_ERR),Mt.INTERNAL_SERVER_ERROR,Ss.LOG_LEVELS.ERROR,ft.INSERT_CSV_ERR+" - "+c);r(u)}}a(JP,"insertChunk");async function C9(e){let t={records:0,number_written:0},r=XP(e.schema,e.table);try{let s=new kT,n=Ts.createReadStream(e.file_path,{highWaterMark:$P});n.setEncoding("utf8"),await FT.parsePromise(n,zP.bind(null,e,s),GT.bind(null,r));let i=s.getPermsResponse();if(i)throw Ye(new Error,i,Mt.BAD_REQUEST);return n=Ts.createReadStream(e.file_path,{highWaterMark:$P}),n.setEncoding("utf8"),await FT.parsePromise(n,JP.bind(null,e,t),GT.bind(null,r)),n.destroy(),t}catch(s){throw Ye(s,Wi(ft.PAPA_PARSE_ERR),Mt.INTERNAL_SERVER_ERROR,Ss.LOG_LEVELS.ERROR,ft.PAPA_PARSE_ERR+s)}}a(C9,"callPapaParse");function XP(e,t){let r=p9[e][t].attributes,s=new Map;for(let n of r)n.type&&s.set(n.name,i=>S9(i,n));return s}a(XP,"createTransformMap");function GT(e,t,r){let s=e.get(r);return s?s(t):ia.autoCast(t)}a(GT,"typeFunction");async function L9(e){let t={records:0,number_written:0},r=a(s=>{throw s},"throwErr");try{let s=new kT,n=qP([Ts.createReadStream(e.file_path,{encoding:"utf-8"}),FP.withParser(),c=>c.value,new GP({batchSize:YP}),xP(async c=>{await zP(e,s,r,c)})]);await new Promise((c,u)=>{kP(n,_=>{_?u(_):c()}),n.resume()});let i=s.getPermsResponse();if(i)throw Ye(new Error,i,Mt.BAD_REQUEST);let o=qP([Ts.createReadStream(e.file_path,{encoding:"utf-8"}),FP.withParser(),c=>c.value,new GP({batchSize:YP}),xP(async c=>{await JP(e,t,r,c)})]);return await new Promise((c,u)=>{kP(o,_=>{_?u(_):c()}),o.resume()}),t}catch(s){throw Ye(s,Wi(ft.INSERT_JSON_ERR),Mt.INTERNAL_SERVER_ERROR,Ss.LOG_LEVELS.ERROR,ft.INSERT_JSON_ERR+s)}}a(L9,"insertJson");async function jP(e){let t={};try{e.data&&e.data.length>0&&D9(e.data[0])?t=await U9(e.data,e.schema,e.table,e.action):(t.message="No records parsed from csv file.",oa.info(t.message))}catch(r){throw Qi(r)}return t}a(jP,"callBulkFileLoad");function D9(e){let t=Object.keys(e);for(let r of t)if(!T9.test(r))throw new Error(`Invalid column name '${r}', cancelling load operation`);return!0}a(D9,"validateColumnNames");async function U9(e,t,r,s){s||(s="insert");let n={operation:s,schema:t,table:r,records:e},i;switch(s){case"insert":i=of.insert;break;case"update":i=of.update;break;case"upsert":i=of.upsert;break;default:throw Ye(new Error,ft.INVALID_ACTION_PARAM_ERR(s),Mt.BAD_REQUEST,Ss.LOG_LEVELS.ERROR,ft.INVALID_ACTION_PARAM_ERR(s))}try{let o=await i(n),c;switch(s){case"insert":c=o.inserted_hashes;break;case"update":c=o.update_hashes;break;case"upsert":c=o.upserted_hashes;break;default:break}if(Array.isArray(o.skipped_hashes)&&o.skipped_hashes.length>0){let l=global.hdb_schema[t][r].hash_attribute,d=e.length;for(;d--;)o.skipped_hashes.indexOf(e[d][l])>=0&&e.splice(d,1)}let u=ia.isEmptyOrZeroLength(c)?0:c.length;return{records:e.length,number_written:u,new_attributes:o.new_attributes}}catch(o){throw Qi(o)}}a(U9,"bulkFileLoad");function ZP(e,t){return`successfully loaded ${t} of ${e} records`}a(ZP,"buildResponseMsg");function Qi(e){return Ye(e,Wi(ft.DEFAULT_BULK_LOAD_ERR),Mt.INTERNAL_SERVER_ERROR,Ss.LOG_LEVELS.ERROR,ft.DEFAULT_BULK_LOAD_ERR+" - "+e)}a(Qi,"buildTopLevelErrMsg")});var rv=T((Jde,tv)=>{"use strict";var KT=class{static{a(this,"SqlSearchObject")}constructor(t,r){this.operation="sql",this.sql=t,this.hdb_user=r}};tv.exports=KT});var iv=T((jde,nv)=>{"use strict";var M9=y(),sv=require("moment"),P9=require("uuid").v4,WT=class{static{a(this,"JobObject")}constructor(){this.id=P9(),this.type=void 0,this.start_datetime=sv().valueOf(),this.created_datetime=sv().valueOf(),this.end_datetime=void 0,this.status=M9.JOB_STATUS_ENUM.CREATED,this.message=void 0,this.user=void 0,this.request=void 0}};nv.exports=WT});var QT=T((efe,_v)=>{"use strict";var v9=require("uuid").v4,cv=Gr(),uv=Fr(),B9=vs(),H9=Io(),q9=rv(),Ke=y(),F9=iv(),G9=Vp(),Jr=G(),x9=ja(),aa=$(),{promisify:k9}=require("util"),zi=require("moment"),V9=Vd(),lf=PT(),ov=xh(),{deleteTransactionLogsBeforeValidator:$9}=cT(),{handleHDBError:Y9,hdb_errors:K9}=j(),{HTTP_STATUS_CODES:W9}=K9,av=uv.searchByValue,Q9=uv.searchByHash,z9=cv.insert,J9=k9(V9.evaluateSQL),X9=cv.update;_v.exports={addJob:e7,updateJob:r7,handleGetJob:j9,handleGetJobsByStartDate:Z9,getJobById:lv};async function j9(e){try{let t=await lv(e.id);return aa.isEmptyOrZeroLength(t)||(t[0]={...t[0]},t[0].request!==void 0&&delete t[0].request,delete t[0].__createdtime__,delete t[0].__updatedtime__),t}catch(t){let r=`There was an error getting job: ${t}`;throw Jr.error("There was an error getting job",t),new Error(r)}}a(j9,"handleGetJob");async function Z9(e){try{let t=await t7(e);if(Jr.trace(`Searching for jobs from ${e.from_date} to ${e.to_date}`),t&&t.length>0)for(let r of t)r.start_datetime&&(r.start_datetime_converted=zi(r.start_datetime)),r.end_datetime&&(r.end_datetime_converted=zi(r.end_datetime)),r.request!==void 0&&delete r.request,delete r.__createdtime__,delete r.__updatedtime__;return t}catch(t){let r=`There was an error searching jobs by date: ${t}`;throw Jr.error(r),new Error(r)}}a(Z9,"handleGetJobsByStartDate");async function e7(e){let t={message:"",error:"",success:!1,createdJob:void 0};if(!e||Object.keys(e).length===0||aa.isEmptyOrZeroLength(e.operation)){let l="job parameter is invalid";return Jr.info(l),t.error=l,t}if(!Ke.JOB_TYPE_ENUM[e.operation])return Jr.info(`invalid job type specified: ${e.operation}.`),t;let r=e.operation,s;switch(r){case Ke.OPERATIONS_ENUM.CSV_FILE_LOAD:s=lf.fileObject(e);break;case Ke.OPERATIONS_ENUM.CSV_URL_LOAD:s=lf.urlObject(e);break;case Ke.OPERATIONS_ENUM.CSV_DATA_LOAD:s=lf.dataObject(e);break;case Ke.OPERATIONS_ENUM.IMPORT_FROM_S3:s=lf.s3FileObject(e);break;case Ke.OPERATIONS_ENUM.DELETE_FILES_BEFORE:case Ke.OPERATIONS_ENUM.DELETE_RECORDS_BEFORE:s=ov(e,"date");break;case Ke.OPERATIONS_ENUM.DELETE_AUDIT_LOGS_BEFORE:s=ov(e,"timestamp");break;case Ke.OPERATIONS_ENUM.DELETE_TRANSACTION_LOGS_BEFORE:s=$9(e);break;default:break}if(s)throw Y9(s,s.message,W9.BAD_REQUEST,void 0,void 0,!0);let n=new F9;n.type=e.operation===Ke.OPERATIONS_ENUM.DELETE_RECORDS_BEFORE?Ke.OPERATIONS_ENUM.DELETE_FILES_BEFORE:e.operation,n.type=e.operation,n.user=e.hdb_user.username;let i=new B9(Ke.SYSTEM_SCHEMA_NAME,Ke.SYSTEM_TABLE_NAMES.JOB_TABLE_NAME,"id",n.id,"id",["id"]),o;try{o=Array.from(await av(i))}catch(l){let d=`There was an error inserting a new job: ${l}`;return Jr.error(d),t}let c=Array.isArray(o)?o:Object.keys(o);if(c&&c.length>0){n.id=v9();try{o=await av(i)}catch(l){let d=`There was an error inserting a new job: ${l}`;return Jr.error(d),t}if(c=Array.isArray(o)?o:Object.keys(o),c&&c.length>0)return Jr.error("Error creating a job, could not find a unique job id."),t}n.request=e;let u=new x9(Ke.SYSTEM_SCHEMA_NAME,Ke.SYSTEM_TABLE_NAMES.JOB_TABLE_NAME,"id",[n]),_;try{_=await z9(u)}catch(l){return Jr.error(`There was an error inserting a job for job type: ${e.operation} -- ${l}`),t.success=!1,t}if(_.inserted_hashes.length===0)t.message=`Had a problem creating a job with type ${n.operation} and id ${n.id}`;else{let l=`Created a job with type ${n.type} and id ${n.id}`;t.message=l,t.createdJob=n,t.success=!0,Jr.trace(l)}return t}a(e7,"addJob");async function t7(e){let t=zi(e.from_date,zi.ISO_8601),r=zi(e.to_date,zi.ISO_8601);if(!t.isValid())throw new Error("Invalid 'from' date, must be in ISO-8601 format (YYYY-MM-DD).");if(!r.isValid())throw new Error("Invalid 'to' date, must be in ISO-8601 format (YYYY-MM-DD)");let s=`select * from system.hdb_job where start_datetime > '${t.valueOf()}' and start_datetime < '${r.valueOf()}'`,n=new q9(s,e.hdb_user);try{return await J9(n)}catch(i){throw Jr.error(`there was a problem searching for jobs from date ${e.from_date} to date ${e.to_date} ${i}`),new Error("there was an error searching for jobs.  Please check the log for details.")}}a(t7,"getJobsInDateRange");async function lv(e){if(aa.isEmptyOrZeroLength(e))return aa.errorizeMessage("Invalid job ID specified.");let t=new H9(Ke.SYSTEM_SCHEMA_NAME,Ke.SYSTEM_TABLE_NAMES.JOB_TABLE_NAME,[e],["*"]);try{return await Q9(t)}catch(r){let s=`There was an error searching for a job by id: ${e} ${r}`;return Jr.error(s),aa.errorizeMessage("there was an error searching for jobs.  Please check the log for details.")}}a(lv,"getJobById");async function r7(e){if(Object.keys(e).length===0)throw new Error("invalid job object passed to updateJob");if(aa.isEmptyOrZeroLength(e.id))throw new Error("invalid ID passed to updateJob");(e.status===Ke.JOB_STATUS_ENUM.COMPLETE||e.status===Ke.JOB_STATUS_ENUM.ERROR)&&(e.end_datetime=zi().valueOf());let t=new G9(Ke.SYSTEM_SCHEMA_NAME,Ke.SYSTEM_TABLE_NAMES.JOB_TABLE_NAME,[e]),r;return r=await X9(t),r}a(r7,"updateJob")});var pv=T((rfe,mv)=>{"use strict";var dv=$(),ur=y(),s7=require("moment"),_f=$T(),df=G(),fv=QT(),Ev=$d(),hv=bi(),n7=Je(),i7=Hd(),zT=class{static{a(this,"RunnerMessage")}constructor(t,r){this.job=t,this.json=r}};async function o7(e){if(!e||Object.keys(e).length===0)throw new Error("Empty runner passed to parseMessage");if(!e.json||Object.keys(e.json).length===0)throw new Error("Empty JSON passed to parseMessage");if(!e.job||Object.keys(e.job).length===0)throw new Error("Empty job passed to parseMessage");if(dv.isEmptyOrZeroLength(e.json.operation))throw new Error("Invalid operation");if(dv.isEmptyOrZeroLength(e.job.id))throw new Error("Empty job id specified");switch(e.json.operation){case ur.JOB_TYPE_ENUM.csv_file_load:await gn(e,_f.csvFileLoad);break;case ur.JOB_TYPE_ENUM.csv_url_load:await gn(e,_f.csvURLLoad);break;case ur.JOB_TYPE_ENUM.csv_data_load:await gn(e,_f.csvDataLoad);break;case ur.JOB_TYPE_ENUM.import_from_s3:await gn(e,_f.importFromS3);break;case ur.JOB_TYPE_ENUM.empty_trash:break;case ur.JOB_TYPE_ENUM.export_local:await gn(e,Ev.export_local);break;case ur.JOB_TYPE_ENUM.export_to_s3:await gn(e,Ev.export_to_s3);break;case ur.JOB_TYPE_ENUM.delete_files_before:case ur.JOB_TYPE_ENUM.delete_records_before:await gn(e,hv.deleteFilesBefore);break;case ur.JOB_TYPE_ENUM.delete_audit_logs_before:await gn(e,hv.deleteAuditLogsBefore);break;case ur.JOB_TYPE_ENUM.delete_transaction_logs_before:await gn(e,i7.deleteTransactionLogsBefore);break;default:return`Invalid operation ${e.json.operation} specified`}}a(o7,"parseMessage");async function gn(e,t){try{e.job.status=ur.JOB_STATUS_ENUM.IN_PROGRESS,e.job.start_datetime=s7().valueOf(),await fv.updateJob(e.job),await a7(e.job.id)}catch(r){let s=r.message!==void 0?r.message:r;typeof s=="string"?(s=`There was an error running ${t.name} job with id ${e.job.id} - ${s}`,r.message=s):df.error(`There was an error running ${t.name} job with id ${e.job.id}`),df.error(s),e.job.message=s,e.job.status=ur.JOB_STATUS_ENUM.ERROR;try{await fv.updateJob(e.job)}catch(n){throw df.error(`Unable to update job with id ${e.job.id}`),n}throw r}}a(gn,"runJob");async function a7(e){df.trace("launching job thread:",e),n7.startWorker("server/jobs/jobProcess.js",{autoRestart:!1,name:"job",env:Object.assign({},process.env,{[ur.PROCESS_NAME_ENV_PROP]:`JOB-${e}`})})}a(a7,"launchJobThread");mv.exports={parseMessage:o7,RunnerMessage:zT}});var Tv=T((nfe,Sv)=>{"use strict";var JT=class{static{a(this,"OperationFunctionObject")}constructor(t,r=void 0){this.operation_function=t,this.job_operation_function=r}};Sv.exports=JT});var vv=T((ofe,rg)=>{"use strict";var mf=Fr(),ZT=Vd(),ff=$T(),Rn=v_(),Ef=gi(),Au=bi(),c7=wp(),Ru=xr(),hf=Hp(),Pt=aT(),Et=G(),u7=Gp(),l7=Z_(),_7=RS(),d7=sd(),f7=AS(),E7=OS(),h7=yS(),m7=wS(),XT=DS(),gv=$d(),p7=xd(),eg=QT(),P=y(),{hdb_errors:Nu,handleHDBError:Ou}=j(),{HTTP_STATUS_CODES:Rv}=Nu,jT=BS(),Av=gd(),Dv=require("util"),ca=Gr(),S7=qn(),T7=ko(),Ov=pv(),Nv=Hc(),bv=(yd(),Z(su)),yv=gr(),Iv=Hd(),wv=Dd(),{setServerUtilities:g7}=(uf(),Z(YT)),{CONTEXT:R7}=(ns(),Z(PE)),{_assignPackageExport:A7}=require("../../index"),{transformReq:O7}=$(),{server:N7}=(hr(),Z(hi)),b7=vT(),Cv=mf.searchByHash,y7=mf.searchByValue,I7=Dv.promisify(mf.search),w7=Dv.promisify(ZT.evaluateSQL),C7={[P.OPERATIONS_ENUM.CREATE_ATTRIBUTE]:!0,[P.OPERATIONS_ENUM.CREATE_TABLE]:!0,[P.OPERATIONS_ENUM.CREATE_SCHEMA]:!0,[P.OPERATIONS_ENUM.DROP_ATTRIBUTE]:!0,[P.OPERATIONS_ENUM.DROP_TABLE]:!0,[P.OPERATIONS_ENUM.DROP_SCHEMA]:!0},H=Tv();async function Uv(e,t){try{if(e.body.operation!=="read_log"&&(Et.log_level===P.LOG_LEVELS.INFO||Et.log_level===P.LOG_LEVELS.DEBUG||Et.log_level===P.LOG_LEVELS.TRACE)){let{hdb_user:s,hdb_auth_header:n,password:i,...o}=e.body;Et.info(o)}}catch(s){Et.error(s)}let r=await b7.callOperationFunctionAsAwait(t,e.body,null);if(typeof r!="object"&&(r={message:r}),r instanceof Error)throw r;return C7[e.body.operation]&&S7.setSchemaDataToGlobal(s=>{s&&Et.error(s)}),r}a(Uv,"processLocalTransaction");var Lv=D7();rg.exports={chooseOperation:Mv,getOperationFunction:Pv,operation:tg,processLocalTransaction:Uv};g7(rg.exports);N7.operation=tg;function Mv(e){let t;try{t=Pv(e)}catch(n){throw Et.error(`Error when selecting operation function - ${n}`),n}let{operation_function:r,job_operation_function:s}=t;try{if(e.operation==="sql"||e.search_operation&&e.search_operation.operation==="sql"){let n=e.operation==="sql"?e.sql:e.search_operation.sql,i=ZT.convertSQLToAST(n);if(e.parsed_sql_object=i,!e.bypass_auth){let o=ZT.checkASTPermissions(e,i);if(o)throw Et.error(`${Rv.FORBIDDEN} from operation ${e.operation}`),Et.warn(`User '${e.hdb_user.username}' is not permitted to ${e.operation}`),Ou(new Error,o,Nu.HTTP_STATUS_CODES.FORBIDDEN,void 0,void 0,!0)}}else if(!e.bypass_auth&&e.operation!==P.OPERATIONS_ENUM.CREATE_AUTHENTICATION_TOKENS&&e.operation!==P.OPERATIONS_ENUM.LOGIN&&e.operation!==P.OPERATIONS_ENUM.LOGOUT){let n=s===void 0?r:s,i=e.search_operation?e.search_operation:e;i.hdb_user||(i.hdb_user=e.hdb_user);let o=p7.verifyPerms(i,n);if(o)throw Et.error(`${Rv.FORBIDDEN} from operation ${e.operation}`),Et.warn(`User '${i.hdb_user.username}' is not permitted to ${i.operation}`),Ou(new Error,o,Nu.HTTP_STATUS_CODES.FORBIDDEN,void 0,!1,!0)}}catch(n){throw Ou(n,"There was an error when trying to choose an operation path")}return r}a(Mv,"chooseOperation");function Pv(e){if(Et.trace(`getOperationFunction with operation: ${e.operation}`),Lv.has(e.operation))return Lv.get(e.operation);throw Ou(new Error,Nu.HDB_ERROR_MSGS.OP_NOT_FOUND(e.operation),Nu.HTTP_STATUS_CODES.BAD_REQUEST,void 0,void 0,!0)}a(Pv,"getOperationFunction");A7("operation",tg);function tg(e,t){e.hdb_user=this[R7]?.user,e.bypass_auth=!t;let r=Mv(e);return Uv({body:e},r)}a(tg,"operation");async function L7(e){Et.trace("In serverUtils.catchup");let t=e.transaction,r=t.channel.split(":"),s=r[0],n=r[1];for(let i of t.transactions)try{i.schema=s,i.table=n,i[P.CLUSTERING_FLAG]=!0;let o;switch(i.operation){case P.OPERATIONS_ENUM.INSERT:o=await ca.insert(i);break;case P.OPERATIONS_ENUM.UPDATE:o=await ca.update(i);break;case P.OPERATIONS_ENUM.UPSERT:o=await ca.upsert(i);break;case P.OPERATIONS_ENUM.DELETE:o=await Au.deleteRecord(i);break;default:Et.warn("invalid operation in catchup");break}await transact_to_clustering_utils.postOperationHandler(i,o,e)}catch(o){Et.info("Invalid operation in transaction"),Et.error(o)}}a(L7,"catchup");async function Ys(e){O7(e);let t,r;try{r=await eg.addJob(e),t=r.createdJob,Et.info("addJob result",r);let s=new Ov.RunnerMessage(t,e);return await Ov.parseMessage(s),{message:`Starting job with id ${t.id}`,job_id:t.id}}catch(s){let n=`There was an error executing job: ${s.http_resp_msg?s.http_resp_msg:s}`;throw Et.error(n),Ou(s,n)}}a(Ys,"executeJob");function D7(){let e=new Map;return e.set(P.OPERATIONS_ENUM.INSERT,new H(ca.insert)),e.set(P.OPERATIONS_ENUM.UPDATE,new H(ca.update)),e.set(P.OPERATIONS_ENUM.UPSERT,new H(ca.upsert)),e.set(P.OPERATIONS_ENUM.SEARCH_BY_CONDITIONS,new H(mf.searchByConditions)),e.set(P.OPERATIONS_ENUM.SEARCH_BY_HASH,new H(Cv)),e.set(P.OPERATIONS_ENUM.SEARCH_BY_ID,new H(Cv)),e.set(P.OPERATIONS_ENUM.SEARCH_BY_VALUE,new H(y7)),e.set(P.OPERATIONS_ENUM.SEARCH,new H(I7)),e.set(P.OPERATIONS_ENUM.SQL,new H(w7)),e.set(P.OPERATIONS_ENUM.CSV_DATA_LOAD,new H(Ys,ff.csvDataLoad)),e.set(P.OPERATIONS_ENUM.CSV_FILE_LOAD,new H(Ys,ff.csvFileLoad)),e.set(P.OPERATIONS_ENUM.CSV_URL_LOAD,new H(Ys,ff.csvURLLoad)),e.set(P.OPERATIONS_ENUM.IMPORT_FROM_S3,new H(Ys,ff.importFromS3)),e.set(P.OPERATIONS_ENUM.CREATE_SCHEMA,new H(Rn.createSchema)),e.set(P.OPERATIONS_ENUM.CREATE_DATABASE,new H(Rn.createSchema)),e.set(P.OPERATIONS_ENUM.CREATE_TABLE,new H(Rn.createTable)),e.set(P.OPERATIONS_ENUM.CREATE_ATTRIBUTE,new H(Rn.createAttribute)),e.set(P.OPERATIONS_ENUM.DROP_SCHEMA,new H(Rn.dropSchema)),e.set(P.OPERATIONS_ENUM.DROP_DATABASE,new H(Rn.dropSchema)),e.set(P.OPERATIONS_ENUM.DROP_TABLE,new H(Rn.dropTable)),e.set(P.OPERATIONS_ENUM.DROP_ATTRIBUTE,new H(Rn.dropAttribute)),e.set(P.OPERATIONS_ENUM.DESCRIBE_SCHEMA,new H(Ef.describeSchema)),e.set(P.OPERATIONS_ENUM.DESCRIBE_DATABASE,new H(Ef.describeSchema)),e.set(P.OPERATIONS_ENUM.DESCRIBE_TABLE,new H(Ef.describeTable)),e.set(P.OPERATIONS_ENUM.DESCRIBE_ALL,new H(Ef.describeAll)),e.set(P.OPERATIONS_ENUM.DELETE,new H(Au.deleteRecord)),e.set(P.OPERATIONS_ENUM.ADD_USER,new H(Ru.addUser)),e.set(P.OPERATIONS_ENUM.ALTER_USER,new H(Ru.alterUser)),e.set(P.OPERATIONS_ENUM.DROP_USER,new H(Ru.dropUser)),e.set(P.OPERATIONS_ENUM.LIST_USERS,new H(Ru.listUsersExternal)),e.set(P.OPERATIONS_ENUM.LIST_ROLES,new H(hf.listRoles)),e.set(P.OPERATIONS_ENUM.ADD_ROLE,new H(hf.addRole)),e.set(P.OPERATIONS_ENUM.ALTER_ROLE,new H(hf.alterRole)),e.set(P.OPERATIONS_ENUM.DROP_ROLE,new H(hf.dropRole)),e.set(P.OPERATIONS_ENUM.USER_INFO,new H(Ru.userInfo)),e.set(P.OPERATIONS_ENUM.READ_LOG,new H(u7)),e.set(P.OPERATIONS_ENUM.ADD_NODE,new H(l7)),e.set(P.OPERATIONS_ENUM.UPDATE_NODE,new H(_7)),e.set(P.OPERATIONS_ENUM.REMOVE_NODE,new H(d7)),e.set(P.OPERATIONS_ENUM.CONFIGURE_CLUSTER,new H(f7)),e.set(P.OPERATIONS_ENUM.PURGE_STREAM,new H(E7)),e.set(P.OPERATIONS_ENUM.SET_CONFIGURATION,new H(yv.setConfiguration)),e.set(P.OPERATIONS_ENUM.CLUSTER_STATUS,new H(h7.clusterStatus)),e.set(P.OPERATIONS_ENUM.CLUSTER_NETWORK,new H(m7)),e.set(P.OPERATIONS_ENUM.CLUSTER_SET_ROUTES,new H(XT.setRoutes)),e.set(P.OPERATIONS_ENUM.CLUSTER_GET_ROUTES,new H(XT.getRoutes)),e.set(P.OPERATIONS_ENUM.CLUSTER_DELETE_ROUTES,new H(XT.deleteRoutes)),e.set(P.OPERATIONS_ENUM.EXPORT_TO_S3,new H(Ys,gv.export_to_s3)),e.set(P.OPERATIONS_ENUM.DELETE_FILES_BEFORE,new H(Ys,Au.deleteFilesBefore)),e.set(P.OPERATIONS_ENUM.DELETE_RECORDS_BEFORE,new H(Ys,Au.deleteFilesBefore)),e.set(P.OPERATIONS_ENUM.EXPORT_LOCAL,new H(Ys,gv.export_local)),e.set(P.OPERATIONS_ENUM.SEARCH_JOBS_BY_START_DATE,new H(eg.handleGetJobsByStartDate)),e.set(P.OPERATIONS_ENUM.GET_JOB,new H(eg.handleGetJob)),e.set(P.OPERATIONS_ENUM.GET_FINGERPRINT,new H(jT.getFingerprint)),e.set(P.OPERATIONS_ENUM.SET_LICENSE,new H(jT.setLicense)),e.set(P.OPERATIONS_ENUM.GET_REGISTRATION_INFO,new H(jT.getRegistrationInfo)),e.set(P.OPERATIONS_ENUM.RESTART,new H(Av.restart)),e.set(P.OPERATIONS_ENUM.RESTART_SERVICE,new H(Av.restartService)),e.set(P.OPERATIONS_ENUM.CATCHUP,new H(L7)),e.set(P.OPERATIONS_ENUM.SYSTEM_INFORMATION,new H(T7.systemInformation)),e.set(P.OPERATIONS_ENUM.DELETE_AUDIT_LOGS_BEFORE,new H(Ys,Au.deleteAuditLogsBefore)),e.set(P.OPERATIONS_ENUM.READ_AUDIT_LOG,new H(c7)),e.set(P.OPERATIONS_ENUM.CREATE_AUTHENTICATION_TOKENS,new H(Nv.createTokens)),e.set(P.OPERATIONS_ENUM.REFRESH_OPERATION_TOKEN,new H(Nv.refreshOperationToken)),e.set(P.OPERATIONS_ENUM.LOGIN,new H(bv.login)),e.set(P.OPERATIONS_ENUM.LOGOUT,new H(bv.logout)),e.set(P.OPERATIONS_ENUM.GET_CONFIGURATION,new H(yv.getConfiguration)),e.set(P.OPERATIONS_ENUM.CUSTOM_FUNCTIONS_STATUS,new H(Pt.customFunctionsStatus)),e.set(P.OPERATIONS_ENUM.GET_CUSTOM_FUNCTIONS,new H(Pt.getCustomFunctions)),e.set(P.OPERATIONS_ENUM.GET_COMPONENT_FILE,new H(Pt.getComponentFile)),e.set(P.OPERATIONS_ENUM.GET_COMPONENTS,new H(Pt.getComponents)),e.set(P.OPERATIONS_ENUM.SET_COMPONENT_FILE,new H(Pt.setComponentFile)),e.set(P.OPERATIONS_ENUM.DROP_COMPONENT,new H(Pt.dropComponent)),e.set(P.OPERATIONS_ENUM.GET_CUSTOM_FUNCTION,new H(Pt.getCustomFunction)),e.set(P.OPERATIONS_ENUM.SET_CUSTOM_FUNCTION,new H(Pt.setCustomFunction)),e.set(P.OPERATIONS_ENUM.DROP_CUSTOM_FUNCTION,new H(Pt.dropCustomFunction)),e.set(P.OPERATIONS_ENUM.ADD_CUSTOM_FUNCTION_PROJECT,new H(Pt.addComponent)),e.set(P.OPERATIONS_ENUM.ADD_COMPONENT,new H(Pt.addComponent)),e.set(P.OPERATIONS_ENUM.DROP_CUSTOM_FUNCTION_PROJECT,new H(Pt.dropCustomFunctionProject)),e.set(P.OPERATIONS_ENUM.PACKAGE_CUSTOM_FUNCTION_PROJECT,new H(Pt.packageComponent)),e.set(P.OPERATIONS_ENUM.PACKAGE_COMPONENT,new H(Pt.packageComponent)),e.set(P.OPERATIONS_ENUM.DEPLOY_CUSTOM_FUNCTION_PROJECT,new H(Pt.deployComponent)),e.set(P.OPERATIONS_ENUM.DEPLOY_COMPONENT,new H(Pt.deployComponent)),e.set(P.OPERATIONS_ENUM.READ_TRANSACTION_LOG,new H(Iv.readTransactionLog)),e.set(P.OPERATIONS_ENUM.DELETE_TRANSACTION_LOGS_BEFORE,new H(Ys,Iv.deleteTransactionLogsBefore)),e.set(P.OPERATIONS_ENUM.INSTALL_NODE_MODULES,new H(wv.installModules)),e.set(P.OPERATIONS_ENUM.AUDIT_NODE_MODULES,new H(wv.auditModules)),e.set(P.OPERATIONS_ENUM.GET_BACKUP,new H(Rn.getBackup)),e}a(D7,"initializeOperationFunctionMap")});var Sf=T((cfe,qv)=>{"use strict";var sg=y(),U7=$(),bu=G(),{handleHDBError:ng,hdb_errors:pf}=j(),{isMainThread:M7}=require("worker_threads"),{Readable:P7}=require("stream"),Bv=require("os"),v7=require("util"),B7=Xp(),H7=v7.promisify(B7.authorize),Hv=vv(),{createGzip:q7,constants:F7}=require("zlib");function G7(e){let t=`Found an uncaught exception with message: ${e.message}. ${Bv.EOL}Stack: ${e.stack} ${Bv.EOL}Terminating ${M7?"HDB":"thread"}.`;console.error(t),bu.fatal(t),process.exit(1)}a(G7,"handleServerUncaughtException");function x7(e,t,r){if(bu[e.logLevel||"error"](e),e.statusCode)return typeof e.http_resp_msg!="object"?r.code(e.statusCode).send({error:e.http_resp_msg||e.message}):r.code(e.statusCode).send(e.http_resp_msg);let s=e.statusCode?e.statusCode:pf.HTTP_STATUS_CODES.INTERNAL_SERVER_ERROR;return typeof e=="string"?r.code(s).send({error:e}):r.code(s).send(e.message?{error:e.message}:e)}a(x7,"serverErrorHandler");function k7(e,t,r){if(!e.body||Object.keys(e.body).length===0||typeof e.body!="object"){let s=ng(new Error,"Invalid JSON.",pf.HTTP_STATUS_CODES.BAD_REQUEST);r(s,null)}if(U7.isEmpty(e.body.operation)){let s=ng(new Error,"Request body must include an 'operation' property.",pf.HTTP_STATUS_CODES.BAD_REQUEST);r(s,null)}r()}a(k7,"reqBodyValidationHandler");function V7(e,t,r){let s;e.body.operation!==sg.OPERATIONS_ENUM.CREATE_AUTHENTICATION_TOKENS&&e.body.operation!==sg.OPERATIONS_ENUM.LOGIN&&e.body.operation!==sg.OPERATIONS_ENUM.LOGOUT?H7(e,t).then(n=>{s=n,e.body.hdb_user=s,e.body.hdb_auth_header=e.headers.authorization,r()}).catch(n=>{bu.warn(n),bu.warn(`{"ip":"${e.socket.remoteAddress}", "error":"${n.stack}"`);let i=typeof n=="string"?{error:n}:{error:n.message};r(ng(n,i,pf.HTTP_STATUS_CODES.UNAUTHORIZED),null)}):(e.body.hdb_user=null,e.body.hdb_auth_header=e.headers.authorization,e.body.baseRequest=e.raw?.baseRequest,e.body.baseResponse=t.raw?.baseResponse,e.body.fastifyResponse=t,r())}a(V7,"authHandler");async function $7(e,t,r=!1){let s;try{r&&(e.body.operation!=="configure_cluster"||e.body.operation!=="set_configuration")&&(e.body.bypass_auth=r),s=Hv.chooseOperation(e.body);let n=await Hv.processLocalTransaction(e,s);if(n instanceof P7&&n.headers){for(let[i,o]of n.headers)t.header(i,o);e.headers["accept-encoding"]?.includes("gzip")&&(t.header("content-encoding","gzip"),n=n.pipe(q7({level:F7.Z_BEST_SPEED})))}return n}catch(n){throw bu.error(n),n}}a($7,"handlePostRequest");qv.exports={authHandler:V7,handlePostRequest:$7,handleServerUncaughtException:G7,serverErrorHandler:x7,reqBodyValidationHandler:k7}});var kv=T((lfe,xv)=>{"use strict";var Y7=require("fastify-plugin"),{handlePostRequest:Fv,authHandler:K7,reqBodyValidationHandler:W7}=Sf();async function Q7(e){e.decorate("hdbCore",{preValidation:[W7,K7],request:t=>Gv(Fv(t,response)),requestWithoutAuthentication:(t,r)=>Gv(Fv(t,r,!0))})}a(Q7,"hdbCore");async function Gv(e){if(e=await e,e?.[Symbol.asyncIterator]&&!e[Symbol.iterator]){let t=[];for await(let r of e)t.push(r);return t}return e}a(Gv,"convertAsyncIterators");xv.exports=Y7(Q7)});var $v=T((dfe,Vv)=>{"use strict";var ig=require("fs"),ua=X();ua.initSync();var{CONFIG_PARAMS:yu}=y(),z7=1024*1024*1024;function J7(e){let t=ua.get(yu.HTTP_TIMEOUT),r=ua.get(yu.HTTP_KEEPALIVETIMEOUT),s={bodyLimit:z7,connectionTimeout:t,keepAliveTimeout:r,return503OnClosing:!1,forceCloseConnections:!0,ignoreTrailingSlash:!0};if(e){let n=ua.get(yu.TLS_PRIVATEKEY),i=ua.get(yu.TLS_CERTIFICATE),o=ua.get(yu.TLS_CERTIFICATEAUTHORITY);s.https={allowHTTP1:!0,key:ig.readFileSync(`${n}`),cert:ig.readFileSync(i)+(o?`

`+ig.readFileSync(o):"")},s.http2=!0}return s}a(J7,"getServerOptions");Vv.exports=J7});var Wv=T((Efe,Kv)=>{"use strict";var og=X();og.initSync();var{CONFIG_PARAMS:Yv}=y();function X7(){let e=og.get(Yv.HTTP_CORSACCESSLIST),t=og.get(Yv.HTTP_CORS),r;return t&&(r={origin:!0,allowedHeaders:["Content-Type","Authorization","Accept"],credentials:!1},e&&e.length>0&&e[0]!==null&&e[0]!=="*"&&(r.origin=(s,n)=>n(null,e.indexOf(s)!==-1))),r}a(X7,"getCORSOptions");Kv.exports=X7});var Jv=T((mfe,zv)=>{"use strict";var Qv=X();Qv.initSync();var j7=y();function Z7(){return Qv.get(j7.CONFIG_PARAMS.HTTP_HEADERSTIMEOUT)??6e4}a(Z7,"getHeaderTimeoutConfig");zv.exports=Z7});var ug={};qe(ug,{customFunctionsServer:()=>ree,handleFile:()=>tee,ready:()=>iee});async function tee(e,t,r,s){if(!An){let c=ag.get(cg.CONFIG_PARAMS.CUSTOMFUNCTIONS_NETWORK_HTTPS);An=u0(c),ut.http((await An).server)}let n=await An,i=(0,jv.dirname)(r),o=t.replace(/\/routes\/.*/g,"");if(o.startsWith("/")&&(o=o.slice(1)),!Xv.has(i)){Xv.add(i);try{n.register(nee(i,o))}catch(c){if(c.message==="Root plugin has already booted")Le.warn(`Could not load root fastify route for ${r}, this may require a restart to install properly`);else throw c}}}async function ree(){try{Le.info("In Custom Functions Fastify server"+process.cwd()),Le.info(`Custom Functions Running with NODE_ENV set as: ${process.env.NODE_ENV}`),Le.debug(`Custom Functions server process ${process.pid} starting up.`),await see();let e=ag.get(cg.CONFIG_PARAMS.CUSTOMFUNCTIONS_NETWORK_HTTPS),t=e&&(e===!0||e.toUpperCase()===TRUE_COMPARE_VAL),r;try{r=An=await u0(t)}catch(s){throw Le.error(`Custom Functions buildServer error: ${s}`),s}try{await r.ready()}catch(s){throw Le.error(`Custom Functions server.ready() error: ${s}`),s}r.server.cantCleanupProperly=!0}catch(e){Le.error(`Custom Functions ${process.pid} Error: ${e}`),Le.error(e),process.exit(1)}}async function see(){try{Le.info("Custom Functions starting configuration."),await n0.setUsersToGlobal(),Le.info("Custom Functions completed configuration.")}catch(e){Le.error(e)}}function nee(e,t){return async function(r){try{Le.info("Custom Functions starting buildRoutes"),Le.trace("Loading fastify routes folder "+e),(0,Zv.existsSync)(e)&&r.register(s0.default,n=>({dir:e,dirNameRoutePrefix:!1,options:{hdbCore:n.hdbCore,logger:Le.loggerWithTag("custom-function"),prefix:`/${t}`}})).after((n,i,o)=>{n?.message?Le.error(n.message):n&&Le.error(n),o()})}catch(s){Le.error(`Custom Functions errored buildRoutes: ${s}`)}}}async function u0(e){Le.info("Custom Functions starting buildServer.");let t=(0,i0.default)(e),r=(0,e0.default)(t);r.server.headersTimeout=(0,a0.default)(),r.setErrorHandler(c0.serverErrorHandler);let s=(0,o0.default)();return s&&r.register(t0.default,s),r.register(function(n,i,o){n.setNotFoundHandler(function(c,u){r.server.emit("unhandled",c.raw,u.raw)}),o()}),r.register(r0.default),await r.register(eee),await r.after(),IT(r),Le.info("Custom Functions completed buildServer."),r}function iee(){if(An)return An.then?An.then(e=>e.ready()):An.ready()}var jv,Zv,e0,t0,r0,s0,ag,cg,Le,eee,n0,i0,o0,a0,c0,An,Xv,l0=Te(()=>{jv=require("path"),Zv=require("fs"),e0=M(require("fastify")),t0=M(require("@fastify/cors")),r0=M(LT()),s0=M(require("@fastify/autoload")),ag=M(X()),cg=M(y()),Le=M(G()),eee=M(kv()),n0=M(xr()),i0=M($v()),o0=M(Wv()),a0=M(Jv()),c0=M(Sf());Jo();hr();Xv=new Set;a(tee,"handleFile");a(ree,"customFunctionsServer");a(see,"setUp");a(nee,"buildRouteFolder");a(u0,"buildServer");a(iee,"ready")});var lg={};qe(lg,{start:()=>oee});function oee(e){return{handleFile(t,r,s){d0||(d0=!0,e.server.http(async(n,i)=>{if(!n.isWebSocket){let o=_0.get(n.pathname);if(o)return{handlesHeaders:!0,body:(0,f0.default)(n,(0,E0.realpathSync)(o))}}return i(n)},{runFirst:!0})),_0.set(r,s)}}}var f0,E0,_0,d0,h0=Te(()=>{f0=M(require("send")),E0=require("fs"),_0=new Map;a(oee,"start")});function uee(e,t=1,r){if(_g++,(0,Ji.startWorker)("server/threads/threadServer.js",{name:Rf.THREAD_TYPES.HTTP,workerIndex:e,threadCount:t,async onStarted(s){let n=new Promise((o,c)=>{function u(_){_.type===Rf.CLUSTER_MESSAGE_TYPE_ENUM.CHILD_STARTED&&(s.removeListener("message",u),o(s))}a(u,"onMessage"),s.on("message",u),s.on("error",c)});cee.push(n),await n,la.push(s),s.expectedIdle=1,s.lastIdle=0,s.requests=1,s.on("message",o=>{if(o.requestId){let c=gf.get(o.requestId);c&&c(o)}}),s.on("exit",i),s.on("shutdown",i);function i(){let o=la.indexOf(s);o>-1&&la.splice(o,1)}if(a(i,"removeWorker"),_a){let o=_a;_a=[];for(let c of o)T0[c.localPort](null,c)}}}),r){let s=setInterval(()=>{dg?dg=!1:(clearInterval(s),console.log("shut down dynamic thread due to inactivity"),(0,Ji.shutdownWorkers)(),_g=0,setTimeout(()=>{global.gc?.()},5e3))},1e4)}}function g0(e=0,t){if(typeof e=="string")try{(0,Af.existsSync)(e)&&(0,Af.unlinkSync)(e)}catch{}let r;t?t==="ip"?r=lee:r=_ee(t):r=fg;let s=(0,da.createServer)({allowHalfOpen:!0,pauseOnConnect:!r.readsData}).listen(e);if(s._handle){s._handle.onconnection=T0[e]=function(i,o){r.readsData||(o.reading=!1,o.readStop()),dg=!0,r(o,(c,u)=>{if(!c){if(m0){let l=o._socket||new da.Socket({handle:o,writable:!0,readable:!0});m0.deliverSocket(l,e,u),l.resume()}else _g>0?(_a.length===0&&setTimeout(()=>{_a.length>0&&console.warn("Incoming sockets/requests have been queued for workers to start, and no workers have handled them. Check to make sure an error is not preventing workers from starting")},1e4).unref(),o.localPort=e,_a.push(o)):(console.log("start up a dynamic thread to handle request"),uee(0));br(!1,"socket-routed");return}c.requests++;let _=o.fd;if(_>=0)c.postMessage({port:e,fd:_,data:u});else{let l=o._socket||new da.Socket({handle:o,writable:!0,readable:!0});hee(l,c,e)}br(!0,"socket-routed")})};let n=Oc();S0.info(`HarperDB ${n.version} Server running on port ${e}`)}return s.on("error",n=>{console.error("Error in socket server",n)}),process.env._UNREF_SERVER&&s.unref(),s}function fg(e,t){let r,s=0;for(let n of la){if(n.threadId===-1)continue;let i=n.expectedIdle/n.requests;if(i>s)r=n;else if(s>=Tf)return Tf=i,t(r);s=i}Tf=0,t(r)}function lee(e,t){let r={};e.getpeername(r);let s=r.address,n=fa.get(s),i=Date.now();if(n&&n.worker.threadId!==-1)return n.lastUsed=i,t(n.worker);fg(e,o=>{fa.set(s,{worker:o,lastUsed:i}),t(o)})}function _ee(e){let t=new RegExp(`${e}:\\s*(.+)`,"i");return r.readsData=!0,r;function r(s,n){let i=new da.Socket({handle:s,readable:!0,writable:!0});s._socket=i,i.on("data",o=>{s.readStop();let u=o.toString("latin1").match(t)?.[1],_=fa.get(u),l=Date.now();if(_&&_.worker.threadId!==-1)return _.lastUsed=l,n(_.worker);fg(s,d=>{fa.set(u,{worker:d,lastUsed:l}),n(d,o)})})}a(r,"findByHeaderAffinity")}function fee(){Tf=0;for(let e of la)e.expectedIdle=e.recentELU.idle+dee,e.requests=1;la.sort((e,t)=>e.expectedIdle>t.expectedIdle?-1:1)}function hee(e,t,r){let s=Eee++;t.postMessage({port:r,requestId:s,event:"connection"}),e.on("data",n=>{let i=n.toString("latin1");t.postMessage({port:r,requestId:s,data:i,event:"data"})}).on("close",n=>{t.postMessage({port:r,requestId:s,event:"close",hadError:n})}).on("error",n=>{t.postMessage({port:r,requestId:s,event:"error",error:n})}).on("drain",n=>{t.postMessage({port:r,requestId:s,event:"drain",error:n})}).on("end",()=>{t.postMessage({port:r,requestId:s,event:"end"})}).resume(),gf.set(s,n=>{n.event=="data"&&e.write(Buffer.from(n.data,"latin1")),n.event=="end"&&(e.end(n.data&&Buffer.from(n.data,"latin1")),gf.delete(s)),n.event=="destroy"&&(e.destroy(),gf.delete(s))})}var Ji,da,Rf,S0,Af,aee,la,_a,T0,m0,_g,cee,dg,Tf,p0,fa,dee,gf,Eee,R0=Te(()=>{Ji=M(Je()),da=require("net"),Rf=M(y()),S0=M(G()),Af=require("fs");ln();({isMainThread:aee}=require("worker_threads")),la=[],_a=[],T0=[],_g=0,cee=[];aee&&process.on("uncaughtException",e=>{e.code!=="ECONNRESET"&&e.message!=="write EIO"&&console.error("uncaughtException",e)});a(uee,"startHTTPWorker");a(g0,"startSocketServer");Tf=0;a(fg,"findMostIdleWorker");p0=36e5,fa=new Map;a(lee,"findByRemoteAddressAffinity");a(_ee,"makeFindByHeaderAffinity");setInterval(()=>{let e=Date.now();for(let[t,r]of fa)r.lastUsed+p0<e&&fa.delete(t)},p0).unref();dee=1e3;a(fee,"updateWorkerIdleness");(0,Ji.setMonitorListener)(fee);gf=new Map,Eee=1;a(hee,"proxySocket")});var b0=T((wfe,N0)=>{"use strict";var mee=require("cluster"),gs=X();gs.initSync();var O0=y(),bfe=require("util"),On=G(),Eg=require("fs"),pee=require("fastify"),yfe=Oc(),See=require("@fastify/cors"),Tee=require("@fastify/compress"),gee=require("@fastify/static"),Ree=LT(),Aee=require("path"),{PACKAGE_ROOT:Oee}=y(),Nee=qn(),bee=$(),yee=xr(),Iee=ic(),{server:wee}=(hr(),Z(hi)),{authHandler:Cee,handlePostRequest:Lee,serverErrorHandler:Dee,reqBodyValidationHandler:Uee}=Sf(),Ife=require("net"),{registerContentHandlers:Mee}=(Jo(),Z(OP)),Pee=6e4,vee=1024*1024*1024,Bee="TRUE",{CONFIG_PARAMS:Nn}=O0,Xi;N0.exports={hdbServer:A0,start:A0};async function A0(e){try{On.info("In Fastify server"+process.cwd()),On.info(`Running with NODE_ENV set as: ${process.env.NODE_ENV}`),On.debug(`HarperDB server process ${process.pid} starting up.`),global.clustering_on=!1,global.isMaster=mee.isMaster,await Hee();let t=gs.get(Nn.OPERATIONSAPI_NETWORK_SECUREPORT)!=null;Xi=qee(t),await Xi.ready(),e||(e={}),e.isOperationsServer=!0,Xi.server.cantCleanupProperly=!0;try{wee.http(Xi.server,e),Xi.server.closeIdleConnections||await Xi.listen({port:0,host:"::"})}catch(r){throw Xi.close(),On.error(r),On.error("Error configuring operations server"),r}}catch(t){console.error(`Failed to build server on ${process.pid}`,t),On.fatal(t),process.exit(1)}}a(A0,"operationsServer");async function Hee(){On.trace("Configuring HarperDB process."),Nee.setSchemaDataToGlobal(),await yee.setUsersToGlobal(),await Iee.getLicense()}a(Hee,"setUp");function qee(e){On.debug(`HarperDB process starting to build ${e?"HTTPS":"HTTP"} server.`);let t=Fee(e),r=pee(t);r.server.headersTimeout=xee(),r.setErrorHandler(Dee);let s=Gee();s&&r.register(See,s),r.register(function(i,o,c){i.setNotFoundHandler(function(u,_){r.server.emit("unhandled",u.raw,_.raw)}),c()}),r.register(Ree),r.register(Tee),r.register(gee,{root:Aee.join(Oee,"studio")}),Mee(r);let n=gs.get(O0.HDB_SETTINGS_NAMES.LOCAL_STUDIO_ON);return r.get("/",function(i,o){return!bee.isEmpty(n)&&n.toString().toLowerCase()==="true"?o.sendFile("index.html"):o.sendFile("running.html")}),r.post("/",{preValidation:[Uee,Cee],config:{isOperation:!0}},async function(i,o){return i.body?.operation?.startsWith("restart")&&o.header("Connection","close"),Lee(i,o)}),r.get("/health",()=>"HarperDB is running."),On.debug(`HarperDB process starting up ${e?"HTTPS":"HTTP"} server listener.`),r}a(qee,"buildServer");function Fee(e){let t=gs.get(Nn.OPERATIONSAPI_NETWORK_TIMEOUT),r=gs.get(Nn.OPERATIONSAPI_NETWORK_KEEPALIVETIMEOUT),s={bodyLimit:vee,connectionTimeout:t,keepAliveTimeout:r,forceCloseConnections:!0,return503OnClosing:!1};if(e){let n=gs.get(Nn.OPERATIONSAPI_TLS_PRIVATEKEY),i=gs.get(Nn.OPERATIONSAPI_TLS_CERTIFICATE),o=gs.get(Nn.OPERATIONSAPI_TLS_CERTIFICATEAUTHORITY),c={allowHTTP1:!0,key:Eg.readFileSync(n),cert:Eg.readFileSync(i)+(o?`

`+Eg.readFileSync(o):"")};s.http2=!0,s.https=c}return s}a(Fee,"getServerOptions");function Gee(){let e=gs.get(Nn.OPERATIONSAPI_NETWORK_CORS),t=gs.get(Nn.OPERATIONSAPI_NETWORK_CORSACCESSLIST),r;return e&&(e===!0||e.toUpperCase()===Bee)&&(r={origin:!0,allowedHeaders:["Content-Type","Authorization","Accept"],credentials:!1},t&&t.length>0&&t[0]!==null&&t[0]!=="*"&&(r.origin=(s,n)=>n(null,t.indexOf(s)!==-1))),r}a(Gee,"getCORSOpts");function xee(){return gs.get(Nn.OPERATIONSAPI_NETWORK_HEADERSTIMEOUT)??Pee}a(xee,"getHeaderTimeoutConfig")});var B0=T((Ufe,v0)=>{"use strict";var{decode:kee}=require("msgpackr"),{isMainThread:Vee,parentPort:$ee,threadId:Lfe}=require("worker_threads"),mg=_t(),bn=Ve(),Yee=y(),Iu=G(),y0=X(),w0=y();Je();var Kee=sn(),{recordAction:Wee,recordActionBinary:Qee}=(ln(),Z(Ic)),{publishToStream:zee}=mg,Dfe={durable:bn.WORK_QUEUE_CONSUMER_NAMES.durable_name,queue:bn.WORK_QUEUE_CONSUMER_NAMES.deliver_group},Jee,Xee,jee,C0,L0;v0.exports={initialize:D0,workQueueListener:P0,setSubscription:Zee,setIgnoreOrigin:tte,getDatabaseSubscriptions:ete};async function D0(){L0=!0,Iu.notify("Starting clustering ingest service.");let{connection:e,jsm:t,js:r}=await mg.getNATSReferences();Jee=e,Xee=e.info.server_name,jee=t,C0=r}a(D0,"initialize");var Nf=new Map;function Zee(e,t,r){let s=Nf.get(e);s||Nf.set(e,s=new Map),s.set(t,r),L0||D0().then(P0)}a(Zee,"setSubscription");function ete(){return Nf}a(ete,"getDatabaseSubscriptions");var U0;function tte(e){U0=e}a(tte,"setIgnoreOrigin");var M0=100,I0=new Array(M0),Of=0;async function P0(){let t=await(await C0.consumers.get(bn.WORK_QUEUE_CONSUMER_NAMES.stream_name,bn.WORK_QUEUE_CONSUMER_NAMES.durable_name)).consume();for await(let r of t)await I0[Of],I0[Of]=rte(r).catch(s=>{Iu.error(s)}),++Of>=M0&&(Of=0)}a(P0,"workQueueListener");Vee||$ee.on("message",async e=>{let{type:t}=e;t===w0.ITC_EVENT_TYPES.SHUTDOWN&&mg.closeConnection()});async function rte(e){let t=kee(e.data);Wee(e.data.length,"bytes-received",e.subject,t.operation,"ingest");let r=e.headers,s=!1,n=y0.get(Yee.CONFIG_PARAMS.CLUSTERING_NODENAME);r.has(bn.MSG_HEADERS.TRANSACTED_NODES)&&r.values(bn.MSG_HEADERS.TRANSACTED_NODES).indexOf(n)>-1&&(s=!0);let i=r.get(bn.MSG_HEADERS.ORIGIN);if(s||(s=i===n&&!U0),Qee(s,"echo",e.subject,t.operation,"ingest"),s){e.ack();return}r.append(bn.MSG_HEADERS.TRANSACTED_NODES,n);try{let{operation:o,schema:c,next:u,table:_,records:l,hash_values:d,__origin:f,expiresAt:E}=t;Iu.trace("processing message:",o,c,_,(l?"records: "+l.map(O=>O?.id):"")+(d?"ids: "+d:""),"with sequence:",e.seq),Iu.trace(`messageProcessor nats msg id: ${e.headers.get(bn.MSG_HEADERS.NATS_MSG_ID)}`);let h;l||(l=d);let{timestamp:p,user:S,node_name:g}=f||{},b=Nf.get(c)?.get(_);if(!b)throw new Error("Missing table for replication message",_);if(o==="define_schema")t.type=o,b.send(t);else if(l.length===1&&!u)b.send({type:hg(o),value:l[0],id:d?.[0],expiresAt:E,timestamp:p,table:_,onCommit:h,user:S,nodeName:g});else{let O=l.map((Y,Q)=>({type:hg(o),value:Y,expiresAt:E,id:d?.[Q],table:_}));for(;u;)O.push({type:hg(u.operation),value:u.record,expiresAt:u.expiresAt,id:u.id,table:u.table}),u=u.next;b.send({type:"transaction",writes:O,table:_,timestamp:p,onCommit:h,user:S,nodeName:g})}y0.get(w0.CONFIG_PARAMS.CLUSTERING_REPUBLISHMESSAGES)!==!1&&zee(e.subject.split(".").slice(0,-1).join("."),Kee.createNatsTableStreamName(c,_),e.headers,e.data)}catch(o){Iu.error(o)}e.ack()}a(rte,"messageProcessor");function hg(e){switch(e){case"insert":case"upsert":case"update":return"put"}return e}a(hg,"convertOperation")});var Ag={};qe(Ag,{disableNATS:()=>nte,publishToStream:()=>wf,setNATSReplicator:()=>pg,setPublishToStream:()=>ite,setSubscription:()=>Rg,start:()=>ste});function ste(){yf.default.get(If.default.CONFIG_PARAMS.CLUSTERING_ENABLED)&&ate()}function nte(e=!0){k0=e}function ite(e,t){wf=e,Rg=t}function ate(){if(k0||process.env._DISABLE_NATS)return;let e=ds(),t=Object.keys(e);t.push("system");for(let r of t){let s=e[r];for(let n in s){let i=s[n];pg(n,r,i)}}Og((r,s)=>{pg(r.tableName,r.databaseName,r),s&&$0(r)}),!H0&&(H0=!0)}function pg(e,t,r){if(!r)return console.error(`Attempt to replicate non-existent table ${e} from database ${t}`);if(r.sources.some(n=>n?.isNATSReplicator))return;r.sourcedFrom(class extends Ot{static{a(this,"NATSReplicator")}put(i){return s(this.getContext()).addWrite(t,{operation:"put",table:e,id:this[Ie],record:i})}delete(){return s(this.getContext()).addWrite(t,{operation:"delete",table:e,id:this[Ie]})}publish(i){return s(this.getContext()).addWrite(t,{operation:"publish",table:e,id:this[Ie],record:i})}invalidate(){s(this.getContext()).addWrite(t,{operation:"invalidate",table:e,id:this[Ie]})}static defineSchema(i){$0(i)}static subscribe(){let i=new rs;return Rg(t,e,i),i}static subscribeOnThisThread(i){return i<ote}static isEqual(i){return i.isNATSReplicator}static isNATSReplicator=!0;static shouldReceiveInvalidations=!0},{intermediateSource:!0});function s(n){let i=n?.transaction?.nats;if(!i)if(n?.transaction){n.transaction.nats=i=new bf(n.transaction,n);let o=n.transaction;for(;o.next;)o=o.next;o.next=n.transaction.nats,i.user=n.user,i.context=n}else i=V0;return i}a(s,"getNATSTransaction")}function $0(e){let t=yf.default.get(If.default.CONFIG_PARAMS.CLUSTERING_NODENAME);wf(`${Tg.SUBJECT_PREFIXES.TXN}.${e.databaseName}.${e.tableName}`,(0,gg.createNatsTableStreamName)(e.databaseName,e.tableName),void 0,{operation:"define_schema",schema:e.databaseName,table:e.tableName,attributes:e.attributes,__origin:{timestamp:Date.now(),node_name:t}})}var q0,Tg,gg,F0,G0,yf,If,x0,k0,wf,Rg,ote,V0,H0,bf,Sg,Y0=Te(()=>{Ee();ns();q0=M(_t()),Tg=M(Ve()),gg=M(sn());Ha();F0=M(B0()),G0=M(Er()),yf=M(X()),If=M(y()),x0=M(G());a(ste,"start");a(nte,"disableNATS");wf=q0.publishToStream,Rg=F0.setSubscription;a(ite,"setPublishToStream");ote=2;a(ate,"assignReplicationSource");a(pg,"setNATSReplicator");a($0,"publishSchema");bf=class{constructor(t,r){this.transaction=t;this.options=r}static{a(this,"NATSTransaction")}user;writes_by_db=new Map;addWrite(t,r){r.expiresAt=this.context?.expiresAt;let s=this.writes_by_db.get(t);s||this.writes_by_db.set(t,s=[]),s.push(r)}commit({timestamp:t}){let r=yf.default.get(If.default.CONFIG_PARAMS.CLUSTERING_NODENAME),s=[];for(let[n,i]of this.writes_by_db){let o=[],c=[],u,_;for(let l of i){let d=l.table,f=l.operation=="put"?"upsert":l.operation;u||(x0.trace(`Sending transaction event ${f}`),_=u={operation:f,schema:n,table:d,__origin:{user:this.user?.username,timestamp:t,node_name:r}},u.hash_values=c,f!=="delete"&&f!=="invalidate"&&(u.records=o)),u.table===d&&u.operation===f?(o.push(l.record),c.push(l.id)):_=_.next={operation:f,table:d,id:l.id,record:l.record},l.expiresAt&&(_.expiresAt=l.expiresAt)}u&&s.push(wf(`${Tg.SUBJECT_PREFIXES.TXN}.${n}.${u.table}`,(0,gg.createNatsTableStreamName)(n,u.table),void 0,u))}return Promise.all(s)}},Sg=class extends bf{static{a(this,"ImmmediateNATSTransaction")}constructor(){super({get timestamp(){return(0,G0.getNextMonotonicTime)()}})}addWrite(t,r){super.addWrite(t,r),this.commit()}};V0=new Sg});async function W0({clientId:e,user:t,listener:r,clean:s}){let n;if(e&&!s){let i=await Ng.getResource(e,{});n=new yg(e,t,i),i&&(n.sessionWasPresent=!0)}else{if(e){let i=await Ng.get(e);i&&i.delete()}n=new Lf(e,t)}return n}function bg(){return Cf++,Cf>65500&&(Cf=1),Cf}var K0,Ea,Ng,Cf,Lf,yg,Q0=Te(()=>{Ee();ru();K0=M(Er()),Ea=M(G());Ei();Ng=et({database:"system",table:"hdb_durable_session",attributes:[{name:"id",isPrimaryKey:!0},{name:"subscriptions",type:"array",elements:{attributes:[{name:"topic"},{name:"qos"},{name:"startTime"},{name:"acks"}]}}]});a(W0,"getSession");Cf=1;a(bg,"getNextMessageId");Lf=class{static{a(this,"SubscriptionsSession")}listener;sessionId;user;subscriptions=[];awaitingAcks;sessionWasPresent;constructor(t,r){this.sessionId=t,this.user=r}async addSubscription(t,r,s){let{topic:n,omitCurrent:i,startTime:o}=t,c=n.indexOf("?"),u,_;if(c>-1?(u=n.slice(c),_=n.slice(0,c)):_=n,!_)throw new Error("No topic provided");let l=!1,d;if((_.endsWith("+")||_.endsWith("#"))&&(l=!0,_.endsWith("+")&&(d=!0),_=_.slice(0,_.length-1)),_.indexOf(".")>-1)throw new Error("Dots are not allowed in topic names");if(_.indexOf("#")>-1||_.indexOf("+")>-1)throw new Error("Only trailing wildcards are supported");let f=this.subscriptions.find(b=>b.topic===n);f&&(f.end(),this.subscriptions.splice(this.subscriptions.indexOf(f),1));let E={search:u,async:!0,user:this.user,startTime:o,omitCurrent:i,isCollection:l,shallowWildcard:d,url:""};o&&(0,Ea.trace)("Resuming subscription from",n,"from",o);let h=ti.getMatch(_);if(!h)throw new Error(`The topic ${n} does not exist, no resource has been defined to handle this topic`);E.url=h.relativeURL;let p=h.path,S=h.Resource,g=await Ge(E,async()=>{let b=await S.subscribe(E);if(!b)throw new Error(`No subscription was returned from subscribe for topic ${n}`);if(!b[Symbol.asyncIterator])throw new Error(`Subscription is not (async) iterable for topic ${n}`);return(async()=>{for await(let O of b)try{let Y;if(O.type&&O.type!=="put"&&O.type!=="delete"&&O.type!=="message"||s&&!s(O))continue;r?(O.topic=n,Y=this.needsAcknowledge(O)):(O.acknowledge?.(),Y=bg());let Q=O.id;Array.isArray(Q)&&(Q=zo(Q)),Q==null&&(Q=""),this.listener(p+"/"+Q,O.value,Y,t)}catch(Y){(0,Ea.warn)(Y)}})(),b});return g.topic=n,g.qos=t.qos,this.subscriptions.push(g),g}resume(){}needsAcknowledge(t){let r=bg();return t.acknowledge&&(this.awaitingAcks||(this.awaitingAcks=new Map),this.awaitingAcks.set(r,t.acknowledge)),r}acknowledge(t){let r=this.awaitingAcks?.get(t);r&&(this.awaitingAcks.delete(t),r())}async removeSubscription(t){let r=this.subscriptions.find(s=>s.topic===t);r&&r.end()}async publish(t,r){let{topic:s,retain:n}=t;t.data=r,t.user=this.user,t.async=!0;let i=ti.getMatch(s);if(!i)throw new Error(`Can not publish to topic ${s} as it does not exist, no resource has been defined to handle this topic`);t.url=i.relativeURL;let o=i.Resource;return Ge(t,()=>n?r===void 0?o.delete(t,t):o.put(t,t.data,t):o.publish(t,t.data,t))}setListener(t){this.listener=t}disconnect(){for(let t of this.subscriptions)t.end();this.subscriptions=[]}},yg=class extends Lf{static{a(this,"DurableSubscriptionsSession")}sessionRecord;constructor(t,r,s){super(t,r),this.sessionRecord=s||{id:t,subscriptions:[]}}async resume(){for(let t of this.sessionRecord.subscriptions||[])await this.resumeSubscription({omitCurrent:!0,topic:t.topic,qos:t.qos,startTime:t.startTime},!0,t.acks?r=>!t.acks.includes(r.timestamp):null)}resumeSubscription(t,r,s){return super.addSubscription(t,r,s)}needsAcknowledge(t){this.awaitingAcks||(this.awaitingAcks=new Map);let r=bg(),s={topic:t.topic,timestamp:t.timestamp};return t.acknowledge&&(s.acknowledge=t.acknowledge),this.awaitingAcks.set(r,s),r}acknowledge(t){let r=this.awaitingAcks.get(t);this.awaitingAcks.delete(t),r.acknowledge?.();let s=r.topic;for(let[,n]of this.awaitingAcks)if(n.topic===s&&n.timestamp<r.timestamp){for(let i of this.sessionRecord.subscriptions)if(i.topic===s){i.acks||(i.acks=[]),i.acks.push(r.timestamp),(0,Ea.trace)("Received ack",s,r.timestamp),this.sessionRecord.update();return}}for(let n of this.sessionRecord.subscriptions)n.topic===s&&(n.startTime=r.timestamp);this.sessionRecord.update()}async addSubscription(t,r){await this.resumeSubscription(t,r);let{qos:s,startTime:n}=t;return s>0&&!n&&(this.sessionRecord.subscriptions=this.subscriptions.map(i=>{let o=i.startTime;return o||(o=i.startTime=(0,K0.getNextMonotonicTime)()),(0,Ea.trace)("Added durable subscription",i.topic,o),{qos:i.qos,topic:i.topic,startTime:o}}),Ng.put(this.sessionRecord)),t.qos}}});var wg={};qe(wg,{start:()=>ute});async function ute({server:e,port:t,webSocket:r,securePort:s,requireAuthentication:n}){let i=e.mqtt={requireAuthentication:n};r&&e.ws((o,c,u)=>{if(o.protocol==="mqtt"){let{onMessage:_,onClose:l}=X0(o,(d,f)=>{if(o.send(d),f&&o._socket.writableNeedDrain)return new Promise(E=>this._socket.once("drain",E))},c,Promise.resolve(u).then(()=>c?.user),i);o.on("message",_),o.on("close",l),o.on("error",d=>{(0,Xr.info)("WebSocket error",d)})}},{subProtocol:"mqtt"}),(t||s)&&e.socket(async o=>{let c;cte&&o.remoteAddress.includes("127.0.0.1")&&(c=await(0,j0.getSuperUser)());let{onMessage:u,onClose:_}=X0(o,l=>o.write(l),null,c,i);o.on("data",u),o.on("close",_),o.on("error",l=>{(0,Xr.info)("Socket error",l)})},{port:t,securePort:s})}function X0(e,t,r,s,n){J0||(J0=!0,yc(d=>{Df>0&&d.push({metric:"mqtt-connections",connections:Df,byThread:!0})}));let i;Df++;let o,c={protocolVersion:4},u=(0,Uf.parser)({protocolVersion:5});function _(d){u.parse(d)}a(_,"onMessage");function l(){Df--,i||(i=!0,o?.disconnect(),kr(!1,"connection","mqtt","disconnect"))}return a(l,"onClose"),u.on("packet",async d=>{s?.then&&(s=await s),o?.then&&await o;try{switch(d.cmd){case"connect":if(c.protocolVersion=d.protocolVersion,d.username)try{s=await ut.getUser(d.username,d.password.toString()),(0,Ig.get)(yn.CONFIG_PARAMS.LOGGING_AUDITAUTHEVENTS_LOGSUCCESSFUL)&&z0.notify({username:s.username,status:yn.AUTH_AUDIT_STATUS.SUCCESS,type:yn.AUTH_AUDIT_TYPES.AUTHENTICATION,auth_strategy:"MQTT",remote_address:e.remoteAddress})}catch{return(0,Ig.get)(yn.CONFIG_PARAMS.LOGGING_AUDITAUTHEVENTS_LOGFAILED)&&z0.error({username:s.username,status:yn.AUTH_AUDIT_STATUS.FAILURE,type:yn.AUTH_AUDIT_TYPES.AUTHENTICATION,auth_strategy:"mqtt",remote_address:e.remoteAddress}),f({cmd:"connack",reasonCode:4,returnCode:134})}if(!s&&n.requireAuthentication)return kr(!1,"connection","mqtt","connect"),f({cmd:"connack",reasonCode:4,returnCode:134});try{n.authorizeClient?.(d,s),o=W0({user:s,...d}),o=await o}catch(O){return(0,Xr.error)(O),kr(!1,"connection","mqtt","connect"),f({cmd:"connack",reasonCode:O.code||5,returnCode:O.code||128})}kr(!0,"connection","mqtt","connect"),f({cmd:"connack",sessionPresent:o.sessionWasPresent,reasonCode:0,returnCode:0}),o.setListener((O,Y,Q,F)=>{try{let w=O.indexOf("/",1),K=w>0?O.slice(0,w):O;f({cmd:"publish",topic:O,payload:E(Y),messageId:Q||Math.floor(Math.random()*1e8),qos:F.qos},K)}catch(w){(0,Xr.error)(w),o?.disconnect()}}),o.sessionWasPresent&&await o.resume();break;case"subscribe":let h=[];for(let O of d.subscriptions){let Y;try{Y=(await o.addSubscription(O,O.qos>=1)).qos||0}catch(Q){(0,Xr.error)(Q),Y=128}h.push(Y)}await o.committed,f({cmd:"suback",granted:h,messageId:d.messageId});break;case"unsubscribe":for(let O of d.unsubscriptions)o.removeSubscription(O);f({cmd:"unsuback",messageId:d.messageId});break;case"pubrel":f({cmd:"pubcomp",messageId:d.messageId,reasonCode:0});return;case"publish":let p=d.qos===2?"pubrec":"puback",S=e.deserialize||(e.deserialize=sa(r?.headers.get?.("content-type"))),g=d.payload?.length>0?S(d.payload):void 0,b;try{b=await o.publish(d,g)}catch(O){(0,Xr.warn)(O),d.qos>0&&f({cmd:p,messageId:d.messageId,reasonCode:128,returnCode:128},d.topic)}d.qos>0&&f({cmd:p,messageId:d.messageId,reasonCode:b===!1?144:0,returnCode:b===!1?144:0},d.topic);break;case"pubrec":f({cmd:"pubrel",messageId:d.messageId,reasonCode:0});break;case"pubcomp":case"puback":o.acknowledge(d.messageId);break;case"pingreq":f({cmd:"pingresp"});break;case"disconnect":i=!0,o?.disconnect(),kr(!0,"connection","mqtt","disconnect"),e.close?e.close():e.end();break}}catch(h){(0,Xr.error)(h),f({cmd:"disconnect"})}function f(h,p){let S=(0,Uf.generate)(h,c);t(S),br(S.length,"bytes-sent",p,h.cmd,"mqtt")}a(f,"sendPacket");function E(h){return si(h,r)}a(E,"serialize")}),{onMessage:_,onClose:l}}var Uf,j0,Ig,yn,Xr,z0,cte,J0,Df,Z0=Te(()=>{Uf=require("mqtt-packet");Q0();j0=M(xr());Jo();ln();hr();Ig=M(X()),yn=M(y()),Xr=M(G()),z0=(0,Xr.loggerWithTag)("auth-event"),cte=!0;a(ute,"start");Df=0;a(X0,"onSocket")});var tB={};qe(tB,{Request:()=>Cg,createReuseportFd:()=>Mf});var eB,Cg,Lg,Dg,Mf,Ug=Te(()=>{eB=require("os"),Cg=class{static{a(this,"Request")}#e;constructor(t,r){this.method=t.method;let s=t.url;this._nodeRequest=t,this._nodeResponse=r,this.url=s,this.headers=new Dg(t.headers)}get absoluteURL(){return this.protocol+"://"+this.host+this.url}get pathname(){let t=this.url.indexOf("?");return t>-1?this.url.slice(0,t):this.url}set pathname(t){let r=this.url.indexOf("?");r>-1?this.url=t+this.url.slice(r):this.url=t}get protocol(){return this._nodeRequest.socket.encrypted?"https":"http"}get ip(){return this._nodeRequest.socket.remoteAddress}get body(){return this.#e||(this.#e=new Lg(this._nodeRequest))}get host(){return this._nodeRequest.authority||this._nodeRequest.headers.host}get isAborted(){return!1}},Lg=class{static{a(this,"RequestBody")}#e;constructor(t){this.#e=t}on(t,r){return this.#e.on(t,r),this}},Dg=class{constructor(t){this.asObject=t}static{a(this,"Headers")}set(t,r){this.asObject[t.toLowerCase()]=r}get(t){return this.asObject[t.toLowerCase()]}has(t){return this.asObject.hasOwnProperty(t.toLowerCase())}[Symbol.iterator](){return Object.entries(this.asObject)[Symbol.iterator]()}keys(){return Object.keys(this.asObject)}values(){return Object.values(this.asObject)}forEach(t){for(let[r,s]of this)t(s,r,this)}};(0,eB.platform)()!="win32"&&(Mf=require("node-unix-socket").createReuseportFd)});var Pd={};qe(Pd,{component_errors:()=>ha,loadComponent:()=>Pf,loadComponentDirectories:()=>lB,setErrorReporter:()=>fte});function lB(e,t){t&&(Pg=t),e&&(vg=e);let r=[];if((0,Rs.existsSync)(Mg)){let n=(0,Rs.readdirSync)(Mg,{withFileTypes:!0});for(let i of n){if(!i.isDirectory()&&!i.isSymbolicLink())continue;let o=i.name,c=(0,gt.join)(Mg,o);r.push(Pf(c,Pg,"hdb",!1))}}let s=process.env.RUN_HDB_APP;return s&&r.push(Pf(s,Pg,s,!1,null,process.env.DEV_MODE)),Promise.all(r).then(()=>{uB=!0})}function fte(e){Lu=e}async function Pf(e,t,r,s,n,i){if(!sB.has(e)){sB.set(e,!0),n&&(vg=n);try{let o;s&&(ha=new Map);let c=(0,gt.join)(e,s?"harperdb-config.yaml":"config.yaml");(0,Rs.existsSync)(c)?o=s?(0,cB.getConfigObj)():(0,nB.parseDocument)((0,Rs.readFileSync)(c,"utf8"),{simpleKeys:!0}).toJSON():o=Bg;let u=[],_=s;for(let l in o){let d=o[l];if(ha.set(s?l:(0,gt.basename)(e),!1),!d)continue;let f,E=d.package;try{if(E){let b=e,O;for(;!(0,Rs.existsSync)(O=(0,gt.join)(b,"node_modules",l));)if(b=(0,gt.dirname)(b),b.length<(0,aB.getHdbBasePath)().length){O=null;break}if(O)f=await Pf(O,t,r,!1),_=!0;else throw new Error(`Unable to find package ${l}:${E}`)}else f=dte[l];if(!f)continue;u.push(f);let h=a(b=>(b.origin=r,et(b)),"ensureTable"),p=d.network||(d.port||d.securePort)&&d,S=p?.securePort||p?.https&&p.port,g=!p?.https&&p?.port;if(wu.isMainThread&&(f=await f.startOnMainThread?.({server:ut,ensureTable:h,port:g,securePort:S,resources:t,...d})||f,s&&p))for(let b of[g,S])try{if(+b&&!rB.includes(b)){let O=Hg.get(qg.CONFIG_PARAMS.HTTP_SESSIONAFFINITY);O&&Cu.default.warn("Session affinity is not recommended and may cause memory leaks"),(O||!Mf)&&(rB.push(b),g0(b,O))}}catch(O){console.error("Error listening on socket",b,O,l)}if(t.isWorker&&(f=await f.start?.({server:ut,ensureTable:h,port:g,securePort:S,resources:t,...d})||f),vg.set(f,!0),f.handleFile&&d.files){if(d.files.includes(".."))throw(0,oB.handleHDBError)("Can not reference parent directories");let b=(0,gt.join)(e,d.files).replace(/\\/g,"/"),O=b.indexOf("/*");if(O>-1&&d.files!==Bg[l]?.files&&!(0,Rs.existsSync)(b.slice(0,O)))throw new Error(`The path '${b.slice(0,O)}' does not exist and cannot be used as the base of the resolved 'files' path value '${d.files}'`);for(let Y of await(0,iB.default)(b,{onlyFiles:!1,objectMode:!0})){let{path:Q,dirent:F}=Y;_=!0;let w=(0,gt.relative)(e,Q).replace(/\\/g,"/");if(d.root){let x=d.root;if(x.startsWith("/")&&(x=x.slice(1)),x.endsWith("/")&&(x=x.slice(0,-1)),x+="/",w.startsWith(x))w=w.slice(x.length);else throw new Error(`The root path '${d.root}' does not reference a valid part of the file path '${w}'.The root path should be used to indicate the relative path/part of the file path for determining the exported web path.`)}let K=(0,gt.basename)(e),B=d.path||"/";B=B.startsWith("/")?B:B.startsWith("./")?"/"+K+B.slice(2):B==="."?"/"+K:"/"+K+"/"+B,B+=(B.endsWith("/")?"":"/")+w;try{if(F.isFile()){let x=await _te(Q);wu.isMainThread&&await f.setupFile?.(x,B,Q,t),t.isWorker&&await f.handleFile?.(x,B,Q,t)}else wu.isMainThread&&await f.setupDirectory?.(B,Q,t),t.isWorker&&await f.handleDirectory?.(B,Q,t)}catch(x){x.message=`Could not load ${F.isFile()?"file":"directory"} '${Q}'${d.module?" using '"+d.module+"'":""} for application '${e}' due to: ${x.message}`,Lu?.(x),((0,ma.getWorkerIndex)()===0?console:Cu.default).error(x),t.set(d.path||"/",new Du(x)),ha.set(s?l:(0,gt.basename)(e),x.message)}}}}catch(h){h.message=`Could not load component '${l}' for application '${(0,gt.basename)(e)}' due to: ${h.message}`,Lu?.(h),((0,ma.getWorkerIndex)()===0?console:Cu.default).error(h),t.set(d.path||"/",new Du(h),null,!0),ha.set(s?l:(0,gt.basename)(e),h.message)}}if(wu.isMainThread&&!uB&&i&&(0,ma.watchDir)(e,async()=>lB()),o.extensionModule)return await Tl((0,gt.join)(e,o.extensionModule));if(!_){let l=`${e} did not load any modules, resources, or files, is this a valid component?`;Lu?.(new Error(l)),((0,ma.getWorkerIndex)()===0?console:Cu.default).error(l),ha.set((0,gt.basename)(e),l)}}catch(o){console.error(`Could not load application directory ${e}`,o),o.message=`Could not load application due to ${o.message}`,Lu?.(o),t.set("",new Du(o))}}}var Rs,gt,wu,nB,Hg,qg,iB,ma,Cu,oB,aB,lte,cB,_te,Mg,vg,uB,Pg,ha,dte,Bg,rB,sB,Lu,Du,vd=Te(()=>{Rs=require("fs"),gt=require("path"),wu=require("worker_threads"),nB=require("yaml"),Hg=M(X()),qg=M(y());GA();$A();YA();yP();l0();h0();iB=M(require("fast-glob")),ma=M(Je()),Cu=M(G());HE();hr();oB=M(j());ns();Ee();R0();aB=M(X()),lte=M(b0());yd();Y0();Z0();cB=M(gr());Ug();({readFile:_te}=Rs.promises),Mg=Hg.get(qg.CONFIG_PARAMS.COMPONENTSROOT),vg=new Map,ha=new Map;a(lB,"loadComponentDirectories");dte={REST:zd,rest:zd,graphqlSchema:BE,jsResource:FE,fastifyRoutes:ug,login:xE,static:lg,operationsApi:lte,customFunctions:{},http:{},clustering:Ag,authentication:su,mqtt:wg},Bg={rest:!0,graphqlSchema:{files:"*.graphql"},jsResource:{files:"resources.js"},fastifyRoutes:{files:"routes/*.js",path:"."}};Object.defineProperty(Bg,"static",{value:{files:"web/**"}});rB=[],sB=new Map;a(fte,"setErrorReporter");a(Pf,"loadComponent");Du=class extends Ot{constructor(r){super();this.error=r}static{a(this,"ErrorResource")}get(){throw this.error}post(){throw this.error}put(){throw this.error}delete(){throw this.error}connect(){throw this.error}getResource(){return this}publish(){throw this.error}subscribe(){throw this.error}}});var Gg=T((cEe,dB)=>{var{isMainThread:_B}=require("worker_threads"),{getTables:Ete}=(Ee(),Z(Ce)),{loadComponentDirectories:hte,loadComponent:mte}=(vd(),Z(Pd)),{resetResources:pte}=(ru(),Z(YU)),Ste=nT(),Tte=gr(),{dirname:gte}=require("path"),{getConnection:Rte}=_t(),Ate=X(),Ote=y(),Fg=new Map;async function Nte(e=!1){!_B&&Ate.get(Ote.CONFIG_PARAMS.CLUSTERING_ENABLED)&&Rte();try{_B&&await Ste()}catch(s){console.error(s)}let t=pte();Ete(),t.isWorker=e,await mte(gte(Tte.getConfigFilePath()),t,"hdb",!0,Fg),await hte(Fg,t);let r=[];for(let[s]of Fg)s.ready&&r.push(s.ready());r.length>0&&await Promise.all(r)}a(Nte,"loadRootComponents");dB.exports.loadRootComponents=Nte});var Je=T((lEe,ai)=>{"use strict";var{Worker:bte,MessageChannel:yte,parentPort:Ks,isMainThread:Yg,threadId:Ite,workerData:In}=require("worker_threads"),{PACKAGE_ROOT:wte}=y(),{join:hB,isAbsolute:Cte,extname:Lte}=require("path"),{server:mB}=(hr(),Z(hi)),{watch:Dte,readdir:Ute}=require("fs/promises"),{totalmem:fB}=require("os"),Hf=y(),Mte=X(),wn=G(),{randomBytes:Pte}=require("crypto"),{_assignPackageExport:vte}=require("../../index"),Bte=y(),Hte=1024*1024,oi=[],jr=[],qte=50,Kg=1e4,Fte="restart",pB="request_thread_info",SB="resource_report",TB="thread_info",gB="added-port",Gte="ack",xg;vte("threads",jr);ai.exports={startWorker:kg,restartWorkers:Qg,shutdownWorkers:Yte,workers:oi,setMonitorListener:Zte,onMessageFromWorkers:Kte,onMessageByType:yB,broadcast:Qte,broadcastWithAcknowledgement:Jte,setChildListenerByType:$te,getWorkerIndex:RB,getWorkerCount:AB,getTicketKeys:OB,setMainIsWorker:kte,setTerminateTimeout:xte,restartNumber:In?.restartNumber||1};jr.onMessageByType=yB;jr.sendToThread=function(e,t){if(!t?.type)throw new Error("A message with a type must be provided");let r=jr.find(s=>s.threadId===e);if(r)return r.postMessage(t),!0};var Wg;function xte(e){Kg=e}a(xte,"setTerminateTimeout");function RB(){return In?In.workerIndex:Wg?0:void 0}a(RB,"getWorkerIndex");function AB(){return In?In.workerCount:Wg?1:void 0}a(AB,"getWorkerCount");function kte(e){Wg=e}a(kte,"setMainIsWorker");var vf;function OB(){return vf||(vf=Yg?Pte(48):In.ticketKeys,vf)}a(OB,"getTicketKeys");Object.defineProperty(mB,"workerIndex",{get(){return RB()}});Object.defineProperty(mB,"workerCount",{get(){return AB()}});var NB={[pB](e,t){Xte(t)},[SB](e,t){jte(t,e)}};function kg(e,t={}){let r=process.constrainedMemory?.()||fB();r=Math.min(r,fB());let s=Math.max(Math.floor(r/Hte/(1+(t.threadCount||1)/4)),512),n=Math.min(Math.max(s>>7,16),64),i=[],o=[];for(let u of jr){let _=new yte;_.existingPort=u,i.push(_),o.push(_.port2)}Lte(e)||(e+=".js");let c=new bte(Cte(e)?e:hB(wte,e),Object.assign({resourceLimits:{maxOldGenerationSizeMb:s,maxYoungGenerationSizeMb:n},execArgv:["--enable-source-maps"],argv:process.argv.slice(2),workerData:{addPorts:o,addThreadIds:i.map(u=>u.existingPort.threadId),workerIndex:t.workerIndex,workerCount:t.threadCount,name:t.name,restartNumber:ai.exports.restartNumber,ticketKeys:OB()},transferList:o},t));for(let{port1:u,existingPort:_}of i)_.postMessage({type:gB,port:u,threadId:c.threadId},[u]);return qf(c,!0),c.unexpectedRestarts=t.unexpectedRestarts||0,c.startCopy=()=>kg(e,t),c.on("error",u=>{console.error("Worker error:",u),wn.error("Worker error:",u)}),c.on("exit",u=>{oi.splice(oi.indexOf(c),1),!c.wasShutdown&&t.autoRestart!==!1&&(c.unexpectedRestarts<qte?(t.unexpectedRestarts=c.unexpectedRestarts+1,kg(e,t)):wn.error(`Thread has been restarted ${c.restarts} times and will not be restarted`))}),c.on("message",u=>{NB[u.type]?.(u,c)}),oi.push(c),tre(),t.onStarted&&t.onStarted(c),c.name=t.name,c}a(kg,"startWorker");var Vte=[Hf.THREAD_TYPES.HTTP];async function Qg(e=null,t=2,r=!0){if(Yg){if(r){let{loadRootComponents:o}=Gg();await o()}ai.exports.restartNumber++,t<1&&(t=t*oi.length);let s=[],n=[];for(let o of oi.slice(0)){if(e&&o.name!==e||o.wasShutdown)continue;wn.trace("sending shutdown request to ",o.threadId),o.postMessage({restartNumber:ai.exports.restartNumber,type:Hf.ITC_EVENT_TYPES.SHUTDOWN}),o.wasShutdown=!0,o.emit("shutdown",{});let c=Vte.indexOf(o.name)>-1,u=new Promise(_=>{let l=setTimeout(()=>o.terminate(),Kg*2).unref();o.on("exit",()=>{clearTimeout(l),s.splice(s.indexOf(u)),!c&&r&&o.startCopy(),_()})});if(s.push(u),c&&r){let _=o.startCopy(),l=new Promise(d=>{let f=a(E=>{E.type===Bte.ITC_EVENT_TYPES.CHILD_STARTED&&(wn.trace("Worker has started",_.threadId),d(),n.splice(n.indexOf(l)),_.off("message",f))},"startListener");wn.trace("Waiting for worker to start",_.threadId),_.on("message",f)});n.push(l),s.length>=t&&await Promise.race(s),n.length>=t&&await Promise.race(n)}}await Promise.all(s),await Promise.all(n);let{restartService:i}=gd();r&&(e==="http"||!e)&&Mte.get(Hf.CONFIG_PARAMS.CLUSTERING_ENABLED)&&await i({service:"clustering"})}else Ks.postMessage({type:Fte,workerType:e})}a(Qg,"restartWorkers");function $te(e,t){NB[e]=t}a($te,"setChildListenerByType");function Yte(e){return Qg(e,1/0,!1)}a(Yte,"shutdownWorkers");var bB=[];function Kte(e){bB.push(e)}a(Kte,"onMessageFromWorkers");var Vg=new Map;function yB(e,t){let r=Vg.get(e);r||Vg.set(e,r=[]),r.push(t)}a(yB,"onMessageByType");var Wte=10;async function Qte(e){let t=0;for(let r of jr)try{r.postMessage(e),t++>Wte&&(t=0,await new Promise(setImmediate))}catch(s){wn.error("Unable to send message to worker",s)}}a(Qte,"broadcast");var Bf=new Map,zte=1;function Jte(e){return new Promise(t=>{let r=0;for(let s of jr)try{let n=zte++,i=a(()=>{Bf.delete(n),--r===0&&t(),s!==Ks&&--s.refCount===0&&s.unref()},"ack_handler");i.port=s,s.ref(),s.refCount=(s.refCount||0)+1,Bf.set(e.requestId=n,i),s.hasAckCloseListener||(s.hasAckCloseListener=!0,s.on(s.close?"close":"exit",()=>{for(let[,o]of Bf)o.port===s&&o()})),s.postMessage(e),r++}catch(n){wn.error("Unable to send message to worker",n)}r===0&&t()})}a(Jte,"broadcastWithAcknowledgement");function Xte(e){e.postMessage({type:TB,workers:IB()})}a(Xte,"sendThreadInfo");function IB(){let e=Date.now();return oi.map(t=>({threadId:t.threadId,name:t.name,heapTotal:t.resources?.heapTotal,heapUsed:t.resources?.heapUsed,externalMemory:t.resources?.external,arrayBuffers:t.resources?.arrayBuffers,sinceLastUpdate:e-t.resources?.updated,...t.recentELU}))}a(IB,"getChildWorkerInfo");function jte(e,t){e.resources=t,e.resources.updated=Date.now()}a(jte,"recordResourceReport");var $g;function Zte(e){$g=e}a(Zte,"setMonitorListener");var ere=1e3,EB=!1;function tre(){EB||(EB=!0,setInterval(()=>{for(let e of oi){let t=e.performance.eventLoopUtilization(),r;e.lastTotalELU?r=e.performance.eventLoopUtilization(t,e.lastTotalELU):r=t,e.lastTotalELU=t,e.recentELU=r}$g&&$g()},ere).unref())}a(tre,"startMonitoring");var rre=1e3;if(Ks){qf(Ks);for(let e=0,t=In.addPorts.length;e<t;e++){let r=In.addPorts[e];r.threadId=In.addThreadIds[e],qf(r)}setInterval(()=>{let e=process.memoryUsage();Ks.postMessage({type:SB,heapTotal:e.heapTotal,heapUsed:e.heapUsed,external:e.external,arrayBuffers:e.arrayBuffers})},rre).unref(),xg=a(()=>new Promise((e,t)=>{Ks.on("message",r),Ks.postMessage({type:pB});function r(s){s.type===TB&&(Ks.off("message",r),e(s.workers))}a(r,"receiveThreadInfo")}),"getThreadInfo")}else xg=IB;ai.exports.getThreadInfo=xg;function qf(e,t){jr.push(e),e.on("message",r=>{if(r.type===gB)r.port.threadId=r.threadId,qf(r.port);else if(r.type===Gte){let s=Bf.get(r.id);s&&s()}else{for(let n of bB)n(r,e);let s=Vg.get(r.type);if(s)for(let n of s)try{n(r,e)}catch(i){wn.error(i)}}}).on("close",()=>{jr.splice(jr.indexOf(e),1)}).on("exit",()=>{jr.splice(jr.indexOf(e),1)}),t?e.refCount=100:e.unref()}a(qf,"addPort");if(Yg){let e,t,r=a(async(s,n)=>{n&&(e=n);for(let i of await Ute(s,{withFileTypes:!0}))i.isDirectory()&&i.name!=="node_modules"&&r(hB(s,i.name));try{for await(let{filename:i}of Dte(s,{persistent:!1}))t&&clearTimeout(t),t=setTimeout(async()=>{e&&await e(),await Qg(),console.log("Reloaded HarperDB components")},100)}catch(i){console.warn("Error trying to watch component directory",s,i)}},"watch_dir");ai.exports.watchDir=r,process.env.WATCH_DIR&&r(process.env.WATCH_DIR)}else Ks.on("message",async e=>{let{type:t}=e;t===Hf.ITC_EVENT_TYPES.SHUTDOWN&&(ai.exports.restartNumber=e.restartNumber,Ks.unref(),setTimeout(()=>{wn.warn("Thread did not voluntarily terminate",Ite),process.exit(0)},Kg).unref())})});function CB(e,t,r,s,n){let i=e.primaryStore.env.path,o=e.primaryStore.tableId;pa||((0,Mu.onMessageByType)(wB,d=>{LB(d.path)}),(0,Mu.onMessageByType)(sre,d=>{(0,Uu.trace)("confirming to proceed with txn",d.txnId)}),pa=Object.create(null));let c=pa[i]||(pa[i]=[]);c.auditStore=e.auditStore;let u=c[o];u||(u=c[o]=new Map,u.envs=c,u.tableId=o,u.store=e.primaryStore),t=zo(t);let _=new Jg(r);_.startTime=s,n&&(_.includeDescendants=n);let l=u.get(t);return l?l.push(_):(u.set(t,l=[_]),l.tables=u,l.key=t),_.subscriptions=l,_}function LB(e,t){if(!pa)return;let r=pa[e];if(!r)return;try{r.auditStore.resetReadTxn()}catch(n){throw n.message+=" in "+e,n}let s;for(let{key:n,value:i}of r.auditStore.getRange({start:zg,exclusiveStart:!0})){zg=n;let o=pr(i),c=r[o.tableId];if(!c)continue;let u=o.recordId,_,l=zo(o.recordId),d;do{let f=c.get(l);if(f){for(let h of f)if(!(d&&!h.includeDescendants)){if(h.startTime>=n){(0,Uu.info)("omitting",u,h.startTime,n);continue}try{if(h.crossThreads===!1&&!t)continue;let p;h.supportsTransactions&&h.txnInProgress!==o.version&&(p=!0,h.txnInProgress||(s?s.push(h):s=[h]),h.txnInProgress=o.version),h.listener(u,o,n,p)}catch(p){console.error(p),(0,Uu.info)(p)}}}if(l==null)break;let E=l.lastIndexOf?.("/",l.length-2);E>-1?l=l.slice(0,E+1):l=null,d=!0}while(!0)}if(s)for(let n of s)n.txnInProgress=null,n.listener(null,{type:"end_txn"},zg,!0)}function DB(e,t){let r=t||e,s=r.env;if(t&&!t.cache&&(t.cache=new Map),!s.hasBroadcastListener){s.hasBroadcastListener=!0;let n=s.path;r.on("aftercommit",()=>{(0,Mu.broadcast)({type:wB,path:n}),LB(n,!0)})}}var Uu,Mu,wB,sre,pa,mEe,Jg,zg,UB=Te(()=>{Uu=M(G()),Mu=M(Je());Ha();ru();ao();wB="transaction",sre="transaction-await",mEe=Buffer.alloc(4096);a(CB,"addSubscription");Jg=class extends rs{static{a(this,"Subscription")}listener;subscriptions;startTime;constructor(t){super(),this.listener=t,this.on("close",()=>this.end())}end(){if(this.subscriptions){if(this.subscriptions.splice(this.subscriptions.indexOf(this),1),this.subscriptions.length===0){let t=this.subscriptions.tables,r=this.subscriptions.key;if(t.delete(r),t.size===0){let s=t.envs,n=t.dbi;delete s[n]}}this.subscriptions=null}}toJSON(){return{name:"subscription"}}},zg=Date.now();a(LB,"notifyFromTransactionData");a(DB,"listenToCommits")});var YT={};qe(YT,{coerceType:()=>Vf,makeTable:()=>Kf,setServerUtilities:()=>_re,updateResource:()=>Hu});function Kf(e){let{primaryKey:t,indices:r,tableId:s,tableName:n,primaryStore:i,databasePath:o,databaseName:c,auditStore:u,schemaDefined:_,dbisDB:l}=e,{expirationMS:d,evictionMS:f,audit:E,trackDeletes:h}=e,{attributes:p}=e;p||(p=[]),DB(i,u);let S=uh(i,s,u),g=0,b,O,Y,Q={},F=Promise.resolve(),w,K,B;for(let W of p)(W.assignCreatedTime||W.name==="__createdtime__")&&(w=W),(W.assignUpdatedTime||W.name==="__updatedtime__")&&(K=W),W.expiresAt&&(B=W),W.isPrimaryKey&&(Q=W);let x,te=[],be=[],se=1,vt=2,Pe={},At={},es=864e5,mR,Qu,pH=10,SH=6;E&&TR();class at extends Ot{static name=n;static primaryStore=i;static auditStore=u;static primaryKey=t;static tableName=n;static indices=r;static audit=E;static databasePath=o;static databaseName=c;static attributes=p;static expirationTimer;static createdTimeProperty=w;static updatedTimeProperty=K;static sources=[];static get expirationMS(){return d}static dbisDB=l;static schemaDefined=_;static sourcedFrom(m,R){R&&(this.sourceOptions=R,(R.expiration||R.eviction||R.scanInterval)&&this.setTTLExpiration(R)),R?.intermediateSource?(m.intermediateSource=!0,this.sources.unshift(m)):this.sources.push(m),O=m.get&&(!m.get.reliesOnPrototype||m.prototype.get);let D=a(I=>{let U=this.sources.slice(0,-1);if(U=U.filter(L=>L[I]&&(!L[I].reliesOnPrototype||L.prototype[I])),U.length>0)if(U.length===1){let L=U[0];return(V,z,oe)=>{if(V?.source!==L)return L[I](z,oe,V)}}else return(L,V,z)=>{let oe=[];for(let k of U){if(L?.source===k)break;oe.push(k[I](V,z,L))}return Promise.all(oe)}},"getApplyToIntermediateSource"),A=this.sources[this.sources.length-1],C=a(I=>{if(A[I]&&(!A[I].reliesOnPrototype||A.prototype[I]))return(U,L,V)=>{if(!U?.source)return A[I](L,V,U)}},"getApplyToCanonicalSource");return Pe={put:C("put"),delete:C("delete"),publish:C("publish")},At={put:D("put"),delete:D("delete"),publish:D("publish"),invalidate:D("invalidate")},(async()=>{let I=!1,U=a(async(L,V)=>{let z=L.value,oe=L.table?xe[c][L.table]:at;if(c===As.SYSTEM_SCHEMA_NAME&&(L.table===As.SYSTEM_TABLE_NAMES.ROLE_TABLE_NAME||L.table===As.SYSTEM_TABLE_NAMES.USER_TABLE_NAME)&&(I=!0),L.id===void 0&&(L.id=z[oe.primaryKey],L.id===void 0))throw new Error("Replication message without an id "+JSON.stringify(L));L.source=m;let k=await oe.getResource(L.id,V,Pu);switch(L.type){case"put":return k._writeUpdate(z,Pu);case"delete":return k._writeDelete(Pu);case"publish":return k._writePublish(z,Pu);case"invalidate":return k.invalidate(Pu);default:We.error("Unknown operation",L.type,L.id)}},"writeUpdate");try{let L=m.subscribe;L&&h==null&&(h=!0);let V=m.subscribeOnThisThread?m.subscribeOnThisThread((0,ji.getWorkerIndex)()):(0,ji.getWorkerIndex)()===0,z=L&&V&&await m.subscribe?.({crossThreads:!1,inTransactionUpdates:!0,supportsTransactions:!0,omitCurrent:!0});if(z){let oe;for await(let k of z)try{if(!(k.type==="transaction"?k.writes[0]:k)){We.error("Bad subscription event",k);continue}if(k.source=m,oe)if(k.beginTxn)oe.resolve();else{U(k,oe);continue}if(k.type==="end_txn")continue;let Ne=Ge(k,()=>{if(k.type==="transaction"){let ne=[];for(let Bt of k.writes)try{ne.push(U(Bt,k))}catch($t){throw $t.message+=" writing "+JSON.stringify(Bt)+" of event "+JSON.stringify(k),$t}return Promise.all(ne)}else if(k.type==="define_schema"){let ne=this.attributes.slice(0),Bt;for(let $t of k.attributes)ne.find(li=>li.name===$t.name)||(ne.push($t),Bt=!0);Bt&&(et({table:n,database:c,attributes:ne,origin:"cluster"}),Fu.signalSchemaChange(new Gu.SchemaEventMsg(process.pid,As.OPERATIONS_ENUM.CREATE_TABLE,c,n)))}else return k.beginTxn?(oe=k,U(k,k),new Promise(ne=>{oe.resolve=ne})):U(k,k)});I&&(await Ne,Fu.signalUserChange(new Gu.UserEventMsg(process.pid))),k.onCommit&&(Ne?.then?Ne.then(k.onCommit):k.onCommit())}catch(he){We.error("error in subscription handler",he)}}}catch(L){We.error(L)}})(),this}static getResource(m,R,D){let A=super.getResource(m,R,D);if(m!=null){Aa(m);try{if(A.hasOwnProperty(ge))return A;if(typeof m=="object"&&m&&!Array.isArray(m))throw new Error(`Invalid id ${JSON.stringify(m)}`);let C=!D?.async||i.cache?.get(m),I=Un(R),U=I.getReadTxn();if(U?.isDone)throw new Error("You can not read from a transaction that has already been committed/aborted");return pR(m,R,{transaction:U},C,L=>{if(L?Hu(A,L):A[ge]=null,R.onlyIfCached&&R.noCacheStore){if(!A.doesExist())throw new Qs.ServerError("Entry is not cached",504)}else if(D?.ensureLoaded){let V=aE(m,L,R,A);if(V)return I?.disregardReadTxn(),A[jg]=!0,eR(V,z=>(Hu(A,z),A))}return A})}catch(C){throw C.message.includes("Unable to serialize object")&&(C.message+=": "+JSON.stringify(m)),C}}return A}ensureLoaded(){let m=aE(this[Ie],this[Ws],this[fe]);if(m)return this[jg]=!0,eR(m,R=>{this[Ws]=R,this[ge]=R.value,this[kf]=R.version})}static setTTLExpiration(m){if(typeof m=="number")d=m*1e3,f||(f=0);else if(m&&typeof m=="object")d=m.expiration*1e3,f=(m.eviction||0)*1e3,es=m.scanInterval*1e3;else throw new Error("Invalid expiration value type");if(d<0)throw new Error("Expiration can not be negative");es=es||(d+f)/4,cE()}static enableAuditing(m=!0){E=m,m&&TR(),at.audit=m}static coerceId(m){return m===""?null:Vf(m,Q)}static async dropTable(){if(delete xe[c][n],c===o){for(let m of p)l.remove(at.tableName+"/"+m.name),r[m.name]?.drop();l.remove(at.tableName+"/"),i.drop(),await l.committed}else console.log("legacy dropTable"),await i.close(),await fs.remove(data_path),await fs.remove(data_path===standard_path?data_path+MDB_LOCK_FILE_SUFFIX:path.join(path.dirname(data_path),MDB_LEGACY_LOCK_FILE_NAME));Fu.signalSchemaChange(new Gu.SchemaEventMsg(process.pid,As.OPERATIONS_ENUM.DROP_TABLE,c,n))}static get(m,R){if(m&&typeof m=="object"&&!Array.isArray(m)&&m.url===""){let D=this.getRecordCount();return{recordCount:D.recordCount,estimatedRecordRange:D.estimatedRange,records:"./",name:n,database:c,attributes:p}}return super.get(m,R)}get(m){if(typeof m=="string")return this.getProperty(m);if(this[ws])return this.search(m);if(m?.property)return this.getProperty(m.property);if(this.doesExist()||m?.ensureLoaded===!1||this[fe]?.returnNonexistent)return this}static allowRead(m,R){if(!m)return!1;let D=m.role.permission;if(D.super_user)return!0;if(D[n]?.read){let A=D[n].attribute_permissions;if(A){R||(R={});let C=R.select;if(C){let I=Zg(A,"read");R.select=C.filter(U=>I[U])}else R.select=A.filter(I=>I.read).map(I=>I.attribute_name);return R}else return!0}}allowUpdate(m,R,D){if(!m)return!1;let A=m.role.permission;if(A.super_user)return!0;if(A[n]?.update){let C=A[n].attribute_permissions;if(C){let I=Zg(C,"update");for(let U in R)if(!I[U])return!1;if(D)for(let U of C){let L=U.attribute_name;!U.update&&!(L in R)&&(R[L]=this.getProperty(L))}}else return!0}}allowCreate(m,R){return this.allowUpdate(m,{})}static allowCreate(m,R){if(!m)return!1;let D=m.role.permission;if(D.super_user)return!0;if(D[n]?.insert){let A=D[n].attribute_permissions;if(A){let C=Zg(A,"insert");for(let I in R)if(!C[I])return!1}else return!0}}static allowDelete(m){if(!m)return!1;let R=m.role.permission;if(R.super_user||R[n]?.delete)return!0}update(m,R){if(!Un(this[fe]))throw new Error("Can not update a table resource outside of a transaction");if(m===!1)return this;let A;if(typeof m=="object"&&m)if(R){Object.isFrozen(m)&&(m=Object.assign({},m));for(let C in this[ge])m[C]===void 0&&(m[C]=void 0);this[Ht]=m}else A=this[Ht],A&&(m=Object.assign(A,m)),this[Ht]=A=m;return this._writeUpdate(this),this}invalidate(m){let R=this[fe],D=this[Ie];Aa(D),Un(this[fe]).addWrite({key:D,store:i,invalidated:!0,entry:this[Ws],nodeName:this[fe]?.nodeName,before:Pe.invalidate?.bind(this,R,D),beforeIntermediate:At.invalidate?.bind(this,R,D),commit:(C,I)=>{if(I?.version>C)return;let U=null;for(let L in r)U||(U={}),U[L]=this.getProperty(L);S(D,U,this[Ws],C,Ff,E,this[fe],0,"invalidate")}})}static evict(m,R,D){let A=this.Source,C;if(!((O||E)&&(!R||(C=i.getEntry(m),!C||!R)||C.version!==D))){if(O){if(i.hasLock(m,C.version))return;let I;for(let U in r)I||(I={}),I[U]=R[U];if(I){S(m,I,C,D,Gf,null,null,0,null,!0);return}}if(i.ifVersion(D,()=>{zu(m,R,null)}),E)S(m,null,C,D,Gf,null,null,0,null,!0);else return i.remove(m,D)}}lock(){throw new Error("Not yet implemented")}static operation(m,R){return m.table||=n,m.schema||=c,FB.operation(m,R)}async put(m){this.update(m,!0)}_writeUpdate(m,R){let D=this[fe],A=Un(D),C=this[Ie];Aa(C);let I=this[Ws];this[Xg]=!0;let U={key:C,store:i,entry:I,nodeName:D?.nodeName,validate:L=>{if(!m[PB]||ul(m)){if(this.validate(m),D?.source?m=qa(m):(t&&m[t]!==C&&(m[t]=C),K&&(m[K.name]=K.type==="Date"?new Date(L):K.type==="String"?new Date(L).toISOString():L),w&&(I?.value?m[w.name]=I?.value[w.name]:m[w.name]=w.type==="Date"?new Date(L):w.type==="String"?new Date(L).toISOString():L),m=qa(m)),m[ge])throw new Error("Can not assign a record with a record property");this[ge]=m}else A.removeWrite(U)},before:Pe.put&&(()=>Pe.put(D,C,m)),beforeIntermediate:At.put&&(()=>At.put(D,C,m)),commit:(L,V,z)=>{z&&(D&&V?.version>(D.lastModified||0)&&(D.lastModified=V.version),Hu(this,V));let oe=V?.value;this[Xg]=!1,We.trace("Checking timestamp for put",C,V?.version>L,V?.version,L),!(V?.version>L)&&(zu(C,oe,m),S(C,m,V,L,0,E,D,D.expiresAt||(d?d+Date.now():0)))}};A.addWrite(U)}async delete(m){if(typeof m=="string")return this.deleteProperty(m);if(this[ws]){for await(let R of this.search(m))(await at.getResource(R[t],this.getContext(),{ensureLoaded:!1}))._writeDelete(m);return}return this[ge]?this._writeDelete(m):!1}_writeDelete(m){let R=Un(this[fe]),D=this[Ie];Aa(D);let A=this[fe];return R.addWrite({key:D,store:i,resource:this,nodeName:A?.nodeName,before:Pe.delete?.bind(this,A,D),beforeIntermediate:At.delete?.bind(this,A,D),commit:(C,I,U)=>{let L=I?.value;U&&(A&&I?.version>(A.lastModified||0)&&(A.lastModified=I.version),Hu(this,I)),!(I?.version>C)&&(zu(this[Ie],L),We.trace("Write delete entry",D,C),E||h?(S(D,null,this[Ws],C,0,E,this[fe],0,"delete"),E||cE()):i.remove(this[Ie]))}}),!0}search(m){let R=Un(this[fe]);if(!m)throw new Error("No query provided");let D=m.reverse===!0,A=m.conditions;A?A.length===void 0&&(A=Array.from(A)):A=Array.isArray(m)?m:m[Symbol.iterator]?Array.from(m):[],this[Ie]&&(A=[{attribute:null,comparator:"prefix",value:this[Ie]}].concat(A));for(let k of A){let he=k[0]??k.attribute,Ne=he==null?Q:p.find(ne=>ne.name==he);if(Ne)Ne.type&&(k[1]===void 0?k.value=C(k.value,Ne):k[1]=C(k[1],Ne));else if(he!=null)throw(0,Qs.handleHDBError)(new Error,`${he} is not a defined attribute`,404)}function C(k,he){return Array.isArray(k)?k.map(Ne=>Vf(Ne,he)):Vf(k,he)}a(C,"coerceTypedValues"),A.length>1&&(A=(0,qB.sortBy)(A,k=>{if(k.estimated_count===void 0){let he=k.comparator||k.search_type;if(he===Bu.SEARCH_TYPES.EQUALS){let Ne=k[0]??k.attribute;if(Ne==null||Ne===t)k.estimated_count=1;else{let ne=r[Ne];k.estimated_count=ne?ne.getValuesCount(k[1]??k.value):1/0}}else he===Bu.SEARCH_TYPES.CONTAINS||he===Bu.SEARCH_TYPES.ENDS_WITH||he==="ne"?k.estimated_count=1/0:he===Bu.SEARCH_TYPES.STARTS_WITH||he==="prefix"?k.estimated_count=ore:k.estimated_count=ire}return k.estimated_count}));let I=R.getReadTxn();I.use();let U=m.select,L=A[0],V;if(!L)V=i.getRange(D?{end:!1,reverse:!0,transaction:I,lazy:U?.length<4}:{start:!1,transaction:I,lazy:U?.length<4}).map(({value:k})=>k?new Promise(he=>setImmediate(()=>he(k))):xf.SKIP);else{let k=LE(L,I,D,at,m.allowFullScan);if(!m.operator||m.operator.toLowerCase()==="and"){let he=A.slice(1).map(DE);V=oe(k,he)}else{for(let Ne=1;Ne<A.length;Ne++){let ne=A[Ne],Bt=LE(ne,I,D,at,m.allowFullScan);k=k.concat(Bt)}let he=new Set;k=k.filter(Ne=>he.has(Ne)?!1:(he.add(Ne),!0)),V=oe(k)}}(m.offset||m.limit!==void 0)&&(V=V.slice(m.offset,m.limit!==void 0?(m.offset||0)+m.limit:void 0)),I.activeQueries||(I.activeQueries=new Set),m.headers=this[fe]?.headers?.asObject,m.method=this[fe]?.method,I.activeQueries.add(m),V.onDone=()=>{I.activeQueries.delete(m),V.onDone=null,I.done()};let z=this[fe];function oe(k,he){let Ne=he?.length,ne={transaction:I,lazy:Ne>0||U?.length<4,alwaysPrefetch:!0},Bt=m.ensureLoaded!==!1;function $t(li,He){if(Bt&&He!==void 0){let _r=!z.onlyIfCached&&aE(He,li,z,this);if(_r)return _r.then(RH=>$t(RH))}let Ns=li?.value;if(!Ns)return xf.SKIP;for(let _r=0;_r<Ne;_r++)if(!he[_r](Ns))return xf.SKIP;return Ns}return a($t,"processEntry"),k.map(li=>pR(li,z,ne,!1,$t))}return a(oe,"idsToRecords"),V}async subscribe(m){if(!u)throw new Error("Can not subscribe to a table without an audit log");E||et({table:n,database:c,schemaDefined:_,attributes:p,audit:!0}),m||(m={});let R=CB(at,this[Ie]??null,function(I,U,L,V){try{let z=U.getValue?.(i);this.send({id:I,timestamp:L,value:z,version:U.version,type:U.type,beginTxn:V})}catch(z){We.error(z)}},m.startTime,this[ws]);m.crossThreads===!1&&(R.crossThreads=!1),m.supportsTransactions&&(R.supportsTransactions=!0);let D=this[Ie],A=m.previousCount;A>1e3&&(A=1e3);let C=m.startTime;if(this[ws]){if(C){if(A)throw new Qs.ClientError("startTime and previousCount can not be combined for a table level subscription");for(let{key:I,value:U}of u.getRange({start:C,exclusiveStart:!0})){let L=pr(U,i);if(L.tableId!==s)continue;let V=L.recordId;(D==null||HB(D,V))&&R.send({id:V,timestamp:I,...L}),R.startTime=I}}else if(A){let I=[];for(let{key:U,value:L}of u.getRange({start:"z",end:!1,reverse:!0}))try{let V=pr(L);if(V.tableId!==s)continue;let z=V.recordId;if(D==null||HB(D,z)){let oe=V.getValue(i);if(I.push({id:z,timestamp:U,value:oe,version:V.version,type:V.type}),--A<=0)break}}catch(V){We.error("Error getting history entry",U,V)}for(let U=I.length;U>0;)R.send(I[--U]);I[0]&&(R.startTime=I[0].timestamp)}else if(!m.omitCurrent)for(let{key:I,value:U,version:L,localTime:V}of i.getRange({start:D??!1,end:D==null?void 0:[D,$f.MAXIMUM_KEY],versions:!0}))U&&R.send({id:I,version:L,timestamp:V,value:U})}else{A&&!C&&(C=0);let I=this[Ws]?.localTime;if(We.trace("Subscription from",C,"from",D),C<I){let U=[],L=I;do{let V=u.get(L);if(V){m.omitCurrent=!0;let z=pr(V),oe=z.getValue(i);U.push({id:D,value:oe,timestamp:L,...z}),L=z.previousLocalTime}else break;A&&A--}while(L>C&&A!==0);for(let V=U.length;V>0;)R.send(U[--V]);R.startTime=I}!m.omitCurrent&&this.doesExist()&&R.send({id:D,version:this[kf],timestamp:this[Ws]?.localTime,value:this})}return m.listener&&R.on("data",m.listener),R}doesExist(){return!!(this[ge]||this[Xg])}async publish(m,R){this._writePublish(m,R)}_writePublish(m,R){let D=Un(this[fe]),A=this[Ie]||null;Aa(A);let C=this[fe];D.addWrite({key:A,store:i,entry:this[Ws],nodeName:C?.nodeName,validate:()=>{this.validate(m)},before:Pe.publish?.bind(this,C,A,m),beforeIntermediate:At.publish?.bind(this,C,A,m),commit:(I,U,L)=>{U===void 0&&h&&!E&&cE(),S(A,U?.value??null,U,U?.version||I,0,!0,C,U?.expiresAt,"message",!1,m)}})}validate(m){let R,D=a((A,C,I)=>{if(C.type&&A!=null)if(C.properties){typeof A!="object"&&(R||(R=[])).push(`Property ${I} must be an object${C.type?" ("+C.type+")":""}`);let U=C.properties;for(let L=0,V=U.length;L<V;L++){let z=U[L],oe=D(A[z.name],z,I+"."+z.name);oe&&(A[z.name]=oe)}}else switch(C.type){case"Int":(typeof A!="number"||A>>0!==A)&&(R||(R=[])).push(`Property ${I} must be an integer (from -2147483648 to 2147483647)`);break;case"Long":(typeof A!="number"||!(Math.floor(A)===A&&Math.abs(A)<=9007199254740992))&&(R||(R=[])).push(`Property ${I} must be an integer (from -9007199254740992 to 9007199254740992)`);break;case"Float":typeof A!="number"&&(R||(R=[])).push(`Property ${I} must be a number`);break;case"ID":typeof A=="string"||A?.length>0&&A.every?.(U=>typeof U=="string")||(R||(R=[])).push(`Property ${I} must be a string, or an array of strings`);break;case"String":typeof A!="string"&&(R||(R=[])).push(`Property ${I} must be a string`);break;case"Boolean":typeof A!="boolean"&&(R||(R=[])).push(`Property ${I} must be a boolean`);break;case"Date":if(!(A instanceof Date)){if(typeof A=="string"||typeof A=="number")return new Date(A);(R||(R=[])).push(`Property ${I} must be a Date`)}break;case"Bytes":A instanceof Uint8Array||(R||(R=[])).push(`Property ${I} must be a Buffer or Uint8Array`);break;case"array":if(Array.isArray(A)){if(C.elements)for(let U=0,L=A.length;U<L;U++){let V=A[U],z=D(V,C.elements,I+"[*]");z&&(A[U]=z)}}else(R||(R=[])).push(`Property ${I} must be a Buffer or Uint8Array`);break}C.nullable===!1&&A==null&&(R||(R=[])).push(`Property ${I} is required (and not does not allow null values)`)},"validateValue");for(let A=0,C=p.length;A<C;A++){let I=p[A],U=D(m[I.name],I,I.name);U&&(m[I.name]=U)}if(R)throw new Qs.ClientError(R.join(". "))}getUpdatedTime(){return this[kf]}wasLoadedFromSource(){return O?!!this[jg]:void 0}static async addAttributes(m){let R=p.slice(0);for(let D of m){if(!D.name)throw new Qs.ClientError("Attribute name is required");if(D.name.match(/[`/]/))throw new Qs.ClientError("Attribute names cannot include backticks or forward slashes");R.push(D)}return et({table:n,database:c,schemaDefined:_,attributes:R}),at.indexingOperation}static async removeAttributes(m){let R=p.filter(D=>!m.includes(D.name));return et({table:n,database:c,schemaDefined:_,attributes:R}),at.indexingOperation}static getRecordCount(m){let R=i.getStats().entryCount,D=5e3,A=1e3,C;R>D&&!m?.exactCount&&(C=A);let I=0;for(let{value:U}of i.getRange({start:!0,lazy:!0,limit:C}))U!=null&&I++;if(C){let U=I;I=0;for(let{value:Bt}of i.getRange({start:"\uFFFF",reverse:!0,lazy:!0,limit:C}))Bt!=null&&I++;let L=C*2,V=(I+U)/L,z=Math.pow((I-U+1)/C/2,2)+V*(1-V)/L,oe=Math.max(Math.sqrt(z)*R,1),k=Math.round(V*R),he=Math.max(k-1.96*oe,0),Ne=Math.min(k+1.96*oe,R),ne=Math.pow(10,Math.round(Math.log10(oe)));return ne>k&&(ne=ne/10),I=Math.round(k/ne)*ne,{recordCount:I,estimatedRange:[Math.round(he),Math.round(Ne)]}}return{recordCount:I}}static updatedAttributes(){_l(this,this)}static async deleteHistory(m=0){let R;for(let{key:D,value:A}of u.getRange({start:0,end:m}))await vu(),pr(A).tableId===s&&(R=u.remove(D));await R}static async*getHistory(m=0,R=1/0){for(let{key:D,value:A}of u.getRange({start:m,end:R})){await vu();let C=pr(A);C.tableId===s&&(yield{id:C.recordId,localTime:D,version:C.version,type:C.type,value:C.getValue(i),user:C.user})}}static async getHistoryOfRecord(m){let R=[],D=i.getEntry(m);if(!D)return R;let A=D.localTime,C=0;do{await vu();let I=u.get(A);if(I){let U=pr(I);R.push({id:U.recordId,localTime:A,version:U.version,type:U.type,value:U.getValue(i),user:U.user}),A=U.previousLocalTime}else break}while(C<1e3&&A);return R.reverse()}static cleanup(){x?.remove()}}at.updatedAttributes();let TH=at.prototype;return TH[PB]=!0,d&&at.setTTLExpiration(d/1e3),B&&gH(),at;function zu(W,m,R){let D;for(let A in r){let C=r[A],I=C.isIndexing,U=R?.[A],L=m?.[A];if(U===L&&!I)continue;D=!0;let V=(0,qu.getIndexedValues)(L);if(V){MB&&C.prefetch(V.map(z=>({key:z,value:W})),BB);for(let z=0,oe=V.length;z<oe;z++)C.remove(V[z],W)}if(V=(0,qu.getIndexedValues)(U),V){MB&&C.prefetch(V.map(z=>({key:z,value:W})),BB);for(let z=0,oe=V.length;z<oe;z++)C.put(V[z],W)}}return D}a(zu,"updateIndices");function Aa(W){switch(typeof W){case"number":return!0;case"string":if(W.length<659)return!0;if(W.length>vB)throw new Error("Primary key size is too large: "+W.length);break;case"object":if(W===null)return!0;break;default:throw new Error("Invalid primary key type: "+typeof W)}if((0,$f.writeKey)(W,lre,0)>vB)throw new Error("Primary key size is too large: "+W.length);return!0}a(Aa,"checkValidId");function pR(W,m,R,D,A){let C=a(()=>{if(m?.transaction?.stale&&(m.transaction.stale=!1),R.transaction?.isDone)return A(null,W);let I=i.getEntry(W,R);return I&&m&&(I?.version>(m.lastModified||0)&&(m.lastModified=I.version),I?.localTime&&!m.lastRefreshed&&(m.lastRefreshed=I.localTime)),A(I,W)},"whenPrefetched");return D?C():se>0?(se--,C()):new Promise((I,U)=>{se===0?(se--,i.prefetch([W],()=>{L(),V()})):(te.push(W),be.push(V),te.length>SH&&(se--,L()));function L(){if(te.length>0){let z=be;i.prefetch(te,()=>{se===-1?L():se++;for(let oe of z)oe()}),te=[],be=[],vt>2&&vt--}else se=vt,vt<pH&&vt++}a(L,"prefetch");function V(){try{I(C())}catch(z){U(z)}}a(V,"load")})}a(pR,"loadLocalRecord");function aE(W,m,R,D){if(O){let A;if(R.noCache?A=!0:(m?(!m.value||m.metadataFlags&(Ff|Gf)||m.expiresAt&&m.expiresAt<Date.now())&&(A=!0):A=!0,kr(!A,"cache-hit",n)),A){let C=SR(W,m,R).then(I=>(I?.value?.[ge]&&We.error("Can not assign a record with a record property"),R&&(I?.version>(R.lastModified||0)&&(R.lastModified=I.version),R.lastRefreshed=Date.now()),I));if(R?.onlyIfCached||m?.value&&D?.allowStaleWhileRevalidate?.(m,W)){if(C.catch(I=>We.warn(I)),R?.onlyIfCached&&!D.doesExist())throw new Qs.ServerError("Entry is not cached",504);return}else return C}}}a(aE,"ensureLoadedFromSource");function Un(W){let m=W?.transaction;if(m){if(!m.open)throw new Error("Can not use a transaction that is not open");if(!m.lmdbDb)return m.lmdbDb=i,m;do{if(m.lmdbDb?.path===i.path)return m;let R=m.next;if(!R)return m=m.next=new fi,m.lmdbDb=i,m;m=R}while(!0)}else return new El}a(Un,"txnForContext");async function SR(W,m,R){let D=m?.metadataFlags,A=m?.version,C,I;if(!i.attemptLock(W,A,()=>{clearTimeout(I);let z=i.getEntry(W);!z||!z.value||z.metadataFlags&(Ff|Gf)?C(SR(W,i.getEntry(W),R)):C(z)}))return new Promise(z=>{C=z,I=setTimeout(()=>{i.unlock(W,A)},ure)});let U=m?.value,L={requestContext:R,replacingRecord:U,replacingVersion:A,source:null,resourceCache:R?.resourceCache},V=R?.responseHeaders;return new Promise((z,oe)=>{let k;eR(Ge(L,async he=>{let Ne=performance.now(),ne,Bt,$t;try{for(let _r of at.sources)if(_r.get&&(!_r.get.reliesOnPrototype||_r.prototype.get)&&(L.source=_r,ne=await _r.get(W,L),ne))break;$t=D&Ff;let He=L.lastModified||$t&&A;Bt=$t||He>A||!U,He||(He=(0,qu.getNextMonotonicTime)());let Ns=performance.now()-Ne;if(br(Ns,"cache-resolution",n),V&&V.append("Server-Timing",`cache-resolve;dur=${Ns.toFixed(2)}`),he.timestamp=He,d&&!L.expiresAt&&(L.expiresAt=Date.now()+d),ne){if(typeof ne!="object")throw new Error("Only objects can be cached and stored in tables");typeof ne.toJSON=="function"&&(ne=ne.toJSON()),t&&ne[t]!==W&&(ne[t]=W)}k=!0,z({version:He,value:ne})}catch(He){He.message+=` while resolving record ${W} for ${n}`,U&&((He.code==="ECONNRESET"||He.code==="ECONNREFUSED"||He.code==="EAI_AGAIN")&&!R?.mustRevalidate||R?.staleIfError&&(He.statusCode===500||He.statusCode===502||He.statusCode===503||He.statusCode===504))?(z({version:A,value:U}),We.trace(He.message,"(returned stale record)")):oe(He),L.transaction.abort();return}if(R?.noCacheStore){L.transaction.abort();return}Un(L).addWrite({key:W,store:i,entry:m,nodeName:"source",commit:(He,Ns)=>{if(Ns?.version!==A)return;let _r=zu(W,U,ne);ne?(At.put?.(L,W,ne),S(W,ne,Ns,He,0,E&&Bt||null,L,L.expiresAt,"put",!!$t)):(At.delete?.(L,W),E||h?S(W,null,Ns,He,0,E&&Bt||null,L,0,"delete",!!$t):i.remove(W,A))}})}),()=>{i.unlock(W,A)},he=>{i.unlock(W,A),k&&We.error("Error committing cache update",he)})})}a(SR,"getFromSource");function cE(){if(es!==mR&&(mR=es,(0,ji.getWorkerIndex)()===(0,ji.getWorkerCount)()-1)){if(Qu&&clearTimeout(Qu),!es)return;let W=new Date;W.setMonth(0),W.setDate(1),W.setHours(0),W.setMinutes(0),W.setSeconds(0);let m=Math.ceil((Date.now()-W.getTime())/es)*es+W.getTime(),R=a(D=>{We.trace(`Scheduled next cleanup scan at ${new Date(D)}ms`),Qu=setTimeout(()=>F=F.then(async()=>{if(R(Math.max(D+es,Date.now())),i.rootStore.status!=="open"){clearTimeout(Qu);return}We.trace(`Starting cleanup scan for ${n}`);try{let A=0;for(let{key:C,value:I,version:U,expiresAt:L}of i.getRange({start:!1,snapshot:!1,versions:!0,lazy:!0}))I===null&&!E&&U+cre<Date.now()?i.remove(C,U):L&&L+f<Date.now()&&(at.evict(C,I,U),A++),await vu();We.trace(`Finished cleanup scan for ${n}, evicted ${A} entries`)}catch(A){We.trace(`Error in cleanup scan for ${n}:`,A)}}),Math.min(D-Date.now(),2147483647)).unref()},"startNextTimer");R(m)}}a(cE,"scheduleCleanup");function TR(){x=u?.addDeleteRemovalCallback(s,W=>{let m=i.getEntry(W);m?.value===null&&i.remove(W,m.version)})}a(TR,"addDeleteRemoval");function gH(){(0,ji.getWorkerIndex)()===0&&setInterval(async()=>{try{let W=B.name,m=r[W];if(!m)throw new Error(`expiresAt attribute ${B} must be indexed`);for(let{value:R}of m.getRange({start:!0,end:Date.now(),versions:!0,snapshot:!1})){let D=i.getEntry(R);D?.value?.[W]<Date.now()&&at.evict(R,D.value,D.version),await vu()}}catch(W){We.error("Error in evicting old records",W)}},are).unref()}a(gH,"runRecordExpirationEviction")}function Zg(e,t){let r=e.attr_object||(e.attr_object={}),s=r[t];if(s)return s;s=r[t]=Object.create(null);for(let n of e)s[n.attribute_name]=n[t];return s}function BB(){}function _re(e){FB=e}function Vf(e,t){let r=t?.type;return e===null?e:r==="Int"||r==="Long"?parseInt(e):r==="Float"?parseFloat(e):r==="Date"?(typeof e!="number"&&!dre.test(e)&&(e+="Z"),new Date(e)):r?e:(0,Yf.autoCast)(e)}function HB(e,t){if(e==null)return!0;if(!Array.isArray(t))return e===t;if(Array.isArray(e)){let r=e.length;if(e[r-1]===null&&r--,t.length>=r){for(let s=0;s<r;s++)if(t[s]!==e[s])return!1;return!0}return!1}else if(t[0]===e)return!0}function eR(e,t,r){return e?.then?e.then(t,r):t(e)}function Hu(e,t){e[Ws]=t,e[ge]=t?.value??null,e[kf]=t?.version}var As,xf,qu,qB,Bu,xu,Qs,Fu,Gu,We,$f,ji,Yf,nre,FB,ire,ore,are,cre,MB,ure,kf,PB,Ws,Xg,jg,Pu,Ff,Gf,lre,vB,MEe,dre,vu,uf=Te(()=>{As=M(y()),xf=require("lmdb"),qu=M(Er()),qB=require("lodash");ns();IE();Bu=M(ze()),xu=M(X());UB();Qs=M(j()),Fu=M(an()),Gu=M(ls());Ee();ml();We=M(G());fl();Ei();$f=require("ordered-binary"),ji=M(Je());ao();Yf=M($());Va();ln();nre=new Uint8Array(9);nre[8]=192;ire=1e8,ore=1e7,are=6e4,cre=864e5;xu.initSync();MB=xu.get(As.CONFIG_PARAMS.STORAGE_PREFETCHWRITES),ure=1e4,kf=Symbol.for("version"),PB=Symbol.for("incremental-update"),Ws=Symbol("entry"),Xg=Symbol("is-saving"),jg=Symbol("loaded-from-source"),Pu={isNotification:!0,ensureLoaded:!1},Ff=1,Gf=8,lre=Buffer.allocUnsafeSlow(8192),vB=1978,MEe=(0,Yf.convertToMS)(xu.get(As.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_STREAMS_MAXAGE))||864e5;a(Kf,"makeTable");a(Zg,"attributesAsObject");a(BB,"noop");a(_re,"setServerUtilities");dre=/[+-][0-9]{2}:[0-9]{2}|[a-zA-Z]$/;a(Vf,"coerceType");a(HB,"isDescendantId");vu=a(()=>new Promise(setImmediate),"rest");a(eR,"when");a(Hu,"updateResource")});var Ce={};qe(Ce,{database:()=>Tc,databases:()=>xe,dropDatabase:()=>np,dropTableMeta:()=>Sre,getDatabases:()=>ds,getTables:()=>fre,onUpdatedTable:()=>Og,readMetaDb:()=>ku,resetDatabases:()=>Ere,table:()=>et,tables:()=>mr});function fre(){return Xf||ds(),mr||{}}function ds(){if(Xf)return xe;Xf=!0,ga=new Map;let e=(0,Vt.getHdbBasePath)()&&(0,Fe.join)((0,Vt.getHdbBasePath)(),Dr.DATABASES_DIR_NAME),t=(0,Vt.get)(Dr.CONFIG_PARAMS.DATABASES)||{};if(process.env.SCHEMAS_DATA_PATH&&(t.data={path:process.env.SCHEMAS_DATA_PATH}),e=process.env.STORAGE_PATH||(0,Vt.get)(Dr.CONFIG_PARAMS.STORAGE_PATH)||e&&((0,Lr.existsSync)(e)?e:(0,Fe.join)((0,Vt.getHdbBasePath)(),Dr.LEGACY_DATABASES_DIR_NAME)),!!e){if((0,Lr.existsSync)(e))for(let r of(0,Lr.readdirSync)(e,{withFileTypes:!0})){let s=(0,Fe.basename)(r.name,".mdb");r.isFile()&&(0,Fe.extname)(r.name).toLowerCase()===".mdb"&&!t[s]?.path&&ku((0,Fe.join)(e,r.name),null,s)}if((0,Lr.existsSync)((0,Ta.getBaseSchemaPath)())){for(let r of(0,Lr.readdirSync)((0,Ta.getBaseSchemaPath)(),{withFileTypes:!0}))if(!r.isFile()){let s=(0,Fe.join)((0,Ta.getBaseSchemaPath)(),r.name),n=(0,Fe.join)((0,Ta.getTransactionAuditStoreBasePath)(),r.name);for(let i of(0,Lr.readdirSync)(s,{withFileTypes:!0}))if(i.isFile()&&(0,Fe.extname)(i.name).toLowerCase()===".mdb"){let o=(0,Fe.join)(n,i.name);ku((0,Fe.join)(s,i.name),(0,Fe.basename)(i.name,".mdb"),r.name,o,!0)}}}if(t)for(let r in t){let s=t[r],n=s.path;if((0,Lr.existsSync)(n))for(let o of(0,Lr.readdirSync)(n,{withFileTypes:!0}))o.isFile()&&(0,Fe.extname)(o.name).toLowerCase()===".mdb"&&ku((0,Fe.join)(n,o.name),(0,Fe.basename)(o.name,".mdb"),r);let i=s.tables;if(i)for(let o in i){let c=i[o],u=(0,Fe.join)(c.path,(0,Fe.basename)(o+".mdb"));(0,Lr.existsSync)(u)&&ku(u,o,r,null,!0)}}for(let r in xe){let s=ga.get(r);if(s){let n=xe[r];r.includes("delete")&&Zr.trace(`defined tables ${Array.from(s.keys())}`);for(let i in n)s.has(i)||(Zr.trace(`delete table class ${i}`),delete n[i])}else if(delete xe[r],r==="data"){for(let n in mr)delete mr[n];delete mr[jf]}}return ga=null,xe}}function Ere(){Xf=!1;for(let[,e]of ci)e.needsDeletion=!0;ds();for(let[e,t]of ci)t.needsDeletion&&!e.endsWith("system.mdb")&&(t.close(),ci.delete(e));return xe}function ku(e,t,r=sR,s,n){let i=new tR.default(e,!1);try{let o=ci.get(e);o?o.needsDeletion=!1:(o=(0,Qf.open)(i),ci.set(e,o));let c=new Zi.default(!1),u=o.dbisDb||(o.dbisDb=o.openDB(Wf.INTERNAL_DBIS_NAME,c)),_=o.auditStore;_||(s?(0,Lr.existsSync)(s)&&(i.path=s,_=(0,Qf.open)(i),_.isLegacy=!0):_=Al(o));let l=VB(r),d=l[jf],f=new Map;for(let{key:E,value:h}of u.getRange({start:!1})){let[p,S]=E.toString().split("/");S===""?S=h.name:S||(S=p,p=t,h.name||(h.name=S,h.indexed=!h.is_hash_attribute)),d?.add(p);let g=f.get(p);g||f.set(p,g={attributes:[]}),(S==null||h.is_hash_attribute)&&(g.primary=h),S!=null&&g.attributes.push(h),Object.defineProperty(h,"key",{value:E,configurable:!0})}for(let[E,h]of f){let{attributes:p,primary:S}=h;if(!S){for(let x of p)if(x.is_hash_attribute||x.isPrimaryKey){S=x;break}if(!S){Zr.fatal(`Unable to find a primary key attribute on table ${E}, with attributes: ${JSON.stringify(p)}`);continue}}let g=l[E],b={},O=[],Y,Q,F=typeof S.audit=="boolean"?S.audit:(0,Vt.get)(Dr.CONFIG_PARAMS.LOGGING_AUDITLOG),w=S.trackDeletes,K=S.expiration,B=S.eviction;if(g)b=g.indices,O=g.attributes,g.schemaVersion++;else{Y=S.tableId,Y?Y>=(u.get(Sa)||0)&&u.putSync(Sa,Y+1):(S.tableId=Y=u.get(Sa),Y||(Y=1),u.putSync(Sa,Y+1),u.putSync(S.key,S));let x=new Zi.default(!S.is_hash_attribute,S.is_hash_attribute);Q=Il(o.openDB(S.key,x)),Q.rootStore=o,Q.tableId=Y}for(let x of p){x.attribute=x.name;try{if(!x.is_hash_attribute&&(x.indexed||x.attribute&&!x.name)){if(!b[x.name]){let be=new Zi.default(!x.is_hash_attribute,x.is_hash_attribute);b[x.name]=o.openDB(x.key,be)}let te=O.find(be=>be.name===x.name);te?O.splice(O.indexOf(te),1,x):O.push(x)}}catch(te){Zr.error("Error trying to update attribute",x,O,b,te)}}if(!g){g=$B(l,E,Kf({primaryStore:Q,auditStore:_,audit:F,expirationMS:K&&K*1e3,evictionMS:B&&B*1e3,trackDeletes:w,tableName:E,tableId:Y,primaryKey:S.name,databasePath:n?r+"/"+E:r,databaseName:r,indices:b,attributes:p,schemaDefined:S.schemaDefined,dbisDB:u})),g.schemaVersion=1;for(let x of nR)x(g)}}return o}catch(o){throw o.message+=` opening database ${e}`,o}}function VB(e){let t=xe[e];if(t||(e==="data"?t=xe[e]=mr:e==="system"?Object.defineProperty(xe,"system",{value:t=Object.create(null),configurable:!0}):t=xe[e]=Object.create(null)),ga&&!ga.has(e)){let r=new Set;t[jf]=r,ga.set(e,r)}return t}function $B(e,t,r){return e[t]=r,r}function Tc({database:e,table:t}){e||(e=sR),ds();let r=VB(e),s=(0,Fe.join)((0,Vt.getHdbBasePath)(),Dr.DATABASES_DIR_NAME),n=(0,Vt.get)(Dr.CONFIG_PARAMS.DATABASES)||{};process.env.SCHEMAS_DATA_PATH&&(n.data={path:process.env.SCHEMAS_DATA_PATH});let i=t&&n[e]?.tables?.[t]?.path;s=i||n[e]?.path||process.env.STORAGE_PATH||(0,Vt.get)(Dr.CONFIG_PARAMS.STORAGE_PATH)||((0,Lr.existsSync)(s)?s:(0,Fe.join)((0,Vt.getHdbBasePath)(),Dr.LEGACY_DATABASES_DIR_NAME));let o=(0,Fe.join)(s,(i?t:e)+".mdb"),c=ci.get(o);if(!c){let u=new tR.default(o,!1);c=(0,Qf.open)(u),ci.set(o,c)}return c}async function np(e){if(!xe[e])throw new Error("Schema does not exist");let t=xe[e];for(let r in t){let n=t[r].primaryStore.rootStore;ci.delete(n.path),n.status==="open"&&(await n.close(),await GB.remove(n.path))}if(e==="data"){for(let r in mr)delete mr[r];delete mr[jf]}delete xe[e]}function et({table:e,database:t,expiration:r,eviction:s,scanInterval:n,attributes:i,audit:o,trackDeletes:c,schemaDefined:u,origin:_}){t||(t=sR);let l=Tc({database:t,table:e}),d=xe[t],f=d?.[e];if(l.status==="closed")throw new Error(`Can not use a closed data store for ${e}`);let E,h,p,S;u==null&&(u=!0);let g=new Zi.default(!1);for(let w of i)w.attribute?(w.name=w.attribute,w.indexed=!0):w.attribute=w.name,w.expiresAt&&(w.indexed=!0);let b,O;if(f){if(E=f.primaryKey,f.primaryStore.rootStore.status==="closed")throw new Error(`Can not use a closed data store from ${e} class`);f.attributes.splice(0,f.attributes.length,...i)}else{let w=l.auditStore;w||(w=Al(l)),h=i.find(te=>te.isPrimaryKey)||{},E=h.name,h.is_hash_attribute=!0,h.schemaDefined=u,c&&(h.trackDeletes=!0),o=h.audit=typeof o=="boolean"?o:(0,Vt.get)(Dr.CONFIG_PARAMS.LOGGING_AUDITLOG),r&&(h.expiration=r),s&&(h.eviction=s),_&&(h.origins?h.origins.includes(_)||h.origins.push(_):h.origins=[_]),Zr.trace(`${e} table loading, opening primary store`);let K=new Zi.default(!1,!0),B=e+"/",x=Il(l.openDB(B,K));x.rootStore=l,S=l.dbisDb=l.openDB(Wf.INTERNAL_DBIS_NAME,g),x.tableId=S.get(Sa),x.tableId||(x.tableId=1),S.putSync(Sa,x.tableId+1),h.tableId=x.tableId,f=$B(d,e,Kf({primaryStore:x,auditStore:w,audit:o,trackDeletes:c,expirationMS:r&&r*1e3,evictionMS:s&&s*1e3,primaryKey:E,tableName:e,tableId:x.tableId,databasePath:t,databaseName:t,indices:{},attributes:i,schemaDefined:u,dbisDB:S})),f.schemaVersion=1,b=!0,F(),S.put(B,h)}p=f.indices,S=S||(l.dbisDb=l.openDB(Wf.INTERNAL_DBIS_NAME,g)),f.dbisDB=S;let Y=[];for(let{key:w,value:K}of S.getRange({start:!0})){let[B,x]=w.toString().split("/");if(x===""&&(x=K.name),x){if(B!==e)continue}else x=B;if(!i.find(be=>be.name===x)?.indexed&&K.indexed&&!K.isPrimaryKey){F(),b=!0,S.remove(w);let be=f.indices[B];be&&Y.push(be)}}let Q=[];try{for(let w of i||[]){let K=e+"/"+(w.name||"");Object.defineProperty(w,"key",{value:K,configurable:!0});let B=S.get(K);if(w.isPrimaryKey){if(B=B||S.get(K=e+"/")||{},o!==f.audit||(+r||void 0)!==(+B.expiration||void 0)||(+s||void 0)!==(+B.eviction||void 0)){let te=Object.assign({},B);typeof o=="boolean"&&(o&&f.enableAuditing(o),te.audit=o),r&&(te.expiration=+r),s&&(te.eviction=+s),b=!0,F(),S.put(K,te)}continue}B?.attribute&&!B.name&&(B.indexed=!0);let x=!B||B.type!==w.type||B.indexed!==w.indexed||JSON.stringify(B.attributes)!==JSON.stringify(w.attributes)||JSON.stringify(B.elements)!==JSON.stringify(w.elements);if(w.indexed){let te=new Zi.default(!0,!1),be=l.openDB(K,te);(x||B.indexingPID&&B.indexingPID!==process.pid||B.restartNumber<Vu.workerData?.restartNumber)&&(b=!0,F(),B=S.get(K),(x||B.indexingPID&&B.indexingPID!==process.pid||B.restartNumber<Vu.workerData?.restartNumber)&&(b=!0,w.lastIndexedKey=B?.lastIndexedKey||!1,w.indexingPID=process.pid,be.isIndexing=!0,Object.defineProperty(w,"dbi",{value:be}),Q.push(w)),S.put(K,w)),p[w.name]=be}else x&&(b=!0,F(),S.put(K,w))}}finally{O&&O()}if(b&&(f.schemaVersion++,f.updatedAttributes()),Zr.trace(`${e} table loading, running index`),Q.length>0||Y.length>0?f.indexingOperation=pre(f,Q,Y):b&&zf.signalSchemaChange(new Jf.SchemaEventMsg(process.pid,"schema-change",f.databaseName,f.tableName)),f.origin=_,b)for(let w of nR)w(f,_!=="cluster");return(r||s||n)&&f.setTTLExpiration({expiration:r,eviction:s,scanInterval:n}),Zr.trace(`${e} table loaded`),f;function F(){O||l.transactionSync(()=>({then(w){O=w}}))}a(F,"startTxn")}async function pre(e,t,r){try{let s=e.schemaVersion;await zf.signalSchemaChange(new Jf.SchemaEventMsg(process.pid,"schema-change",e.databaseName,e.tableName));let n;for(let u of r)n=u.drop();let i,o=0,c=t.length;if(await new Promise(u=>setImmediate(u)),c>0){let u=0;for(let{key:_,value:l,version:d}of e.primaryStore.getRange({start:t[0].lastIndexedKey,lazy:c<4,versions:!0,snapshot:!1}))if(l){if(u++,n=e.primaryStore.ifVersion(_,d,()=>{for(let f=0;f<c;f++){let E=t[f],h=E.name,p=(0,xB.getIndexedValues)(l[h]);if(p)for(let S=0,g=p.length;S<g;S++)E.dbi.put(p[S],_)}}),n.then(()=>u--,f=>{u--,Zr.error(f)}),Vu.workerData&&Vu.workerData.restartNumber!==kB.restartNumber&&(i=!0),++o%100===0||i){for(let f of t)f.lastIndexedKey=_,e.dbisDB.put(f.key,f);if(i)return}u>hre?await n:u>mre&&await new Promise(f=>setImmediate(f))}for(let _ of t)delete _.lastIndexedKey,delete _.indexingPID,_.dbi.isIndexing=!1,n=e.dbisDB.put(_.key,_)}await n,await zf.signalSchemaChange(new Jf.SchemaEventMsg(process.pid,"indexing-finished",e.databaseName,e.tableName))}catch(s){Zr.error("Error in indexing",s)}}function Sre({table:e,database:t}){let r=Tc({database:t,table:e}),s=[],n=r.dbisDb;for(let i of n.getKeys({start:e+"/",end:e+"0"}))s.push(n.remove(i));return Promise.all(s)}function Og(e){nR.push(e)}var Vt,Wf,Qf,Fe,Lr,Ta,Zi,tR,Dr,GB,rR,xB,zf,Jf,Vu,Zr,kB,sR,jf,mr,xe,Sa,nR,Xf,ci,ga,hre,mre,Ee=Te(()=>{Vt=M(X()),Wf=M(ze()),Qf=require("lmdb"),Fe=require("path"),Lr=require("fs"),Ta=M(ve());uf();Zi=M(wl()),tR=M(Ll()),Dr=M(y()),GB=M(require("fs-extra")),rR=require("../../index"),xB=M(Er()),zf=M(an()),Jf=M(ls()),Vu=require("worker_threads"),Zr=M(G()),kB=M(Je());ao();Va();sR="data",jf=Symbol("defined-tables");(0,Vt.initSync)();mr=Object.create(null),xe=Object.create(null);(0,rR._assignPackageExport)("databases",xe);(0,rR._assignPackageExport)("tables",mr);Sa=Symbol.for("next-table-id"),nR=[],ci=new Map;a(fre,"getTables");a(ds,"getDatabases");a(Ere,"resetDatabases");a(ku,"readMetaDb");a(VB,"ensureDB");a($B,"setTable");a(Tc,"database");a(np,"dropDatabase");a(et,"table");hre=1e3,mre=10;a(pre,"runIndexing");a(Sre,"dropTableMeta");a(Og,"onUpdatedTable")});var $=T((kEe,nH)=>{"use strict";var ui=require("path"),zB=require("fs-extra"),lr=G(),YB=require("fs-extra"),Zf=require("os"),Tre=require("net"),gre=require("recursive-iterator"),Qe=y(),Rre=jR(),KB=require("papaparse"),eE=require("moment"),{inspect:Are}=require("util"),WB=require("is-number"),xEe=require("lodash"),Ore=require("minimist"),Nre=require("https"),bre=require("http"),{hdb_errors:tE}=j(),yre=/^((\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)))$/,JB=require("util").promisify(setTimeout),Ire=100,wre=5,Cre="",Lre=4,QB={true:!0,TRUE:!0,FALSE:!1,false:!1,undefined:null,null:null,NULL:null,NaN:NaN};nH.exports={isEmpty:Ur,isEmptyOrZeroLength:zs,arrayHasEmptyValues:Mre,arrayHasEmptyOrZeroLengthValues:Pre,buildFolderPath:vre,isBoolean:XB,errorizeMessage:Dre,stripFileExtension:Hre,autoCast:qre,autoCastJSON:jB,autoCastJSONDeep:oR,removeDir:Fre,compareVersions:Gre,isCompatibleDataVersion:xre,escapeRawValue:kre,unescapeValue:Vre,stringifyProps:$re,timeoutPromise:Kre,isClusterOperation:Qre,getClusterUser:Jre,checkGlobalSchemaTable:zre,getHomeDir:eH,getPropsFilePath:Yre,promisifyPapaParse:Xre,removeBOM:tH,createEventPromise:jre,checkProcessRunning:Zre,checkSchemaTableExist:ese,checkSchemaExists:rH,checkTableExists:sH,getStartOfTomorrowInSeconds:tse,getLimitKey:rse,isObject:Bre,isNotEmptyAndHasValue:Ure,autoCasterIsNumberCheck:ZB,backtickASTSchemaItems:sse,isPortTaken:Wre,createForkArgs:nse,autoCastBoolean:ise,async_set_timeout:JB,getTableHashAttribute:ose,doesSchemaExist:ase,doesTableExist:cse,stringifyObj:use,ms_to_time:lse,changeExtension:_se,getEnvCliRootPath:aR,noBootFile:dse,httpRequest:fse,transformReq:Ese,convertToMS:hse,PACKAGE_ROOT:Qe.PACKAGE_ROOT};function Dre(e){return e instanceof Error?e:new Error(e)}a(Dre,"errorizeMessage");function Ur(e){return e==null}a(Ur,"isEmpty");function Ure(e){return!Ur(e)&&(e||e===0||e===""||XB(e))}a(Ure,"isNotEmptyAndHasValue");function zs(e){return Ur(e)||e.length===0||e.size===0}a(zs,"isEmptyOrZeroLength");function Mre(e){if(Ur(e))return!0;for(let t=0;t<e.length;t++)if(Ur(e[t]))return!0;return!1}a(Mre,"arrayHasEmptyValues");function Pre(e){if(zs(e))return!0;for(let t=0;t<e.length;t++)if(zs(e[t]))return!0;return!1}a(Pre,"arrayHasEmptyOrZeroLengthValues");function vre(...e){try{return e.join(ui.sep)}catch{console.error(e)}}a(vre,"buildFolderPath");function XB(e){return Ur(e)?!1:e===!0||e===!1}a(XB,"isBoolean");function Bre(e){return Ur(e)?!1:typeof e=="object"}a(Bre,"isObject");function Hre(e){return zs(e)?Cre:e.slice(0,-Lre)}a(Hre,"stripFileExtension");function qre(e){return Ur(e)||e===""||typeof e!="string"?e:QB[e]!==void 0?QB[e]:ZB(e)===!0?Number(e):yre.test(e)?new Date(e):e}a(qre,"autoCast");function jB(e){if(typeof e=="string"&&(e.startsWith("{")&&e.endsWith("}")||e.startsWith("[")&&e.endsWith("]")))try{return JSON.parse(e)}catch{}return e}a(jB,"autoCastJSON");function oR(e){if(e&&typeof e=="object"){if(Array.isArray(e))for(let t=0,r=e.length;t<r;t++){let s=e[t],n=oR(s);n!==s&&(e[t]=n)}else for(let t in e){let r=e[t],s=oR(r);s!==r&&(e[t]=s)}return e}else return jB(e)}a(oR,"autoCastJSONDeep");function ZB(e){if(e.startsWith("0.")&&WB(e))return!0;let t=e.toUpperCase().includes("E");return!!((e!=="0"&&e.startsWith("0"))===!1&&t===!1&&WB(e))}a(ZB,"autoCasterIsNumberCheck");async function Fre(e){if(zs(e))throw new Error(`Directory path: ${e} does not exist`);try{await YB.emptyDir(e),await YB.remove(e)}catch(t){throw lr.error(`Error removing files in ${e} -- ${t}`),t}}a(Fre,"removeDir");function Gre(e,t){if(zs(e)){lr.info("Invalid current version sent as parameter.");return}if(zs(t)){lr.info("Invalid upgrade version sent as parameter.");return}let r,s=/(\.0+)+$/,n=e.version?e.version:e,i=t.version?t.version:t,o=n.replace(s,"").split("."),c=i.replace(s,"").split("."),u=Math.min(o.length,c.length);for(let _=0;_<u;_++)if(r=parseInt(o[_],10)-parseInt(c[_],10),r)return r;return o.length-c.length}a(Gre,"compareVersions");function xre(e,t,r=!1){let s=e.toString().split("."),n=t.toString().split(".");return s[0]===n[0]&&(!r||s[1]===n[1])}a(xre,"isCompatibleDataVersion");function kre(e){if(Ur(e))return e;let t=String(e);return t==="."?Qe.UNICODE_PERIOD:t===".."?Qe.UNICODE_PERIOD+Qe.UNICODE_PERIOD:t.replace(Qe.FORWARD_SLASH_REGEX,Qe.UNICODE_FORWARD_SLASH)}a(kre,"escapeRawValue");function Vre(e){if(Ur(e))return e;let t=String(e);return t===Qe.UNICODE_PERIOD?".":t===Qe.UNICODE_PERIOD+Qe.UNICODE_PERIOD?"..":String(e).replace(Qe.ESCAPED_FORWARD_SLASH_REGEX,"/")}a(Vre,"unescapeValue");function $re(e,t){if(Ur(e))return lr.info("Properties object is null"),"";let r="";return e.each(function(s,n){try{if(t&&t[s]){let i=t[s];for(let o of i)r+=";"+o+Zf.EOL}!zs(s)&&s[0]===";"?r+="	"+s+n+Zf.EOL:zs(s)||(r+=s+"="+n+Zf.EOL)}catch{lr.error(`Found bad property during upgrade with key ${s} and value: ${n}`)}}),r}a($re,"stringifyProps");function eH(){let e;try{e=Zf.homedir()}catch{e=process.env.HOME}return e||(e="~/"),e}a(eH,"getHomeDir");function Yre(){let e=ui.join(eH(),Qe.HDB_HOME_DIR_NAME,Qe.BOOT_PROPS_FILE_NAME);return zB.existsSync(e)||(e=ui.join(__dirname,"../","hdb_boot_properties.file")),e}a(Yre,"getPropsFilePath");function Kre(e,t){let r,s;return s=new Promise(function(n){r=setTimeout(function(){n(t)},e)}),{promise:s,cancel:function(){clearTimeout(r)}}}a(Kre,"timeoutPromise");async function Wre(e){if(!e)throw new Error("Invalid port passed as parameter");return new Promise((t,r)=>{let s=Tre.createServer().once("error",n=>{n.code==="EADDRINUSE"?t(!0):r(n)}).once("listening",()=>s.once("close",()=>t(!1)).close()).listen(e)})}a(Wre,"isPortTaken");function Qre(e){try{return Qe.CLUSTER_OPERATIONS[e.toLowerCase()]!==void 0}catch(t){lr.error(`Error checking operation against cluster ops ${t}`)}return!1}a(Qre,"isClusterOperation");function zre(e,t){let r=(Ee(),Z(Ce)).getDatabases();if(!r[e])return tE.HDB_ERROR_MSGS.SCHEMA_NOT_FOUND(e);if(!r[e][t])return tE.HDB_ERROR_MSGS.TABLE_NOT_FOUND(e,t)}a(zre,"checkGlobalSchemaTable");function Jre(e,t){if(Ur(t)){lr.warn("No CLUSTERING_USER defined, clustering disabled");return}if(Ur(e)||zs(e)){lr.warn("No users to search.");return}let r;try{let s=e.get(t);s&&s.role.permission.cluster_user===!0&&s.active===!0&&(r=s)}catch(s){lr.error(`unable to find cluster_user due to: ${s.message}`);return}if(r===void 0){lr.warn(`CLUSTERING_USER: ${t} not found or is not active.`);return}return r}a(Jre,"getClusterUser");function Xre(){KB.parsePromise=function(e,t,r){return new Promise(function(s,n){KB.parse(e,{header:!0,transformHeader:tH,chunk:t.bind(null,n),skipEmptyLines:!0,transform:r,dynamicTyping:!1,error:n,complete:s})})}}a(Xre,"promisifyPapaParse");function tH(e){if(typeof e!="string")throw new TypeError(`Expected a string, got ${typeof e}`);return e.charCodeAt(0)===65279?e.slice(1):e}a(tH,"removeBOM");function jre(e,t,r){return new Promise(s=>{t.once(e,n=>{let i=r;lr.info(`Got cluster status event response: ${Are(n)}`);try{i.cancel()}catch{lr.error("Error trying to cancel timeout.")}s(n)})})}a(jre,"createEventPromise");async function Zre(e){let t=!0,r=0;do await JB(Ire*r++),(await Rre.findPs(e)).length>0&&(t=!1);while(t&&r<wre);if(t)throw new Error(`process ${e} was not started`)}a(Zre,"checkProcessRunning");function ese(e,t){let r=rH(e);if(r)return r;let s=sH(e,t);if(s)return s}a(ese,"checkSchemaTableExist");function rH(e){let{getDatabases:t}=(Ee(),Z(Ce));if(!t()[e])return tE.HDB_ERROR_MSGS.SCHEMA_NOT_FOUND(e)}a(rH,"checkSchemaExists");function sH(e,t){let{getDatabases:r}=(Ee(),Z(Ce));if(!r()[e][t])return tE.HDB_ERROR_MSGS.TABLE_NOT_FOUND(e,t)}a(sH,"checkTableExists");function tse(){let e=eE().utc().add(1,Qe.MOMENT_DAYS_TAG).startOf(Qe.MOMENT_DAYS_TAG).unix(),t=eE().utc().unix();return e-t}a(tse,"getStartOfTomorrowInSeconds");function rse(){return eE().utc().format("DD-MM-YYYY")}a(rse,"getLimitKey");function sse(e){try{let t=new gre(e);for(let{node:r}of t)r&&(r.columnid&&typeof r.columnid!="string"&&(r.columnid=r.columnid.toString()),r.columnid&&!r.columnid.startsWith("`")&&(r.columnid_orig=r.columnid,r.columnid=`\`${r.columnid}\``),r.tableid&&!r.tableid.startsWith("`")&&(r.tableid_orig=r.tableid,r.tableid=`\`${r.tableid}\``),r.databaseid&&!r.databaseid.startsWith("`")&&(r.databaseid_orig=r.databaseid,r.databaseid=`\`${r.databaseid}\``),r.as&&typeof r.as=="string"&&!r.as.startsWith("[")&&(r.as_orig=r.as,r.as=`\`${r.as}\``))}catch(t){lr.error("Got an error back ticking items."),lr.error(t)}}a(sse,"backtickASTSchemaItems");function nse(e){return[e]}a(nse,"createForkArgs");function ise(e){return e===!0||typeof e=="string"&&e.toLowerCase()==="true"}a(ise,"autoCastBoolean");function ose(e,t){let{getDatabases:r}=(Ee(),Z(Ce)),s=r()[e]?.[t];return s?.primaryKey||s?.hash_attribute}a(ose,"getTableHashAttribute");function ase(e){let{getDatabases:t}=(Ee(),Z(Ce));return t()[e]!==void 0}a(ase,"doesSchemaExist");function cse(e,t){let{getDatabases:r}=(Ee(),Z(Ce));return r()[e]?.[t]!==void 0}a(cse,"doesTableExist");function use(e){try{return JSON.stringify(e)}catch{return e}}a(use,"stringifyObj");function lse(e){let t=eE.duration(e),r=t.seconds()>0?t.seconds()+"s":"",s=t.minutes()>0?t.minutes()+"m ":"",n=t.hours()>0?t.hours()+"h ":"",i=t.days()>0?t.days()+"d ":"";return(t.years()>0?t.years()+"y ":"")+i+n+s+r}a(lse,"ms_to_time");function _se(e,t){let r=ui.basename(e,ui.extname(e));return ui.join(ui.dirname(e),r+t)}a(_se,"changeExtension");function aR(){if(process.env[Qe.CONFIG_PARAMS.ROOTPATH.toUpperCase()])return process.env[Qe.CONFIG_PARAMS.ROOTPATH.toUpperCase()];let e=Ore(process.argv);if(e[Qe.CONFIG_PARAMS.ROOTPATH.toUpperCase()])return e[Qe.CONFIG_PARAMS.ROOTPATH.toUpperCase()]}a(aR,"getEnvCliRootPath");var iR;function dse(){if(iR)return iR;let e=aR();aR()&&zB.pathExistsSync(ui.join(e,Qe.HDB_CONFIG_FILE))&&(iR=!0)}a(dse,"noBootFile");function fse(e,t){let r;return e.protocol==="http:"?r=bre:r=Nre,new Promise((s,n)=>{let i=r.request(e,o=>{o.setEncoding("utf8");let c={body:"",headers:o.headers};o.on("data",u=>{c.body+=u}),o.on("end",()=>{s(c)})});i.on("error",o=>{n(o)}),i.write(JSON.stringify(t)),i.end()})}a(fse,"httpRequest");function Ese(e){if(!e.schema&&!e.database){e.schema=Qe.DEFAULT_DATABASE_NAME;return}e.database&&(e.schema=e.database)}a(Ese,"transformReq");function hse(e){let t=0;if(typeof e=="number"&&(t=e),typeof e=="string")switch(t=parseFloat(e),e.slice(-1)){case"M":t*=86400*30;break;case"D":case"d":t*=86400;break;case"H":case"h":t*=3600;break;case"m":t*=60;break}return t*1e3}a(hse,"convertToMS")});var X=T(($Ee,aH)=>{"use strict";var cR=require("fs-extra"),Os=require("path"),iH=require("os"),mse=require("properties-reader"),$u=G(),eo=$(),ee=y(),rE=gr(),pse="Error initializing environment manager",sE="BOOT_PROPS_FILE_PATH",oH=!1,Sse={[ee.HDB_SETTINGS_NAMES.INSTALL_USER]:!0,[ee.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY]:!0,[ee.HDB_SETTINGS_NAMES.HDB_ROOT_KEY]:!0,BOOT_PROPS_FILE_PATH:!0},Cn={};aH.exports={BOOT_PROPS_FILE_PATH:sE,getHdbBasePath:Tse,setHdbBasePath:gse,get:Rse,initSync:Ose,setProperty:me,initTestEnvironment:Nse};function Tse(){return Cn[ee.HDB_SETTINGS_NAMES.HDB_ROOT_KEY]}a(Tse,"getHdbBasePath");function gse(e){Cn[ee.HDB_SETTINGS_NAMES.HDB_ROOT_KEY]=e}a(gse,"setHdbBasePath");function Rse(e){let t=rE.getConfigValue(e);return t===void 0?Cn[e]:t}a(Rse,"get");function me(e,t){Sse[e]&&(Cn[e]=t),rE.updateConfigObject(e,t)}a(me,"setProperty");function Ase(){let e;try{e=eo.getPropsFilePath(),cR.accessSync(e,cR.constants.F_OK|cR.constants.R_OK),oH=!0;let t=mse(e);return Cn[ee.HDB_SETTINGS_NAMES.INSTALL_USER]=t.get(ee.HDB_SETTINGS_NAMES.INSTALL_USER),Cn[ee.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY]=t.get(ee.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY),Cn[sE]=e,!0}catch{return $u.trace(`Environment manager found no properties file at ${e}`),!1}}a(Ase,"doesPropFileExist");function Ose(e=!1){try{(oH||Ase()||eo.noBootFile())&&(rE.initConfig(e),Cn[ee.HDB_SETTINGS_NAMES.HDB_ROOT_KEY]=rE.getConfigValue(ee.HDB_SETTINGS_NAMES.HDB_ROOT_KEY))}catch(t){$u.error(pse),$u.error(t),console.error(t),process.exit(1)}}a(Ose,"initSync");function Nse(e={}){try{let{keep_alive_timeout:t,headers_timeout:r,server_timeout:s,https_enabled:n,cors_enabled:i,cors_accesslist:o,local_studio_on:c}=e,u=Os.join(__dirname,"../../","unitTests");Cn[sE]=Os.join(u,"hdb_boot_properties.file"),me(ee.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY,Os.join(u,"settings.test")),me(ee.HDB_SETTINGS_NAMES.INSTALL_USER,iH.userInfo()?iH.userInfo().username:void 0),me(ee.HDB_SETTINGS_NAMES.PRIVATE_KEY_KEY,Os.join(u,"envDir","utility","keys","privateKey.pem")),me(ee.HDB_SETTINGS_NAMES.CERT_KEY,Os.join(u,"envDir","utility","keys","certificate.pem")),me(ee.CONFIG_PARAMS.TLS_PRIVATEKEY,Os.join(u,"envDir","utility","keys","privateKey.pem")),me(ee.CONFIG_PARAMS.TLS_CERTIFICATE,Os.join(u,"envDir","utility","keys","certificate.pem")),me(ee.HDB_SETTINGS_NAMES.LOG_LEVEL_KEY,"debug"),me(ee.HDB_SETTINGS_NAMES.LOG_PATH_KEY,Os.join(u,"envDir","log")),me(ee.HDB_SETTINGS_NAMES.LOG_DAILY_ROTATE_KEY,!1),me(ee.HDB_SETTINGS_NAMES.CLUSTERING_ENABLED_KEY,!0),me(ee.HDB_SETTINGS_NAMES.CLUSTERING_NODE_NAME_KEY,"1231412de213"),me(ee.HDB_SETTINGS_NAMES.HDB_ROOT_KEY,Os.join(u,"envDir")),me(ee.CONFIG_PARAMS.STORAGE_PATH,Os.join(u,"envDir")),me(ee.HDB_SETTINGS_NAMES.HTTP_SECURE_ENABLED_KEY,eo.isEmpty(n)?!0:n),me(ee.CONFIG_PARAMS.CUSTOMFUNCTIONS_NETWORK_HTTPS,eo.isEmpty(n)?!0:n),me(ee.HDB_SETTINGS_NAMES.SERVER_PORT_KEY,9925),me(ee.HDB_SETTINGS_NAMES.CORS_ENABLED_KEY,eo.isEmpty(i)?!1:i),me(ee.CONFIG_PARAMS.HTTP_CORS,eo.isEmpty(i)?!1:i),me(ee.HDB_SETTINGS_NAMES.MAX_CUSTOM_FUNCTION_PROCESSES,2),me(ee.HDB_SETTINGS_NAMES.MAX_HDB_PROCESSES,4),me(ee.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_PORT_KEY,9926),me(ee.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_ENABLED_KEY,!0),me(ee.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY,Os.resolve(__dirname,"../../unitTests/server/fastifyRoutes/custom_functions")),me(ee.HDB_SETTINGS_NAMES.LOCAL_STUDIO_ON,eo.isEmpty(c)?!1:c),o&&(me("CORS_ACCESSLIST",o),me(ee.CONFIG_PARAMS.HTTP_CORSACCESSLIST,o)),s&&(me(ee.HDB_SETTINGS_NAMES.SERVER_TIMEOUT_KEY,s),me(ee.CONFIG_PARAMS.HTTP_TIMEOUT,s)),t&&(me(ee.HDB_SETTINGS_NAMES.SERVER_KEEP_ALIVE_TIMEOUT_KEY,t),me(ee.CONFIG_PARAMS.HTTP_KEEPALIVETIMEOUT,t)),r&&(me(ee.HDB_SETTINGS_NAMES.SERVER_HEADERS_TIMEOUT_KEY,r),me(ee.CONFIG_PARAMS.HTTP_HEADERSTIMEOUT,r))}catch(t){let r=`Error reading in HDB environment variables from path ${sE}.  Please check your boot props and settings files`;$u.fatal(r),$u.error(t)}}a(Nse,"initTestEnvironment")});var $se=T(Wu=>{var{isMainThread:bse,parentPort:Ku,threadId:nE}=require("worker_threads"),{Socket:yse,createServer:Ise}=require("net"),{createServer:wse,IncomingMessage:Cse}=require("http"),{createServer:Lse}=require("https"),{readFileSync:Ra}=require("fs"),Dn=G(),Rt=X(),Ln=y(),{server:oE}=(hr(),Z(hi)),{WebSocketServer:Dse}=require("ws"),{createServer:Use}=require("tls"),{getTicketKeys:Mse,restartNumber:Pse}=Je(),{Headers:_H}=(Ad(),Z(KU)),{recordAction:Yu,recordActionBinary:vse}=(ln(),Z(Ic)),{Request:dH,node_request_key:KEe,createReuseportFd:cH}=(Ug(),Z(tB));if(process.env.DEV_MODE)try{require("inspector").open(9229)}catch(e){Pse<=1&&Dn.trace("Could not start debugging on port 9229, you may already be debugging:",e.message)}process.on("uncaughtException",e=>{e.code!=="ECONNRESET"&&e.message!=="write EIO"&&console.error("uncaughtException",e)});var{HDB_SETTINGS_NAMES:WEe,CONFIG_PARAMS:Bse}=Ln;Rt.initSync();var Hse=Rt.get(Bse.HTTP_SESSIONAFFINITY),Js={};Wu.registerServer=ER;Wu.httpServer=hR;Wu.deliverSocket=fR;Wu.startServers=fH;oE.http=hR;oE.request=xse;oE.socket=kse;oE.ws=Vse;var uR=[],lR=[],qse,to={},iE={},Fse=[],_R=[];function fH(){return Gg().loadRootComponents(!0).then(()=>{Ku?.on("message",t=>{let{port:r,fd:s,data:n}=t;if(s)fR(s,r,n);else if(t.requestId)Gse(t);else if(t.type===Ln.ITC_EVENT_TYPES.SHUTDOWN){Dn.trace("received shutdown request",nE);for(let i in Js){let o=Js[i],c;o.closeIdleConnections&&setInterval(()=>{o.closeIdleConnections()},25).unref(),o.close?.(()=>{clearInterval(c),setTimeout(()=>{console.log("forced close server",i,nE),o.cantCleanupProperly||Dn.warn("Had to forcefully exit the thread",nE),process.exit(0)},5e3).unref()})}if(process.env.DEV_MODE)try{require("inspector").close()}catch(i){console.error("Could not close debugger",i)}}}).ref();let e=[];if(cH&&!Hse)for(let t in Js){let r=Js[t],s;try{s=cH(+t,"::")}catch(n){console.error(`Unable to bind to port ${t}`,n);continue}e.push(new Promise((n,i)=>{r.listen({fd:s},()=>{n(),Dn.trace("Listening on port "+t,nE)}).on("error",i)}))}Promise.all(e).then(()=>{Ku?.postMessage({type:Ln.ITC_EVENT_TYPES.CHILD_STARTED})})})}a(fH,"startServers");bse||fH();function fR(e,t,r){let s=e?.read?e:new yse({fd:e,readable:!0,writable:!0,allowHalfOpen:!0}),n=Js[t];if(n.isSecure&&(s.startTime=performance.now()),n)typeof n=="function"?n(s):n.emit("connection",s),r&&s.emit("data",r);else{let i=a(o=>{setTimeout(()=>{let c=Js[t];c?(typeof c=="function"?c(s):c.emit("connection",s),r&&s.emit("data",r)):o<5?i(o+1):(Dn.error(`Server on port ${t} was not registered`),s.destroy())},1e3)},"retry");i(1)}return s}a(fR,"deliverSocket");var uH=new Map;function Gse(e){let{port:t,event:r,data:s,requestId:n}=e,i;switch(i=uH.get(n),r){case"connection":i=fR(void 0,t),uH.set(n,i),i.write=(c,u,_)=>(Ku.postMessage({requestId:n,event:"data",data:c.toString("latin1")}),_&&_(),!0),i.end=(c,u,_)=>(Ku.postMessage({requestId:n,event:"end",data:c?.toString("latin1")}),_&&_(),!0);let o=i.destroy;i.destroy=()=>{o.call(i),Ku.postMessage({requestId:n,event:"destroy"})};break;case"data":i._readableState.destroyed||i.emit("data",Buffer.from(s,"latin1"));break;case"drain":i._readableState.destroyed||i.emit("drain",{});break;case"end":i._readableState.destroyed||i.emit("end",{});break;case"error":i._readableState.destroyed||i.emit("error",{});break}}a(Gse,"proxyRequest");function ER(e,t){+t||(t=parseInt(Rt.get(Ln.CONFIG_PARAMS.HTTP_PORT),10));let r=Js[t];if(r){let s=r.lastServer||r;s.off("unhandled",lH),s.on("unhandled",(n,i)=>{e.cantCleanupProperly&&(r.cantCleanupProperly=!0),e.emit("request",n,i)}),r.lastServer=e}else Js[t]=e;e.on("unhandled",lH)}a(ER,"registerServer");function EH(e){let t=[],r=parseInt(e?.securePort);return r&&t.push({port:r,secure:!0}),r=parseInt(e?.port),r&&t.push({port:r,secure:!1}),t.length===0&&(t=[],Rt.get(Ln.CONFIG_PARAMS.HTTP_PORT)!=null&&t.push({port:Rt.get(Ln.CONFIG_PARAMS.HTTP_PORT),secure:Rt.get(Ln.CONFIG_PARAMS.CUSTOMFUNCTIONS_NETWORK_HTTPS)}),Rt.get(Ln.CONFIG_PARAMS.HTTP_SECUREPORT)!=null&&t.push({port:Rt.get(Ln.CONFIG_PARAMS.HTTP_SECUREPORT),secure:!0})),t}a(EH,"getPorts");function hR(e,t){for(let{port:r,secure:s}of EH(t))hH(r,s,t?.isOperationsServer),typeof e=="function"?_R[t?.runFirst?"unshift":"push"]({listener:e,port:t?.port||r}):ER(e,r),iE[r]=dR(_R,r),qse=dR(Fse,r)}a(hR,"httpServer");function hH(e,t,r){if(!to[e]){let s=r?"operationsApi_network":"http",n={keepAliveTimeout:Rt.get(s+"_keepAliveTimeout"),headersTimeout:Rt.get(s+"_headersTimeout"),requestTimeout:Rt.get(s+"_timeout")};if(t){s=r?"operationsApi_":"";let i=Rt.get(s+"tls_privateKey"),o=Rt.get(s+"tls_certificate"),c=Rt.get(s+"tls_certificateAuthority");Object.assign(n,{key:Ra(i),cert:Ra(o)+(c?`

`+Ra(c):""),ticketKeys:Mse()})}to[e]=(t?Lse:wse)(n,async(i,o)=>{try{let u=performance.now(),_=new dH(i,o);r&&(_.isOperationsServer=!0);let l=await iE[e](_);if(!l){if(_._nodeResponse.statusCode)return;l=mH(_)}if(l.headers?.set?.("Server","HarperDB"),l.status===-1){for(let b of l.headers||[])o.setHeader(b[0],b[1]);return i.baseRequest=_,o.baseResponse=l,to[e].emit("unhandled",i,o)}let d=l.status||200,f=performance.now(),E=f-u,h=l.body,p;if(!l.handlesHeaders){let b=l.headers||new _H;if(h?h.length>=0&&(typeof h=="string"?b.set("Content-Length",Buffer.byteLength(h)):b.set("Content-Length",h.length),p=!0):(b.set("Content-Length","0"),p=!0),b.append){let O=`hdb;dur=${E.toFixed(2)}`;l.wasCacheMiss&&(O+=", miss"),b.append("Server-Timing",O,!0)}o.writeHead(d,b&&(b[Symbol.iterator]?Array.from(b):b)),p&&o.end(h)}let S=_.handlerPath,g=_.method;if(Yu(E,"duration",S,g,l.wasCacheMiss==null?void 0:l.wasCacheMiss?"cache-miss":"cache-hit"),vse(d<400,"success",S,g),!p)if(h?.pipe){h.pipe(o),h.destroy&&o.on("close",()=>{h.destroy()});let b=0;h.on("data",O=>{b+=O.length}),h.on("end",()=>{Yu(performance.now()-f,"transfer",S,g),Yu(b,"bytes-sent",S,g)})}else h?.then?h.then(b=>{o.end(b)},c):o.end(h)}catch(u){c(u)}function c(u){let _=u.headers;o.writeHead(u.statusCode||500,_&&(_[Symbol.iterator]?Array.from(_):_)),o.end(u.toString()),u.statusCode?u.statusCode===500?Dn.warn(u):Dn.info(u):Dn.error(u)}a(c,"onError")}),t&&(to[e].on("secureConnection",i=>{i._parent.startTime&&Yu(performance.now()-i._parent.startTime,"tls-handshake",e),Yu(i.isSessionReused(),"tls-reused",e)}),to[e].isSecure=!0),ER(to[e],e)}return to[e]}a(hH,"getHTTPServer");function dR(e,t){let r=mH;for(let s=e.length;s>0;){let{listener:n,port:i}=e[--s];if(i===t||i==="all"){let o=r;r=a(c=>n(c,o),"next_callback")}}return r}a(dR,"makeCallbackChain");function mH(e){return e.user&&(e._nodeRequest.user=e.user),{status:-1,body:"Not found",headers:new _H}}a(mH,"unhandled");function xse(e,t){hR(e,{requestOnly:!0,...t})}a(xse,"onRequest");function kse(e,t){if(t.securePort){let r=Rt.get("tls_privateKey"),s=Rt.get("tls_certificate"),n=Rt.get("tls_certificateAuthority"),i=Use({key:Ra(r),cert:Ra(s)+(n?`

`+Ra(n):"")},e);Js[t.securePort]=i}if(t.port){let r=Ise(e);Js[t.port]=r}}a(kse,"onSocket");Object.defineProperty(Cse.prototype,"upgrade",{get(){return"connection"in this.headers&&"upgrade"in this.headers&&this.headers.connection.startsWith("Upgrade")&&this.headers.upgrade.toLowerCase()=="websocket"},set(e){}});function Vse(e,t){for(let{port:r,secure:s}of EH(t)){lR[r]||(lR[r]=new Dse({server:hH(r,s)}),lR[r].on("connection",async(i,o)=>{try{let c=new dH(o);c.isWebSocket=!0;let u=iE[r](c),_=o.headers["sec-websocket-protocol"]||"";for(let l=0;l<uR.length;l++){let d=uR[l];if(d.protocol){if(d.protocol===_){d.listener(i,c,u);break}}else d.listener(i,c,u)}}catch(c){Dn.warn("Error handling WebSocket connection",c)}}));let n=t?.subProtocol||"";uR.push({listener:e,protocol:n}),iE[r]=dR(_R,r)}}a(Vse,"onWebSocket");function lH(e,t){t.writeHead(404),t.end(`Not found
`)}a(lH,"defaultNotFound")});module.exports=$se();
