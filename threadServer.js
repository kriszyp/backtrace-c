"use strict";var TH=Object.create;var Aa=Object.defineProperty;var gH=Object.getOwnPropertyDescriptor;var RH=Object.getOwnPropertyNames;var AH=Object.getPrototypeOf,OH=Object.prototype.hasOwnProperty;var a=(e,t)=>Aa(e,"name",{value:t,configurable:!0});var Te=(e,t)=>()=>(e&&(t=e(e=0)),t);var T=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),qe=(e,t)=>{for(var r in t)Aa(e,r,{get:t[r],enumerable:!0})},pR=(e,t,r,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of RH(t))!OH.call(e,n)&&n!==r&&Aa(e,n,{get:()=>t[n],enumerable:!(s=gH(t,n))||s.enumerable});return e};var U=(e,t,r)=>(r=e!=null?TH(AH(e)):{},pR(t||!e||!e.__esModule?Aa(r,"default",{value:e,enumerable:!0}):r,e)),Z=e=>pR(Aa({},"__esModule",{value:!0}),e);var gR=T(($se,TR)=>{var NH=require("fast-glob"),{statSync:aE,existsSync:cE,readFileSync:bH,writeFileSync:yH}=require("fs"),{spawnSync:IH,spawn:wH,execFileSync:Vse}=require("child_process"),{isMainThread:CH}=require("worker_threads"),{join:Mn,relative:SR}=require("path"),{PACKAGE_ROOT:es}=y(),{tmpdir:LH,platform:DH}=require("os");require("source-map-support").install();var UH=["resources","server","dataLayer","components"],Oa="ts-build",uE,MH=__filename.endsWith("tsBuild.js");if(MH){if(CH){let r;try{aE(Mn(es,Oa)),r=!0}catch{}if(r)for(let s of NH.sync(UH.map(n=>n+"/**/*.ts"),{cwd:es})){let n=0,i=0;try{n=aE(Mn(es,s)).mtimeMs-5e3,i=aE(Mn(es,Oa,s.replace(/.ts$/,".js"))).mtimeMs}catch{}if(n>i){console.warn(`TypeScript ${s} is not compiled`+(i?` (TS source file was modified at ${new Date(n)} and compiled file at ${new Date(i)})`:"")+", consider enabling auto-compilation of TypeScript in your IDE), compiling now."),uE=!0;break}}else console.log("TypeScript modules are not compiled, compiling now"),uE=!0;if(uE){let s=Mn(es,"node_modules/.bin/tsc");DH()==="win32"&&(s+=".cmd");let n=IH(s,{cwd:es});if(n.stdout.length&&console.log(n.stdout.toString()),n.stderr.length&&console.log(n.stderr.toString()),r){let i=Mn(LH(),"harperdb-tsc.pid"),o;if(cE(i))try{process.kill(+bH(i,{encoding:"utf8"}),0),o=!0}catch{}if(!o){console.log("starting tsc background process");let c=wH(s,["--watch"],{cwd:es,detached:!0,stdio:"ignore"});yH(i,c.pid.toString()),c.unref()}}}}let e=TR.constructor,t=e._findPath;e._findPath=function(r,s,n){if(r.startsWith(".")&&!n&&s.length===1&&s[0].startsWith(es)&&!s[0].includes("node_modules")){let i=SR(es,s[0]),o;i.startsWith(Oa)?o=Mn(es,SR(Oa,i)):o=Mn(es,Oa,i);let c=Mn(o,r),u=c+".js";if(cE(u))return u;if(c.includes(".")&&cE(c))return c}return t(r,s,n)}}});var y=T((Wse,PR)=>{"use strict";var Mr=require("path"),PH=require("fs"),{relative:Yse,join:Kse}=Mr,{existsSync:vH}=PH;function BH(){let e=__dirname;for(;!vH(Mr.join(e,"package.json"));){let t=Mr.dirname(e);if(t===e)throw new Error("Could not find package root");e=t}return e}a(BH,"getHDBPackageRoot");var Pn=BH(),RR="js",Xu=RR,HH="harperdb-config.yaml",qH="defaultConfig.yaml",FH="hdb",AR=`harperdb.${Xu}`,OR=`customFunctionsServer.${Xu}`,GH=`restartHdb.${Xu}`,_E="HarperDB",Ju="Custom Functions",ju="Clustering Hub",Zu="Clustering Leaf",xH="Clustering Ingest Service",kH="Clustering Reply Service",VH="foreground.pid",$H="hdb.pid",YH="data",KH={HDB:_E,CLUSTERING_HUB:ju,CLUSTERING_LEAF:Zu,CLUSTERING_INGEST_SERVICE:xH,CLUSTERING_REPLY_SERVICE:kH,CUSTOM_FUNCTIONS:Ju,RESTART_HDB:"Restart HDB",INSTALL:"Install",RUN:"Run",STOP:"Stop",UPGRADE:"Upgrade",REGISTER:"Register",JOB:"Job",CLUSTERING_UPGRADE_4_0_0:"Upgrade-4-0-0"},WH={HDB:"hdb.log",INSTALL:"install.log",CLUSTERING_HUB:"clustering_hub.log",CLUSTERING_LEAF:"clustering_leaf.log"},QH={NOTIFY:"notify",FATAL:"fatal",ERROR:"error",WARN:"warn",INFO:"info",DEBUG:"debug",TRACE:"trace"},zH={harperdb:_E,"clustering hub":ju,"clustering leaf":Zu,"custom functions":Ju,custom_functions:Ju,clustering:"clustering","clustering config":"clustering config",clustering_config:"clustering_config",http_workers:"http_workers"},JH={CLUSTERING_HUB_PROC_DESCRIPTOR:ju,CLUSTERING_LEAF_PROC_DESCRIPTOR:Zu},lE={HDB:Mr.join(Pn,"server/harperdb"),CUSTOM_FUNCTIONS:Mr.join(Pn,"server/customFunctions"),CLUSTERING_HUB:Mr.join(Pn,"server/nats"),CLUSTERING_LEAF:Mr.join(Pn,"server/nats")},XH={HDB:Mr.join(lE.HDB,AR),CUSTOM_FUNCTIONS:Mr.join(lE.CUSTOM_FUNCTIONS,OR)},jH={MAIN:"bin/harperdb.js",NATS_INGEST_SERVICE:Mr.join(Pn,"launchServiceScripts/launchNatsIngestService.js"),NATS_REPLY_SERVICE:Mr.join(Pn,"launchServiceScripts/launchNatsReplyService.js"),NODES_UPGRADE_4_0_0:Mr.join(Pn,"launchServiceScripts/launchUpdateNodes4-0-0.js")},ZH={SUPER_USER:"super_user",CLUSTER_USER:"cluster_user"},NR="support@harperdb.io",eq="customer-success@harperdb.io",bR=1,tq=4141,yR="https://harperdbhelp.zendesk.com/hc/en-us/requests/new",rq="https://www.harperdb.io/product",sq=`For support, please submit a request at ${yR} or contact ${NR}`,IR=`For license support, please contact ${eq}`,nq="None of the specified records were found.",iq="hash attribute not found",oq=`Your current license only supports ${bR} role.  ${IR}`,aq="Your current license only supports 3 connections to a node.",cq="127.0.0.1",uq=1,lq=/^\.$/,_q=/^\.\.$/,dq="U+002E",fq=/\//g,Eq="U+002F",hq=/U\+002F/g,mq=/^U\+002E$/,pq=/^U\+002EU\+002E$/,Sq="d",Tq=999999,gq="*",Rq="--max-old-space-size=",Aq="system",Oq="__hdb_hash",Nq=".harperdb",bq=".hdb",yq="keys",Iq="hdb_boot_properties.file",wq=".updateConfig.json",Cq="SIGTSTP",Lq=24,Dq=6e4,Uq=448,Mq="blob",Pq="trash",vq="database",Bq="schema",Hq="transactions",qq=".count",Fq="id",Gq="PROCESS_NAME",wR={SETTINGS_PATH_KEY:"settings_path"},CR=require("lodash"),xq={TC_AGREEMENT:"TC_AGREEMENT",CLUSTERING_USER:"CLUSTERING_USER",CLUSTERING_PASSWORD:"CLUSTERING_PASSWORD",HDB_ADMIN_USERNAME:"HDB_ADMIN_USERNAME",HDB_ADMIN_PASSWORD:"HDB_ADMIN_PASSWORD",OPERATIONSAPI_ROOT:"OPERATIONSAPI_ROOT",ROOTPATH:"ROOTPATH",OPERATIONSAPI_NETWORK_PORT:"OPERATIONSAPI_NETWORK_PORT",CLUSTERING_NODENAME:"CLUSTERING_NODENAME",CLUSTERING_ENABLED:"CLUSTERING_ENABLED",HDB_CONFIG:"HDB_CONFIG",CLUSTERING_PORT:"CLUSTERING_PORT",HDB_ROOT:"HDB_ROOT",SERVER_PORT:"SERVER_PORT",NODE_NAME:"NODE_NAME",CLUSTERING:"CLUSTERING"},kq={HDB_PATH_KEY:"HDB_INTERNAL_PATH",HDB_AUTH_HEADER:"hdb_auth_header",HDB_USER_DATA_KEY:"hdb_user",CHUNK_SIZE:1e3,MAX_CHARACTER_SIZE:250},Vq={DATA_VERSION:"data_version",UPGRADE_VERSION:"upgrade_version"},$q={JOB_TABLE_NAME:"hdb_job",NODE_TABLE_NAME:"hdb_nodes",ATTRIBUTE_TABLE_NAME:"hdb_attribute",LICENSE_TABLE_NAME:"hdb_license",ROLE_TABLE_NAME:"hdb_role",SCHEMA_TABLE_NAME:"hdb_schema",TABLE_TABLE_NAME:"hdb_table",USER_TABLE_NAME:"hdb_user",INFO_TABLE_NAME:"hdb_info"},Yq={JOB_TABLE_HASH_ATTRIBUTE:"id",NODE_TABLE_HASH_ATTRIBUTE:"name",ATTRIBUTE_TABLE_HASH_ATTRIBUTE:"id",LICENSE_TABLE_HASH_ATTRIBUTE:"license_key",ROLE_TABLE_HASH_ATTRIBUTE:"id",SCHEMA_TABLE_HASH_ATTRIBUTE:"name",TABLE_TABLE_HASH_ATTRIBUTE:"id",USER_TABLE_HASH_ATTRIBUTE:"username",INFO_TABLE_ATTRIBUTE:"info_id"},dr="hdb_internal:",Kq={CREATE_SCHEMA:dr+"create_schema",CREATE_TABLE:dr+"create_table",CREATE_ATTRIBUTE:dr+"create_attribute",ADD_USER:dr+"add_user",ALTER_USER:dr+"alter_user",DROP_USER:dr+"drop_user",HDB_NODES:dr+"hdb_nodes",HDB_USERS:dr+"hdb_users",HDB_WORKERS:dr+"hdb_workers",CATCHUP:dr+"catchup",SCHEMA_CATCHUP:dr+"schema_catchup",WORKER_ROOM:dr+"cluster_workers"},Wq={ATTR_ATTRIBUTE_KEY:"attribute",ATTR_CREATEDDATE_KEY:"createddate",ATTR_HASH_ATTRIBUTE_KEY:"hash_attribute",ATTR_ID_KEY:"id",ATTR_NAME_KEY:"name",ATTR_PASSWORD_KEY:"password",ATTR_RESIDENCE_KEY:"residence",ATTR_ROLE_KEY:"role",ATTR_SCHEMA_KEY:"schema",ATTR_SCHEMA_TABLE_KEY:"schema_table",ATTR_TABLE_KEY:"table",ATTR_USERNAME_KEY:"username"},Qq="060493.ks",zq=".license",Jq={CREATED:"CREATED",IN_PROGRESS:"IN_PROGRESS",COMPLETE:"COMPLETE",ERROR:"ERROR"},z={INSERT:"insert",UPDATE:"update",UPSERT:"upsert",SEARCH_BY_CONDITIONS:"search_by_conditions",SEARCH_BY_HASH:"search_by_hash",SEARCH_BY_ID:"search_by_id",SEARCH_BY_VALUE:"search_by_value",SEARCH:"search",SQL:"sql",CSV_DATA_LOAD:"csv_data_load",CSV_FILE_LOAD:"csv_file_load",CSV_URL_LOAD:"csv_url_load",CREATE_SCHEMA:"create_schema",CREATE_DATABASE:"create_database",CREATE_TABLE:"create_table",CREATE_ATTRIBUTE:"create_attribute",DROP_SCHEMA:"drop_schema",DROP_DATABASE:"drop_database",DROP_TABLE:"drop_table",DESCRIBE_SCHEMA:"describe_schema",DESCRIBE_DATABASE:"describe_database",DESCRIBE_TABLE:"describe_table",DESCRIBE_ALL:"describe_all",DELETE:"delete",ADD_USER:"add_user",ALTER_USER:"alter_user",DROP_USER:"drop_user",LIST_USERS:"list_users",LIST_ROLES:"list_roles",ADD_ROLE:"add_role",ALTER_ROLE:"alter_role",DROP_ROLE:"drop_role",USER_INFO:"user_info",READ_LOG:"read_log",ADD_NODE:"add_node",UPDATE_NODE:"update_node",EXPORT_TO_S3:"export_to_s3",IMPORT_FROM_S3:"import_from_s3",DELETE_FILES_BEFORE:"delete_files_before",DELETE_RECORDS_BEFORE:"delete_records_before",EXPORT_LOCAL:"export_local",SEARCH_JOBS_BY_START_DATE:"search_jobs_by_start_date",GET_JOB:"get_job",DELETE_JOB:"delete_job",UPDATE_JOB:"update_job",GET_FINGERPRINT:"get_fingerprint",SET_LICENSE:"set_license",GET_REGISTRATION_INFO:"registration_info",CONFIGURE_CLUSTER:"configure_cluster",SET_CONFIGURATION:"set_configuration",CLUSTER_STATUS:"cluster_status",CLUSTER_NETWORK:"cluster_network",DROP_ATTRIBUTE:"drop_attribute",REMOVE_NODE:"remove_node",RESTART:"restart",RESTART_SERVICE:"restart_service",CATCHUP:"catchup",SYSTEM_INFORMATION:"system_information",DELETE_AUDIT_LOGS_BEFORE:"delete_audit_logs_before",READ_AUDIT_LOG:"read_audit_log",CREATE_AUTHENTICATION_TOKENS:"create_authentication_tokens",LOGIN:"login",LOGOUT:"logout",REFRESH_OPERATION_TOKEN:"refresh_operation_token",GET_CONFIGURATION:"get_configuration",CUSTOM_FUNCTIONS_STATUS:"custom_functions_status",GET_CUSTOM_FUNCTIONS:"get_custom_functions",GET_CUSTOM_FUNCTION:"get_custom_function",SET_CUSTOM_FUNCTION:"set_custom_function",GET_COMPONENTS:"get_components",GET_COMPONENT_FILE:"get_component_file",SET_COMPONENT_FILE:"set_component_file",DROP_COMPONENT:"drop_component",DROP_CUSTOM_FUNCTION:"drop_custom_function",ADD_CUSTOM_FUNCTION_PROJECT:"add_custom_function_project",ADD_COMPONENT:"add_component",DROP_CUSTOM_FUNCTION_PROJECT:"drop_custom_function_project",PACKAGE_CUSTOM_FUNCTION_PROJECT:"package_custom_function_project",DEPLOY_CUSTOM_FUNCTION_PROJECT:"deploy_custom_function_project",PACKAGE_COMPONENT:"package_component",DEPLOY_COMPONENT:"deploy_component",CLUSTER_SET_ROUTES:"cluster_set_routes",CLUSTER_DELETE_ROUTES:"cluster_delete_routes",CLUSTER_GET_ROUTES:"cluster_get_routes",READ_TRANSACTION_LOG:"read_transaction_log",DELETE_TRANSACTION_LOGS_BEFORE:"delete_transaction_logs_before",INSTALL_NODE_MODULES:"install_node_modules",AUDIT_NODE_MODULES:"audit_node_modules",PURGE_STREAM:"purge_stream",GET_BACKUP:"get_backup"},Xq={CSV:".csv",JSON:".json"},jq={AWS_ACCESS_KEY:"aws_access_key_id",AWS_SECRET:"aws_secret_access_key",AWS_BUCKET:"bucket",AWS_FILE_KEY:"key",REGION:"region"},Zq={SELECT:"select",INSERT:"insert",UPDATE:"update",DELETE:"delete"},Na={};Na[z.INSERT]=z.INSERT;Na[z.UPDATE]=z.UPDATE;Na[z.UPSERT]=z.UPSERT;Na[z.DELETE]=z.DELETE;var ye=Object.create(null);ye[z.DESCRIBE_ALL]=z.DESCRIBE_ALL;ye[z.DESCRIBE_TABLE]=z.DESCRIBE_TABLE;ye[z.DESCRIBE_SCHEMA]=z.DESCRIBE_SCHEMA;ye[z.READ_LOG]=z.READ_LOG;ye[z.ADD_NODE]=z.ADD_NODE;ye[z.LIST_USERS]=z.LIST_USERS;ye[z.LIST_ROLES]=z.LIST_ROLES;ye[z.USER_INFO]=z.USER_INFO;ye[z.SQL]=z.SQL;ye[z.GET_JOB]=z.GET_JOB;ye[z.SEARCH_JOBS_BY_START_DATE]=z.SEARCH_JOBS_BY_START_DATE;ye[z.DELETE_FILES_BEFORE]=z.DELETE_FILES_BEFORE;ye[z.EXPORT_LOCAL]=z.EXPORT_LOCAL;ye[z.EXPORT_TO_S3]=z.EXPORT_TO_S3;ye[z.CLUSTER_STATUS]=z.CLUSTER_STATUS;ye[z.REMOVE_NODE]=z.REMOVE_NODE;ye[z.RESTART]=z.RESTART;ye[z.CUSTOM_FUNCTIONS_STATUS]=z.CUSTOM_FUNCTIONS_STATUS;ye[z.GET_CUSTOM_FUNCTIONS]=z.GET_CUSTOM_FUNCTIONS;ye[z.GET_CUSTOM_FUNCTION]=z.GET_CUSTOM_FUNCTION;ye[z.SET_CUSTOM_FUNCTION]=z.SET_CUSTOM_FUNCTION;ye[z.DROP_CUSTOM_FUNCTION]=z.DROP_CUSTOM_FUNCTION;ye[z.ADD_CUSTOM_FUNCTION_PROJECT]=z.ADD_CUSTOM_FUNCTION_PROJECT;ye[z.DROP_CUSTOM_FUNCTION_PROJECT]=z.DROP_CUSTOM_FUNCTION_PROJECT;ye[z.PACKAGE_CUSTOM_FUNCTION_PROJECT]=z.PACKAGE_CUSTOM_FUNCTION_PROJECT;ye[z.DEPLOY_CUSTOM_FUNCTION_PROJECT]=z.DEPLOY_CUSTOM_FUNCTION_PROJECT;var eF={DEV:"dev",RUN:"run",START:"start",INSTALL:"install",REGISTER:"register",STOP:"stop",RESTART:"restart",VERSION:"version",UPGRADE:"upgrade",HELP:"help",STATUS:"status"},tF={point:"point",lineString:"lineString",multiLineString:"multiLineString",multiPoint:"multiPoint",multiPolygon:"multiPolygon",polygon:"polygon"},LR={HDB_ROOT_KEY:"HDB_ROOT",SERVER_PORT_KEY:"SERVER_PORT",CERT_KEY:"CERTIFICATE",PRIVATE_KEY_KEY:"PRIVATE_KEY",HTTP_SECURE_ENABLED_KEY:"HTTPS_ON",CORS_ENABLED_KEY:"CORS_ON",CORS_WHITELIST_KEY:"CORS_WHITELIST",LOG_LEVEL_KEY:"LOG_LEVEL",LOGGER_KEY:"LOGGER",LOG_PATH_KEY:"LOG_PATH",LOG_ROTATE:"LOG_ROTATE",LOG_ROTATE_MAX_SIZE:"LOG_ROTATE_MAX_SIZE",LOG_ROTATE_RETAIN:"LOG_ROTATE_RETAIN",LOG_ROTATE_COMPRESS:"LOG_ROTATE_COMPRESS",LOG_ROTATE_DATE_FORMAT:"LOG_ROTATE_DATE_FORMAT",LOG_ROTATE_ROTATE_MODULE:"LOG_ROTATE_ROTATE_MODULE",LOG_ROTATE_WORKER_INTERVAL:"LOG_ROTATE_WORKER_INTERVAL",LOG_ROTATE_ROTATE_INTERVAL:"LOG_ROTATE_ROTATE_INTERVAL",LOG_ROTATE_TIMEZONE:"LOG_ROTATE_TIMEZONE",LOG_DAILY_ROTATE_KEY:"LOG_DAILY_ROTATE",LOG_MAX_DAILY_FILES_KEY:"LOG_MAX_DAILY_FILES",PROPS_ENV_KEY:"NODE_ENV",SETTINGS_PATH_KEY:"settings_path",CLUSTERING_PORT_KEY:"CLUSTERING_PORT",CLUSTERING_NODE_NAME_KEY:"NODE_NAME",CLUSTERING_ENABLED_KEY:"CLUSTERING",ALLOW_SELF_SIGNED_SSL_CERTS:"ALLOW_SELF_SIGNED_SSL_CERTS",MAX_HDB_PROCESSES:"MAX_HDB_PROCESSES",INSTALL_USER:"install_user",CLUSTERING_USER_KEY:"CLUSTERING_USER",MAX_CLUSTERING_PROCESSES:"MAX_CLUSTERING_PROCESSES",SERVER_TIMEOUT_KEY:"SERVER_TIMEOUT_MS",SERVER_KEEP_ALIVE_TIMEOUT_KEY:"SERVER_KEEP_ALIVE_TIMEOUT",SERVER_HEADERS_TIMEOUT_KEY:"SERVER_HEADERS_TIMEOUT",DISABLE_TRANSACTION_LOG_KEY:"DISABLE_TRANSACTION_LOG",OPERATION_TOKEN_TIMEOUT_KEY:"OPERATION_TOKEN_TIMEOUT",REFRESH_TOKEN_TIMEOUT_KEY:"REFRESH_TOKEN_TIMEOUT",CUSTOM_FUNCTIONS_ENABLED_KEY:"CUSTOM_FUNCTIONS",CUSTOM_FUNCTIONS_PORT_KEY:"CUSTOM_FUNCTIONS_PORT",CUSTOM_FUNCTIONS_DIRECTORY_KEY:"CUSTOM_FUNCTIONS_DIRECTORY",MAX_CUSTOM_FUNCTION_PROCESSES:"MAX_CUSTOM_FUNCTION_PROCESSES",LOG_TO_FILE:"LOG_TO_FILE",LOG_TO_STDSTREAMS:"LOG_TO_STDSTREAMS",RUN_IN_FOREGROUND:"RUN_IN_FOREGROUND",LOCAL_STUDIO_ON:"LOCAL_STUDIO_ON",STORAGE_WRITE_ASYNC:"STORAGE_WRITE_ASYNC"},rF=CR.invert(LR),sF={CUSTOMFUNCTIONS_ENABLED:"customFunctions_enabled",CUSTOMFUNCTIONS_NETWORK_PORT:"customFunctions_network_port",CUSTOMFUNCTIONS_TLS_CERTIFICATE:"customFunctions_tls_certificate",CUSTOMFUNCTIONS_NETWORK_CORS:"customFunctions_network_cors",CUSTOMFUNCTIONS_NETWORK_CORSACCESSLIST:"customFunctions_network_corsAccessList",CUSTOMFUNCTIONS_NETWORK_HEADERSTIMEOUT:"customFunctions_network_headersTimeout",CUSTOMFUNCTIONS_NETWORK_HTTPS:"customFunctions_network_https",CUSTOMFUNCTIONS_NETWORK_KEEPALIVETIMEOUT:"customFunctions_network_keepAliveTimeout",CUSTOMFUNCTIONS_TLS_PRIVATEKEY:"customFunctions_tls_privateKey",CUSTOMFUNCTIONS_TLS_CERT_AUTH:"customFunctions_tls_certificateAuthority",CUSTOMFUNCTIONS_NETWORK_TIMEOUT:"customFunctions_network_timeout",CUSTOMFUNCTIONS_NODEENV:"customFunctions_nodeEnv",CUSTOMFUNCTIONS_ROOT:"customFunctions_root"},N={ANALYTICS_AGGREGATEPERIOD:"analytics_aggregatePeriod",AUTHENTICATION_AUTHORIZELOCAL:"authentication_authorizeLocal",AUTHENTICATION_CACHETTL:"authentication_cacheTTL",AUTHENTICATION_ENABLESESSIONS:"authentication_enableSessions",AUTHENTICATION_OPERATIONTOKENTIMEOUT:"authentication_operationTokenTimeout",AUTHENTICATION_REFRESHTOKENTIMEOUT:"authentication_refreshTokenTimeout",CLUSTERING_USER:"clustering_user",CLUSTERING_ENABLED:"clustering_enabled",CLUSTERING_HUBSERVER_CLUSTER_NAME:"clustering_hubServer_cluster_name",CLUSTERING_HUBSERVER_CLUSTER_NETWORK_PORT:"clustering_hubServer_cluster_network_port",CLUSTERING_HUBSERVER_CLUSTER_NETWORK_ROUTES:"clustering_hubServer_cluster_network_routes",CLUSTERING_HUBSERVER_LEAFNODES_NETWORK_PORT:"clustering_hubServer_leafNodes_network_port",CLUSTERING_HUBSERVER_NETWORK_PORT:"clustering_hubServer_network_port",CLUSTERING_LEAFSERVER_NETWORK_PORT:"clustering_leafServer_network_port",CLUSTERING_LEAFSERVER_NETWORK_ROUTES:"clustering_leafServer_network_routes",CLUSTERING_LEAFSERVER_STREAMS_MAXAGE:"clustering_leafServer_streams_maxAge",CLUSTERING_LEAFSERVER_STREAMS_MAXBYTES:"clustering_leafServer_streams_maxBytes",CLUSTERING_LEAFSERVER_STREAMS_MAXMSGS:"clustering_leafServer_streams_maxMsgs",CLUSTERING_LEAFSERVER_STREAMS_PATH:"clustering_leafServer_streams_path",CLUSTERING_NODENAME:"clustering_nodeName",CLUSTERING_TLS_CERTIFICATE:"clustering_tls_certificate",CLUSTERING_TLS_PRIVATEKEY:"clustering_tls_privateKey",CLUSTERING_TLS_CERT_AUTH:"clustering_tls_certificateAuthority",CLUSTERING_TLS_INSECURE:"clustering_tls_insecure",CLUSTERING_TLS_VERIFY:"clustering_tls_verify",CLUSTERING_LOGLEVEL:"clustering_logLevel",CLUSTERING_REPUBLISHMESSAGES:"clustering_republishMessages",CLUSTERING_DATABASELEVEL:"clustering_databaseLevel",CUSTOMFUNCTIONS_NETWORK_HTTPS:"customFunctions_network_https",THREADS:"threads",HTTP_SESSIONAFFINITY:"http_sessionAffinity",HTTP_COMPRESSIONTHRESHOLD:"http_compressionThreshold",HTTP_CORS:"http_cors",HTTP_CORSACCESSLIST:"http_corsAccessList",HTTP_HEADERSTIMEOUT:"http_headersTimeout",HTTP_KEEPALIVETIMEOUT:"http_keepAliveTimeout",HTTP_TIMEOUT:"http_timeout",HTTP_PORT:"http_port",HTTP_SECUREPORT:"http_securePort",LOCALSTUDIO_ENABLED:"localStudio_enabled",LOGGING_FILE:"logging_file",LOGGING_LEVEL:"logging_level",LOGGING_ROOT:"logging_root",LOGGING_ROTATION_ENABLED:"logging_rotation_enabled",LOGGING_ROTATION_COMPRESS:"logging_rotation_compress",LOGGING_ROTATION_INTERVAL:"logging_rotation_interval",LOGGING_ROTATION_MAXSIZE:"logging_rotation_maxSize",LOGGING_ROTATION_PATH:"logging_rotation_path",LOGGING_STDSTREAMS:"logging_stdStreams",LOGGING_AUDITLOG:"logging_auditLog",LOGGING_AUDITRETENTION:"logging_auditRetention",LOGGING_AUDITAUTHEVENTS_LOGFAILED:"logging_auditAuthEvents_logFailed",LOGGING_AUDITAUTHEVENTS_LOGSUCCESSFUL:"logging_auditAuthEvents_logSuccessful",OPERATIONSAPI_NETWORK_CORS:"operationsApi_network_cors",OPERATIONSAPI_NETWORK_CORSACCESSLIST:"operationsApi_network_corsAccessList",OPERATIONSAPI_NETWORK_HEADERSTIMEOUT:"operationsApi_network_headersTimeout",OPERATIONSAPI_NETWORK_HTTPS:"operationsApi_network_https",OPERATIONSAPI_NETWORK_KEEPALIVETIMEOUT:"operationsApi_network_keepAliveTimeout",OPERATIONSAPI_NETWORK_PORT:"operationsApi_network_port",OPERATIONSAPI_NETWORK_SECUREPORT:"operationsApi_network_securePort",OPERATIONSAPI_TLS_CERTIFICATE:"operationsApi_tls_certificate",OPERATIONSAPI_TLS_PRIVATEKEY:"operationsApi_tls_privateKey",OPERATIONSAPI_TLS_CERTIFICATEAUTHORITY:"operationsApi_tls_certificateAuthority",OPERATIONSAPI_NETWORK_TIMEOUT:"operationsApi_network_timeout",ROOTPATH:"rootPath",STORAGE_WRITEASYNC:"storage_writeAsync",STORAGE_OVERLAPPINGSYNC:"storage_overlappingSync",STORAGE_CACHING:"storage_caching",STORAGE_COMPRESSION:"storage_compression",STORAGE_NOREADAHEAD:"storage_noReadAhead",STORAGE_PREFETCHWRITES:"storage_prefetchWrites",STORAGE_ENCRYPTION:"storage_encryption",STORAGE_PATH:"storage_path",STORAGE_AUDIT_PATH:"storage_audit_path",DATABASES:"databases",IGNORE_SCRIPTS:"ignoreScripts",MQTT_NETWORK_PORT:"mqtt_network_port",MQTT_WEBSOCKET:"mqtt_webSocket",MQTT_NETWORK_SECUREPORT:"mqtt_network_securePort",MQTT_REQUIREAUTHENTICATION:"mqtt_requireAuthentication",COMPONENTSROOT:"componentsRoot",TLS_CERTIFICATE:"tls_certificate",TLS_PRIVATEKEY:"tls_privateKey",TLS_CERTIFICATEAUTHORITY:"tls_certificateAuthority"},DR={settings_path:wR.SETTINGS_PATH_KEY,hdb_root_key:N.ROOTPATH,hdb_root:N.ROOTPATH,rootpath:N.ROOTPATH,server_port_key:N.OPERATIONSAPI_NETWORK_PORT,server_port:N.OPERATIONSAPI_NETWORK_PORT,cert_key:N.TLS_CERTIFICATE,certificate:N.TLS_CERTIFICATE,private_key_key:N.TLS_PRIVATEKEY,private_key:N.TLS_PRIVATEKEY,http_secure_enabled_key:N.OPERATIONSAPI_NETWORK_HTTPS,https_on:N.OPERATIONSAPI_NETWORK_HTTPS,cors_enabled_key:N.OPERATIONSAPI_NETWORK_CORS,cors_on:N.OPERATIONSAPI_NETWORK_CORS,cors_whitelist_key:N.OPERATIONSAPI_NETWORK_CORSACCESSLIST,cors_whitelist:N.OPERATIONSAPI_NETWORK_CORSACCESSLIST,cors_accesslist_key:N.OPERATIONSAPI_NETWORK_CORSACCESSLIST,cors_accesslist:N.OPERATIONSAPI_NETWORK_CORSACCESSLIST,log_level_key:N.LOGGING_LEVEL,log_level:N.LOGGING_LEVEL,log_path_key:N.LOGGING_ROOT,log_path:N.LOGGING_ROOT,clustering_node_name_key:N.CLUSTERING_NODENAME,node_name:N.CLUSTERING_NODENAME,clustering_enabled_key:N.CLUSTERING_ENABLED,clustering:N.CLUSTERING_ENABLED,max_http_threads:N.THREADS,max_hdb_processes:N.THREADS,server_timeout_key:N.OPERATIONSAPI_NETWORK_TIMEOUT,server_timeout_ms:N.OPERATIONSAPI_NETWORK_TIMEOUT,server_keep_alive_timeout_key:N.OPERATIONSAPI_NETWORK_KEEPALIVETIMEOUT,server_keep_alive_timeout:N.OPERATIONSAPI_NETWORK_KEEPALIVETIMEOUT,server_headers_timeout_key:N.OPERATIONSAPI_NETWORK_HEADERSTIMEOUT,server_headers_timeout:N.OPERATIONSAPI_NETWORK_HEADERSTIMEOUT,disable_transaction_log_key:N.LOGGING_AUDITLOG,disable_transaction_log:N.LOGGING_AUDITLOG,operation_token_timeout_key:N.AUTHENTICATION_OPERATIONTOKENTIMEOUT,operation_token_timeout:N.AUTHENTICATION_OPERATIONTOKENTIMEOUT,refresh_token_timeout_key:N.AUTHENTICATION_REFRESHTOKENTIMEOUT,refresh_token_timeout:N.AUTHENTICATION_REFRESHTOKENTIMEOUT,custom_functions_port_key:N.HTTP_PORT,custom_functions_port:N.HTTP_PORT,custom_functions_directory_key:N.COMPONENTSROOT,custom_functions_directory:N.COMPONENTSROOT,max_custom_function_processes:N.THREADS,log_to_file:N.LOGGING_FILE,log_to_stdstreams:N.LOGGING_STDSTREAMS,local_studio_on:N.LOCALSTUDIO_ENABLED,clustering_port:N.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_PORT,clustering_user:N.CLUSTERING_USER,clustering_enabled:N.CLUSTERING_ENABLED,clustering_hubserver_cluster_name:N.CLUSTERING_HUBSERVER_CLUSTER_NAME,clustering_hubserver_cluster_network_port:N.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_PORT,clustering_hubserver_cluster_network_routes:N.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_ROUTES,clustering_hubserver_leafnodes_network_port:N.CLUSTERING_HUBSERVER_LEAFNODES_NETWORK_PORT,clustering_hubserver_network_port:N.CLUSTERING_HUBSERVER_NETWORK_PORT,clustering_leafserver_network_port:N.CLUSTERING_LEAFSERVER_NETWORK_PORT,clustering_leafserver_network_routes:N.CLUSTERING_LEAFSERVER_NETWORK_ROUTES,clustering_leafserver_streams_maxage:N.CLUSTERING_LEAFSERVER_STREAMS_MAXAGE,clustering_leafserver_streams_maxbytes:N.CLUSTERING_LEAFSERVER_STREAMS_MAXBYTES,clustering_leafserver_streams_maxmsgs:N.CLUSTERING_LEAFSERVER_STREAMS_MAXMSGS,clustering_leafserver_streams_path:N.CLUSTERING_LEAFSERVER_STREAMS_PATH,clustering_nodename:N.CLUSTERING_NODENAME,clustering_tls_certificate:N.CLUSTERING_TLS_CERTIFICATE,clustering_tls_privatekey:N.CLUSTERING_TLS_PRIVATEKEY,clustering_tls_certificateauthority:N.CLUSTERING_TLS_CERT_AUTH,clustering_tls_insecure:N.CLUSTERING_TLS_INSECURE,clustering_tls_verify:N.CLUSTERING_TLS_VERIFY,clustering_loglevel:N.CLUSTERING_LOGLEVEL,clustering_republishmessages:N.CLUSTERING_REPUBLISHMESSAGES,clustering_databaselevel:N.CLUSTERING_DATABASELEVEL,customfunctions_network_port:N.HTTP_PORT,customfunctions_tls_certificate:N.TLS_CERTIFICATE,customfunctions_network_cors:N.HTTP_CORS,customfunctions_network_corsaccesslist:N.HTTP_CORSACCESSLIST,customfunctions_network_headerstimeout:N.HTTP_HEADERSTIMEOUT,customfunctions_network_https:N.CUSTOMFUNCTIONS_NETWORK_HTTPS,customfunctions_network_keepalivetimeout:N.HTTP_KEEPALIVETIMEOUT,customfunctions_tls_privatekey:N.TLS_PRIVATEKEY,customfunctions_tls_certificateauthority:N.TLS_CERTIFICATEAUTHORITY,customfunctions_network_timeout:N.HTTP_TIMEOUT,http_threads:N.THREADS,threads:N.THREADS,http_session_affinity:N.HTTP_SESSIONAFFINITY,http_compressionthreshold:N.HTTP_COMPRESSIONTHRESHOLD,http_cors:N.HTTP_CORS,http_corsaccesslist:N.HTTP_CORSACCESSLIST,http_headerstimeout:N.HTTP_HEADERSTIMEOUT,http_keepalivetimeout:N.HTTP_KEEPALIVETIMEOUT,http_timeout:N.HTTP_TIMEOUT,http_port:N.HTTP_PORT,http_secureport:N.HTTP_SECUREPORT,customfunctions_processes:N.THREADS,customfunctions_root:N.COMPONENTSROOT,localstudio_enabled:N.LOCALSTUDIO_ENABLED,logging_file:N.LOGGING_FILE,logging_level:N.LOGGING_LEVEL,logging_root:N.LOGGING_ROOT,logging_rotation_enabled:N.LOGGING_ROTATION_ENABLED,logging_rotation_compress:N.LOGGING_ROTATION_COMPRESS,logging_rotation_interval:N.LOGGING_ROTATION_INTERVAL,logging_rotation_maxsize:N.LOGGING_ROTATION_MAXSIZE,logging_rotation_path:N.LOGGING_ROTATION_PATH,logging_stdstreams:N.LOGGING_STDSTREAMS,logging_auditlog:N.LOGGING_AUDITLOG,logging_auditretention:N.LOGGING_AUDITRETENTION,logging_auditauthevents_logfailed:N.LOGGING_AUDITAUTHEVENTS_LOGFAILED,logging_auditauthevents_logsuccessful:N.LOGGING_AUDITAUTHEVENTS_LOGSUCCESSFUL,operationsapi_authentication_operationtokentimeout:N.AUTHENTICATION_OPERATIONTOKENTIMEOUT,operationsapi_authentication_refreshtokentimeout:N.AUTHENTICATION_REFRESHTOKENTIMEOUT,operationsapi_network_cors:N.OPERATIONSAPI_NETWORK_CORS,operationsapi_network_corsaccesslist:N.OPERATIONSAPI_NETWORK_CORSACCESSLIST,operationsapi_network_headerstimeout:N.OPERATIONSAPI_NETWORK_HEADERSTIMEOUT,operationsapi_network_https:N.OPERATIONSAPI_NETWORK_HTTPS,operationsapi_network_keepalivetimeout:N.OPERATIONSAPI_NETWORK_KEEPALIVETIMEOUT,operationsapi_network_port:N.OPERATIONSAPI_NETWORK_PORT,operationsapi_network_secureport:N.OPERATIONSAPI_NETWORK_SECUREPORT,operationsapi_tls_certificate:N.OPERATIONSAPI_TLS_CERTIFICATE,operationsapi_tls_privatekey:N.OPERATIONSAPI_TLS_PRIVATEKEY,operationsapi_tls_certificateauthority:N.OPERATIONSAPI_TLS_CERTIFICATEAUTHORITY,operationsapi_network_timeout:N.OPERATIONSAPI_NETWORK_TIMEOUT,operationsapi_root:N.ROOTPATH,databases:N.DATABASES,storage_path:N.STORAGE_PATH,ignorescripts:N.IGNORE_SCRIPTS,mqtt_network_port:N.MQTT_NETWORK_PORT,mqtt_websocket:N.MQTT_WEBSOCKET,mqtt_network_secureport:N.MQTT_NETWORK_SECUREPORT,mqtt_requireauthentication:N.MQTT_REQUIREAUTHENTICATION,analytics_aggregatePeriod:N.ANALYTICS_AGGREGATEPERIOD,authentication_authorizelocal:N.AUTHENTICATION_AUTHORIZELOCAL,authentication_cachettl:N.AUTHENTICATION_CACHETTL,authentication_enablesessions:N.AUTHENTICATION_ENABLESESSIONS,authentication_operationtokentimeout:N.AUTHENTICATION_OPERATIONTOKENTIMEOUT,authentication_refreshtokentimeout:N.AUTHENTICATION_REFRESHTOKENTIMEOUT,componentsroot:N.COMPONENTSROOT,tls_certificate:N.TLS_CERTIFICATE,tls_privatekey:N.TLS_PRIVATEKEY,tls_certificateauthority:N.TLS_CERTIFICATEAUTHORITY};for(let e in N){let t=N[e];DR[t.toLowerCase()]=t}var nF={TABLES:"tables",PATH:"path",AUDIT_PATH:"auditPath"},iF={csv_file_load:"csv_file_load",csv_data_load:z.CSV_DATA_LOAD,csv_url_load:z.CSV_URL_LOAD,delete_files_before:"delete_files_before",delete_records_before:"delete_records_before",delete_audit_logs_before:"delete_audit_logs_before",delete_transaction_logs_before:"delete_transaction_logs_before",empty_trash:"empty_trash",export_local:"export_local",export_to_s3:"export_to_s3",import_from_s3:"import_from_s3"},oF={CLUSTERING_PAYLOAD:"clustering_payload",DELEGATE_THREAD_RESPONSE:"delegate_thread_response",CLUSTERING:"clustering",SCHEMA:"schema",CLUSTER_STATUS:"cluster_status",JOB:"job",CHILD_STARTED:"child_started",CHILD_STOPPED:"child_stopped",USER:"user",RESTART:"restart"},aF={BIDIRECTIONAL:"BIDIRECTIONAL",OUTBOUND:"OUTBOUND",INBOUND:"INBOUND"},cF={VERSION_DEFAULT:"2.2.0"},uF={DEVELOPMENT:8192,DEFAULT:512},lF={IDENTIFY:"identify",AUTHENTICATE:"authenticate",AUTHENTICATE_OK:"authenticated",AUTHENTICATE_FAIL:"authenticate_fail",CONNECTION:"connection",CONNECT:"connect",CATCHUP_REQUEST:"catchup_request",CATCHUP_RESPONSE:"catchup",CONFIRM_MSG:"confirm_msg",ERROR:"error",DISCONNECT:"disconnect",SCHEMA_UPDATE_REQ:"schema_update_request",SCHEMA_UPDATE_RES:"schema_update_response",RECONNECT_ATTEMPT:"reconnect_attempt",CONNECT_ERROR:"connect_error",MESSAGE:"msg",VERSION_MISMATCH:"version_mismatch",DIRECTION_CHANGE:"direction_change"},_F={1e3:"SUCCESSFUL_SHUTDOWN",1001:"CLOSE_GOING_AWAY",1002:"CLOSE_PROTOCOL_ERROR",1003:"CLOSE_UNSUPPORTED",1005:"CLOSE_NO_STATUS",1006:"CLOSE_ABNORMAL",1007:"UNSUPPORTED_PAYLOAD",1008:"POLICY_VIOLATION",1009:"CLOSE_TOO_LARGE",1010:"MANDATORY_EXTENSION",1011:"SERVER_ERROR",1012:"SERVICE_RESTART",1013:"SERVER_BUSY",1014:"BAD_GATEWAY",1015:"HANDSHAKE_FAIL",4141:"LICENSE_LIMIT_REACHED"},dF={ENOENT:"ENOENT",EACCES:"EACCES",EEXIST:"EEXIST"},UR={CREATED_TIME:"__createdtime__",UPDATED_TIME:"__updatedtime__"},fF=Symbol("metadata"),EF="__clustering__",hF=Object.values(UR),mF=15984864e5,MR={LESS:"<",LESS_OR_EQ:"<=",GREATER:">",GREATER_OR_EQ:">=",BETWEEN:"..."},pF=CR.invert(MR),SF={GET_CLUSTER_STATUS:"GET_CLUSTER_STATUS",CLUSTER_STATUS_RESPONSE:"CLUSTER_STATUS_RESPONSE",ERROR_RESPONSE:"ERROR",ADD_USER:"ADD_USER",ALTER_USER:"ALTER_USER",DROP_USER:"DROP_USER",HDB_OPERATION:"HDB_OPERATION",ADD_NODE:"ADD_NODE",UPDATE_NODE:"UPDATE_NODE",REMOVE_NODE:"REMOVE_NODE",HDB_USERS_MSG:"HDB_USERS_MSG",HDB_WORKERS:"HDB_WORKERS",HDB_TRANSACTION:"HDB_TRANSACTION"},TF=111,gF=`\r
`,RF={READ:"read",INSERT:"insert",UPDATE:"update",DELETE:"delete"},AF=["*","%"],OF="unauthorized_access",NF="func_val",bF={HASH_VALUE:"hash_value",TIMESTAMP:"timestamp",USERNAME:"username"},yF={JWT_PRIVATE_KEY_NAME:".jwtPrivate.key",JWT_PUBLIC_KEY_NAME:".jwtPublic.key",JWT_PASSPHRASE_NAME:".jwtPass"},IF={SHUTDOWN:"shutdown",CHILD_STARTED:"child_started",CHILD_STOPPED:"child_stopped",SCHEMA:"schema",USER:"user",CLUSTER_STATUS_RESPONSE:"cluster_status_response",CLUSTER_STATUS_REQUEST:"cluster_status_request",METRICS:"metrics",GET_METRICS:"get_metrics",RESTART:"restart"},wF={HDB_CORE:"hdb_core",CUSTOM_FUNCTIONS:"custom_functions"},CF={HTTP:"http"},LF={STOPPED:"stopped",ONLINE:"online"},DF="3.x.x",UF={SUCCESS:"success",FAILURE:"failure"},MF={AUTHENTICATION:"authentication",AUTHORIZATION:"authorization"};PR.exports={LOCAL_HARPERDB_OPERATIONS:ye,HDB_SUPPORT_ADDRESS:NR,HDB_SUPPORT_URL:yR,HDB_PRICING_URL:rq,SUPPORT_HELP_MSG:sq,LICENSE_HELP_MSG:IR,HDB_PROC_NAME:AR,HDB_PROC_DESCRIPTOR:_E,CLUSTERING_LEAF_PROC_DESCRIPTOR:Zu,CLUSTERING_HUB_PROC_DESCRIPTOR:ju,SYSTEM_SCHEMA_NAME:Aq,HASH_FOLDER_NAME:Oq,HDB_HOME_DIR_NAME:Nq,UPDATE_FILE_NAME:wq,LICENSE_KEY_DIR_NAME:yq,BOOT_PROPS_FILE_NAME:Iq,JOB_TYPE_ENUM:iF,JOB_STATUS_ENUM:Jq,SYSTEM_TABLE_NAMES:$q,SYSTEM_TABLE_HASH_ATTRIBUTES:Yq,OPERATIONS_ENUM:z,VALID_S3_FILE_TYPES:Xq,S3_BUCKET_AUTH_KEYS:jq,VALID_SQL_OPS_ENUM:Zq,GEO_CONVERSION_ENUM:tF,HDB_SETTINGS_NAMES:LR,HDB_SETTINGS_NAMES_REVERSE_LOOKUP:rF,SERVICE_ACTIONS_ENUM:eF,CLUSTER_MESSAGE_TYPE_ENUM:oF,CLUSTER_CONNECTION_DIRECTION_ENUM:aF,CLUSTER_EVENTS_DEFS_ENUM:lF,PERIOD_REGEX:lq,DOUBLE_PERIOD_REGEX:_q,UNICODE_PERIOD:dq,FORWARD_SLASH_REGEX:fq,UNICODE_FORWARD_SLASH:Eq,ESCAPED_FORWARD_SLASH_REGEX:hq,ESCAPED_PERIOD_REGEX:mq,ESCAPED_DOUBLE_PERIOD_REGEX:pq,REG_KEY_FILE_NAME:Qq,RESTART_TIMEOUT_MS:Dq,HDB_FILE_PERMISSIONS:Uq,DATABASES_DIR_NAME:vq,LEGACY_DATABASES_DIR_NAME:Bq,TRANSACTIONS_DIR_NAME:Hq,LIMIT_COUNT_NAME:qq,ID_ATTRIBUTE_STRING:Fq,INSERT_MODULE_ENUM:kq,UPGRADE_JSON_FIELD_NAMES_ENUM:Vq,RESTART_CODE:Cq,RESTART_CODE_NUM:Lq,CLUSTER_OPERATIONS:Na,SYSTEM_DEFAULT_ATTRIBUTE_NAMES:Wq,HDB_INTERNAL_SC_CHANNEL_PREFIX:dr,INTERNAL_SC_CHANNELS:Kq,CLUSTERING_MESSAGE_TYPES:SF,HDB_FILE_SUFFIX:bq,BLOB_FOLDER_NAME:Mq,HDB_TRASH_DIR:Pq,ORIGINATOR_SET_VALUE:TF,LICENSE_VALUES:cF,RAM_ALLOCATION_ENUM:uF,TIME_STAMP_NAMES_ENUM:UR,TIME_STAMP_NAMES:hF,PERMS_UPDATE_RELEASE_TIMESTAMP:mF,SEARCH_NOT_FOUND_MESSAGE:nq,SEARCH_ATTRIBUTE_NOT_FOUND:iq,LICENSE_ROLE_DENIED_RESPONSE:oq,LICENSE_MAX_CONNS_REACHED:aq,BASIC_LICENSE_MAX_NON_CU_ROLES:bR,BASIC_LICENSE_CLUSTER_CONNECTION_LIMIT_WS_ERROR_CODE:tq,VALUE_SEARCH_COMPARATORS:MR,VALUE_SEARCH_COMPARATORS_REVERSE_LOOKUP:pF,LICENSE_FILE_NAME:zq,WEBSOCKET_CLOSE_CODE_DESCRIPTION_LOOKUP:_F,NEW_LINE:gF,BASIC_LICENSE_MAX_CLUSTER_USER_ROLES:uq,MOMENT_DAYS_TAG:Sq,API_TURNOVER_SEC:Tq,LOOPBACK:cq,CODE_EXTENSION:Xu,WILDCARD_SEARCH_VALUE:gq,NODE_ERROR_CODES:dF,JAVASCRIPT_EXTENSION:RR,PERMS_CRUD_ENUM:RF,UNAUTHORIZED_PERMISSION_NAME:OF,SEARCH_WILDCARDS:AF,FUNC_VAL:NF,READ_AUDIT_LOG_SEARCH_TYPES_ENUM:bF,JWT_ENUM:yF,CLUSTERING_FLAG:EF,ITC_EVENT_TYPES:IF,CUSTOM_FUNCTION_PROC_NAME:OR,CUSTOM_FUNCTION_PROC_DESCRIPTOR:Ju,SERVICES:wF,THREAD_TYPES:CF,MEM_SETTING_KEY:Rq,HDB_RESTART_SCRIPT:GH,PROCESS_DESCRIPTORS:KH,SERVICE_SERVERS:XH,SERVICE_SERVERS_CWD:lE,PROCESS_DESCRIPTORS_VALIDATE:zH,LAUNCH_SERVICE_SCRIPTS:jH,LOG_LEVELS:QH,PROCESS_NAME_ENV_PROP:Gq,LOG_NAMES:WH,PM2_PROCESS_STATUSES:LF,CONFIG_PARAM_MAP:DR,CONFIG_PARAMS:N,HDB_CONFIG_FILE:HH,HDB_DEFAULT_CONFIG_FILE:qH,ROLE_TYPES_ENUM:ZH,BOOT_PROP_PARAMS:wR,INSTALL_PROMPTS:xq,HDB_ROOT_DIR_NAME:FH,CLUSTERING_PROCESSES:JH,FOREGROUND_PID_FILE:VH,PACKAGE_ROOT:Pn,PRE_4_0_0_VERSION:DF,DATABASES_PARAM_CONFIG:nF,METADATA_PROPERTY:fF,AUTH_AUDIT_STATUS:UF,AUTH_AUDIT_TYPES:MF,HDB_PID_FILE:$H,DEFAULT_DATABASE_NAME:YH,LEGACY_CONFIG_PARAMS:sF};gR()});var dE=T((zse,HR)=>{"use strict";var vR=require("minimist");HR.exports=PF;function PF(e=[],t=!1){if(!Array.isArray(e))return{};let r,s;t?(r=BR(process.env),s=BR(vR(process.argv))):(r=process.env,s=vR(process.argv));let n={};for(let i=0,o=e.length;i<o;i++){let c=e[i];s[c]!==void 0?n[c]=s[c].toString().trim():r[c]!==void 0&&(n[c]=r[c].toString().trim())}return n}a(PF,"assignCMDENVVariables");function BR(e){let t,r=Object.keys(e),s=r.length,n={};for(;s--;)t=r[s],n[t.toLowerCase()]=e[t];return n}a(BR,"objKeysToLowerCase")});var G=T((Xse,TE)=>{"use strict";var _i=require("fs-extra"),{workerData:vF,threadId:BF}=require("worker_threads"),Zs=require("path"),GR=require("yaml"),xR=require("properties-reader"),ct=y(),qR=dE(),HF=require("os"),{PACKAGE_ROOT:EE}=y(),{_assignPackageExport:qF}=require("../../index"),ya={};for(let e in console)ya[e]||(ya[e]=console[e]);var Kt={notify:7,fatal:6,error:5,warn:4,info:3,debug:2,trace:1},kR={STDOUT:"stdOut",STDERR:"stdErr"},FF=Zs.join(EE,"logs"),GF=Zs.join(EE,"config/yaml/",ct.HDB_DEFAULT_CONFIG_FILE),xF=1e4,js,bs,Yt,el,tl,Ia,so,ba;ba===void 0&&VR();TE.exports={notify:KR,fatal:WR,error:wa,warn:SE,info:rl,debug:pE,trace:mE,setLogLevel:QF,log_level:Yt,loggerWithTag:kF,suppressLogging:VF,initLogSettings:VR,setupConsoleLogging:$R,logCustomLevel:KF,closeLogFile:hE,getLogFilePath:()=>Ia,OUTPUTS:kR,AuthAuditLog:XF};qF("logger",TE.exports);function VR(e=!1){try{if(ba===void 0||e){hE();let t=WF(),r=qR(["ROOTPATH"]);try{ba=xR(t)}catch(s){if(!r.ROOTPATH||r.ROOTPATH&&!_i.pathExistsSync(Zs.join(r.ROOTPATH,ct.HDB_CONFIG_FILE)))throw s}({level:Yt,config_log_path:tl,to_file:js,to_stream:bs}=zF(r.ROOTPATH?Zs.join(r.ROOTPATH,ct.HDB_CONFIG_FILE):ba.get("settings_path"))),el=ct.LOG_NAMES.HDB,Ia=Zs.join(tl,el)}}catch(t){if(ba=void 0,t.code===ct.NODE_ERROR_CODES.ENOENT){let r=qR(Object.keys(ct.CONFIG_PARAM_MAP),!0);for(let o in r){let c=ct.CONFIG_PARAM_MAP[o];c&&c.toLowerCase();let u=r[o];if(c===ct.CONFIG_PARAMS.LOGGING_LEVEL){Yt=u;continue}if(c===ct.CONFIG_PARAMS.LOGGING_STDSTREAMS){bs=u;continue}c===ct.CONFIG_PARAMS.LOGGING_FILE&&(js=c)}let{default_level:s,default_to_file:n,default_to_stream:i}=JF();js=js===void 0?n:js,js=FR(js),bs=bs===void 0?i:bs,bs=FR(bs),Yt=Yt===void 0?s:Yt,tl=FF,el=ct.LOG_NAMES.INSTALL,Ia=Zs.join(tl,el);return}throw wa("Error initializing log settings"),wa(t),t}process.env.DEV_MODE&&(bs=!0),$R()}a(VR,"initLogSettings");var fE=!0;function $R(){ro("error",wa),ro("warn",SE),ro("log",rl),ro("info",rl),ro("debug",pE),ro("trace",mE)}a($R,"setupConsoleLogging");function ro(e,t){console[e]=function(...r){if(fE&&t(...r),!/PM2 log:|App \[/.test(r[0]))return ya[e](...r)}}a(ro,"logConsole");function kF(e){let t={tagName:e.replace(/ /g,"-")};return{notify:r(KR),fatal:r(WR),error:r(wa),warn:r(SE),info:r(rl),debug:r(pE),trace:r(mE)};function r(s){return function(...n){return s(t,...n)}}}a(kF,"loggerWithTag");function VF(e){try{fE=!1,e()}finally{fE=!0}}a(VF,"suppressLogging");var $F=vF?.name?.replace(/ /g,"-")||"main";function en(e,t){let r=new Date(Date.now()).toISOString(),s="",n=t.length,i=n-1,o=[e],c=0,u;for(typeof t[0]=="object"&&(t[0]?.tagName?(o.push(t[0]?.tagName),c++):t[0]?.serviceName&&(u=t[0]?.serviceName,c++)),o.unshift(u||$F+"/"+BF);c<n;c++){let _=t[c];_ instanceof Error&&_.stack?s+=_.stack:typeof _=="object"?s+=JSON.stringify(_):s+=_,c<i&&(s+=" ")}return`${r} [${o.join("] [")}]: ${s}
`}a(en,"createLogRecord");function Ca(e){js&&YR(e),bs&&process.stdout.write(e)}a(Ca,"logStdOut");function sl(e){js&&YR(e),bs&&process.stderr.write(e)}a(sl,"logStdErr");function YR(e){YF(),so?_i.appendFileSync(so,e):ya.log(e)}a(YR,"logToFile");function hE(){try{_i.closeSync(so)}catch{}so=null}a(hE,"closeLogFile");function YF(){if(!so){try{if(!Ia)debugger;so=_i.openSync(Ia,"a")}catch(e){ya.error(e)}setTimeout(()=>{hE()},xF).unref()}}a(YF,"openLogFile");function rl(...e){Kt[Yt]<=Kt.info&&Ca(en("info",e))}a(rl,"info");function mE(...e){Kt[Yt]<=Kt.trace&&Ca(en("trace",e))}a(mE,"trace");function wa(...e){Kt[Yt]<=Kt.error&&sl(en("error",e))}a(wa,"error");function pE(...e){Kt[Yt]<=Kt.debug&&Ca(en("debug",e))}a(pE,"debug");function KR(...e){Kt[Yt]<=Kt.notify&&Ca(en("notify",e))}a(KR,"notify");function WR(...e){Kt[Yt]<=Kt.fatal&&sl(en("fatal",e))}a(WR,"fatal");function SE(...e){Kt[Yt]<=Kt.warn&&sl(en("warn",e))}a(SE,"warn");function KF(e,t,...r){t===kR.STDERR?sl(en(e,r)):Ca(en(e,r))}a(KF,"logCustomLevel");function WF(){let e;try{e=HF.homedir()}catch{e=process.env.HOME}e||(e="~/");let t=Zs.join(e,ct.HDB_HOME_DIR_NAME,ct.BOOT_PROPS_FILE_NAME);return _i.existsSync(t)||(t=Zs.join(EE,"utility/hdb_boot_properties.file")),t}a(WF,"getPropsFilePath");function QF(e){Yt=e}a(QF,"setLogLevel");function FR(e){return e===!0||typeof e=="string"&&e.toLowerCase()==="true"}a(FR,"autoCastBoolean");function zF(e){try{if(e.includes("config/settings.js")){let o=xR(e);return{level:o.get(ct.HDB_SETTINGS_NAMES.LOG_LEVEL_KEY),config_log_path:Zs.dirname(o.get(ct.HDB_SETTINGS_NAMES.LOG_PATH_KEY)),to_file:o.get(ct.HDB_SETTINGS_NAMES.LOG_TO_FILE),to_stream:o.get(ct.HDB_SETTINGS_NAMES.LOG_TO_STDSTREAMS)}}let t=GR.parseDocument(_i.readFileSync(e,"utf8")),r=t.getIn(["logging","level"]),s=t.getIn(["logging","root"]),n=t.getIn(["logging","file"]),i=t.getIn(["logging","stdStreams"]);return{level:r,config_log_path:s,to_file:n,to_stream:i}}catch(t){if(t.code===ct.NODE_ERROR_CODES.ENOENT)throw t;console.error("Error accessing config file for logging"),console.error(t)}}a(zF,"getLogConfig");function JF(){try{let e=GR.parseDocument(_i.readFileSync(GF,"utf8")),t=e.getIn(["logging","level"]),r=e.getIn(["logging","file"]),s=e.getIn(["logging","stdStreams"]);return{default_level:t,default_to_file:r,default_to_stream:s}}catch(e){console.error("Error accessing default config file for logging"),console.error(e)}}a(JF,"getDefaultConfig");function XF(e,t,r,s,n,i){this.username=e,this.status=t,this.type=r,this.originating_ip=s,this.request_method=n,this.path=i}a(XF,"AuthAuditLog")});var zR=T((Zse,QR)=>{"use strict";var jF=require("util"),ZF=require("path"),eG=require("child_process"),tG=jF.promisify(eG.execFile),rG=1e3*1e3*10;QR.exports={findPs:sG};async function sG(e){let t={};try{await Promise.all(["comm","args","ppid","uid","%cpu","%mem"].map(async r=>{let{stdout:s}=await tG("ps",["wwxo",`pid,${r}`],{maxBuffer:rG});for(let n of s.trim().split(`
`).slice(1)){n=n.trim();let[i]=n.split(" ",1),o=n.slice(i.length+1).trim();t[i]===void 0&&(t[i]={}),t[i][r]=o}}))}catch(r){throw r}return Object.entries(t).filter(([,r])=>r.comm&&r.args&&r.ppid&&r.uid&&r["%cpu"]&&r["%mem"]&&r.args.includes(e)).map(([r,s])=>({pid:Number.parseInt(r,10),name:ZF.basename(s.comm),cmd:s.args,ppid:Number.parseInt(s.ppid,10),uid:Number.parseInt(s.uid,10),cpu:Number.parseFloat(s["%cpu"]),memory:Number.parseFloat(s["%mem"])}))}a(sG,"findPs")});var ze=T((tne,XR)=>{"use strict";var nG="__dbis__",iG="__txns__",oG="__environment_name__",aG="__dbi_defintion__",cG={EQUALS:"equals",STARTS_WITH:"startsWith",_STARTS_WITH:"starts_with",ENDS_WITH:"endsWith",_ENDS_WITH:"ends_with",CONTAINS:"contains",SEARCH_ALL:"searchAll",SEARCH_ALL_TO_MAP:"searchAllToMap",BATCH_SEARCH_BY_HASH:"batchSearchByHash",BATCH_SEARCH_BY_HASH_TO_MAP:"batchSearchByHashToMap",GREATER_THAN:"greaterThan",_GREATER_THAN:"greater_than",GREATER_THAN_EQUAL:"greaterThanEqual",_GREATER_THAN_EQUAL:"greater_than_equal",LESS_THAN:"lessThan",_LESS_THAN:"less_than",LESS_THAN_EQUAL:"lessThanEqual",_LESS_THAN_EQUAL:"less_than_equal",BETWEEN:"between"},uG=["__createdtime__","__updatedtime__"],lG="\uFFFF",JR={TIMESTAMP:"timestamp",HASH_VALUE:"hash_value",USER_NAME:"user_name"},_G=Object.values(JR);XR.exports={AUDIT_STORE_NAME:iG,INTERNAL_DBIS_NAME:nG,DBI_DEFINITION_NAME:aG,SEARCH_TYPES:cG,TIMESTAMP_NAMES:uG,MAX_SEARCH_KEY_LENGTH:256,ENVIRONMENT_NAME_KEY:oG,TRANSACTIONS_DBI_NAMES_ENUM:JR,TRANSACTIONS_DBIS:_G,OVERFLOW_MARKER:lG}});var fr=T((rne,oA)=>{"use strict";var jR=y(),ZR=ze(),eA={CONTINUE:100,OK:200,CREATED:201,BAD_REQUEST:400,UNAUTHORIZED:401,FORBIDDEN:403,NOT_FOUND:404,METHOD_NOT_ALLOWED:405,REQUEST_TIMEOUT:408,CONFLICT:409,TOO_MANY_REQUESTS:429,INTERNAL_SERVER_ERROR:500,NOT_IMPLEMENTED:501,BAD_GATEWAY:502,SERVICE_UNAVAILABLE:503,GATEWAY_TIMEOUT:504,HTTP_VERSION_NOT_SUPPORTED:505,INSUFFICIENT_STORAGE:507,NETWORK_AUTHENTICATION_REQUIRED:511},tA=a(e=>`${e} Check logs and try again.`,"CHECK_LOGS_WRAPPER"),rA={500:tA("There was an error processing your request."),400:"Invalid request"},dG=rA[eA.INTERNAL_SERVER_ERROR],fG={OP_NOT_SUPPORTED_FOR_FS:e=>`${e} is not available for this instance because it uses the File System data store.`,MISSING_VALUE:e=>`${e} is missing.`,INVALID_VALUE:e=>`${e} is invalid.`,NOT_FOUND:e=>`${e} not found.`},EG={CONFIG_VALIDATION:e=>`HarperDB config file validation error: ${e}`},hG={DEFAULT_BULK_LOAD_ERR:"There was an error during your bulk load into HarperDB.",DOWNLOAD_FILE_ERR:e=>`There was an error downloading '${e}'.`,INSERT_JSON_ERR:"There was an error inserting the downloaded JSON data.",INSERT_CSV_ERR:"There was an error inserting the downloaded CSV data.",INVALID_ACTION_PARAM_ERR:e=>`Bulk load operation failed - ${e} is not a valid 'action' parameter`,INVALID_FILE_EXT_ERR:e=>`Error selecting correct parser - valid file type not found in json - ${e}`,MAX_FILE_SIZE_ERR:(e,t)=>`File size is ${e} bytes, which exceeded the maximum size allowed of: ${t} bytes`,PAPA_PARSE_ERR:"There was an error parsing the downloaded CSV data.",S3_DOWNLOAD_ERR:e=>`There was an error downloading '${e}' from AWS.`,WRITE_TEMP_FILE_ERR:"Error writing temporary file to storage"},mG={BASE_PATH_REQUIRED:"base_path is required",DESTINATION_PATH_REQUIRED:"destination_path is required",ENV_NAME_REQUIRED:"env_name is required",INVALID_BASE_PATH:"invalid base_path",INVALID_DESTINATION_PATH:"invalid destination_path",INVALID_ENVIRONMENT:"invalid environment",ENV_REQUIRED:"env is required",DBI_NAME_REQUIRED:"dbi_name is required",DBI_DOES_NOT_EXIST:"dbi does not exist",HASH_ATTRIBUTE_REQUIRED:"hash_attribute is required",ID_REQUIRED:"id is required",IDS_REQUIRED:"ids is required",IDS_MUST_BE_ITERABLE:"ids must be iterable",FETCH_ATTRIBUTES_REQUIRED:"fetch_attributes is required",FETCH_ATTRIBUTES_MUST_BE_ARRAY:"fetch_attributes must be an array",ATTRIBUTE_REQUIRED:"attribute is required",SEARCH_VALUE_REQUIRED:"search_value is required",SEARCH_VALUE_TOO_LARGE:"search_value is too long",WRITE_ATTRIBUTES_REQUIRED:"write_attributes is required",WRITE_ATTRIBUTES_MUST_BE_ARRAY:"write_attributes must be an array",RECORDS_REQUIRED:"records is required",RECORDS_MUST_BE_ARRAY:"records must be an array",CANNOT_CREATE_INTERNAL_DBIS_NAME:`cannot create a dbi named ${ZR.INTERNAL_DBIS_NAME}`,CANNOT_DROP_INTERNAL_DBIS_NAME:`cannot drop a dbi named ${ZR.INTERNAL_DBIS_NAME}`,START_VALUE_REQUIRED:"start_value is required",END_VALUE_REQUIRED:"end_value is required",CANNOT_COMPARE_STRING_TO_NUMERIC_KEYS:"cannot compare a string to numeric keys",END_VALUE_MUST_BE_GREATER_THAN_START_VALUE:"end_value must be greater than or equal to start_value",UNKNOWN_SEARCH_TYPE:"unknown search type",CANNOT_DROP_TABLE_HASH_ATTRIBUTE:"cannot drop a table's hash attribute"},pG={ATTR_NAME_LENGTH_ERR:e=>`transaction aborted due to attribute name ${e} being too long. Attribute names cannot be longer than ${jR.INSERT_MODULE_ENUM.MAX_CHARACTER_SIZE} bytes.`,ATTR_NAME_NULLISH_ERR:"transaction aborted due to record(s) with an attribute name that is null, undefined or empty string",HASH_VAL_LENGTH_ERR:`transaction aborted due to record(s) with a hash value that exceeds ${jR.INSERT_MODULE_ENUM.MAX_CHARACTER_SIZE} bytes, check log for more info`,INVALID_FORWARD_SLASH_IN_HASH_ERR:"transaction aborted due to record(s) with a hash value that contains a forward slash, check log for more info",RECORD_MISSING_HASH_ERR:"transaction aborted due to record(s) with no hash value, check log for more info"},sA={GENERIC_AUTH_FAIL:"Login failed",USER_INACTIVE:"Cannot complete request: User is inactive",INVALID_TOKEN:"invalid token",NO_ENCRYPTION_KEYS:"unable to generate JWT as there are no encryption keys.  please contact your administrator",INVALID_CREDENTIALS:"invalid credentials",PASSWORD_REQUIRED:"password is required",USERNAME_REQUIRED:"username is required",REFRESH_TOKEN_REQUIRED:"refresh_token is required",INVALID_AUTH_OBJECT:"invalid auth_object",INVALID_BODY:"invalid body",TOKEN_EXPIRED:"token expired",REFRESH_TOKEN_SAVE_FAILED:"unable to store refresh_token"},SG={DEFAULT_INVALID_REQUEST:"Invalid request",OP_AUTH_PERMS_ERROR:"This operation is not authorized due to role restrictions and/or invalid database items",OP_IS_SU_ONLY:e=>`Operation '${e}' is restricted to 'super_user' roles`,OP_NOT_FOUND:e=>`Operation '${e}' not found`,SYSTEM_TIMESTAMP_PERMS_ERR:"Internal timestamp attributes - '__createdtime_' and '__updatedtime__' - cannot be inserted to or updated by HDB users.",UNKNOWN_OP_AUTH_ERROR:(e,t,r)=>`There was an error authorizing ${e} op on table '${t}.${r}'`,USER_HAS_NO_PERMS:e=>`User ${e} has no role or permissions.  Please assign the user a valid role.`,DROP_SYSTEM:"The 'system' database, tables and records are used internally by HarperDB and cannot be updated or removed."},TG={ATTR_PERM_MISSING:(e,t)=>`${e.toUpperCase()} attribute permission missing for '${t}'`,ATTR_PERM_MISSING_NAME:"Permission object in 'attribute_permission' missing an 'attribute_name'",ATTR_PERM_NOT_BOOLEAN:(e,t)=>`${e.toUpperCase()} attribute permission for '${t}' must be a boolean`,ATTR_PERMS_ARRAY_MISSING:"Missing 'attribute_permissions' array",ATTR_PERMS_NOT_ARRAY:"Value for 'attribute_permissions' must be an array",INVALID_ATTRIBUTE_IN_PERMS:e=>`Invalid attribute '${e}' in 'attribute_permissions'`,INVALID_PERM_KEY:e=>`Invalid table permission key value '${e}'`,INVALID_ATTR_PERM_KEY:e=>`Invalid attribute permission key value '${e}'`,INVALID_ROLE_JSON_KEYS:e=>`Invalid ${e.length>1?"keys":"key"} in JSON body - '${e.join("', '")}'`,MISMATCHED_TABLE_ATTR_PERMS:e=>`You have a conflict with TABLE permissions for '${e}' being false and ATTRIBUTE permissions being true`,OUTDATED_PERMS_TRANSLATION_ERROR:"This instance was recently upgraded and uses our new role permissions structure. Please login to this instance in HarperDB Studio, go to 'Roles', and click 'Update Role Permission' for all standard roles to migrate them to the new structure.",ROLE_ALREADY_EXISTS:e=>`A role with name '${e}' already exists`,ROLE_NOT_FOUND:"Role not found",ROLE_PERMS_ERROR:"Errors in the role permissions JSON provided",SCHEMA_PERM_ERROR:e=>`Your role does not have permission to view database metadata for '${e}'`,SCHEMA_TABLE_PERM_ERROR:(e,t)=>`Your role does not have permission to view database.table metadata for '${e}.${t}'`,SU_ROLE_MISSING_ERROR:"Missing 'super_user' key/value in permission set",SU_CU_ROLE_BOOLEAN_ERROR:e=>`Value for '${e}' permission must be a boolean`,STRUCTURE_USER_ROLE_TYPE_ERROR:e=>`Value for '${e}' permission must be a boolean or Array`,SU_CU_ROLE_NO_PERMS_ALLOWED:e=>`Roles with '${e}' set to true cannot have other permissions set.`,SU_CU_ROLE_COMBINED_ERROR:"Roles cannot have both 'super_user' and 'cluster_user' values included in their permissions set.",TABLE_PERM_MISSING:e=>`Missing table ${e.toUpperCase()} permission`,TABLE_PERM_NOT_BOOLEAN:e=>`Table ${e.toUpperCase()} permission must be a boolean`},gG={ATTR_NOT_FOUND:(e,t,r)=>`Attribute '${r}' does not exist on '${e}.${t}'`,ATTR_EXISTS_ERR:(e,t,r)=>`Attribute '${r}' already exists in ${e}.${t}'`,DESCRIBE_ALL_ERR:"There was an error during describeAll.  Please check the logs and try again.",INVALID_TABLE_ERR:e=>`Invalid table ${JSON.stringify(e)}`,SCHEMA_NOT_FOUND:e=>`database '${e}' does not exist`,SCHEMA_EXISTS_ERR:e=>`database '${e}' already exists`,TABLE_EXISTS_ERR:(e,t)=>`Table '${t}' already exists in '${e}'`,SCHEMA_REQUIRED_ERR:"database is required",TABLE_NOT_FOUND:(e,t)=>`Table '${e}.${t}' does not exist`,TABLE_REQUIRED_ERR:"table is required"},RG={OUTER_JOIN_TRANSLATION_ERROR:"There was an error translating the final SQL outer join data."},AG={ALTER_USER_DUP_ROLES:e=>`Update failed.  There are duplicates for the '${e}' role which is not allowed. Update your roles and try again.`,ALTER_USER_ROLE_NOT_FOUND:e=>`Update failed.  Requested '${e}' role not found.`,DUP_ROLES_FOUND:e=>`Multiple ${e} roles found.  Roles must have unique 'role' value. Please update and try again.`,ROLE_NAME_NOT_FOUND:e=>`${e} role not found`,USER_ALREADY_EXISTS:e=>`User ${e} already exists`,USER_NOT_EXIST:e=>`User ${e} does not exist`},nA={INVALID_DATE:"Invalid date, must be in ISO-8601 format (YYYY-MM-DD).",SEARCH_CONDITIONS_INVALID_SORT_ATTRIBUTE:e=>`invalid sort attribute '${e}', the attribute must either be the table's hash attribute or an attribute used in conditions.`},iA={INVALID_ITC_DATA_TYPE:"Invalid ITC event data type, must be an object",MISSING_TYPE:"ITC event missing 'type'",MISSING_MSG:"ITC event missing 'message'",MISSING_ORIGIN:"ITC event message missing 'originator' property",INVALID_EVENT:e=>`ITC server received invalid event type: ${e}`},OG={FUNCTION_STATUS:"Error getting custom function status, check the log for more details",GET_FUNCTIONS:"Error getting custom functions, check the log for more details",GET_FUNCTION:"Error getting custom function, check the log for more details",SET_FUNCTION:"Error setting custom function, check the log for more details",NO_PROJECT:"Project does not exist. Create one using 'add_custom_function_project'",PROJECT_EXISTS:"Project already exists",VALIDATION_ERR:"Error validating request, check the log for more details",NO_FILE:"File does not exist",BAD_FILE_NAME:"File name can only contain alphanumeric, dash and underscore characters",BAD_PROJECT_NAME:"Project name can only contain alphanumeric, dash and underscores characters",BAD_PACKAGE:"Packaged project must be base64-encoded tar file of project directory",DROP_FUNCTION:"Error dropping custom function, check the log for more details",ADD_FUNCTION:"Error adding custom function project, check the log for more details",DROP_FUNCTION_PROJECT:"Error dropping custom function project, check the log for more details",BAD_FILE_PATH:"Filepath must be valid, and contain the name of the tarball you wish to write",NOT_ENABLED:"Custom functions is not enabled, to enable set fastifyRoutes enabled to true in hdb/harperdb-config.yaml file."},NG={CLUSTERING_NOT_ENABLED:"Clustering must be enabled to perform this operation."},bG={...sA,...hG,...fG,...SG,...TG,...gG,...RG,...AG,...pG,...nA,...iA,...OG,...NG,...EG};oA.exports={CHECK_LOGS_WRAPPER:tA,HDB_ERROR_MSGS:bG,DEFAULT_ERROR_MSGS:rA,DEFAULT_ERROR_RESP:dG,HTTP_STATUS_CODES:eA,LMDB_ERRORS_ENUM:mG,AUTHENTICATION_ERROR_MSGS:sA,VALIDATION_ERROR_MSGS:nA,ITC_ERRORS:iA}});var j=T((nne,uA)=>{"use strict";var no=fr(),yG=G(),IG=y(),nl=class extends Error{static{a(this,"HdbError")}constructor(t,r,s,n,i){super(),Error.captureStackTrace(this,aA),this.statusCode=s||no.HTTP_STATUS_CODES.INTERNAL_SERVER_ERROR,this.http_resp_msg=r||(no.DEFAULT_ERROR_MSGS[s]?no.DEFAULT_ERROR_MSGS[s]:no.DEFAULT_ERROR_MSGS[no.HTTP_STATUS_CODES.INTERNAL_SERVER_ERROR]),this.message=t.message?t.message:this.http_resp_msg,this.type=t.name,n&&(this.logLevel=n),typeof this.message!="string"&&(this.stack=t.stack),i&&yG[n](i)}},gE=class extends Error{static{a(this,"ClientError")}constructor(t,r){if(t instanceof Error)return t.statusCode=r||400,t;super(t),this.statusCode=r||400}},RE=class extends Error{static{a(this,"ServerError")}constructor(t,r){super(t),this.statusCode=r||500}};function aA(e,t,r,s=IG.LOG_LEVELS.ERROR,n=null,i=!1){if(cA(e))return e;let o=new nl(e,t,r,s,n);return i&&delete o.stack,o}a(aA,"handleHDBError");function cA(e){return e.__proto__.constructor.name===nl.name}a(cA,"isHDBError");uA.exports={isHDBError:cA,handleHDBError:aA,ClientError:gE,ServerError:RE,hdb_errors:no}});var ve=T((one,mA)=>{"use strict";var Pa=y(),wG=$(),Wt=X(),va=require("path"),CG=require("minimist"),lA=require("fs-extra"),_A=require("lodash");Wt.initSync();var{CONFIG_PARAMS:vn,DATABASES_PARAM_CONFIG:La,SYSTEM_SCHEMA_NAME:il}=Pa,Da,Ua,Ma;function dA(){if(Da!==void 0)return Da;if(Wt.getHdbBasePath()!==void 0)return Da=Wt.get(vn.STORAGE_PATH)||va.join(Wt.getHdbBasePath(),Pa.DATABASES_DIR_NAME),Da}a(dA,"getBaseSchemaPath");function fA(){if(Ua!==void 0)return Ua;if(Wt.getHdbBasePath()!==void 0)return Ua=hA(il),Ua}a(fA,"getSystemSchemaPath");function EA(){if(Ma!==void 0)return Ma;if(Wt.getHdbBasePath()!==void 0)return Ma=Wt.get(Pa.CONFIG_PARAMS.STORAGE_AUDIT_PATH)||va.join(Wt.getHdbBasePath(),Pa.TRANSACTIONS_DIR_NAME),Ma}a(EA,"getTransactionAuditStoreBasePath");function LG(e,t){let r=Wt.get(vn.DATABASES)?.[e];return t&&r?.tables?.[t]?.auditPath||r?.auditPath||va.join(EA(),e.toString())}a(LG,"getTransactionAuditStorePath");function hA(e,t){e=e.toString(),t=t&&t.toString();let r=Wt.get(Pa.CONFIG_PARAMS.DATABASES)?.[e];return t&&r?.tables?.[t]?.path||r?.path||va.join(dA(),e)}a(hA,"getSchemaPath");function DG(e,t){e=e.toString(),t=t.toString();let r=process.env;Object.assign(r,CG(process.argv));let s=r[vn.DATABASES.toUpperCase()];if(s){let i;try{i=JSON.parse(s)}catch(o){if(!wG.isObject(s))throw o;i=s}for(let o of i){let c=o[il];if(!c)continue;let u=Wt.get(vn.DATABASES);u=u??{};let _=c?.tables?.[t]?.[La.PATH];if(_)return _A.set(u,[il,La.TABLES,t,La.PATH],_),Wt.setProperty(vn.DATABASES,u),_;let l=c?.[La.PATH];if(l)return _A.set(u,[il,La.PATH],l),Wt.setProperty(vn.DATABASES,u),l}}let n=r[vn.STORAGE_PATH.toUpperCase()];if(n){if(!lA.pathExistsSync(n))throw new Error(n+" does not exist");let i=va.join(n,e);return lA.mkdirsSync(i),Wt.setProperty(vn.STORAGE_PATH,n),i}return fA()}a(DG,"initSystemSchemaPaths");function UG(){Da=void 0,Ua=void 0,Ma=void 0}a(UG,"resetPaths");mA.exports={getBaseSchemaPath:dA,getSystemSchemaPath:fA,getTransactionAuditStorePath:LG,getTransactionAuditStoreBasePath:EA,getSchemaPath:hA,initSystemSchemaPaths:DG,resetPaths:UG}});var Er=T((lne,RA)=>{"use strict";var MG=fr().LMDB_ERRORS_ENUM,cne=require("lmdb"),PG=ze(),une=require("buffer").Buffer,{OVERFLOW_MARKER:pA,MAX_SEARCH_KEY_LENGTH:ol}=PG,SA=["number","string","symbol","boolean","bigint"];function vG(e){if(e=e?.primaryStore||e,!e)throw new Error(MG.ENV_REQUIRED)}a(vG,"validateEnv");function BG(e){if(e==null)return null;let t;try{t=typeof e=="object"?JSON.stringify(e):e.toString()}catch{t=e.toString()}return t}a(BG,"stringifyData");function HG(e){return e instanceof Date?e.valueOf():e}a(HG,"convertKeyValueToWrite");function qG(e){if(e==null)return;if(SA.includes(typeof e))return e.length>ol?[e.slice(0,ol)+pA]:[e];let t;if(Array.isArray(e)){t=[];for(let r=0,s=e.length;r<s;r++){let n=e[r];if(SA.includes(typeof n))n.length>ol?t.push(n.slice(0,ol)+pA):t.push(n);else if(n instanceof Date)return t.push(n.getTime())}}else if(e instanceof Date)return[e.getTime()];return t}a(qG,"getIndexedValues");var al=0,TA=0;function gA(){TA=Date.now()-performance.now()}a(gA,"adjustStartTime");gA();var FG=6e4;setInterval(gA,FG).unref();function GG(){let e=performance.now()+TA;return e>al?(al=e,e):(al+=488e-6,al)}a(GG,"getNextMonotonicTime");RA.exports={validateEnv:vG,stringifyData:BG,convertKeyValueToWrite:HG,getNextMonotonicTime:GG,getIndexedValues:qG}});var AA,ts,AE,Ba=Te(()=>{AA=require("events"),ts=class extends AA.EventEmitter{static{a(this,"IterableEventQueue")}resolveNext;queue;hasDataListeners;[Symbol.asyncIterator](){let t=new AE;return t.queue=this,t}push(t){this.send(t)}send(t){this.resolveNext?(this.resolveNext({value:t}),this.resolveNext=null):this.hasDataListeners?this.emit("data",t):(this.queue||(this.queue=[]),this.queue.push(t))}getNextMessage(){return this.queue?.shift()}on(t,r){if(t==="data"&&!this.hasDataListeners)for(this.hasDataListeners=!0;this.queue?.length>0;)r(this.queue.shift());return super.on(t,r)}},AE=class{static{a(this,"EventQueueIterator")}queue;push(t){this.queue.send(t)}next(){let t=this.queue.getNextMessage();return t?{value:t}:new Promise(r=>this.queue.resolveNext=r)}return(t){return this.queue.emit("close"),{value:t,done:!0}}throw(t){return this.queue.emit("close",t),{done:!0}}}});function Pr(e){return e[Ht]||(e[Ht]=Object.create(null))}function _l(e,t){let r=e.prototype,s={},n=t.attributes||t.properties||[];for(let o of n){let c=o.name,u;switch(o.type){case"String":u=a(function(l){if(!(typeof l=="string"||l==null&&o.nullable!==!1))throw new rs.ClientError(`${c} must be a string, attempt to assign ${l}`);Pr(this)[c]=l},"set");break;case"ID":u=a(function(l){if(!(typeof l=="string"||l?.length>0&&l.every?.(d=>typeof d=="string")||l==null&&o.nullable!==!1))throw new rs.ClientError(`${c} must be a string, attempt to assign ${l}`);Pr(this)[c]=l},"set");break;case"Float":u=a(function(l){if(!(typeof l=="number"||l==null&&o.nullable!==!1))throw new rs.ClientError(`${c} must be a number, attempt to assign ${l}`);Pr(this)[c]=l},"set");break;case"Int":u=a(function(l){if(!(l>>0===l||l==null&&o.nullable!==!1))if(typeof l=="number"&&Math.abs((l>>0)-l)<=1)l=Math.round(l);else throw new rs.ClientError(`${c} must be an integer between -2147483648 and 2147483647, attempt to assign ${l}`);Pr(this)[c]=l},"set");break;case"Long":u=a(function(l){if(!(Math.round(l)===l&&Math.abs(l)<=9007199254740992||l==null&&o.nullable!==!1))if(typeof l=="number"&&Math.abs(l)<=9007199254740992)l=Math.round(l);else throw new rs.ClientError(`${c} must be an integer between -9007199254740992 and 9007199254740992, attempt to assign ${l}`);Pr(this)[c]=l},"set");break;case"Boolean":u=a(function(l){if(!(typeof l=="boolean"||l==null&&o.nullable!==!1))throw new rs.ClientError(`${c} must be a boolean, attempt to assign ${l}`);Pr(this)[c]=l},"set");break;case"Date":u=a(function(l){if(!(l instanceof Date||l==null&&o.nullable!==!1))if(typeof l=="string"||typeof l=="number")l=new Date(l);else throw new rs.ClientError(`${c} must be a Date, attempt to assign ${l}`);Pr(this)[c]=l},"set");break;case"Bytes":u=a(function(l){if(!(l instanceof Uint8Array||l==null&&o.nullable!==!1))throw new rs.ClientError(`${c} must be a Buffer or Uint8Array, attempt to assign ${l}`);Pr(this)[c]=l},"set");break;case"Any":case void 0:u=a(function(l){Pr(this)[c]=l},"set");break;default:u=a(function(l){if(!(typeof l=="object"||l==null&&o.nullable!==!1))throw new rs.ClientError(`${c} must be an object, attempt to assign ${l}`);Pr(this)[c]=l},"set")}let _=s[c]={get(){let l=this[Ht];if(l&&c in l)return l[c];let d=this[ge]?.[c];if(d&&typeof d=="object"){let f=OA(d,o);if(f)return l||(l=this[Ht]=Object.create(null)),l[c]=f}return d},set:u,enumerable:!0,configurable:!0};_.get.isAttribute=!0,(!(c in r)||Object.getOwnPropertyDescriptor(r,c)?.get?.isAttribute)&&Object.defineProperty(r,c,_)}i("getProperty",function(o){let c=s[o];if(c)return c.get.call(this);let u=this[Ht];return u?.[o]!==void 0?u[o]:this[ge]?.[o]}),i("set",function(o,c){let u=s[o];if(u)return u.set.call(this,c);if(t.sealed)throw new rs.ClientError("Can not add a property to a sealed table schema");Pr(this)[o]=c}),i("deleteProperty",function(o){Pr(this)[o]=void 0}),i("toJSON",function(){let o=this[Ht],c;for(let _ in o)c||(c=Object.assign({},this[ge])),c[_]=o[_];return Object.keys(this).length>0&&(c||(c=Object.assign({},this[ge])),Object.assign(c,this)),c||this[ge]}),r.get||i("get",r.getProperty),r.delete||i("delete",r.deleteProperty);function i(o,c){Object.defineProperty(r,o,{value:c,configurable:!0})}a(i,"setMethod")}function OA(e,t){let r;switch(e.constructor){case Object:return t?((r=t.TrackedObject)||(t.TrackedObject=r=class{static{a(this,"TrackedObject")}constructor(n){this[ge]=n}},_l(r,t)),new r(e)):new cl(e);case Array:let s=new ll(e.length);s[ge]=e;for(let n=0,i=e.length;n<i;n++){let o=e[n];o&&typeof o=="object"&&(o=OA(o,t?.elements)),s[n]=o}return s}}function dl(e){let t=e[Ht],r;for(let n in t){r||(r=Object.assign({},e[ge]));let i=t[n];i&&typeof i=="object"&&(i=dl(i)),r[n]=i}return Object.keys(e).length>0&&(r||(r=Object.assign({},e[ge])),Object.assign(r,e)),r||e[ge]}function Ha(e){let t;if(e[ge]&&e.constructor===Array&&!Object.isFrozen(e)){t=e;for(let s=0,n=e.length;s<n;s++){let i=e[s];if(i&&typeof i=="object"){let o=Ha(i);o!==i&&t===e&&(t=e.slice(0)),i=o}t[s]=i}return Object.freeze(t)}let r=e[Ht];for(let s in r){t||(t=Object.assign({},e[ge]));let n=r[s];n&&typeof n=="object"&&(n=Ha(n)),t[s]=n}return t?Object.freeze(t):e[ge]||(e.buffer?e:Object.freeze(e))}function ul(e){let t=e[ge];if(t===void 0)return!0;if(e.constructor===Array){if(!t||e[di]||e.length!==t.length)return!0;for(let r=0,s=e.length;r<s;r++){let n=t[r],i=e[r];if(n&&i?.[ge]===n){if(ul(i))return!0}else return!0}}else{let r=e[Ht];if(r&&!t)return!0;for(let s in r){let n=r[s];if(n&&typeof n=="object"){let i=t[s];if(i&&n[ge]===i){if(ul(n))return!0}else return!0}else return!0}}return!1}var rs,Ht,cl,di,ll,fl=Te(()=>{ss();rs=U(j()),Ht=Symbol("own-data");a(Pr,"getChanges");a(_l,"assignTrackedAccessors");a(OA,"trackObject");cl=class{static{a(this,"GenericTrackedObject")}constructor(t){this[ge]=t}};_l(cl,{});a(dl,"collapseData");a(Ha,"deepFreeze");a(ul,"hasChanges");di=Symbol.for("has-array-changes"),ll=class extends Array{static{a(this,"TrackedArray")}[di];constructor(t){super(t)}splice(...t){return this[di]=!0,super.splice(...t)}push(...t){return this[di]=!0,super.push(...t)}pop(){return this[di]=!0,super.pop()}unshift(...t){return this[di]=!0,super.unshift(...t)}shift(){return this[di]=!0,super.shift()}};ll.prototype.constructor=Array});function $G(){VG=setInterval(function(){for(let e of OE)if(e.stale){let t=e[me]?.url;NA.error(`Transaction was open too long and has been aborted, from table: ${e.lmdbDb?.name+(t?" path: "+t:"")}`),e.resetReadSnapshot()}else e.stale=!0},kG).unref()}var NE,NA,xG,OE,fi,El,kG,VG,bE=Te(()=>{NE=U(Er()),NA=U(G());ss();xG=100,OE=new Set,fi=class{static{a(this,"DatabaseTransaction")}writes=[];lmdbDb;readTxn;readTxnRefCount;validated=0;timestamp=0;open=!0;getReadTxn(){return this.readTxnRefCount=(this.readTxnRefCount||0)+1,this.stale&&(this.stale=!1),this.readTxn?this.readTxn:(this.readTxn=this.lmdbDb.useReadTransaction(),OE.add(this),this.readTxn)}disregardReadTxn(){--this.readTxnRefCount===0&&this.resetReadSnapshot()}resetReadSnapshot(){this.readTxn&&(OE.delete(this),this.readTxn.done(),this.readTxn=null)}addWrite(t){this.writes.push(t)}removeWrite(t){let r=this.writes.indexOf(t);r>-1&&(this.writes[r]=null)}commit(t={}){let r=this.timestamp;r||(r=this.timestamp=t.timestamp=t.timestamp||(0,NE.getNextMonotonicTime)());let s=t.retries||0;if(this.resetReadSnapshot(),this.validated<this.writes.length){let l=this.validated;this.validated=this.writes.length;for(let f=l;f<this.validated;f++)this.writes[f]?.validate?.(this.timestamp);let d;for(let f=l;f<this.validated;f++){let E=this.writes[f];E&&(E.before||E.beforeIntermediate)&&(d=!0)}if(d)return(async()=>{for(let f=0;f<2;f++){let E;for(let h=l;h<this.validated;h++){let S=this.writes[h];if(!S)continue;let p=S[f===0?"before":"beforeIntermediate"];if(p){let g=p();E?E.push?E.push(g):E=[E,g]:E=g}}E&&await(E.push?Promise.all(E):E)}return this.commit(t)})()}t?.close&&(this.open=!1);let n,i=[],o=0;this.writes=this.writes.filter(l=>l);let c=a(l=>{l.commit(r,l.entry,s)},"doWrite"),u=a(()=>{let l=this.writes[o++];if(l)if(l.key){s>0&&(l.entry=l.store.getEntry(l.key));let d=l.store.ifVersion(l.key,l.entry?.version??null,u);n=n||d}else u();else for(let d of this.writes)c(d)},"nextCondition");if(this.writes.length<xG>>s?u():n=this.writes[0].store.transaction(()=>{for(let l of this.writes)l.entry=l.store.getEntry(l.key),c(l);return!0}),n)return n.then(l=>l?(this.next&&i.push(this.next.commit(t)),t?.flush&&i.push(this.writes[0].store.flushed),Promise.all(i).then(()=>(this.writes=[],{txnTime:r}))):(t?t.retries=s+1:t={retries:1},this.commit(t)));let _={txnTime:r};if(this.next){let l=this.next?.commit(t);if(l?.then)return l?.then(d=>({txnTime:r,next:d}));_.next=l}return _}abort(){this.resetReadSnapshot(),this.writes=[]}},El=class extends fi{static{a(this,"ImmediateTransaction")}_timestamp;addWrite(t){super.addWrite(t),this.commit()}get timestamp(){return this._timestamp||(this._timestamp=(0,NE.getNextMonotonicTime)())}getReadTxn(){}},kG=3e3;a($G,"startMonitoringTxns");$G()});function Ge(e,t,r){if(!t)t=e,e={};else if(!e)e={};else if(e?.transaction&&typeof t=="function")return t(e.transaction);if(typeof t!="function")throw new Error("Callback function must be provided to transaction");let s=e.transaction=new fi;e.timestamp&&(s.timestamp=e.timestamp),s[me]=e,e.resourceCache||(e.resourceCache=[]);let n;try{if(n=t(s),n?.then)return n.then(i,o)}catch(c){o(c)}return i(n);function i(c){let u=s.commit({close:!0});return u.then?u.then(()=>(r?.resetTransaction&&(e.transaction=null),c)):(r?.resetTransaction&&(e.transaction=null),c)}function o(c){throw s.abort(),r?.resetTransaction&&(e.transaction=null),c}}var bA,Ei=Te(()=>{bA=require("../../index");ss();bE();a(Ge,"transaction");(0,bA._assignPackageExport)("transaction",Ge);Ge.commit=function(e){let t=(e[me]||e)?.transaction;if(!t)throw new Error("No active transaction is available to commit");return t.commit()};Ge.abort=function(e){let t=(e[me]||e)?.transaction;if(!t)throw new Error("No active transaction is available to abort");return t.abort()}});function wE(e,t,r,s,n){let i=e[0]??e.attribute,o,c,u,_,l=e[1]??e.value;l instanceof Date&&(l=l.getTime());let d=e.comparator,f;switch(KG[d]||d){case"lt":o=!0,c=l;break;case"le":o=!0,c=l,u=!0;break;case"gt":o=l,_=!0;break;case"ge":o=l;break;case"prefix":o=l,c=l.slice(0),c[c.length-1]=Is.MAXIMUM_KEY;break;case"starts_with":o=l.toString(),c=l+String.fromCharCode(65535);break;case"between":o=l[0],o instanceof Date&&(o=o.getTime()),c=l[1],c instanceof Date&&(c=c.getTime()),u=!0;break;case ht.SEARCH_TYPES.EQUALS:case void 0:o=l,c=l,u=!0;break;case"ne":case"contains":case"ends_with":f=!0;break}if(r){let p=o;o=c,c=p,p=!_,_=!u,u=p}let E=i===s.primaryKey||i==null,h=E?s.primaryStore:s.indices[i];if(!h||h.isIndexing||f){if(!n)throw new yE.ClientError(`"${i}" is not indexed${h?.isIndexing?" yet":""}, can not search for this attribute`,404);let p=CE(e);if(!p)throw new yE.ClientError(`Unknown search operator ${e.comparator}`);return s.primaryStore.getRange({start:!0,transaction:t,reverse:r}).map(({key:g,value:b})=>new Promise((O,Y)=>setImmediate(()=>{try{O(b&&p(b)?g:IA.SKIP)}catch(W){Y(W)}})))}let S={start:o,end:c,inclusiveEnd:u,exclusiveStart:_,values:!E,transaction:t,reverse:r};return E?h.getRange(S):h.getRange(S).map(({value:p})=>p)}function CE(e){let t=e.comparator,r=e[0]??e.attribute,s=e[1]??e.value;switch(s instanceof Date&&(s=s.getTime()),t){case ht.SEARCH_TYPES.EQUALS:case void 0:return ys(r,n=>n===s);case ht.SEARCH_TYPES.CONTAINS:return ys(r,n=>n?.toString().includes(s));case ht.SEARCH_TYPES.ENDS_WITH:case ht.SEARCH_TYPES._ENDS_WITH:return ys(r,n=>n?.toString().endsWith(s));case ht.SEARCH_TYPES.STARTS_WITH:case ht.SEARCH_TYPES._STARTS_WITH:return ys(r,n=>typeof n=="string"&&n.startsWith(s));case ht.SEARCH_TYPES.BETWEEN:return s[0]instanceof Date&&(s[0]=s[0].getTime()),s[1]instanceof Date&&(s[1]=s[1].getTime()),ys(r,n=>(0,Is.compareKeys)(n,s[0])>=0&&(0,Is.compareKeys)(n,s[1])<=0);case"gt":case ht.SEARCH_TYPES.GREATER_THAN:case ht.SEARCH_TYPES._GREATER_THAN:return ys(r,n=>(0,Is.compareKeys)(n,s)>0);case"ge":case ht.SEARCH_TYPES.GREATER_THAN_EQUAL:case ht.SEARCH_TYPES._GREATER_THAN_EQUAL:return ys(r,n=>(0,Is.compareKeys)(n,s)>=0);case ht.SEARCH_TYPES.LESS_THAN:case"lt":case ht.SEARCH_TYPES._LESS_THAN:return ys(r,n=>(0,Is.compareKeys)(n,s)<0);case"le":case ht.SEARCH_TYPES.LESS_THAN_EQUAL:case ht.SEARCH_TYPES._LESS_THAN_EQUAL:return ys(r,n=>(0,Is.compareKeys)(n,s)<=0);case"ne":return ys(r,n=>(0,Is.compareKeys)(n,s)!==0);default:return}}function ys(e,t){return r=>{let s=r[e];return typeof s!="object"||!s?t(s):Array.isArray(s)?s.some(t):s instanceof Date?t(s.getTime()):!1}}function hl(e){if(!e)return;let t=new IE,r,s,n,i,o,c=yA;for(;r=c.exec(e);){i=c.lastIndex;let[,u,_]=r;switch(_){case")":case")&":switch(o){case"limit":if(u.indexOf(",")>-1){let[l,d]=u.split(",");t.offset=+l,t.limit=d-t.offset}else t.limit=+u;break;case"select":if(u[0]==="["){if(u[u.length-1]!=="]")throw new Error("Unmatched brackets");t.select=u.slice(1,-1).split(","),t.select.asArray=!0}else u.indexOf(",")>-1?t.select=(u.endsWith(",")?u.slice(0,-1):u).split(","):t.select=u;break;case"group-by":throw new Error("Group by is not implemented yet");case"sort":t.sort=u.split(",").map(l=>{switch(l[0]){case"-":return{attribute:l.slice(1),descending:!0};case"+":return{attribute:l.slice(1),descending:!1};default:return{attribute:l,descending:!1}}});break;default:throw new Error(`Unknown query function call ${o}`)}s=void 0;break;case"(":o=u;break;case"=":s?u.length<=2&&(n=u):(n="equals",s=decodeURIComponent(u));break;case"!=":case"<":case"<=":case">":case">=":n=YG[_],s=decodeURIComponent(u);break;case"=*":n="ends_with",s=decodeURIComponent(u);break;case"*":case"*&":t.conditions.push({comparator:n==="ends_with"?"contains":"starts_with",attribute:s,value:decodeURIComponent(u)}),s=null;break;case"":case void 0:case"&":case"|":if(!s)throw new Error(`Unable to parse query, no part before ${_} at ${i} in ${e}`);t.conditions.push({comparator:n,attribute:s,value:decodeURIComponent(u)}),s=void 0;break;default:throw new Error(`Unknown operator ${_} in query ${e}`)}c=s?WG:yA,c.lastIndex=i}if(i!==e.length)throw new Error(`Unable to parse query, unexpected end in ${e}`);return t}var yE,ht,Is,IA,YG,KG,yA,WG,IE,ml=Te(()=>{yE=U(j()),ht=U(ze()),Is=require("ordered-binary"),IA=require("lmdb"),YG={"<":"lt","<=":"le",">":"gt",">=":"ge","!=":"ne"};a(wE,"idsForCondition");KG={greater_than:"gt",greater_than_equal:"ge",less_than:"lt",less_than_equal:"le",not_equal:"ne",">":"gt",">=":"ge","<":"lt","<=":"le","...":"between"};a(CE,"filterByType");a(ys,"attributeComparator");yA=/([^?&|=<>!()*]+)([&|=<>!()*]*)/g,WG=/([^&|*=]+)([&|*=]*)/g;a(hl,"parseQuery");IE=class{static{a(this,"Query")}constructor(){this.conditions=[]}[Symbol.iterator](){return this.conditions[Symbol.iterator]()}get(t){for(let r=0;r<this.conditions.length;r++){let s=this.conditions[r];if(s.attribute===t)return s.value}}}});var UE={};qe(UE,{CONTEXT:()=>me,ID_PROPERTY:()=>Ie,IS_COLLECTION:()=>ws,RECORD_PROPERTY:()=>ge,Resource:()=>Ot,SAVE_UPDATES_PROPERTY:()=>MA,snake_case:()=>zG});function zG(e){return e[0].toLowerCase()+e.slice(1).replace(/[a-z][A-Z][a-z]/g,t=>t[0]+"_"+t.slice(1))}function wA(e,t){if(e=e.slice(1),e.indexOf("/")===-1)return e.startsWith("$")&&(e=parseInt(e,36)),t.coerceId(decodeURIComponent(e));let r=e.split("/"),s=new DE(r.length);for(let n=0;n<r.length;n++)s[n]=t.coerceId(decodeURIComponent(r[n]));return s}function vr(e,t){s.reliesOnPrototype=!0;let r=t.hasContent;return s;function s(n,i,o){let c,u,_;if(r?o?(_=i,o=o[me]||o):i?typeof n=="object"&&n&&(!Array.isArray(n)||typeof n[0]=="object")?(_=n,c=_[this.primaryKey]??null,o=i[me]||i):_=i:(_=n,c=_[Ie]??_[this.primaryKey]??null):i?o=i[me]||i:n&&typeof n=="object"&&!Array.isArray(n)&&(o=n),c===void 0)if(typeof n=="string")c=n;else if(typeof n=="object"&&n)if(u=n,n[Symbol.iterator]){c=[];for(let f of n){if(typeof f=="object"&&f)break;c.push(f)}c.length===0?c=null:(c.length===1&&(c=c[0]),u.slice&&(u=u.slice(c.length,u.length),u.length===0&&(u=null)))}else{if(typeof(c=n.url)=="string"){let f=c.indexOf("?");if(f>-1){let h=this.parseQuery(c.slice(f+1));u?u=Object.assign(h,u):u=h,c=c.slice(0,f)}let E=this.parsePath(c,o,u);E?.query?(u=E.query,c=E.id):c=E}c===void 0&&(c=n.id??null)}else c=n??null;o||(o={});let l;if(u?.ensureLoaded!=null||u?.async?(l=Object.assign({},t),u?.ensureLoaded!=null&&(l.ensureLoaded=u.ensureLoaded),u.async&&(l.async=u.async)):l=t,o.transaction){let f=this.getResource(c,o,l);return f.then?f.then(d):d(f)}else return Ge(o,()=>{let f=this.getResource(c,o,l);return f.then?f.then(d):d(f)},l);function d(f){if(t.type==="read"&&(f[MA]=!1),o.authorize){o.authorize=!1;let E=t.type==="read"?f.allowRead(o.user,o):t.type==="update"?f.doesExist?.()===!1?f.allowCreate(o.user,o):f.allowUpdate(o.user,o):t.type==="create"?f.allowCreate(o.user,o):f.allowDelete(o.user,o);if(E?.then)return E.then(h=>{if(!h)throw new pl(o.user);return typeof _?.then=="function"?_.then(S=>e(f,u,o,S)):e(f,u,o,_)});if(!E)throw new pl(o.user)}return typeof _?.then=="function"?_.then(E=>e(f,u,o,E)):e(f,u,o,_)}a(d,"authorizeActionOnResource")}}function Br(e,t){let r=new UA.ClientError(`The ${e.constructor.name} does not have a ${t} method implemented`,405);r.allow=[],r.method=t;for(let s of["get","put","post","delete","query","move","copy"])typeof e[s]=="function"&&r.allow.push(s);throw r}function LE(e){let t=e[ge];if(t){let r=e[Ht];return s=>{let n;return e.hasOwnProperty(s)&&typeof(n=e[s])!="function"?n:r&&s in r?r[s]:t[s]}}else return r=>e[r]}function CA(e){if(typeof e=="string")return t=>LE(t)(e);if(typeof e=="object"){if(e.asArray)return r=>{let s=[],n=LE(r);for(let i of e)s.push(n(i));return s};let t=e.forceNulls;return r=>{let s={},n=LE(r);for(let i of e){let o=n(i);o===void 0&&t&&(o=null),s[i]=o}return s}}else throw new Error("Invalid select argument type "+typeof e)}var LA,DA,UA,me,Ie,ws,MA,ge,QG,Ot,pl,DE,ss=Te(()=>{LA=require("crypto");Ba();DA=require("../../index"),UA=U(j());fl();Ei();ml();me=Symbol.for("context"),Ie=Symbol.for("primary-key"),ws=Symbol("is-collection"),MA=Symbol("save-updates"),ge=Symbol("stored-record"),QG={json:"application/json",cbor:"application/cbor",msgpack:"application/x-msgpack",csv:"text/csv"},Ot=class{static{a(this,"Resource")}static transactions;constructor(t,r){this[Ie]=t;let s=r?.[me];this[me]=s!==void 0?s:r||null}static get=vr(function(t,r,s,n){let i=t.get?.(r);if(i?.then)return i.then(o);return o(i);function o(c){let u;if((u=r?.select)&&c!=null){let _=CA(u);return typeof c?.map=="function"?c.map(_):_(c)}return c}},{type:"read",resetTransaction:!0,ensureLoaded:!0,async:!0});static put=vr(function(t,r,s,n){if(Array.isArray(n)&&t[ws]){let i=[],o=s.authorize;for(let c of n){let u=t.constructor,_=u.getResource(c[u.primaryKey],s,{async:!0});_.then?i.push(_.then(l=>l.put(c,s))):i.push(_.put(c,s))}return Promise.all(i)}return t.put?t.put(n,r):Br(t,"put")},{hasContent:!0,type:"update"});static delete=vr(function(t,r,s,n){return t.delete?t.delete(r):Br(t,"delete")},{hasContent:!1,type:"delete"});static getNewId(){return(0,LA.randomUUID)()}static create(t,r,s){let n;return t==null?n=this.getNewId():Array.isArray(t)&&typeof t[0]!="object"?n=[...t,this.getNewId()]:typeof t!="object"?n=[t,this.getNewId()]:(n=this.getNewId(),s=r,r=t),Ge(s,()=>{let i=new this(n,s),o=i.put?i.put(r):Br(i,"put");return s.newLocation=n,s.createdResource=!0,o?.then?o.then(()=>n):n})}static invalidate=vr(function(t,r,s,n){return t.invalidate?t.invalidate(r):Br(t,"delete")},{hasContent:!1,type:"update"});static post=vr(function(t,r,s,n){return t[Ie]!=null&&t.update?.(),t.post(n,r)},{hasContent:!0,type:"create"});static connect=vr(function(t,r,s,n){return t.connect?t.connect(n,r):Br(t,"connect")},{hasContent:!0,type:"read"});static subscribe=vr(function(t,r,s,n){return t.subscribe?t.subscribe(r):Br(t,"subscribe")},{type:"read"});static publish=vr(function(t,r,s,n){return t[Ie]!=null&&t.update?.(),t.publish?t.publish(n,r):Br(t,"publish")},{hasContent:!0,type:"create"});static search=vr(function(t,r,s,n){let i=t.search?t.search(r):Br(t,"search"),o=s.select;if(o&&s.hasOwnProperty("select")&&i!=null){let c=CA(o);return i.map(c)}return i},{type:"read"});static query=vr(function(t,r,s,n){return t.search?t.search(n,r):Br(t,"search")},{hasContent:!0,type:"read"});static copy=vr(function(t,r,s,n){return t.copy?t.copy(n,r):Br(t,"copy")},{type:"create"});static move=vr(function(t,r,s,n){return t.move?t.move(n,r):Br(t,"move")},{type:"delete"});post(t){if(this[ws])return this.constructor.create(this[Ie],t,this[me]);Br(this,"post")}static isCollection(t){return t?.[ws]}static coerceId(t){return t}static parseQuery(t){return hl(t)}static parsePath(t,r,s){let n=t.indexOf(".");if(n>-1){let i=t.slice(n+1);t=t.slice(0,n);let o=r?.headers&&QG[i];if(o)r.headers.set("accept",o);else if(s)s.property=i;else return{query:{property:i},id:wA(t,this)}}return wA(t,this)}static getResource(t,r,s){let n,i=r[me],o;typeof r.isCollection=="boolean"&&r.hasOwnProperty("isCollection")?o=r.isCollection:o=t==null||Array.isArray(t)&&t[t.length-1]==null;let c=o&&this.Collection||this;if(i||(i=i===void 0?r:{}),i.transaction){let u;if(i.resourceCache?u=i.resourceCache:u=i.resourceCache=[],u.asMap){let _=u.asMap.get(t);if(n=_?.find(l=>l.constructor===c),n)return n;_||u.asMap.set(t,_=[]),_.push(n=new c(t,i))}else{if(n=u.find(_=>_[Ie]===t&&_.constructor===c),n)return n;if(u.push(n=new c(t,i)),u.length>10){let _=new Map;for(let l of u){let d=l[Ie],f=_.get(d);f?f.push(l):_.set(d,[l])}i.resourceCache.length=0,i.resourceCache.asMap=_}}}else n=new c(t,i);return o&&(n[ws]=!0),n}subscribe(t){return new ts}connect(t){return t?.subscribe!==!1?this.subscribe?.(t):new ts}allowRead(t){return t?.role.permission.super_user}allowUpdate(t){return t?.role.permission.super_user}allowCreate(t){return t?.role.permission.super_user}allowDelete(t){return t?.role.permission.super_user}getId(){return this[Ie]}getContext(){return this[me]}};Ot.prototype[me]=null;(0,DA._assignPackageExport)("Resource",Ot);a(zG,"snake_case");pl=class extends Error{static{a(this,"AccessError")}constructor(t){t?(super("Unauthorized access to resource"),this.statusCode=403):(super("Must login"),this.statusCode=401)}};a(wA,"pathToId");DE=class extends Array{static{a(this,"MulitPartId")}toString(){return this.join("/")}};a(vr,"transactional");a(Br,"missingMethod");a(LE,"selectFromObject");a(CA,"transformForSelect")});var hi={};qe(hi,{server:()=>ut});var PA,ut,hr=Te(()=>{PA=require("../../index"),ut={};(0,PA._assignPackageExport)("server",ut)});var PE={};qe(PE,{loadGQLSchema:()=>jG,start:()=>ME,startOnMainThread:()=>XG});function ME({ensureTable:e}){return{handleFile:t,setupFile:t};async function t(r,s,n,i){let{parse:o,Source:c,Kind:u,NamedTypeNode:_,StringValueNode:l}=await import("graphql"),d=o(new c(r.toString(),n)),f=new Map,E=[],h;for(let p of d.definitions)switch(p.kind){case u.OBJECT_TYPE_DEFINITION:let W=function(F){if(F.kind==="NonNullType"){let B=W(F.type);return B.nullable=!1,B}if(F.kind==="ListType")return{type:"array",elements:W(F.type)};let K={type:F.name?.value};return Object.defineProperty(K,"location",{value:F.loc.startToken}),K};a(W,"getProperty");let g=p.name.value,b=[],O={table:null,database:null,properties:b};f.set(g,O);for(let F of p.directives){if(F.name.value==="table"){for(let w of F.arguments)O[w.name.value]=w.value.value;O.schema&&(O.database=O.schema),O.table||(O.table=g),O.audit&&(O.audit=O.audit!=="false"),O.attributes=O.properties,E.push(O)}if(F.name.value==="sealed"&&(O.sealed=!0),F.name.value==="export"){O.export=!0;for(let w of F.arguments)w.name.value==="name"&&(O.export={name:w.value.value})}}let Y=!1;for(let F of p.fields){let w=W(F.type);w.name=F.name.value,b.push(w);for(let K of F.directives)if(K.name.value==="primaryKey")Y?console.warn("Can not define two attributes as a primary key"):(w.isPrimaryKey=!0,Y=!0);else if(K.name.value==="indexed")w.indexed=!0;else if(K.name.value==="createdTime")w.assignCreatedTime=!0;else if(K.name.value==="updatedTime")w.assignUpdatedTime=!0;else if(K.name.value==="expiresAt")w.expiresAt=!0;else if(K.name.value==="allow"){let B=w.authorizedRoles=[];for(let x of K.arguments)x.name.value==="role"&&B.push(x.value.value)}}O.typeName=g,g==="Query"&&(h=O)}function S(p){let g=f.get(p.type);g?p.properties=g.properties:p.type==="array"?S(p.elements):JG.includes(p.type)||(0,vA.getWorkerIndex)()===0&&console.error(`The type ${p.type} is unknown at line ${p.location.line}, column ${p.location.column}, in ${n}`)}a(S,"connectPropertyType");for(let p of f.values())for(let g of p.properties)S(g);for(let p of E)p.tableClass=e(p),p.export&&(p.export.name===""?i.set((0,Sl.dirname)(s),p.tableClass):i.set((0,Sl.dirname)(s)+"/"+(p.export.name||p.typeName),p.tableClass));if(h)for(let p of h.properties){let g=f.get(p.type);if(!g)throw new Error(`${p.type} was not found as a Query export`);i.set((0,Sl.dirname)(s)+"/"+p.name,g.tableClass)}}}var Sl,vA,JG,XG,jG,BA=Te(()=>{Sl=require("path");fe();vA=U(Je()),JG=["ID","Int","Float","Long","String","Boolean","Date","Bytes","Any"];a(ME,"start");XG=ME,jG=ME({ensureTable:et}).handleFile});async function Tl(e){return ZG?(qa||(qa=ex(rx)),(await(await qa).import(e)).namespace):import(e)}async function ex(e){let{StaticModuleRecord:t}=await import("@endo/static-module-record");return require("ses"),lockdown({domainTaming:"unsafe",consoleTaming:"unsafe",errorTaming:"unsafe",errorTrapping:"none",stackFiltering:"verbose"}),qa=new Compartment({console,Math,Date,fetch:tx,...e()},{},{name:"h-dapp",resolveHook(r,s){return r==="harperdb"?"harperdb":(r=new URL(r,s).toString(),(0,qA.extname)(r)||(r+=".js"),r)},importHook:async r=>{if(r==="harperdb")return{imports:[],exports:["Resource","tables","databases"],execute(n){Object.assign(n,{Resource:Ot,tables:mr,databases:xe})}};let s=await(0,HA.readFile)(new URL(r),{encoding:"utf-8"});return new t(s,r)}}),qa}function tx(e,t){let r=typeof e=="string"||e.url;if(new URL(r).protocol!="https")throw new Error("Only https is allowed in fetch");return fetch(e,t)}function rx(){return{Resource:Ot,tables:mr}}var HA,qA,ZG,qa,vE=Te(()=>{ss();fe();HA=require("fs/promises"),qA=require("path"),ZG=!1;a(Tl,"secureImport");a(ex,"getCompartment");a(tx,"secureOnlyFetch");a(rx,"getGlobalVars")});var HE={};qe(HE,{handleFile:()=>sx});async function sx(e,t,r,s){let n=new Map,i=(0,FA.pathToFileURL)(r).toString(),o=await Tl(i);u(o.default)&&s.set((0,BE.dirname)(t),o.default),c(o,(0,BE.dirname)(t));function c(_,l){for(let d in _){let f=_[d];u(f)?s.set(l+"/"+d,f):typeof f=="object"&&c(f,l+"/"+d)}}a(c,"recurseForResources");function u(_){return typeof _=="function"&&(_.get||_.put||_.post||_.delete)}return a(u,"isResource"),n}var FA,BE,GA=Te(()=>{FA=require("url");vE();BE=require("path");a(sx,"handleFile")});var FE={};qe(FE,{start:()=>nx});function nx({resources:e}){e.set("login",qE),e.loginPath=t=>"/login?redirect="+encodeURIComponent(t.url)}var qE,xA=Te(()=>{ss();a(nx,"start");qE=class extends Ot{static{a(this,"Login")}static async get(t,r,s){}static async post(t,r,s){let{username:n,password:i,redirect:o}=r;return{data:await s.login(n,i)}}}});var xE=T((kne,$A)=>{"use strict";var{Readable:ix}=require("stream"),ox=1e4;$A.exports={streamAsJSON(e){return new GE({value:e})}};var GE=class extends ix{static{a(this,"JSONStream")}constructor(t){super(t),this.buffer=[],this.bufferSize=0,this.iterator=this.serialize(t.value,!0)}*serialize(t){if(t&&typeof t=="object"){let r=t[Symbol.asyncIterator],s=t[Symbol.iterator];if((s||r)&&!t.then){yield"[";let n=!0;if((r||s)&&!(t instanceof Array)){let i=r?t[Symbol.asyncIterator]():t[Symbol.iterator](),o;for(;;)if(o=i.next(),o.then&&(yield o.then(c=>(o=c,""))),o.done){yield"]";return}else n?n=!1:yield",",yield*this.serialize(o.value)}for(let i of t)n?n=!1:yield",",yield*this.serialize(i);yield"]";return}if(t.then)try{yield t.then(n=>this.serialize(n),kA)}catch(n){yield kA(n)}else yield JSON.stringify(t)}else yield JSON.stringify(t)}_read(){if(!this._amReading){if(this._amReading=!0,this.done)return this.push(null);VA(this.readIterator(this.iterator),t=>{t?(this.done=!0,this.push(null)):this._amReading=!1},t=>{console.error(t),this.done=!0,this.push(t.toString()),this.push(null)})}}push(t){return t===null||t instanceof Buffer?(this.bufferSize>0&&this.flush(),super.push(t)):(this.bufferSize+=t.length||t.toString().length,this.buffer.push(t),this.bufferSize>ox?this.flush():!0)}flush(){let t=super.push(this.buffer.join(""));return this.buffer=[],this.bufferSize=0,t}readIterator(t){try{let r;if(t.childIterator)return VA(this.readIterator(t.childIterator),s=>{if(s)return t.childIterator=null,this.readIterator(t)});do{let s=t.next();if(s.done)return!0;if(r=s.value,r==null)r="null";else{if(r.then)return this.flush(),Promise.resolve(r).then(n=>{if(n&&typeof n.return=="function")return t.childIterator=n,this.readIterator(t);if(this.push(n+""))return this.readIterator(t)});if(typeof r.return=="function")return t.childIterator=r,this.readIterator(t)}}while(this.push(r))}catch(r){return console.error(r),this.push(r.toString()),this.push(null),!0}}};function kA(e){return console.error(e),JSON.stringify(e.toString())}a(kA,"handleError");function VA(e,t,r){return e&&e.then?r?e.then(t,r):e.then(t):t(e)}a(VA,"when")});var sO=T((Yne,rO)=>{"use strict";var kE=require("recursive-iterator"),ax=require("alasql"),VE=require("clone"),YA=$(),{handleHDBError:KA,hdb_errors:cx}=j(),{HDB_ERROR_MSGS:WA,HTTP_STATUS_CODES:QA}=cx,{getDatabases:ux}=(fe(),Z(Ce)),lx=["DISTINCT_ARRAY"],zA=Symbol("validateTables"),$E=Symbol("validateTable"),$ne=Symbol("getAllColumns"),JA=Symbol("validateAllColumns"),gl=Symbol("findColumn"),XA=Symbol("validateOrderBy"),Fa=Symbol("validateSegment"),YE=Symbol("validateColumn"),jA=Symbol("setColumnsForTable"),ZA=Symbol("checkColumnsForAsterisk"),eO=Symbol("validateGroupBy"),tO=Symbol("hasColumns"),KE=class{static{a(this,"SelectValidator")}constructor(t){this.statement=t,this.attributes=[]}validate(){if(!this.statement)throw new Error("invalid sql statement");this[zA](),this[ZA](),this[JA]()}[zA](){if(this[tO]()){if(!this.statement.from||this.statement.from.length===0)throw"no from clause";this.statement.from.forEach(t=>{this[$E](t)}),this.statement.joins&&this.statement.joins.forEach(t=>{t.table.as=t.as,this[$E](t.table)})}}[tO](){let t=!1,r=new kE(this.statement);for(let{node:s,path:n}of r)if(s&&s.columnid){t=!0;break}return t}[$E](t){if(!t.databaseid)throw`schema not defined for table ${t.tableid}`;let r=ux();if(!r[t.databaseid])throw KA(new Error,WA.SCHEMA_NOT_FOUND(t.databaseid),QA.NOT_FOUND);if(!r[t.databaseid][t.tableid])throw KA(new Error,WA.TABLE_NOT_FOUND(t.databaseid,t.tableid),QA.NOT_FOUND);r[t.databaseid][t.tableid].attributes.forEach(n=>{let i=VE(n);i.table=VE(t),this.attributes.push(i)})}[gl](t){return this.attributes.filter(r=>t.tableid?(r.table.as===t.tableid||r.table.tableid===t.tableid)&&r.attribute===t.columnid:r.attribute===t.columnid)}[ZA](){let t=new kE(this.statement.columns);for(let{node:r,path:s}of t)r&&r.columnid==="*"&&s.indexOf("expression")<0&&this[jA](r.tableid)}[jA](t){this.attributes.forEach(r=>{(!t||t&&(r.table.tableid===t||r.table.as===t))&&this.statement.columns.push(new ax.yy.Column({columnid:r.attribute,tableid:r.table.as?r.table.as:r.table.tableid}))})}[JA](){this[Fa](this.statement.columns,!1),this[Fa](this.statement.joins,!1),this[Fa](this.statement.where,!1),this[eO](this.statement.group,!1),this[Fa](this.statement.order,!0)}[Fa](t,r){if(!t)return;let s=new kE(t),n=[];for(let{node:i,path:o}of s)!YA.isEmpty(i)&&!YA.isEmpty(i.columnid)&&i.columnid!=="*"&&(r?this[XA](i):n.push(this[YE](i)));return n}[eO](t){if(!t)return;let r=[];if(this.statement.columns.forEach(s=>{if(!(s.funcid&&lx.indexOf(s.funcid.toUpperCase())>=0)){if(!s.aggregatorid&&!s.columnid){let n=VE(s);delete n.as,r.push(n)}else if(s.columnid){let n=this[gl](s)[0];n&&r.push(n)}}}),this.statement.group.forEach(s=>{let n=null;if(!s.columnid)r.forEach((i,o)=>{if(i.toString()===s.toString()){n=i,r.splice(o,1);return}});else{let i=this[gl](s);if(!i||i.length===0)throw`unknown column '${s.toString()}' in group by`;if(i.length>1)throw`ambiguously defined column '${s.toString()}' in group by`;r.forEach((o,c)=>{if(o.attribute===i[0].attribute&&o.table.tableid===i[0].table.tableid){n=o,r.splice(c,1);return}})}if(!n)throw`group by column '${s.toString()}' must be in select`}),r.length>0)throw`select column '${r[0].attribute?r[0].attribute:r[0].toString()}' must be in group by`}[XA](t){let r=this.statement.columns.filter(s=>s.as===t.columnid);if(r.length>1)throw`ambiguous column reference ${(t.tableid?t.tableid+".":"")+t.columnid} in order by`;r.length===0&&this[YE](t)}[YE](t){let r=this[gl](t),s=(t.tableid?t.tableid+".":"")+t.columnid;if(r.length===0)throw`unknown column ${s}`;if(r.length>1)throw`ambiguous column reference ${s}`;return r[0]}};rO.exports=KE});var iO=T((Wne,nO)=>{"use strict";var WE=class{static{a(this,"BridgeMethods")}createSchema(){throw new Error("createSchema bridge method is not defined")}dropSchema(){throw new Error("dropSchema bridge method is not defined")}createTable(){throw new Error("createTable bridge method is not defined")}dropTable(){throw new Error("dropTable bridge method is not defined")}createRecords(){throw new Error("createRecords bridge method is not defined")}updateRecords(){throw new Error("updateRecords bridge method is not defined")}async upsertRecords(){throw new Error("upsertRecords bridge method is not defined")}deleteRecords(){throw new Error("deleteRecords bridge method is not defined")}createAttribute(){throw new Error("createAttribute bridge method is not defined")}dropAttribute(){throw new Error("dropAttribute bridge method is not defined")}searchByConditions(){throw new Error("searchByConditions bridge method is not defined")}searchByHash(){throw new Error("searchByHash bridge method is not defined")}searchByValue(){throw new Error("searchByValue bridge method is not defined")}getDataByHash(){throw new Error("getDataByHash bridge method is not defined")}getDataByValue(){throw new Error("getDataByValue bridge method is not defined")}deleteRecordsBefore(){throw new Error("deleteRecordsBefore bridge method is not defined")}deleteAuditLogsBefore(){throw new Error("deleteAuditLogsBefore bridge method is not defined")}async readAuditLog(){throw new Error("readAuditLog bridge method is not defined")}};nO.exports=WE});var aO=T((zne,oO)=>{"use strict";var QE=class{static{a(this,"DBIDefinition")}constructor(t=!1,r=!1){this.dup_sort=t,this.is_hash_attribute=r,this.useVersions=r}};oO.exports=QE});var gO={};qe(gO,{AUDIT_STORE_OPTIONS:()=>SO,createAuditEntry:()=>Ol,openAuditStore:()=>Al,readAuditEntry:()=>pr,setAuditRetention:()=>_x,transactionKeyEncoder:()=>pO});function Al(e){let t=e.auditStore=e.openDB(dO.AUDIT_STORE_NAME,SO);t.rootStore=e;let r=[];return t.addDeleteRemovalCallback=function(s,n){return r[s]=n,{remove(){delete r[s]}}},(0,EO.getWorkerIndex)()===0&&e.on("aftercommit",()=>{xa||(xa=setTimeout(()=>{if(xa=null,t.rootStore.status!=="closed")for(let{key:s,value:n}of t.getRange({start:0,end:Date.now()-zE})){if((n[0]&15)===XE){let i=pr(n),o=i.tableId;r[o]?.(i.recordId)}t.remove(s)}},zE/10).unref())}),t}function _x(e){clearTimeout(xa),xa=null,zE=e}function Ol(e,t,r,s,n,i,o){let c=TO[i],u=1;s&&(s>1?Ga.setFloat64(0,s):Cs.set(ZE),u=9),f(0),f(t),d(r),Ga.setFloat64(u,e),u+=8,n?d(n):Cs[u++]=0,Cs[s?8:0]=c;let l=Cs.subarray(0,u);if(o)return Buffer.concat([l,o]);return l;function d(E){let h=u;u+=1,u=(0,io.writeKey)(E,Cs,u),u>130||(Cs[h]=u-h-1)}function f(E){E<128?Cs[u++]=E:E<16384?(Ga.setUint16(u,E|32767),u+=2):E<1056964608?(Ga.setUint32(u,E|3489660927),u+=4):(Cs[u]=255,Ga.setUint32(u+1,E),u+=5)}}function pr(e){try{let t=e.dataView||(e.dataView=new jE(e.buffer,e.byteOffset,e.byteLength)),r;e[0]==66&&(r=t.readFloat64());let s=t.readInt(),n=t.readInt(),i=t.readInt(),o=t.readInt(),c=t.position,u=t.position+=o,_=t.readFloat64();o=t.readInt();let l=t.position,d=t.position+=o;return{type:TO[s&7],tableId:i,get recordId(){return _O(e,c,u)},version:_,previousLocalTime:r,get user(){return d>l?_O(e,l,d):void 0},getValue(f){return s&JE?f.decoder.decode(e.subarray(t.position)):void 0}}}catch{return mO.error("Reading audit entry error",e),{}}}function _O(e,t,r){let s=e.subarray(t,r);return(0,io.readKey)(s,0,r-t)}var io,Rl,dO,fO,EO,hO,mO,Cs,Ga,pO,SO,zE,xa,JE,cO,XE,uO,lO,TO,jE,oo=Te(()=>{io=require("ordered-binary"),Rl=U(X()),dO=U(ze()),fO=U(y()),EO=U(Je()),hO=U($());Va();mO=U(G());(0,Rl.initSync)();Cs=Buffer.alloc(1024),Ga=new DataView(Cs.buffer,Cs.byteOffset,1024),pO={writeKey(e,t,r){return e===ka?(t.set(ka,r),r+8):typeof e=="number"?((t.dataView||(t.dataView=new DataView(t.buffer,t.byteOffset,t.byteLength))).setFloat64(r,e),r+8):(0,io.writeKey)(e,t,r)},readKey(e,t,r){return e[t]===66?(e.dataView||(e.dataView=new DataView(e.buffer,e.byteOffset,e.byteLength))).getFloat64(t):(0,io.readKey)(e,t,r)}},SO={encoding:"binary",keyEncoder:pO},zE=(0,hO.convertToMS)((0,Rl.get)(fO.CONFIG_PARAMS.LOGGING_AUDITRETENTION))||86400*3,xa=null;a(Al,"openAuditStore");a(_x,"setAuditRetention");JE=16,cO=1,XE=2,uO=3,lO=4,TO={put:cO|JE,[cO]:"put",delete:XE,[XE]:"delete",message:uO|JE,[uO]:"message",invalidate:lO,[lO]:"invalidate"};a(Ol,"createAuditEntry");a(pr,"readAuditEntry");jE=class extends DataView{static{a(this,"Decoder")}position=0;readInt(){let t=this.getUint8(this.position++);return t>=128?t>=192?t===255?(t=this.getUint32(this.position-1)&3489660927,this.position+=4,t):(t=this.getUint32(this.position-1)&3489660927,this.position+=3,t):(t=this.getUint16(this.position-1)&32767,this.position++,t):t}readFloat64(){try{let t=this.getFloat64(this.position);return this.position+=8,t}catch{debugger}}};a(_O,"readKeySafely")});var yO={};qe(yO,{HAS_EXPIRATION:()=>ih,LAST_TIMESTAMP_PLACEHOLDER:()=>ka,LOCAL_TIMESTAMP:()=>dx,METADATA:()=>$a,NO_TIMESTAMP:()=>eh,PREVIOUS_TIMESTAMP_PLACEHOLDER:()=>ZE,RecordEncoder:()=>nh,TIMESTAMP_ASSIGN_LAST:()=>Ex,TIMESTAMP_ASSIGN_NEW:()=>OO,TIMESTAMP_ASSIGN_PREVIOUS:()=>NO,TIMESTAMP_PLACEHOLDER:()=>Nl,TIMESTAMP_RECORD_PREVIOUS:()=>th,getUpdateRecord:()=>oh,handleLocalTimeForGets:()=>Il});function bO(){return co[0]=co[0]^64,fx.getFloat64(0)}function Il(e){let t=e.getEntry;e.getEntry=function(i,o){let c=t.call(this,i,o),u=c?.value,_=u?.[$a];return _>=0&&(c.metadataFlags=_,c.localTime=u.localTime,c.value=u.value,u.expiresAt>0&&(c.expiresAt=u.expiresAt)),c};let r=e.get;e.get=function(i,o){let c=r.call(this,i,o);return c?.[$a]>=0?c.value:c};let s=e.getRange;e.getRange=function(i){let o=s.call(this,i);return i.valuesForKey?o.map(c=>c?.value):i.values===!1?o:o.map(c=>{let u=c.value,_=u[$a];return _>=0&&(c.metadataFlags=_,c.localTime=u.localTime,c.value=u.value,u.expiresAt>0&&(c.expiresAt=u.expiresAt)),c})},e.env.metadataRetriever||(e.env.metadataRetriever=!0,e.on("aftercommit",({next:i,last:o})=>{do{let c=i.meta,u=c&&c.store;if(u&&!(i.flag&67108864)){let _=u.cache;if(c.key){let l=hx.call(_,c.key);if(l&&l.timestampBytes){let d=l.timestampOffset;l.timestampBytes[d]===2&&(l.timestampBytes.copy(co,0,d),l.timestampBytes=null,l.localTime=bO())}}}}while(i!=o&&(i=i.next))}));let n=e.useReadTransaction();if(n.done(),!n.done.isTracked){n.done.isTracked=!0;let i=n.constructor,o=n.use,c=n.done;i.prototype.use=function(){this.timerTracked||(this.timerTracked=!0,mi.push(new WeakRef(this))),o.call(this)},i.prototype.done=function(){if(c.call(this),this.isDone)for(let u=0;u<mi.length;u++){let _=mi[u].deref();(!_||_===this||_.isDone||_.isCommitted)&&mi.splice(u--,1)}}}return e}function oh(e,t,r){return function(s,n,i,o,c=-1,u,_,l,d="put",f,E){if(f||u==null?ao=i?.localTime?th|NO:eh:ao=u?i?.localTime?th|16384:OO|16384:eh,l>0&&(c|=ih),yl=c,sh=l,i?.version===o&&u===!1)throw new Error("Must retain local time if version is not changed");let h={version:o,instructedWrite:ao>0},S;try{f&&(h.ifVersion=S=i?.version??null);let p=e.put(s,n,h);if(e.cache&&p.result!==!1){let g=e.cache.get(s);g&&(c>=0?g.metadataFlags=c:g.metadataFlags>=0&&(g.metadataFlags=void 0),(l||!g.expiresAt)&&(g.expiresAt=l),h.instructedWrite&&(g.localTime||(g.localTime=1),g.timestampBytes=rh,g.timestampOffset=rh.start||0))}if(u){let g=_?.user?.username;if(E&&(bl=e.encoder.encode(E)),f&&i?.localTime){let b=i?.localTime,O=r.get(b);if(O){let Y=pr(O).previousLocalTime;return r.put(b,Ol(o,t,s,Y,g,d,bl),{ifVersion:S}),p}}r.put(ka,Ol(o,t,s,i?.localTime?1:0,g,d,bl),{append:d!=="invalidate",instructedWrite:!0,ifVersion:S})}return p}catch(p){throw p.message+=" id: "+s+" options: "+h,p}}}var RO,AO,Nl,ka,ZE,dx,$a,co,fx,eh,OO,Ex,NO,th,ih,rh,bl,ao,yl,sh,nh,hx,mi,Va=Te(()=>{RO=require("msgpackr");oo();AO=U(G()),Nl=new Uint8Array([1,1,1,1,4,64,0,0]),ka=new Uint8Array([1,1,1,1,1,0,0,0]),ZE=new Uint8Array([1,1,1,1,3,64,0,0]),dx=Symbol("local-timestamp"),$a=Symbol("metadata"),co=new Uint8Array(8),fx=new DataView(co.buffer,0,8),eh=0,OO=0,Ex=1,NO=3,th=4,ih=16,ao=0,yl=-1,sh=0,nh=class extends RO.Encoder{static{a(this,"RecordEncoder")}constructor(t){super(t);let r=this.encode;this.encode=function(s,n){if(ao||yl>=0){let i=0,o=ao;o&&(i+=8,ao=0);let c=yl,u=sh;c>=0&&(i+=2,yl=-1,u&&(i+=8,sh=0));let _=rh=r.call(this,s,n|2048|i);bl=_.subarray((_.start||0)+i,_.end);let l=_.start||0;return o&&(Nl[4]=o,Nl[5]=o>>8,_.set(Nl,l),l+=8),c>=0&&(_[l++]=c,_[l++]=0,u&&(_.dataView||(_.dataView=new DataView(_.buffer,_.byteOffset,_.byteLength))).setFloat64(l,u)),_}else return r.call(this,s,n)}}decode(t,r){let s=r?.start||0,n=r>-1?r:r?.end||t.length,i=t[s],o=0;try{if(i<32&&n>2){let c=s,u;if(i===2){if(t.copy)t.copy(co,0,c),c+=8;else for(let d=0;d<8;d++)co[d]=t[c++];u=bO(),i=t[c]}let _;i<32&&(o=i,c+=2,o&ih&&(_=(t.dataView||(t.dataView=new DataView(t.buffer,t.byteOffset,t.byteLength))).getFloat64(c),c+=8));let l=super.decode(t.subarray(c,n),n-c);return{localTime:u,value:l,[$a]:o,expiresAt:_}}return super.decode(t,r)}catch(c){throw c.message+=", data: "+t.slice(0,40).toString("hex"),c}}};a(bO,"getTimestamp");hx=Map.prototype.get;a(Il,"handleLocalTimeForGets");mi=[];setInterval(()=>{for(let e=0;e<mi.length;e++){let t=mi[e].deref();!t||t.isDone||t.isCommitted?mi.splice(e--,1):t.notCurrent&&(t.openTimer?(t.openTimer>3&&AO.error("Read transaction detected that has been open too long (over one minute), make sure read transactions are quickly closed",t),t.openTimer++):t.openTimer=1)}},15e3).unref();a(oh,"getUpdateRecord")});var wl=T((tie,IO)=>{"use strict";var ch=X(),uh=y(),{RecordEncoder:mx}=(Va(),Z(yO));ch.initSync();var px=ch.get(uh.CONFIG_PARAMS.STORAGE_COMPRESSION),Sx=ch.get(uh.CONFIG_PARAMS.STORAGE_CACHING)!==!1,Tx=uh.UPDATES_PROPERTY,ah=class{static{a(this,"OpenDBIObject")}constructor(t,r=!1){this.dupSort=t===!0,this.encoding=t?"ordered-binary":"msgpack",this.useVersions=r,this.compression=px&&r&&{startingOffset:32},this.sharedStructuresKey=Symbol.for("structures"),r&&(this.cache=Sx&&{validated:!0},this.randomAccessStructure=!0,this.freezeData=!0,this.encoder={Encoder:mx},this.alwaysLazyProperty=s=>s===Tx)}};IO.exports=ah});var Ll=T((sie,CO)=>{"use strict";var uo=X(),Ya=y();uo.initSync();var gx=uo.get(Ya.CONFIG_PARAMS.STORAGE_WRITEASYNC)===!0||uo.get(Ya.CONFIG_PARAMS.STORAGE_WRITEASYNC)==="true"||uo.get(Ya.CONFIG_PARAMS.STORAGE_WRITEASYNC)==="TRUE",wO=uo.get(Ya.CONFIG_PARAMS.STORAGE_OVERLAPPINGSYNC),Rx=uo.get(Ya.CONFIG_PARAMS.STORAGE_NOREADAHEAD),Cl=class{static{a(this,"OpenEnvironmentObject")}constructor(t,r=!1){this.path=t,this.mapSize=1073741824,this.maxDbs=1e4,this.maxReaders=1e3,this.sharedStructuresKey=Symbol.for("structures"),this.readOnly=r,this.trackMetrics=!0,this.noSync=gx,this.noFSAccess=!0,wO!==void 0&&(this.overlappingSync=wO),this.noReadAhead=Rx}};CO.exports=Cl;Cl.MAX_DBS=1e4});var De=T((iie,FO)=>{"use strict";var _h=require("lmdb"),ns=require("fs-extra"),Sr=require("path"),Dl=Er(),UO=G(),Qt=fr().LMDB_ERRORS_ENUM,Ul=aO(),dh=wl(),MO=Ll(),Bn=ze(),LO=y(),{table:Ax,resetDatabases:Ox}=(fe(),Z(Ce)),DO=X(),is=Bn.INTERNAL_DBIS_NAME,PO=Bn.DBI_DEFINITION_NAME,Nx="data.mdb",bx="lock.mdb",Ka=".mdb",yx="-lock",lh=class{static{a(this,"TransactionCursor")}constructor(t,r,s=!1){this.dbi=Hr(t,r),this.key_type=this.dbi[Bn.DBI_DEFINITION_NAME].key_type,this.is_hash_attribute=this.dbi[Bn.DBI_DEFINITION_NAME].is_hash_attribute,this.txn=t.beginTxn({readOnly:s===!1}),this.cursor=new _h.Cursor(this.txn,this.dbi)}close(){this.cursor.close(),this.txn.abort()}commit(){this.cursor.close(),this.txn.commit()}};function Ml(e,t){if(e===void 0)throw new Error(Qt.BASE_PATH_REQUIRED);if(t===void 0)throw new Error(Qt.ENV_NAME_REQUIRED)}a(Ml,"pathEnvNameValidation");async function fh(e,t,r=!0){try{await ns.access(e)}catch(s){throw s.code==="ENOENT"?new Error(Qt.INVALID_BASE_PATH):s}try{let s=Sr.join(e,t+Ka);return await ns.access(s,ns.constants.R_OK|ns.constants.F_OK),s}catch(s){if(s.code==="ENOENT")if(r)try{return await ns.access(Sr.join(e,t,Nx),ns.constants.R_OK|ns.constants.F_OK),Sr.join(e,t)}catch(n){if(n.code==="ENOENT")throw new Error(Qt.INVALID_ENVIRONMENT)}else throw new Error(Qt.INVALID_ENVIRONMENT);throw s}}a(fh,"validateEnvironmentPath");function Pl(e,t){if(Dl.validateEnv(e),t===void 0)throw new Error(Qt.DBI_NAME_REQUIRED)}a(Pl,"validateEnvDBIName");async function Ix(e,t,r=!1,s=!1){Ml(e,t);let n=Sr.basename(e);t=t.toString();let i=DO.get(LO.CONFIG_PARAMS.DATABASES);i||DO.setProperty(LO.CONFIG_PARAMS.DATABASES,i={}),i[n]||(i[n]={}),i[n].path=e;try{return await fh(e,t,s),vO(e,t,r)}catch(o){if(o.message===Qt.INVALID_ENVIRONMENT){let c=Sr.join(e,t);await ns.mkdirp(s?c:e);let u=new MO(s?c:c+Ka,!1),_=_h.open(u);_.dbis=Object.create(null);let l=new dh(!1);_.openDB(is,l),global.lmdb_map===void 0&&(global.lmdb_map=Object.create(null));let d=Eh(e,t,r);return _[Bn.ENVIRONMENT_NAME_KEY]=d,global.lmdb_map[d]=_,_}throw o}}a(Ix,"createEnvironment");async function wx(e,t,r,s=!0){Ml(e,t),t=t.toString();let n=Sr.join(e,t);return Ax({table:t,database:Sr.parse(e).name,path:n,attributes:[{name:"id",isPrimaryKey:!0}]})}a(wx,"copyEnvironment");async function vO(e,t,r=!1){Ml(e,t),t=t.toString();let s=Eh(e,t,r);if(global.lmdb_map===void 0&&(global.lmdb_map=Object.create(null)),global.lmdb_map[s]!==void 0)return global.lmdb_map[s];let n=await fh(e,t),i=Sr.join(e,t+Ka),o=n!=i,c=new MO(n,o),u=_h.open(c);u.dbis=Object.create(null);let _=HO(u);for(let l=0;l<_.length;l++)Hr(u,_[l]);return u[Bn.ENVIRONMENT_NAME_KEY]=s,global.lmdb_map[s]=u,u}a(vO,"openEnvironment");async function Cx(e,t,r=!1){Ml(e,t),t=t.toString();let s=Sr.join(e,t+Ka),n=await fh(e,t);if(global.lmdb_map!==void 0){let i=Eh(e,t,r);if(global.lmdb_map[i]){let o=global.lmdb_map[i];await BO(o),delete global.lmdb_map[i]}}await ns.remove(n),await ns.remove(n===s?n+yx:Sr.join(Sr.dirname(n),bx))}a(Cx,"deleteEnvironment");async function BO(e){Dl.validateEnv(e);let t=e[Bn.ENVIRONMENT_NAME_KEY];await e.close(),t!==void 0&&global.lmdb_map!==void 0&&delete global.lmdb_map[t]}a(BO,"closeEnvironment");function Eh(e,t,r=!1){let n=`${Sr.basename(e)}.${t}`;return r===!0&&(n=`txn.${n}`),n}a(Eh,"getCachedEnvironmentName");function Lx(e){Dl.validateEnv(e);let t=Object.create(null),r=Hr(e,is);for(let{key:s,value:n}of r.getRange({start:!1}))if(s!==is)try{t[s]=Object.assign(new Ul,n)}catch{UO.warn(`an internal error occurred: unable to parse DBI Definition for ${s}`)}return t}a(Lx,"listDBIDefinitions");function HO(e){Dl.validateEnv(e);let t=[],r=Hr(e,is);for(let{key:s}of r.getRange({start:!1}))s!==is&&t.push(s);return t}a(HO,"listDBIs");function Dx(e,t){let s=Hr(e,is).getEntry(t),n=new Ul;if(s!==void 0){try{n=Object.assign(n,s.value)}catch{UO.warn(`an internal error occurred: unable to parse DBI Definition for ${s}`)}return n}}a(Dx,"getDBIDefinition");function qO(e,t,r,s=!r){if(Pl(e,t),t=t.toString(),t===is)throw new Error(Qt.CANNOT_CREATE_INTERNAL_DBIS_NAME);try{return Hr(e,t)}catch(n){if(n.message===Qt.DBI_DOES_NOT_EXIST){let i=new dh(r,s===!0),o=e.openDB(t,i),c=new Ul(r===!0,s);return o[PO]=c,Hr(e,is).putSync(t,c),e.dbis[t]=o,o}throw n}}a(qO,"createDBI");function Hr(e,t){if(Pl(e,t),t=t.toString(),e.dbis[t]!==void 0)return e.dbis[t];let r;if(t!==is?r=Dx(e,t):r=new Ul,r===void 0)throw new Error(Qt.DBI_DOES_NOT_EXIST);let s;try{let n=new dh(r.dup_sort,r.useVersions);if(s=e.openDB(t,n),s.db===void 0)throw new Error("MDB_NOTFOUND")}catch(n){throw n.message.includes("MDB_NOTFOUND")===!0?new Error(Qt.DBI_DOES_NOT_EXIST):n}return s[PO]=r,e.dbis[t]=s,s}a(Hr,"openDBI");function Ux(e,t){Pl(e,t),t=t.toString();let r=Hr(e,t),s=r.getStats();return r[Bn.DBI_DEFINITION_NAME].is_hash_attribute&&s.entryCount>0&&s.entryCount--,s}a(Ux,"statDBI");async function Mx(e,t){try{let r=Sr.join(e,t+Ka);return(await ns.stat(r)).size}catch{throw new Error(Qt.INVALID_ENVIRONMENT)}}a(Mx,"environmentDataSize");function Px(e,t){if(Pl(e,t),t=t.toString(),t===is)throw new Error(Qt.CANNOT_DROP_INTERNAL_DBIS_NAME);Hr(e,t).dropSync(),e.dbis!==void 0&&delete e.dbis[t],Hr(e,is).removeSync(t)}a(Px,"dropDBI");function vx(e,t,r){let s;for(let n=0;n<r.length;n++){let i=r[n];if(!e.dbis[i])try{Hr(e,i)}catch(o){if(o.message===Qt.DBI_DOES_NOT_EXIST)qO(e,i,i!==t,i===t),s=!0;else throw o}}s&&Ox()}a(vx,"initializeDBIs");FO.exports={openDBI:Hr,openEnvironment:vO,createEnvironment:Ix,listDBIs:HO,listDBIDefinitions:Lx,createDBI:qO,dropDBI:Px,statDBI:Ux,deleteEnvironment:Cx,initializeDBIs:vx,TransactionCursor:lh,environmentDataSize:Mx,copyEnvironment:wx,closeEnvironment:BO}});var xO=T((aie,GO)=>{"use strict";var hh=class{static{a(this,"InsertRecordsResponseObject")}constructor(t=[],r=[],s=void 0){this.written_hashes=t,this.skipped_hashes=r,this.txn_time=s}};GO.exports=hh});var VO=T((uie,kO)=>{"use strict";var mh=class{static{a(this,"UpdateRecordsResponseObject")}constructor(t=[],r=[],s=void 0,n=[]){this.written_hashes=t,this.skipped_hashes=r,this.txn_time=s,this.original_records=n}};kO.exports=mh});var YO=T((_ie,$O)=>{"use strict";var ph=class{static{a(this,"UpsertRecordsResponseObject")}constructor(t=[],r=void 0,s=[]){this.written_hashes=t,this.txn_time=r,this.original_records=s}};$O.exports=ph});var lo=T((mie,QO)=>{"use strict";var Bx=De(),Hx=xO(),qx=VO(),Fx=YO(),Ls=Er(),Wa=fr().LMDB_ERRORS_ENUM,Gx=ze(),tn=y(),xx=$(),kx=require("uuid"),fie=require("lmdb"),{handleHDBError:Vx,hdb_errors:$x}=j(),{OVERFLOW_MARKER:Eie,MAX_SEARCH_KEY_LENGTH:hie}=Gx,KO=X();KO.initSync();var vl=KO.get(tn.CONFIG_PARAMS.STORAGE_PREFETCHWRITES),Sh=tn.TIME_STAMP_NAMES_ENUM.CREATED_TIME,pi=tn.TIME_STAMP_NAMES_ENUM.UPDATED_TIME;async function Yx(e,t,r,s,n=Ls.getNextMonotonicTime()){Ah(e,t,r,s),Th(e,t,r);let i=new Hx,o=[],c=[];for(let u=0;u<s.length;u++){let _=s[u];WO(_,!0,n);let l=Kx(e,t,r,_),d=_[t];o.push(l),c.push(d)}return gh(o,c,s,i,n)}a(Yx,"insertRecords");function Kx(e,t,r,s){let n=s[t];return e.dbis[t].ifNoExists(n,()=>{for(let i=0;i<r.length;i++){let o=r[i];if(o===t||s.hasOwnProperty(o)===!1)continue;let c=s[o];if(typeof c=="function"){let l=c([[{}]]);Array.isArray(l)&&(c=l[0][tn.FUNC_VAL],s[o]=c)}let u=Ls.getIndexedValues(c),_=e.dbis[o];if(u){vl&&_.prefetch(u.map(l=>({key:l,value:n})),Bl);for(let l=0,d=u.length;l<d;l++)_.put(u[l],n)}}vl&&e.dbis[t].prefetch([n],Bl),e.dbis[t].put(n,s,s[pi])})}a(Kx,"insertRecord");function Wx(e,t=[]){let r=0;for(let s=0;s<t.length;s++){let n=t[s];e.splice(n-r,1),r++}}a(Wx,"removeSkippedRecords");function WO(e,t,r){let s=r>0;(s||!Number.isInteger(e[pi]))&&(e[pi]=r||(r=Ls.getNextMonotonicTime())),t===!0?(s||!Number.isInteger(e[Sh]))&&(e[Sh]=r||Ls.getNextMonotonicTime()):delete e[Sh]}a(WO,"setTimestamps");function Th(e,t,r){r.indexOf(tn.TIME_STAMP_NAMES_ENUM.CREATED_TIME)<0&&r.push(tn.TIME_STAMP_NAMES_ENUM.CREATED_TIME),r.indexOf(tn.TIME_STAMP_NAMES_ENUM.UPDATED_TIME)<0&&r.push(tn.TIME_STAMP_NAMES_ENUM.UPDATED_TIME),Bx.initializeDBIs(e,t,r)}a(Th,"initializeTransaction");async function Qx(e,t,r,s,n=Ls.getNextMonotonicTime()){Ah(e,t,r,s),Th(e,t,r);let i=new qx,o=[],c=[],u=[];for(let _=0;_<s.length;_++){let l=s[_],d=l[t],f;try{f=Rh(e,t,l,d,i,!0,n)}catch{i.skipped_hashes.push(d),o.push(_);continue}c.push(f),u.push(d)}return gh(c,u,s,i,n,o)}a(Qx,"updateRecords");async function zx(e,t,r,s,n=Ls.getNextMonotonicTime()){try{Ah(e,t,r,s)}catch(u){throw Vx(u,u.message,$x.HTTP_STATUS_CODES.BAD_REQUEST)}Th(e,t,r);let i=new Fx,o=[],c=[];for(let u=0;u<s.length;u++){let _=s[u],l;xx.isEmpty(_[t])?(l=kx.v4(),_[t]=l):l=_[t];let d=Rh(e,t,_,l,i,!1,n);o.push(d),c.push(l)}return gh(o,c,s,i,n)}a(zx,"upsertRecords");async function gh(e,t,r,s,n,i=[]){let o=await Promise.all(e);for(let c=0,u=o.length;c<u;c++)o[c]===!0?s.written_hashes.push(t[c]):(s.skipped_hashes.push(t[c]),i.push(c));return s.txn_time=n||Ls.getNextMonotonicTime(),Wx(r,i),s}a(gh,"finalizeWrite");function Rh(e,t,r,s,n,i=!1,o){let c=e.dbis[t],u=c.getEntry(s),_=u?.value,l=_;if(!_){if(i)return!1;_={}}if(WO(r,!l,o),Number.isInteger(r[pi])&&_[pi]>r[pi])return!1;l&&n.original_records.push(_);let d,f=a(()=>{for(let h in r){if(!r.hasOwnProperty(h)||h===t)continue;let S=r[h],p=e.dbis[h];if(p===void 0)continue;let g=_[h];if(typeof S=="function"){let O=S([[_]]);Array.isArray(O)&&(S=O[0][tn.FUNC_VAL],r[h]=S)}if(S===g)continue;let b=Ls.getIndexedValues(g);if(b){vl&&p.prefetch(b.map(O=>({key:O,value:s})),Bl);for(let O=0,Y=b.length;O<Y;O++)p.remove(b[O],s)}if(b=Ls.getIndexedValues(S),b){vl&&p.prefetch(b.map(O=>({key:O,value:s})),Bl);for(let O=0,Y=b.length;O<Y;O++)p.put(b[O],s)}}let E=Object.assign({},_,r);c.put(s,E,E[pi])},"do_put");return u?d=c.ifVersion(s,u.version,f):d=c.ifNoExists(s,f),d.then(E=>E?!0:Rh(e,t,r,s,n,i,o))}a(Rh,"updateUpsertRecord");function Jx(e,t,r){if(Ls.validateEnv(e),t===void 0)throw new Error(Wa.HASH_ATTRIBUTE_REQUIRED);if(!Array.isArray(r))throw r===void 0?new Error(Wa.WRITE_ATTRIBUTES_REQUIRED):new Error(Wa.WRITE_ATTRIBUTES_MUST_BE_ARRAY)}a(Jx,"validateBasic");function Ah(e,t,r,s){if(Jx(e,t,r),!Array.isArray(s))throw s===void 0?new Error(Wa.RECORDS_REQUIRED):new Error(Wa.RECORDS_MUST_BE_ARRAY)}a(Ah,"validateWrite");function Bl(){}a(Bl,"noop");QO.exports={insertRecords:Yx,updateRecords:Qx,upsertRecords:zx}});var Si=T((Sie,Xx)=>{Xx.exports={hdb_table:{hash_attribute:"id",name:"hdb_table",schema:"system",residence:["*"],attributes:[{attribute:"id"},{attribute:"name"},{attribute:"hash_attribute"},{attribute:"schema"},{attribute:"residence"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_attribute:{hash_attribute:"id",name:"hdb_attribute",schema:"system",residence:["*"],attributes:[{attribute:"id"},{attribute:"schema"},{attribute:"table"},{attribute:"attribute"},{attribute:"schema_table"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_schema:{hash_attribute:"name",name:"hdb_schema",schema:"system",residence:["*"],attributes:[{attribute:"name"},{attribute:"createddate"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_user:{hash_attribute:"username",name:"hdb_user",schema:"system",residence:["*"],attributes:[{attribute:"username"},{attribute:"password"},{attribute:"role"},{attribute:"active"},{attribute:"hash"},{attribute:"refresh_token"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_role:{hash_attribute:"id",name:"hdb_role",schema:"system",attributes:[{attribute:"id"},{attribute:"role"},{attribute:"permission"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}],residence:["*"]},hdb_job:{hash_attribute:"id",name:"hdb_job",schema:"system",attributes:[{attribute:"id"},{attribute:"user"},{attribute:"type"},{attribute:"status"},{attribute:"start_datetime"},{attribute:"end_datetime"},{attribute:"message"},{attribute:"created_datetime"},{attribute:"request"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_license:{hash_attribute:"license_key",name:"hdb_license",schema:"system",attributes:[{attribute:"license_key"},{attribute:"company"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_info:{hash_attribute:"info_id",name:"hdb_info",schema:"system",attributes:[{attribute:"info_id"},{attribute:"data_version_num"},{attribute:"hdb_version_num"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_nodes:{hash_attribute:"name",name:"hdb_nodes",schema:"system",attributes:[{attribute:"name"},{attribute:"subscriptions"},{attribute:"system_info"},{attribute:"__createdtime__"},{attribute:"__updatedtime__"}]},hdb_analytics:{hash_attribute:"id",name:"hdb_analytics",schema:"system",audit:!1,attributes:[{attribute:"id"},{attribute:"time"},{attribute:"metric"}]},hdb_raw_analytics:{hash_attribute:"id",name:"hdb_raw_analytics",schema:"system",audit:!1,attributes:[{attribute:"id"},{attribute:"time"},{attribute:"metrics"}]},hdb_temp:{hash_attribute:"id",name:"hdb_temp",schema:"system",attributes:[{attribute:"id"}]}}});var Ds=T((Tie,XO)=>{"use strict";var JO=$(),zO=y(),_o=/^[\x20-\x2E|\x30-\x5F|\x61-\x7E]*$/,rn=require("joi"),Hn={schema_format:{pattern:_o,message:"names cannot include backticks or forward slashes"},schema_length:{minimum:1,maximum:250,tooLong:"cannot exceed 250 characters"}},jx=rn.alternatives(rn.string().min(1).max(Hn.schema_length.maximum).pattern(_o).messages({"string.pattern.base":"{:#label} "+Hn.schema_format.message}),rn.number()).required(),Zx=rn.alternatives(rn.string().min(1).max(Hn.schema_length.maximum).pattern(_o).messages({"string.pattern.base":"{:#label} "+Hn.schema_format.message}),rn.number()),ek=rn.alternatives(rn.string().min(1).max(Hn.schema_length.maximum).pattern(_o).messages({"string.pattern.base":"{:#label} "+Hn.schema_format.message}),rn.number()).required();function tk(e,t){return t?typeof t!="string"?`'${e}' must be a string`:t.length?t.length>Hn.schema_length.maximum?`'${e}' maximum of 250 characters`:_o.test(t)?"":`'${e}' has illegal characters`:`'${e}' must be at least one character`:`'${e}' is required`}a(tk,"checkValidTable");function rk(e,t){return JO.doesSchemaExist(e)?e:t.message(`Database '${e}' does not exist`)}a(rk,"validateSchemaExists");function sk(e,t){let r=t.state.ancestors[0].schema;return JO.doesTableExist(r,e)?e:t.message(`Table '${e}' does not exist`)}a(sk,"validateTableExists");function nk(e,t){return e.toLowerCase()===zO.SYSTEM_SCHEMA_NAME?t.message(`'subscriptions[${t.state.path[1]}]' invalid database name, '${zO.SYSTEM_SCHEMA_NAME}' name is reserved`):e}a(nk,"validateSchemaName");XO.exports={common_validators:Hn,schema_regex:_o,hdb_schema_table:jx,validateSchemaExists:rk,validateTableExists:sk,validateSchemaName:nk,checkValidTable:tk,hdb_database:Zx,hdb_table:ek}});var ke=T((Rie,jO)=>{"use strict";var zt=require("validate.js");zt.validators.type=function(e,t,r,s){return e===null||typeof e>"u"||zt.validators.type.checks[t](e)?null:` must be a '${t}' value`};zt.validators.type.checks={Object:function(e){return zt.isObject(e)&&!zt.isArray(e)},Array:zt.isArray,Integer:zt.isInteger,Number:zt.isNumber,String:zt.isString,Date:zt.isDate,Boolean:function(e){return typeof e=="boolean"}};zt.validators.hasValidFileExt=function(e,t){return zt.isString(e)?e===""?"can't be blank":t.filter(r=>e.endsWith(r)).length>0?null:`must include one of the following valid file extensions - '${t.join("', '")}'`:null};jO.exports={validateObject:ik,validateObjectAsync:ok,validateBySchema:ak};function ik(e,t){if(!e||!t)return new Error("validateObject parameters were null");let r=zt(e,t,{format:"flat"});return r?new Error(r):null}a(ik,"validateObject");async function ok(e,t){if(!e||!t)return new Error("validateObject parameters were null");try{await zt.async(e,t,{format:"flat"})}catch(r){let s=r.join(",");return new Error(s)}return null}a(ok,"validateObjectAsync");function ak(e,t){let r=t.validate(e,{allowUnknown:!0,abortEarly:!1,errors:{wrap:{label:"'"}}});if(r.error)return new Error(r.error.message)}a(ak,"validateBySchema")});var Hl=T((Oie,ZO)=>{var{common_validators:Us}=Ds(),za=ke(),Qa="is required",tt={database:{presence:!1,format:Us.schema_format,length:Us.schema_length},schema:{presence:!1,format:Us.schema_format,length:Us.schema_length},table:{presence:!0,format:Us.schema_format,length:Us.schema_length},attribute:{presence:!0,format:Us.schema_format,length:Us.schema_length},hash_attribute:{presence:!0,format:Us.schema_format,length:Us.schema_length}};function Ja(e){for(let t in e)e[t]=e[t]===null||e[t]===void 0||typeof e[t]=="object"?e[t]:e[t].toString();return e}a(Ja,"makeAttributesStrings");function ck(e){return e=Ja(e),tt.table.presence=!1,tt.attribute.presence=!1,tt.hash_attribute.presence=!1,za.validateObject(e,tt)}a(ck,"schema_object");function uk(e){return e=Ja(e),tt.table.presence={message:Qa},tt.attribute.presence=!1,tt.hash_attribute.presence=!1,za.validateObject(e,tt)}a(uk,"table_object");function lk(e){return e=Ja(e),tt.table.presence={message:Qa},tt.attribute.presence=!1,za.validateObject(e,tt)}a(lk,"create_table_object");function _k(e){return e=Ja(e),tt.table.presence={message:Qa},tt.attribute.presence={message:Qa},tt.hash_attribute.presence=!1,za.validateObject(e,tt)}a(_k,"attribute_object");function dk(e){return e=Ja(e),tt.table.presence={message:Qa},tt.attribute.presence=!1,tt.hash_attribute.presence=!1,za.validateObject(e,tt)}a(dk,"describe_table");function fk(e){if(e){if(!Array.isArray(e))throw new Error("residence must be a string array");if(e.length===0)throw new Error("residence cannot be an empty array");for(let t=0;t<e.length;t++)if(typeof e[t]!="string")throw new Error(`residence must be a string array, item '${e[t]}' is not a string`)}}a(fk,"validateTableResidence");ZO.exports={schema_object:ck,create_table_object:lk,table_object:uk,attribute_object:_k,describe_table:dk,validateTableResidence:fk}});var tN=T((bie,eN)=>{"use strict";var Ek=require("uuid"),Oh=class{static{a(this,"CreateAttributeObject")}constructor(t,r,s,n){this.schema=t,this.table=r,this.attribute=s,this.id=n||Ek.v4(),this.schema_table=`${this.schema}.${this.table}`}};eN.exports=Oh});var ql=T((Iie,rN)=>{"use strict";var hk=tN(),Nh=class extends hk{static{a(this,"LMDBCreateAttributeObject")}constructor(t,r,s,n,i=!0,o=!1){super(t,r,s,n),this.dup_sort=i,this.is_hash_attribute=o}};rN.exports=Nh});var nN=T((Cie,sN)=>{"use strict";sN.exports=pk;var mk="inserted";function pk(e,t,r,s){let n={message:`${e} ${t.length} of ${r.records.length} records`,skipped_hashes:s};return e===mk?(n.inserted_hashes=t,n):(n.update_hashes=t,n)}a(pk,"returnObject")});var Fl=T((Die,uN)=>{"use strict";var Sk=y(),bh=De(),Tk=lo(),{getSystemSchemaPath:gk,getSchemaPath:Rk}=ve(),Ak=Si(),Ok=Hl(),Nk=ql(),bk=nN(),{handleHDBError:iN,hdb_errors:aN}=j(),oN=$(),{HTTP_STATUS_CODES:yk}=aN,yh=Ak.hdb_attribute,cN=[];for(let e=0;e<yh.attributes.length;e++)cN.push(yh.attributes[e].attribute);var Ik="inserted";uN.exports=wk;async function wk(e){let t=Ok.attribute_object(e);if(t)throw iN(new Error,t.message,aN.HTTP_STATUS_CODES.BAD_REQUEST,void 0,void 0,!0);let r=!e.skip_table_check&&oN.checkGlobalSchemaTable(e.schema,e.table);if(r)throw iN(new Error,r,yk.NOT_FOUND);e.is_hash_attribute=e.is_hash_attribute=="true",e.dup_sort=oN.isEmpty(e.dup_sort)||e.dup_sort=="true";let s=[];if(global.hdb_schema[e.schema]&&global.hdb_schema[e.schema][e.table]&&(s=global.hdb_schema[e.schema][e.table].attributes),Array.isArray(s)&&s.length>0){for(let i of s)if(i.attribute===e.attribute)throw new Error(`attribute '${i.attribute}' already exists in ${e.schema}.${e.table}`)}let n=new Nk(e.schema,e.table,e.attribute,e.id);try{let i=await bh.openEnvironment(Rk(e.schema,e.table),e.table);if(i.dbis[e.attribute]!==void 0)throw new Error(`attribute '${e.attribute}' already exists in ${e.schema}.${e.table}`);bh.createDBI(i,e.attribute,e.dup_sort,e.is_hash_attribute);let o=await bh.openEnvironment(gk(),Sk.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME),{written_hashes:c,skipped_hashes:u}=await Tk.insertRecords(o,yh.hash_attribute,cN,[n]);return bk(Ik,c,{records:[n]},u)}catch(i){throw i}}a(wk,"lmdbCreateAttribute")});var wh=T((Mie,_N)=>{var{hdb_table:Ck,hdb_database:lN}=Ds(),Lk=ke(),Ih=require("joi"),Dk={undefined:"undefined",null:"null"},Uk=a((e,t)=>{let r=Object.keys(e),s=r.length,n;for(let i=0;i<s;i++){let o=r[i];(!o||o.length===0||Dk[o]!==void 0)&&(n===void 0?n=`Invalid attribute name: '${o}'`:n+=`. Invalid attribute name: '${o}'`)}return n?t.message(n):e},"custom_records_val"),Mk=Ih.object({database:lN,schema:lN,table:Ck,records:Ih.array().items(Ih.object().custom(Uk)).required()});_N.exports=function(e){return Lk.validateBySchema(e,Mk)}});var Xa=T((Bie,fN)=>{"use strict";var sn=$(),dN=G(),vie=wh(),{getDatabases:Pk}=(fe(),Z(Ce)),{ClientError:Ti}=j();fN.exports=vk;function vk(e){if(sn.isEmpty(e))throw new Ti("invalid update parameters defined.");if(sn.isEmptyOrZeroLength(e.schema))throw new Ti("invalid schema specified.");if(sn.isEmptyOrZeroLength(e.table))throw new Ti("invalid table specified.");if(!Array.isArray(e.records))throw new Ti("records must be an array");let t=Pk()[e.schema]?.[e.table];if(sn.isEmpty(t))throw new Ti(`could not retrieve schema:${e.schema} and table ${e.table}`);let r=t.primaryKey,s=new Set,n={},i=!1;return e.operation==="update"&&(i=!0),e.records.forEach(o=>{if(i&&sn.isEmptyOrZeroLength(o[r]))throw dN.error("a valid hash attribute must be provided with update record:",o),new Ti("a valid hash attribute must be provided with update record, check log for more info");if(!sn.isEmptyOrZeroLength(o[r])&&(o[r]==="null"||o[r]==="undefined"))throw dN.error(`a valid hash value must be provided with ${e.operation} record:`,o),new Ti(`Invalid hash value: '${o[r]}' is not a valid hash attribute value, check log for more info`);!sn.isEmpty(o[r])&&o[r]!==""&&s.has(sn.autoCast(o[r]))&&(o.skip=!0),s.add(sn.autoCast(o[r]));for(let c in o)n[c]=1}),n[r]=1,{schema_table:t,hashes:Array.from(s),attributes:Object.keys(n)}}a(vk,"insertUpdateValidate")});var ja=T((qie,EN)=>{"use strict";var Bk=y().OPERATIONS_ENUM,Ch=class{static{a(this,"InsertObject")}constructor(t,r,s,n,i=void 0){this.operation=Bk.INSERT,this.schema=t,this.table=r,this.hash_attribute=s,this.records=n,this.__origin=i}};EN.exports=Ch});var rc=T((xie,hN)=>{"use strict";var Gie=ja(),Gl=y(),Dh=$(),Lh=G(),Hk=require("uuid"),{handleHDBError:Za,hdb_errors:qk}=j(),{HDB_ERROR_MSGS:ec,HTTP_STATUS_CODES:tc}=qk;hN.exports=Fk;function Fk(e,t,r){for(let n=0;n<t.length;n++)Gk(t[n]);let{records:s}=e;for(let n=0;n<s.length;n++){let i=s[n];xk(i,r,e.operation)}}a(Fk,"processRows");function Gk(e){if(Buffer.byteLength(String(e))>Gl.INSERT_MODULE_ENUM.MAX_CHARACTER_SIZE)throw Za(new Error,ec.ATTR_NAME_LENGTH_ERR(e),tc.BAD_REQUEST,void 0,void 0,!0);if(Dh.isEmptyOrZeroLength(e)||Dh.isEmpty(e.trim()))throw Za(new Error,ec.ATTR_NAME_NULLISH_ERR,tc.BAD_REQUEST,void 0,void 0,!0)}a(Gk,"validateAttribute");function xk(e,t,r){if(!e.hasOwnProperty(t)||Dh.isEmptyOrZeroLength(e[t])){if(r===Gl.OPERATIONS_ENUM.INSERT||r===Gl.OPERATIONS_ENUM.UPSERT){e[t]=Hk.v4();return}throw Lh.error("Update transaction aborted due to record with no hash value:",e),Za(new Error,ec.RECORD_MISSING_HASH_ERR,tc.BAD_REQUEST,void 0,void 0,!0)}if(Buffer.byteLength(String(e[t]))>Gl.INSERT_MODULE_ENUM.MAX_CHARACTER_SIZE)throw Lh.error(e),Za(new Error,ec.HASH_VAL_LENGTH_ERR,tc.BAD_REQUEST,void 0,void 0,!0);if(isNaN(e[t])&&e[t].includes("/"))throw Lh.error(e),Za(new Error,ec.INVALID_FORWARD_SLASH_IN_HASH_ERR,tc.BAD_REQUEST,void 0,void 0,!0)}a(xk,"validateHash")});var pN=T((Vie,mN)=>{"use strict";var Uh=class{static{a(this,"ITCEventObject")}constructor(t,r){this.type=t,this.message=r}};mN.exports=Uh});var gN=T((Yie,TN)=>{"use strict";var Mh=De(),kk=G(),SN=fr().LMDB_ERRORS_ENUM;TN.exports=Vk;async function Vk(e){try{if(global.lmdb_map!==void 0&&e.operation!==void 0){let t=Object.keys(global.lmdb_map),r;switch(e.operation){case"drop_schema":for(let i=0;i<t.length;i++){let o=t[i];if(o.startsWith(`${e.schema}.`)||o.startsWith(`txn.${e.schema}.`))try{await Mh.closeEnvironment(global.lmdb_map[o])}catch(c){if(c.message!==SN.ENV_REQUIRED)throw c}}break;case"drop_table":let s=`${e.schema}.${e.table}`,n=`txn.${s}`;try{await Mh.closeEnvironment(global.lmdb_map[s]),await Mh.closeEnvironment(global.lmdb_map[n])}catch(i){if(i.message!==SN.ENV_REQUIRED)throw i}break;case"drop_attribute":r=global.lmdb_map[`${e.schema}.${e.table}`],r!==void 0&&typeof r.dbis=="object"&&r.dbis[`${e.attribute}`]!==void 0&&delete r.dbis[`${e.attribute}`];break;default:break}}}catch(t){kk.error(t)}}a(Vk,"cleanLMDBMap")});var nn=T((Wie,NN)=>{"use strict";var sc=require("crypto"),$k=X(),{CONFIG_PARAMS:Yk}=y(),AN="aes-256-cbc",Kk=32,Wk=16,Ph=64,ON=32,Qk=Ph+ON,RN=new Map;NN.exports={encrypt:zk,decrypt:Jk,createNatsTableStreamName:Xk};function zk(e){let t=sc.randomBytes(Kk),r=sc.randomBytes(Wk),s=sc.createCipheriv(AN,Buffer.from(t),r),n=s.update(e);n=Buffer.concat([n,s.final()]);let i=t.toString("hex"),o=r.toString("hex"),c=n.toString("hex");return i+o+c}a(zk,"encrypt");function Jk(e){let t=e.substr(0,Ph),r=e.substr(Ph,ON),s=e.substr(Qk,e.length),n=Buffer.from(r,"hex"),i=Buffer.from(s,"hex"),o=sc.createDecipheriv(AN,Buffer.from(t,"hex"),n),c=o.update(i);return c=Buffer.concat([c,o.final()]),c.toString()}a(Jk,"decrypt");function Xk(e,t){let r=$k.get(Yk.CLUSTERING_DATABASELEVEL)?e:`${e}.${t}`,s=RN.get(r);return s||(s=sc.createHash("md5").update(r).digest("hex"),RN.set(r,s)),s}a(Xk,"createNatsTableStreamName")});var gi=T((Jie,yN)=>{"use strict";var zie=qr(),xl=G(),bN=Hl(),jk=nn(),kl=$(),{handleHDBError:Vl,hdb_errors:Zk}=j(),{HDB_ERROR_MSGS:$l,HTTP_STATUS_CODES:vh}=Zk,eV=X();eV.initSync();var{getDatabases:Bh}=(fe(),Z(Ce));yN.exports={describeAll:tV,describeTable:Yl,describeSchema:rV};async function tV(e){try{let t=kl.isEmptyOrZeroLength(e),r,s;t||(r=e.hdb_user.role.permission,s=r.super_user||r.cluster_user);let n=Bh(),i={},o={},c=[],u=e?.exact_count;for(let l in n){i[l]=!0,!t&&!s&&(o[l]=e.hdb_user.role.permission[l].describe);let d=n[l];for(let f in d)try{let E;if(t||s)E=await Yl({schema:l,table:f,exact_count:u});else if(r&&r[l].describe&&r[l].tables[f].describe){let h=r[l].tables[f].attribute_permissions;E=await Yl({schema:l,table:f,exact_count:u},h)}E&&c.push(E)}catch(E){xl.error(E)}}let _={};for(let l in c)t||s?(_[c[l].schema]==null&&(_[c[l].schema]={}),_[c[l].schema][c[l].name]=c[l],i[c[l].schema]&&delete i[c[l].schema]):o[c[l].schema]&&(_[c[l].schema]==null&&(_[c[l].schema]={}),_[c[l].schema][c[l].name]=c[l],i[c[l].schema]&&delete i[c[l].schema]);for(let l in i)t||s?_[l]={}:o[l]&&(_[l]={});return _}catch(t){return xl.error("Got an error in describeAll"),xl.error(t),Vl(new Error,$l.DESCRIBE_ALL_ERR)}}a(tV,"describeAll");async function Yl(e,t){kl.transformReq(e);let{schema:r,table:s}=e;r=r?.toString(),s=s?.toString();let n=t;e.hdb_user&&!e.hdb_user.role.permission.super_user&&(n=e.hdb_user.role.permission[r].tables[s].attribute_permissions);let i=bN.describe_table(e);if(i)throw i;let c=Bh()[r];if(!c)throw Vl(new Error,$l.SCHEMA_NOT_FOUND(e.schema),vh.NOT_FOUND);let u=c[s];if(!u)throw Vl(new Error,$l.TABLE_NOT_FOUND(e.schema,e.table),vh.NOT_FOUND);function _(f){l.push(Object.assign({},{attribute:f.attribute,type:f.type,elements:f.elements?.type,indexed:f.indexed,is_primary_key:f.isPrimaryKey,assigned_created_time:f.assignCreatedTime,assigned_updated_time:f.assignUpdatedTime,nullable:f.nullable,properties:f.properties?f.properties.map(E=>({type:E.type,name:E.name})):void 0}))}a(_,"pushAtt");let l=[];if(n){let f={};n.forEach(E=>{E.describe&&(f[E.attribute_name]=!0)}),u.attributes.forEach(E=>{f[E.name]&&_(E)})}else u.attributes?.forEach(f=>_(f));let d={schema:r,name:u.tableName,hash_attribute:u.attributes.find(f=>f.isPrimaryKey||f.is_hash_attribute)?.name,audit:u.audit,schema_defined:u.schemaDefined,attributes:l};d.clustering_stream_name=jk.createNatsTableStreamName(d.schema,d.name);try{let f=u.getRecordCount({exactCount:e.exact_count==="true"});d.record_count=f.recordCount,d.estimated_record_range=f.estimatedRange;let E=u.auditStore;if(E)for(let h of E.getKeys({reverse:!0,limit:1}))d.last_updated_record=h[0];if(!d.last_updated_record&&u.indices.__updatedtime__)for(let h of u.indices.__updatedtime__.getKeys({reverse:!0,limit:1}))d.last_updated_record=h}catch(f){xl.warn(`unable to stat table dbi due to ${f}`)}return d}a(Yl,"descTable");async function rV(e){kl.transformReq(e);let t=bN.schema_object(e);if(t)throw t;let r;e.hdb_user&&!e.hdb_user.role.permission.super_user&&(r=e.hdb_user.role.permission[e.schema]);let s=e.schema.toString(),i=Bh()[s];if(!i)throw Vl(new Error,$l.SCHEMA_NOT_FOUND(e.schema),vh.NOT_FOUND);let o={};for(let c in i){let u;if(r&&r.tables[c]&&(u=r.tables[c]),kl.isEmpty(u)||u.describe){let _=await Yl({schema:e.schema,table:c,exact_count:e.exact_count},u?u.attribute_permissions:null);_&&(o[_.name]=_)}}return o}a(rV,"describeSchema")});var qn=T((eoe,DN)=>{var sV=Si(),{callbackify:wN,promisify:nV}=require("util"),{getDatabases:CN}=(fe(),Z(Ce));DN.exports={setSchemaDataToGlobal:IN,getTableSchema:iV,getSystemSchema:oV,setSchemaDataToGlobalAsync:nV(IN)};var LN=gi(),jie=wN(LN.describeAll),Zie=wN(LN.describeTable);function IN(e){global.hdb_schema=CN(),e&&e()}a(IN,"setSchemaDataToGlobal");function iV(e,t,r){let s=CN()[e];if(!s)return r(`schema ${e} does not exist`);let n=s[t];return n?r(null,{schema:e,name:t,hash_attribute:n.primaryKey}):r(`table ${e}.${t} does not exist`)}a(iV,"getTableSchema");function oV(){return sV}a(oV,"getSystemSchema")});var Fr=T((roe,vN)=>{"use strict";var Wl=wh(),Nt=$(),aV=require("util"),Ql=os(),cV=qn(),UN=G(),{handleHDBError:Ri,hdb_errors:uV}=j(),{HTTP_STATUS_CODES:Ai}=uV,lV=aV.promisify(cV.getTableSchema),_V="updated",MN="inserted",PN="upserted";vN.exports={insert:fV,update:EV,upsert:hV,validation:dV,flush:mV};async function dV(e){if(Nt.isEmpty(e))throw new Error("invalid update parameters defined.");if(Nt.isEmptyOrZeroLength(e.schema))throw new Error("invalid database specified.");if(Nt.isEmptyOrZeroLength(e.table))throw new Error("invalid table specified.");let t=await lV(e.schema,e.table),r=Wl(e);if(r)throw r;if(!Array.isArray(e.records))throw new Error("records must be an array");let s=t.hash_attribute,n=new Set,i={},o=!1;return e.operation==="update"&&(o=!0),e.records.forEach(c=>{if(o&&Nt.isEmptyOrZeroLength(c[s]))throw UN.error("a valid hash attribute must be provided with update record:",c),new Error("a valid hash attribute must be provided with update record");if(!Nt.isEmptyOrZeroLength(c[s])&&(c[s]==="null"||c[s]==="undefined"))throw UN.error(`a valid hash value must be provided with ${e.operation} record:`,c),new Error(`"${c[s]}" is not a valid hash attribute value`);!Nt.isEmpty(c[s])&&c[s]!==""&&n.has(Nt.autoCast(c[s]))&&(c.skip=!0),n.add(Nt.autoCast(c[s]));for(let u in c)i[u]=1}),i[s]=1,{schema_table:t,hashes:Array.from(n),attributes:Object.keys(i)}}a(dV,"validation");async function fV(e){if(e.operation!=="insert")throw new Error("invalid operation, must be insert");let t=Wl(e);if(t)throw Ri(new Error,t.message,Ai.BAD_REQUEST);Nt.transformReq(e);let r=Nt.checkSchemaTableExist(e.schema,e.table);if(r)throw Ri(new Error,r,Ai.BAD_REQUEST);let s=await Ql.createRecords(e);return Kl(MN,s.written_hashes,e,s.skipped_hashes,s.new_attributes,s.txn_time)}a(fV,"insertData");async function EV(e){if(e.operation!=="update")throw new Error("invalid operation, must be update");let t=Wl(e);if(t)throw Ri(new Error,t.message,Ai.BAD_REQUEST);Nt.transformReq(e);let r=Nt.checkSchemaTableExist(e.schema,e.table);if(r)throw Ri(new Error,r,Ai.BAD_REQUEST);let s=await Ql.updateRecords(e);return Nt.isEmpty(s.existing_rows)?Kl(_V,s.written_hashes,e,s.skipped_hashes,s.new_attributes,s.txn_time):Kl(s.update_action,[],e,s.hashes,void 0,s.txn_time)}a(EV,"updateData");async function hV(e){if(e.operation!=="upsert")throw Ri(new Error,"invalid operation, must be upsert",Ai.INTERNAL_SERVER_ERROR);let t=Wl(e);if(t)throw Ri(new Error,t.message,Ai.BAD_REQUEST);Nt.transformReq(e);let r=Nt.checkSchemaTableExist(e.schema,e.table);if(r)throw Ri(new Error,r,Ai.BAD_REQUEST);let s=await Ql.upsertRecords(e);return Kl(PN,s.written_hashes,e,[],s.new_attributes,s.txn_time)}a(hV,"upsertData");function Kl(e,t,r,s,n,i){let o={message:`${e} ${t.length} of ${t.length+s.length} records`,new_attributes:n,txn_time:i};return e===MN?(o.inserted_hashes=t,o.skipped_hashes=s,o):e===PN?(o.upserted_hashes=t,o):(o.update_hashes=t,o.skipped_hashes=s,o)}a(Kl,"returnObject");function mV(e){return Nt.transformReq(e),Ql.flush(e.schema,e.table)}a(mV,"flush")});var qh=T((noe,qN)=>{var pV=ke(),Hh=require("joi"),{hdb_table:SV,hdb_database:BN}=Ds(),HN={schema:BN,database:BN,table:SV},TV={date:Hh.date().iso().required()},gV={timestamp:Hh.date().timestamp().required().messages({"date.format":"'timestamp' is invalid"})};qN.exports=function(e,t){let r=t==="timestamp"?{...HN,...gV}:{...HN,...TV},s=Hh.object(r);return pV.validateBySchema(e,s)}});var xN=T((ioe,GN)=>{var RV=ke(),Fh=require("joi"),{hdb_table:AV,hdb_database:FN}=Ds(),OV=Fh.object({schema:FN,database:FN,table:AV,hash_values:Fh.array().required(),ids:Fh.array()});GN.exports=function(e){return RV.validateBySchema(e,OV)}});var VN=T((ooe,kN)=>{"use strict";var Gh=class{static{a(this,"InsertObject")}constructor(t,r,s,n,i){this.operation=t,this.schema=r,this.table=s,this.hash_attribute=n,this.records=i}},xh=class{static{a(this,"NoSQLSeachObject")}constructor(t,r,s,n,i,o){this.schema=t,this.table=r,this.search_attribute=s,this.hash_attribute=n,this.get_attributes=i,this.search_value=o}},kh=class{static{a(this,"DeleteResponseObject")}constructor(){this.message=void 0,this.deleted_hashes=[],this.skipped_hashes=[]}};kN.exports={InsertObject:Gh,NoSQLSeachObject:xh,DeleteResponseObject:kh}});var bi=T((coe,QN)=>{"use strict";var YN=qh(),NV=xN(),Oi=$(),$N=require("moment"),KN=G(),{promisify:bV,callbackify:yV}=require("util"),Ni=y(),IV=qn(),Vh=bV(IV.getTableSchema),$h=os(),{DeleteResponseObject:wV}=VN(),{handleHDBError:Fn,hdb_errors:CV}=j(),{HDB_ERROR_MSGS:zl,HTTP_STATUS_CODES:Gn}=CV,LV="records successfully deleted",DV=yV(WN);QN.exports={delete:DV,deleteRecord:WN,deleteFilesBefore:UV,deleteAuditLogsBefore:MV};async function UV(e){let t=YN(e,"date");if(t)throw Fn(t,t.message,Gn.BAD_REQUEST,void 0,void 0,!0);if(Oi.transformReq(e),!$N(e.date,$N.ISO_8601).isValid())throw Fn(new Error,zl.INVALID_DATE,Gn.BAD_REQUEST,Ni.LOG_LEVELS.ERROR,zl.INVALID_DATE,!0);let s=Oi.checkSchemaTableExist(e.schema,e.table);if(s)throw Fn(new Error,s,Gn.NOT_FOUND,Ni.LOG_LEVELS.ERROR,s,!0);let n=await $h.deleteRecordsBefore(e);if(await Vh(e.schema,e.table),KN.info(`Finished deleting files before ${e.date}`),n&&n.message)return n.message}a(UV,"deleteFilesBefore");async function MV(e){let t=YN(e,"timestamp");if(t)throw Fn(t,t.message,Gn.BAD_REQUEST,void 0,void 0,!0);if(Oi.transformReq(e),isNaN(e.timestamp))throw Fn(new Error,zl.INVALID_VALUE("Timestamp"),Gn.BAD_REQUEST,Ni.LOG_LEVELS.ERROR,zl.INVALID_VALUE("Timestamp"),!0);let r=Oi.checkSchemaTableExist(e.schema,e.table);if(r)throw Fn(new Error,r,Gn.NOT_FOUND,Ni.LOG_LEVELS.ERROR,r,!0);let s=await $h.deleteAuditLogsBefore(e);return await Vh(e.schema,e.table),KN.info(`Finished deleting audit logs before ${e.timestamp}`),s}a(MV,"deleteAuditLogsBefore");async function WN(e){e.ids&&(e.hash_values=e.ids);let t=NV(e);if(t)throw Fn(t,t.message,Gn.BAD_REQUEST,void 0,void 0,!0);Oi.transformReq(e);let r=Oi.checkSchemaTableExist(e.schema,e.table);if(r)throw Fn(new Error,r,Gn.NOT_FOUND,Ni.LOG_LEVELS.ERROR,r,!0);try{await Vh(e.schema,e.table);let s=await $h.deleteRecords(e);return Oi.isEmptyOrZeroLength(s.message)&&(s.message=`${s.deleted_hashes.length} of ${e.hash_values.length} ${LV}`),s}catch(s){if(s.message===Ni.SEARCH_NOT_FOUND_MESSAGE){let n=new wV;return n.message=Ni.SEARCH_NOT_FOUND_MESSAGE,n.skipped_hashes=e.hash_values.length,n.deleted_hashes=0,n}throw s}}a(WN,"deleteRecord")});var Jl=T((loe,XN)=>{var PV=require("crypto"),zN=9;function vV(e){let t=HV(zN),r=JN(e+t);return t+r}a(vV,"createHash");function BV(e,t){let r=e.substr(0,zN),s=r+JN(t+r);return e===s}a(BV,"validateHash");function HV(e){let t="0123456789abcdefghijklmnopqurstuvwxyzABCDEFGHIJKLMNOPQURSTUVWXYZ",r=t.length,s="";for(let n=0;n<e;n++){let i=Math.floor(Math.random()*r);s+=t[i]}return s}a(HV,"generateSalt");function JN(e){return PV.createHash("md5").update(e).digest("hex")}a(JN,"md5");XN.exports={hash:vV,validate:BV}});var ZN=T((doe,jN)=>{var Yh=ke(),qt={username:{presence:!0,format:"[\\w\\-\\_]+",exclusion:{within:["system"],message:"You cannot create tables within the system schema"}},password:{presence:!0},role:{presence:!0,format:"[\\w\\-\\_]+"},active:{presence:!0,inclusion:{within:[!0,!1],message:"must be a boolean"}}};function qV(e){return qt.password.presence=!0,qt.username.presence=!0,qt.role.presence=!0,qt.active.presence=!0,Yh.validateObject(e,qt)}a(qV,"addUserValidation");function FV(e){return qt.password.presence=!1,qt.username.presence=!0,qt.role.presence=!1,qt.active.presence=!1,Yh.validateObject(e,qt)}a(FV,"alterUserValidation");function GV(e){return qt.password.presence=!1,qt.username.presence=!0,qt.role.presence=!1,qt.active.presence=!1,Yh.validateObject(e,qt)}a(GV,"dropUserValidation");jN.exports={addUserValidation:qV,alterUserValidation:FV,dropUserValidation:GV}});var Ve=T((hoe,tb)=>{"use strict";var{platform:Eoe}=require("os"),xV="nats-server.zip",Kh="nats-server",kV=process.platform==="win32"?`${Kh}.exe`:Kh,Wh="HDB",VV=/^[^\s.,*>]+$/,eb="__request__",$V=a(e=>`${e}.${eb}`,"REQUEST_SUBJECT"),YV={NATS_MSG_ID:"Nats-Msg-Id",ORIGIN:"origin",TRANSACTED_NODES:"transacted_nodes"},KV={HUB_SERVER:"hub.json",LEAF_SERVER:"leaf.json"},WV={HUB:"hub.pid",LEAF:"leaf.pid"},QV={HUB:"-hub",LEAF:"-leaf",ADMIN:"-admin"},zV={stream_name:"__HARPERDB_WORK_QUEUE__",durable_name:"HDB_WORK_QUEUE",deliver_group:Wh,deliver_subject:"__HDB__.WORKQUEUE"},JV={stream_name:"__HARPERDB_SCHEMA_QUEUE__",durable_name:"HDB_SCHEMA_QUEUE",deliver_group:Wh,deliver_subject:"HDB.SCHEMAQUEUE"},XV={stream_name:"__HARPERDB_USER_QUEUE__",durable_name:"HDB_USER_QUEUE",deliver_group:Wh,deliver_subject:"HDB.USERQUEUE"},jV={SUCCESS:"success",ERROR:"error"},ZV={OPEN:"open",CLOSED:"closed",NO_RESPONDERS:"NoResponders",TIMEOUT:"Timeout"},e$={TXN:"txn",MSGID:"msgid"},fo={ERR:"error",WRN:"warn",INF:"info",DBG:"debug",TRC:"trace"},t$={[fo.ERR]:1,[fo.WRN]:2,[fo.INF]:3,[fo.DBG]:4,[fo.TRC]:5},r$={debug:"-D",trace:"-DVV"};tb.exports={NATS_SERVER_ZIP:xV,NATS_SERVER_NAME:Kh,NATS_BINARY_NAME:kV,PID_FILES:WV,NATS_CONFIG_FILES:KV,SERVER_SUFFIX:QV,WORK_QUEUE_CONSUMER_NAMES:zV,SCHEMA_QUEUE_CONSUMER_NAMES:JV,USER_QUEUE_CONSUMER_NAMES:XV,NATS_TERM_CONSTRAINTS_RX:VV,REQUEST_SUFFIX:eb,UPDATE_REMOTE_RESPONSE_STATUSES:jV,CLUSTER_STATUS_STATUSES:ZV,REQUEST_SUBJECT:$V,SUBJECT_PREFIXES:e$,MSG_HEADERS:YV,LOG_LEVELS:fo,LOG_LEVEL_FLAGS:r$,LOG_LEVEL_HIERARCHY:t$}});var sb=T((poe,rb)=>{"use strict";var s$={key:"-----BEGIN RSA PRIVATE KEY-----\rMIIEowIBAAKCAQEArBFJQRfFiJku/KwhV1Ssp7cX61vvuKmd4Rp6A9jB2QLgx8nj\r/+Xhp2hPRkISnOA8BuAxr4dMD9syGJwX4kNy9mbZ5Q0fWZCiEGBpVcU1J+k+N5K4\rSuZ2SqgxeN2IN2RLzt3GyQY4imcdHgNv7aHoXUrEwBx0MeYEw3IIDXtrYKCR2D8I\rvWBfwMUgWa24G8lpWILWA5hd9srRz9NxlAiHSjhbgT7B0xruEpHRCHSyKjvaIJVt\rWBR+amejYsAKVrD/hgrqjsA1123Y6++YqvU6vwg64xhS2kz5r3dkNKhvwbWgpZdI\rIaRvsiB77f4kLGo0vi8RFgJ1ZRjGg3RRK2w1LQIDAQABAoIBAQCEOmh78EOpnGZC\rYBjjHrvrysVD5gvLcfVUtl8Ls7gMB60re1eOIF+PoZZCHKZnDd6zPfiQtj1adg0C\rYnnsM/8VoaZS4gm0b3RLd3ubIQifWhuo40RissY2yxfxlPSH9LhZCY8ojnJG0cTL\resK579E8WCfopjUY33XLqEbN7Ylv39J+DSqInjqV3efJZUa+HqUJ98VxxzodcKMD\rP3bwUU4gHoSSp4pAsOFH5sQhaIWH1IcNjrAwpee2cJQuh4G157RRIuuUpagtaEG/\rXJIiAyBguJyu3JQFnIBQF01N5+omJgXYJ1L0m54543/iIRThmF3zDCDgCyUzmOk+\rH6As9fv1AoGBANOpOtOZLSAScjGsgJamT3ceJ2wCa86g2j8Oxu8lJUmUp5s3tA0v\rBFW5O3S4KR1EXwkLMBUMrfFM8YvzHWxsXBI6XV8azGLvyqPHxr65OhmpGYkGZMXu\rn9okgjkqlewnY2I073gvyK7ppX51UL5y9fF1vlsk+UlW+Rgx/vMHbdcjAoGBANAc\rxRUsxs4QJpbS4zD3JOkHjr24a97TrS3kCybAHUMpR2NrEHPZw9zex0/aphOJUHfL\rIMkOZdpfDqMfxWy4FAEmqBEMkO2SB+h0Wp4P+qp81ax4vGFiB0cD3wtixr11U1tt\rlZ/ZTdv4VDpDFNK1KaplhTDeyuCjeYfS3/GJia9vAoGAcOsAgjBevZR5rXx84WH6\rVO8WUu37u7FenXNxt9VWTinrPMh72uixZFY8nOk+rely1e1NCn3IMko9Ns9NbDFm\r8SaH95vhXArXTYbfxZIlp9jp0YtCqcHDL+p4Oq04bFMbFyJseu7rHj1x18QYfnHw\rOY/6LL/N6k1m+Hx7qgXVmIcCgYB/w0nTCBw84XlvWqSTqQaF8VfWbWP79mP5KmkW\rLxdH5g2noVEGbohqDnK6OXd/wusdwByukiJBf94Skyy25AOT+VFwthA7aU1ljhkb\rtJ+lDuJ28eBkwLPLCzthWBC+u0qjdJFJAzVjd/7tjcU43nNn4s90AzL12iaAFhvZ\rwyA+DQKBgGc/4cdyGJ3YkcA8150gQBawgJZ7q8V1JND87ggWA8wnK3cHn7rMZQl2\r3emDp9HEFXFex5dbGDDqZFAoesZCDxjknIn9oNfW4PvaWS8q7b6ZKLZG1p03Pu7/\rtYaD0kPbo0kysfFT/co+NgHbdykvIyboomfGdNLTUjYuy6lpwpvs\r-----END RSA PRIVATE KEY-----\r".replace(/\r/g,String.fromCharCode(13,10)),cert:"-----BEGIN CERTIFICATE-----\rMIIDXDCCAkSgAwIBAgIFNTE4MzQwDQYJKoZIhvcNAQELBQAwXTEXMBUGA1UEAxMO\rSGFycGVyREIsIEluYy4xCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJDTzEPMA0GA1UE\rBxMGRGVudmVyMRcwFQYDVQQKEw5IYXJwZXJEQiwgSW5jLjAeFw0yMjAzMTEyMzAz\rNDlaFw0yNzAzMTAyMzAzNDlaMF0xFzAVBgNVBAMTDkhhcnBlckRCLCBJbmMuMQsw\rCQYDVQQGEwJVUzELMAkGA1UECBMCQ08xDzANBgNVBAcTBkRlbnZlcjEXMBUGA1UE\rChMOSGFycGVyREIsIEluYy4wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIB\rAQCsEUlBF8WImS78rCFXVKyntxfrW++4qZ3hGnoD2MHZAuDHyeP/5eGnaE9GQhKc\r4DwG4DGvh0wP2zIYnBfiQ3L2ZtnlDR9ZkKIQYGlVxTUn6T43krhK5nZKqDF43Yg3\rZEvO3cbJBjiKZx0eA2/toehdSsTAHHQx5gTDcggNe2tgoJHYPwi9YF/AxSBZrbgb\ryWlYgtYDmF32ytHP03GUCIdKOFuBPsHTGu4SkdEIdLIqO9oglW1YFH5qZ6NiwApW\rsP+GCuqOwDXXbdjr75iq9Tq/CDrjGFLaTPmvd2Q0qG/BtaCll0ghpG+yIHvt/iQs\rajS+LxEWAnVlGMaDdFErbDUtAgMBAAGjIzAhMA8GA1UdEwEB/wQFMAMBAf8wDgYD\rVR0PAQH/BAQDAgIEMA0GCSqGSIb3DQEBCwUAA4IBAQASR4YW/rPK7PNArHVe9zzM\rb0rKNX/2T9/0nybRhmE/+hdlSgliTAeebmwkUS2APckmekYt/q2ZY2NS65Fo/jjp\rG8TJrtcF4h+ylVqUp0ZXQLFtIsr7r2JZA7hJ6njW6G4DHSZ0gxtECLi4CBlTjzm5\rNmnmIDObvGRTuqmcdAZmXeObbta/He2XIzietukPAYX062pNM+G5XT5UM1eG/Vlp\rN86vjhpyI+ffKy+C60SJqxmKM3ydgN7oLscE7+2wLPN25XqN4W99OwGsp5dTdu/f\r5lPtFayXdJ55e/sNQKmGN+UGLrL05c2MWgjb8U/LFilnupUianceoeSERZmVjzKX\r-----END CERTIFICATE-----\r".replace(/\r/g,String.fromCharCode(13,10))},n$="certificate.pem",i$="privateKey.pem",o$="ca.pem";rb.exports={CERTIFICATE_VALUES:s$,CERTIFICATE_PEM_NAME:n$,PRIVATEKEY_PEM_NAME:i$,CA_PEM_NAME:o$}});var zh=T((Toe,cb)=>{"use strict";var ab=require("fs-extra"),ue=require("joi"),a$=require("os"),{boolean:we,string:Ms,number:bt,array:Qh}=ue.types(),{totalmem:nb}=require("os"),Eo=require("path"),c$=G(),jl=$(),Soe=sb(),ib=y(),u$=ke(),ob="log",l$="components",_$="Invalid logging.rotation.maxSize unit. Available units are G, M or K",d$="Invalid logging.rotation.interval unit. Available units are D, H or M (minutes)",f$="Invalid logging.rotation.maxSize value. Value should be a number followed by unit e.g. '10M'",E$="Invalid logging.rotation.interval value. Value should be a number followed by unit e.g. '10D'",h$="rootPath config parameter is undefined",m$="clustering.enabled config parameter is undefined",yi=bt.min(0).required(),Zl=Qh.items({host:Ms.required(),port:yi}).empty(null),on;cb.exports={configValidator:p$,routesValidator:O$,route_constraints:Zl};function p$(e){if(on=e.rootPath,jl.isEmpty(on))throw h$;let t=we.required(),r=bt.min(0).max(1e3).empty(null).default(A$),s=Ms.pattern(/^[\\\/]$|([\\\/][a-zA-Z_0-9\:-]+)+$/,"directory path").empty(null).default(Xl),n=Ms.optional().empty(null),i=Ms.pattern(/^[^\s.,*>]+$/).messages({"string.pattern.base":"{:#label} invalid, must not contain ., * or >"}).empty(null).required(),o=ue.string().empty(null).default(Xl),c=ue.custom(T$).empty(null).default(Xl),u=e.clustering?.enabled;if(jl.isEmpty(u))throw m$;let _;return u===!0?_=ue.object({enabled:t,hubServer:ue.object({cluster:ue.object({name:ue.required().empty(null),network:ue.object({port:yi,routes:Zl}).required()}).required(),leafNodes:ue.object({network:ue.object({port:yi}).required()}).required(),network:ue.object({port:yi}).required()}).required(),leafServer:ue.object({network:ue.object({port:yi,routes:Zl}).required(),streams:ue.object({maxAge:bt.min(120).allow(null).optional(),maxBytes:bt.min(1).allow(null).optional(),maxMsgs:bt.min(1).allow(null).optional(),path:o}).required()}).required(),logLevel:ue.valid("error","warn","info","debug","trace"),nodeName:i,republishMessages:we.optional(),databaseLevel:we.optional(),tls:ue.object({certificate:n,certificateAuthority:n,privateKey:n,insecure:we.required(),verify:we.optional()}),user:Ms.optional().empty(null)}).required():_=ue.object({enabled:t,tls:ue.object({certificate:n,certificateAuthority:n,privateKey:n,insecure:we.required()})}).required(),ue.object({authentication:ue.object({authorizeLocal:we,cacheTTL:bt.required(),enableSessions:we}),analytics:ue.object({aggregatePeriod:bt}),componentsRoot:s.optional(),clustering:_,localStudio:ue.object({enabled:t}).required(),logging:ue.object({auditAuthEvents:ue.object({logFailed:we,logSuccessful:we}),file:we.required(),level:ue.valid("notify","fatal","error","warn","info","debug","trace"),rotation:ue.object({enabled:we.optional(),compress:we.optional(),interval:Ms.custom(R$).optional().empty(null),maxSize:Ms.custom(g$).optional().empty(null),path:Ms.optional().empty(null).default(Xl)}).required(),root:s,stdStreams:we.required(),auditLog:we.required()}).required(),operationsApi:ue.object({network:ue.object({cors:we.optional(),corsAccessList:Qh.optional(),headersTimeout:bt.min(1).optional(),keepAliveTimeout:bt.min(1).optional(),port:bt.optional().empty(null),securePort:bt.optional().empty(null),timeout:bt.min(1).optional()}).optional(),tls:ue.object({certificate:n,certificateAuthority:n,privateKey:n})}).required(),rootPath:Ms.pattern(/^[\\\/]$|([\\\/][a-zA-Z_0-9\:-]+)+$/,"directory path").required(),mqtt:ue.object({network:ue.object({port:yi,securePort:yi}).required(),webSocket:we.optional(),requireAuthentication:we.optional()}),http:ue.object({compressionThreshold:bt.optional(),cors:we.optional(),corsAccessList:Qh.optional(),headersTimeout:bt.min(1).optional(),port:bt.min(0).optional().empty(null),securePort:bt.min(0).optional().empty(null)}).required(),threads:r.optional(),storage:ue.object({writeAsync:we.required(),overlappingSync:we.optional(),caching:we.optional(),compression:we.optional(),noReadAhead:we.optional(),path:c,prefetchWrites:we.optional()}).required(),ignoreScripts:we.optional(),tls:ue.object({certificate:n.optional(),certificateAuthority:n.optional(),privateKey:n.optional()})}).validate(e,{allowUnknown:!0,abortEarly:!1,errors:{wrap:{label:"'"}}})}a(p$,"configValidator");function S$(e){return ab.existsSync(e)?null:`Specified path ${e} does not exist.`}a(S$,"doesPathExist");function T$(e,t){ue.assert(e,Ms.pattern(/^[\\\/]$|([\\\/][a-zA-Z_0-9\:-]+)+$/,"directory path"));let r=S$(e);if(r)return t.message(r)}a(T$,"validatePath");function g$(e,t){let r=e.slice(-1);if(r!=="G"&&r!=="M"&&r!=="K")return t.message(_$);let s=e.slice(0,-1);return isNaN(parseInt(s))?t.message(f$):e}a(g$,"validateRotationMaxSize");function R$(e,t){let r=e.slice(-1);if(r!=="D"&&r!=="H"&&r!=="M")return t.message(d$);let s=e.slice(0,-1);return isNaN(parseInt(s))?t.message(E$):e}a(R$,"validateRotationInterval");function A$(e,t){let r=t.state.path.join("."),s=a$.cpus().length,n=s-1;n<=2&&(n=2);let i=process.constrainedMemory?.()||nb();return i=Math.round(Math.min(i,nb())/1e6),n=Math.max(Math.min(n,Math.round((i-750)/300)),1),c$.info(`Detected ${s} cores and ${i}MB on this machine, defaulting ${r} to ${n}`),n}a(A$,"setDefaultThreads");function Xl(e,t){if(!jl.isEmpty(t.original))return t.original;let r=t.state.path.join(".");if(jl.isEmpty(on))throw new Error(`Error setting default root for: ${r}. HDB root is not defined`);switch(r){case"componentsRoot":return Eo.join(on,l$);case"logging.root":return Eo.join(on,ob);case"clustering.leafServer.streams.path":return Eo.join(on,"clustering","leaf");case"storage.path":let s=Eo.join(on,ib.LEGACY_DATABASES_DIR_NAME);return ab.existsSync(s)?s:Eo.join(on,ib.DATABASES_DIR_NAME);case"logging.rotation.path":return Eo.join(on,ob);default:throw new Error(`Error setting default root for config parameter: ${r}. Unrecognized config parameter`)}}a(Xl,"setDefaultRoot");function O$(e){let t=ue.object({routes:Zl});return u$.validateBySchema({routes:e},t)}a(O$,"routesValidator")});var gr=T((Aoe,pb)=>{"use strict";var Tr=y(),mt=$(),lt=G(),{configValidator:N$,routesValidator:ub}=zh(),Jt=require("fs-extra"),b$=require("yaml"),as=require("path"),y$=require("is-number"),_b=require("properties-reader"),I$=require("lodash"),{handleHDBError:w$}=j(),{HTTP_STATUS_CODES:C$,HDB_ERROR_MSGS:e_}=fr(),Roe=require("minimist"),{server:L$}=(hr(),Z(hi)),{DATABASES_PARAM_CONFIG:nc,CONFIG_PARAMS:an,CONFIG_PARAM_MAP:cs}=Tr,D$="Unable to get config value because config is uninitialized",U$="Config successfully initialized",M$="Error backing up config file",P$="Empty parameter sent to getConfigValue",db=as.join(Tr.PACKAGE_ROOT,"config","yaml",Tr.HDB_DEFAULT_CONFIG_FILE),v$="Configuration successfully set. You must restart HarperDB for new config settings to take effect.",lb={logging_rotation_retain:"logging.rotation.retain",logging_rotation_rotate:"logging.rotation.rotate",logging_rotation_rotateinterval:"logging.rotation.rotateInterval",logging_rotation_rotatemodule:"logging.rotation.rotateModule",logging_rotation_timezone:"logging.rotation.timezone",logging_rotation_workerinterval:"logging.rotation.workerInterval"},t_,yt,r_;pb.exports={createConfigFile:B$,getDefaultConfig:H$,getConfigValue:Eb,initConfig:Xh,flattenConfig:ho,updateConfigValue:hb,updateConfigObject:F$,getConfiguration:k$,setConfiguration:V$,readConfigFile:Zh,getClusteringRoutes:$$,initOldConfig:mb,getConfigFromFile:Y$,getConfigFilePath:Ii,addConfig:K$,deleteConfigFromFile:W$,getConfigObj:Q$};function B$(e){let t=xn(db);t_=ho(t.toJSON());let r;for(let o in e){let c=cs[o.toLowerCase()];if(c===an.DATABASES){r=e[o];continue}if(!c&&o.endsWith("_package")&&(c=o),c!==void 0){let u=c.split("_"),_=Jh(c,e[o]);c==="rootPath"&&_?.endsWith("/")&&(_=_.slice(0,-1));try{t.setIn([...u],_)}catch(l){lt.error(l)}}}r&&fb(t,r),jh(t);let s=t.toJSON();yt=ho(s);let n=t.getIn(["rootPath"]),i=as.join(n,Tr.HDB_CONFIG_FILE);Jt.createFileSync(i),Jt.writeFileSync(i,String(t)),lt.trace(`Config file written to ${i}`)}a(B$,"createConfigFile");function fb(e,t){let r;try{try{r=JSON.parse(t)}catch(s){if(!mt.isObject(t))throw s;r=t}for(let s of r){let n=Object.keys(s)[0];if(s[n].hasOwnProperty(nc.TABLES))for(let i in s[n][nc.TABLES])for(let o in s[n][nc.TABLES][i]){let c=s[n][nc.TABLES][i][o],u=[an.DATABASES,n,nc.TABLES,i,o];e.hasIn(u)?e.setIn(u,c):e.addIn(u,c)}else for(let i in s[n]){let o=s[n][i],c=[an.DATABASES,n,i];e.hasIn(c)?e.setIn(c,o):e.addIn(c,o)}}}catch(s){lt.error("Error parsing schemas CLI/env config arguments",s)}}a(fb,"setSchemasConfig");function H$(e){if(t_===void 0){let r=xn(db);t_=ho(r.toJSON())}let t=cs[e.toLowerCase()];if(t!==void 0)return t_[t.toLowerCase()]}a(H$,"getDefaultConfig");function Eb(e){if(e==null){lt.error(P$);return}if(yt===void 0){lt.trace(D$);return}let t=cs[e.toLowerCase()];if(t!==void 0)return yt[t.toLowerCase()]}a(Eb,"getConfigValue");function Ii(e=mt.getPropsFilePath()){let t=mt.getEnvCliRootPath();return t?as.join(t,Tr.HDB_CONFIG_FILE):_b(e).get(Tr.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY)}a(Ii,"getConfigFilePath");function Xh(e=!1){if(yt===void 0||e){let t;if(!mt.noBootFile()){t=mt.getPropsFilePath();try{Jt.accessSync(t,Jt.constants.F_OK|Jt.constants.R_OK)}catch(i){throw lt.error(i),new Error(`HarperDB properties file at path ${t} does not exist`)}}let r=Ii(t),s;if(r.includes("config/settings.js"))try{mb(r);return}catch(i){if(i.code!==Tr.NODE_ERROR_CODES.ENOENT)throw i}try{s=xn(r)}catch(i){if(i.code===Tr.NODE_ERROR_CODES.ENOENT){lt.trace(`HarperDB config file not found at ${r}. 
				This can occur during early stages of install where the config file has not yet been created`);return}else throw lt.error(i),new Error(`Error reading HarperDB config file at ${r}`)}q$(s,r),jh(s);let n=s.toJSON();if(L$.config=n,yt=ho(n),yt.logging_rotation_rotate)for(let i in lb)yt[i]&&lt.error(`Config ${lb[i]} has been deprecated. Please check https://docs.harperdb.io/docs/ for further details.`);lt.trace(U$)}}a(Xh,"initConfig");function q$(e,t){let r=e.getIn(["rootPath"]),s=!1;e.hasIn(["storage","path"])||(e.setIn(["storage","path"],as.join(r,"database")),s=!0),e.hasIn(["clustering","leafServer","streams","path"])||(e.setIn(["clustering","leafServer","streams","path"],as.join(r,"clustering","leaf")),s=!0),e.hasIn(["logging","rotation","path"])||(e.setIn(["logging","rotation","path"],as.join(r,"log")),s=!0),e.hasIn(["clustering","tls","verify"])||(e.setIn(["clustering","tls","verify"],!0),s=!0),s&&(lt.trace("Updating config file with missing config params"),Jt.writeFileSync(t,String(e)))}a(q$,"checkForUpdatedConfig");function jh(e){let t=e.toJSON();t.componentsRoot=t.componentsRoot??t?.customFunctions?.root,t.threads=t.threads??t?.http?.threads;let r=N$(t);if(r.error)throw e_.CONFIG_VALIDATION(r.error.message);e.setIn(["threads"],r.value.threads),e.setIn(["componentsRoot"],r.value.componentsRoot),e.setIn(["logging","root"],r.value.logging.root),e.setIn(["storage","path"],r.value.storage.path),e.setIn(["logging","rotation","path"],r.value.logging.rotation.path),e.setIn(["clustering","leafServer","streams","path"],r.value.clustering.leafServer.streams?.path)}a(jh,"validateConfig");function F$(e,t){yt===void 0&&(yt={});let r=cs[e.toLowerCase()];if(r===void 0){lt.trace(`Unable to update config object because config param '${e}' does not exist`);return}yt[r.toLowerCase()]=t}a(F$,"updateConfigObject");function hb(e,t,r=void 0,s=!1,n=!1,i=!1){yt===void 0&&Xh();let o=Eb(cs.hdb_root),c=as.join(o,Tr.HDB_CONFIG_FILE),u=xn(c),_;if(r===void 0&&e.toLowerCase()===an.DATABASES)_=t;else if(r===void 0){let f;if(i)f=e;else if(f=cs[e.toLowerCase()],f===void 0)throw new Error(`Unable to update config, unrecognized config parameter: ${e}`);let E=f.split("_"),h=Jh(f,t);u.setIn([...E],h)}else for(let f in r){let E=cs[f.toLowerCase()];if(E===an.DATABASES){_=r[f];continue}if(!E&&f.endsWith("_package")&&(E=f),E!==void 0){let h=E.split("_"),S=Tr.LEGACY_CONFIG_PARAMS[f.toUpperCase()];S&&S.startsWith("customFunctions")&&u.hasIn(S.split("_"))&&(E=S,h=S.split("_"));let p=Jh(E,r[f]);E==="rootPath"&&p?.endsWith("/")&&(p=p.slice(0,-1));try{u.setIn([...h],p)}catch(g){lt.error(g)}}}_&&fb(u,_),jh(u);let l=u.getIn(["rootPath"]),d=as.join(l,Tr.HDB_CONFIG_FILE);s===!0&&G$(c,l),Jt.writeFileSync(d,String(u)),n&&(yt=ho(u.toJSON())),lt.trace(`Config parameter: ${e} updated with value: ${t}`)}a(hb,"updateConfigValue");function G$(e,t){try{let r=as.join(t,"backup",`${Tr.HDB_CONFIG_FILE}.bak`);Jt.copySync(e,r),lt.trace(`Config file: ${e} backed up to: ${r}`)}catch(r){lt.error(M$),lt.error(r)}}a(G$,"backupConfigFile");var x$=["databases"];function ho(e){return e.http&&Object.assign(e.http,e?.customFunctions?.network),e?.operationsApi?.network&&(e.operationsApi.network=Object.assign({},e.http,e.operationsApi.network)),e?.operationsApi&&(e.operationsApi.tls=Object.assign({},e.tls,e.operationsApi.tls)),r_=e,r(e);function r(s){let n={};for(let i in s)if(s.hasOwnProperty(i))if(typeof s[i]=="object"&&s[i]!==null&&!Array.isArray(s[i])&&!x$.includes(i)){let o=r(s[i]);for(let c in o){if(!o.hasOwnProperty(c))continue;c!=="package"&&(i=i.toLowerCase());let u=i+"_"+c;!an[u.toUpperCase()]&&cs[u]&&(n[cs[u].toLowerCase()]=o[c]),n[u]=o[c]}}else n[i.toLowerCase()]=s[i];return n}a(r,"squashObj")}a(ho,"flattenConfig");function Jh(e,t){if(e===an.CLUSTERING_NODENAME||e===an.CLUSTERING_USER){if(t==null)return t;if(!isNaN(t))return t.toString();if(typeof t=="string"&&t.toLowerCase()==="true"||typeof t=="string"&&t.toLowerCase()==="false")return t}else{if(y$(t))return parseFloat(t);if(t===!0||t===!1||Array.isArray(t)||mt.isObject(t)||t===null)return t;if(typeof t=="string"&&t.toLowerCase()==="true")return!0;if(typeof t=="string"&&t.toLowerCase()==="false")return!1}if(t===void 0||t.toLowerCase()==="undefined")return null;if(typeof t=="string"&&(t.startsWith("{")&&t.endsWith("}")||t.startsWith("[")&&t.endsWith("]")))try{return JSON.parse(t)}catch{}return mt.autoCast(t)}a(Jh,"castConfigValue");function k$(){let e=mt.getPropsFilePath(),t=Ii(e);return xn(t).toJSON()}a(k$,"getConfiguration");async function V$(e){let{operation:t,hdb_user:r,hdb_auth_header:s,...n}=e;try{return hb(void 0,void 0,n,!0),v$}catch(i){throw typeof i=="string"||i instanceof String?w$(i,i,C$.BAD_REQUEST,void 0,void 0,!0):i}}a(V$,"setConfiguration");function Zh(){let e=mt.getPropsFilePath();try{Jt.accessSync(e,Jt.constants.F_OK|Jt.constants.R_OK)}catch(s){if(!mt.noBootFile())throw lt.error(s),new Error(`HarperDB properties file at path ${e} does not exist`)}let t=Ii(e);return xn(t).toJSON()}a(Zh,"readConfigFile");function xn(e){return b$.parseDocument(Jt.readFileSync(e,"utf8"),{simpleKeys:!0})}a(xn,"parseYamlDoc");function $$(){let e=Zh(),t=e?.clustering?.hubServer?.cluster?.network?.routes;t=mt.isEmptyOrZeroLength(t)?[]:t;let r=ub(t);if(r)throw e_.CONFIG_VALIDATION(r.message);let s=e?.clustering?.leafServer?.network?.routes;s=mt.isEmptyOrZeroLength(s)?[]:s;let n=ub(s);if(n)throw e_.CONFIG_VALIDATION(n.message);if(!mt.isEmptyOrZeroLength(s)&&!mt.isEmptyOrZeroLength(t)){let i=t.filter(o=>s.some(c=>c.host===o.host&&c.port===o.port));if(!mt.isEmptyOrZeroLength(i)){let o=`Duplicate hub and leaf routes found ${JSON.stringify(i)}`;throw e_.CONFIG_VALIDATION(o)}}return{hub_routes:t,leaf_routes:s}}a($$,"getClusteringRoutes");function mb(e){let t=_b(e);yt={};for(let r in cs){let s=t.get(r.toUpperCase());if(mt.isEmpty(s)||typeof s=="string"&&s.trim().length===0)continue;let n=cs[r].toLowerCase();n===an.LOGGING_ROOT?yt[n]=as.dirname(s):yt[n]=s}return yt}a(mb,"initOldConfig");function Y$(e){let t=Zh();return I$.get(t,e.replaceAll("_","."))}a(Y$,"getConfigFromFile");async function K$(e,t){let r=xn(Ii());r.hasIn([e])?r.setIn([e],t):r.addIn([e],t),await Jt.writeFile(Ii(),String(r))}a(K$,"addConfig");function W$(e){let t=Ii(mt.getPropsFilePath()),r=xn(t);r.deleteIn(e);let s=r.getIn(["rootPath"]),n=as.join(s,Tr.HDB_CONFIG_FILE);Jt.writeFileSync(n,String(r))}a(W$,"deleteConfigFromFile");function Q$(){return r_||(Xh(),r_)}a(Q$,"getConfigObj")});var Tb=T((Noe,Sb)=>{"use strict";var s_=y(),n_=class{static{a(this,"BaseLicense")}constructor(t=0,r=s_.RAM_ALLOCATION_ENUM.DEFAULT,s=s_.LICENSE_VALUES.VERSION_DEFAULT,n){this.exp_date=t,this.ram_allocation=r,this.version=s,this.fingerprint=n}},em=class extends n_{static{a(this,"ExtendedLicense")}constructor(t=0,r=s_.RAM_ALLOCATION_ENUM.DEFAULT,s=s_.LICENSE_VALUES.VERSION_DEFAULT,n,i=!1){super(t,r,s,n),this.enterprise=i}};Sb.exports={BaseLicense:n_,ExtendedLicense:em}});var ic=T((yoe,bb)=>{"use strict";var po=require("fs-extra"),gb=Jl(),Rb=require("crypto"),z$=require("moment"),J$=require("uuid").v4,Ft=G(),rm=require("path"),X$=$(),kn=y(),j$=Tb().ExtendedLicense,mo="invalid license key format",Z$="061183",eY="mofi25",tY="aes-256-cbc",rY=16,sY=32,Ab=X();Ab.initSync();var tm;bb.exports={validateLicense:Ob,generateFingerPrint:iY,licenseSearch:Nb,getLicense:cY};function sm(){return rm.join(Ab.getHdbBasePath(),kn.LICENSE_KEY_DIR_NAME,kn.LICENSE_FILE_NAME)}a(sm,"getLicenseDirPath");function nY(){let e=sm();return rm.join(e,kn.LICENSE_FILE_NAME)}a(nY,"getLicenseFilePath");function nm(){let e=sm();return rm.join(e,kn.REG_KEY_FILE_NAME)}a(nm,"getFingerPrintFilePath");async function iY(){let e=nm();try{return await po.readFile(e,"utf8")}catch(t){if(t.code==="ENOENT")return await oY();throw Ft.error(`Error writing fingerprint file to ${e}`),Ft.error(t),new Error("There was an error generating the fingerprint")}}a(iY,"generateFingerPrint");async function oY(){let e=J$(),t=gb.hash(e),r=nm();try{await po.mkdirp(sm()),await po.writeFile(r,t)}catch(s){if(s.code==="EEXIST")return t;throw Ft.error(`Error writing fingerprint file to ${r}`),Ft.error(s),new Error("There was an error generating the fingerprint")}return t}a(oY,"writeFingerprint");function Ob(e,t){let r={valid_license:!1,valid_date:!1,valid_machine:!1,exp_date:null,ram_allocation:kn.RAM_ALLOCATION_ENUM.DEFAULT,version:kn.LICENSE_VALUES.VERSION_DEFAULT};if(!e)return Ft.error("empty license key passed to validate."),r;let s=nm(),n=!1;try{n=po.statSync(s)}catch(i){Ft.error(i)}if(n){let i;try{i=po.readFileSync(s,"utf8")}catch{Ft.error("error validating this machine in the license"),r.valid_machine=!1;return}let o=e.split(eY),c=o[1];c=Buffer.concat([Buffer.from(c)],rY);let u=Buffer.concat([Buffer.from(i)],sY),_=Rb.createDecipheriv(tY,u,c);r.valid_date=!0,r.valid_license=!0,r.valid_machine=!0;let l=null;try{l=_.update(o[0],"hex","utf8"),l.trim(),l+=_.final("utf8")}catch{let E=aY(o[0],i);if(E)l=E;else throw r.valid_license=!1,r.valid_machine=!1,console.error(mo),Ft.error(mo),new Error(mo)}let d;if(isNaN(l))try{d=JSON.parse(l),r.version=d.version,r.exp_date=d.exp_date,isNaN(r.exp_date)&&(r.exp_date=new Date(r.exp_date).getTime()),d.ram_allocation&&(r.ram_allocation=d.ram_allocation)}catch{throw console.error(mo),Ft.error(mo),new Error(mo)}else r.exp_date=l;r.exp_date<z$().valueOf()&&(r.valid_date=!1),gb.validate(o[1],`${Z$}${i}${t}`)||(r.valid_license=!1)}else r.valid_license=!1,r.valid_machine=!1;return r.valid_license&&r.valid_machine&&r.valid_date||Ft.error("Invalid licence"),r}a(Ob,"validateLicense");function aY(e,t){try{let r=Rb.createDecipher("aes192",t),s=r.update(e,"hex","utf8");return s.trim(),s+=r.final("utf8"),s}catch{Ft.warn("Check old license failed")}}a(aY,"checkOldLicense");function Nb(){let e=new j$,t=[];try{t=po.readFileSync(nY(),"utf-8").split(kn.NEW_LINE)}catch(r){r.code==="ENOENT"?Ft.info("no license file found"):Ft.error(`could not search for licenses due to: '${r.message}`)}for(let r=0;r<t.length;++r){let s=t[r];try{if(X$.isEmptyOrZeroLength(s))continue;let n=JSON.parse(s),i=Ob(n.license_key,n.company);i.valid_machine===!0&&i.valid_date===!0&&i.valid_machine===!0&&(e.exp_date=i.exp_date>e.exp_date?i.exp_date:e.exp_date,e.ram_allocation=i.ram_allocation,e.enterprise=!0)}catch(n){Ft.error("There was an error parsing the license string."),Ft.error(n),e.ram_allocation=kn.RAM_ALLOCATION_ENUM.DEFAULT,e.enterprise=!1}}return tm=e,e}a(Nb,"licenseSearch");async function cY(){return tm||await Nb(),tm}a(cY,"getLicense")});var Gr=T((Doe,xb)=>{"use strict";var Cb="username is required",Lb="nothing to update, must supply active, role or password to update",Db="password cannot be an empty string",Ub="If role is specified, it cannot be empty.",Mb="active must be true or false";xb.exports={addUser:pY,alterUser:SY,dropUser:gY,getSuperUser:NY,userInfo:RY,listUsers:o_,listUsersExternal:AY,setUsersToGlobal:To,findAndValidateUser:Fb,getClusterUser:bY,USERNAME_REQUIRED:Cb,ALTERUSER_NOTHING_TO_UPDATE:Lb,EMPTY_PASSWORD:Db,EMPTY_ROLE:Ub,ACTIVE_BOOLEAN:Mb};var Pb=Fr(),uY=bi(),am=Jl(),vb=ZN(),Bb=qr(),cm=cn(),Rr=$(),Hb=require("validate.js"),le=G(),{promisify:lY}=require("util"),um=nn(),yb=y(),Ib=Ve(),_Y=gr(),woe=X(),Coe=ic(),dY=Si(),{table:Loe}=(fe(),Z(Ce)),{handleHDBError:Ps,hdb_errors:fY}=j(),{HTTP_STATUS_CODES:vs,AUTHENTICATION_ERROR_MSGS:im,HDB_ERROR_MSGS:So}=fY,{UserEventMsg:lm}=us(),om=require("lodash"),{server:_m}=(hr(),Z(hi)),EY=G();_m.getUser=Fb;var qb={username:!0,active:!0,role:!0,password:!0},wb=new Map,i_=Bb.searchByValue,hY=Bb.searchByHash,mY=lY(uY.delete);async function pY(e){let t=Hb.cleanAttributes(e,qb),r=vb.addUserValidation(t);if(r)throw Ps(new Error,r.message,vs.BAD_REQUEST,void 0,void 0,!0);let s={schema:"system",table:"hdb_role",search_attribute:"role",search_value:t.role,get_attributes:["id","permission","role"]},n;try{n=await i_(s),n=n&&Array.from(n)}catch(u){throw le.error("There was an error searching for a role in add user"),le.error(u),u}if(!n||n.length<1)throw Ps(new Error,So.ROLE_NAME_NOT_FOUND(t.role),vs.NOT_FOUND,void 0,void 0,!0);if(n.length>1)throw Ps(new Error,So.DUP_ROLES_FOUND(t.role),vs.CONFLICT,void 0,void 0,!0);n[0].permission.cluster_user===!0&&(t.hash=um.encrypt(t.password)),t.password=am.hash(t.password),t.role=n[0].id;let i={operation:"insert",schema:"system",table:"hdb_user",records:[t]},o;try{o=await Pb.insert(i)}catch(u){throw le.error("There was an error searching for a user."),le.error(u),u}le.debug(o);try{await To()}catch(u){throw le.error("Got an error setting users to global"),le.error(u),u}if(o.skipped_hashes.length===1)throw Ps(new Error,So.USER_ALREADY_EXISTS(t.username),vs.CONFLICT,void 0,void 0,!0);let c=Object.assign({},t);return c.role=n[0],cm.signalUserChange(new lm(process.pid)),`${c.username} successfully added`}a(pY,"addUser");async function SY(e){let t=Hb.cleanAttributes(e,qb);if(Rr.isEmptyOrZeroLength(t.username))throw new Error(Cb);if(Rr.isEmptyOrZeroLength(t.password)&&Rr.isEmptyOrZeroLength(t.role)&&Rr.isEmptyOrZeroLength(t.active))throw new Error(Lb);if(!Rr.isEmpty(t.password)&&Rr.isEmptyOrZeroLength(t.password.trim()))throw new Error(Db);if(!Rr.isEmpty(t.active)&&!Rr.isBoolean(t.active))throw new Error(Mb);let r=TY(t.username);if(!Rr.isEmpty(t.password)&&!Rr.isEmptyOrZeroLength(t.password.trim())&&(r&&(t.hash=um.encrypt(t.password)),t.password=am.hash(t.password)),t.role==="")throw new Error(Ub);if(t.role){let i={schema:"system",table:"hdb_role",search_attribute:"role",search_value:t.role,get_attributes:["*"]},o;try{o=Array.from(await i_(i)||[])}catch(c){throw le.error("Got an error searching for a role."),le.error(c),c}if(!o||o.length===0){let c=So.ALTER_USER_ROLE_NOT_FOUND(t.role);throw le.error(c),Ps(new Error,c,vs.NOT_FOUND,void 0,void 0,!0)}if(o.length>1){let c=So.ALTER_USER_DUP_ROLES(t.role);throw le.error(c),Ps(new Error,c,vs.CONFLICT,void 0,void 0,!0)}t.role=o[0].id}let s={operation:"update",schema:"system",table:"hdb_user",records:[t]},n;try{n=await Pb.update(s)}catch(i){throw le.error("Error during update."),le.error(i),i}try{await To()}catch(i){throw le.error("Got an error setting users to global"),le.error(i),i}return cm.signalUserChange(new lm(process.pid)),n}a(SY,"alterUser");function TY(e){let t=!1,r=global.hdb_users.get(e);return r&&r.role.permission.cluster_user===!0&&(t=!0),t}a(TY,"isClusterUser");async function gY(e){try{let t=vb.dropUserValidation(e);if(t)throw new Error(t);let r={table:"hdb_user",schema:"system",hash_values:[e.username]};if(Rr.isEmpty(global.hdb_users.get(e.username)))throw Ps(new Error,So.USER_NOT_EXIST(e.username),vs.NOT_FOUND,void 0,void 0,!0);let s;try{s=await mY(r)}catch(n){throw le.error("Got an error deleting a user."),le.error(n),n}le.debug(s);try{await To()}catch(n){throw le.error("Got an error setting users to global."),le.error(n),n}return cm.signalUserChange(new lm(process.pid)),`${e.username} successfully deleted`}catch(t){throw t}}a(gY,"dropUser");async function RY(e){let t={};try{if(!e||!e.hdb_user)return"There was no user info in the body";t=om.cloneDeep(e.hdb_user);let r={schema:"system",table:"hdb_role",hash_values:[t.role.id],get_attributes:["*"]},s;try{s=await hY(r)}catch(n){throw le.error("Got an error searching for a role."),le.error(n),n}t.role=s[0],delete t.password,delete t.refresh_token,delete t.hash}catch(r){throw le.error(r),r}return t}a(RY,"userInfo");async function AY(){let e;try{e=await o_()}catch(t){throw le.error("Got an error listing users."),le.error(t),t}try{e.forEach(t=>{delete t.password,delete t.hash,delete t.refresh_token})}catch{throw new Error("there was an error massaging the user data")}return[...e.values()]}a(AY,"listUsersExternal");async function o_(){try{let e={schema:"system",table:"hdb_role",search_value:"*",search_attribute:"role",get_attributes:["*"]},t;try{t=await i_(e)}catch(o){throw le.error("Got an error searching for roles."),le.error(o),o}let r={};for(let o of t)r[o.id]=om.cloneDeep(o);if(Object.keys(r).length===0)return null;let s={schema:"system",table:"hdb_user",search_value:"*",search_attribute:"username",get_attributes:["*"]},n;try{n=await i_(s)}catch(o){throw le.error("Got an error searching for users."),le.error(o),o}let i=new Map;for(let o of n)o=om.cloneDeep(o),o.role=r[o.role],OY(o.role),i.set(o.username,o);return i}catch(e){throw le.error("got an error listing users"),le.error(e),Rr.errorizeMessage(e)}return null}a(o_,"listUsers");function OY(e){try{if(!e){le.error("invalid user role found.");return}e.permission.system||(e.permission.system={}),e.permission.system.tables||(e.permission.system.tables={});for(let t of Object.keys(dY)){let r={read:!!e.permission.super_user,insert:!1,update:!1,delete:!1,attribute_permissions:[]};e.permission.system.tables[t]=r}}catch(t){le.error("Got an error trying to set system permissions."),le.error(t)}}a(OY,"appendSystemTablesToRole");async function To(){try{let e=await o_();global.hdb_users=e}catch(e){throw le.error(e),e}}a(To,"setUsersToGlobal");async function Fb(e,t,r=!0){global.hdb_users||await To();let s=global.hdb_users.get(e);if(!s)throw Ps(new Error,im.GENERIC_AUTH_FAIL,vs.UNAUTHORIZED,void 0,void 0,!0);if(s&&!s.active)throw Ps(new Error,im.USER_INACTIVE,vs.UNAUTHORIZED,void 0,void 0,!0);let n={active:s.active,username:s.username};if(s.refresh_token&&(n.refresh_token=s.refresh_token),s.role&&(n.role=s.role),r===!0){if(wb.get(t)===s.password)return n;if(am.validate(s.password,t))wb.set(t,s.password);else throw Ps(new Error,im.GENERIC_AUTH_FAIL,vs.UNAUTHORIZED,void 0,void 0,!0)}return n}a(Fb,"findAndValidateUser");async function NY(){global.hdb_users||await To();for(let[,e]of global.hdb_users)if(e.role.role==="super_user")return e}a(NY,"getSuperUser");async function bY(){let e=await o_(),t=_Y.getConfigFromFile(yb.CONFIG_PARAMS.CLUSTERING_USER),r=e.get(t);if(!Rr.isEmpty(r)&&r?.role?.role===yb.ROLE_TYPES_ENUM.CLUSTER_USER)return r.decrypt_hash=um.decrypt(r.hash),r.uri_encoded_d_hash=encodeURIComponent(r.decrypt_hash),r.uri_encoded_name=encodeURIComponent(r.username),r.sys_name=r.username+Ib.SERVER_SUFFIX.ADMIN,r.sys_name_encoded=r.uri_encoded_name+Ib.SERVER_SUFFIX.ADMIN,r}a(bY,"getClusterUser");var Gb=[];_m.invalidateUser=function(e){for(let t of Gb)try{t(e)}catch(r){EY.error("Error invalidating user",r)}};_m.onInvalidatedUser=function(e){Gb.push(e)}});var ac=T((voe,Yb)=>{"use strict";var wi=G(),Ar=y(),yY=gN(),Moe=qn(),Poe=gi(),IY=Gr(),{validateEvent:kb}=us(),oc=os(),wY=require("process"),{resetDatabases:CY}=(fe(),Z(Ce)),LY={[Ar.ITC_EVENT_TYPES.SCHEMA]:DY,[Ar.ITC_EVENT_TYPES.USER]:$b};async function DY(e){let t=kb(e);if(t){wi.error(t);return}wi.trace("ITC schemaHandler received schema event:",e),await yY(e.message),await UY(e.message)}a(DY,"schemaHandler");async function UY(e){try{oc.resetReadTxn(Ar.SYSTEM_SCHEMA_NAME,Ar.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME),oc.resetReadTxn(Ar.SYSTEM_SCHEMA_NAME,Ar.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME),oc.resetReadTxn(Ar.SYSTEM_SCHEMA_NAME,Ar.SYSTEM_TABLE_NAMES.SCHEMA_TABLE_NAME);let t=CY();e.table&&e.database&&await t[e.database][e.table].put(Symbol.for("write-verify"),null)}catch(t){wi.error(t)}}a(UY,"syncSchemaMetadata");var Vb=[];async function $b(e){try{try{oc.resetReadTxn(Ar.SYSTEM_SCHEMA_NAME,Ar.SYSTEM_TABLE_NAMES.USER_TABLE_NAME),oc.resetReadTxn(Ar.SYSTEM_SCHEMA_NAME,Ar.SYSTEM_TABLE_NAMES.ROLE_TABLE_NAME)}catch(r){wi.warn(r)}let t=kb(e);if(t){wi.error(t);return}wi.trace(`ITC userHandler ${Ar.HDB_ITC_CLIENT_PREFIX}${wY.pid} received user event:`,e),await IY.setUsersToGlobal();for(let r of Vb)r()}catch(t){wi.error(t)}}a($b,"userHandler");$b.addListener=function(e){Vb.push(e)};Yb.exports=LY});var us=T((xoe,Wb)=>{"use strict";var Hoe=G(),dm=$(),MY=y(),{ITC_ERRORS:cc}=fr(),{parentPort:qoe,threadId:PY,isMainThread:vY,workerData:Foe}=require("worker_threads"),{onMessageFromWorkers:BY,broadcast:Goe,broadcastWithAcknowledgement:HY}=Je();Wb.exports={sendItcEvent:qY,validateEvent:Kb,SchemaEventMsg:FY,UserEventMsg:GY};var a_;BY(async(e,t)=>{a_=a_||ac(),Kb(e),a_[e.type]&&await a_[e.type](e),e.requestId&&t&&t.postMessage({type:"ack",id:e.requestId})});function qY(e){return!vY&&e.message&&(e.message.originator=PY),HY(e)}a(qY,"sendItcEvent");function Kb(e){if(typeof e!="object")return cc.INVALID_ITC_DATA_TYPE;if(!e.hasOwnProperty("type")||dm.isEmpty(e.type))return cc.MISSING_TYPE;if(!e.hasOwnProperty("message")||dm.isEmpty(e.message))return cc.MISSING_MSG;if(!e.message.hasOwnProperty("originator")||dm.isEmpty(e.message.originator))return cc.MISSING_ORIGIN;if(MY.ITC_EVENT_TYPES[e.type.toUpperCase()]===void 0)return cc.INVALID_EVENT(e.type)}a(Kb,"validateEvent");function FY(e,t,r,s=void 0,n=void 0){this.originator=e,this.operation=t,this.schema=r,this.table=s,this.attribute=n}a(FY,"SchemaEventMsg");function GY(e){this.originator=e}a(GY,"UserEventMsg")});var cn=T(($oe,Xb)=>{"use strict";var Qb=y(),Voe=$(),c_=G(),zb=pN(),go,{sendItcEvent:Jb}=us();function xY(e){try{c_.trace("signalSchemaChange called with message:",e),go=go||ac();let t=new zb(Qb.ITC_EVENT_TYPES.SCHEMA,e);return go.schema(t),Jb(t)}catch(t){c_.error(t)}}a(xY,"signalSchemaChange");function kY(e){try{c_.trace("signalUserChange called with message:",e),go=go||ac();let t=new zb(Qb.ITC_EVENT_TYPES.USER,e);return go.user(t),Jb(t)}catch(t){c_.error(t)}}a(kY,"signalUserChange");Xb.exports={signalSchemaChange:xY,signalUserChange:kY}});var u_=T((Koe,Zb)=>{"use strict";var jb=$(),VY=y(),$Y=G(),YY=Fl(),KY=ql(),WY=cn(),{SchemaEventMsg:QY}=us(),zY="already exists in";Zb.exports=JY;async function JY(e,t,r){if(jb.isEmptyOrZeroLength(r))return r;let s=[];jb.isEmptyOrZeroLength(t.attributes)||t.attributes.forEach(i=>{s.push(i.attribute)});let n=r.filter(i=>s.indexOf(i)<0);return n.length===0||await Promise.all(n.map(async i=>{await XY(e,t.schema,t.name,i)})),n}a(JY,"lmdbCheckForNewAttributes");async function XY(e,t,r,s){let n=new KY(t,r,s,void 0,!0);e&&(n.hdb_auth_header=e);try{await jY(n)}catch(i){if(typeof i=="object"&&i.message!==void 0&&i.message.includes(zY))$Y.warn(`attribute ${t}.${r}.${s} already exists`);else throw i}}a(XY,"createNewAttribute");async function jY(e){let t;return t=await YY(e),WY.signalSchemaChange(new QY(process.pid,VY.OPERATIONS_ENUM.CREATE_ATTRIBUTE,e.schema,e.table,e.attribute)),t}a(jY,"createAttribute")});var Ro=T((Qoe,ey)=>{"use strict";var fm=class{static{a(this,"LMDBTransactionObject")}constructor(t,r,s,n,i=void 0){this.operation=t,this.user_name=r,this.timestamp=s,this.hash_values=n,this.origin=i}};ey.exports=fm});var ry=T((Joe,ty)=>{"use strict";var ZY=Ro(),e1=y().OPERATIONS_ENUM,Em=class extends ZY{static{a(this,"LMDBInsertTransactionObject")}constructor(t,r,s,n,i=void 0){super(e1.INSERT,r,s,n,i),this.records=t}};ty.exports=Em});var ny=T((joe,sy)=>{"use strict";var t1=Ro(),r1=y().OPERATIONS_ENUM,hm=class extends t1{static{a(this,"LMDBUpdateTransactionObject")}constructor(t,r,s,n,i,o=void 0){super(r1.UPDATE,s,n,i,o),this.records=t,this.original_records=r}};sy.exports=hm});var oy=T((eae,iy)=>{"use strict";var s1=Ro(),n1=y().OPERATIONS_ENUM,mm=class extends s1{static{a(this,"LMDBUpsertTransactionObject")}constructor(t,r,s,n,i,o=void 0){super(n1.UPSERT,s,n,i,o),this.records=t,this.original_records=r}};iy.exports=mm});var cy=T((rae,ay)=>{"use strict";var i1=Ro(),o1=y().OPERATIONS_ENUM,pm=class extends i1{static{a(this,"LMDBDeleteTransactionObject")}constructor(t,r,s,n,i=void 0){super(o1.DELETE,s,n,t,i),this.original_records=r}};ay.exports=pm});var uc=T((iae,dy)=>{"use strict";var nae=require("path"),uy=De(),a1=ry(),c1=ny(),u1=oy(),l1=cy(),Ao=ze(),ly=$(),{CONFIG_PARAMS:_1}=y(),_y=X();_y.initSync();var l_=y().OPERATIONS_ENUM,{getTransactionAuditStorePath:d1}=ve();dy.exports=f1;async function f1(e,t){if(_y.get(_1.LOGGING_AUDITLOG)===!1)return;let r=d1(e.schema,e.table),s=await uy.openEnvironment(r,e.table,!0),n=E1(e,t);if(!(n===void 0||n.hash_values.length===0)&&s!==void 0){uy.initializeDBIs(s,Ao.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP,Ao.TRANSACTIONS_DBIS);let i=n.timestamp;return await s.dbis[Ao.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP].ifNoExists(i,()=>{s.dbis[Ao.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP].put(i,n),ly.isEmpty(n.user_name)||s.dbis[Ao.TRANSACTIONS_DBI_NAMES_ENUM.USER_NAME].put(n.user_name,i);for(let o=0;o<n.hash_values.length;o++)s.dbis[Ao.TRANSACTIONS_DBI_NAMES_ENUM.HASH_VALUE].put(n.hash_values[o],i)})}}a(f1,"writeTransaction");function E1(e,t){let r=ly.isEmpty(e.hdb_user)?void 0:e.hdb_user.username;if(e.operation===l_.INSERT)return new a1(e.records,r,t.txn_time,t.written_hashes,e.__origin);if(e.operation===l_.UPDATE)return new c1(e.records,t.original_records,r,t.txn_time,t.written_hashes,e.__origin);if(e.operation===l_.UPSERT)return new u1(e.records,t.original_records,r,t.txn_time,t.written_hashes,e.__origin);if(e.operation===l_.DELETE)return new l1(t.deleted,t.original_records,r,t.txn_time,e.__origin)}a(E1,"createTransactionObject")});var Sm=T((cae,fy)=>{"use strict";var h1=Xa(),aae=ja(),lc=y(),m1=rc(),p1=lo().insertRecords,S1=De(),T1=G(),g1=u_(),{getSchemaPath:R1}=ve(),A1=uc();fy.exports=O1;async function O1(e){try{let{schema_table:t,attributes:r}=h1(e);m1(e,r,t.hash_attribute),e.schema!==lc.SYSTEM_SCHEMA_NAME&&(r.includes(lc.TIME_STAMP_NAMES_ENUM.CREATED_TIME)||r.push(lc.TIME_STAMP_NAMES_ENUM.CREATED_TIME),r.includes(lc.TIME_STAMP_NAMES_ENUM.UPDATED_TIME)||r.push(lc.TIME_STAMP_NAMES_ENUM.UPDATED_TIME));let s=await g1(e.hdb_auth_header,t,r),n=R1(e.schema,e.table),i=await S1.openEnvironment(n,e.table),o=await p1(i,t.hash_attribute,r,e.records,e.__origin?.timestamp);try{await A1(e,o)}catch(c){T1.error(`unable to write transaction due to ${c.message}`)}return{written_hashes:o.written_hashes,skipped_hashes:o.skipped_hashes,schema_table:t,new_attributes:s,txn_time:o.txn_time}}catch(t){throw t}}a(O1,"lmdbCreateRecords")});var my=T((lae,hy)=>{"use strict";var Ey=y(),N1=Sm(),b1=ja(),y1=require("fs-extra"),{getSchemaPath:I1}=ve();hy.exports=w1;async function w1(e){let t=[{name:e.schema,createddate:Date.now()}],r=new b1(Ey.SYSTEM_SCHEMA_NAME,Ey.SYSTEM_TABLE_NAMES.SCHEMA_TABLE_NAME,void 0,t);await N1(r),await y1.mkdirp(I1(e.schema))}a(w1,"lmdbCreateSchema")});var Sy=T((dae,py)=>{"use strict";var Tm=class{static{a(this,"DeleteRecordsResponseObject")}constructor(t=[],r=[],s=void 0,n=[]){this.deleted=t,this.skipped=r,this.txn_time=s,this.original_records=n}};py.exports=Tm});var Ay=T((pae,Ry)=>{"use strict";var Ty=De(),gm=Er(),Rm=fr().LMDB_ERRORS_ENUM,C1=ze(),gy=G(),Eae=$(),L1=require("lmdb"),D1=Sy(),U1=y(),{OVERFLOW_MARKER:hae,MAX_SEARCH_KEY_LENGTH:mae}=C1,M1=U1.TIME_STAMP_NAMES_ENUM.UPDATED_TIME;async function P1(e,t,r,s){if(gm.validateEnv(e),t===void 0)throw new Error(Rm.HASH_ATTRIBUTE_REQUIRED);if(!Array.isArray(r))throw r===void 0?new Error(Rm.IDS_REQUIRED):new Error(Rm.IDS_MUST_BE_ITERABLE);try{let n=Ty.listDBIs(e);Ty.initializeDBIs(e,t,n);let i=new D1,o,c=[],u=[];for(let f=0,E=r.length;f<E;f++)try{o=r[f];let h=e.dbis[t].get(o);if(!h||s&&h[M1]>s){i.skipped.push(o);continue}let S=e.dbis[t].ifVersion(o,L1.IF_EXISTS,()=>{e.dbis[t].remove(o);for(let p=0;p<n.length;p++){let g=n[p];if(!h.hasOwnProperty(g)||g===t)continue;let b=e.dbis[g],O=h[g];if(O!=null)try{let Y=gm.getIndexedValues(O);if(Y)for(let W=0,F=Y.length;W<F;W++)b.remove(Y[W],o)}catch{gy.warn(`cannot delete from attribute: ${g}, ${O}:${o}`)}}});c.push(S),u.push(o),i.original_records.push(h)}catch(h){gy.warn(h),i.skipped.push(o)}let _=[],l=await Promise.all(c);for(let f=0,E=l.length;f<E;f++)l[f]===!0?i.deleted.push(u[f]):(i.skipped.push(u[f]),_.push(f));let d=0;for(let f=0;f<_.length;f++){let E=_[f];i.original_records.splice(E-d,1),d++}return i.txn_time=gm.getNextMonotonicTime(),i}catch(n){throw n}}a(P1,"deleteRecords");Ry.exports={deleteRecords:P1}});var _c=T((Tae,Ny)=>{"use strict";var Oo=$(),v1=Ay(),B1=De(),{getSchemaPath:H1}=ve(),q1=uc(),F1=G();Ny.exports=G1;async function G1(e,t=!0){let s=global.hdb_schema[e.schema][e.table].hash_attribute;if(Oo.isEmpty(s))throw new Error(`could not retrieve hash attribute for schema:${e.schema} and table ${e.table}`);try{if(Oo.isEmptyOrZeroLength(e.hash_values)&&!Oo.isEmptyOrZeroLength(e.records)){e.hash_values=[];for(let c=0;c<e.records.length;c++){let u=e.records[c][s];Oo.isEmpty(u)||e.hash_values.push(u)}}if(Oo.isEmptyOrZeroLength(e.hash_values))return Oy([],[]);if(!Array.isArray(e.hash_values))throw new Error("hash_values must be an array");if(Oo.isEmptyOrZeroLength(e.records)){e.records=[];for(let c=0;c<e.hash_values.length;c++)e.records[c]={[s]:e.hash_values[c]}}let n=H1(e.schema,e.table),i=await B1.openEnvironment(n,e.table),o=await v1.deleteRecords(i,s,e.hash_values,e.__origin?.timestamp);try{t===!0&&await q1(e,o)}catch(c){F1.error(`unable to write transaction due to ${c.message}`)}return Oy(o.deleted,o.skipped,o.txn_time)}catch(n){throw n}}a(G1,"lmdbDeleteRecords");function Oy(e,t,r){let s=e.length+t.length,n=s===1?"record":"records";return{message:`${e.length} of ${s} ${n} successfully deleted`,deleted_hashes:e,skipped_hashes:t,txn_time:r}}a(Oy,"createDeleteResponse")});var Om=T((Aae,by)=>{"use strict";var x1=y(),Rae=Er();function Am(e,t){let r=Object.create(null);if(t.length===1&&x1.SEARCH_WILDCARDS.indexOf(t[0])>=0)Object.assign(r,e);else for(let s=0;s<t.length;s++){let n=t[s],i=e[n];r[n]=i===void 0?null:i}return r}a(Am,"parseRow");function k1(e,t,r,s){let n=Am(r,e);s.push(n)}a(k1,"searchAll");function V1(e,t,r,s){let n=Am(r,e);s[t]=n}a(V1,"searchAllToMap");function $1(e,t,r){r[e]===void 0&&(r[e]=[]),r[e].push(t)}a($1,"iterateDBI");function Ci(e,t,r,s,n){let i=Object.create(null);i[n]=e;let o;s===n?o=e:(o=t,s!==void 0&&(i[s]=o)),r[0].push(o),r[1].push(i)}a(Ci,"pushResults");function Y1(e,t,r,s,n,i){t.toString().endsWith(e)&&Ci(t,r,s,n,i)}a(Y1,"endsWith");function K1(e,t,r,s,n,i){t.toString().includes(e)&&Ci(t,r,s,n,i)}a(K1,"contains");function W1(e,t,r,s,n,i){t>e&&Ci(t,r,s,n,i)}a(W1,"greaterThanCompare");function Q1(e,t,r,s,n,i){t>=e&&Ci(t,r,s,n,i)}a(Q1,"greaterThanEqualCompare");function z1(e,t,r,s,n,i){t<e&&Ci(t,r,s,n,i)}a(z1,"lessThanCompare");function J1(e,t,r,s,n,i){t<=e&&Ci(t,r,s,n,i)}a(J1,"lessThanEqualCompare");by.exports={parseRow:Am,searchAll:k1,searchAllToMap:V1,iterateDBI:$1,endsWith:Y1,contains:K1,greaterThanCompare:W1,greaterThanEqualCompare:Q1,lessThanCompare:z1,lessThanEqualCompare:J1,pushResults:Ci}});var No=T((Iae,Uy)=>{"use strict";var Vn=De(),Nae=G(),Or=Er(),__=ze(),Xe=fr().LMDB_ERRORS_ENUM,bae=$(),X1=y(),d_=Om(),{parseRow:j1}=d_,yae=require("lmdb"),{OVERFLOW_MARKER:yy,MAX_SEARCH_KEY_LENGTH:Z1}=__;function Iy(e,t,r,s=!1,n=void 0,i=void 0){return Li(e,t,r,(o,c)=>c.getRange({transaction:o,start:s?void 0:!1,end:s?!1:void 0,limit:n,offset:i,reverse:s}))}a(Iy,"iterateFullIndex");function dc(e,t,r,s,n,i=!1,o=void 0,c=void 0,u=!1,_=!1){return Li(e,t,r,(l,d,f,E)=>{let b={transaction:l,start:i===!0?n:s,end:i===!0?s:n,reverse:i,limit:o,offset:c,inclusiveEnd:i===!0?!u:!_,exclusiveStart:i===!0?_:u};return E===r?(b.values=!1,d.getRange(b).map(O=>({value:O}))):d.getRange(b)})}a(dc,"iterateRangeBetween");function Li(e,t,r,s){let n=e.database||e,i=Vn.openDBI(n,r);i[__.DBI_DEFINITION_NAME].is_hash_attribute?t=r:t&&Vn.openDBI(n,t);let o;e.database?o=e:(o=e.useReadTransaction(),o.database=e);let c=s(o,i,n,t);return c.transaction=o,e.database||(c.onDone=()=>{o.done()}),c}a(Li,"setupTransaction");function wy(e,t,r,s){let n;return function(i,o){if(typeof i=="string"&&i.endsWith(yy)){if(!n)if(r)n=Vn.openDBI(e,r);else{let u=Vn.listDBIs(e);for(let _=0,l=u.length;_<l&&(n=Vn.openDBI(e,u[_]),!n[__.DBI_DEFINITION_NAME].is_hash_attribute);_++);}i=n.get(o,{transaction:t,lazy:!0})[s]}return i}}a(wy,"getOverflowCheck");function eK(e,t,r,s=!1,n=void 0,i=void 0){if(Or.validateEnv(e),t===void 0)throw new Error(Xe.HASH_ATTRIBUTE_REQUIRED);return Li(e,t,t,(o,c,u)=>(f_(r),r=fc(u,r),c.getRange({transaction:o,start:s?void 0:!1,end:s?!1:void 0,limit:n,offset:i,reverse:s}).map(_=>j1(_.value,r))))}a(eK,"searchAll");function tK(e,t,r,s=!1,n=void 0,i=void 0){if(Or.validateEnv(e),t===void 0)throw new Error(Xe.HASH_ATTRIBUTE_REQUIRED);f_(r),r=fc(e.database||e,r);let o=new Map;for(let{key:c,value:u}of Iy(e,t,t,s,n,i))o.set(c,d_.parseRow(u,r));return o}a(tK,"searchAllToMap");function rK(e,t,r=!1,s=void 0,n=void 0){if(Or.validateEnv(e),t===void 0)throw new Error(Xe.ATTRIBUTE_REQUIRED);let i=Object.create(null),o=Iy(e,void 0,t,r,s,n),c=o.transaction,u=wy(c.database,c,void 0,t);for(let{key:_,value:l}of o){let d=u(_,l);i[d]===void 0&&(i[d]=[]),i[d].push(l)}return i}a(rK,"iterateDBI");function sK(e,t){if(Or.validateEnv(e),t===void 0)throw new Error(Xe.HASH_ATTRIBUTE_REQUIRED);return Vn.statDBI(e,t).entryCount}a(sK,"countAll");function nK(e,t,r,s,n=!1,i=void 0,o=void 0){return $n(e,r,s),Li(e,t,r,(c,u,_,l)=>(s=Or.convertKeyValueToWrite(s),l===r?u.get(s,{transaction:c,lazy:!0})===void 0?[]:[{key:s,value:s}]:u.getValues(s,{transaction:c,reverse:n,limit:i,offset:o}).map(d=>({key:s,value:d}))))}a(nK,"equals");function iK(e,t,r){return $n(e,t,r),Vn.openDBI(e,t).getValuesCount(r)}a(iK,"count");function oK(e,t,r,s,n=!1,i=void 0,o=void 0){return $n(e,r,s),Li(e,null,r,(c,u)=>{s=Or.convertKeyValueToWrite(s);let _=!0;typeof s=="number"&&(_=!1);let l;if(n===!0){let d;for(let f of u.getKeys({transaction:c,start:s}))if(!f.startsWith(s)){d=f;break}return d!==void 0&&(Number.isInteger(o)?o++:i++),l=u.getRange({transaction:c,start:d,end:void 0,reverse:n,limit:i,offset:o}).map(f=>{let{key:E}=f;if(E!==d){if(E.toString().startsWith(s))return f;if(_===!0)return l.DONE}}),l.filter(f=>f)}else return l=u.getRange({transaction:c,start:s,reverse:n,limit:i,offset:o}).map(d=>{if(d.key.toString().startsWith(s))return d;if(_===!0)return l.DONE}),_?l:l.filter(d=>d)})}a(oK,"startsWith");function aK(e,t,r,s,n=!1,i=void 0,o=void 0){return Cy(e,t,r,s,n,i,o,!0)}a(aK,"endsWith");function Cy(e,t,r,s,n=!1,i=void 0,o=void 0,c=!1){return $n(e,r,s),Li(e,null,r,(u,_,l,d)=>{let f=wy(l,u,d,r);return o=Number.isInteger(o)?o:0,_.getKeys({transaction:u,end:n?!1:void 0,reverse:n}).flatMap(E=>{let h=E.toString();return h.endsWith(yy)?_.getValues(E,{transaction:u}).map(S=>{let p=f(E,S);if(c?p.endsWith(s):p.includes(s))return{key:p,value:S}}).filter(S=>S):(c?h.endsWith(s):h.includes(s))?_[__.DBI_DEFINITION_NAME].is_hash_attribute?{key:E,value:E}:_.getValues(E,{transaction:u}).map(S=>({key:E,value:S})):[]}).slice(o,i===void 0?void 0:i+(o||0))})}a(Cy,"contains");function cK(e,t,r,s,n=!1,i=void 0,o=void 0){$n(e,r,s);let c=typeof s,u;return c==="string"?u="\uFFFF":c==="number"?u=1/0:c==="boolean"&&(u=!0),dc(e,t,r,s,u,n,i,o,!0,!1)}a(cK,"greaterThan");function uK(e,t,r,s,n=!1,i=void 0,o=void 0){$n(e,r,s);let c=typeof s,u;return c==="string"?u="\uFFFF":c==="number"?u=1/0:c==="boolean"&&(u=!0),dc(e,t,r,s,u,n,i,o,!1,!1)}a(uK,"greaterThanEqual");function lK(e,t,r,s,n=!1,i=void 0,o=void 0){$n(e,r,s);let c=typeof s,u;return c==="string"?u="\0":c==="number"?u=-1/0:c==="boolean"&&(u=!1),dc(e,t,r,u,s,n,i,o,!1,!0)}a(lK,"lessThan");function _K(e,t,r,s,n=!1,i=void 0,o=void 0){$n(e,r,s);let c=typeof s,u;return c==="string"?u="\0":c==="number"?u=-1/0:c==="boolean"&&(u=!1),dc(e,t,r,u,s,n,i,o,!1,!1)}a(_K,"lessThanEqual");function dK(e,t,r,s,n,i=!1,o=void 0,c=void 0){if(Or.validateEnv(e),r===void 0)throw new Error(Xe.ATTRIBUTE_REQUIRED);if(s===void 0)throw new Error(Xe.START_VALUE_REQUIRED);if(n===void 0)throw new Error(Xe.END_VALUE_REQUIRED);if(s=Or.convertKeyValueToWrite(s),n=Or.convertKeyValueToWrite(n),s>n)throw new Error(Xe.END_VALUE_MUST_BE_GREATER_THAN_START_VALUE);return dc(e,t,r,s,n,i,o,c)}a(dK,"between");function fK(e,t,r,s){Or.validateEnv(e);let n=e.database||e,i=e.database?e:null;if(t===void 0)throw new Error(Xe.HASH_ATTRIBUTE_REQUIRED);if(f_(r),r=fc(n,r),s===void 0)throw new Error(Xe.ID_REQUIRED);let o=null,c=n.dbis[t].get(s,{transaction:i,lazy:r.length<3});return c&&(o=d_.parseRow(c,r)),o}a(fK,"searchByHash");function EK(e,t,r){Or.validateEnv(e);let s=e.database||e,n=e.database?e:null;if(t===void 0)throw new Error(Xe.HASH_ATTRIBUTE_REQUIRED);if(r===void 0)throw new Error(Xe.ID_REQUIRED);let i=!0;return s.dbis[t].get(r,{transaction:n,lazy:!0})===void 0&&(i=!1),i}a(EK,"checkHashExists");function hK(e,t,r,s,n=[]){return Dy(e,t,r,s,n),Ly(e,t,r,s,n).map(i=>i[1])}a(hK,"batchSearchByHash");function mK(e,t,r,s,n=[]){Dy(e,t,r,s,n);let i=new Map;for(let[o,c]of Ly(e,t,r,s,n))i.set(o,c);return i}a(mK,"batchSearchByHashToMap");function Ly(e,t,r,s,n=[]){return Li(e,t,t,(i,o,c)=>{r=fc(c,r);let u=r.length<3;return s.map(_=>{let l=c.dbis[t].get(_,{transaction:i,lazy:u});if(l)return[_,d_.parseRow(l,r)];n.push(_)}).filter(_=>_)})}a(Ly,"batchHashSearch");function Dy(e,t,r,s,n){if(Or.validateEnv(e),t===void 0)throw new Error(Xe.HASH_ATTRIBUTE_REQUIRED);if(f_(r),s==null)throw new Error(Xe.IDS_REQUIRED);if(!s[Symbol.iterator])throw new Error(Xe.IDS_MUST_BE_ITERABLE)}a(Dy,"initializeBatchSearchByHash");function f_(e){if(!Array.isArray(e))throw e===void 0?new Error(Xe.FETCH_ATTRIBUTES_REQUIRED):new Error(Xe.FETCH_ATTRIBUTES_MUST_BE_ARRAY)}a(f_,"validateFetchAttributes");function $n(e,t,r){if(Or.validateEnv(e),t===void 0)throw new Error(Xe.ATTRIBUTE_REQUIRED);if(r===void 0)throw new Error(Xe.SEARCH_VALUE_REQUIRED);if(r?.length>Z1)throw new Error(Xe.SEARCH_VALUE_TOO_LARGE)}a($n,"validateComparisonFunctions");function fc(e,t){return t.length===1&&X1.SEARCH_WILDCARDS.indexOf(t[0])>=0&&(t=Vn.listDBIs(e)),t}a(fc,"setGetWholeRowAttributes");Uy.exports={searchAll:eK,searchAllToMap:tK,count:iK,countAll:sK,equals:nK,startsWith:oK,endsWith:aK,contains:Cy,searchByHash:fK,setGetWholeRowAttributes:fc,batchSearchByHash:hK,batchSearchByHashToMap:mK,checkHashExists:EK,iterateDBI:rK,greaterThan:cK,greaterThanEqual:uK,lessThan:lK,lessThanEqual:_K,between:dK}});var bo=T((Cae,Hy)=>{var My=require("lodash"),Py=ke(),Be=require("joi"),pK=$(),{hdb_schema_table:E_,checkValidTable:vy,hdb_table:By,hdb_database:h_}=Ds(),{handleHDBError:SK,hdb_errors:TK}=j(),{getDatabases:gK}=(fe(),Z(Ce)),{HTTP_STATUS_CODES:RK}=TK,AK=Be.object({database:h_,schema:h_,table:By,search_attribute:E_,search_value:Be.any().required(),get_attributes:Be.array().min(1).items(E_).optional(),desc:Be.bool(),limit:Be.number().integer().min(1),offset:Be.number().integer().min(0)}),OK=Be.object({database:h_,schema:h_,table:By,operator:Be.string().valid("and","or").default("and").lowercase(),offset:Be.number().integer().min(0),limit:Be.number().integer().min(1),get_attributes:Be.array().min(1).items(E_).optional(),conditions:Be.array().min(1).items(Be.object({search_attribute:E_,search_type:Be.string().valid("equals","contains","starts_with","ends_with","greater_than","greater_than_equal","less_than","less_than_equal","between").optional(),search_value:Be.when("search_type",{switch:[{is:"equals",then:Be.any()},{is:"between",then:Be.array().items(Be.alternatives([Be.string(),Be.number()])).length(2)}],otherwise:Be.alternatives(Be.string(),Be.number())}).required()})).required()});Hy.exports=function(e,t){let r=null;switch(t){case"value":r=Py.validateBySchema(e,AK);break;case"hashes":let i=function(o){n?n+=". "+o:n=o};var s=i;a(i,"addError");let n;i(vy("database",e.schema)),i(vy("table",e.table)),e.hash_values?Array.isArray(e.hash_values)?e.hash_values.every(o=>typeof o=="string"||typeof o=="number")||i("'hash_values' must be strings or numbers"):i("'hash_values' must be an array"):i("'hash_values' is required"),e.get_attributes?Array.isArray(e.get_attributes)?e.get_attributes.length===0?i("'get_attributes' must contain at least 1 item"):e.get_attributes.every(o=>typeof o=="string"||typeof o=="number")||i("'get_attributes' must be strings or numbers"):i("'get_attributes' must be an array"):i("'get_attributes' is required"),n&&(r=new Error(n.trim()));break;case"conditions":r=Py.validateBySchema(e,OK);break;default:throw new Error(`Error validating search, unknown type: ${t}`)}if(!r&&e.schema!=="system"){let n=pK.checkGlobalSchemaTable(e.schema,e.table);if(n)return SK(new Error,n,RK.NOT_FOUND);let o=gK()[e.schema][e.table].attributes,c=e.get_attributes?[...e.get_attributes]:[];if(t==="value"&&c.push(e.search_attribute),t==="conditions")for(let _=0,l=e.conditions.length;_<l;_++){let d=e.conditions[_];c.push(d.search_attribute)}let u=My.filter(c,_=>_!=="*"&&_.attribute!=="*"&&!My.some(o,l=>l===_||l.attribute===_||l.attribute===_.attribute));if(u&&u.length>0){let _=u.join(", ");return _=_.replace(/,([^,]*)$/," and$1"),new Error(`unknown attribute '${_}'`)}}return r}});var Nm=T((Dae,qy)=>{"use strict";var NK=De(),bK=bo(),{getSchemaPath:yK}=ve();qy.exports=IK;function IK(e){let t=bK(e,"hashes");if(t)throw t;let r=yK(e.schema,e.table);return NK.openEnvironment(r,e.table)}a(IK,"initialize")});var bm=T((Mae,Fy)=>{"use strict";var wK=No(),CK=Nm();Fy.exports=LK;async function LK(e){let t=await CK(e),r=t.useReadTransaction();r.database=t;let s=global.hdb_schema[e.schema][e.table];try{return wK.batchSearchByHashToMap(r,s.hash_attribute,e.get_attributes,e.hash_values)}finally{r.done()}}a(LK,"lmdbGetDataByHash")});var yo=T((vae,Gy)=>{"use strict";var ym=class{static{a(this,"SearchByHashObject")}constructor(t,r,s,n){this.schema=t,this.table=r,this.hash_values=s,this.get_attributes=n}};Gy.exports=ym});var ky=T((qae,xy)=>{"use strict";var Hae=yo(),DK=No(),UK=Nm();xy.exports=MK;async function MK(e){let t=await UK(e),r=global.hdb_schema[e.schema][e.table];return DK.batchSearchByHash(t,r.hash_attribute,e.get_attributes,e.hash_values)}a(MK,"lmdbSearchByHash")});var Bs=T((Gae,Vy)=>{"use strict";var Im=class{static{a(this,"SearchObject")}constructor(t,r,s,n,i,o,c,u=!1,_=void 0,l=void 0){this.schema=t,this.table=r,this.search_attribute=s,this.search_value=n,this.hash_attribute=i,this.get_attributes=o,this.end_value=c,this.reverse=u,this.limit=_,this.offset=l}};Vy.exports=Im});var m_=T((kae,zy)=>{"use strict";var Gt=No(),PK=De(),vK=$(),ae=ze(),Di=y(),BK=Si(),$y=fr().LMDB_ERRORS_ENUM,{getSchemaPath:HK}=ve(),un=Di.SEARCH_WILDCARDS;async function qK(e,t,r){let s;e.schema===Di.SYSTEM_SCHEMA_NAME?s=BK[e.table]:s=global.hdb_schema[e.schema][e.table];let n=Qy(e,s.hash_attribute,r,t);return Ky(e,n,s.hash_attribute,r)}a(qK,"prepSearch");async function Ky(e,t,r,s){let n=HK(e.schema,e.table),i=await PK.openEnvironment(n,e.table),o=Wy(i,e,t,r),c=o.transaction||i;if([ae.SEARCH_TYPES.BATCH_SEARCH_BY_HASH,ae.SEARCH_TYPES.BATCH_SEARCH_BY_HASH_TO_MAP,ae.SEARCH_TYPES.SEARCH_ALL,ae.SEARCH_TYPES.SEARCH_ALL_TO_MAP].indexOf(t)>=0)return o;if(FK(e,r)===!1){let l=e.search_attribute;if(l===r)return s?Yy(o,()=>!0):o.map(f=>({[r]:f.key}));let d=a(f=>({[r]:f.value,[l]:f.key}),"toObject");return s?Yy(o,d):o.map(d)}let _=e.search_attribute===r?o.map(l=>l.key):o.map(l=>l.value);return s===!0?Gt.batchSearchByHashToMap(c,r,e.get_attributes,_):Gt.batchSearchByHash(c,r,e.get_attributes,_)}a(Ky,"executeSearch");function Wy(e,t,r,s){let n,i=s;t.get_attributes.indexOf(s)<0&&(i=void 0);let{reverse:o,limit:c,offset:u}=t;switch(o=typeof o=="boolean"?o:!1,c=Number.isInteger(c)?c:void 0,u=Number.isInteger(u)?u:void 0,r){case ae.SEARCH_TYPES.EQUALS:n=Gt.equals(e,i,t.search_attribute,t.search_value,o,c,u);break;case ae.SEARCH_TYPES.CONTAINS:n=Gt.contains(e,i,t.search_attribute,t.search_value,o,c,u);break;case ae.SEARCH_TYPES.ENDS_WITH:case ae.SEARCH_TYPES._ENDS_WITH:n=Gt.endsWith(e,i,t.search_attribute,t.search_value,o,c,u);break;case ae.SEARCH_TYPES.STARTS_WITH:case ae.SEARCH_TYPES._STARTS_WITH:n=Gt.startsWith(e,i,t.search_attribute,t.search_value,o,c,u);break;case ae.SEARCH_TYPES.BATCH_SEARCH_BY_HASH:return Gt.batchSearchByHash(e,t.search_attribute,t.get_attributes,[t.search_value]);case ae.SEARCH_TYPES.BATCH_SEARCH_BY_HASH_TO_MAP:return Gt.batchSearchByHashToMap(e,t.search_attribute,t.get_attributes,[t.search_value]);case ae.SEARCH_TYPES.SEARCH_ALL:return Gt.searchAll(e,s,t.get_attributes,o,c,u);case ae.SEARCH_TYPES.SEARCH_ALL_TO_MAP:return Gt.searchAllToMap(e,s,t.get_attributes,o,c,u);case ae.SEARCH_TYPES.BETWEEN:n=Gt.between(e,i,t.search_attribute,t.search_value,t.end_value,o,c,u);break;case ae.SEARCH_TYPES.GREATER_THAN:case ae.SEARCH_TYPES._GREATER_THAN:n=Gt.greaterThan(e,i,t.search_attribute,t.search_value,o,c,u);break;case ae.SEARCH_TYPES.GREATER_THAN_EQUAL:case ae.SEARCH_TYPES._GREATER_THAN_EQUAL:n=Gt.greaterThanEqual(e,i,t.search_attribute,t.search_value,o,c,u);break;case ae.SEARCH_TYPES.LESS_THAN:case ae.SEARCH_TYPES._LESS_THAN:n=Gt.lessThan(e,i,t.search_attribute,t.search_value,o,c,u);break;case ae.SEARCH_TYPES.LESS_THAN_EQUAL:case ae.SEARCH_TYPES._LESS_THAN_EQUAL:n=Gt.lessThanEqual(e,i,t.search_attribute,t.search_value,o,c,u);break;default:return Object.create(null)}return n}a(Wy,"searchByType");function Yy(e,t){let r=new Map;for(let s of e)r.set(s.value,t(s));return r}a(Yy,"createMapFromIterable");function FK(e,t){if(e.get_attributes.length===1&&e.get_attributes[0]==="*")return!0;let r=[e.search_attribute];e.get_attributes.indexOf(t)>=0&&r.push(t);let s=!1;for(let n=0;n<e.get_attributes.length;n++)if(r.indexOf(e.get_attributes[n])<0){s=!0;break}return s}a(FK,"checkToFetchMore");function Qy(e,t,r,s){if(vK.isEmpty(s)){let n=e.search_value;typeof n=="object"?n=JSON.stringify(n):n=n.toString();let i=n.charAt(0),o=n.charAt(n.length-1),c=!1;if(e.search_attribute===t&&(c=!0),un.indexOf(n)>-1)return r===!0?ae.SEARCH_TYPES.SEARCH_ALL_TO_MAP:ae.SEARCH_TYPES.SEARCH_ALL;if(n.indexOf(un[0])<0&&n.indexOf(un[1])<0)return c===!0?r===!0?ae.SEARCH_TYPES.BATCH_SEARCH_BY_HASH_TO_MAP:ae.SEARCH_TYPES.BATCH_SEARCH_BY_HASH:ae.SEARCH_TYPES.EQUALS;if(un.indexOf(i)>=0&&un.indexOf(o)>=0)return e.search_value=e.search_value.slice(1,-1),ae.SEARCH_TYPES.CONTAINS;if(un.indexOf(i)>=0)return e.search_value=e.search_value.substr(1),ae.SEARCH_TYPES.ENDS_WITH;if(un.indexOf(o)>=0)return e.search_value=e.search_value.slice(0,-1),ae.SEARCH_TYPES.STARTS_WITH;if(n.includes(un[0])||n.includes(un[1]))return ae.SEARCH_TYPES.EQUALS;throw new Error($y.UNKNOWN_SEARCH_TYPE)}else switch(s){case Di.VALUE_SEARCH_COMPARATORS.BETWEEN:return ae.SEARCH_TYPES.BETWEEN;case Di.VALUE_SEARCH_COMPARATORS.GREATER:return ae.SEARCH_TYPES.GREATER_THAN;case Di.VALUE_SEARCH_COMPARATORS.GREATER_OR_EQ:return ae.SEARCH_TYPES.GREATER_THAN_EQUAL;case Di.VALUE_SEARCH_COMPARATORS.LESS:return ae.SEARCH_TYPES.LESS_THAN;case Di.VALUE_SEARCH_COMPARATORS.LESS_OR_EQ:return ae.SEARCH_TYPES.LESS_THAN_EQUAL;default:throw new Error($y.UNKNOWN_SEARCH_TYPE)}}a(Qy,"createSearchTypeFromSearchObject");zy.exports={executeSearch:Ky,createSearchTypeFromSearchObject:Qy,prepSearch:qK,searchByType:Wy}});var Xy=T((Yae,Jy)=>{"use strict";var $ae=Bs(),GK=bo(),xK=$(),kK=y(),VK=m_();Jy.exports=$K;function $K(e,t){if(!xK.isEmpty(t)&&kK.VALUE_SEARCH_COMPARATORS_REVERSE_LOOKUP[t]===void 0)throw new Error(`Value search comparator - ${t} - is not valid`);let s=GK(e,"value");if(s)throw s;let n=!0;return VK.prepSearch(e,t,n)}a($K,"lmdbGetDataByValue")});var Ec=T((Qae,jy)=>{"use strict";var Wae=Bs(),YK=bo(),KK=$(),WK=y(),QK=m_();jy.exports=zK;async function zK(e,t){if(!KK.isEmpty(t)&&WK.VALUE_SEARCH_COMPARATORS_REVERSE_LOOKUP[t]===void 0)throw new Error(`Value search comparator - ${t} - is not valid`);let s=YK(e,"value");if(s)throw s;return QK.prepSearch(e,t,!1)}a(zK,"lmdbSearchByValue")});var eI=T((Xae,Zy)=>{"use strict";var Jae=ze(),wm=class{static{a(this,"SearchByConditionsObject")}constructor(t,r,s,n,i=void 0,o=void 0,c="and"){this.schema=t,this.table=r,this.get_attributes=s,this.limit=i,this.offset=o,this.conditions=n,this.operator=c}},Cm=class{static{a(this,"SearchCondition")}constructor(t,r,s){this.search_attribute=t,this.search_type=r,this.search_value=s}},Lm=class{static{a(this,"SortAttribute")}constructor(t,r){this.attribute=t,this.desc=r}};Zy.exports={SearchByConditionsObject:wm,SearchCondition:Cm,SortAttribute:Lm}});var iI=T((tce,nI)=>{"use strict";var Zae=eI().SearchByConditionsObject,JK=Bs(),XK=bo(),Dm=No(),p_=ze(),{Resource:ece}=(ss(),Z(UE)),sI=m_(),jK=Om(),ZK=require("lodash"),{getSchemaPath:eW}=ve(),tI=De(),{handleHDBError:tW,hdb_errors:rW}=j(),{HTTP_STATUS_CODES:sW}=rW,nW=1e8;nI.exports=iW;async function iW(e){let t=XK(e,"conditions");if(t)throw tW(t,t.message,sW.BAD_REQUEST,void 0,void 0,!0);e.operator=e.operator?e.operator.toLowerCase():void 0,e.offset=Number.isInteger(e.offset)?e.offset:0;let r=eW(e.schema,e.table),s=await tI.openEnvironment(r,e.table),n=global.hdb_schema[e.schema][e.table];for(let _ of e.conditions)tI.openDBI(s,_.search_attribute);let i=ZK.sortBy(e.conditions,_=>{if(_.estimated_count===void 0){let l=_.search_type;l===p_.SEARCH_TYPES.EQUALS?_.estimated_count=Dm.count(s,_.search_attribute,_.search_value):l===p_.SEARCH_TYPES.CONTAINS||l===p_.SEARCH_TYPES.ENDS_WITH?_.estimated_count=1/0:_.estimated_count=nW}return _.estimated_count}),o=s.useReadTransaction();o.database=s;let c=await rI(o,e,i[0],n.hash_attribute),u;if(!e.operator||e.operator.toLowerCase()==="and"){let _=s.dbis[n.hash_attribute],l=i.slice(1).map(sI.filterByType),d=l.length,f=Dm.setGetWholeRowAttributes(s,e.get_attributes);u=c.map(E=>_.get(E,{transaction:o,lazy:!0})),d>0&&(u=u.filter(E=>{for(let h=0;h<d;h++)if(!l[h](E))return!1;return!0})),(e.offset||e.limit!==void 0)&&(u=u.slice(e.offset,e.limit!==void 0?(e.offset||0)+e.limit:void 0)),u=u.map(E=>jK.parseRow(E,f))}else{for(let d=1;d<i.length;d++){let f=i[d],E=await rI(o,e,f,n.hash_attribute);c=c.concat(E)}let _=new Set,l=e.offset||0;c=c.filter(d=>_.has(d)?!1:(_.add(d),!0)).slice(l,e.limit&&e.limit+l),u=Dm.batchSearchByHash(o,n.hash_attribute,e.get_attributes,c)}return u.onDone=()=>{o.done()},u}a(iW,"lmdbSearchByConditions");async function rI(e,t,r,s){let n=new JK(t.schema,t.table,void 0,void 0,s,t.get_attributes),i=r.search_type;return n.search_attribute=r.search_attribute,i===p_.SEARCH_TYPES.BETWEEN?(n.search_value=r.search_value[0],n.end_value=r.search_value[1]):n.search_value=r.search_value,sI.searchByType(e,n,i,s).map(o=>o.value)}a(rI,"executeConditionSearch")});var hc=T((sce,oI)=>{"use strict";var oW=y().OPERATIONS_ENUM,Um=class{static{a(this,"DeleteObject")}constructor(t,r,s,n=void 0){this.operation=oW.DELETE,this.schema=t,this.table=r,this.hash_values=s,this.__origin=n}};oI.exports=Um});var Mm=T((ice,EI)=>{"use strict";var lI=Bs(),_I=hc(),dI=Ec(),fI=_c(),Xt=y(),aI=$(),cI=De(),{getTransactionAuditStorePath:aW,getSchemaPath:cW}=ve(),uI=G();EI.exports=uW;async function uW(e){try{if(aI.isEmpty(global.hdb_schema[e.schema])||aI.isEmpty(global.hdb_schema[e.schema][e.table]))throw new Error(`unknown schema:${e.schema} and table ${e.table}`);await lW(e),await _W(e);let t=cW(e.schema,e.table);try{await cI.deleteEnvironment(t,e.table)}catch(r){if(r.message==="invalid environment")uI.warn(`cannot delete environment for ${e.schema}.${e.table}, environment not found`);else throw r}try{let r=aW(e.schema,e.table);await cI.deleteEnvironment(r,e.table,!0)}catch(r){if(r.message==="invalid environment")uI.warn(`cannot delete environment for ${e.schema}.${e.table}, environment not found`);else throw r}}catch(t){throw t}}a(uW,"lmdbDropTable");async function lW(e){let t=new lI(Xt.SYSTEM_SCHEMA_NAME,Xt.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME,Xt.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_SCHEMA_TABLE_KEY,`${e.schema}.${e.table}`,void 0,[Xt.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ID_KEY]),r=Array.from(await dI(t)),s=[];for(let i=0;i<r.length;i++){let o=r[i];s.push(o.id)}if(s.length===0)return;let n=new _I(Xt.SYSTEM_SCHEMA_NAME,Xt.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME,s);await fI(n)}a(lW,"deleteAttributesFromSystem");async function _W(e){let t=new lI(Xt.SYSTEM_SCHEMA_NAME,Xt.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME,Xt.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_NAME_KEY,e.table,void 0,[Xt.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_NAME_KEY,Xt.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_SCHEMA_KEY,Xt.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ID_KEY]),r,s;try{r=Array.from(await dI(t))}catch(i){throw i}for(let i=0;i<r.length;i++){let o=r[i];o.name===e.table&&o.schema===e.schema&&(s=o)}if(!s)throw new Error(`${e.schema}.${e.table} was not found`);let n=new _I(Xt.SYSTEM_SCHEMA_NAME,Xt.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME,[s.id]);try{await fI(n)}catch(i){throw i}}a(_W,"dropTableFromSystem")});var mI=T((ace,hI)=>{"use strict";var dW=require("fs-extra"),fW=Bs(),EW=yo(),hW=hc(),mW=Mm(),pW=_c(),SW=bm(),TW=Ec(),ln=y(),{getSchemaPath:gW}=ve(),{handleHDBError:RW,hdb_errors:AW}=j(),{HDB_ERROR_MSGS:OW,HTTP_STATUS_CODES:NW}=AW;hI.exports=bW;async function bW(e){let t;try{t=await yW(e.schema);let r=new fW(ln.SYSTEM_SCHEMA_NAME,ln.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME,ln.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_SCHEMA_KEY,t,void 0,[ln.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_NAME_KEY]),s=Array.from(await TW(r));for(let o=0;o<s.length;o++){let c={schema:t,table:s[o].name};try{await mW(c)}catch(u){if(u.message!=="invalid environment")throw u}}let n=new hW(ln.SYSTEM_SCHEMA_NAME,ln.SYSTEM_TABLE_NAMES.SCHEMA_TABLE_NAME,[t]);await pW(n);let i=gW(t);await dW.remove(i)}catch(r){throw r}}a(bW,"lmdbDropSchema");async function yW(e){let t=new EW(ln.SYSTEM_SCHEMA_NAME,ln.SYSTEM_TABLE_NAMES.SCHEMA_TABLE_NAME,[e],[ln.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_NAME_KEY]),r,s;try{r=Array.from(await SW(t))}catch(n){throw n}for(let[,n]of r)n.name===e&&(s=e);if(!s)throw RW(new Error,OW.SCHEMA_NOT_FOUND(e),NW.NOT_FOUND,void 0,void 0,!0);return s}a(yW,"validateDropSchema")});var vm=T((uce,pI)=>{"use strict";var Pm=class{static{a(this,"CreateTableObject")}constructor(t,r,s){this.schema=t,this.table=r,this.hash_attribute=s}};pI.exports=Pm});var TI=T((dce,SI)=>{"use strict";var IW=require("fs-extra"),S_=De(),{getTransactionAuditStorePath:wW}=ve(),Bm=ze(),_ce=vm();SI.exports=CW;async function CW(e){let t;try{let r=wW(e.schema,e.table);await IW.mkdirp(r),t=await S_.createEnvironment(r,e.table,!0)}catch(r){throw r.message=`unable to create transactions audit environment for ${e.schema}.${e.table} due to: ${r.message}`,r}try{S_.createDBI(t,Bm.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP,!1,!0),S_.createDBI(t,Bm.TRANSACTIONS_DBI_NAMES_ENUM.HASH_VALUE,!0,!1),S_.createDBI(t,Bm.TRANSACTIONS_DBI_NAMES_ENUM.USER_NAME,!0,!1)}catch(r){throw r.message=`unable to create dbi for ${e.schema}.${e.table} due to: ${r.message}`,r}return t}a(CW,"createTransactionsAuditEnvironment")});var OI=T((Ece,AI)=>{"use strict";var Hm=y(),gI=De(),LW=lo(),{getSystemSchemaPath:DW,getSchemaPath:UW}=ve(),MW=Si(),PW=Fl(),qm=ql(),vW=G(),BW=TI(),Gm=MW.hdb_table,RI=[];for(let e=0;e<Gm.attributes.length;e++)RI.push(Gm.attributes[e].attribute);AI.exports=HW;async function HW(e,t){let r=UW(t.schema,t.table),s=new qm(t.schema,t.table,Hm.TIME_STAMP_NAMES_ENUM.CREATED_TIME,void 0,!0),n=new qm(t.schema,t.table,Hm.TIME_STAMP_NAMES_ENUM.UPDATED_TIME,void 0,!0),i=new qm(t.schema,t.table,t.hash_attribute,void 0,!1,!0);try{if(await gI.createEnvironment(r,t.table),e!==void 0){let o=await gI.openEnvironment(DW(),Hm.SYSTEM_TABLE_NAMES.TABLE_TABLE_NAME);await LW.insertRecords(o,Gm.hash_attribute,RI,[e]),s.skip_table_check=!0,n.skip_table_check=!0,i.skip_table_check=!0,await Fm(s),await Fm(n),await Fm(i)}await BW(t)}catch(o){throw o}}a(HW,"lmdbCreateTable");async function Fm(e){try{await PW(e)}catch(t){vW.warn(`failed to create attribute ${e.attribute} due to ${t.message}`)}}a(Fm,"createAttribute")});var bI=T((mce,NI)=>{"use strict";var qW=Xa(),FW=rc(),GW=u_(),mc=y(),xW=lo().updateRecords,kW=De(),{getSchemaPath:VW}=ve(),$W=uc(),YW=G();NI.exports=KW;async function KW(e){try{let{schema_table:t,attributes:r}=qW(e);FW(e,r,t.hash_attribute),e.schema!==mc.SYSTEM_SCHEMA_NAME&&(r.includes(mc.TIME_STAMP_NAMES_ENUM.CREATED_TIME)||r.push(mc.TIME_STAMP_NAMES_ENUM.CREATED_TIME),r.includes(mc.TIME_STAMP_NAMES_ENUM.UPDATED_TIME)||r.push(mc.TIME_STAMP_NAMES_ENUM.UPDATED_TIME));let s=await GW(e.hdb_auth_header,t,r),n=VW(e.schema,e.table),i=await kW.openEnvironment(n,e.table),o=await xW(i,t.hash_attribute,r,e.records,e.__origin?.timestamp);try{await $W(e,o)}catch(c){YW.error(`unable to write transaction due to ${c.message}`)}return{written_hashes:o.written_hashes,skipped_hashes:o.skipped_hashes,schema_table:t,new_attributes:s,txn_time:o.txn_time}}catch(t){throw t}}a(KW,"lmdbUpdateRecords")});var II=T((Sce,yI)=>{"use strict";var WW=y().OPERATIONS_ENUM,xm=class{static{a(this,"UpsertObject")}constructor(t,r,s,n=void 0){this.operation=WW.UPSERT,this.schema=t,this.table=r,this.records=s,this.__origin=n}};yI.exports=xm});var CI=T((Rce,wI)=>{"use strict";var gce=II(),QW=Xa(),zW=rc(),JW=u_(),pc=y(),XW=lo().upsertRecords,jW=De(),{getSchemaPath:ZW}=ve(),eQ=uc(),tQ=G(),{handleHDBError:rQ,hdb_errors:sQ}=j();wI.exports=nQ;async function nQ(e){let t;try{t=QW(e)}catch(u){throw rQ(u,u.message,sQ.HTTP_STATUS_CODES.BAD_REQUEST,void 0,void 0,!0)}let{schema_table:r,attributes:s}=t;zW(e,s,r.hash_attribute),e.schema!==pc.SYSTEM_SCHEMA_NAME&&(s.includes(pc.TIME_STAMP_NAMES_ENUM.CREATED_TIME)||s.push(pc.TIME_STAMP_NAMES_ENUM.CREATED_TIME),s.includes(pc.TIME_STAMP_NAMES_ENUM.UPDATED_TIME)||s.push(pc.TIME_STAMP_NAMES_ENUM.UPDATED_TIME));let n=await JW(e.hdb_auth_header,r,s),i=ZW(e.schema,e.table),o=await jW.openEnvironment(i,e.table),c=await XW(o,r.hash_attribute,s,e.records,e.__origin?.timestamp);try{await eQ(e,c)}catch(u){tQ.error(`unable to write transaction due to ${u.message}`)}return{written_hashes:c.written_hashes,schema_table:r,new_attributes:n,txn_time:c.txn_time}}a(nQ,"lmdbUpsertRecords")});var DI=T((Oce,LI)=>{"use strict";var km=class{static{a(this,"DeleteBeforeObject")}constructor(t,r,s){this.schema=t,this.table=r,this.timestamp=s}};LI.exports=km});var MI=T((bce,UI)=>{"use strict";var Vm=class{static{a(this,"DeleteAuditLogsBeforeResults")}constructor(t=void 0,r=void 0,s=0){this.start_timestamp=t,this.end_timestamp=r,this.transactions_deleted=s}};UI.exports=Vm});var BI=T((wce,vI)=>{"use strict";var $m=De(),{getTransactionAuditStorePath:iQ}=ve(),Ice=DI(),Sc=ze(),oQ=$(),PI=MI(),aQ=require("util").promisify,cQ=aQ(setTimeout),uQ=1e4,lQ=100;vI.exports=_Q;async function _Q(e){let t=iQ(e.schema,e.table),r=await $m.openEnvironment(t,e.table,!0),s=$m.listDBIs(r);$m.initializeDBIs(r,Sc.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP,s);let n,i=new PI;do n=await dQ(r,e.timestamp),i.start_timestamp===void 0&&(i.start_timestamp=n.start_timestamp),n.end_timestamp!==void 0&&(i.end_timestamp=n.end_timestamp),i.transactions_deleted+=n.transactions_deleted,await cQ(lQ);while(n.transactions_deleted>0);return i}a(_Q,"deleteAuditLogsBefore");async function dQ(e,t){let r=new PI;try{let s=e.dbis[Sc.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP],n;for(let{key:i,value:o}of s.getRange({start:!1})){if(i>=t)break;r.start_timestamp===void 0&&(r.start_timestamp=i),n=s.remove(i);let c=o[Sc.TRANSACTIONS_DBI_NAMES_ENUM.USER_NAME];oQ.isEmpty(c)||(n=e.dbis[Sc.TRANSACTIONS_DBI_NAMES_ENUM.USER_NAME].remove(c,i));for(let u=0;u<o.hash_values.length;u++)n=e.dbis[Sc.TRANSACTIONS_DBI_NAMES_ENUM.HASH_VALUE].remove(o.hash_values[u],i);if(r.transactions_deleted++,r.end_timestamp=i,r.transactions_deleted>uQ)break}return await n,r}catch(s){throw s}}a(dQ,"deleteTransactions")});var qI=T((Lce,HI)=>{"use strict";var Ym=class{static{a(this,"DropAttributeObject")}constructor(t,r,s){this.schema=t,this.table=r,this.attribute=s}};HI.exports=Ym});var GI=T((Mce,FI)=>{"use strict";var fQ=Bs(),EQ=hc(),Uce=qI(),Hs=y(),hQ=$(),Km=De(),mQ=Si(),pQ=Ec(),SQ=_c(),{getSchemaPath:TQ}=ve();FI.exports=gQ;async function gQ(e,t=!0){let r;e.schema===Hs.SYSTEM_SCHEMA_NAME?r=mQ[e.table]:r=global.hdb_schema[e.schema][e.table];let s=await AQ(e),n=TQ(e.schema,e.table),i=await Km.openEnvironment(n,e.table);return t===!0&&await RQ(e,i,r.hash_attribute),Km.dropDBI(i,e.attribute),s}a(gQ,"lmdbDropAttribute");async function RQ(e,t,r){let s=Km.openDBI(t,r),n,i=e.attribute;for(let{key:o,value:c,version:u}of s.getRange({start:!1,versions:!0})){let _={};for(let l in c)l!==i&&(_[l]=c[l]);n=t.dbis[r].put(o,_,u)}await n}a(RQ,"removeAttributeFromAllObjects");async function AQ(e){let t=new fQ(Hs.SYSTEM_SCHEMA_NAME,Hs.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME,Hs.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_SCHEMA_TABLE_KEY,`${e.schema}.${e.table}`,void 0,[Hs.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ID_KEY,Hs.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ATTRIBUTE_KEY]),s=Array.from(await pQ(t)).filter(o=>o[Hs.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ATTRIBUTE_KEY]===e.attribute);if(hQ.isEmptyOrZeroLength(s))throw new Error(`Attribute '${e.attribute}' was not found in '${e.schema}.${e.table}'`);let n=s.map(o=>o[Hs.SYSTEM_DEFAULT_ATTRIBUTE_NAMES.ATTR_ID_KEY]),i=new EQ(Hs.SYSTEM_SCHEMA_NAME,Hs.SYSTEM_TABLE_NAMES.ATTRIBUTE_TABLE_NAME,n);return SQ(i)}a(AQ,"dropAttributeFromSystem")});var KI=T((Bce,YI)=>{"use strict";var Wm=De(),Io=ze(),vce=Er(),Qm=y(),xI=$(),{getTransactionAuditStorePath:OQ}=ve(),NQ=No(),T_=Ro(),bQ=G();YI.exports=yQ;async function yQ(e){let t=OQ(e.schema,e.table),r=await Wm.openEnvironment(t,e.table,!0),s=Wm.listDBIs(r);Wm.initializeDBIs(r,Io.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP,s);let n;switch(e.search_type){case Qm.READ_AUDIT_LOG_SEARCH_TYPES_ENUM.TIMESTAMP:return kI(r,e.search_values);case Qm.READ_AUDIT_LOG_SEARCH_TYPES_ENUM.HASH_VALUE:return n=global.hdb_schema[e.schema][e.table].hash_attribute,wQ(r,e.search_values,n);case Qm.READ_AUDIT_LOG_SEARCH_TYPES_ENUM.USERNAME:return IQ(r,e.search_values);default:return kI(r)}}a(yQ,"readAuditLog");function kI(e,t=[0,Date.now()]){xI.isEmpty(t[0])&&(t[0]=0),xI.isEmpty(t[1])&&(t[1]=Date.now());let r=e.dbis[Io.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP],s;for(let n of r.getKeys({start:t[1]}))if(n!==t[1]){s=n;break}return r.getRange({start:t[0],end:s}).map(({value:n})=>Object.assign(new T_,n))}a(kI,"searchTransactionsByTimestamp");function IQ(e,t=[]){let r=new Map;for(let s=0;s<t.length;s++){let n=t[s],i=[];for(let o of e.dbis[Io.TRANSACTIONS_DBI_NAMES_ENUM.USER_NAME].getValues(n))i.push(o);r.set(n,$I(e,i))}return Object.fromEntries(r)}a(IQ,"searchTransactionsByUsername");function wQ(e,t,r){let s=new Map;for(let c=0,u=t.length;c<u;c++){let _=t[c],l=NQ.equals(e,Io.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP,Io.TRANSACTIONS_DBI_NAMES_ENUM.HASH_VALUE,_);for(let{value:d}of l){let f=Number(d);s.has(f)?s.get(f).push(_.toString()):s.set(f,[_.toString()])}}let n=Array.from(s.keys()),i=$I(e,n),o=new Map;for(let c=0;c<i.length;c++){let u=i[c],_=u.timestamp,l=s.get(_);VI(u,"records",r,l,o),VI(u,"original_records",r,l,o)}return Object.fromEntries(o)}a(wQ,"searchTransactionsByHashValues");function VI(e,t,r,s,n){let i=e.timestamp;if(e[t])for(let o=0;o<e[t].length;o++){let c=e[t][o],u=c[r].toString();if(s.indexOf(u)>=0)if(n.has(u)){let _=n.get(u),l=_[_.length-1];if(l.timestamp===i)l[t]=[c];else{let d=new T_(e.operation,e.user_name,i,void 0);d[t]=[c],_.push(d)}}else{let _=new T_(e.operation,e.user_name,i,void 0);_[t]=[c],n.set(u,[_])}}}a(VI,"loopRecords");function $I(e,t){let r=[];try{let s=e.dbis[Io.TRANSACTIONS_DBI_NAMES_ENUM.TIMESTAMP];for(let n=0;n<t.length;n++)try{let i=s.get(t[n]);if(i){let o=Object.assign(new T_,i);r.push(o)}}catch(i){bQ.warn(i)}return r}catch(s){throw s}}a($I,"batchSearchTransactions")});var QI=T((Gce,WI)=>{"use strict";var{getSchemaPath:qce}=ve(),Fce=De(),{database:CQ}=(fe(),Z(Ce));WI.exports={writeTransaction:LQ};async function LQ(e,t,r){return CQ({database:e,table:t}).transaction(r)}a(LQ,"writeTransaction")});var jI=T((kce,XI)=>{"use strict";var{getSchemaPath:zI}=ve(),JI=De();XI.exports={flush:DQ,resetReadTxn:UQ};async function DQ(e,t){return(await JI.openEnvironment(zI(e,t),t.toString())).flushed}a(DQ,"flush");async function UQ(e,t){try{(await JI.openEnvironment(zI(e,t),t.toString())).resetReadTxn()}catch{}}a(UQ,"resetReadTxn")});var rw=T(($ce,tw)=>{"use strict";var{Readable:MQ}=require("stream"),{getDatabases:PQ}=(fe(),Z(Ce)),{readSync:vQ,openSync:BQ,createReadStream:ZI}=require("fs"),{open:HQ}=require("lmdb"),ew=wl(),qQ=Ll(),{AUDIT_STORE_OPTIONS:FQ}=(oo(),Z(gO)),{INTERNAL_DBIS_NAME:GQ,AUDIT_STORE_NAME:xQ}=ze();tw.exports=VQ;var zm=32768,kQ=100;async function VQ(e){let t=e.database||e.schema||"data",r=PQ()[t],s=new Date().toISOString(),n=e.tables||e.table&&[e.table];if(n){let _=r[n[0]];if(!_)throw new Error(`Can not find table ${n[0]}`);let l=_.dbisDB,d=HQ({noSync:!0,maxDbs:qQ.MAX_DBS}),f,E=d.openDB(GQ,new ew(!1)),h=l.useReadTransaction(),S=0,p=a(async function(b,O){O.encoding="binary",O.encoder=void 0;let Y=d.openDB(b,O),W=l.openDB(b,O);for(let{key:F,version:w,value:K}of W.getRange({transaction:h,versions:W.useVersions}))f=Y.put(F,K,w),S++%kQ===0&&(await new Promise(B=>setTimeout(B,20)),h.openTimer&&(h.openTimer=0))},"copyDatabase");for(let{key:b,value:O}of l.getRange({transaction:h,start:!1}))if(n.some(Y=>b.startsWith?.(Y+"/"))){E.put(b,O);let[,Y]=b.split("/"),W=!Y,F=new ew(!W,W);await p(b,F)}e.include_audit&&await p(xQ,Object.assign({},FQ)),await f;let g=ZI(d.path);return g.headers=u(),g.on("close",()=>{h.done(),d.close()}),g}let o=r[Object.keys(r)[0]].primaryStore,c=BQ(o.path);return o.transaction(()=>{let _=Buffer.alloc(zm);vQ(c,_,0,zm);let l=o.useReadTransaction(),d=ZI(null,{fd:c,start:zm}),f=new MQ.from(async function*(){yield _;for await(let E of d)l.openTimer&&(l.openTimer=0),yield E;l.done()}());return f.headers=u(),f});function u(){let _=new Map;return _.set("content-type","application/octet-stream"),_.set("content-disposition",`attachment; filename="${t}"`),_.set("date",s),_}}a(VQ,"getBackup")});var iw=T((Kce,nw)=>{"use strict";var $Q=G(),{handleHDBError:YQ}=j(),KQ=iO(),WQ=Fl(),QQ=Sm(),zQ=my(),JQ=_c(),XQ=bm(),jQ=ky(),ZQ=Xy(),ez=Ec(),tz=iI(),rz=mI(),sz=OI(),nz=bI(),iz=CI(),oz=BI(),az=Mm(),cz=GI(),uz=KI(),lz=QI(),sw=jI(),_z=rw(),Jm=class extends KQ{static{a(this,"LMDBBridge")}async searchByConditions(t){return tz(t)}async getDataByHash(t){return await XQ(t)}async searchByHash(t){return await jQ(t)}async getDataByValue(t,r){return await ZQ(t,r)}async searchByValue(t){return await ez(t)}async createSchema(t){return await zQ(t)}async dropSchema(t){return await rz(t)}async createTable(t,r){return await sz(t,r)}async dropTable(t){return await az(t)}async createAttribute(t){return await WQ(t)}async createRecords(t){return await QQ(t)}async updateRecords(t){return await nz(t)}async upsertRecords(t){try{return await iz(t)}catch(r){throw YQ(r,null,null,$Q.ERR,r)}}async deleteRecords(t){return await JQ(t)}async dropAttribute(t){return await cz(t)}async deleteAuditLogsBefore(t){return await oz(t)}async readAuditLog(t){return await uz(t)}writeTransaction(t,r,s){return lz.writeTransaction(t,r,s)}flush(t,r){return sw.flush(t,r)}resetReadTxn(t,r){return sw.resetReadTxn(t,r)}getBackup(t){return _z(t)}};nw.exports=Jm});var Ew={};qe(Ew,{ResourceBridge:()=>Zm});function ep({get_attributes:e},t){if(e){if(e[0]==="*"){if(t.schemaDefined)return;e=t.attributes.map(r=>r.name)}return e.forceNulls=!0,e}}function aw(e,t){let r=qs(e),s=ep(e,r);if(!r)throw new ls.ClientError(`Table ${e.table} not found`);let n;s&&r.attributes.length-s.length>2&&s.length<5&&(n=!0);let i={user:e.hdb_user},o;Ge(i,()=>new Promise(_=>o=_));let c=e.ids||e.hash_values,u=0;return{[Symbol.asyncIterator](){return{async next(){if(u<c.length){let _=c[u++],l=await r.get({id:_,lazy:n,select:s},i);return l=l&&dl(l),t?{value:{key:_,value:l}}:{value:l}}else return o(),{done:!0}},return(_){return o(),{value:_,done:!0}},throw(_){return o(),{done:!0}}}}}}function qs(e){let t=e.database||e.schema||fz,r=_s()[t];if(!r)throw(0,ls.handleHDBError)(new Error,dz.SCHEMA_NOT_FOUND(t),404);return r[e.table]}function cw(e,t,r){let s=e.length+t.length,n=s===1?"record":"records";return{message:`${e.length} of ${s} ${n} successfully deleted`,deleted_hashes:e,skipped_hashes:t,txn_time:r}}async function*uw(e,t,r){let s;for await(let n of e.getHistory(t,r)){let i=n.type;i==="put"&&(i="upsert");let{id:o,version:c,value:u}=n;s?.timestamp===c?(s.hash_values.push(o),s.records.push(u)):(s&&(yield s),s={operation:i,user_name:n.user,timestamp:c,hash_values:[o],records:[u]})}s&&(yield s)}var lw,g_,ls,_w,dw,ds,Xm,jm,fw,dz,fz,Ez,hz,ow,Zm,hw=Te(()=>{"use strict";lw=U(iw()),g_=U(bo()),ls=U(j());fe();_w=U(Xa()),dw=U(rc()),ds=U(y()),Xm=U(cn()),jm=U(us()),fw=U($());Ei();fl();({HDB_ERROR_MSGS:dz}=ls.hdb_errors),fz="data",Ez=1e4,hz=10,Zm=class extends lw.default{static{a(this,"ResourceBridge")}constructor(t){super(t),ow=this}async searchByConditions(t){let r=(0,g_.default)(t,"conditions");if(r)throw(0,ls.handleHDBError)(r,r.message,400,void 0,void 0,!0);let s=qs(t);if(!s)throw new ls.ClientError(`Table ${t.table} not found`);let n=t.conditions.map(i=>({attribute:i.search_attribute,comparator:i.search_type,value:i.search_value}));return s.search({conditions:n,operator:t.operator?t.operator.toLowerCase():void 0,limit:t.limit,offset:t.offset,reverse:t.reverse,select:ep(t,s),allowFullScan:!0})}async createTable(t,r){let s=r.attributes,n=!!s,i=r.primary_key||r.hash_attribute;if(s)for(let o of s)o.is_primary_key?(o.isPrimaryKey=!0,delete o.is_primary_key):o.name===i&&i&&(o.isPrimaryKey=!0);else{if(!i)throw new ls.ClientError("A primary key must be specified with a `primary_key` property or with `attributes`");s=[{name:i,isPrimaryKey:!0},{name:"__createdtime__",indexed:!0},{name:"__updatedtime__",indexed:!0}]}et({database:r.schema,table:r.table,attributes:s,schemaDefined:n,expiration:r.expiration})}async createAttribute(t){return await qs(t).addAttributes([{name:t.attribute,indexed:t.indexed??!0}]),`attribute ${t.schema}.${t.table}.${t.attribute} successfully created.`}async dropAttribute(t){let r=qs(t);if(await r.removeAttributes([t.attribute]),!r.schemaDefined){let s=t.attribute,n,i=a((o,c,u)=>(c=Object.assign({},c),delete c[s],r.primaryStore.ifVersion(o,u,()=>r.primaryStore.put(o,c,u)).then(_=>{if(!_){let{value:l,version:d}=r.primaryStore.getEntry(o);return i(o,l,d)}})),"deleteRecord");for(let{key:o,value:c,version:u}of r.primaryStore.getRange({start:!0,versions:!0}))n=i(o,c,u),await new Promise(_=>setImmediate(_));await n}return`successfully deleted ${t.schema}.${t.table}.${t.attribute}`}dropTable(t){qs(t).dropTable()}createSchema(t){return Tc({database:t.schema,table:null}),Xm.signalSchemaChange(new jm.SchemaEventMsg(process.pid,ds.OPERATIONS_ENUM.CREATE_SCHEMA,t.schema))}async dropSchema(t){await tp(t.schema),Xm.signalSchemaChange(new jm.SchemaEventMsg(process.pid,ds.OPERATIONS_ENUM.DROP_SCHEMA,t.schema))}async updateRecords(t){return t.requires_existing=!0,this.upsertRecords(t)}async createRecords(t){return t.requires_no_existing=!0,ow.upsertRecords(t)}async upsertRecords(t){let{schema_table:r,attributes:s}=(0,_w.default)(t);(0,dw.default)(t,s,r.primaryKey);let n,i=_s()[t.schema][t.table],o={user:t.hdb_user,expiresAt:t.expiresAt};return Ge(o,async c=>{if(!i.schemaDefined){n=[];for(let l of s)i.attributes.find(f=>f.name==l)||n.push(l);n.length>0&&await i.addAttributes(n.map(l=>({name:l,indexed:!0})))}let u=[],_=[];for(let l of t.records){let d=await i.get(l[i.primaryKey],o);if(t.requires_existing&&!d||t.requires_no_existing&&d){_.push(l[i.primaryKey]);continue}d&&(d=dl(d));for(let f in l)if(Object.prototype.hasOwnProperty.call(l,f)){let E=l[f];if(typeof E=="function")try{let h=E([[d]]);Array.isArray(h)&&(E=h[0].func_val,l[f]=E)}catch(h){throw h.message+="Trying to set key "+f+" on object"+JSON.stringify(l),h}}if(d)for(let f in d)Object.prototype.hasOwnProperty.call(l,f)||(l[f]=d[f]);await i.put(l,o),u.push(l[i.primaryKey])}return{txn_time:c.timestamp,written_hashes:u,new_attributes:n,skipped_hashes:_}})}async deleteRecords(t){let r=_s()[t.schema][t.table],s={user:t.hdb_user};return Ge(s,async n=>{let i=t.hash_values||t.records.map(u=>u[r.primaryKey]),o=[],c=[];for(let u of i)await r.delete(u,s)?o.push(u):c.push(u);return cw(o,c,n.timestamp)})}async deleteRecordsBefore(t){let r=_s()[t.schema][t.table];if(!r.createdTimeProperty)throw new ls.ClientError("Table must have a '__createdtime__' attribute or @createdTime timestamp defined to perform this operation");let s=await r.search({conditions:[{attribute:r.createdTimeProperty.name,value:Date.parse(t.date),comparator:ds.VALUE_SEARCH_COMPARATORS.LESS}]}),n=!1,i=[],o=[],c=0,u=[],_=a(async()=>{let l=await this.deleteRecords({schema:t.schema,table:t.table,hash_values:u});i.push(...l.deleted_hashes),o.push(...l.skipped_hashes),await(0,fw.async_set_timeout)(hz),u=[],n=!0},"chunkDelete");for await(let l of s)u.push(l[r.primaryKey]),c++,c%Ez===0&&await _();return u.length>0&&await _(),n?cw(i,o,void 0):{message:"No records found to delete"}}searchByHash(t){let r=(0,g_.default)(t,"hashes");if(r)throw r;return aw(t)}async getDataByHash(t){let r=new Map;t._returnKeyValue=!0;for await(let{key:s,value:n}of aw(t,!0))r.set(s,n);return r}searchByValue(t,r){if(r&&ds.VALUE_SEARCH_COMPARATORS_REVERSE_LOOKUP[r]===void 0)throw new Error(`Value search comparator - ${r} - is not valid`);let s=(0,g_.default)(t,"value");if(s)throw s;let n=qs(t);if(!n)throw new ls.ClientError(`Table ${t.table} not found`);let i=t.search_value;i.includes?.("*")&&(i.startsWith("*")?i.endsWith("*")?i!=="*"&&(r="contains",i=i.slice(1,-1)):(r="ends_with",i=i.slice(1)):i.endsWith("*")&&(r="starts_with",i=i.slice(0,-1))),r===ds.VALUE_SEARCH_COMPARATORS.BETWEEN&&(i=[i,t.end_value]);let o=i==="*"?[]:[{attribute:t.search_attribute,value:i,comparator:r}];return n.search({conditions:o,allowFullScan:!0,limit:t.limit,offset:t.offset,reverse:t.reverse,select:ep(t,n)})}async getDataByValue(t,r){let s=new Map,n=qs(t);t.get_attributes&&!t.get_attributes.includes(n.primaryKey)&&t.get_attributes[0]!=="*"&&t.get_attributes.push(n.primaryKey);for await(let i of this.searchByValue(t,r))s.set(i[n.primaryKey],i);return s}resetReadTxn(t,r){qs({schema:t,table:r})?.primaryStore.resetReadTxn()}async deleteAuditLogsBefore(t){return qs(t).deleteHistory(t.timestamp)}async readAuditLog(t){let r=qs(t),s={};switch(t.search_type){case ds.READ_AUDIT_LOG_SEARCH_TYPES_ENUM.HASH_VALUE:for(let i of t.search_values)s[i]=(await r.getHistoryOfRecord(i)).map(o=>{let c=o.type;return c==="put"&&(c="upsert"),{operation:c,timestamp:o.version,user_name:o.user,hash_values:[i],records:[o.value]}});return s;case ds.READ_AUDIT_LOG_SEARCH_TYPES_ENUM.USERNAME:let n=t.search_values;for await(let i of uw(r))n.includes(i.user_name)&&(s[i.user_name]||(s[i.user_name]=[])).push(i);return s;default:return uw(r,t.search_values?.[0],t.search_values?.[1])}}};a(ep,"getSelect");a(aw,"getRecords");a(qs,"getTable");a(cw,"createDeleteResponse");a(uw,"groupRecordsInHistory")});var os=T((jce,mw)=>{"use strict";var{ResourceBridge:mz}=(hw(),Z(Ew)),pz=X();pz.initSync();var R_;function Sz(){return R_||(R_=new mz,R_)}a(Sz,"getBridge");mw.exports=Sz()});var gw=T((eue,Tw)=>{"use strict";var pw=require("lodash"),gc=require("mathjs"),Tz=require("jsonata"),Sw=$();Tw.exports={distinct_array:e=>Array.isArray(e)&&e.length>1?pw.uniqWith(e,pw.isEqual):e,searchJSON:gz,mad:Rc.bind(null,gc.mad),mean:Rc.bind(null,gc.mean),mode:Rc.bind(null,gc.mode),prod:Rc.bind(null,gc.prod),median:Rc.bind(null,gc.median)};function Rc(e,t,r,s){return s===1?t==null?[]:[t]:s===2?(t!=null&&r.push(t),r):r!=null&&r.length>0?e(r):null}a(Rc,"aggregateFunction");function gz(e,t){if(typeof e!="string"||e.length===0)throw new Error("search json expression must be a non-empty string");let r="__"+e+"__";if(Sw.isEmpty(this.__ala__.res)&&(this.__ala__.res={}),Sw.isEmpty(this.__ala__.res[r])){let s=Tz(e);this.__ala__.res[r]=s}return this.__ala__.res[r].evaluate(t)}a(gz,"searchJSON")});var Aw=T((rue,Rw)=>{"use strict";var rt=require("moment"),rp="YYYY-MM-DDTHH:mm:ss.SSSZZ";rt.suppressDeprecationWarnings=!0;Rw.exports={current_date:()=>rt().utc().format("YYYY-MM-DD"),current_time:()=>rt().utc().format("HH:mm:ss.SSS"),extract:(e,t)=>{switch(t.toLowerCase()){case"year":return rt(e).utc().format("YYYY");case"month":return rt(e).utc().format("MM");case"day":return rt(e).utc().format("DD");case"hour":return rt(e).utc().format("HH");case"minute":return rt(e).utc().format("mm");case"second":return rt(e).utc().format("ss");case"millisecond":return rt(e).utc().format("SSS");default:break}},date:e=>rt(e).utc().format(rp),date_format:(e,t)=>rt(e).utc().format(t),date_add:(e,t,r)=>rt(e).utc().add(t,r).valueOf(),date_sub:(e,t,r)=>rt(e).utc().subtract(t,r).valueOf(),date_diff:(e,t,r)=>{let s=rt(e).utc(),n=rt(t).utc();return r?s.diff(n,r,!0):s.diff(n)},now:()=>rt().utc().valueOf(),get_server_time:()=>rt().format(rp),offset_utc:(e,t)=>rt(e).utc().utcOffset(t).format(rp)}});var yw=T((sue,bw)=>{"use strict";var Rz=require("@turf/area"),Az=require("@turf/length"),Oz=require("@turf/circle"),Nz=require("@turf/difference"),bz=require("@turf/distance"),yz=require("@turf/boolean-contains"),Iz=require("@turf/boolean-equal"),wz=require("@turf/boolean-disjoint"),Cz=require("@turf/helpers"),Ow=y(),_e=$();bw.exports={geoArea:Lz,geoLength:Dz,geoCircle:Uz,geoDifference:Mz,geoDistance:Nw,geoNear:Pz,geoContains:vz,geoEqual:Bz,geoCrosses:Hz,geoConvert:qz};var sp="geo1 is required",np="geo2 is required";function Lz(e){if(_e.isEmpty(e))throw new Error("geoJSON is required");return typeof e=="string"&&(e=_e.autoCastJSON(e)),Rz.default(e)}a(Lz,"geoArea");function Dz(e,t){if(_e.isEmpty(e))throw new Error("geoJSON is required");return typeof e=="string"&&(e=_e.autoCastJSON(e)),Az.default(e,{units:t||"kilometers"})}a(Dz,"geoLength");function Uz(e,t,r){if(_e.isEmpty(e))throw new Error("point is required");if(_e.isEmpty(t))throw new Error("radius is required");return typeof e=="string"&&(e=_e.autoCastJSON(e)),Oz.default(e,t,{units:r||"kilometers"})}a(Uz,"geoCircle");function Mz(e,t){if(_e.isEmpty(e))throw new Error("poly1 is required");if(_e.isEmpty(t))throw new Error("poly2 is required");return typeof e=="string"&&(e=_e.autoCastJSON(e)),typeof t=="string"&&(t=_e.autoCastJSON(t)),Nz(e,t)}a(Mz,"geoDifference");function Nw(e,t,r){if(_e.isEmpty(e))throw new Error("point1 is required");if(_e.isEmpty(t))throw new Error("point2 is required");return typeof e=="string"&&(e=_e.autoCastJSON(e)),typeof t=="string"&&(t=_e.autoCastJSON(t)),bz.default(e,t,{units:r||"kilometers"})}a(Nw,"geoDistance");function Pz(e,t,r,s){if(_e.isEmpty(e))throw new Error("point1 is required");if(_e.isEmpty(t))throw new Error("point2 is required");if(_e.isEmpty(r))throw new Error("distance is required");if(typeof e=="string"&&(e=_e.autoCastJSON(e)),typeof t=="string"&&(t=_e.autoCastJSON(t)),isNaN(r))throw new Error("distance must be a number");return Nw(e,t,s)<=r}a(Pz,"geoNear");function vz(e,t){if(_e.isEmpty(e))throw new Error(sp);if(_e.isEmpty(e))throw new Error(np);return typeof e=="string"&&(e=_e.autoCastJSON(e)),typeof t=="string"&&(t=_e.autoCastJSON(t)),yz.default(e,t)}a(vz,"geoContains");function Bz(e,t){if(_e.isEmpty(e))throw new Error(sp);if(_e.isEmpty(e))throw new Error(np);return typeof e=="string"&&(e=_e.autoCastJSON(e)),typeof t=="string"&&(t=_e.autoCastJSON(t)),Iz.default(e,t)}a(Bz,"geoEqual");function Hz(e,t){if(_e.isEmpty(e))throw new Error(sp);if(_e.isEmpty(e))throw new Error(np);return typeof e=="string"&&(e=_e.autoCastJSON(e)),typeof t=="string"&&(t=_e.autoCastJSON(t)),!wz.default(e,t)}a(Hz,"geoCrosses");function qz(e,t,r){if(_e.isEmptyOrZeroLength(e))throw new Error("coordinates is required");if(_e.isEmpty(t))throw new Error("geo_type is required");if(_e.isEmpty(Ow.GEO_CONVERSION_ENUM[t]))throw new Error(`geo_type of ${t} is invalid please use one of the following types: ${Object.keys(Ow.GEO_CONVERSION_ENUM).join(",")}`);return Cz[t](e,r)}a(qz,"geoConvert")});var A_=T((iue,Iw)=>{var Ui=gw(),Nr=Aw(),Fs=yw();Iw.exports=e=>{e.aggr.mad=e.aggr.MAD=Ui.mad,e.aggr.mean=e.aggr.MEAN=Ui.mean,e.aggr.mode=e.aggr.MODE=Ui.mode,e.aggr.prod=e.aggr.PROD=Ui.prod,e.aggr.median=e.aggr.MEDIAN=Ui.median,e.fn.distinct_array=e.fn.DISTINCT_ARRAY=Ui.distinct_array,e.fn.search_json=e.fn.SEARCH_JSON=Ui.searchJSON,e.fn.__ala__=e,e.fn.current_date=e.fn.CURRENT_DATE=Nr.current_date,e.fn.current_time=e.fn.CURRENT_TIME=Nr.current_time,e.fn.extract=e.fn.EXTRACT=Nr.extract,e.fn.date=e.fn.DATE=Nr.date,e.fn.date_format=e.fn.DATE_FORMAT=Nr.date_format,e.fn.date_add=e.fn.DATE_ADD=Nr.date_add,e.fn.date_sub=e.fn.DATE_SUB=Nr.date_sub,e.fn.date_diff=e.fn.DATE_DIFF=e.fn.datediff=e.fn.DATEDIFF=Nr.date_diff,e.fn.now=e.fn.NOW=Nr.now,e.fn.offset_utc=e.fn.OFFSET_UTC=Nr.offset_utc,e.fn.get_server_time=e.fn.GET_SERVER_TIME=Nr.get_server_time,e.fn.getdate=e.fn.GETDATE=Nr.now,e.fn.current_timestamp=e.fn.CURRENT_TIMESTAMP=Nr.now,e.fn.geoarea=e.fn.GEOAREA=e.fn.geoArea=Fs.geoArea,e.fn.geocircle=e.fn.GEOCIRCLE=e.fn.geoCircle=Fs.geoCircle,e.fn.geocontains=e.fn.GEOCONTAINS=e.fn.geoContains=Fs.geoContains,e.fn.geoconvert=e.fn.GEOCONVERT=e.fn.geoConvert=Fs.geoConvert,e.fn.geocrosses=e.fn.GEOCROSSES=e.fn.geoCrosses=Fs.geoCrosses,e.fn.geodifference=e.fn.GEODIFFERENCE=e.fn.geoDifference=Fs.geoDifference,e.fn.geodistance=e.fn.GEODISTANCE=e.fn.geoDistance=Fs.geoDistance,e.fn.geoequal=e.fn.GEOEQUAL=e.fn.geoEqual=Fs.geoEqual,e.fn.geolength=e.fn.GEOLENGTH=e.fn.geoLength=Fs.geoLength,e.fn.geonear=e.fn.GEONEAR=e.fn.geoNear=Fs.geoNear}});var Dw=T((oue,Lw)=>{"use strict";var Ac=require("lodash"),It=require("alasql");It.options.cache=!1;var Fz=A_(),ww=require("clone"),O_=require("recursive-iterator"),re=G(),ie=$(),wo=os(),Gz=y(),{hdb_errors:xz}=j(),{getDatabases:Cw}=(fe(),Z(Ce)),kz="IS NULL",Es="There was a problem performing this search. Please check the logs and try again.";Fz(It);var ip=class{static{a(this,"SQLSearch")}constructor(t,r){if(ie.isEmpty(t))throw re.error("AST statement for SQL select process cannot be empty"),"statement cannot be null";this.statement=t,this.columns={},this.all_table_attributes=r,this.fetch_attributes=[],this.exact_search_values={},this.comparator_search_values={},this.tables=[],this.data={},this.has_aggregator=!1,this.has_ordinal=!1,this.has_outer_join=!1,this._getColumns(),this._getTables(),this._conditionsToFetchAttributeValues(),this._setAliasesForColumns(),ie.backtickASTSchemaItems(this.statement)}async search(){let t;try{let s=await this._checkEmptySQL();if(!ie.isEmptyOrZeroLength(s))return re.trace("No results returned from checkEmptySQL SQLSearch method."),s}catch(s){throw re.error("Error thrown from checkEmptySQL in SQLSearch class method search."),re.error(s),new Error(Es)}try{let s=await this._getFetchAttributeValues();if(s)return s}catch(s){throw re.error("Error thrown from getFetchAttributeValues in SQLSearch class method search."),re.error(s),new Error(Es)}if(Object.keys(this.data).length===0)return re.trace('SQLSearch class field: "data" is empty.'),[];let r;try{r=await this._processJoins()}catch(s){throw re.error("Error thrown from processJoins in SQLSearch class method search."),re.error(s),new Error(Es)}try{await this._getFinalAttributeData(r.existing_attributes,r.joined_length)}catch(s){throw re.error("Error thrown from getFinalAttributeData in SQLSearch class method search."),re.error(s),new Error(Es)}try{return t=await this._finalSQL(),t}catch(s){throw re.error("Error thrown from finalSQL in SQLSearch class method search."),re.error(s),new Error(Es)}}_getColumns(){let t=new O_(this.statement);for(let{node:r,path:s}of t)r&&r.columnid&&(this.columns[s[0]]||(this.columns[s[0]]=[]),this.columns[s[0]].push(ww(r)))}_getTables(){let t=[];this.all_table_attributes.forEach(r=>{t.push(r.table)}),this.tables=Ac.uniqBy(t,r=>[r.databaseid,r.tableid,r.as].join()),this.tables.forEach(r=>{let s=`${r.databaseid}_${r.as?r.as:r.tableid}`;this.data[s]={},this.data[s].__hash_name=Cw()[r.databaseid][r.tableid].primaryKey,this.data[s].__merged_data={},this.data[s].__merged_attributes=[],this.data[s].__merged_attr_map={}})}_conditionsToFetchAttributeValues(){if(ie.isEmpty(this.statement.where)){re.trace('AST "where" statement is empty.');return}let t=!1;for(let{node:r}of new O_(this.statement.where))if(r&&r.op&&r.op==="OR"&&(t=!0),!ie.isEmpty(r)&&r.right)if(ie.isNotEmptyAndHasValue(r.right.value)){let s=ie.autoCast(r.right.value);[!0,!1].indexOf(s)>=0?r.right=new It.yy.LogicValue({value:s}):r.right instanceof It.yy.StringValue&&!ie.isEmpty(s)&&ie.autoCasterIsNumberCheck(s.toString())&&(r.right=new It.yy.NumValue({value:s}))}else Array.isArray(r.right)&&r.right.forEach((s,n)=>{let i=ie.autoCast(s.value);[!0,!1].indexOf(i)>=0?r.right[n]=new It.yy.LogicValue({value:i}):s instanceof It.yy.StringValue&&ie.autoCasterIsNumberCheck(i.toString())&&(r.right[n]=new It.yy.NumValue({value:i}))});if(t){re.trace('Where clause contains "OR", exact match search not performed on attributes.');return}for(let{node:r}of new O_(this.statement.where))if(r&&r.left&&r.right&&(r.left.columnid||r.right.value)&&r.op){let s=new Set,n=r.left.columnid?r.left:r.right,i=this._findColumn(n);if(!i)continue;let o=[i.table.databaseid,i.table.tableid,i.attribute].join("/");if(!ie.isEmpty(Gz.VALUE_SEARCH_COMPARATORS_REVERSE_LOOKUP[r.op])){if(ie.isEmpty(this.comparator_search_values[o])&&(this.comparator_search_values[o]={ignore:!1,comparators:[]}),!this.comparator_search_values[o].ignore){if(ie.isEmptyOrZeroLength(r.left.columnid)||ie.isEmptyOrZeroLength(r.right.value)){this.comparator_search_values[o].ignore=!0,this.comparator_search_values[o].comparators=[];continue}this.comparator_search_values[o].comparators.push({attribute:r.left.columnid,operation:r.op,search_value:r.right.value})}continue}if(ie.isEmpty(this.exact_search_values[o])&&(this.exact_search_values[o]={ignore:!1,values:new Set}),!this.exact_search_values[o].ignore){let c=!1;switch(r.op){case"=":!ie.isEmpty(r.right.value)||!ie.isEmpty(r.left.value)?s.add(ie.isEmpty(r.right.value)?r.left.value:r.right.value):c=!0;break;case"IN":let u=Array.isArray(r.right)?r.right:r.left;for(let _=0;_<u.length;_++)if(u[_].value)s.add(u[_].value);else{c=!0;break}break;default:c=!0;break}this.exact_search_values[o].ignore=c,c?this.exact_search_values[o].values=new Set:this.exact_search_values[o].values=new Set([...this.exact_search_values[o].values,...s])}}}_setAliasesForColumns(){if(ie.isEmptyOrZeroLength(this.all_table_attributes)&&ie.isEmptyOrZeroLength(this.statement.from)&&ie.isEmptyOrZeroLength(this.columns.columns))return;let t=[],r={};this.statement.columns.forEach((s,n)=>{if(s.columnid==="*"){t.push(n);return}if(s.aggregatorid&&(this.has_aggregator=!0),!s.aggregatorid&&!s.funcid)if(s.as_orig=s.as?s.as:s.columnid,this.statement.joins)if(r[s.as_orig]>=0){let i=r[s.as_orig]+1;s.as=`[${s.as_orig+i}]`,r[s.as_orig]=i}else s.as=`[${s.as_orig}]`,r[s.as_orig]=0;else s.as=`[${s.as_orig}]`;!s.aggregatorid&&s.funcid&&s.args&&(s.as_orig=s.as?s.as:s.toString().replace(/'/g,'"'),s.as=`[${s.as_orig}]`),s.aggregatorid&&s.expression.columnid!=="*"&&(s.as_orig=s.as?s.as:s.expression.tableid?`${s.aggregatorid}(${s.expression.tableid}.${s.expression.columnid})`:`${s.aggregatorid}(${s.expression.columnid})`,s.as=`[${s.as_orig}]`)}),this.statement.columns.length>1&&t.length>0&&Ac.pullAt(this.statement.columns,t)}_findColumn(t){let r=this.all_table_attributes.filter(s=>{if(t.columnid_orig&&t.tableid_orig)return(s.table.as===t.tableid_orig||s.table.tableid===t.tableid_orig)&&s.attribute===t.columnid_orig;if(t.tableid)return(s.table.as===t.tableid||s.table.tableid===t.tableid)&&s.attribute===t.columnid;let n=t.columnid_orig?t.columnid_orig:t.columnid;return s.attribute===n});if(ie.isEmptyOrZeroLength(r)){let s=this.columns.columns.filter(n=>n.as?t.columnid===n.as:!1);ie.isEmptyOrZeroLength(s)||(r=this.all_table_attributes.filter(n=>n.attribute===s[0].columnid&&s[0].tableid&&s[0].tableid===(n.table.as?n.table.as:n.table.tableid)))}return r[0]}async _checkEmptySQL(){let t=[];if(ie.isEmptyOrZeroLength(this.all_table_attributes)&&!ie.isEmptyOrZeroLength(this.columns.columns))return t;if(ie.isEmptyOrZeroLength(this.all_table_attributes)&&ie.isEmptyOrZeroLength(this.statement.from))try{let r=this._buildSQL(!1);t=await It.promise(r)}catch(r){throw re.error("Error thrown from AlaSQL in SQLSearch class method checkEmptySQL."),re.error(r),new Error("There was a problem with the SQL statement")}return t}_addFetchColumns(t){t&&t.length>0&&t.forEach(r=>{let s=this._findColumn(r);s&&this.fetch_attributes.push(ww(s))})}_addColumnToMergedAttributes(t,r){this.data[t].__merged_attributes.push(r),this.data[t].__merged_attr_map[r]=this.data[t].__merged_attributes.length-1}_setMergedHashAttribute(t,r){this.data[t].__merged_data[r].splice(0,1,r)}_updateMergedAttribute(t,r,s,n){let i=this.data[t].__merged_attr_map[s];this.data[t].__merged_data[r].splice(i,1,n)}async _getFetchAttributeValues(){if(ie.isEmptyOrZeroLength(Object.keys(this.columns)))return[];this._addFetchColumns(this.columns.joins);let t=null;try{t=this.statement.where?this.statement.where.toString():""}catch{throw new Error("Could not generate proper where clause")}this.columns.where&&this._addFetchColumns(this.columns.where);let r=this._isSimpleSelect();if(r?this._addFetchColumns(this.columns.columns):(!this.columns.where&&this.fetch_attributes.length===0)|t.indexOf(kz)>-1&&this.tables.forEach(n=>{let i={columnid:Cw()[n.databaseid][n.tableid].primaryKey,tableid:n.tableid};this._addFetchColumns([i])}),this.statement.order&&(this._updateOrderByToAliases(),this._addNonAggregatorsToFetchColumns()),this.fetch_attributes=Ac.uniqBy(this.fetch_attributes,n=>[n.table.databaseid,n.table.as?n.table.as:n.table.tableid,n.attribute].join()),r)return await this._simpleSQLQuery();let s=this.fetch_attributes.reduce((n,i)=>{let o=`${i.table.databaseid}_${i.table.as?i.table.as:i.table.tableid}`,c=this.data[o].__hash_name;return n[o]||(n[o]=[],n[o].push(null),this._addColumnToMergedAttributes(o,c)),i.attribute!==c&&(n[o].push(null),this._addColumnToMergedAttributes(o,i.attribute)),n},{});for(let n of this.fetch_attributes){let i=`${n.table.databaseid}_${n.table.as?n.table.as:n.table.tableid}`,o=this.data[i].__hash_name,c={schema:n.table.databaseid,table:n.table.tableid,get_attributes:[n.attribute]},u=!1,_=[n.table.databaseid,n.table.tableid,n.attribute].join("/");if(n.attribute===o&&(u=!0),!ie.isEmpty(this.exact_search_values[_])&&!this.exact_search_values[_].ignore&&!ie.isEmptyOrZeroLength(this.exact_search_values[_].values))if(u)try{c.hash_values=Array.from(this.exact_search_values[_].values);let l=await wo.getDataByHash(c);for(let d of c.hash_values)l.get(d)&&!this.data[i].__merged_data[d]&&(this.data[i].__merged_data[d]=[...s[i]],this._setMergedHashAttribute(i,d))}catch(l){throw re.error("Error thrown from getDataByHash function in SQLSearch class method getFetchAttributeValues exact match."),re.error(l),new Error(Es)}else try{c.search_attribute=n.attribute,await Promise.all(Array.from(this.exact_search_values[_].values).map(async l=>{let d=Object.assign({},c);d.search_value=l;let f=await wo.getDataByValue(d);for(let[E,h]of f)this.data[i].__merged_data[E]?this._updateMergedAttribute(i,E,n.attribute,h[n.attribute]):(this.data[i].__merged_data[E]=[...s[i]],this._updateMergedAttribute(i,E,n.attribute,h[n.attribute]),this._setMergedHashAttribute(i,ie.autoCast(E)))}))}catch(l){throw re.error("Error thrown from getDataByValue function in SQLSearch class method getFetchAttributeValues exact match."),re.error(l),new Error(Es)}else if(!ie.isEmpty(this.comparator_search_values[_])&&!this.comparator_search_values[_].ignore&&!ie.isEmptyOrZeroLength(this.comparator_search_values[_].comparators))try{let l=this.comparator_search_values[_].comparators;for(let d=0,f=l.length;d<f;d++){let E=l[d];c.search_attribute=E.attribute,c.search_value=E.search_value;let h=await wo.getDataByValue(c,E.operation);if(u)for(let[S]of h)this.data[i].__merged_data[S]||(this.data[i].__merged_data[S]=[...s[i]],this._setMergedHashAttribute(i,ie.autoCast(S)));else for(let[S,p]of h)this.data[i].__merged_data[S]?this._updateMergedAttribute(i,S,n.attribute,p[n.attribute]):(this.data[i].__merged_data[S]=[...s[i]],this._updateMergedAttribute(i,S,n.attribute,p[n.attribute]),this._setMergedHashAttribute(i,ie.autoCast(S)))}}catch(l){throw re.error("Error thrown from getDataByValue function in SQLSearch class method getFetchAttributeValues comparator search values."),re.error(l),new Error(Es)}else try{c.search_attribute=n.attribute,c.search_value="*";let l=await wo.getDataByValue(c);if(u)for(let[d]of l)this.data[i].__merged_data[d]||(this.data[i].__merged_data[d]=[...s[i]],this._setMergedHashAttribute(i,ie.autoCast(d)));else for(let[d,f]of l)this.data[i].__merged_data[d]?this._updateMergedAttribute(i,d,n.attribute,f[n.attribute]):(this.data[i].__merged_data[d]=[...s[i]],this._updateMergedAttribute(i,d,n.attribute,f[n.attribute]),this._setMergedHashAttribute(i,ie.autoCast(d)))}catch(l){throw re.error("Error thrown from getDataByValue function in SQLSearch class method getFetchAttributeValues no comparator search values."),re.error(l),new Error(Es)}}}_isSimpleSelect(){let t=!0;return Object.keys(this.statement).length!==2||!this.statement.columns||!this.statement.from||this.statement.from.length!==1?(t=!1,t):(this.statement.columns.forEach(r=>{r instanceof It.yy.Column||(t=!1)}),t)}_updateOrderByToAliases(){this.statement.order.forEach(t=>{if(t.expression.aggregatorid){t.is_aggregator=!0;return}if(t.expression.value){t.is_ordinal=!0,this.has_ordinal=!0;return}else t.is_ordinal=!1;let r=this.statement.columns.filter(n=>{let i=n.aggregatorid?n.expression:n,o=n.aggregatorid?n.as_orig:i.as_orig;return t.expression.tableid?i.columnid_orig===t.expression.columnid_orig&&i.tableid_orig===t.expression.tableid_orig:i.columnid_orig===t.expression.columnid_orig||t.expression.columnid_orig===o});r[0]||r.push(this._findColumn(t.expression));let s=r[0];if(t.is_func=!!s.funcid,t.is_aggregator=!!s.aggregatorid,s.as)if(s.as&&!t.expression.tableid)t.expression.columnid=s.as,t.expression.columnid_orig=s.as_orig;else{let n=new It.yy.Column;n.columnid=s.as,n.columnid_orig=s.as_orig,t.expression=n}else{t.initial_select_column=Object.assign(new It.yy.Column,t.expression),t.initial_select_column.as=`[${t.expression.columnid_orig}]`,t.expression.columnid=t.initial_select_column.as;return}if(!t.is_aggregator){let n=t.is_func?new It.yy.FuncValue:new It.yy.Column;t.initial_select_column=Object.assign(n,s)}})}_addNonAggregatorsToFetchColumns(){let r=this.statement.order.filter(s=>!s.is_aggregator&&!s.is_ordinal).map(s=>s.is_func?{columnid:s.initial_select_column.args.filter(i=>!!i.columnid_orig)[0].columnid_orig}:{columnid:s.expression.columnid_orig});this._addFetchColumns(r)}async _processJoins(){let t=[],r=[],s=this.statement.from[0],n=[s],i=["? "+(s.as?" AS "+s.as:s.tableid)];t.push(Object.values(this.data[`${s.databaseid_orig}_${s.as?s.as_orig:s.tableid_orig}`].__merged_data)),this.statement.joins&&this.statement.joins.forEach(E=>{E.joinmode&&E.joinmode!=="INNER"&&(this.has_outer_join=!0),n.push(E.table);let h=E.joinmode+" JOIN ? AS "+(E.as?E.as:E.table.tableid);E.on&&(h+=" ON "+E.on.toString()),i.push(h),t.push(Object.values(this.data[`${E.table.databaseid_orig}_${E.table.as?E.table.as_orig:E.table.tableid_orig}`].__merged_data))});let o=[],c={};n.forEach(E=>{let h=this.data[`${E.databaseid_orig}_${E.as?E.as_orig:E.tableid_orig}`].__hash_name,S=E.as?E.as_orig:E.tableid_orig;o.push({key:`'${S}.${h}'`,schema:E.databaseid_orig,table:E.as?E.as_orig:E.tableid_orig,keys:new Set}),r.push(`${E.as?E.as:E.tableid}.\`${h}\` AS "${S}.${h}"`),c[E.as?E.as_orig:E.tableid_orig]=this.data[`${E.databaseid_orig}_${E.as?E.as_orig:E.tableid_orig}`].__merged_attributes});let u=this.statement.where?"WHERE "+this.statement.where:"",_="";this.statement.order&&!this.has_ordinal&&!this.has_aggregator&&!this.statement.group&&this.statement.limit&&(_="ORDER BY "+this.statement.order.toString(),this.statement.order.forEach(E=>{E.is_func?r.push(E.initial_select_column.toString()):E.initial_select_column.tableid?r.push(`${E.initial_select_column.tableid}.${E.initial_select_column.columnid} AS ${E.expression.columnid}`):r.push(`${E.initial_select_column.columnid} AS ${E.expression.columnid}`)}));let l="",d="";!this.has_aggregator&&!this.statement.group&&!this.has_ordinal&&(l=this.statement.limit?"LIMIT "+this.statement.limit:"",d=this.statement.offset?"OFFSET "+this.statement.offset:"");let f=[];try{let E=`SELECT ${r.join(", ")} FROM ${i.join(" ")} ${u} ${_} ${l} ${d}`,h=this._convertColumnsToIndexes(E,n);f=await It.promise(h,t),t=null}catch(E){throw re.error("Error thrown from AlaSQL in SQLSearch class method processJoins."),re.error(E),new Error("There was a problem processing the data.")}if(f&&f.length>0){for(let E=0,h=f.length;E<h;E++){let S=f[E];o.forEach(p=>{S[p.key]!==null&&S[p.key]!==void 0&&p.keys.add(S[p.key])})}o.forEach(E=>{let h=Object.keys(this.data[`${E.schema}_${E.table}`].__merged_data),S=Ac.difference(h,[...E.keys].map(p=>p.toString()));for(let p=0,g=S.length;p<g;p++){let b=S[p];delete this.data[`${E.schema}_${E.table}`].__merged_data[b]}})}return{existing_attributes:c,joined_length:f?f.length:0}}async _getFinalAttributeData(t,r){if(r===0)return;let s=[],n=new O_(this.columns);for(let{node:i}of n)if(i&&i.columnid){let o=this._findColumn(i);if(o){let c=o.table.as?o.table.as:o.table.tableid;(!t[c]||t[c].indexOf(o.attribute)<0)&&s.push(o)}}s=Ac.uniqBy(s,i=>[i.table.databaseid,i.table.as?i.table.as:i.table.tableid,i.attribute].join());try{await this._getData(s)}catch(i){throw re.error("Error thrown from getData in SQLSearch class method getFinalAttributeData."),re.error(i),new Error(Es)}}async _getData(t){try{let r=t.reduce((s,n)=>{let i=`${n.table.databaseid}_${n.table.as?n.table.as:n.table.tableid}`;return s[i]?s[i].columns.push(n.attribute):s[i]={schema:n.table.databaseid,table:n.table.tableid,columns:[n.attribute]},s},{});for(let s in r){let n=r[s],i=this.data[s].__merged_data,o=[];for(let l in i)o.push(i[l][0]);this.data[s].__merged_attributes.push(...n.columns);let c={schema:n.schema,table:n.table,hash_values:o,get_attributes:n.columns},u=await wo.getDataByHash(c),_=n.columns.length;for(let l=0,d=o.length;l<d;l++){let f=o[l],E=u.get(f);for(let h=0;h<_;h++){let S=n.columns[h],p=E[S]===void 0?null:E[S];this.data[s].__merged_data[f].push(p)}}}}catch(r){throw re.error("Error thrown from getDataByHash function in SQLSearch class method getData."),re.error(r),r}}async _finalSQL(){let t=[],r=this.statement.from[0];t.push(Object.values(this.data[`${r.databaseid_orig}_${r.as?r.as_orig:r.tableid_orig}`].__merged_data)),r.as=r.as?r.as:r.tableid,r.databaseid="",r.tableid="?",this.statement.joins&&this.statement.joins.forEach(n=>{n.as=n.as?n.as:n.table.tableid,t.push(Object.values(this.data[`${n.table.databaseid_orig}_${n.table.as?n.table.as_orig:n.table.tableid_orig}`].__merged_data)),n.table.databaseid="",n.table.tableid="?"}),this.statement.order&&this.statement.order.forEach(n=>{if(n.is_ordinal)return;this.statement.columns.filter(o=>{let c=o.aggregatorid?o.expression:o,u=o.aggregatorid?o.as_orig:c.as_orig;return n.expression.tableid?c.columnid_orig===n.expression.columnid_orig&&c.tableid_orig===n.expression.tableid_orig:c.columnid_orig===n.expression.columnid_orig||n.expression.columnid_orig===u}).length===0&&(n.expression.columnid=n.initial_select_column.columnid)}),!this.has_aggregator&&!this.statement.group&&!this.has_ordinal&&(this.statement.limit&&delete this.statement.limit,this.statement.offset&&delete this.statement.offset);let s;try{let n=this._buildSQL();re.trace(`Final SQL: ${n}`),s=await It.promise(n,t),this.has_outer_join&&(s=this._translateUndefinedValues(s)),re.trace(`Final AlaSQL results data included ${s.length} rows`)}catch(n){throw re.error("Error thrown from AlaSQL in SQLSearch class method finalSQL."),re.error(n),new Error("There was a problem running the generated sql.")}return s}_translateUndefinedValues(t){try{let r=[];for(let s of t){let n=Object.create(null);Object.keys(s).forEach(i=>{s[i]===void 0?n[i]=null:n[i]=s[i]}),r.push(n)}return r}catch(r){return re.error(xz.HDB_ERROR_MSGS.OUTER_JOIN_TRANSLATION_ERROR),re.trace(r.stack),t}}_buildSQL(t=!0){let r=this.statement.toString();return this.statement.columns.forEach(s=>{if(s.funcid&&s.as){let n=s.toString().replace(" AS "+s.as,"");r=r.replace(s.toString(),n)}}),t===!0?this._convertColumnsToIndexes(r,this.tables):r}_convertColumnsToIndexes(t,r){let s=t,n={};r.forEach(i=>{i.databaseid_orig?n[`${i.databaseid_orig}_${i.as?i.as_orig:i.tableid_orig}`]=i.as?i.as:i.tableid:n[`${i.databaseid}_${i.as?i.as:i.tableid}`]=`\`${i.as?i.as:i.tableid}\``});for(let i in this.data)this.data[i].__merged_attributes.forEach((o,c)=>{let u=n[i],_=new RegExp(`${u}.\`${o}\``,"g"),l=`${u}.[${c}]`;s=s.replace(_,l)});for(let i in this.data)this.data[i].__merged_attributes.forEach((o,c)=>{let u=new RegExp(`\`${o}\``,"g"),_=`[${c}]`;s=s.replace(u,_)});return s}async _simpleSQLQuery(){let t=this.statement.columns.reduce((s,n)=>(n.as_orig&&n.as_orig!=n.columnid_orig?s[n.columnid_orig]=n.as_orig:s[n.columnid_orig]||(s[n.columnid_orig]=n.columnid_orig),s),{}),r=this.fetch_attributes.reduce((s,n)=>{let i=`${n.table.databaseid}_${n.table.as?n.table.as:n.table.tableid}`;return s[i]||(s[i]={}),s[i][t[n.attribute]]=null,s},{});for(let s of this.fetch_attributes){let n=`${s.table.databaseid}_${s.table.as?s.table.as:s.table.tableid}`,i={schema:s.table.databaseid,table:s.table.tableid,get_attributes:[s.attribute]};try{i.search_attribute=s.attribute,i.search_value="*";let o=await wo.getDataByValue(i);for(let[c,u]of o)this.data[n].__merged_data[c]||(u[s.attribute]===void 0&&(u[s.attribute]=null),this.data[n].__merged_data[c]=Object.assign({},r[n])),this.data[n].__merged_data[c][t[s.attribute]]=u[s.attribute]??null}catch(o){throw re.error("There was an error when processing this SQL operation.  Check your logs"),re.error(o),new Error(Es)}}return Object.values(Object.values(this.data)[0].__merged_data)}};Lw.exports=ip});var qr=T((cue,Uw)=>{"use strict";var Vz=sO();Uw.exports={searchByConditions:Yz,searchByHash:Kz,searchByValue:Wz,search:Qz};var op=os(),{transformReq:ap}=$(),$z=Dw();async function Yz(e){return ap(e),op.searchByConditions(e)}a(Yz,"searchByConditions");async function Kz(e){ap(e),e.ids&&(e.hash_values=e.ids);let t=[];for await(let r of op.searchByHash(e))r&&t.push(r);return t}a(Kz,"searchByHash");async function Wz(e){ap(e),e.hasOwnProperty("desc")===!0&&(e.reverse=e.desc);let t=[];for await(let r of op.searchByValue(e))t.push(r);return t}a(Wz,"searchByValue");function Qz(e,t){try{let r=new Vz(e);r.validate(),new $z(r.statement,r.attributes).search().then(n=>{t(null,n)}).catch(n=>{t(n,null)})}catch(r){return t(r)}}a(Qz,"search")});var N_=T((lue,Mw)=>{"use strict";var zz=os();Mw.exports={writeTransaction:Jz};function Jz(e,t,r){return zz.writeTransaction(e,t,r)}a(Jz,"writeTransaction")});var Hw=T((fue,Bw)=>{"use strict";var Xz=qr(),jz=qn(),Pw=G(),Zz=Fr(),due=N_(),e2=require("clone"),up=require("alasql"),t2=A_(),vw=require("util"),r2=vw.promisify(jz.getTableSchema),s2=vw.promisify(Xz.search),n2=y(),cp=$();t2(up);Bw.exports={update:o2};var i2="There was a problem performing this update. Please check the logs and try again.";async function o2({statement:e,hdb_user:t}){let r=await r2(e.table.databaseid,e.table.tableid),s=a2(e.columns);cp.backtickASTSchemaItems(e);let{table:n,where:i}=e,o=e2(n),c=cp.isEmpty(i)?"":` WHERE ${i.toString()}`,u=`SELECT ${r.hash_attribute} FROM ${n.toString()} ${c}`,_=up.parse(u).statements[0],l=await s2(_),d=c2(s,l);return u2(o,d,t)}a(o2,"update");function a2(e){try{let t={};return e.forEach(r=>{"value"in r.expression?t[r.column.columnid]=r.expression.value??null:t[r.column.columnid]=up.compile(`SELECT ${r.expression.toString()} AS [${n2.FUNC_VAL}] FROM ?`)}),t}catch(t){throw Pw.error(t),new Error(i2)}}a(a2,"createUpdateRecord");function c2(e,t){return cp.isEmptyOrZeroLength(t)?[]:t.map(r=>Object.assign(r,e))}a(c2,"buildUpdateRecords");async function u2(e,t,r){let s={operation:"update",schema:e.databaseid_orig,table:e.tableid_orig,records:t,hdb_user:r},n=await Zz.update(s);try{delete n.new_attributes,delete n.txn_time}catch(i){Pw.error(`Error delete new_attributes from update response: ${i}`)}return n}a(u2,"updateRecords")});var Fw=T((pue,qw)=>{var l2=require("alasql"),_2=qr(),d2=G(),f2=os(),_p=require("util"),lp=$(),E2=y(),h2=qn(),hue=N_(),mue=Fr(),m2="record",p2="successfully deleted",S2=_p.callbackify(A2),T2=_p.promisify(_2.search),g2=_p.promisify(h2.getTableSchema);qw.exports={convertDelete:S2};function R2(e){return`${e.deleted_hashes.length} ${m2}${e.deleted_hashes.length===1?"":"s"} ${p2}`}a(R2,"generateReturnMessage");async function A2({statement:e,hdb_user:t}){let r=await g2(e.table.databaseid,e.table.tableid);lp.backtickASTSchemaItems(e);let{table:s,where:n}=e,i=lp.isEmpty(n)?"":` WHERE  ${n.toString()}`,o=`SELECT ${r.hash_attribute} FROM ${s.toString()} ${i}`,c=l2.parse(o).statements[0],u={operation:E2.OPERATIONS_ENUM.DELETE,schema:s.databaseid_orig,table:s.tableid_orig,hdb_user:t};try{u.records=await T2(c);let _=await f2.deleteRecords(u);return lp.isEmptyOrZeroLength(_.message)&&(_.message=R2(_)),delete _.txn_time,_}catch(_){throw d2.error(_),_.hdb_code?_.message:_}}a(A2,"convertDelete")});var $w=T((Tue,Vw)=>{"use strict";var O2=gi(),{hdb_errors:Gw}=j(),{getDatabases:xw}=(fe(),Z(Ce));Vw.exports={checkSchemaExists:kw,checkSchemaTableExists:N2,schema_describe:O2};async function kw(e){if(!xw()[e])return Gw.HDB_ERROR_MSGS.SCHEMA_NOT_FOUND(e)}a(kw,"checkSchemaExists");async function N2(e,t){let r=await kw(e);if(r)return r;if(!xw()[e][t])return Gw.HDB_ERROR_MSGS.TABLE_NOT_FOUND(e,t)}a(N2,"checkSchemaTableExists")});var Oc=T((Rue,b2)=>{b2.exports={name:"harperdb",version:"4.2.0-rc.2",description:"HarperDB is a distributed SQL & NoSQL data platform focused on speed, flexibility, and ease of use.",keywords:["database","sql","nosql","api","distributed","cloud","enterprise","Fastify","NATS"],main:"harperdb.js",bin:{harperdb:"./bin/harperdb.js"},engines:{"minimum-node":"16.0.0","go-lang":"1.21.1","nats-server":"2.10.1"},exports:{".":"./index.js"},homepage:"https://www.harperdb.io/",bugs:"support@harperdb.io",author:{name:"HarperDB",email:"support@harperdb.io"},license:"SEE LICENSE IN LICENSE",scripts:{submodules:"git submodule update --init --recursive",build:"eslint -c ./.eslintbuild bin/ dataLayer/ security/ server/ sqlTranslator/ upgrade/ utility/ validation/",pretty:"eslint --fix bin/ dataLayer/ security/ server/ sqlTranslator/ upgrade/ utility/ validation/","cover:test":"pm2 kill && rimraf ./.nyc_output/* && node utility/devops/register.js --reset_license && nyc --no-clean --reporter=lcovonly npm run test:apitests && nyc --no-clean --reporter=lcovonly npm run test:logging && nyc --no-clean --reporter=lcovonly npm run test:upgrade && nyc --no-clean --reporter=lcovonly npm run test:nats && nyc --no-clean --reporter=lcovonly npm run test:cfserver && nyc --no-clean --reporter=lcovonly npm run test:hdbserver && nyc --no-clean --reporter=lcovonly npm run test:main && nyc merge .nyc_output coverage.json && node ./utility/devops/register.js --reset_license",test:"pm2 kill && rimraf ./.nyc_output/* && node utility/devops/register.js --reset_license && npm run test:apitests && npm run test:logging && npm run test:upgrade && npm run test:nats && npm run test:cfserver && npm run test:hdbserver && npm run test:main && nyc merge .nyc_output coverage.json && node ./utility/devops/register.js --reset_license","test:main":"cd bin/ && ../node_modules/mocha/bin/_mocha '../unitTests/**/*.js' --config '../unitTests/.mocharc-main.json'","test:lmdbbridge":"cd bin/ && ../node_modules/mocha/bin/_mocha '../unitTests/dataLayer/harperBridge/lmdbBridge/**/*.js' --config '../unitTests/.mocharc.json'","test:lmdbutility":"cd bin/ && ../node_modules/mocha/bin/_mocha '../unitTests/utility/lmdb/**/*.js' --config '../unitTests/.mocharc.json'","test:hdbserver":"cd bin/ && ../node_modules/mocha/bin/_mocha '../unitTests/server/harperdb/hdbServer-test.js' --config '../unitTests/.mocharc.json'","test:cfserver":"npm run submodules && cd bin/ && ../node_modules/mocha/bin/_mocha '../unitTests/server/fastifyRoutes/customFunctionsServer-test.js' --config '../unitTests/.mocharc.json'","test:nats":"cd bin/ && ../node_modules/mocha/bin/_mocha '../unitTests/server/nats/**/*.js' --config '../unitTests/.mocharc.json'","test:upgrade":"cd bin/ && ../node_modules/mocha/bin/_mocha '../unitTests/upgrade/**/*.js' --config '../unitTests/.mocharc.json'","test:apitests":"pm2 kill && cd bin/ && ../node_modules/mocha/bin/_mocha '../unitTests/apiTests/**/*-test.mjs' --config '../unitTests/.mocharc.json'","test:logging":"cd bin/ && ../node_modules/mocha/bin/_mocha '../unitTests/utility/logging/*.js' --config '../unitTests/.mocharc.json'","test:ci":" cd bin/ && ../node_modules/mocha/bin/_mocha '../unitTests/**/*.js' --retries 3 --config '../unitTests/.mocharc-main.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/dataLayer/harperBridge/lmdbBridge/**/*.js' --parallel --retries 3 --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/utility/lmdb/**/*.js' --parallel --retries 3 --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/server/harperdb/hdbServer-test.js' --parallel --retries 3 --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/server/customFunctions/customFunctionsServer-test.js' --parallel --retries 3 --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/upgrade/**/*.js' --parallel --retries 3 --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter && ../node_modules/mocha/bin/_mocha '../unitTests/server/nats/**/*.js' --config '../unitTests/.mocharc.json' --reporter mocha-teamcity-reporter","hdb-check":"./utility/devops/hdb-check.sh","download-prebuilds":"node ./utility/devops/build/download-prebuilds.js",prebuild:"date",postinstall:"node ./launchServiceScripts/launchInstallNATSServer.js",build_nats_dependency:"node ./utility/devops/nats/builder.js",coverage:"nyc --reporter=lcov npm test"},dependencies:{"@aws-sdk/abort-controller":"3.374.0","@aws-sdk/client-s3":"3.418.0","@aws-sdk/lib-storage":"3.418.0","@endo/static-module-record":"^0.8.1","@fastify/autoload":"~5.7.1","@fastify/compress":"~6.4.0","@fastify/cors":"~8.4.0","@fastify/static":"~6.11.0","@turf/area":"6.5.0","@turf/boolean-contains":"6.5.0","@turf/boolean-disjoint":"6.5.0","@turf/boolean-equal":"6.5.0","@turf/circle":"6.5.0","@turf/difference":"6.5.0","@turf/distance":"6.5.0","@turf/helpers":"6.5.0","@turf/length":"6.5.0",alasql:"1.7.4","cbor-x":"1.5.4",chalk:"4.1.2","cli-progress":"3.12.0",clone:"2.1.2","fast-glob":"3.3.1",fastify:"~4.23.2","fastify-plugin":"~4.5.0","fs-extra":"11.1.1",graphql:"^16.8.0","human-readable-ids":"1.0.4",inquirer:"8.2.6","is-number":"7.0.0",joi:"17.10.2",json2csv:"5.0.7",jsonata:"1.8.6",jsonwebtoken:"9.0.2",lmdb:"2.9.0-beta.2",lodash:"4.17.21",mathjs:"11.11.1",minimist:"1.2.8",mkcert:"1.5.1",moment:"2.29.4","mqtt-packet":"~8.2.0",msgpackr:"1.9.9",nats:"2.17.0",needle:"3.2.0","node-stream-zip":"1.15.0","node-unix-socket":"^0.2.5","normalize-path":"^3.0.0",ora:"5.4.1","ordered-binary":"1.4.1",papaparse:"5.4.1",passport:"0.6.0","passport-http":"0.3.0","passport-local":"1.0.0",pino:"8.15.3",pm2:"5.3.0",prompt:"1.3.0","properties-reader":"2.3.0","recursive-iterator":"3.3.0",semver:"7.5.4",send:"^0.18.0",ses:"^0.18.1","stream-chain":"2.2.5","stream-json":"1.8.0",systeminformation:"5.21.9","tar-fs":"2.1.1",ulidx:"0.5.0",uuid:"9.0.1","validate.js":"0.13.1",ws:"^8.14.1",yaml:"2.3.2"},devDependencies:{"@tsconfig/node16":"^1.0.3","@types/node":"latest","@typescript-eslint/eslint-plugin":"^5.55.0","@typescript-eslint/parser":"^5.55.0",axios:"0.27.2",chai:"4.3.7","chai-integer":"0.1.0",esbuild:"^0.19.1",eslint:"8.22.0","eslint-config-prettier":"8.3.0","eslint-plugin-prettier":"3.4.1","eslint-plugin-radar":"0.2.1",eventsource:"^2.0.2","hook-std":"3.0.0","intercept-stdout":"0.1.2",mocha:"^10.2.0","mocha-teamcity-reporter":"3.0.0","mock-require":"3.0.3","mock-stdin":"1.0.0",mqtt:"~4.3.7",newman:"5.3.2","newman-reporter-html":"1.0.5","newman-reporter-htmlextra":"^1.22.11","newman-reporter-teamcity":"^0.1.12","node-fetch":"2.6.7",nyc:"15.1.0",prettier:"2.8.4",rewire:"5.0.0",rimraf:"3.0.2",sinon:"10.0.0","sinon-chai":"3.7.0","source-map-support":"^0.5.21",typescript:"^5.2.2","why-is-node-still-running":"^1.0.0"},overrides:{"eslint-plugin-radar":{eslint:"8.22.0"},"newman-reporter-html":{newman:"5.3.2"},alasql:{xlsx:"0.18.5"}},optionalDependencies:{bufferutil:"^4.0.7","utf-8-validate":"^5.0.10"}}});var Ic={};qe(Ic,{addAnalyticsListener:()=>yc,recordAction:()=>br,recordActionBinary:()=>xr,setAnalyticsEnabled:()=>y2});function y2(e){eC=e}function br(e,t,r,s,n){if(!eC)return;let i=t+(r?"-"+r:"");s!==void 0&&(i+="-"+s),n!==void 0&&(i+="-"+n);let o=I_.get(i);if(o)if(typeof e=="number"){let c=o.values,u=c.index++;if(u>=c.length){let _=c;o.values=c=new Float32Array(u*2),c.set(_),c.index=u+1}c[u]=e,o.total+=e}else if(typeof e=="boolean")e&&o.total++,o.count++;else if(typeof e=="function")o.count++;else throw new TypeError("Invalid metric value type "+typeof e);else{if(typeof e=="number")o={total:e,values:new Float32Array(4)},o.values.index=1,o.values[0]=e,o.total=e;else if(typeof e=="boolean")o={},o.total=e?1:0,o.count=1;else if(typeof e=="function")o={},o.count=1,o.callback=e;else throw new TypeError("Invalid metric value type "+typeof e);o.description={metric:t,path:r,method:s,type:n},I_.set(i,o)}b_||I2()}function xr(e,t,r,s,n){br(!!e,t,r,s,n)}function yc(e){sC.push(e)}function I2(){b_=performance.now(),setTimeout(async()=>{let e=performance.now()-b_;b_=0;let t=[],r={time:Date.now(),period:e,threadId:Mi.threadId,metrics:t};for(let[n,i]of I_){if(i.values){let o=i.values.subarray(0,i.values.index);o.sort();let c=o.length,u=0,_=[],l;for(let d of nC){let f=Math.floor(c*d),E=o[f-1];if(f>u){let h=f-u;if(E===l){let S=_[_.length-1];typeof S=="number"?_[_.length-1]={value:S,count:1+h}:S.count+=h}else _.push(h>1?{value:E,count:h}:E),l=E;u=f}}t.push(Object.assign(i.description,{mean:i.total/c,distribution:_,count:c}))}else i.callback?t.push(Object.assign(i.description,i.callback(i))):t.push(Object.assign(i.description,{total:i.total,count:i.count}));await iC()}let s=process.memoryUsage();t.push({metric:"memory",threadId:Mi.threadId,byThread:!0,...s});for(let n of sC)n(t);I_=new Map,Mi.parentPort?Mi.parentPort.postMessage({type:rC,report:r}):cC({report:r})},tC).unref()}async function w2(e,t=6e4){let r=Ep(),s=oC(),n;for(let h of s.primaryStore.getRange({start:1/0,end:!1,reverse:!0}))if(h.value?.time){n=h.value.time;break}if(Date.now()-t<n)return;let i,o=new Map,c=new Map,u=[],_;for(let{key:h,value:S}of r.primaryStore.getRange({start:n||!1,exclusiveStart:!0,end:1/0})){if(!S)continue;if(i){if(h>i+t)break}else i=h;_=h;let{metrics:p,threadId:g}=S;for(let b of p||[]){let{path:O,method:Y,type:W,metric:F,count:w,total:K,distribution:B,threads:x,...te}=b;w||(w=1);let be=F+(O?"-"+O:"");Y!==void 0&&(be+="-"+Y),W!==void 0&&(be+="-"+W);let se=o.get(be);if(se){if(se.threads){let Pe=se.threads[g];if(Pe)se=Pe;else{se.threads[g]=Object.assign({},te);continue}}se.count||(se.count=1);let vt=se.count;for(let Pe in te){let At=te[Pe];typeof At=="number"&&(se[Pe]=(se[Pe]*vt+At*w)/(vt+w))}se.count+=w,K>=0&&(se.total+=K,se.ratio=se.total/se.count)}else se=Object.assign({period:t},b),delete se.distribution,o.set(be,se),se.byThread&&(se.threads=[],se.threads[g]=Object.assign({},te),u.push(se));if(B){B=B.map(Pe=>typeof Pe=="number"?{value:Pe,count:1}:Pe);let vt=c.get(be);vt?vt.push(...B):c.set(be,B)}}await iC()}for(let h of u){let{path:S,method:p,type:g,metric:b,count:O,total:Y,distribution:W,threads:F,...w}=h;F=F.filter(K=>K);for(let K in w){if(typeof h[K]!="number")continue;let B=0;for(let x of F){let te=x[K];typeof te=="number"&&(B+=te)}h[K]=B}h.count=F.length,delete h.threads,delete h.byThread}for(let[h,S]of c){let p=o.get(h);S.sort((Pe,At)=>Pe.value>At.value?1:-1);let g=p.count-1,b=[],O=0,Y=0,W;for(let Pe of nC){let At=g*Pe;for(;O<At;)W=S[Y++],O+=W.count,Y===1&&O--;let Zr=S[Y>1?Y-2:0];W||(W=S[0]),b.push(W.value-(W.value-Zr.value)*(O-At)/W.count)}let[F,w,K,B,x,te,be,se,vt]=b;Object.assign(p,{p1:F,p10:w,p25:K,median:B,p75:x,p90:te,p95:be,p99:se,p999:vt})}let l;for(let[h,S]of o)S.id=(0,y_.getNextMonotonicTime)(),S.time=_,s.primaryStore.put(S.id,S,{append:!0}).then(p=>{p||s.primaryStore.put(S.id,S)}),l=!0;let d=Date.now(),{idle:f,active:E}=performance.eventLoopUtilization();if(l||E*10>f){let h=(0,y_.getNextMonotonicTime)(),S={id:h,metric:"main-thread-utilization",idle:f-Yw,active:E-Kw,time:d,...process.memoryUsage()};s.primaryStore.put(h,S,{append:!0}).then(p=>{p||s.primaryStore.put(h,S)})}Yw=f,Kw=E}async function Ww(e,t){let r=Date.now()-t;for(let s of e.primaryStore.getKeys({start:!1,end:r}))e.primaryStore.remove(s)}function Ep(){return Qw||(Qw=et({table:"hdb_raw_analytics",database:"system",audit:!1,trackDeletes:!1,attributes:[{name:"id",isPrimaryKey:!0},{name:"action"},{name:"metrics"}]}))}function oC(){return zw||(zw=et({table:"hdb_analytics",database:"system",audit:!1,trackDeletes:!1,attributes:[{name:"id",isPrimaryKey:!0},{name:"metric"},{name:"path"},{name:"method"},{name:"type"}]}))}function D2(){aC=!0;let e=(0,bc.get)(fp.CONFIG_PARAMS.ANALYTICS_AGGREGATEPERIOD)*1e3;e&&setInterval(async()=>{await w2(tC,e),await Ww(Ep(),C2),await Ww(oC(),L2)},Math.min(e/2,2147483647)).unref()}function cC(e,t){let r=e.report;r.threadId=t?.threadId||Mi.threadId;for(let s of r.metrics)s.metric==="bytes-sent"&&(Jw+=s.mean*s.count);r.totalBytesProcessed=Jw,t&&(r.metrics.push({metric:"utilization",...t.performance.eventLoopUtilization(Xw.get(t))}),Xw.set(t,t.performance.eventLoopUtilization())),r.id=(0,y_.getNextMonotonicTime)(),Ep().primaryStore.put(r.id,r),aC||D2(),U2&&(uC=P2(r))}async function P2(e){if(await uC,!Yn){let r=(0,Nc.dirname)((0,Zw.getLogFilePath)());try{Yn=await(0,dp.open)((0,Nc.join)(r,"analytics.log"),"r+")}catch{Yn=await(0,dp.open)((0,Nc.join)(r,"analytics.log"),"w+")}}let t=(await Yn.stat()).size;if(t>M2){let r=Buffer.alloc(t);await Yn.read(r,{position:0}),r=r.subarray(r.indexOf(10,r.length/2)+1),await Yn.write(r,{position:0}),await Yn.truncate(r.length),t=r.length}await Yn.write(JSON.stringify(e)+`
`,t)}var Mi,jw,Zw,Nc,dp,y_,bc,fp,I_,eC,b_,tC,rC,sC,nC,Yw,Kw,iC,C2,L2,Qw,zw,aC,Jw,Xw,U2,uC,Yn,M2,_n=Te(()=>{Mi=require("worker_threads"),jw=U(Je());fe();Zw=U(G()),Nc=require("path"),dp=require("fs/promises"),y_=U(Er()),bc=U(X()),fp=U(y());hr();(0,bc.initSync)();I_=new Map,eC=(0,bc.get)(fp.CONFIG_PARAMS.ANALYTICS_AGGREGATEPERIOD)>-1;a(y2,"setAnalyticsEnabled");a(br,"recordAction");ut.recordAnalytics=br;a(xr,"recordActionBinary");b_=0,tC=1e3,rC="analytics-report",sC=[];a(yc,"addAnalyticsListener");nC=[.01,.1,.25,.5,.75,.9,.95,.99,.999,1];a(I2,"sendAnalytics");a(w2,"aggregation");Yw=0,Kw=0,iC=a(()=>new Promise(setImmediate),"rest");a(Ww,"cleanup");C2=36e5,L2=31536e6;a(Ep,"getRawAnalyticsTable");a(oC,"getAnalyticsTable");(0,jw.setChildListenerByType)(rC,cC);a(D2,"startScheduledTasks");Jw=0,Xw=new Map,U2=!1;a(cC,"recordAnalytics");M2=1e6;a(P2,"logAnalytics")});var _t=T((vue,wC)=>{"use strict";var wt=X();wt.initSync();var v2=require("fs-extra"),B2=require("semver"),Lc=require("path"),{monotonicFactory:H2}=require("ulidx"),_C=H2(),q2=require("util"),dC=require("child_process"),F2=q2.promisify(dC.exec),G2=dC.spawn,Re=Ve(),Oe=y(),Sp=$(),kr=G(),w_=nn(),x2=N_(),wc=gr(),{onMessageByType:k2}=Je(),{isMainThread:V2}=require("worker_threads"),{Encoder:$2,decode:Tp}=require("msgpackr"),fC=new $2,{isEmpty:Pi}=Sp,EC=Gr(),Y2=48*36e11,K2=5e9;V2&&k2(Oe.ITC_EVENT_TYPES.RESTART,()=>{hs=void 0,Do=void 0});var{connect:W2,StorageType:hC,RetentionPolicy:mC,AckPolicy:C_,DeliverPolicy:L_,DiscardPolicy:Q2,NatsConnection:Due,JetStreamManager:Uue,JetStreamClient:Mue,StringCodec:Pue,JSONCodec:z2,createInbox:gp,headers:J2,ErrorCode:lC}=require("nats"),{PACKAGE_ROOT:X2}=y(),j2=Oc(),{recordAction:Z2}=(_n(),Z(Ic)),pC=z2(),eJ="clustering",tJ=j2.engines[Re.NATS_SERVER_NAME],rJ=Lc.join(X2,"dependencies"),pp=Lc.join(rJ,`${process.platform}-${process.arch}`,Re.NATS_BINARY_NAME),hp,mp,Cc,Co,Lo;wC.exports={runCommand:SC,checkNATSServerInstalled:sJ,createConnection:Rp,getConnection:D_,getJetStreamManager:Dc,getJetStream:TC,getNATSReferences:jt,getServerList:iJ,createLocalStream:Ap,listStreams:gC,deleteLocalStream:oJ,getServerConfig:Uc,listRemoteStreams:aJ,viewStream:cJ,viewStreamIterator:uJ,publishToStream:lJ,createWorkQueueStream:_J,addSourceToWorkStream:AC,request:fJ,removeSourceFromWorkStream:NC,reloadNATS:Op,reloadNATSHub:EJ,reloadNATSLeaf:hJ,extractServerName:OC,requestErrorHandler:mJ,updateWorkStream:pJ,createLocalTableStream:yC,createTableStreams:SJ,purgeTableStream:IC,purgeSchemaTableStreams:TJ,getStreamInfo:gJ,updateLocalStreams:AJ,closeConnection:nJ,getJsmServerName:Mc,addNatsMsgHeader:RC,updateIngestStreamConsumer:dJ};async function SC(e,t=void 0){let{stdout:r,stderr:s}=await F2(e,{cwd:t});if(s)throw new Error(s.replace(`
`,""));return r.replace(`
`,"")}a(SC,"runCommand");async function sJ(){try{await v2.access(pp)}catch{return!1}let e=await SC(`${pp} --version`,void 0),t=e.substring(e.lastIndexOf("v")+1,e.length);return B2.eq(t,tJ)}a(sJ,"checkNATSServerInstalled");async function Rp(e,t,r,s=!0,n="127.0.0.1"){if(!t&&!r){let o=await EC.getClusterUser();if(Pi(o))throw new Error("Unable to get nats connection. Cluster user is undefined.");t=o.username,r=o.decrypt_hash}kr.trace("create nats connection called");let i=await W2({name:n,port:e,user:t,pass:r,maxReconnectAttempts:-1,waitOnFirstConnect:s,timeout:2e5,tls:{keyFile:wt.get(Oe.CONFIG_PARAMS.CLUSTERING_TLS_PRIVATEKEY),certFile:wt.get(Oe.CONFIG_PARAMS.CLUSTERING_TLS_CERTIFICATE),caFile:wt.get(Oe.CONFIG_PARAMS.CLUSTERING_TLS_CERT_AUTH),rejectUnauthorized:!1}});return kr.trace("create connection established a nats client connection with id",i?.info?.client_id),i}a(Rp,"createConnection");async function nJ(){hs&&(await hs.drain(),hs=void 0,Co=void 0,Lo=void 0,Do=void 0)}a(nJ,"closeConnection");var hs,Do;async function D_(){return Do||(Do=Rp(wt.get(Oe.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_NETWORK_PORT),void 0,void 0),hs=await Do),hs||Do}a(D_,"getConnection");async function Dc(){if(Co)return Co;Pi(hs)&&await D_();let{domain:e}=Uc(Oe.PROCESS_DESCRIPTORS.CLUSTERING_LEAF);if(Pi(e))throw new Error("Error getting JetStream domain. Unable to get JetStream manager.");return Co=await hs.jetstreamManager({domain:e}),Co}a(Dc,"getJetStreamManager");async function TC(){if(Lo)return Lo;Pi(hs)&&await D_();let{domain:e}=Uc(Oe.PROCESS_DESCRIPTORS.CLUSTERING_LEAF);if(Pi(e))throw new Error("Error getting JetStream domain. Unable to get JetStream manager.");return Lo=hs.jetstream({domain:e}),Lo}a(TC,"getJetStream");async function jt(){let e=hs||await D_(),t=Co||await Dc(),r=Lo||await TC();return{connection:e,jsm:t,js:r}}a(jt,"getNATSReferences");async function iJ(e){let t=wt.get(Oe.CONFIG_PARAMS.CLUSTERING_HUBSERVER_NETWORK_PORT),{sys_name:r,decrypt_hash:s}=await EC.getClusterUser(),n=await Rp(t,r,s),i=gp(),o=n.subscribe(i),c=[],u,_=(async()=>{for await(let l of o){let d=pC.decode(l.data);d.response_time=Date.now()-u,c.push(d)}})();return u=Date.now(),await n.publish("$SYS.REQ.SERVER.PING.VARZ",void 0,{reply:i}),await n.publish("$SYS.REQ.SERVER.PING",void 0,{reply:i}),await n.flush(),await Sp.async_set_timeout(e),await o.drain(),await n.close(),await _,c}a(iJ,"getServerList");async function Ap(e,t){let{jsm:r}=await jt(),s=wt.get(Oe.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_STREAMS_MAXAGE);s=s===null?0:s*1e9;let n=wt.get(Oe.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_STREAMS_MAXMSGS);n=n===null?-1:n;let i=wt.get(Oe.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_STREAMS_MAXBYTES);i=i===null?-1:i,await r.streams.add({name:e,storage:hC.File,retention:mC.Limits,subjects:t,discard:Q2.Old,max_msgs:n,max_bytes:i,max_age:s})}a(Ap,"createLocalStream");async function gC(){let{jsm:e}=await jt(),t=await e.streams.list().next(),r=[];return t.forEach(s=>{r.push(s)}),r}a(gC,"listStreams");async function oJ(e){let{jsm:t}=await jt();await t.streams.delete(e)}a(oJ,"deleteLocalStream");async function aJ(e){let{connection:t}=await jt(),r=[],s=gp(),n=t.subscribe(s),i=(async()=>{for await(let o of n)r.push(pC.decode(o.data))})();return await t.publish(`$JS.${e}.API.STREAM.LIST`,void 0,{reply:s}),await t.flush(),await n.drain(),await i,r}a(aJ,"listRemoteStreams");async function cJ(e,t=void 0,r=void 0){let{jsm:s,js:n}=await jt(),i=_C(),o={durable_name:i,ack_policy:C_.Explicit};t&&(o.deliver_policy=L_.StartTime,o.opt_start_time=new Date(t).toISOString()),await s.consumers.add(e,o);let c=await n.consumers.get(e,i),u=r?await c.fetch({max_messages:r,expires:2e3}):await c.consume();if(c._info.num_pending===0)return[];let _=[];for await(let l of u){let d=Tp(l.data),f={nats_timestamp:l.info.timestampNanos,nats_sequence:l.info.streamSequence,entry:d};if(l.headers&&(f.origin=l.headers.get(Re.MSG_HEADERS.ORIGIN)),_.push(f),l.ack(),l.info.pending===0)break}return await c.delete(),_}a(cJ,"viewStream");async function*uJ(e,t=void 0,r=void 0){let{jsm:s,js:n}=await jt(),i=_C(),o={durable_name:i,ack_policy:C_.Explicit};t&&(o.deliver_policy=L_.StartTime,o.opt_start_time=new Date(t).toISOString()),await s.consumers.add(e,o);let c=await n.consumers.get(e,i),u=r?await c.fetch({max_messages:r,expires:2e3}):await c.consume();if(c._info.num_pending===0)return[];for await(let _ of u){let l=Tp(_.data);l[0]||(l=[l]);for(let d of l){let f={nats_timestamp:_.info.timestampNanos,nats_sequence:_.info.streamSequence,entry:d};_.headers&&(f.origin=_.headers.get(Re.MSG_HEADERS.ORIGIN)),yield f}if(_.ack(),_.info.pending===0)break}await c.delete()}a(uJ,"viewStreamIterator");async function lJ(e,t,r,s){kr.trace(`publishToStream called with subject: ${e}, stream: ${t}, entries:`,s.operation),r=RC(s,r);let{js:n}=await jt(),i=await Mc(),o=`${e}.${i}`,c=s instanceof Uint8Array?s:fC.encode(s);try{kr.trace(`publishToStream publishing to subject: ${o}`),Z2(c.length,"bytes-sent",e,s.operation,"replication"),await n.publish(o,c,{headers:r})}catch(u){if(u.code&&u.code.toString()==="503")return bC(async()=>{try{await n.publish(o,c,{headers:r})}catch{if(u.code&&u.code.toString()==="503"){kr.trace(`publishToStream creating stream: ${t}`);let l=o.split(".");l[2]="*",await Ap(t,[o]),await n.publish(o,c,{headers:r})}else throw u}});throw u}}a(lJ,"publishToStream");function RC(e,t){t===void 0&&(t=J2());let r=wt.get(Oe.CONFIG_PARAMS.CLUSTERING_NODENAME);return!t.has(Re.MSG_HEADERS.ORIGIN)&&r&&t.append(Re.MSG_HEADERS.ORIGIN,r),t}a(RC,"addNatsMsgHeader");function Uc(e){e=e.toLowerCase();let t=Lc.join(wt.get(Oe.CONFIG_PARAMS.ROOTPATH),eJ);if(e===Oe.PROCESS_DESCRIPTORS.CLUSTERING_HUB.toLowerCase())return Pi(mp)&&(mp={port:wc.getConfigFromFile(Oe.CONFIG_PARAMS.CLUSTERING_HUBSERVER_NETWORK_PORT),server_name:wc.getConfigFromFile(Oe.CONFIG_PARAMS.CLUSTERING_NODENAME)+Re.SERVER_SUFFIX.HUB,config_file:Re.NATS_CONFIG_FILES.HUB_SERVER,pid_file_path:Lc.join(t,Re.PID_FILES.HUB),hdb_nats_path:t}),mp;if(e===Oe.PROCESS_DESCRIPTORS.CLUSTERING_LEAF.toLowerCase())return Pi(hp)&&(hp={port:wc.getConfigFromFile(Oe.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_NETWORK_PORT),server_name:wc.getConfigFromFile(Oe.CONFIG_PARAMS.CLUSTERING_NODENAME)+Re.SERVER_SUFFIX.LEAF,config_file:Re.NATS_CONFIG_FILES.LEAF_SERVER,domain:wc.getConfigFromFile(Oe.CONFIG_PARAMS.CLUSTERING_NODENAME)+Re.SERVER_SUFFIX.LEAF,pid_file_path:Lc.join(t,Re.PID_FILES.LEAF),hdb_nats_path:t}),hp;kr.error(`Unable to get Nats server config. Unrecognized process: ${e}`)}a(Uc,"getServerConfig");async function _J(e){let{jsm:t}=await jt(),r=await Mc();try{await t.streams.add({name:e.stream_name,storage:hC.File,retention:mC.Limits,max_age:Y2,max_bytes:K2,subjects:[`${Re.SUBJECT_PREFIXES.TXN}.${e.stream_name}.${r}`]})}catch(s){if(s.code!=="400")throw s}try{await t.consumers.info(e.stream_name,e.durable_name)}catch(s){if(s.code.toString()==="404")await t.consumers.add(e.stream_name,{ack_policy:C_.Explicit,durable_name:e.durable_name,deliver_policy:L_.All,max_ack_pending:1e4});else throw s}}a(_J,"createWorkQueueStream");async function dJ(){let{jsm:e}=await jt();(await e.consumers.info(Re.WORK_QUEUE_CONSUMER_NAMES.stream_name,Re.WORK_QUEUE_CONSUMER_NAMES.durable_name)).config.deliver_subject&&(kr.info("Removing old nats push consumer from ingest stream"),await e.consumers.delete(Re.WORK_QUEUE_CONSUMER_NAMES.stream_name,Re.WORK_QUEUE_CONSUMER_NAMES.durable_name),kr.info("Adding pull consumer to ingest stream"),await e.consumers.add(Re.WORK_QUEUE_CONSUMER_NAMES.stream_name,{ack_policy:C_.Explicit,durable_name:Re.WORK_QUEUE_CONSUMER_NAMES.durable_name,deliver_policy:L_.All,max_ack_pending:1e4}))}a(dJ,"updateIngestStreamConsumer");async function AC(e,t,r){let{jsm:s}=await jt(),n=await s.streams.info(t),i=OC(s.prefix),o=r.start_time?r.start_time:new Date(Date.now()).toISOString(),{schema:c,table:u}=r,_=w_.createNatsTableStreamName(c,u),l=i===e,d,f,E=!1;if(!Array.isArray(n.config.sources)||n.config.sources.length===0)n.config.sources=[];else for(let S=0,p=n.config.sources.length;S<p;S++)if(d=n.config.sources[S],f=S,l&&d.name===_||!l&&d.name===_&&d.external&&d.external.api===`$JS.${e}.API`){E=!0;break}if(E===!0){if(d.opt_start_time===o)return;let S=`txn.${c}.${u}.${e}`;await s.streams.purge(t,{filter:S}),n.config.sources.splice(f,1),await s.streams.update(t,n.config)}let h={name:_,opt_start_time:o,filter_subject:`${Re.SUBJECT_PREFIXES.TXN}.>`};l||(h.external={api:`$JS.${e}.API`,deliver:""}),n.config.sources.push(h),await s.streams.update(t,n.config)}a(AC,"addSourceToWorkStream");function OC(e){return e.split(".")[1]}a(OC,"extractServerName");async function NC(e,t,r){let{jsm:s}=await jt(),{schema:n,table:i}=r,o=`txn.${n}.${i}.${e}`;await s.streams.purge(t,{filter:o});let c=w_.createNatsTableStreamName(n,i),u=await s.streams.info(t);if(!Array.isArray(u.config.sources)||u.config.sources.length===0)return;let _=u.config.sources.length,l;for(;_--;)if(l=u.config.sources[_],l.name===c&&l.external.api===`$JS.${e}.API`){u.config.sources.splice(_,1);break}await s.streams.update(t,u.config)}a(NC,"removeSourceFromWorkStream");async function fJ(e,t,r=2e4,s=gp()){if(!Sp.isObject(t))throw new Error("data param must be an object");let n=fC.encode(t),{connection:i}=await jt(),o={timeout:r};s&&(o.reply=s,o.noMux=!0);let c=await i.request(e,n,o);return Tp(c.data)}a(fJ,"request");function Op(e){return new Promise(async(t,r)=>{let s=G2(pp,["--signal",`reload=${e}`],{cwd:__dirname}),n,i;s.on("error",o=>{r(o)}),s.stdout.on("data",o=>{i+=o.toString()}),s.stderr.on("data",o=>{n+=o.toString()}),s.stderr.on("close",o=>{n&&r(n),t(i)})})}a(Op,"reloadNATS");async function EJ(){let{pid_file_path:e}=Uc(Oe.PROCESS_DESCRIPTORS.CLUSTERING_HUB);await Op(e)}a(EJ,"reloadNATSHub");async function hJ(){let{pid_file_path:e}=Uc(Oe.PROCESS_DESCRIPTORS.CLUSTERING_LEAF);await Op(e)}a(hJ,"reloadNATSLeaf");function mJ(e,t,r){let s;switch(e.code){case lC.NoResponders:s=`Unable to ${t}, node '${r}' is not listening.`;break;case lC.Timeout:s=`Unable to ${t}, node '${r}' is listening but did not respond.`;break;default:s=e.message;break}return s}a(mJ,"requestErrorHandler");async function pJ(e,t){let r=t+Re.SERVER_SUFFIX.LEAF;await bC(async()=>{e.subscribe===!0?await AC(r,Re.WORK_QUEUE_CONSUMER_NAMES.stream_name,e):await NC(r,Re.WORK_QUEUE_CONSUMER_NAMES.stream_name,e)})}a(pJ,"updateWorkStream");function bC(e){return x2.writeTransaction(Oe.SYSTEM_SCHEMA_NAME,Oe.SYSTEM_TABLE_NAMES.NODE_TABLE_NAME,e)}a(bC,"exclusiveLock");async function yC(e,t){let r=w_.createNatsTableStreamName(e,t),s=await Mc(),n=RJ(e,t,s);await Ap(r,[n])}a(yC,"createLocalTableStream");async function SJ(e){for(let t=0,r=e.length;t<r;t++){let s=e[t].schema,n=e[t].table;await yC(s,n)}}a(SJ,"createTableStreams");async function IC(e,t){if(wt.get(Oe.CONFIG_PARAMS.CLUSTERING_ENABLED))try{let r=w_.createNatsTableStreamName(e,t),{jsm:s}=await jt();await s.streams.purge(r)}catch(r){if(r.message==="stream not found")kr.warn(r);else throw r}}a(IC,"purgeTableStream");async function TJ(e,t){if(wt.get(Oe.CONFIG_PARAMS.CLUSTERING_ENABLED))for(let r=0,s=t.length;r<s;r++)await IC(e,t[r])}a(TJ,"purgeSchemaTableStreams");async function gJ(e){return(await Dc()).streams.info(e)}a(gJ,"getStreamInfo");function RJ(e,t,r){return`${Re.SUBJECT_PREFIXES.TXN}.${e}${t?"."+t:""}.${r}`}a(RJ,"createSubjectName");async function Mc(){if(Cc)return Cc;if(Cc=(await Dc())?.nc?.info?.server_name,Cc===void 0)throw new Error("Unable to get jetstream manager server name");return Cc}a(Mc,"getJsmServerName");async function AJ(){let e=await Dc(),t=await Mc(),r=await gC();for(let s of r){let n=s.config,i=n.subjects[0];if(!i)continue;let o=OJ(s),c=i.split(".");if(!(c[c.length-1]===t&&!o)){if(n.name===Re.SCHEMA_QUEUE_CONSUMER_NAMES.stream_name){let _=`${Re.SCHEMA_QUEUE_CONSUMER_NAMES.deliver_subject}.${t}`;kr.trace(`Updating stream subject name from: ${i} to: ${_}`),n.subjects[0]=_}else if(n.name===Re.WORK_QUEUE_CONSUMER_NAMES.stream_name){let _=`${Re.WORK_QUEUE_CONSUMER_NAMES.stream_name}.${t}`;kr.trace(`Updating stream subject name from: ${i} to: ${_}`),n.subjects[0]=_}else{let _=i.split(".");_[_.length-1]=t;let l=_.join(".");kr.trace(`Updating stream subject name from: ${i} to: ${l}`),n.subjects[0]=l}await e.streams.update(n.name,n)}}}a(AJ,"updateLocalStreams");function OJ(e){let{config:t}=e,r=!1;if(t.name===Re.SCHEMA_QUEUE_CONSUMER_NAMES.stream_name||t.name===Re.WORK_QUEUE_CONSUMER_NAMES.stream_name)return r;let s=wt.get(Oe.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_STREAMS_MAXAGE);s=s===null?0:s*1e9;let n=wt.get(Oe.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_STREAMS_MAXBYTES);n=n===null?-1:n;let i=wt.get(Oe.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_STREAMS_MAXMSGS);return i=i===null?-1:i,s!==t.max_age&&(t.max_age=s,r=!0),n!==t.max_bytes&&(t.max_bytes=n,r=!0),i!==t.max_msgs&&(t.max_msgs=i,r=!0),r}a(OJ,"updateStreamLimits")});var v_=T((que,UC)=>{"use strict";var Uo=Hl(),Mo=$w(),NJ=G(),bJ=require("uuid").v4,Hue=require("clone"),M_=cn(),Po=y(),yJ=require("util"),Kn=os(),{handleHDBError:Zt,hdb_errors:IJ}=j(),{HDB_ERROR_MSGS:U_,HTTP_STATUS_CODES:er}=IJ,{SchemaEventMsg:P_}=us(),CC=_t(),{getDatabases:wJ}=(fe(),Z(Ce)),{transformReq:vo}=$();UC.exports={createSchema:CJ,createSchemaStructure:LC,createTable:LJ,createTableStructure:DC,createAttribute:vJ,dropSchema:DJ,dropTable:UJ,dropAttribute:MJ,getBackup:BJ};async function CJ(e){let t=await LC(e);return M_.signalSchemaChange(new P_(process.pid,e.operation,e.schema)),t}a(CJ,"createSchema");async function LC(e){let t=Uo.schema_object(e);if(t)throw Zt(t,t.message,er.BAD_REQUEST,void 0,void 0,!0);if(vo(e),!await Mo.checkSchemaExists(e.schema))throw Zt(new Error,U_.SCHEMA_EXISTS_ERR(e.schema),er.BAD_REQUEST,Po.LOG_LEVELS.ERROR,U_.SCHEMA_EXISTS_ERR(e.schema),!0);return await Kn.createSchema(e),`database '${e.schema}' successfully created`}a(LC,"createSchemaStructure");async function LJ(e){return vo(e),e.hash_attribute=e.primary_key??e.hash_attribute,await DC(e)}a(LJ,"createTable");async function DC(e){let t=Uo.create_table_object(e);if(t)throw Zt(t,t.message,er.BAD_REQUEST,void 0,void 0,!0);if(Uo.validateTableResidence(e.residence),!await Mo.checkSchemaTableExists(e.schema,e.table))throw Zt(new Error,U_.TABLE_EXISTS_ERR(e.schema,e.table),er.BAD_REQUEST,Po.LOG_LEVELS.ERROR,U_.TABLE_EXISTS_ERR(e.schema,e.table),!0);let s={name:e.table,schema:e.schema,id:bJ(),hash_attribute:e.hash_attribute};try{if(e.residence)if(global.clustering_on)s.residence=e.residence,await Kn.createTable(s,e);else throw Zt(new Error,"Clustering does not appear to be enabled. Cannot insert table with property 'residence'.",er.BAD_REQUEST);else await Kn.createTable(s,e);return`table '${e.schema}.${e.table}' successfully created.`}catch(n){throw n}}a(DC,"createTableStructure");async function DJ(e){let t=!e.schema&&!e.database?new Error("database is required"):void 0,r=Uo.schema_object(e),s=t??r;if(s)throw Zt(s,s.message,er.BAD_REQUEST,void 0,void 0,!0);vo(e);let n=await Mo.checkSchemaExists(e.schema);if(n)throw Zt(new Error,n,er.NOT_FOUND,Po.LOG_LEVELS.ERROR,n,!0);let i=await Mo.schema_describe.describeSchema({schema:e.schema}),o=Object.keys(global.hdb_schema[e.schema]);return await Kn.dropSchema(e),M_.signalSchemaChange(new P_(process.pid,e.operation,e.schema)),await CC.purgeSchemaTableStreams(e.schema,o),`successfully deleted '${e.schema}'`}a(DJ,"dropSchema");async function UJ(e){let t=Uo.table_object(e);if(t)throw Zt(t,t.message,er.BAD_REQUEST,void 0,void 0,!0);vo(e);let r=await Mo.checkSchemaTableExists(e.schema,e.table);if(r)throw Zt(new Error,r,er.NOT_FOUND,Po.LOG_LEVELS.ERROR,r,!0);return await Kn.dropTable(e),await CC.purgeTableStream(e.schema,e.table),`successfully deleted table '${e.schema}.${e.table}'`}a(UJ,"dropTable");async function MJ(e){let t=Uo.attribute_object(e);if(t)throw Zt(t,t.message,er.BAD_REQUEST,void 0,void 0,!0);vo(e);let r=await Mo.checkSchemaTableExists(e.schema,e.table);if(r)throw Zt(new Error,r,er.NOT_FOUND,Po.LOG_LEVELS.ERROR,r,!0);if(e.attribute===global.hdb_schema[e.schema][e.table].hash_attribute)throw Zt(new Error,"You cannot drop a hash attribute",er.BAD_REQUEST,void 0,void 0,!0);if(Po.TIME_STAMP_NAMES.indexOf(e.attribute)>=0)throw Zt(new Error,`cannot drop internal timestamp attribute: ${e.attribute}`,er.BAD_REQUEST,void 0,void 0,!0);try{return await Kn.dropAttribute(e),PJ(e),M_.signalSchemaChange(new P_(process.pid,e.operation,e.schema,e.table,e.attribute)),`successfully deleted attribute '${e.attribute}'`}catch(s){throw NJ.error(`Got an error deleting attribute ${yJ.inspect(e)}.`),s}}a(MJ,"dropAttribute");function PJ(e){let t=Object.values(global.hdb_schema[e.schema][e.table].attributes);for(let r=0;r<t.length;r++)t[r].attribute===e.attribute&&global.hdb_schema[e.schema][e.table].attributes.splice(r,1)}a(PJ,"dropAttributeFromGlobal");async function vJ(e){vo(e);let t=wJ()[e.schema][e.table].attributes;for(let{name:r}of t)if(r===e.attribute)throw Zt(new Error,`attribute '${e.attribute}' already exists in ${e.schema}.${e.table}`,er.BAD_REQUEST,void 0,void 0,!0);return await Kn.createAttribute(e),M_.signalSchemaChange(new P_(process.pid,e.operation,e.schema,e.table,e.attribute)),`attribute '${e.schema}.${e.table}.${e.attribute}' successfully created.`}a(vJ,"createAttribute");function BJ(e){return Kn.getBackup(e)}a(BJ,"getBackup")});var PC=T((Gue,MC)=>{"use strict";var{OPERATIONS_ENUM:HJ}=y(),Np=class{static{a(this,"ReadAuditLogObject")}constructor(t,r,s=void 0,n=void 0){this.operation=HJ.READ_AUDIT_LOG,this.schema=t,this.table=r,this.search_type=s,this.search_values=n}};MC.exports=Np});var bp=T((Vue,FC)=>{"use strict";var qJ=os(),kue=PC(),B_=$(),H_=y(),FJ=X(),{handleHDBError:vC,hdb_errors:GJ}=j(),{HDB_ERROR_MSGS:BC,HTTP_STATUS_CODES:HC}=GJ,xJ=Object.values(H_.READ_AUDIT_LOG_SEARCH_TYPES_ENUM),qC="To use this operation audit log must be enabled in harperdb-config.yaml";FC.exports=kJ;async function kJ(e){if(B_.isEmpty(e.schema))throw new Error(BC.SCHEMA_REQUIRED_ERR);if(B_.isEmpty(e.table))throw new Error(BC.TABLE_REQUIRED_ERR);if(!FJ.get(H_.CONFIG_PARAMS.LOGGING_AUDITLOG))throw vC(new Error,qC,HC.BAD_REQUEST,H_.LOG_LEVELS.ERROR,qC,!0);let t=B_.checkSchemaTableExist(e.schema,e.table);if(t)throw vC(new Error,t,HC.NOT_FOUND,H_.LOG_LEVELS.ERROR,t,!0);if(!B_.isEmpty(e.search_type)&&xJ.indexOf(e.search_type)<0)throw new Error(`Invalid search_type '${e.search_type}'`);return await qJ.readAuditLog(e)}a(kJ,"readAuditLog")});var xC=T((Yue,GC)=>{"use strict";var{OPERATIONS_ENUM:VJ}=y(),yp=class{static{a(this,"GetBackupObject")}constructor(t,r,s=void 0,n=void 0){this.operation=VJ.GET_BACKUP,this.schema=t,this.table=r}};GC.exports=yp});var $C=T((zue,VC)=>{"use strict";var $J=os(),Wue=xC(),Ip=$(),YJ=y(),Que=X(),{handleHDBError:KJ,hdb_errors:WJ}=j(),{HDB_ERROR_MSGS:kC,HTTP_STATUS_CODES:QJ}=WJ;VC.exports=zJ;async function zJ(e){if(Ip.isEmpty(e.schema))throw new Error(kC.SCHEMA_REQUIRED_ERR);if(Ip.isEmpty(e.table))throw new Error(kC.TABLE_REQUIRED_ERR);let t=Ip.checkSchemaTableExist(e.schema,e.table);if(t)throw KJ(new Error,t,QJ.NOT_FOUND,YJ.LOG_LEVELS.ERROR,t,!0);return await $J.getBackup(read_audit_log_object)}a(zJ,"getBackup")});var JC=T((Xue,zC)=>{var Wn=require("validate.js"),KC=ke(),Bo=y(),{handleHDBError:JJ,hdb_errors:XJ}=j(),{HDB_ERROR_MSGS:je,HTTP_STATUS_CODES:jJ}=XJ,wp=a(()=>({role:{presence:!0,format:"[\\w\\-\\_]+"},id:{presence:!0,format:"[\\w\\-\\_]+"},permission:{presence:!0}}),"constraintsTemplate"),ZJ={STRUCTURE_USER:"structure_user"},YC=Object.values(Bo.ROLE_TYPES_ENUM),e4="attribute_permissions",t4="attribute_name",{PERMS_CRUD_ENUM:Ho}=Bo,r4=[e4,...Object.values(Ho)],WC=[Ho.READ,Ho.INSERT,Ho.UPDATE],s4=[t4,...WC];function n4(e){let t=wp();return t.role.presence=!0,t.id.presence=!1,t.permission.presence=!0,QC(e,t)}a(n4,"addRoleValidation");function i4(e){let t=wp();return t.role.presence=!1,t.id.presence=!0,t.permission.presence=!0,QC(e,t)}a(i4,"alterRoleValidation");function o4(e){let t=wp();return t.role.presence=!1,t.id.presence=!0,t.permission.presence=!1,KC.validateObject(e,t)}a(o4,"dropRoleValidation");var a4=["operation","role","id","permission","hdb_user","hdb_auth_header"];function QC(e,t){let r={main_permissions:[],schema_permissions:{}},s=Object.keys(e),n=[];for(let o=0,c=s.length;o<c;o++)a4.includes(s[o])||n.push(s[o]);n.length>0&&st(je.INVALID_ROLE_JSON_KEYS(n),r);let i=KC.validateObject(e,t);if(i&&i.message.split(",").forEach(o=>{st(o,r)}),e.permission){let o=c4(e);o&&st(o,r),YC.forEach(c=>{e.permission[c]&&!Wn.isBoolean(e.permission[c])&&st(je.SU_CU_ROLE_BOOLEAN_ERROR(c),r)})}for(let o in e.permission)if(YC.indexOf(o)<0){if(o===ZJ.STRUCTURE_USER){let u=e.permission[o];if(typeof u=="boolean")continue;if(Array.isArray(u)){for(let _=0,l=u.length;_<l;_++){let d=u[_];global.hdb_schema[d]||st(je.SCHEMA_NOT_FOUND(d),r)}continue}st(je.STRUCTURE_USER_ROLE_TYPE_ERROR(o),r);continue}let c=e.permission[o];if(!o||!global.hdb_schema[o]){st(je.SCHEMA_NOT_FOUND(o),r);continue}if(c.tables)for(let u in c.tables){let _=c.tables[u];if(!u||!global.hdb_schema[o][u]){st(je.TABLE_NOT_FOUND(o,u),r);continue}if(Object.keys(_).forEach(l=>{r4.includes(l)||st(je.INVALID_PERM_KEY(l),r,o,u)}),Object.values(Ho).forEach(l=>{Wn.isDefined(_[l])?Wn.isBoolean(_[l])||st(je.TABLE_PERM_NOT_BOOLEAN(l),r,o,u):st(je.TABLE_PERM_MISSING(l),r,o,u)}),Wn.isDefined(_.attribute_permissions)){if(!Wn.isArray(_.attribute_permissions)){st(je.ATTR_PERMS_NOT_ARRAY,r,o,u);continue}}else{st(je.ATTR_PERMS_ARRAY_MISSING,r,o,u);continue}if(_.attribute_permissions){let l=global.hdb_schema[o][u].attributes.map(({attribute:f})=>f),d={read:!1,insert:!1,update:!1};for(let f in _.attribute_permissions){let E=_.attribute_permissions[f];if(Object.keys(E).forEach(S=>{!s4.includes(S)&&S!==Ho.DELETE&&st(je.INVALID_ATTR_PERM_KEY(S),r,o,u)}),!Wn.isDefined(E.attribute_name)){st(je.ATTR_PERM_MISSING_NAME,r,o,u);continue}let h=E.attribute_name;if(!l.includes(h)){st(je.INVALID_ATTRIBUTE_IN_PERMS(h),r,o,u);continue}WC.forEach(S=>{Wn.isDefined(E[S])?Wn.isBoolean(E[S])||st(je.ATTR_PERM_NOT_BOOLEAN(S,h),r,o,u):st(je.ATTR_PERM_MISSING(S,h),r,o,u)}),!d.read&&E.read===!0&&(d.read=!0),!d.insert&&E.insert===!0&&(d.insert=!0),!d.update&&E.update===!0&&(d.update=!0)}if(_.read===!1&&d.read===!0||_.insert===!1&&d.insert===!0||_.update===!1&&d.update===!0){let f=`${o}.${u}`;st(je.MISMATCHED_TABLE_ATTR_PERMS(f),r,o,u)}}}}return u4(r)}a(QC,"customValidate");zC.exports={addRoleValidation:n4,alterRoleValidation:i4,dropRoleValidation:o4};function c4(e){let{operation:t,permission:r}=e;if(t===Bo.OPERATIONS_ENUM.ADD_ROLE||t===Bo.OPERATIONS_ENUM.ALTER_ROLE){let s=r.super_user===!0,n=r.cluster_user===!0;if(Object.keys(r).length>1&&(s||n)){if(n&&s)return je.SU_CU_ROLE_COMBINED_ERROR;{let o=r.super_user?Bo.ROLE_TYPES_ENUM.SUPER_USER:Bo.ROLE_TYPES_ENUM.CLUSTER_USER;return je.SU_CU_ROLE_NO_PERMS_ALLOWED(o)}}}return null}a(c4,"validateNoSUPerms");function u4(e){let{main_permissions:t,schema_permissions:r}=e;if(t.length>0||Object.keys(r).length>0){let s={error:je.ROLE_PERMS_ERROR,...e};return JJ(new Error,s,jJ.BAD_REQUEST)}else return null}a(u4,"generateRolePermResponse");function st(e,t,r,s){if(!r)t.main_permissions.push(e);else{let n=s?r+"_"+s:r;t.schema_permissions[n]?t.schema_permissions[n].push(e):t.schema_permissions[n]=[e]}}a(st,"addPermError")});var Pp=T((Zue,eL)=>{"use strict";var XC=Fr(),jC=qr(),l4=bi(),Lp=JC(),Dp=cn(),_4=require("uuid").v4,d4=require("util"),q_=y(),f4=$(),Up=jC.searchByValue,E4=jC.searchByHash,h4=d4.promisify(l4.delete),m4=Bs(),p4=yo(),{hdb_errors:S4,handleHDBError:qo}=j(),{HDB_ERROR_MSGS:ZC,HTTP_STATUS_CODES:F_}=S4,{UserEventMsg:Mp}=us();eL.exports={addRole:T4,alterRole:g4,dropRole:R4,listRoles:A4};function Cp(e){try{e.hdb_auth_header&&delete e.hdb_auth_header,e.HDB_INTERNAL_PATH&&delete e.HDB_INTERNAL_PATH,e.operation&&delete e.operation,e.hdb_user&&delete e.hdb_user}catch{}return e}a(Cp,"scrubRoleDetails");async function T4(e){let t=Lp.addRoleValidation(e);if(t)throw t;e=Cp(e);let r={schema:"system",table:"hdb_role",search_attribute:"role",search_value:e.role,hash_attribute:"id",get_attributes:["*"]},s;try{s=Array.from(await Up(r)||[])}catch(i){throw qo(i)}if(s&&s.length>0)throw qo(new Error,ZC.ROLE_ALREADY_EXISTS(e.role),F_.CONFLICT,void 0,void 0,!0);e.id||(e.id=_4());let n={operation:"insert",schema:"system",table:"hdb_role",hash_attribute:"id",records:[e]};return await XC.insert(n),Dp.signalUserChange(new Mp(process.pid)),e=Cp(e),e}a(T4,"addRole");async function g4(e){let t=Lp.alterRoleValidation(e);if(t)throw t;e=Cp(e);let r={operation:"update",schema:"system",table:"hdb_role",records:[e]},s;try{s=await XC.update(r)}catch(n){throw qo(n)}if(s&&s?.message==="updated 0 of 1 records")throw qo(new Error,"Invalid role id",F_.BAD_REQUEST,void 0,void 0,!0);return await Dp.signalUserChange(new Mp(process.pid)),e}a(g4,"alterRole");async function R4(e){let t=Lp.dropRoleValidation(e);if(t)throw qo(new Error,t,F_.BAD_REQUEST,void 0,void 0,!0);let r=new p4(q_.SYSTEM_SCHEMA_NAME,q_.SYSTEM_TABLE_NAMES.ROLE_TABLE_NAME,[e.id],["role"]),s=Array.from(await E4(r));if(s.length===0)throw qo(new Error,ZC.ROLE_NOT_FOUND,F_.NOT_FOUND,void 0,void 0,!0);let n=new m4(q_.SYSTEM_SCHEMA_NAME,q_.SYSTEM_TABLE_NAMES.USER_TABLE_NAME,"role",e.id,void 0,["username","active"]),i=Array.from(await Up(n)),o=!1;if(f4.isEmptyOrZeroLength(i)===!1){for(let u=0;u<i.length;u++)if(i[u].active===!0){o=!0;break}}if(o===!0)throw new Error(`Cannot drop role ${s[0].role} as it has active user(s) tied to this role`);let c={table:"hdb_role",schema:"system",hash_values:[e.id]};return await h4(c),Dp.signalUserChange(new Mp(process.pid)),`${s[0].role} successfully deleted`}a(R4,"dropRole");async function A4(){return Up({table:"hdb_role",schema:"system",hash_attribute:"id",search_attribute:"id",search_value:"*",get_attributes:["*"]})}a(A4,"listRoles")});var nL=T((tle,sL)=>{"use strict";var O4=X(),Qn=require("joi"),N4=ke(),tL=require("moment"),b4=require("fs-extra"),vp=require("path"),y4=require("lodash"),Pc=y(),{LOG_LEVELS:vi}=y(),I4="YYYY-MM-DD hh:mm:ss",w4=vp.resolve(__dirname,"../logs");sL.exports=function(e){return N4.validateBySchema(e,C4)};var C4=Qn.object({from:Qn.custom(rL),until:Qn.custom(rL),level:Qn.valid(vi.NOTIFY,vi.FATAL,vi.ERROR,vi.WARN,vi.INFO,vi.DEBUG,vi.TRACE),order:Qn.valid("asc","desc"),limit:Qn.number().min(1),start:Qn.number().min(0),log_name:Qn.custom(L4)});function rL(e,t){if(tL(e,tL.ISO_8601).format(I4)==="Invalid date")return t.message(`'${t.state.path[0]}' date '${e}' is invalid.`)}a(rL,"validateDatetime");function L4(e,t){if(y4.invert(Pc.LOG_NAMES)[e]===void 0)return t.message(`'log_name' '${e}' is invalid.`);let s=O4.get(Pc.HDB_SETTINGS_NAMES.LOG_PATH_KEY),n=e===void 0?Pc.LOG_NAMES.HDB:e,i=n===Pc.LOG_NAMES.INSTALL?vp.join(w4,Pc.LOG_NAMES.INSTALL):vp.join(s,n);return b4.existsSync(i)?null:t.message(`'log_name' '${e}' does not exist.`)}a(L4,"validateReadLogPath")});var Hp=T((sle,oL)=>{"use strict";var G_=y(),D4=G(),U4=X(),M4=nL(),Bp=require("path"),iL=require("fs-extra"),{once:P4}=require("events"),{handleHDBError:v4,hdb_errors:B4}=j(),{PACKAGE_ROOT:H4}=y(),q4=Bp.join(H4,"logs"),F4=1e3,G4=200;oL.exports=x4;async function x4(e){let t=M4(e);if(t)throw v4(t,t.message,B4.HTTP_STATUS_CODES.BAD_REQUEST,void 0,void 0,!0);let r=U4.get(G_.HDB_SETTINGS_NAMES.LOG_PATH_KEY),s=e.log_name===void 0?G_.LOG_NAMES.HDB:e.log_name,n=s===G_.LOG_NAMES.INSTALL?Bp.join(q4,G_.LOG_NAMES.INSTALL):Bp.join(r,s),i=e.level!==void 0,o=i?e.level:void 0,c=e.from!==void 0,u=c?new Date(e.from):void 0,_=e.until!==void 0,l=_?new Date(e.until):void 0,d=e.limit===void 0?F4:e.limit,f=e.order===void 0?void 0:e.order,E=e.start===void 0?0:e.start,h=E+d,S=0;f==="desc"&&!u&&!l&&(S=Math.max(iL.statSync(n).size-(h+5)*G4,0));let p=iL.createReadStream(n,{start:S});p.on("error",F=>{D4.error(F)});let g=0,b=[],O="",Y;p.on("data",F=>{let w=/(?:^|\n)(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:[\d\.]+Z) \[(.+?)]: /g;F=O+F;let K=0,B;for(;(B=w.exec(F))&&!p.destroyed;){Y&&(Y.message=F.slice(K,B.index),W(Y));let[x,te,be]=B,se=be.split("] ["),vt=se[0],Pe=se[1];se.splice(0,2),Y={timestamp:te,thread:vt,level:Pe,tags:se,message:""},K=B.index+x.length}O=F.slice(K)}),p.on("end",F=>{p.destroyed||Y&&(Y.message=O.trim(),W(Y))}),p.resume();function W(F){let w,K,B;switch(!0){case(i&&c&&_):w=new Date(F.timestamp),K=new Date(u),B=new Date(l),F.level===o&&w>=K&&w<=B&&g<E?g++:F.level===o&&w>=K&&w<=B&&(zn(F,f,b),g++,g===h&&p.destroy());break;case(i&&c):w=new Date(F.timestamp),K=new Date(u),F.level===o&&w>=K&&g<E?g++:F.level===o&&w>=K&&(zn(F,f,b),g++,g===h&&p.destroy());break;case(i&&_):w=new Date(F.timestamp),B=new Date(l),F.level===o&&w<=B&&g<E?g++:F.level===o&&w<=B&&(zn(F,f,b),g++,g===h&&p.destroy());break;case(c&&_):w=new Date(F.timestamp),K=new Date(u),B=new Date(l),w>=K&&w<=B&&g<E?g++:w>=K&&w<=B&&(zn(F,f,b),g++,g===h&&p.destroy());break;case i:F.level===o&&g<E?g++:F.level===o&&(zn(F,f,b),g++,g===h&&p.destroy());break;case c:w=new Date(F.timestamp),K=new Date(u),w>=K&&g<E?g++:w>=K&&g>=E&&(zn(F,f,b),g++,g===h&&p.destroy());break;case _:w=new Date(F.timestamp),B=new Date(l),w<=B&&g<E?g++:w<=B&&g>=E&&(zn(F,f,b),g++,g===h&&p.destroy());break;default:g<E?g++:(zn(F,f,b),g++,g===h&&p.destroy())}}return a(W,"onLogMessage"),await P4(p,"close"),b}a(x4,"readLog");function zn(e,t,r){t==="desc"?k4(e,r):t==="asc"?V4(e,r):r.push(e)}a(zn,"pushLineToResult");function k4(e,t){let r=new Date(e.timestamp),s=0,n=t.length;for(;s<n;){let i=s+n>>>1;new Date(t[i].timestamp)>r?s=i+1:n=i}t.splice(s,0,e)}a(k4,"insertDescending");function V4(e,t){let r=new Date(e.timestamp),s=0,n=t.length;for(;s<n;){let i=s+n>>>1;new Date(t[i].timestamp)<r?s=i+1:n=i}t.splice(s,0,e)}a(V4,"insertAscending")});var k_=T((cle,lL)=>{"use strict";var qp=require("joi"),{string:x_,boolean:aL,date:$4}=qp.types(),Y4=ke(),{validateSchemaExists:ile,validateTableExists:ole,validateSchemaName:ale}=Ds(),K4=y(),W4=Ve(),cL=X();cL.initSync();var Q4=x_.invalid(cL.get(K4.CONFIG_PARAMS.CLUSTERING_NODENAME)).pattern(W4.NATS_TERM_CONSTRAINTS_RX).messages({"string.pattern.base":"{:#label} invalid, must not contain ., * or >","any.invalid":"'node_name' cannot be this nodes name"}).empty(null).required(),uL={operation:x_.valid("add_node","update_node"),node_name:Q4,subscriptions:qp.array().items({table:x_.optional(),schema:x_.required(),subscribe:aL.required(),publish:aL.required().custom(J4),start_time:$4.iso()}).min(1).required()};function z4(e){return Y4.validateBySchema(e,qp.object(uL))}a(z4,"addUpdateNodeValidator");function J4(e,t){if(t.state.ancestors[2].operation==="add_node"&&e===!1&&t.state.ancestors[0].subscribe===!1)return t.message(`'subscriptions[${t.state.path[1]}]' subscribe and/or publish must be set to true when adding a node`)}a(J4,"checkForFalsy");lL.exports={addUpdateNodeValidator:z4,validation_schema:uL}});var dL=T((lle,_L)=>{var X4=ke(),j4={user:{presence:!0},schema:{presence:!0},table:{presence:!0},operation:{presence:!0}};_L.exports=function(e){return X4.validateObject(e,j4)}});var Gp=T((_le,fL)=>{"use strict";var Z4=y().OPERATIONS_ENUM,Fp=class{static{a(this,"UpdateObject")}constructor(t,r,s,n=void 0){this.operation=Z4.UPDATE,this.schema=t,this.table=r,this.records=s,this.__origin=n}};fL.exports=Fp});var hL=T((fle,EL)=>{"use strict";var e3={OPERATION:"operation",REFRESH:"refresh"},xp=class{static{a(this,"JWTTokens")}constructor(t,r){this.operation_token=t,this.refresh_token=r}},kp=class{static{a(this,"JWTRSAKeys")}constructor(t,r,s){this.public_key=t,this.private_key=r,this.passphrase=s}};EL.exports={JWTTokens:xp,TOKEN_TYPE_ENUM:e3,JWTRSAKeys:kp}});var Hc=T((hle,TL)=>{"use strict";var Bc=require("jsonwebtoken"),Vp=require("fs-extra"),$p=$(),Vr=y(),{handleHDBError:tr,hdb_errors:t3}=j(),{HTTP_STATUS_CODES:rr,AUTHENTICATION_ERROR_MSGS:sr}=t3,vc=G(),mL=Jl(),Wp=Gr(),r3=Fr().update,s3=Gp(),n3=cn(),{UserEventMsg:i3}=us(),Jn=X();Jn.initSync();var Yp=require("path"),{JWTTokens:o3,JWTRSAKeys:a3,TOKEN_TYPE_ENUM:V_}=hL(),c3=Jn.get(Vr.HDB_SETTINGS_NAMES.OPERATION_TOKEN_TIMEOUT_KEY)?Jn.get(Vr.HDB_SETTINGS_NAMES.OPERATION_TOKEN_TIMEOUT_KEY):"1d",u3=Jn.get(Vr.HDB_SETTINGS_NAMES.REFRESH_TOKEN_TIMEOUT_KEY)?Jn.get(Vr.HDB_SETTINGS_NAMES.REFRESH_TOKEN_TIMEOUT_KEY):"30d",$_="RS256",Kp;TL.exports={createTokens:l3,validateOperationToken:d3,refreshOperationToken:_3,validateRefreshToken:SL};async function l3(e){if($p.isEmpty(e)||typeof e!="object")throw tr(new Error,sr.INVALID_AUTH_OBJECT,rr.BAD_REQUEST,void 0,void 0,!0);if($p.isEmpty(e.username))throw tr(new Error,sr.USERNAME_REQUIRED,rr.BAD_REQUEST,void 0,void 0,!0);if($p.isEmpty(e.password))throw tr(new Error,sr.PASSWORD_REQUIRED,rr.BAD_REQUEST,void 0,void 0,!0);let t;try{if(t=await Wp.findAndValidateUser(e.username,e.password),!t)throw tr(new Error,sr.INVALID_CREDENTIALS,rr.UNAUTHORIZED,void 0,void 0,!0)}catch(f){throw vc.error(f),tr(new Error,sr.INVALID_CREDENTIALS,rr.UNAUTHORIZED,void 0,void 0,!0)}let r=await Y_(),s=!1,n=!1;t.role&&t.role.permission&&(s=t.role.permission.super_user===!0,n=t.role.permission.cluster_user===!0);let i={username:e.username,super_user:s,cluster_user:n},o=await pL(i,r.private_key,r.passphrase),c=await Bc.sign(i,{key:r.private_key,passphrase:r.passphrase},{expiresIn:u3,algorithm:$_,subject:V_.REFRESH}),u=mL.hash(c),_=new s3(Vr.SYSTEM_SCHEMA_NAME,Vr.SYSTEM_TABLE_NAMES.USER_TABLE_NAME,[{username:e.username,refresh_token:u}]),l,d;try{l=await r3(_)}catch(f){vc.error(f),d=f}if(d!==void 0||l.skipped_hashes.length>0)throw tr(new Error,sr.REFRESH_TOKEN_SAVE_FAILED,rr.INTERNAL_SERVER_ERROR);return n3.signalUserChange(new i3(process.pid)),new o3(o,c)}a(l3,"createTokens");async function pL(e,t,r){return await Bc.sign(e,{key:t,passphrase:r},{expiresIn:c3,algorithm:$_,subject:V_.OPERATION})}a(pL,"signOperationToken");async function Y_(){if(Kp===void 0)try{let e=Yp.join(Jn.getHdbBasePath(),Vr.LICENSE_KEY_DIR_NAME,Vr.JWT_ENUM.JWT_PASSPHRASE_NAME),t=Yp.join(Jn.getHdbBasePath(),Vr.LICENSE_KEY_DIR_NAME,Vr.JWT_ENUM.JWT_PRIVATE_KEY_NAME),r=Yp.join(Jn.getHdbBasePath(),Vr.LICENSE_KEY_DIR_NAME,Vr.JWT_ENUM.JWT_PUBLIC_KEY_NAME),s=(await Vp.readFile(e)).toString(),n=(await Vp.readFile(t)).toString(),i=(await Vp.readFile(r)).toString();Kp=new a3(i,n,s)}catch(e){throw vc.error(e),tr(new Error,sr.NO_ENCRYPTION_KEYS,rr.INTERNAL_SERVER_ERROR)}return Kp}a(Y_,"getJWTRSAKeys");async function _3(e){if(!e)throw tr(new Error,sr.INVALID_BODY,rr.BAD_REQUEST,void 0,void 0,!0);if(!e.refresh_token)throw tr(new Error,sr.REFRESH_TOKEN_REQUIRED,rr.BAD_REQUEST,void 0,void 0,!0);await SL(e.refresh_token);let t=await Y_(),r=await Bc.decode(e.refresh_token);return{operation_token:await pL({username:r.username,super_user:r.super_user,cluster_user:r.cluster_user},t.private_key,t.passphrase)}}a(_3,"refreshOperationToken");async function d3(e){try{let t=await Y_(),r=await Bc.verify(e,t.public_key,{algorithms:$_,subject:V_.OPERATION});return await Wp.findAndValidateUser(r.username,void 0,!1)}catch(t){throw vc.warn(t),t.name&&t.name==="TokenExpiredError"?tr(new Error,sr.TOKEN_EXPIRED,rr.FORBIDDEN):tr(new Error,sr.INVALID_TOKEN,rr.UNAUTHORIZED)}}a(d3,"validateOperationToken");async function SL(e){let t;try{let r=await Y_(),s=await Bc.verify(e,r.public_key,{algorithms:$_,subject:V_.REFRESH});t=await Wp.findAndValidateUser(s.username,void 0,!1)}catch(r){throw vc.warn(r),r.name&&r.name==="TokenExpiredError"?tr(new Error,sr.TOKEN_EXPIRED,rr.FORBIDDEN):tr(new Error,sr.INVALID_TOKEN,rr.UNAUTHORIZED)}if(!mL.validate(t.refresh_token,e))throw tr(new Error,sr.INVALID_TOKEN,rr.UNAUTHORIZED);return t}a(SL,"validateRefreshToken")});var Qp=T((Sle,AL)=>{"use strict";var f3=dL(),Fo=require("passport"),E3=require("passport-local").Strategy,h3=require("passport-http").BasicStrategy,m3=require("util"),p3=Gr(),RL=m3.callbackify(p3.findAndValidateUser),ple=fr(),S3=y(),gL=Hc();Fo.use(new E3(function(e,t,r){RL(e,t,r)}));Fo.use(new h3(function(e,t,r){RL(e,t,r)}));Fo.serializeUser(function(e,t){t(null,e)});Fo.deserializeUser(function(e,t){t(null,e)});function T3(e,t,r){if(e.raw?.user!==void 0)return r(null,e.raw.user);let s,n;if(e.headers?.authorization){let o=e.headers.authorization.split(" ");s=o[0],n=o[1]}function i(o,c){return o?r(o):c?r(null,c):r("Must login")}switch(a(i,"handleResponse"),s){case"Basic":Fo.authenticate("basic",{session:!1},(o,c)=>{i(o,c)})(e,t,r);break;case"Bearer":e.body?.operation&&e.body.operation===S3.OPERATIONS_ENUM.REFRESH_OPERATION_TOKEN?gL.validateRefreshToken(n).then(o=>{e.body.refresh_token=n,r(null,o)}).catch(o=>{r(o)}):gL.validateOperationToken(n).then(o=>{r(null,o)}).catch(o=>{r(o)});break;default:Fo.authenticate("local",{session:!1},function(o,c){i(o,c)})(e,t,r);break}}a(T3,"authorize");function g3(e,t){let r=f3(e);if(r){t(r);return}let s={authorized:!0,messages:[]},n=e.user.role;if(!n?.permission)return t("Invalid role");let i=JSON.parse(n.permission);if(i.super_user)return t(null,s);if(!i[e.schema])return s.authorized=!1,s.messages.push(`Not authorized to access ${e.schema} schema`),t(null,s);if(!i[e.schema].tables[e.table])return s.authorized=!1,s.messages.push(`Not authorized to access ${e.table} table`),t(null,s);if(!i[e.schema].tables[e.table][e.operation])return s.authorized=!1,s.messages.push(`Not authorized to access ${e.operation} on ${e.table} table`),t(null,s);if(i[e.schema].tables[e.table].attribute_permissions&&!e.attributes)return s.authorized=!1,s.messages.push(`${e.schema}.${e.table} has attribute permissions. Missing attributes to validate`),t(null,s);if(i[e.schema].tables[e.table].attribute_permissions&&e.attributes){let o=i[e.schema].tables[e.table].attribute_permissions;for(let c in o)e.attributes.indexOf(o[c].attribute_name)>-1&&!o[c][e.operation]&&(s.authorized=!1,s.messages.push(`Not authorized to ${e.operation} ${o[c].attribute_name} `))}return t(null,s)}a(g3,"checkPermissions");AL.exports={authorize:T3,checkPermissions:g3}});var Go=T((gle,OL)=>{"use strict";var zp=class{static{a(this,"Node")}constructor(t,r,s){this.name=t,this.subscriptions=r,this.system_info=s}},Jp=class{static{a(this,"NodeSubscription")}constructor(t,r,s,n){this.schema=t,this.table=r,this.publish=s,this.subscribe=n}};OL.exports={Node:zp,NodeSubscription:Jp}});var bL=T((Ale,NL)=>{"use strict";var R3=y().OPERATIONS_ENUM,Xp=class{static{a(this,"UpsertObject")}constructor(t,r,s,n=void 0){this.operation=R3.UPSERT,this.schema=t,this.table=r,this.records=s,this.__origin=n}};NL.exports=Xp});var qc=T((Nle,yL)=>{"use strict";var jp=class{static{a(this,"RemotePayloadObject")}constructor(t,r,s,n){this.operation=t,this.node_name=r,this.subscriptions=s,this.system_info=n}},Zp=class{static{a(this,"RemotePayloadSubscription")}constructor(t,r,s,n,i,o,c){this.schema=t,this.table=r,this.hash_attribute=s,this.publish=n,this.subscribe=i,this.start_time=o,c!==void 0&&(this.attributes=c)}};yL.exports={RemotePayloadObject:jp,RemotePayloadSubscription:Zp}});var wL=T((yle,IL)=>{"use strict";var eS=class{static{a(this,"TableSizeObject")}constructor(t,r,s=0,n=0,i=0,o=0){this.schema=t,this.table=r,this.table_size=s,this.record_count=n,this.transaction_log_size=i,this.transaction_log_record_count=o}};IL.exports=eS});var DL=T((Dle,LL)=>{"use strict";var A3=wL(),wle=ze(),CL=De(),O3=G(),{getSchemaPath:Cle,getTransactionAuditStorePath:Lle}=ve(),{getDatabases:N3}=(fe(),Z(Ce));LL.exports=b3;async function b3(e){let t=new A3;try{let r=N3()[e.schema]?.[e.name],s=r.primaryStore.getStats(),n=r.auditStore?.getStats(),i=await CL.environmentDataSize(schema_path,e.name),o=await CL.environmentDataSize(txn_path,e.name);t.schema=e.schema,t.table=e.name,t.table_size=i,t.record_count=s.entryCount,t.transaction_log_size=o,t.transaction_log_record_count=n.entryCount}catch(r){O3.warn(`unable to stat table dbi due to ${r}`)}return t}a(b3,"lmdbGetTableSize")});var ML=T((Mle,UL)=>{"use strict";var tS=class{static{a(this,"SystemInformationObject")}constructor(t,r,s,n,i,o,c){this.system=t,this.time=r,this.cpu=s,this.memory=n,this.disk=i,this.network=o,this.harperdb_processes=c}};UL.exports=tS});var xo=T((Hle,HL)=>{"use strict";var y3=require("fs-extra"),I3=require("path"),xt=require("systeminformation"),Xn=G(),w3=_t(),rS=Ve(),W_=y(),C3=DL(),BL=gi(),{getThreadInfo:PL}=Je(),dS=X();dS.initSync();var L3=ML(),{openEnvironment:vle}=De(),{getSchemaPath:Ble}=ve(),{database:D3}=(fe(),Z(Ce)),K_;HL.exports={getHDBProcessInfo:oS,getNetworkInfo:cS,getDiskInfo:aS,getMemoryInfo:iS,getCPUInfo:nS,getTimeInfo:sS,getSystemInformation:uS,systemInformation:U3,getTableSize:lS,getMetrics:_S};function sS(){return xt.time()}a(sS,"getTimeInfo");async function nS(){try{let{family:e,model:t,stepping:r,revision:s,voltage:n,speedmin:i,speedmax:o,governor:c,socket:u,cache:_,...l}=await xt.cpu();l.cpu_speed=await xt.cpuCurrentSpeed();let{raw_currentload:d,raw_currentload_idle:f,raw_currentload_irq:E,raw_currentload_nice:h,raw_currentload_system:S,raw_currentload_user:p,cpus:g,...b}=await xt.currentLoad();return b.cpus=[],g.forEach(O=>{let{raw_load:Y,raw_load_idle:W,raw_load_irq:F,raw_load_nice:w,raw_load_system:K,raw_load_user:B,...x}=O;b.cpus.push(x)}),l.current_load=b,l}catch(e){return Xn.error(`error in getCPUInfo: ${e}`),{}}}a(nS,"getCPUInfo");async function iS(){try{let{buffers:e,cached:t,slab:r,buffcache:s,...n}=await xt.mem();return Object.assign(n,process.memoryUsage())}catch(e){return Xn.error(`error in getMemoryInfo: ${e}`),{}}}a(iS,"getMemoryInfo");async function oS(){let e={core:[],clustering:[]};try{let t=await xt.processes(),r;try{r=Number.parseInt(await y3.readFile(I3.join(dS.get(W_.CONFIG_PARAMS.ROOTPATH),W_.HDB_PID_FILE),"utf8"))}catch(s){if(s.code===W_.NODE_ERROR_CODES.ENOENT)Xn.error("Unable to locate 'hdb.pid' file, try stopping and starting HarperDB");else throw s}t.list.forEach(s=>{s.pid===r?e.core.push(s):s.name==="nats-server"&&e.clustering.push(s)});for(let s of e.core)for(let n of t.list)n.pid===s.parentPid&&(n.name==="PM2"||n.command==="PM2")&&(s.parent="PM2");return e}catch(t){return Xn.error(`error in getHDBProcessInfo: ${t}`),e}}a(oS,"getHDBProcessInfo");async function aS(){let e={};try{let{rIO_sec:t,wIO_sec:r,tIO_sec:s,ms:n,...i}=await xt.disksIO();e.io=i;let{rx_sec:o,tx_sec:c,wx_sec:u,..._}=await xt.fsStats();return e.read_write=_,e.size=await xt.fsSize(),e}catch(t){return Xn.error(`error in getDiskInfo: ${t}`),e}}a(aS,"getDiskInfo");async function cS(){let e={default_interface:null,latency:{},interfaces:[],stats:[],connections:[]};try{return e.default_interface=await xt.networkInterfaceDefault(),e.latency=await xt.inetChecksite("google.com"),(await xt.networkInterfaces()).forEach(s=>{let{internal:n,virtual:i,mtu:o,dhcp:c,dnsSuffix:u,ieee8021xAuth:_,ieee8021xState:l,carrier_changes:d,...f}=s;e.interfaces.push(f)}),(await xt.networkStats()).forEach(s=>{let{rx_sec:n,tx_sec:i,ms:o,...c}=s;e.stats.push(c)}),e}catch(t){return Xn.error(`error in getNetworkInfo: ${t}`),e}}a(cS,"getNetworkInfo");async function uS(){if(K_!==void 0)return K_;let e={};try{let{codepage:t,logofile:r,serial:s,build:n,servicepack:i,uefi:o,...c}=await xt.osInfo();e=c;let u=await xt.versions("node, npm");return e.node_version=u.node,e.npm_version=u.npm,K_=e,K_}catch(t){return Xn.error(`error in getSystemInformation: ${t}`),e}}a(uS,"getSystemInformation");async function lS(){let e=[],t=await BL.describeAll();for(let r of Object.values(t))for(let s of Object.values(r))e.push(await C3(s));return e}a(lS,"getTableSize");async function _S(){let e=await BL.describeAll(),t={};for(let r in e){let s=t[r]={};for(let n in e[r])try{let i=D3({database:r,table:n}),o=i.getStats();o.readers=i.readerList().split(/\n\s+/).slice(1).map(c=>{let[u,_,l]=c.trim().split(" ");return{pid:u,thread:_,txnid:l}}),s[n]=o}catch(i){Xn.notify(`Error getting stats for table ${n}: ${i}`)}}return t}a(_S,"getMetrics");async function vL(){if(dS.get(W_.CONFIG_PARAMS.CLUSTERING_ENABLED)){let{js:e,jsm:t}=await w3.getNATSReferences(),r=await t.streams.info(rS.WORK_QUEUE_CONSUMER_NAMES.stream_name),s=await e.consumers.get(rS.WORK_QUEUE_CONSUMER_NAMES.stream_name,rS.WORK_QUEUE_CONSUMER_NAMES.durable_name),n={ingest:{stream:{...r.state},consumer:{num_ack_pending:s._info.num_ack_pending,num_redelivered:s._info.num_redelivered,num_waiting:s._info.num_waiting,num_pending:s._info.num_pending}}};return r.config?.sources&&(n.ingest.stream.sources=r.config.sources),n}}a(vL,"getNatsStreamInfo");async function U3(e){let t=new L3;if(!Array.isArray(e.attributes)||e.attributes.length===0)return t.system=await uS(),t.time=sS(),t.cpu=await nS(),t.memory=await iS(),t.disk=await aS(),t.network=await cS(),t.harperdb_processes=await oS(),t.table_size=await lS(),t.metrics=await _S(),t.threads=await PL(),t.replication=await vL(),t;for(let r=0;r<e.attributes.length;r++)switch(e.attributes[r]){case"system":t.system=await uS();break;case"time":t.time=sS();break;case"cpu":t.cpu=await nS();break;case"memory":t.memory=await iS();break;case"disk":t.disk=await aS();break;case"network":t.network=await cS();break;case"harperdb_processes":t.harperdb_processes=await oS();break;case"table_size":t.table_size=await lS();break;case"database_metrics":case"metrics":t.metrics=await _S();break;case"threads":t.threads=await PL();break;case"replication":t.replication=await vL();break;default:break}return t}a(U3,"systemInformation")});var fS=T((Fle,qL)=>{"use strict";qL.exports={version:M3,printVersion:P3};var Q_=Oc();function M3(){if(Q_)return Q_.version}a(M3,"version");function P3(){Q_&&console.log(`HarperDB Version ${Q_.version}`)}a(P3,"printVersion")});var dn=T((Vle,kL)=>{"use strict";var v3=Fr(),ES=$(),B3=require("util"),Bi=y(),FL=X();FL.initSync();var H3=Qp(),GL=qr(),{Node:xle,NodeSubscription:kle}=Go(),q3=yo(),F3=bL(),{RemotePayloadObject:G3,RemotePayloadSubscription:x3}=qc(),{handleHDBError:k3,hdb_errors:V3}=j(),{HTTP_STATUS_CODES:$3,HDB_ERROR_MSGS:Y3}=V3,K3=Bs(),W3=xo(),Q3=fS(),{getDatabases:z3}=(fe(),Z(Ce)),J3=B3.promisify(H3.authorize),X3=GL.searchByHash,j3=GL.searchByValue;kL.exports={authHeaderToUser:Z3,isEmpty:eX,getNodeRecord:tX,upsertNodeRecord:rX,buildNodePayloads:sX,checkClusteringEnabled:nX,getAllNodeRecords:iX,getSystemInfo:oX,reverseSubscription:xL};async function Z3(e){let t={headers:{authorization:e.hdb_auth_header}};return e.hdb_user=await J3(t,null),e}a(Z3,"authHeaderToUser");function eX(e){return e==null}a(eX,"isEmpty");async function tX(e){let t=new q3(Bi.SYSTEM_SCHEMA_NAME,Bi.SYSTEM_TABLE_NAMES.NODE_TABLE_NAME,[e],["*"]);return X3(t)}a(tX,"getNodeRecord");async function rX(e){let t=new F3(Bi.SYSTEM_SCHEMA_NAME,Bi.SYSTEM_TABLE_NAMES.NODE_TABLE_NAME,[e]);return v3.upsert(t)}a(rX,"upsertNodeRecord");function xL(e){if(ES.isEmpty(e.subscribe)||ES.isEmpty(e.publish))throw new Error("Received invalid subscription object");let{schema:t,table:r,hash_attribute:s}=e,n={schema:t,table:r,hash_attribute:s};return e.subscribe===!0&&e.publish===!1?(n.subscribe=!1,n.publish=!0):e.subscribe===!1&&e.publish===!0?(n.subscribe=!0,n.publish=!1):(n.subscribe=e.subscribe,n.publish=e.publish),n}a(xL,"reverseSubscription");function sX(e,t,r,s){let n=[];for(let i=0,o=e.length;i<o;i++){let c=e[i],{schema:u,table:_}=c,l=ES.getTableHashAttribute(u,_),{subscribe:d,publish:f}=xL(c),E=z3()[u]?.[_],h=new x3(u,_,l,f,d,c.start_time,E.schemaDefined?E.attributes:void 0);n.push(h)}return new G3(r,t,n,s)}a(sX,"buildNodePayloads");function nX(){if(!FL.get(Bi.CONFIG_PARAMS.CLUSTERING_ENABLED))throw k3(new Error,Y3.CLUSTERING_NOT_ENABLED,$3.BAD_REQUEST,void 0,void 0,!0)}a(nX,"checkClusteringEnabled");async function iX(){let e=new K3(Bi.SYSTEM_SCHEMA_NAME,Bi.SYSTEM_TABLE_NAMES.NODE_TABLE_NAME,"name","*",void 0,["*"]);return Array.from(await j3(e))}a(iX,"getAllNodeRecords");async function oX(){let e=await W3.getSystemInformation();return{hdb_version:Q3.version(),node_version:e.node_version,platform:e.platform}}a(oX,"getSystemInfo")});var hS=T((Yle,JL)=>{"use strict";var z_=_t(),VL=$(),$L=Ve(),YL=y(),J_=G(),KL=v_(),aX=vm(),{RemotePayloadObject:cX}=qc(),{handleHDBError:WL,hdb_errors:uX}=j(),{HTTP_STATUS_CODES:QL}=uX,{NodeSubscription:zL}=Go();JL.exports=lX;async function lX(e,t){let r;try{r=await z_.request(`${t}.${$L.REQUEST_SUFFIX}`,new cX(YL.OPERATIONS_ENUM.DESCRIBE_ALL,t,void 0,void 0)),J_.trace("Response from remote describe all request:",r)}catch(o){J_.error(`addNode received error from describe all request to remote node: ${o}`);let c=z_.requestErrorHandler(o,"add_node",t);throw WL(new Error,c,QL.INTERNAL_SERVER_ERROR,"error",c)}if(r.status===$L.UPDATE_REMOTE_RESPONSE_STATUSES.ERROR){let o=`Error returned from remote node ${t}: ${r.message}`;throw WL(new Error,o,QL.INTERNAL_SERVER_ERROR,"error",o)}let s=r.message,n=[],i=[];for(let o of e){let{schema:c,table:u}=o;if(c===YL.SYSTEM_SCHEMA_NAME){await z_.createLocalTableStream(c,u);let h=new zL(c,u,o.publish,o.subscribe);h.start_time=o.start_time,i.push(h);continue}let _=VL.doesSchemaExist(c),l=s[c]!==void 0,d=u?VL.doesTableExist(c,u):!0,f=u?s?.[c]?.[u]!==void 0:!0;if(!_&&!l||!d&&!f){n.push(o);continue}if(!_&&l&&(J_.trace(`addNode creating schema: ${c}`),await KL.createSchema({operation:"create_schema",schema:c})),!d&&f){J_.trace(`addNode creating table: ${u} in schema: ${c} with attributes ${JSON.stringify(s[c][u].attributes)}`);let h=new aX(c,u,s[c][u].hash_attribute);s[c][u].attributes&&(h.attributes=s[c][u].attributes),await KL.createTable(h)}await z_.createLocalTableStream(c,u);let E=new zL(c,u,o.publish,o.subscribe);E.start_time=o.start_time,i.push(E)}return{added:i,skipped:n}}a(lX,"reviewSubscriptions")});var Z_=T((Wle,ZL)=>{"use strict";var{handleHDBError:X_,hdb_errors:_X}=j(),{HTTP_STATUS_CODES:j_}=_X,{addUpdateNodeValidator:dX}=k_(),Fc=G(),jL=y(),XL=Ve(),fX=$(),mS=_t(),Gc=dn(),EX=X(),hX=hS(),{Node:mX,NodeSubscription:pX}=Go(),{broadcast:SX}=Je(),TX="Unable to create subscriptions due to schema and/or tables not existing on the local or remote node",gX="Some subscriptions were unsuccessful due to schema and/or tables not existing on the local or remote node",RX=EX.get(jL.CONFIG_PARAMS.CLUSTERING_NODENAME);ZL.exports=AX;async function AX(e,t=!1){Fc.trace("addNode called with:",e),Gc.checkClusteringEnabled();let r=dX(e);if(r)throw X_(r,r.message,j_.BAD_REQUEST,void 0,void 0,!0);let s=e.node_name;if(!t){let d=await Gc.getNodeRecord(s);if(!fX.isEmptyOrZeroLength(d))throw X_(new Error,`Node '${s}' has already been added, perform update_node to proceed.`,j_.BAD_REQUEST,void 0,void 0,!0)}let{added:n,skipped:i}=await hX(e.subscriptions,s),o={message:void 0,added:n,skipped:i};if(n.length===0)return o.message=TX,o;let c=Gc.buildNodePayloads(n,RX,jL.OPERATIONS_ENUM.ADD_NODE,await Gc.getSystemInfo());Fc.trace("addNode sending remote payload:",c);let u;try{u=await mS.request(`${s}.${XL.REQUEST_SUFFIX}`,c)}catch(d){Fc.error(`addNode received error from request: ${d}`);let f=mS.requestErrorHandler(d,"add_node",s);throw X_(new Error,f,j_.INTERNAL_SERVER_ERROR,"error",f)}if(u.status===XL.UPDATE_REMOTE_RESPONSE_STATUSES.ERROR){let d=`Error returned from remote node ${s}: ${u.message}`;throw X_(new Error,d,j_.INTERNAL_SERVER_ERROR,"error",d)}Fc.trace(u);let _=[];for(let d=0,f=n.length;d<f;d++){let E=n[d];Fc.trace("Add node updating work stream for node:",s,"subscriptions:",E),await mS.updateWorkStream(E,s),n[d].start_time===void 0&&delete n[d].start_time,_.push(new pX(E.schema,E.table,E.publish,E.subscribe))}let l=new mX(s,_,u.system_info);return await Gc.upsertNodeRecord(l),SX({type:"nats_update"}),i.length>0?o.message=gX:o.message=`Successfully added '${s}' to manifest`,o}a(AX,"addNode")});var SS=T((zle,rD)=>{"use strict";var{handleHDBError:ed,hdb_errors:OX}=j(),{HTTP_STATUS_CODES:td}=OX,{addUpdateNodeValidator:NX}=k_(),xc=G(),tD=y(),eD=Ve(),bX=$(),pS=_t(),kc=dn(),yX=X(),{cloneDeep:IX}=require("lodash"),wX=hS(),{NodeSubscription:CX}=Go(),{broadcast:LX}=Je(),DX="Unable to update subscriptions due to schema and/or tables not existing on the local or remote node",UX="Some subscriptions were unsuccessful due to schema and/or tables not existing on the local or remote node",MX=yX.get(tD.CONFIG_PARAMS.CLUSTERING_NODENAME);rD.exports=PX;async function PX(e){xc.trace("updateNode called with:",e),kc.checkClusteringEnabled();let t=NX(e);if(t)throw ed(t,t.message,td.BAD_REQUEST,void 0,void 0,!0);let r=e.node_name,s=IX(await kc.getNodeRecord(r));if(bX.isEmptyOrZeroLength(s))throw ed(new Error,`Node '${r}' has not been added, perform add_node to proceed.`,td.BAD_REQUEST,void 0,void 0,!0);let{added:n,skipped:i}=await wX(e.subscriptions,r),o={message:void 0,updated:n,skipped:i};if(n.length===0)return o.message=DX,o;let c=kc.buildNodePayloads(n,MX,tD.OPERATIONS_ENUM.UPDATE_NODE,await kc.getSystemInfo());xc.trace("updateNode sending remote payload:",c);let u;try{u=await pS.request(`${r}.${eD.REQUEST_SUFFIX}`,c)}catch(_){xc.error(`updateNode received error from request: ${_}`);let l=pS.requestErrorHandler(_,"update_node",r);throw ed(new Error,l,td.INTERNAL_SERVER_ERROR,"error",l)}if(u.status===eD.UPDATE_REMOTE_RESPONSE_STATUSES.ERROR){let _=`Error returned from remote node ${r}: ${u.message}`;throw ed(new Error,_,td.INTERNAL_SERVER_ERROR,"error",_)}xc.trace(u);for(let _=0,l=n.length;_<l;_++){let d=n[_];xc.trace(`updateNode updating work stream for node: ${r} subscription:`,d),await pS.updateWorkStream(d,r),n[_].start_time===void 0&&delete n[_].start_time}return await vX(s[0],n,u.system_info),i.length>0?o.message=UX:o.message=`Successfully updated '${r}'`,o}a(PX,"updateNode");async function vX(e,t,r){let s=e;for(let n=0,i=t.length;n<i;n++){let o=t[n],c=!1;for(let u=0,_=e.subscriptions.length;u<_;u++){let l=s.subscriptions[u];if(l.schema===o.schema&&l.table===o.table){l.publish=o.publish,l.subscribe=o.subscribe,c=!0;break}}c||s.subscriptions.push(new CX(o.schema,o.table,o.publish,o.subscribe))}s.system_info=r,await kc.upsertNodeRecord(s),LX({type:"nats_update"})}a(vX,"updateNodeTable")});var aD=T((Xle,oD)=>{"use strict";var iD=require("joi"),{string:sD}=iD.types(),BX=ke(),nD=y(),HX=X(),qX=Ve();oD.exports=FX;function FX(e){let t=sD.invalid(HX.get(nD.CONFIG_PARAMS.CLUSTERING_NODENAME)).pattern(qX.NATS_TERM_CONSTRAINTS_RX).messages({"string.pattern.base":"{:#label} invalid, must not contain ., * or >","any.invalid":"'node_name' cannot be this nodes name"}).empty(null),r=iD.object({operation:sD.valid(nD.OPERATIONS_ENUM.REMOVE_NODE).required(),node_name:t});return BX.validateBySchema(e,r)}a(FX,"removeNodeValidator")});var sd=T((Zle,fD)=>{"use strict";var{handleHDBError:cD,hdb_errors:GX}=j(),{HTTP_STATUS_CODES:uD}=GX,xX=aD(),Vc=G(),lD=dn(),kX=$(),rd=y(),_D=Ve(),dD=_t(),VX=X(),{RemotePayloadObject:$X}=qc(),{NodeSubscription:YX}=Go(),KX=hc(),WX=bi(),{broadcast:QX}=Je(),zX=VX.get(rd.CONFIG_PARAMS.CLUSTERING_NODENAME);fD.exports=JX;async function JX(e){Vc.trace("removeNode called with:",e),lD.checkClusteringEnabled();let t=xX(e);if(t)throw cD(t,t.message,uD.BAD_REQUEST,void 0,void 0,!0);let r=e.node_name,s=await lD.getNodeRecord(r);if(kX.isEmptyOrZeroLength(s))throw cD(new Error,`Node '${r}' was not found.`,uD.BAD_REQUEST,void 0,void 0,!0);s=s[0];let n=new $X(rd.OPERATIONS_ENUM.REMOVE_NODE,zX,[]),i,o=!1;try{i=await dD.request(`${r}.${_D.REQUEST_SUFFIX}`,n),Vc.trace("Remove node reply from remote node:",r,i)}catch(u){Vc.error("removeNode received error from request:",u),o=!0}for(let u=0,_=s.subscriptions.length;u<_;u++){let l=s.subscriptions[u];Vc.trace(`Remove node removing subscription: ${l.schema}.${l.table} for node: ${r}`);let d=new YX(l.schema,l.table,!1,!1);await dD.updateWorkStream(d,r)}let c=new KX(rd.SYSTEM_SCHEMA_NAME,rd.SYSTEM_TABLE_NAMES.NODE_TABLE_NAME,[r]);return await WX.deleteRecord(c),QX({type:"nats_update"}),i?.status===_D.UPDATE_REMOTE_RESPONSE_STATUSES.ERROR||o?(Vc.error("Error returned from remote node:",r,i?.message),`Successfully removed '${r}' from local manifest, however there was an error reaching remote node. Check the logs for more details.`):`Successfully removed '${r}' from manifest`}a(JX,"removeNode")});var mD=T((t_e,hD)=>{"use strict";var ED=require("joi"),{string:XX,array:jX}=ED.types(),ZX=ke(),ej=k_();hD.exports=tj;function tj(e){let t=ED.object({operation:XX.valid("configure_cluster").required(),connections:jX.items(ej.validation_schema).required()});return ZX.validateBySchema(e,t)}a(tj,"configureClusterValidator")});var TS=T((s_e,RD)=>{"use strict";var rj=y(),nd=G(),sj=$(),nj=sd(),ij=Z_(),pD=dn(),oj=mD(),{handleHDBError:SD,hdb_errors:aj}=j(),{HTTP_STATUS_CODES:TD}=aj,cj="Configure cluster complete.",uj="Failed to configure the cluster. Check the logs for more details.",lj="Configure cluster was partially successful. Errors occurred when attempting to configure the following nodes. Check the logs for more details.";RD.exports=_j;async function _j(e){nd.trace("configure cluster called with:",e),pD.checkClusteringEnabled();let t=oj(e);if(t)throw SD(t,t.message,TD.BAD_REQUEST,void 0,void 0,!0);let r=await pD.getAllNodeRecords(),s=[];for(let f=0,E=r.length;f<E;f++)s.push(gD(nj,{operation:rj.OPERATIONS_ENUM.REMOVE_NODE,node_name:r[f].name},r[f].name));let n=await Promise.allSettled(s);nd.trace("All results from configure_cluster remove node:",n);let i=[],o=e.connections.length;for(let f=0;f<o;f++){let E=e.connections[f];i.push(gD(ij,E,E.node_name))}let c=await Promise.allSettled(i);nd.trace("All results from configure_cluster add node:",c);let u=[],_=[],l=!1,d=n.concat(c);for(let f=0,E=d.length;f<E;f++){let h=d[f];h.status==="rejected"&&(nd.error(h.reason),u.includes(h.reason.node_name)||u.push(h.reason.node_name)),h.status==="fulfilled"&&(l=!0);let S=h?.value?.result;typeof S=="string"&&S.includes("Successfully removed")||h.status==="rejected"||_.push({node_name:h?.value?.node_name,subscriptions:h?.value?.result})}if(sj.isEmptyOrZeroLength(u))return{message:cj,connections:_};if(l)return{message:lj,failed_nodes:u,connections:_};throw SD(new Error,uj,TD.INTERNAL_SERVER_ERROR,void 0,void 0,!0)}a(_j,"configureCluster");async function gD(e,t,r){try{return{node_name:r,result:await e(t)}}catch(s){throw{node_name:r,error:s}}}a(gD,"functionWrapper")});var OD=T((i_e,AD)=>{"use strict";var id=require("joi"),dj=ke(),{validateSchemaExists:fj,validateTableExists:Ej,validateSchemaName:hj}=Ds(),mj=id.object({operation:id.string().valid("purge_stream"),schema:id.string().custom(fj).custom(hj).required(),table:id.string().custom(Ej).required()});function pj(e){return dj.validateBySchema(e,mj)}a(pj,"purgeStreamValidator");AD.exports=pj});var gS=T((a_e,ND)=>{"use strict";var{handleHDBError:Sj,hdb_errors:Tj}=j(),{HTTP_STATUS_CODES:gj}=Tj,Rj=OD(),Aj=_t(),Oj=dn();ND.exports=Nj;async function Nj(e){let t=Rj(e);if(t)throw Sj(t,t.message,gj.BAD_REQUEST,void 0,void 0,!0);Oj.checkClusteringEnabled();let{schema:r,table:s}=e;return await Aj.purgeTableStream(r,s),`Successfully purged table '${r}.${s}'`}a(Nj,"purgeStream")});var OS=T((u_e,LD)=>{"use strict";var AS=dn(),bj=_t(),ID=X(),od=y(),Hi=Ve(),yj=$(),RS=G(),{RemotePayloadObject:Ij}=qc(),{ErrorCode:bD}=require("nats"),yD=ID.get(od.CONFIG_PARAMS.CLUSTERING_ENABLED),wD=ID.get(od.CONFIG_PARAMS.CLUSTERING_NODENAME);LD.exports={clusterStatus:wj,buildNodeStatus:CD};async function wj(){let e={node_name:wD,is_enabled:yD,connections:[]};if(!yD)return e;let t=await AS.getAllNodeRecords();if(yj.isEmptyOrZeroLength(t))return e;let r=[];for(let s=0,n=t.length;s<n;s++)r.push(CD(t[s],e.connections));return await Promise.allSettled(r),e}a(wj,"clusterStatus");async function CD(e,t){let r=e.name,s=new Ij(od.OPERATIONS_ENUM.CLUSTER_STATUS,wD,void 0,await AS.getSystemInfo()),n,i,o=Hi.CLUSTER_STATUS_STATUSES.OPEN;try{let u=Date.now();n=await bj.request(Hi.REQUEST_SUBJECT(r),s),i=Date.now()-u,n.status===Hi.UPDATE_REMOTE_RESPONSE_STATUSES.ERROR&&(o=Hi.CLUSTER_STATUS_STATUSES.CLOSED,RS.error(`Error getting node status from ${r} `,n))}catch(u){RS.warn(`Error getting node status from ${r}`,u),u.code===bD.NoResponders?o=Hi.CLUSTER_STATUS_STATUSES.NO_RESPONDERS:u.code===bD.Timeout?o=Hi.CLUSTER_STATUS_STATUSES.TIMEOUT:o=Hi.CLUSTER_STATUS_STATUSES.CLOSED}let c=new Cj(r,o,n?.message?.ports?.clustering,n?.message?.ports?.operations_api,i,n?.message?.uptime,e.subscriptions,n?.message?.system_info);try{let u={name:r,system_info:n?.message?.system_info};e.system_info?.hdb_version!==od.PRE_4_0_0_VERSION&&await AS.upsertNodeRecord(u)}catch(u){RS.error("Cluster status encountered an error updating system info for node:",r,u)}t.push(c)}a(CD,"buildNodeStatus");function Cj(e,t,r,s,n,i,o,c){this.node_name=e,this.status=t,this.ports={clustering:r,operations_api:s},this.latency_ms=n,this.uptime=i,this.subscriptions=o,this.system_info=c}a(Cj,"NodeStatusObject")});var bS=T((__e,DD)=>{"use strict";var{handleHDBError:Lj,hdb_errors:Dj}=j(),{HTTP_STATUS_CODES:Uj}=Dj,Mj=_t(),Pj=dn(),NS=$(),ad=require("joi"),vj=ke(),Bj=2e3,Hj=ad.object({timeout:ad.number().min(1),connected_nodes:ad.boolean(),routes:ad.boolean()});DD.exports=qj;async function qj(e){Pj.checkClusteringEnabled();let t=vj.validateBySchema(e,Hj);if(t)throw Lj(t,t.message,Uj.BAD_REQUEST,void 0,void 0,!0);let{timeout:r,connected_nodes:s,routes:n}=e,i=s===void 0||NS.autoCastBoolean(s),o=n===void 0||NS.autoCastBoolean(n),c={nodes:[]},u=await Mj.getServerList(r??Bj),_={};if(i)for(let l=0,d=u.length;l<d;l++){let f=u[l].statsz;f&&(_[u[l].server.name]=f.routes)}for(let l=0,d=u.length;l<d;l++){if(u[l].statsz)continue;let f=u[l].server,E=u[l].data;if(f.name.endsWith("-hub")){let h={name:f.name.slice(0,-4),response_time:u[l].response_time};i&&(h.connected_nodes=[],_[f.name]&&_[f.name].forEach(S=>{h.connected_nodes.includes(S.name.slice(0,-4))||h.connected_nodes.push(S.name.slice(0,-4))})),o&&(h.routes=E.cluster?.urls?E.cluster?.urls.map(S=>({host:S.split(":")[0],port:NS.autoCast(S.split(":")[1])})):[]),c.nodes.push(h)}}return c}a(qj,"clusterNetwork")});var vD=T((f_e,PD)=>{"use strict";var yS=require("joi"),UD=ke(),{route_constraints:MD}=zh();PD.exports={setRoutesValidator:Fj,deleteRoutesValidator:Gj};function Fj(e){let t=yS.object({server:yS.valid("hub","leaf").required(),routes:MD.required()});return UD.validateBySchema(e,t)}a(Fj,"setRoutesValidator");function Gj(e){let t=yS.object({routes:MD.required()});return UD.validateBySchema(e,t)}a(Gj,"deleteRoutesValidator")});var wS=T((h_e,FD)=>{"use strict";var qi=gr(),IS=$(),cd=y(),BD=vD(),{handleHDBError:HD,hdb_errors:xj}=j(),{HTTP_STATUS_CODES:qD}=xj,kj="cluster routes successfully set",Vj="cluster routes successfully deleted";FD.exports={setRoutes:$j,getRoutes:Yj,deleteRoutes:Kj};function $j(e){let t=BD.setRoutesValidator(e);if(t)throw HD(t,t.message,qD.BAD_REQUEST,void 0,void 0,!0);let r=qi.getClusteringRoutes(),s=e.server==="hub"?r.hub_routes:r.leaf_routes,n=e.server==="hub"?r.leaf_routes:r.hub_routes,i=[],o=[];for(let c=0,u=e.routes.length;c<u;c++){let _=e.routes[c];_.port=IS.autoCast(_.port);let l=s.some(f=>f.host===_.host&&f.port===_.port),d=n.some(f=>f.host===_.host&&f.port===_.port);l||d?i.push(_):(s.push(_),o.push(_))}return e.server==="hub"?qi.updateConfigValue(cd.CONFIG_PARAMS.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_ROUTES,s):qi.updateConfigValue(cd.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_NETWORK_ROUTES,s),{message:kj,set:o,skipped:i}}a($j,"setRoutes");function Yj(){let e=qi.getClusteringRoutes();return{hub:e.hub_routes,leaf:e.leaf_routes}}a(Yj,"getRoutes");function Kj(e){let t=BD.deleteRoutesValidator(e);if(t)throw HD(t,t.message,qD.BAD_REQUEST,void 0,void 0,!0);let r=qi.getClusteringRoutes(),s=r.hub_routes,n=r.leaf_routes,i=[],o=[],c=!1,u=!1;for(let _=0,l=e.routes.length;_<l;_++){let d=e.routes[_],f=!1;for(let E=0,h=s.length;E<h;E++){let S=s[E];if(d.host===S.host&&d.port===S.port){s.splice(E,1),f=!0,c=!0,i.push(d);break}}if(!f){let E=!0;for(let h=0,S=n.length;h<S;h++){let p=n[h];if(d.host===p.host&&d.port===p.port){n.splice(h,1),u=!0,E=!1,i.push(d);break}}E&&o.push(d)}}return c&&(s=IS.isEmptyOrZeroLength(s)?null:s,qi.updateConfigValue(cd.CONFIG_PARAMS.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_ROUTES,s)),u&&(n=IS.isEmptyOrZeroLength(n)?null:n,qi.updateConfigValue(cd.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_NETWORK_ROUTES,n)),{message:Vj,deleted:i,skipped:o}}a(Kj,"deleteRoutes")});var xD=T((p_e,GD)=>{"use strict";var $c=require("alasql"),Fi=require("recursive-iterator"),ms=G(),Wj=$(),Yc=y(),CS=class{static{a(this,"sql_statement_bucket")}constructor(t){this.ast=t,this.affected_attributes=new Map,this.table_lookup=new Map,this.schema_lookup=new Map,this.table_to_schema_lookup=new Map,zj(this.ast,this.affected_attributes,this.table_lookup,this.schema_lookup,this.table_to_schema_lookup)}getAttributesBySchemaTableName(t,r){if(!t||!r||!this.affected_attributes)return[];if(this.affected_attributes.has(t))return!this.affected_attributes.get(t).has(r)&&(r=this.table_lookup.get(r),!r)?[]:this.affected_attributes.get(t).get(r)}getAllTables(){let t=[];if(!this.affected_attributes)return t;for(let r of this.affected_attributes.keys())t.push(Array.from(this.affected_attributes.get(r).keys()));return t}getTablesBySchemaName(t){return!t||!this.affected_attributes?[]:Array.from(this.affected_attributes.get(t).keys())}getSchemas(){return this.affected_attributes?Array.from(this.affected_attributes.keys()):[]}getAst(){return this.ast}updateAttributeWildcardsForRolePerms(t){let r=this.ast.columns.filter(n=>Yc.SEARCH_WILDCARDS.includes(n.columnid));if(r.length===0)return this.ast;let s=this.ast.from[0].databaseid;return this.ast.columns=this.ast.columns.filter(n=>!Yc.SEARCH_WILDCARDS.includes(n.columnid)),r.forEach(n=>{let i=this.table_to_schema_lookup.has(n.tableid)?this.table_to_schema_lookup.get(n.tableid):s,o=this.table_lookup.has(n.tableid)?this.table_lookup.get(n.tableid):this.ast.from[0].tableid;if(t[i]&&t[i].tables[o]&&t[i].tables[o][Yc.PERMS_CRUD_ENUM.READ]){let c;t[i].tables[o].attribute_permissions.length>0?c=Qj(t[i].tables[o].attribute_permissions):c=global.hdb_schema[i][o].attributes.map(_=>({attribute_name:_.attribute}));let u=this.affected_attributes.get(i).get(o).filter(_=>!Yc.SEARCH_WILDCARDS.includes(_));c.forEach(({attribute_name:_})=>{let l=new $c.yy.Column({columnid:_});n.tableid&&(l.tableid=n.tableid),this.ast.columns.push(l),u.includes(_)||u.push(_)}),this.affected_attributes.get(i).set(o,u)}}),this.ast}};function Qj(e){return e.filter(t=>t[Yc.PERMS_CRUD_ENUM.READ])}a(Qj,"filterReadRestrictedAttrs");function zj(e,t,r,s,n){Jj(e,t,r,s,n)}a(zj,"interpretAST");function Kc(e,t,r,s,n){if(!(!e||!e.databaseid)&&(t.has(e.databaseid)||t.set(e.databaseid,new Map),t.get(e.databaseid).has(e.tableid)||t.get(e.databaseid).set(e.tableid,[]),e.as&&(r.has(e.as)||r.set(e.as,e.tableid),s&&!s.has(e.as)&&s.set(e.as,e.databaseid)),n)){let i=e.databaseid,o=e.tableid;e.as&&(o=e.as),n.set(o,i)}}a(Kc,"addSchemaTableToMap");function Jj(e,t,r,s,n){if(!e){ms.info("getRecordAttributesAST: invalid SQL syntax tree");return}e instanceof $c.yy.Insert?eZ(e,t,r):e instanceof $c.yy.Select?Xj(e,t,r,s,n):e instanceof $c.yy.Update?jj(e,t,r):e instanceof $c.yy.Delete?Zj(e,t,r):ms.error("AST in getRecordAttributesAST() is not a valid SQL type.")}a(Jj,"getRecordAttributesAST");function Xj(e,t,r,s,n){if(!e){ms.info("getSelectAttributes: invalid SQL syntax tree");return}if(!e.from||e.from[0]===void 0)return;let i=e.from[0].databaseid;if(Wj.isEmptyOrZeroLength(i)){ms.error("No schema specified");return}e.from.forEach(c=>{Kc(c,t,r,s,n)}),e.joins&&e.joins.forEach(c=>{c.as&&(c.table.as=c.as),Kc(c.table,t,r,s,n)});let o=new Fi(e.columns);for(let{node:c}of o)if(c&&c.columnid){let u=c.tableid,_=s.has(u)?s.get(u):i;if(u||(u=e.from[0].tableid),!t.get(_).has(u))if(r.has(u))u=r.get(u);else{ms.info(`table specified as ${u} not found.`);return}t.get(_).get(u).indexOf(c.columnid)<0&&t.get(_).get(u).push(c.columnid)}if(e.where){let c=new Fi(e.where),u=e.from[0].tableid;for(let{node:_}of c)if(_&&_.columnid){let l=_.tableid?_.tableid:u;if(!t.get(i).has(l))if(r.has(l))l=r.get(l);else{ms.info(`table specified as ${l} not found.`);continue}t.get(i).get(l).indexOf(_.columnid)<0&&t.get(i).get(l).push(_.columnid)}}if(e.joins&&e.joins.forEach(c=>{let u=new Fi(c.on);for(let{node:_}of u)if(_&&_.columnid){let l=_.tableid,d=n.get(l);if(!t.get(d).has(l))if(r.has(l))l=r.get(l);else{ms.info(`table specified as ${l} not found.`);continue}t.get(d).get(l).indexOf(_.columnid)<0&&t.get(d).get(l).push(_.columnid)}}),e.order){let c=new Fi(e.order);for(let{node:u}of c)if(u&&u.columnid){let _=u.tableid,l=s.has(_)?s.get(_):i;if(_||(_=e.from[0].tableid),!t.get(l).has(_))if(r.has(_))_=r.get(_);else{ms.info(`table specified as ${_} not found.`);return}t.get(l).get(_).indexOf(u.columnid)<0&&t.get(l).get(_).push(u.columnid)}}}a(Xj,"getSelectAttributes");function jj(e,t,r){if(!e){ms.info("getUpdateAttributes: invalid SQL syntax tree");return}let s=new Fi(e.columns),n=e.table.databaseid;Kc(e.table,t,r);for(let{node:i}of s)i&&i.columnid&&LS(e.table.tableid,n,i.columnid,t,r)}a(jj,"getUpdateAttributes");function Zj(e,t,r){if(!e){ms.info("getDeleteAttributes: invalid SQL syntax tree");return}let s=new Fi(e.where),n=e.table.databaseid;Kc(e.table,t,r);for(let{node:i}of s)i&&i.columnid&&LS(e.table.tableid,n,i.columnid,t,r)}a(Zj,"getDeleteAttributes");function eZ(e,t,r){if(!e){ms.info("getInsertAttributes: invalid SQL syntax tree");return}let s=new Fi(e.columns),n=e.into.databaseid;Kc(e.into,t,r);for(let{node:i}of s)i&&i.columnid&&LS(e.into.tableid,n,i.columnid,t,r)}a(eZ,"getInsertAttributes");function LS(e,t,r,s,n){if(!s.get(t))return;let i=e;s.get(t).has(i)||(i=n.get(i)),s.get(t).get(i).push(r)}a(LS,"pushAttribute");GD.exports=CS});var MS=T((T_e,YD)=>{var ud=ic(),kD=require("chalk"),yr=G(),VD=require("prompt"),{promisify:tZ}=require("util"),DS=y(),rZ=require("fs-extra"),sZ=require("path"),nZ=$(),iZ=fS(),$D=X();$D.initSync();var oZ=require("moment"),aZ=tZ(VD.get),cZ=sZ.join($D.getHdbBasePath(),DS.LICENSE_KEY_DIR_NAME,DS.LICENSE_FILE_NAME,DS.LICENSE_FILE_NAME);YD.exports={getFingerprint:lZ,setLicense:uZ,parseLicense:US,register:_Z,getRegistrationInfo:fZ};async function uZ(e){if(e&&e.key&&e.company){try{yr.info(`parsing license key: ${e.key} and `);let t=e.company.toString();await US(e.key.trim(),t.trim())}catch(t){let r="There was an error parsing the license key.";throw yr.error(r),yr.error(t),new Error(r)}return"Wrote license key file.  Registration successful."}throw new Error("Invalid key or company specified for license file.")}a(uZ,"setLicense");async function lZ(){let e={};try{e=await ud.generateFingerPrint()}catch(t){let r="Error generating fingerprint.";throw yr.error(r),yr.error(t),new Error(r)}return e}a(lZ,"getFingerprint");async function US(e,t){if(!e||!t)throw new Error("Invalid entries for License Key and Customer Company");yr.info("Validating license input...");let r=ud.validateLicense(e,t);if(yr.info("checking for valid license..."),!r.valid_license)throw new Error("Invalid license found.");if(yr.info("checking valid license date..."),!r.valid_date)throw new Error("This License has expired.");if(yr.info(`checking for valid machine license ${r.valid_machine}`),!r.valid_machine)throw new Error("This license is in use on another machine.");try{yr.info("writing license to disk"),await rZ.writeFile(cZ,JSON.stringify({license_key:e,company:t}))}catch(s){throw yr.error("Failed to write License"),s}return"Registration successful."}a(US,"parseLicense");async function _Z(){let e=await dZ();return US(e.HDB_LICENSE,e.CUSTOMER_COMPANY)}a(_Z,"register");async function dZ(){let e=await ud.generateFingerPrint(),t={properties:{CUSTOMER_COMPANY:{description:kD.magenta("[COMPANY] Please enter your company name"),required:!0},HDB_LICENSE:{description:kD.magenta(`[HDB_LICENSE] Your fingerprint is ${e} Please enter your license key`),required:!0}}};try{VD.start()}catch(s){yr.error(s)}let r;try{r=await aZ(t)}catch(s){throw console.error("There was a problem prompting for registration input.  Exiting."),s}return r}a(dZ,"promptForRegistration");async function fZ(){let e={registered:!1,version:null,ram_allocation:null,license_expiration_date:null},t;try{t=await ud.getLicense()}catch(r){throw yr.error(`There was an error when searching licenses due to: ${r.message}`),r}if(nZ.isEmptyOrZeroLength(t))throw new Error("There were no licenses found.");if(e.registered=t.enterprise,e.version=iZ.version(),e.ram_allocation=t.ram_allocation,isNaN(t.exp_date))e.license_expiration_date=t.enterprise?t.exp_date:null;else{let r=oZ.utc(t.exp_date).format("YYYY-MM-DD");e.license_expiration_date=t.enterprise?r:null}return e}a(fZ,"getRegistrationInfo")});var WD=T((R_e,KD)=>{"use strict";var EZ=Ve(),PS=class{static{a(this,"HubConfigObject")}constructor(t,r,s,n,i,o,c,u,_,l,d,f,E,h){this.port=t,o===null&&(o=void 0),this.server_name=r+EZ.SERVER_SUFFIX.HUB,this.pid_file=s,this.max_payload=67108864,this.jetstream={enabled:!1},this.tls={cert_file:n,key_file:i,ca_file:o,insecure:c,verify:u},this.leafnodes={port:_,tls:{cert_file:n,key_file:i,ca_file:o,insecure:c}},this.cluster={name:l,port:d,routes:f,tls:{cert_file:n,key_file:i,ca_file:o,insecure:c,verify:u}},this.accounts={SYS:{users:E},HDB:{users:h}},this.system_account="SYS"}};KD.exports=PS});var JD=T((O_e,zD)=>{"use strict";var QD=Ve(),vS=class{static{a(this,"LeafConfigObject")}constructor(t,r,s,n,i,o,c,u,_,l,d){this.port=t,d===null&&(d=void 0),this.server_name=r+QD.SERVER_SUFFIX.LEAF,this.pid_file=s,this.max_payload=67108864,this.jetstream={enabled:!0,store_dir:n,domain:r+QD.SERVER_SUFFIX.LEAF},this.tls={cert_file:_,key_file:l,ca_file:d,insecure:!0},this.leafnodes={remotes:[{tls:{ca_file:d,insecure:!0},urls:i,account:"SYS"},{tls:{ca_file:d,insecure:!0},urls:o,account:"HDB"}]},this.accounts={SYS:{users:c},HDB:{users:u,jetstream:"enabled"}},this.system_account="SYS"}};zD.exports=vS});var jD=T((b_e,XD)=>{"use strict";var BS=class{static{a(this,"HdbUserObject")}constructor(t,r){this.user=t,this.password=r}};XD.exports=BS});var eU=T((I_e,ZD)=>{"use strict";var hZ=Ve(),HS=class{static{a(this,"SysUserObject")}constructor(t,r){this.user=t+hZ.SERVER_SUFFIX.ADMIN,this.password=r}};ZD.exports=HS});var GS=T((C_e,sU)=>{"use strict";var ko=require("path"),dd=require("fs-extra"),mZ=WD(),pZ=JD(),SZ=jD(),TZ=eU(),qS=Gr(),$o=$(),nr=gr(),_d=y(),Wc=Ve(),{CONFIG_PARAMS:Ze}=_d,Qc=G(),zc=X(),tU=nn(),FS=_t(),Vo="clustering",gZ=1e4,rU=5;sU.exports={generateNatsConfig:AZ,removeNatsConfig:OZ,getHubConfigPath:RZ};function RZ(){let e=zc.get(Ze.ROOTPATH);return ko.join(e,Vo,Wc.NATS_CONFIG_FILES.HUB_SERVER)}a(RZ,"getHubConfigPath");async function AZ(e=!1,t=void 0){zc.initSync();let r=zc.get(Ze.ROOTPATH),s=ko.join(r,Vo,Wc.PID_FILES.HUB),n=ko.join(r,Vo,Wc.PID_FILES.LEAF),i=nr.getConfigFromFile(Ze.CLUSTERING_LEAFSERVER_STREAMS_PATH),o=ko.join(r,Vo,Wc.NATS_CONFIG_FILES.HUB_SERVER),c=ko.join(r,Vo,Wc.NATS_CONFIG_FILES.LEAF_SERVER),u=nr.getConfigFromFile(Ze.CLUSTERING_TLS_CERTIFICATE),_=nr.getConfigFromFile(Ze.CLUSTERING_TLS_PRIVATEKEY),l=nr.getConfigFromFile(Ze.CLUSTERING_TLS_CERT_AUTH),d=nr.getConfigFromFile(Ze.CLUSTERING_TLS_INSECURE),f=nr.getConfigFromFile(Ze.CLUSTERING_TLS_VERIFY),E=nr.getConfigFromFile(Ze.CLUSTERING_NODENAME),h=nr.getConfigFromFile(Ze.CLUSTERING_HUBSERVER_LEAFNODES_NETWORK_PORT);await FS.checkNATSServerInstalled()||fd("nats-server dependency is either missing or the wrong version. Run 'npm install' to fix");let S=await qS.listUsers(),p=nr.getConfigFromFile(Ze.CLUSTERING_USER),g=await qS.getClusterUser();($o.isEmpty(g)||g.active!==!0)&&fd(`Invalid cluster user '${p}'. A valid user with the role 'cluster_user' must be defined under clustering.user in harperdb-config.yaml`),e||(await ld(Ze.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_PORT),await ld(Ze.CLUSTERING_HUBSERVER_LEAFNODES_NETWORK_PORT),await ld(Ze.CLUSTERING_HUBSERVER_NETWORK_PORT),await ld(Ze.CLUSTERING_LEAFSERVER_NETWORK_PORT));let b=[],O=[];for(let[x,te]of S.entries())te.role.role===_d.ROLE_TYPES_ENUM.CLUSTER_USER&&te.active&&(b.push(new TZ(te.username,tU.decrypt(te.hash))),O.push(new SZ(te.username,tU.decrypt(te.hash))));let Y=[],{hub_routes:W}=nr.getClusteringRoutes();if(!$o.isEmptyOrZeroLength(W))for(let x of W)Y.push(`tls://${g.sys_name_encoded}:${g.uri_encoded_d_hash}@${x.host}:${x.port}`);let F=new mZ(nr.getConfigFromFile(Ze.CLUSTERING_HUBSERVER_NETWORK_PORT),E,s,u,_,l,d,f,h,nr.getConfigFromFile(Ze.CLUSTERING_HUBSERVER_CLUSTER_NAME),nr.getConfigFromFile(Ze.CLUSTERING_HUBSERVER_CLUSTER_NETWORK_PORT),Y,b,O);l==null&&(delete F.tls.ca_file,delete F.leafnodes.tls.ca_file),t=$o.isEmpty(t)?void 0:t.toLowerCase(),(t===void 0||t===_d.PROCESS_DESCRIPTORS.CLUSTERING_HUB.toLowerCase())&&(await dd.writeJson(o,F),Qc.trace(`Hub server config written to ${o}`));let w=`tls://${g.sys_name_encoded}:${g.uri_encoded_d_hash}@0.0.0.0:${h}`,K=`tls://${g.uri_encoded_name}:${g.uri_encoded_d_hash}@0.0.0.0:${h}`,B=new pZ(nr.getConfigFromFile(Ze.CLUSTERING_LEAFSERVER_NETWORK_PORT),E,n,i,[w],[K],b,O,u,_,l,d);l==null&&delete B.tls.ca_file,(t===void 0||t===_d.PROCESS_DESCRIPTORS.CLUSTERING_LEAF.toLowerCase())&&(await dd.writeJson(c,B),Qc.trace(`Leaf server config written to ${c}`))}a(AZ,"generateNatsConfig");async function ld(e){let t=zc.get(e);return $o.isEmpty(t)&&fd(`port undefined for '${e}'`),await $o.isPortTaken(t)&&fd(`'${e}' port '${t}' is is in use by another process, check to see if HarperDB is already running or another process is using this port.`),!0}a(ld,"isPortAvailable");function fd(e){let t=`Error generating clustering config: ${e}`;Qc.error(t),console.error(t),process.exit(1)}a(fd,"generateNatsConfigError");async function OZ(e){let{port:t,config_file:r}=FS.getServerConfig(e),{username:s,decrypt_hash:n}=await qS.getClusterUser(),i=0,o=2e3;for(;i<rU;){try{let _=await FS.createConnection(t,s,n,!1);if(_.protocol.connected===!0){_.close();break}}catch(_){Qc.trace(`removeNatsConfig waiting for ${e}. Caught and swallowed error ${_}`)}if(i++,i>=rU)throw new Error(`Operations API timed out attempting to connect to ${e}. This is commonly caused by incorrect clustering config. Check hdb.log for further details.`);await $o.async_set_timeout(o*(i*2))}let c="0".repeat(gZ),u=ko.join(zc.get(Ze.ROOTPATH),Vo,r);await dd.writeFile(u,c),await dd.remove(u),Qc.notify(e,"started.")}a(OZ,"removeNatsConfig")});var uU=T((D_e,cU)=>{"use strict";var Ir=X(),NZ=ic(),ce=y(),Jc=Ve(),fn=require("path"),{PACKAGE_ROOT:hd}=y(),nU=X(),Ed=$(),Yo="/dev/null",bZ=fn.join(hd,"launchServiceScripts"),iU=fn.join(hd,"utility/scripts"),yZ=fn.join(iU,ce.HDB_RESTART_SCRIPT),oU=fn.resolve(hd,"dependencies",`${process.platform}-${process.arch}`,Jc.NATS_BINARY_NAME);function aU(){let t=NZ.licenseSearch().ram_allocation||ce.RAM_ALLOCATION_ENUM.DEFAULT,r=ce.MEM_SETTING_KEY+t,s={[ce.PROCESS_NAME_ENV_PROP]:ce.PROCESS_DESCRIPTORS.HDB,IS_SCRIPTED_SERVICE:!0};return Ed.noBootFile()&&(s[ce.CONFIG_PARAMS.ROOTPATH.toUpperCase()]=Ed.getEnvCliRootPath()),{name:ce.PROCESS_DESCRIPTORS.HDB,script:ce.LAUNCH_SERVICE_SCRIPTS.MAIN,exec_mode:"fork",env:s,node_args:r,cwd:hd}}a(aU,"generateMainServerConfig");var IZ=9930;function wZ(){Ir.initSync(!0);let e=Ir.get(ce.CONFIG_PARAMS.ROOTPATH),t=fn.join(e,"clustering",Jc.NATS_CONFIG_FILES.HUB_SERVER),r=fn.join(Ir.get(ce.HDB_SETTINGS_NAMES.LOG_PATH_KEY),ce.LOG_NAMES.HDB),s=nU.get(ce.CONFIG_PARAMS.CLUSTERING_HUBSERVER_NETWORK_PORT),n=Jc.LOG_LEVEL_FLAGS[Ir.get(ce.CONFIG_PARAMS.CLUSTERING_LOGLEVEL)]??void 0,i={name:ce.PROCESS_DESCRIPTORS.CLUSTERING_HUB+(s!==IZ?"-"+s:""),script:oU,args:n?`${n} -c ${t}`:`-c ${t}`,exec_mode:"fork",env:{[ce.PROCESS_NAME_ENV_PROP]:ce.PROCESS_DESCRIPTORS.CLUSTERING_HUB},merge_logs:!0,out_file:r,error_file:r,instances:1};return Ir.get(ce.HDB_SETTINGS_NAMES.LOG_TO_FILE)||(i.out_file=Yo,i.error_file=Yo),i}a(wZ,"generateNatsHubServerConfig");var CZ=9940;function LZ(){Ir.initSync(!0);let e=Ir.get(ce.CONFIG_PARAMS.ROOTPATH),t=fn.join(e,"clustering",Jc.NATS_CONFIG_FILES.LEAF_SERVER),r=fn.join(Ir.get(ce.HDB_SETTINGS_NAMES.LOG_PATH_KEY),ce.LOG_NAMES.HDB),s=nU.get(ce.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_NETWORK_PORT),n=Jc.LOG_LEVEL_FLAGS[Ir.get(ce.CONFIG_PARAMS.CLUSTERING_LOGLEVEL)]??void 0,i={name:ce.PROCESS_DESCRIPTORS.CLUSTERING_LEAF+(s!==CZ?"-"+s:""),script:oU,args:n?`${n} -c ${t}`:`-c ${t}`,exec_mode:"fork",env:{[ce.PROCESS_NAME_ENV_PROP]:ce.PROCESS_DESCRIPTORS.CLUSTERING_LEAF},merge_logs:!0,out_file:r,error_file:r,instances:1};return Ir.get(ce.HDB_SETTINGS_NAMES.LOG_TO_FILE)||(i.out_file=Yo,i.error_file=Yo),i}a(LZ,"generateNatsLeafServerConfig");function DZ(){Ir.initSync();let e=fn.join(Ir.get(ce.CONFIG_PARAMS.LOGGING_ROOT),ce.LOG_NAMES.HDB),t={name:ce.PROCESS_DESCRIPTORS.CLUSTERING_UPGRADE_4_0_0,script:ce.LAUNCH_SERVICE_SCRIPTS.NODES_UPGRADE_4_0_0,exec_mode:"fork",env:{[ce.PROCESS_NAME_ENV_PROP]:ce.PROCESS_DESCRIPTORS.CLUSTERING_UPGRADE_4_0_0},merge_logs:!0,out_file:e,error_file:e,instances:1,cwd:bZ,autorestart:!1};return Ir.get(ce.HDB_SETTINGS_NAMES.LOG_TO_FILE)||(t.out_file=Yo,t.error_file=Yo),t}a(DZ,"generateClusteringUpgradeV4ServiceConfig");function UZ(){let e={[ce.PROCESS_NAME_ENV_PROP]:ce.PROCESS_DESCRIPTORS.RESTART_HDB};return Ed.noBootFile()&&(e[ce.CONFIG_PARAMS.ROOTPATH.toUpperCase()]=Ed.getEnvCliRootPath()),{...{name:ce.PROCESS_DESCRIPTORS.RESTART_HDB,exec_mode:"fork",env:e,instances:1,autorestart:!1,cwd:iU},script:yZ}}a(UZ,"generateRestart");function MZ(){return{apps:[aU()]}}a(MZ,"generateAllServiceConfigs");cU.exports={generateAllServiceConfigs:MZ,generateMainServerConfig:aU,generateRestart:UZ,generateNatsHubServerConfig:wZ,generateNatsLeafServerConfig:LZ,generateClusteringUpgradeV4ServiceConfig:DZ}});var OU=T((P_e,AU)=>{"use strict";var Ae=y(),PZ=$(),En=GS(),Xc=_t(),Gs=Ve(),jn=uU(),md=X(),Zn=G(),vZ=dn(),{startWorker:lU,onMessageFromWorkers:BZ}=Je(),HZ=xo(),M_e=require("util"),qZ=require("child_process"),FZ=require("fs"),{execFile:GZ}=qZ,pe;AU.exports={enterPM2Mode:xZ,start:ei,stop:xS,reload:dU,restart:fU,list:kS,describe:hU,connect:hn,kill:KZ,startAllServices:WZ,startService:VS,getUniqueServicesList:mU,restartAllServices:QZ,isServiceRegistered:pU,reloadStopStart:SU,restartHdb:EU,deleteProcess:$Z,startClusteringProcesses:gU,startClusteringThreads:RU,isHdbRestartRunning:YZ,isClusteringRunning:JZ,stopClustering:zZ,reloadClustering:XZ};var jc=!1;BZ(e=>{e.type==="restart"&&md.initSync(!0)});function xZ(){jc=!0}a(xZ,"enterPM2Mode");function hn(){return pe||(pe=require("pm2")),new Promise((e,t)=>{pe.connect((r,s)=>{Zn.setupConsoleLogging(),r&&t(r),e(s)})})}a(hn,"connect");var ir,kZ=10,_U;function ei(e,t=!1){if(jc)return VZ(e);let r=GZ(e.script,e.args.split(" "),e);r.name=e.name,r.on("exit",async i=>{let o=ir.indexOf(r);o>-1&&ir.splice(o,1),!_U&&i!==0&&(e.restarts=(e.restarts||0)+1,e.restarts<kZ&&(FZ.existsSync(En.getHubConfigPath())?ei(e):(await En.generateNatsConfig(!0),ei(e),await new Promise(c=>setTimeout(c,3e3)),await En.removeNatsConfig(Ae.PROCESS_DESCRIPTORS.CLUSTERING_HUB),await En.removeNatsConfig(Ae.PROCESS_DESCRIPTORS.CLUSTERING_LEAF))))});let s={serviceName:e.name.replace(/ /g,"-")};function n(i){let o=md.get(Ae.CONFIG_PARAMS.CLUSTERING_LOGLEVEL),c=/\[\d+][^\[]+\[(\w+)]/g,u,_=0,l;for(;u=c.exec(i);){if(u.index&&Gs.LOG_LEVEL_HIERARCHY[o]>=Gs.LOG_LEVEL_HIERARCHY[l||"info"]){let E=l===Gs.LOG_LEVELS.ERR||l===Gs.LOG_LEVELS.WRN?Zn.OUTPUTS.STDERR:Zn.OUTPUTS.STDOUT;Zn.logCustomLevel(l||"info",E,s,i.slice(_,u.index).trim())}let[d,f]=u;_=u.index+d.length,l=Gs.LOG_LEVELS[f]}if(Gs.LOG_LEVEL_HIERARCHY[o]>=Gs.LOG_LEVEL_HIERARCHY[l||"info"]){let d=l===Gs.LOG_LEVELS.ERR||l===Gs.LOG_LEVELS.WRN?Zn.OUTPUTS.STDERR:Zn.OUTPUTS.STDOUT;Zn.logCustomLevel(l||"info",d,s,i.slice(_).trim())}}if(a(n,"extractMessages"),r.stdout.on("data",n),r.stderr.on("data",n),r.unref(),ir=[],!ir&&!t){let i=a(()=>{_U=!0,ir&&(ir.map(o=>o.kill()),process.exit(0))},"kill_children");process.on("exit",i),process.on("SIGINT",i),process.on("SIGQUIT",i),process.on("SIGTERM",i)}ir.push(r)}a(ei,"start");function VZ(e){return new Promise(async(t,r)=>{try{await hn()}catch(s){r(s)}pe.start(e,(s,n)=>{s&&(pe.disconnect(),r(s)),pe.disconnect(),t(n)})})}a(VZ,"startWithPM2");function xS(e){if(!jc){for(let t of ir||[])t.name===e&&(ir.splice(ir.indexOf(t),1),t.kill());return}return new Promise(async(t,r)=>{try{await hn()}catch(s){r(s)}pe.stop(e,async(s,n)=>{s&&(pe.disconnect(),r(s)),pe.delete(e,(i,o)=>{i&&(pe.disconnect(),r(s)),pe.disconnect(),t(o)})})})}a(xS,"stop");function dU(e){return new Promise(async(t,r)=>{try{await hn()}catch(s){r(s)}pe.reload(e,(s,n)=>{s&&(pe.disconnect(),r(s)),pe.disconnect(),t(n)})})}a(dU,"reload");function fU(e){if(!jc)for(let t of ir||[])t.name===e&&t.kill();return new Promise(async(t,r)=>{try{await hn()}catch(s){r(s)}pe.restart(e,(s,n)=>{pe.disconnect(),t(n)})})}a(fU,"restart");function $Z(e){return new Promise(async(t,r)=>{try{await hn()}catch(s){r(s)}pe.delete(e,(s,n)=>{s&&(pe.disconnect(),r(s)),pe.disconnect(),t(n)})})}a($Z,"deleteProcess");async function EU(){await ei(jn.generateRestart())}a(EU,"restartHdb");async function YZ(){let e=await kS();for(let t in e)if(e[t].name===Ae.PROCESS_DESCRIPTORS.RESTART_HDB)return!0;return!1}a(YZ,"isHdbRestartRunning");function kS(){return new Promise(async(e,t)=>{try{await hn()}catch(r){t(r)}pe.list((r,s)=>{r&&(pe.disconnect(),t(r)),pe.disconnect(),e(s)})})}a(kS,"list");function hU(e){return new Promise(async(t,r)=>{try{await hn()}catch(s){r(s)}pe.describe(e,(s,n)=>{s&&(pe.disconnect(),r(s)),pe.disconnect(),t(n)})})}a(hU,"describe");function KZ(){if(!jc){for(let e of ir||[])e.kill();ir=[];return}return new Promise(async(e,t)=>{try{await hn()}catch(r){t(r)}pe.killDaemon((r,s)=>{r&&(pe.disconnect(),t(r)),pe.disconnect(),e(s)})})}a(KZ,"kill");async function WZ(){try{await gU(),await RU(),await ei(jn.generateAllServiceConfigs())}catch(e){throw pe?.disconnect(),e}}a(WZ,"startAllServices");async function VS(e,t=!1){try{let r;switch(e=e.toLowerCase(),e){case Ae.PROCESS_DESCRIPTORS.HDB.toLowerCase():r=jn.generateMainServerConfig();break;case Ae.PROCESS_DESCRIPTORS.CLUSTERING_INGEST_SERVICE.toLowerCase():r=jn.generateNatsIngestServiceConfig();break;case Ae.PROCESS_DESCRIPTORS.CLUSTERING_REPLY_SERVICE.toLowerCase():r=jn.generateNatsReplyServiceConfig();break;case Ae.PROCESS_DESCRIPTORS.CLUSTERING_HUB.toLowerCase():r=jn.generateNatsHubServerConfig(),await ei(r,t),await En.removeNatsConfig(e);return;case Ae.PROCESS_DESCRIPTORS.CLUSTERING_LEAF.toLowerCase():r=jn.generateNatsLeafServerConfig(),await ei(r,t),await En.removeNatsConfig(e);return;case Ae.PROCESS_DESCRIPTORS.CLUSTERING_UPGRADE_4_0_0.toLowerCase():r=jn.generateClusteringUpgradeV4ServiceConfig();break;default:throw new Error(`Start service called with unknown service config: ${e}`)}await ei(r)}catch(r){throw pe?.disconnect(),r}}a(VS,"startService");async function mU(){try{let e=await kS(),t={};for(let r=0,s=e.length;r<s;r++){let n=e[r];t[n.name]===void 0&&(t[n.name]={name:n.name,exec_mode:n.pm2_env.exec_mode})}return t}catch(e){throw pe?.disconnect(),e}}a(mU,"getUniqueServicesList");async function QZ(e=[]){try{let t=!1,r=await mU();for(let s=0,n=Object.values(r).length;s<n;s++){let o=Object.values(r)[s].name;e.includes(o)||(o===Ae.PROCESS_DESCRIPTORS.HDB?t=!0:await fU(o))}t&&await SU(Ae.PROCESS_DESCRIPTORS.HDB)}catch(t){throw pe?.disconnect(),t}}a(QZ,"restartAllServices");async function pU(e){if(ir?.find(r=>r.name===e))return!0;let t=await HZ.getHDBProcessInfo();return t.core.length&&t.core[0]?.parent==="PM2"}a(pU,"isServiceRegistered");async function SU(e){let t=e===Ae.PROCESS_DESCRIPTORS.HDB?md.get(Ae.HDB_SETTINGS_NAMES.MAX_HDB_PROCESSES):md.get(Ae.HDB_SETTINGS_NAMES.MAX_CUSTOM_FUNCTION_PROCESSES),r=await hU(e),s=PZ.isEmptyOrZeroLength(r)?0:r.length;t!==s?(await xS(e),await VS(e)):e===Ae.PROCESS_DESCRIPTORS.HDB?await EU():await dU(e)}a(SU,"reloadStopStart");var TU;async function gU(e=!1){for(let t in Ae.CLUSTERING_PROCESSES){let r=Ae.CLUSTERING_PROCESSES[t];await VS(r,e)}}a(gU,"startClusteringProcesses");async function RU(){TU=lU(Ae.LAUNCH_SERVICE_SCRIPTS.NATS_REPLY_SERVICE,{name:Ae.PROCESS_DESCRIPTORS.CLUSTERING_REPLY_SERVICE}),await Xc.createWorkQueueStream(Gs.WORK_QUEUE_CONSUMER_NAMES),await Xc.updateIngestStreamConsumer(),await Xc.updateLocalStreams();let e=await vZ.getAllNodeRecords();for(let t=0,r=e.length;t<r;t++)if(e[t].system_info?.hdb_version===Ae.PRE_4_0_0_VERSION){Zn.info("Starting clustering upgrade 4.0.0 process"),lU(Ae.LAUNCH_SERVICE_SCRIPTS.NODES_UPGRADE_4_0_0,{name:"Upgrade-4-0-0"});break}}a(RU,"startClusteringThreads");async function zZ(){for(let e in Ae.CLUSTERING_PROCESSES)if(e!==Ae.CLUSTERING_PROCESSES.CLUSTERING_INGEST_PROC_DESCRIPTOR)if(e===Ae.CLUSTERING_PROCESSES.CLUSTERING_REPLY_SERVICE_DESCRIPTOR)await TU.terminate();else{let t=Ae.CLUSTERING_PROCESSES[e];await xS(t)}}a(zZ,"stopClustering");async function JZ(){for(let e in Ae.CLUSTERING_PROCESSES){let t=Ae.CLUSTERING_PROCESSES[e];if(await pU(t)===!1)return!1}return!0}a(JZ,"isClusteringRunning");async function XZ(){await En.generateNatsConfig(!0),await Xc.reloadNATSHub(),await Xc.reloadNATSLeaf(),await En.removeNatsConfig(Ae.PROCESS_DESCRIPTORS.CLUSTERING_HUB.toLowerCase()),await En.removeNatsConfig(Ae.PROCESS_DESCRIPTORS.CLUSTERING_LEAF.toLowerCase())}a(XZ,"reloadClustering")});var gd=T((B_e,LU)=>{"use strict";var jZ=require("minimist"),{isMainThread:KS,parentPort:yU}=require("worker_threads"),$e=y(),{PROCESS_DESCRIPTORS_VALIDATE:Zc}=$e,xs=G(),WS=$(),pd=GS(),Ko=_t(),$S=Ve(),IU=gr(),ks=OU(),NU=xo(),ZZ=dE(),{restartWorkers:Sd,onMessageByType:e5}=Je(),{handleHDBError:t5,hdb_errors:r5}=j(),{HTTP_STATUS_CODES:s5}=r5,Td=X();Td.initSync();var eu=`Restarting HarperDB. This may take up to ${$e.RESTART_TIMEOUT_MS/1e3} seconds.`,n5="Restart is not available from the CLI when running in non-pm2 mode. Either call restart from the API or stop and start HarperDB.",bU="Clustering is not enabled so cannot be restarted",i5="Invalid service",Wo,$r;LU.exports={restart:wU,restartService:QS};KS&&e5($e.ITC_EVENT_TYPES.RESTART,e=>{e.workerType?QS({service:e.workerType}):wU({operation:"restart"})});async function wU(e){$r=Object.keys(e).length===0,Wo=await ks.isServiceRegistered($e.HDB_PROC_DESCRIPTOR);let t=jZ(process.argv);if(t.service){await QS(t);return}if($r&&!Wo){console.error(n5);return}if($r&&console.log(eu),Wo){ks.enterPM2Mode(),xs.notify(eu);let r=ZZ(Object.keys($e.CONFIG_PARAM_MAP),!0);return WS.isEmptyOrZeroLength(Object.keys(r))||IU.updateConfigValue(void 0,void 0,r,!0,!0),a5(),eu}return KS?(xs.notify(eu),setTimeout(()=>{Sd()},50)):yU.postMessage({type:$e.ITC_EVENT_TYPES.RESTART}),eu}a(wU,"restart");async function QS(e){let{service:t}=e;if($e.PROCESS_DESCRIPTORS_VALIDATE[t]===void 0)throw t5(new Error,i5,s5.BAD_REQUEST,void 0,void 0,!0);if(Wo=await ks.isServiceRegistered($e.HDB_PROC_DESCRIPTOR),!KS)return yU.postMessage({type:$e.ITC_EVENT_TYPES.RESTART,workerType:t}),t==="custom_functions"&&(t="Custom Functions"),`Restarting ${t}`;let r;switch(t){case Zc.clustering:if(!Td.get($e.CONFIG_PARAMS.CLUSTERING_ENABLED)){r=bU;break}$r&&console.log("Restarting clustering"),xs.notify("Restarting clustering"),await CU();break;case Zc.clustering_config:case Zc["clustering config"]:if(!Td.get($e.CONFIG_PARAMS.CLUSTERING_ENABLED)){r=bU;break}$r&&console.log("Restarting clustering_config"),xs.notify("Restarting clustering_config"),await ks.reloadClustering();break;case"custom_functions":case"custom functions":case Zc.harperdb:case Zc.http_workers:if($r&&!Wo){r=`Restart ${t} is not available from the CLI when running in non-pm2 mode. Either call restart ${t} from the API or stop and start HarperDB.`;break}$r&&console.log("Restarting http_workers"),xs.notify("Restarting http_workers"),$r?await ks.restart($e.HDB_PROC_DESCRIPTOR):setTimeout(()=>{Sd("http")},200);break;default:r=`Unrecognized service: ${t}`;break}return r?(xs.error(r),$r&&console.error(r),r):(t==="custom_functions"&&(t="Custom Functions"),`Restarting ${t}`)}a(QS,"restartService");async function o5(){await Ko.publishToStream(`${$S.SUBJECT_PREFIXES.TXN}.${$S.WORK_QUEUE_CONSUMER_NAMES.stream_name}`,$S.WORK_QUEUE_CONSUMER_NAMES.stream_name,Ko.addNatsMsgHeader({operation:"dummy_msg"},void 0),{operation:"dummy_msg"})}a(o5,"postDummyNatsMsg");async function a5(){await CU(),await ks.restart($e.HDB_PROC_DESCRIPTOR),await WS.async_set_timeout(2e3),Td.get($e.CONFIG_PARAMS.CLUSTERING_ENABLED)&&await YS(),$r&&(await Ko.closeConnection(),process.exit(0))}a(a5,"restartPM2Mode");async function CU(){if(!IU.getConfigFromFile($e.CONFIG_PARAMS.CLUSTERING_ENABLED))return;if((await NU.getHDBProcessInfo()).clustering.length===0)xs.trace("Clustering not running, restart will start clustering services"),await pd.generateNatsConfig(!0),await ks.startClusteringProcesses(),await ks.startClusteringThreads(),await YS(),$r&&await Ko.closeConnection();else{await o5(),await pd.generateNatsConfig(!0),Wo?(xs.trace("Restart clustering restarting PM2 managed Hub and Leaf servers"),await ks.restart($e.PROCESS_DESCRIPTORS.CLUSTERING_HUB),await ks.restart($e.PROCESS_DESCRIPTORS.CLUSTERING_LEAF)):(await NU.getHDBProcessInfo()).clustering.forEach(n=>{xs.trace("Restart clustering killing process pid",n.pid),process.kill(n.pid)}),await WS.async_set_timeout(3e3),await YS(),await Ko.updateLocalStreams(),$r&&await Ko.closeConnection(),xs.trace("Restart clustering restarting ingest and reply service threads");let t=Sd($e.LAUNCH_SERVICE_SCRIPTS.NATS_INGEST_SERVICE),r=Sd($e.LAUNCH_SERVICE_SCRIPTS.NATS_REPLY_SERVICE);await t,await r}}a(CU,"restartClustering");async function YS(){await pd.removeNatsConfig($e.PROCESS_DESCRIPTORS.CLUSTERING_HUB),await pd.removeNatsConfig($e.PROCESS_DESCRIPTORS.CLUSTERING_LEAF)}a(YS,"removeNatsConfig")});var xU=T((F_e,GU)=>{"use strict";var q_e=require("lodash"),or=y(),{handleHDBError:DU,hdb_errors:c5}=j(),{HDB_ERROR_MSGS:u5,HTTP_STATUS_CODES:l5}=c5,zS=G();GU.exports={getRolePermissions:d5};var Gi=Object.create(null),_5=a(e=>({key:e,perms:{}}),"perms_template_obj"),vU=a((e=!1)=>({describe:e,tables:{}}),"schema_perms_template"),BU=a((e=!1,t=!1,r=!1,s=!1)=>({[or.PERMS_CRUD_ENUM.READ]:e,[or.PERMS_CRUD_ENUM.INSERT]:t,[or.PERMS_CRUD_ENUM.UPDATE]:r,[or.PERMS_CRUD_ENUM.DELETE]:s}),"permissions_template"),JS=a((e=!1,t=!1,r=!1,s=!1,n=!1)=>({attribute_permissions:[],describe:e,...BU(t,r,s,n)}),"table_perms_template"),UU=a((e,t=BU())=>({attribute_name:e,describe:FU(t),[tu]:t[tu],[XS]:t[XS],[jS]:t[jS]}),"attr_perms_template"),MU=a((e,t=!1)=>({attribute_name:e,describe:t,[tu]:t}),"timestamp_attr_perms_template"),{READ:tu,INSERT:XS,UPDATE:jS}=or.PERMS_CRUD_ENUM,HU=Object.values(or.PERMS_CRUD_ENUM),qU=[tu,XS,jS];function d5(e){let t;try{if(e.permission.super_user||e.permission.cluster_user)return e.permission;let r=Object.assign({},global.hdb_schema);delete r[or.SYSTEM_SCHEMA_NAME],t=e.role;let s=JSON.stringify([e.__updatedtime__,r]);if(Gi[t]&&Gi[t].key===s)return Gi[t].perms;let n=f5(e,r);return Gi[t]?Gi[t].key=s:Gi[t]=_5(s),Gi[t].perms=n,n}catch(r){if(!e[or.TIME_STAMP_NAMES_ENUM.UPDATED_TIME]||e[or.TIME_STAMP_NAMES_ENUM.UPDATED_TIME]<or.PERMS_UPDATE_RELEASE_TIMESTAMP){let s=`Role permissions for role '${t}' must be updated to align with new structure from the 2.2.0 release.`;throw zS.error(s),zS.debug(r),DU(new Error,u5.OUTDATED_PERMS_TRANSLATION_ERROR,l5.BAD_REQUEST)}else{let s=`There was an error while translating role permissions for role: ${t}.
 ${r.stack}`;throw zS.error(s),DU(new Error)}}}a(d5,"getRolePermissions");function f5(e,t){let r=Object.create(null);r.super_user=!1;let s=e.permission;r[or.SYSTEM_SCHEMA_NAME]=s[or.SYSTEM_SCHEMA_NAME],r.structure_user=s.structure_user;let n=Array.isArray(e.permission.structure_user)||e.permission.structure_user===!0?e.permission.structure_user:[];return Object.keys(t).forEach(i=>{if(n===!0||n.indexOf(i)>-1){r[i]=E5(t[i]);return}r[i]=vU(),s[i]?(s[i].describe&&(r[i].describe=!0),Object.keys(t[i]).forEach(o=>{if(s[i].tables[o]){let c=s[i].tables[o],u=t[i][o],_=h5(c,u);r[i].describe||HU.forEach(l=>{_[l]&&(r[i].describe=!0)}),r[i].tables[o]=_}else r[i].tables[o]=JS()})):Object.keys(t[i]).forEach(o=>{r[i].tables[o]=JS()})}),r}a(f5,"translateRolePermissions");function E5(e){let t=vU(!0);return Object.keys(e).forEach(r=>{t.tables[r]=JS(!0,!0,!0,!0,!0)}),t}a(E5,"createStructureUserPermissions");function h5(e,t){let{attribute_permissions:r}=e;if(r.length>0){let n=Object.assign({},e);n.attribute_permissions=[];let i=r.reduce((_,l)=>{let{attribute_name:d}=l,f=l;return or.TIME_STAMP_NAMES.includes(d)&&(f=MU(d,l[tu])),_[d]=f,_},{}),o=t.primaryKey||t.hash_attribute,c=!!i[o],u=UU(o);return t.attributes.forEach(({attribute:_})=>{if(i[_]){let l=i[_];l.describe=FU(l),n.attribute_permissions.push(l),c||m5(l,u)}else if(_!==o){let l;or.TIME_STAMP_NAMES.includes(_)?l=MU(_):l=UU(_),n.attribute_permissions.push(l)}}),c||n.attribute_permissions.push(u),n.describe=PU(n),n}else return e.describe=PU(e),e}a(h5,"getTableAttrPerms");function PU(e){return HU.filter(t=>e[t]).length>0}a(PU,"getSchemaTableDescribePerm");function FU(e){return qU.filter(t=>e[t]).length>0}a(FU,"getAttributeDescribePerm");function m5(e,t){qU.forEach(r=>{e[r]&&!t[r]&&(t[r]=!0,t.describe=!0)})}a(m5,"checkForHashPerms")});var kU={};qe(kU,{Resources:()=>Rd,keyArrayToString:()=>Qo,resetResources:()=>p5,resources:()=>ti});function p5(){return ti=new Rd}function Qo(e){return Array.isArray(e)?e[e.length-1]===null?e.slice(0,-1).join("/")+"/":e.join("/"):e}var Rd,ti,ru=Te(()=>{Ei();Rd=class extends Map{static{a(this,"Resources")}isWorker=!0;loginPath;set(t,r,s,n){if(!r)throw new Error("Must provide a resource");t.startsWith("/")&&(t=t.replace(/^\/+/,""));let i={Resource:r,path:t,type:s,hasSubPaths:!1,relativeURL:""},o=super.get(t);if(o&&(o.Resource.databaseName!==r.databaseName||o.Resource.tableName!==r.tableName)&&!n)throw new Error(`Conflicting paths for ${t}`);super.set(t,i);for(let[c,u]of this){let _=2;for(;(_=c.indexOf("/",_))>-1;){let l=this.get(c.slice(0,_));l&&(l.hasSubPaths=!0),_+=2}}}getMatch(t,r){let s=2,n;for(;(s=t.indexOf("/",s))>-1;){let c=t.slice(0,s),u=this.get(c);if(u){if(u.relativeURL=t.slice(s),!u.hasSubPaths)return u;n=u}s+=2}if(n)return n;let i=t.indexOf("?"),o=i>-1?t.slice(0,i):t;return n=this.get(o),n?n.relativeURL=i>-1?t.slice(i):"":n||(n=this.get(""),n&&(t[0]!=="/"&&(t="/"+t),n.relativeURL=t)),n}getResource(t,r){let s=this.getMatch(t);if(s)return t=s.relativeURL,s.Resource.getResource(this.pathToId(t,s.Resource),r)}call(t,r,s){return Ge(r,async()=>{let n=this.getMatch(t);if(n)return t=n.relativeURL,s(n.Resource,n.path,t)})}setRepresentation(t,r,s){}};a(p5,"resetResources");a(Qo,"keyArrayToString")});var VU={};qe(VU,{Headers:()=>ri});var ri,Ad=Te(()=>{ri=class extends Map{static{a(this,"Headers")}set(t,r){return typeof t!="string"&&(t=""+t),typeof r!="string"&&(r=""+r),super.set(t.toLowerCase(),[t,r])}get(t){return typeof t!="string"&&(t=""+t),super.get(t.toLowerCase())?.[1]}has(t){return typeof t!="string"&&(t=""+t),super.has(t.toLowerCase())}setIfNone(t,r){typeof t!="string"&&(t=""+t),typeof r!="string"&&(r=""+r);let s=t.toLowerCase();if(!super.has(s))return super.set(s,[t,r])}append(t,r,s){typeof t!="string"&&(t=""+t),typeof r!="string"&&(r=""+r);let n=t.toLowerCase(),i=super.get(n);if(i){let o=i[1];s?r=(typeof o=="string"?o:o.join(", "))+", "+r:typeof o=="string"?r=[o,r]:o.push(r)}return super.set(n,[t,r])}[Symbol.iterator](){return super.values()[Symbol.iterator]()}}});var su={};qe(su,{authentication:()=>XU,bypassAuth:()=>N5,login:()=>y5,logout:()=>I5,start:()=>b5});function N5(){JU=!0}async function XU(e,t){let r=e.headers.asObject,s=r.authorization,n=r.cookie,i=r.origin,o=[];if(i){let E=e.isOperationsServer?R5?g5:[]:T5?S5:[];if(E.includes(i)||E.includes("*")){if(e.method==="OPTIONS"){let h=new ri([["Access-Control-Allow-Methods","POST, GET, PUT, DELETE, PATCH, OPTIONS"],["Access-Control-Allow-Headers","Accept, Content-Type, Authorization"],["Access-Control-Allow-Origin",i]]);return Od&&h.set("Access-Control-Allow-Credentials","true"),{status:200,headers:h}}o.push("Access-Control-Allow-Origin",i),Od&&o.push("Access-Control-Allow-Credentials","true")}}let c,u;if(Od){let E=(i?i.replace(/^https?:\/\//,"").replace(/\W/,"_")+"-":"")+"hdb-session=",h=n?.indexOf(E);if(h>=0){let S=n.indexOf(";",h),p=n.indexOf("=",h);c=n.slice(p+1,S===-1?n.length:S),u=await YU.get(c)}e.session=u||(u={})}e.user=null;let _=a((E,h,S)=>{let p=new bd.AuthAuditLog(E,h,Ct.AUTH_AUDIT_TYPES.AUTHENTICATION,r["x-forwarded-for"]??e.ip,e.method,e.pathname);p.auth_strategy=S,c&&(p.session_id=c),r.referer&&(p.referer=r.referer),r.origin&&(p.origin=r.origin),h===Ct.AUTH_AUDIT_STATUS.SUCCESS?$U.notify(p):$U.error(p)},"authAuditLog"),l;if(s){if(l=xi.get(s),!l){let[E,h]=s.split(" "),S,p;try{switch(E){case"Basic":[S,p]=atob(h).split(":"),l=S||p?await ut.getUser(S,p):null;break;case"Bearer":try{l=await(0,Nd.validateOperationToken)(h)}catch(g){if(g.message==="invalid token")try{return await(0,Nd.validateRefreshToken)(h),{status:-1}}catch{throw g}}break}}catch(g){return O5&&(xi.get(h)||(xi.set(h,h),_(S,Ct.AUTH_AUDIT_STATUS.FAILURE,E))),{status:401,body:si({error:g.message},e)}}xi.set(s,l),A5&&_(l.username,Ct.AUTH_AUDIT_STATUS.SUCCESS,E)}e.user=l}else u?.user?e.user=await ut.getUser(u.user,null,!1):JU&&(e.ip?.includes("127.0.0.1")||e.ip=="::1")&&(e.user=await(0,WU.getSuperUser)());Od&&(e.session.update=function(E){if(!c){c=(0,QU.v4)();let S=`${(i?i.replace(/^https?:\/\//,"").replace(/\W/,"_")+"-":"")+"hdb-session="}${c}; Path=/; Expires=Tue, 01 Oct 8307 19:33:20 GMT; HttpOnly${e.protocol==="https"?"; SameSite=None; Secure":""}`;o?o.push("Set-Cookie",S):d?.headers?.set&&d.headers.set("Set-Cookie",S)}return E.id=c,YU.put(E)},e.login=async function(E,h){e.user=await ut.getUser(E,h),e.session.update({user:e.user.username})},(l&&!u||u?.user?.username!==l?.username)&&r["user-agent"]?.startsWith("Mozilla")&&e.session.update({user:e.user.username}));let d=await t(e);if(!d)return d;d.status===401&&(r["user-agent"]?.startsWith("Mozilla")&&r.accept?.startsWith("text/html")&&ti.loginPath?(d.status=302,d.headers.set("Location",ti.loginPath(e))):d.headers.set("WWW-Authenticate","Basic"));let f=o.length;if(f>0){let E=d.headers;E||(d.headers=E=new ri);for(let h=0;h<f;){let S=o[h++];E.set(S,o[h++])}}return o=null,d}function b5({server:e,port:t}){e.request(XU,{port:t||"all"}),KU||(KU=!0,setInterval(()=>{xi=new Map},Yr.get(Ct.CONFIG_PARAMS.AUTHENTICATION_CACHETTL)).unref(),zU.user.addListener(()=>{xi=new Map}))}async function y5(e){if(!e.baseRequest?.login)throw new Error("No session for login");return e.baseResponse.headers.set=(t,r)=>{e.fastifyResponse.header(t,r)},await e.baseRequest.login(e.username,e.password),"Login successful"}async function I5(e){if(!e.baseRequest.session)throw new Error("No session for logout");return await e.baseRequest.session.update({user:null}),"Logout successful"}var WU,Nd,QU,Yr,Ct,bd,zU,$U,S5,T5,g5,R5,YU,Od,JU,A5,O5,xi,KU,yd=Te(()=>{WU=U(Gr());hr();ru();Nd=U(Hc());fe();QU=require("uuid"),Yr=U(X()),Ct=U(y()),bd=U(G()),zU=U(ac());Ad();zo();$U=(0,bd.loggerWithTag)("auth-event");Yr.initSync();S5=Yr.get(Ct.CONFIG_PARAMS.HTTP_CORSACCESSLIST),T5=Yr.get(Ct.CONFIG_PARAMS.HTTP_CORS),g5=Yr.get(Ct.CONFIG_PARAMS.OPERATIONSAPI_NETWORK_CORSACCESSLIST),R5=Yr.get(Ct.CONFIG_PARAMS.OPERATIONSAPI_NETWORK_CORS),YU=et({table:"hdb_session",database:"system",attributes:[{name:"id",isPrimaryKey:!0},{name:"user"}]}),Od=Yr.get(Ct.CONFIG_PARAMS.AUTHENTICATION_ENABLESESSIONS)??!0,JU=Yr.get(Ct.CONFIG_PARAMS.AUTHENTICATION_AUTHORIZELOCAL)??process.env.DEV_MODE,A5=Yr.get(Ct.CONFIG_PARAMS.LOGGING_AUDITAUTHEVENTS_LOGSUCCESSFUL)??!1,O5=Yr.get(Ct.CONFIG_PARAMS.LOGGING_AUDITAUTHEVENTS_LOGFAILED)??!1,xi=new Map;ut.onInvalidatedUser(()=>{xi=new Map});a(N5,"bypassAuth");a(XU,"authentication");a(b5,"start");a(y5,"login");a(I5,"logout")});var nM=T((J_e,sM)=>{"use strict";var Se=require("joi"),jU=require("fs-extra"),ZU=require("path"),pn=ke(),eM=X(),tM=y(),rM=G(),{hdb_errors:w5}=j(),{HDB_ERROR_MSGS:kt}=w5,mn=/^[a-zA-Z0-9-_]+$/;sM.exports={getDropCustomFunctionValidator:L5,setCustomFunctionValidator:D5,addComponentValidator:v5,dropCustomFunctionProjectValidator:B5,packageComponentValidator:H5,deployComponentValidator:q5,setComponentFileValidator:U5,getComponentFileValidator:P5,dropComponentFileValidator:M5};function Id(e,t,r){try{let s=eM.get(tM.CONFIG_PARAMS.COMPONENTSROOT),n=ZU.join(s,t);return jU.existsSync(n)?e?t:r.message(kt.PROJECT_EXISTS):e?r.message(kt.NO_PROJECT):t}catch(s){return rM.error(s),r.message(kt.VALIDATION_ERR)}}a(Id,"checkProjectExists");function nu(e,t){return e.includes("..")?t.message("Invalid file path"):e}a(nu,"checkFilePath");function C5(e,t,r,s){try{let n=eM.get(tM.CONFIG_PARAMS.COMPONENTSROOT),i=ZU.join(n,e,t,r+".js");return jU.existsSync(i)?r:s.message(kt.NO_FILE)}catch(n){return rM.error(n),s.message(kt.VALIDATION_ERR)}}a(C5,"checkFileExists");function L5(e){let t=Se.object({project:Se.string().pattern(mn).custom(Id.bind(null,!0)).required().messages({"string.pattern.base":kt.BAD_PROJECT_NAME}),type:Se.string().valid("helpers","routes").required(),file:Se.string().pattern(mn).custom(C5.bind(null,e.project,e.type)).custom(nu).required().messages({"string.pattern.base":kt.BAD_FILE_NAME})});return pn.validateBySchema(e,t)}a(L5,"getDropCustomFunctionValidator");function D5(e){let t=Se.object({project:Se.string().pattern(mn).custom(Id.bind(null,!0)).required().messages({"string.pattern.base":kt.BAD_PROJECT_NAME}),type:Se.string().valid("helpers","routes").required(),file:Se.string().custom(nu).required(),function_content:Se.string().required()});return pn.validateBySchema(e,t)}a(D5,"setCustomFunctionValidator");function U5(e){let t=Se.object({project:Se.string().pattern(mn).required().messages({"string.pattern.base":kt.BAD_PROJECT_NAME}),file:Se.string().custom(nu).required(),payload:Se.string().allow("").optional(),encoding:Se.string().valid("utf8","ASCII","binary","hex","base64","utf16le","latin1","ucs2").optional()});return pn.validateBySchema(e,t)}a(U5,"setComponentFileValidator");function M5(e){let t=Se.object({project:Se.string().pattern(mn).required().messages({"string.pattern.base":kt.BAD_PROJECT_NAME}),file:Se.string().custom(nu).optional()});return pn.validateBySchema(e,t)}a(M5,"dropComponentFileValidator");function P5(e){let t=Se.object({project:Se.string().required(),file:Se.string().custom(nu).required(),encoding:Se.string().valid("utf8","ASCII","binary","hex","base64","utf16le","latin1","ucs2").optional()});return pn.validateBySchema(e,t)}a(P5,"getComponentFileValidator");function v5(e){let t=Se.object({project:Se.string().pattern(mn).custom(Id.bind(null,!1)).required().messages({"string.pattern.base":kt.BAD_PROJECT_NAME})});return pn.validateBySchema(e,t)}a(v5,"addComponentValidator");function B5(e){let t=Se.object({project:Se.string().pattern(mn).custom(Id.bind(null,!0)).required().messages({"string.pattern.base":kt.BAD_PROJECT_NAME})});return pn.validateBySchema(e,t)}a(B5,"dropCustomFunctionProjectValidator");function H5(e){let t=Se.object({project:Se.string().pattern(mn).required().messages({"string.pattern.base":kt.BAD_PROJECT_NAME}),skip_node_modules:Se.boolean()});return pn.validateBySchema(e,t)}a(H5,"packageComponentValidator");function q5(e){let t=Se.object({project:Se.string().pattern(mn).required().messages({"string.pattern.base":kt.BAD_PROJECT_NAME}),payload:Se.string().optional().messages({"string.pattern.base":kt.BAD_PACKAGE}),package:Se.string().optional()});return pn.validateBySchema(e,t)}a(q5,"deployComponentValidator")});var Dd=T((j_e,_M)=>{"use strict";var wd=require("joi"),Cd=require("path"),iM=require("fs-extra"),{exec:F5}=require("child_process"),G5=require("util"),oM=G5.promisify(F5),iu=y(),{handleHDBError:Jo,hdb_errors:x5}=j(),{HTTP_STATUS_CODES:Xo}=x5,ou=X(),k5=ke(),jo=G();ou.initSync();var ZS=ou.get(iu.CONFIG_PARAMS.COMPONENTSROOT),aM="npm install --omit=dev --json",V5=`${aM} --dry-run`;_M.exports={installModules:W5,auditModules:Q5,installAllRootModules:$5,uninstallRootModule:Y5,linkHarperdb:K5};async function $5(e=!1){await Ld(),await au(e?"npm install --ignore-scripts":"npm install",ou.get(iu.CONFIG_PARAMS.ROOTPATH))}a($5,"installAllRootModules");async function Y5(e){await au(`npm uninstall ${e}`,ou.get(iu.CONFIG_PARAMS.ROOTPATH))}a(Y5,"uninstallRootModule");async function K5(){await Ld(),await au(`npm link ${iu.PACKAGE_ROOT}`,ou.get(iu.CONFIG_PARAMS.ROOTPATH))}a(K5,"linkHarperdb");async function au(e,t=void 0){let r,s;try{({stdout:r,stderr:s}=await oM(e,{cwd:t}))}catch(n){throw new Error(n.stderr.replace(`
`,""))}return s&&!s.includes("Debugger listening")&&jo.error("Error running NPM command:",e,s),jo.trace(r,s),r.replace(`
`,"")}a(au,"runCommand");async function W5(e){jo.info(`starting installModules for request: ${e}`);let t=lM(e);if(t)throw Jo(t,t.message,Xo.BAD_REQUEST);let{projects:r,dry_run:s}=e,n=s===!0?V5:aM;await Ld(),await uM(r);let i={};for(let o=0,c=r.length;o<c;o++){let u=r[o];i[u]={npm_output:null,npm_error:null};let _=Cd.join(ZS,u),l,d=null;try{let{stdout:f,stderr:E}=await oM(n,{cwd:_});l=f?f.replace(`
`,""):null,d=E?E.replace(`
`,""):null}catch(f){f.stderr?i[u].npm_error=cM(f.stderr):i[u].npm_error=f.message;continue}try{i[u].npm_output=JSON.parse(l)}catch{i[u].npm_output=l}try{i[u].npm_error=JSON.parse(d)}catch{i[u].npm_error=d}}return jo.info(`finished installModules with response ${i}`),i}a(W5,"installModules");function cM(e){let t='"error": {',r=e.indexOf('"error": {'),s=e.indexOf(`}
`);return r>-1&&s>-1?JSON.parse(e.substring(r+t.length-1,s+1)):e}a(cM,"parseNPMStdErr");async function Q5(e){jo.info(`starting auditModules for request: ${e}`);let t=lM(e);if(t)throw Jo(t,t.message,Xo.BAD_REQUEST);let{projects:r}=e;await Ld(),await uM(r);let s={};for(let n=0,i=r.length;n<i;n++){let o=r[n],c=Cd.join(ZS,o);s[o]={npm_output:null,npm_error:null};try{let u=await au("npm audit --json",c);s[o].npm_output=JSON.parse(u)}catch(u){s[o].npm_error=cM(u.stderr)}}return jo.info(`finished auditModules with response ${s}`),s}a(Q5,"auditModules");async function Ld(){try{return await au("npm -v"),!0}catch{throw Jo(new Error,"Unable to install project dependencies: npm is not installed on this instance of HarperDB.",Xo.BAD_REQUEST,void 0,void 0,!0)}}a(Ld,"checkNPMInstalled");async function uM(e){if(!Array.isArray(e)||e.length===0)throw Jo(new Error,"projects argument must be an array with at least 1 element",Xo.BAD_REQUEST,void 0,void 0,!0);let t=[],r=[];for(let s=0,n=e.length;s<n;s++){let i=e[s],o=Cd.join(ZS,i.toString());if(!await iM.pathExists(o)){t.push(i);continue}let u=Cd.join(o,"package.json");await iM.pathExists(u)||r.push(i)}if(t.length>0)throw Jo(new Error,`Unable to install project dependencies: custom function projects '${t.join(",")}' does not exist.`,Xo.BAD_REQUEST,void 0,void 0,!0);if(r.length>0)throw Jo(new Error,`Unable to install project dependencies: custom function projects '${r.join(",")}' do not have a package.json file.`,Xo.BAD_REQUEST,void 0,void 0,!0)}a(uM,"checkProjectPaths");function lM(e){let t=wd.object({projects:wd.array().min(1).items(wd.string()).required(),dry_run:wd.boolean().default(!1)});return k5.validateBySchema(e,t)}a(lM,"modulesValidator")});var tT=T((ede,mM)=>{"use strict";var Zo=require("fs-extra"),eT=require("path"),Ud=G(),dM=$(),Md=y(),hM=X(),z5=gr();mM.exports=J5;async function J5(){let e=X5(),t=hM.get(Md.CONFIG_PARAMS.ROOTPATH),r=eT.join(t,"package.json"),s={dependencies:{harperdb:"file:"+Md.PACKAGE_ROOT}},n=eT.join(t,"node_modules");await Zo.ensureDir(n);let i,o=!0,c=!1;try{i=await Zo.readJson(r)}catch(u){if(dM.isEmptyOrZeroLength(e))return;if(u.code!==Md.NODE_ERROR_CODES.ENOENT)throw u;o=!1}if(!dM.isEmptyOrZeroLength(e)){for(let{name:u,package:_}of e){let l=await fM(_);s.dependencies[u]=l+_}if(!o){Ud.notify("Installing components"),await EM(r,s,null);return}for(let{name:u,package:_}of e){let l=i.dependencies[u],d=await fM(_);if(l===void 0||l!==d+_){c=!0;break}}}for(let u in i.dependencies)s.dependencies[u]===void 0&&(Ud.notify("Removing component",u),c=!0);c&&(Ud.notify("Updating components."),await EM(r,s,i))}a(J5,"installComponents");function X5(){let e=z5.getConfiguration(),t=[];for(let r in e)e[r]?.package&&t.push(Object.assign(e[r],{name:r}));return t}a(X5,"getComponentsConfig");async function fM(e){return e.includes(":")?"":e.startsWith("@")||!e.startsWith("@")&&!e.includes("/")?"npm:":eT.extname(e)||await Zo.pathExists(e)?"file:":"github:"}a(fM,"getPkgPrefix");async function EM(e,t,r){Ud.trace("npm installing components package.json",t),await Zo.writeFile(e,JSON.stringify(t,null,"  "));try{await Dd().installAllRootModules(hM.get(Md.CONFIG_PARAMS.IGNORE_SCRIPTS)===!0)}catch(s){throw r?await Zo.writeFile(e,JSON.stringify(r,null,"  ")):await Zo.unlink(e),s}}a(EM,"installPackages")});var nT=T((sde,gM)=>{"use strict";var Ue=require("fs-extra"),rT=require("fast-glob"),de=require("path"),SM=require("tar-fs"),rde=require("uuid").v4,sT=require("normalize-path"),Vs=nM(),pt=G(),Me=y(),nt=X(),cu=gr(),j5=$(),{PACKAGE_ROOT:Z5}=y(),{handleHDBError:St,hdb_errors:e8}=j(),{basename:t8}=require("path"),r8=tT(),TM=X(),s8=y(),{Readable:n8}=require("stream"),{HDB_ERROR_MSGS:ki,HTTP_STATUS_CODES:Tt}=e8,i8=de.join(Z5,"application-template"),pM=de.join(nt.get(Me.HDB_SETTINGS_NAMES.HDB_ROOT_KEY),"tmp");function o8(){pt.trace("getting custom api status");let e={};try{e={port:nt.get(Me.CONFIG_PARAMS.HTTP_PORT),directory:nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),is_enabled:!0}}catch(t){throw St(new Error,ki.FUNCTION_STATUS,Tt.INTERNAL_SERVER_ERROR,pt.ERR,t)}return e}a(o8,"customFunctionsStatus");function a8(){pt.trace("getting custom api endpoints");let e={},t=nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT);try{rT.sync(sT(`${t}/*`),{onlyDirectories:!0}).forEach(s=>{let n=s.split("/").pop();e[n]={routes:rT.sync(sT(`${s}/routes/*.js`)).map(i=>i.split("/").pop().split(".js")[0]),helpers:rT.sync(sT(`${s}/helpers/*.js`)).map(i=>i.split("/").pop().split(".js")[0])}})}catch(r){throw St(new Error,ki.GET_FUNCTIONS,Tt.INTERNAL_SERVER_ERROR,pt.ERR,r)}return e}a(a8,"getCustomFunctions");function c8(e){e.project&&(e.project=de.parse(e.project).name),e.file&&(e.file=de.parse(e.file).name);let t=Vs.getDropCustomFunctionValidator(e);if(t)throw St(t,t.message,Tt.BAD_REQUEST);pt.trace("getting custom api endpoint file content");let r=nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),{project:s,type:n,file:i}=e,o=de.join(r,s,n,i+".js");try{return Ue.readFileSync(o,{encoding:"utf8"})}catch(c){throw St(new Error,ki.GET_FUNCTION,Tt.INTERNAL_SERVER_ERROR,pt.ERR,c)}}a(c8,"getCustomFunction");function u8(e){e.project&&(e.project=de.parse(e.project).name),e.file&&(e.file=de.parse(e.file).name);let t=Vs.setCustomFunctionValidator(e);if(t)throw St(t,t.message,Tt.BAD_REQUEST);pt.trace("setting custom function file content");let r=nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),{project:s,type:n,file:i,function_content:o}=e;try{return Ue.outputFileSync(de.join(r,s,n,i+".js"),o),`Successfully updated custom function: ${i}.js`}catch(c){throw St(new Error,ki.SET_FUNCTION,Tt.INTERNAL_SERVER_ERROR,pt.ERR,c)}}a(u8,"setCustomFunction");function l8(e){e.project&&(e.project=de.parse(e.project).name),e.file&&(e.file=de.parse(e.file).name);let t=Vs.getDropCustomFunctionValidator(e);if(t)throw St(t,t.message,Tt.BAD_REQUEST);pt.trace("dropping custom function file");let r=nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),{project:s,type:n,file:i}=e;try{return Ue.unlinkSync(de.join(r,s,n,i+".js")),`Successfully deleted custom function: ${i}.js`}catch(o){throw St(new Error,ki.DROP_FUNCTION,Tt.INTERNAL_SERVER_ERROR,pt.ERR,o)}}a(l8,"dropCustomFunction");function _8(e){e.project&&(e.project=de.parse(e.project).name);let t=Vs.addComponentValidator(e);if(t)throw St(t,t.message,Tt.BAD_REQUEST);pt.trace("adding component");let r=nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),{project:s}=e;try{let n=de.join(r,s);return Ue.mkdirSync(n,{recursive:!0}),Ue.copySync(i8,n),`Successfully added project: ${s}`}catch(n){throw St(new Error,ki.ADD_FUNCTION,Tt.INTERNAL_SERVER_ERROR,pt.ERR,n)}}a(_8,"addComponent");function d8(e){e.project&&(e.project=de.parse(e.project).name);let t=Vs.dropCustomFunctionProjectValidator(e);if(t)throw St(t,t.message,Tt.BAD_REQUEST);pt.trace("dropping custom function project");let r=nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),{project:s}=e,n=nt.get(Me.CONFIG_PARAMS.APPS);if(!j5.isEmptyOrZeroLength(n)){let i=!1;for(let[o,c]of n.entries())if(c.name===s){n.splice(o,1),i=!0;break}if(i)return cu.updateConfigValue(Me.CONFIG_PARAMS.APPS,n),`Successfully deleted project: ${s}`}try{let i=de.join(r,s);return Ue.rmSync(i,{recursive:!0}),`Successfully deleted project: ${s}`}catch(i){throw St(new Error,ki.DROP_FUNCTION_PROJECT,Tt.INTERNAL_SERVER_ERROR,pt.ERR,i)}}a(d8,"dropCustomFunctionProject");async function f8(e){e.project&&(e.project=de.parse(e.project).name);let t=Vs.packageComponentValidator(e);if(t)throw St(t,t.message,Tt.BAD_REQUEST);let r=nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),{project:s}=e;pt.trace("packaging component",s);let n;try{n=await Ue.realpath(de.join(r,s))}catch(u){if(u.code!==Me.NODE_ERROR_CODES.ENOENT)throw u;try{n=await Ue.realpath(de.join(nt.get(Me.CONFIG_PARAMS.ROOTPATH),"node_modules",s))}catch(_){if(_.code===Me.NODE_ERROR_CODES.ENOENT)throw new Error(`Unable to locate project '${s}'`)}}await Ue.ensureDir(pM);let i=de.join(pM,`${s}.tar`),o={};(e.skip_node_modules===!0||e.skip_node_modules==="true")&&(o={ignore:u=>u.includes(de.join(n,"node_modules"))}),SM.pack(n,o).pipe(Ue.createWriteStream(i,{overwrite:!0})),await new Promise(u=>setTimeout(u,2e3));let c=Ue.readFileSync(i,{encoding:"base64"});return await Ue.remove(i),{project:s,payload:c}}a(f8,"packageComponent");async function E8(e){e.project&&(e.project=de.parse(e.project).name);let t=Vs.deployComponentValidator(e);if(t)throw St(t,t.message,Tt.BAD_REQUEST);let r=nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),{project:s,payload:n,package:i}=e;if(pt.trace("deploying component",s),!n&&!i)throw new Error("'payload' or 'package' must be provided");let o;if(n){o=de.join(r,s),i="file:"+o,await Ue.ensureDir(o);let f=n8.from(Buffer.from(n,"base64"));await new Promise((h,S)=>{f.pipe(SM.extract(o,{finish:h})).on("error",S)});let E=await Ue.readdir(o);E.length===1&&E[0]==="package"&&(await Ue.copy(de.join(o,"package"),o),await Ue.remove(de.join(o,"package")))}if(cu.updateConfigValue(`${s}_package`,i,void 0,!1,!1,!0),!n){await r8();let f=TM.get(s8.CONFIG_PARAMS.ROOTPATH);o=de.join(f,"node_modules",s)}let c=new Map;c.isWorker=!0;let u=(vd(),Z(Pd)),_;u.setErrorReporter(f=>_=f);let l=t8(o),d=u.component_errors.get(l);try{await u.loadComponent(o,c)}finally{u.component_errors.set(l,d)}if(_)throw _;return pt.info("Installed component"),`Successfully deployed: ${s}`}a(E8,"deployComponent");async function h8(){let e=cu.getConfiguration(),t=[];for(let o in e)if(e[o]?.package){if(e[o].package.startsWith("file:"))continue;t.push(Object.assign({},e[o],{name:o}))}let r=a(async(o,c)=>{let u=await Ue.readdir(o,{withFileTypes:!0});for(let _ of u){let l=_.name;if(l.startsWith(".")||l==="node_modules")continue;let d=de.join(o,l);if(_.isDirectory()||_.isSymbolicLink()){let f={name:l,entries:[]};c.entries.push(f),await r(d,f)}else{let f=await Ue.stat(d),E={name:de.basename(l),mtime:f.mtime,size:f.size};c.entries.push(E)}}return c},"walk_dir"),s=await r(nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),{name:nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT).split(de.sep).slice(-1).pop(),entries:t});for(let o of s.entries)if(o.package){let c=await r(de.join(nt.get(Me.CONFIG_PARAMS.ROOTPATH),"node_modules",o.name),{name:o.name,entries:[]});Object.assign(o,c)}let i=(vd(),Z(Pd)).component_errors;for(let o of t){let c=i.get(o.name);c?o.error=i.get(o.name):c===void 0&&(o.error="The component has not been loaded yet (may need a restart)")}return s}a(h8,"getComponents");async function m8(e){let t=Vs.getComponentFileValidator(e);if(t)throw St(t,t.message,Tt.BAD_REQUEST);let s=cu.getConfigObj()[e.project]||e.project==="harperdb"?de.join(TM.get(Me.CONFIG_PARAMS.ROOTPATH),"node_modules"):nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),n=e.encoding?{encoding:e.encoding}:{encoding:"utf8"};try{return await Ue.readFile(de.join(s,e.project,e.file),n)}catch(i){throw i.code===Me.NODE_ERROR_CODES.ENOENT?new Error(`Component file not found '${de.join(e.project,e.file)}'`):i}}a(m8,"getComponentFile");async function p8(e){let t=Vs.setComponentFileValidator(e);if(t)throw St(t,t.message,Tt.BAD_REQUEST);let r=e.encoding?{encoding:e.encoding}:{encoding:"utf8"},s=de.join(nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),e.project,e.file);return e.payload!==void 0?(await Ue.ensureFile(s),await Ue.outputFile(s,e.payload,r)):await Ue.ensureDir(s),"Successfully set component: "+e.file}a(p8,"setComponentFile");async function S8(e){let t=Vs.dropComponentFileValidator(e);if(t)throw St(t,t.message,Tt.BAD_REQUEST);let r=e.file?de.join(e.project,e.file):e.project,s=de.join(nt.get(Me.CONFIG_PARAMS.COMPONENTSROOT),r);return await Ue.pathExists(s)&&await Ue.remove(s),cu.deleteConfigFromFile([e.project]),"Successfully dropped: "+r}a(S8,"dropComponent");gM.exports={customFunctionsStatus:o8,getCustomFunctions:a8,getCustomFunction:c8,setCustomFunction:u8,dropCustomFunction:l8,addComponent:_8,dropCustomFunctionProject:d8,packageComponent:f8,deployComponent:E8,getComponents:h8,getComponentFile:m8,setComponentFile:p8,dropComponent:S8}});var iT=T((ide,AM)=>{"use strict";var $s=require("joi"),RM=ke();AM.exports={readTransactionLogValidator:T8,deleteTransactionLogsBeforeValidator:g8};function T8(e){let t=$s.object({schema:$s.string().required(),table:$s.string().required(),from:$s.date().timestamp(),to:$s.date().timestamp(),limit:$s.number().min(1)});return RM.validateBySchema(e,t)}a(T8,"readTransactionLogValidator");function g8(e){let t=$s.object({schema:$s.string().required(),table:$s.string().required(),timestamp:$s.date().timestamp().required()});return RM.validateBySchema(e,t)}a(g8,"deleteTransactionLogsBeforeValidator")});var Hd=T((ade,IM)=>{"use strict";var oT=y(),Bd=_t(),OM=$(),NM=X(),bM=nn(),{handleHDBError:ea,hdb_errors:R8}=j(),{HTTP_STATUS_CODES:ta}=R8,{readTransactionLogValidator:A8,deleteTransactionLogsBeforeValidator:O8}=iT(),yM="This operation relies on clustering and cannot run with it disable.",N8="Logs successfully deleted from transaction log.",b8="All logs successfully deleted from transaction log.";IM.exports={readTransactionLog:y8,deleteTransactionLogsBefore:I8};async function*y8(e){let t=A8(e);if(t)throw ea(t,t.message,ta.BAD_REQUEST,void 0,void 0,!0);if(!NM.get(oT.CONFIG_PARAMS.CLUSTERING_ENABLED))throw ea(new Error,yM,ta.NOT_FOUND,void 0,void 0,!0);let{schema:r,table:s}=e,n=OM.checkSchemaTableExist(r,s);if(n)throw ea(new Error,n,ta.NOT_FOUND,void 0,void 0,!0);let i=bM.createNatsTableStreamName(r,s),o=await Bd.viewStreamIterator(i,parseInt(e.from),e.limit);for await(let c of o){let u=Math.floor(c?.nats_timestamp/1e6);if(e.to&&u>e.to)break;let _={operation:c?.entry?.operation,user:c?.entry?.__origin?.user,timestamp:u,records:c?.entry?.records,attributes:c?.entry?.attributes};c?.entry?.operation===oT.OPERATIONS_ENUM.DELETE&&(_.hash_values=c?.entry?.hash_values),yield _}}a(y8,"readTransactionLog");async function I8(e){let t=O8(e);if(t)throw ea(t,t.message,ta.BAD_REQUEST,void 0,void 0,!0);if(!NM.get(oT.CONFIG_PARAMS.CLUSTERING_ENABLED))throw ea(new Error,yM,ta.NOT_FOUND,void 0,void 0,!0);let{schema:r,table:s,timestamp:n}=e,i=OM.checkSchemaTableExist(r,s);if(i)throw ea(new Error,i,ta.NOT_FOUND,void 0,void 0,!0);let o=bM.createNatsTableStreamName(r,s),{jsm:c}=await Bd.getNATSReferences(),u=await Bd.getStreamInfo(o),_=new Date(u.state.first_ts).getTime();if(n<=_)return`No transactions exist before: ${n}`;let l=N8,d,f=new Date(u.state.last_ts).getTime();return n>f?(d=u.state.last_seq+1,l=b8):d=(await Bd.viewStream(o,parseInt(n),1))[0].nats_sequence,await c.streams.purge(o,{seq:d}),l}a(I8,"deleteTransactionLogsBefore")});var CM=T((ude,wM)=>{"use strict";var aT=class{static{a(this,"PermissionTableResponseObject")}constructor(t,r,s=[],n=[]){this.schema=t,this.table=r,this.required_table_permissions=s,this.required_attribute_permissions=n}};wM.exports=aT});var DM=T((_de,LM)=>{"use strict";var cT=class{static{a(this,"PermissionAttributeResponseObject")}constructor(t,r=[]){this.attribute_name=t,this.required_permissions=r}};LM.exports=cT});var lT=T((fde,MM)=>{"use strict";var UM=CM(),w8=DM(),{HDB_ERROR_MSGS:C8}=fr(),uT=class{static{a(this,"PermissionResponseObject")}constructor(){this.error=C8.OP_AUTH_PERMS_ERROR,this.unauthorized_access={},this.invalid_schema_items=[]}handleUnauthorizedItem(t){return this.invalid_schema_items=[],this.unauthorized_access=[t],this}handleInvalidItem(t){return this.invalid_schema_items=[t],this.unauthorized_access=[],this}addInvalidItem(t,r,s){if(r&&s){let n=`${r}_${s}`;if(this.unauthorized_access[n])return}this.invalid_schema_items.push(t)}addUnauthorizedTable(t,r,s){let n=new UM(t,r,s),i=`${t}_${r}`;this.unauthorized_access[i]=n}addUnauthorizedAttributes(t,r,s,n){let i=[];t.forEach(c=>{let u=new w8(c,n[c]);i.push(u)});let o=`${r}_${s}`;if(this.unauthorized_access[o])this.unauthorized_access[o].required_attribute_permissions=i;else{let c=new UM(r,s,[],i);this.unauthorized_access[o]=c}}getPermsResponse(){let t=Object.values(this.unauthorized_access);return t.length>0||this.invalid_schema_items.length>0?(this.unauthorized_access=t,this):null}};MM.exports=uT});var xd=T((hde,zM)=>{"use strict";var _T=Fr(),qd=qr(),Wr=v_(),_u=gi(),dT=bi(),L8=bp(),D8=$C(),du=Gr(),Fd=Pp(),dt=G(),U8=Hp(),M8=Z_(),P8=SS(),v8=sd(),B8=TS(),H8=gS(),q8=OS(),F8=bS(),fT=wS(),Sn=$(),G8=xD(),ET=MS(),BM=gd(),Kr=y(),HM=xU(),x8=xo(),qM=Hc(),FM=(yd(),Z(su)),GM=gr(),wr=nT(),k8=require("alasql"),xM=Hd(),kM=Dd(),VM=lT(),{handleHDBError:ar,hdb_errors:$M}=j(),{HDB_ERROR_MSGS:Lt,HTTP_STATUS_CODES:uu}=$M,v=new Map,YM="delete",ni="insert",Tn="read",Vi="update",lu="describe",PM=_u.describeSchema.name,vM=_u.describeTable.name,KM={delete:!0,deleteRecord:!0,update:!0,updateData:!0,dropAttribute:!0,dropTable:!0,dropSchema:!0,upsert:!0,upsertData:!0},V8="catchup",$8="handleGetJob",Y8="handleGetJobsByStartDate",Gd={CSV_DATA_LOAD:"csvDataLoad",CSV_URL_LOAD:"csvURLLoad",CSV_FILE_LOAD:"csvFileLoad",IMPORT_FROM_S3:"importFromS3"},K8=[Wr.createTable.name,Wr.createAttribute.name,Wr.dropTable.name,Wr.dropAttribute.name],WM={EXPORT_TO_S3:"export_to_s3",EXPORT_LOCAL:"export_local"},q=class{static{a(this,"permission")}constructor(t,r){this.requires_su=t,this.perms=r}};v.set(_T.insert.name,new q(!1,[ni]));v.set(_T.update.name,new q(!1,[Vi]));v.set(_T.upsert.name,new q(!1,[ni,Vi]));v.set(qd.searchByConditions.name,new q(!1,[Tn]));v.set(qd.searchByHash.name,new q(!1,[Tn]));v.set(qd.searchByValue.name,new q(!1,[Tn]));v.set(qd.search.name,new q(!1,[Tn]));v.set(Wr.createSchema.name,new q(!0,[]));v.set(Wr.createTable.name,new q(!0,[]));v.set(Wr.createAttribute.name,new q(!1,[ni]));v.set(Wr.dropSchema.name,new q(!0,[]));v.set(Wr.dropTable.name,new q(!0,[]));v.set(Wr.dropAttribute.name,new q(!0,[]));v.set(_u.describeSchema.name,new q(!1,[Tn]));v.set(_u.describeTable.name,new q(!1,[Tn]));v.set(dT.deleteRecord.name,new q(!1,[YM]));v.set(du.addUser.name,new q(!0,[]));v.set(du.alterUser.name,new q(!0,[]));v.set(du.dropUser.name,new q(!0,[]));v.set(du.listUsersExternal.name,new q(!0,[]));v.set(Fd.listRoles.name,new q(!0,[]));v.set(Fd.addRole.name,new q(!0,[]));v.set(Fd.alterRole.name,new q(!0,[]));v.set(Fd.dropRole.name,new q(!0,[]));v.set(U8.name,new q(!0,[]));v.set(M8.name,new q(!0,[]));v.set(P8.name,new q(!0,[]));v.set(v8.name,new q(!0,[]));v.set(B8.name,new q(!0,[]));v.set(H8.name,new q(!0,[]));v.set(fT.setRoutes.name,new q(!0,[]));v.set(fT.getRoutes.name,new q(!0,[]));v.set(fT.deleteRoutes.name,new q(!0,[]));v.set(GM.setConfiguration.name,new q(!0,[]));v.set(q8.clusterStatus.name,new q(!0,[]));v.set(F8.name,new q(!0,[]));v.set(ET.getFingerprint.name,new q(!0,[]));v.set(ET.setLicense.name,new q(!0,[]));v.set(dT.deleteFilesBefore.name,new q(!0,[]));v.set(dT.deleteAuditLogsBefore.name,new q(!0,[]));v.set(BM.restart.name,new q(!0,[]));v.set(BM.restartService.name,new q(!0,[]));v.set(L8.name,new q(!0,[]));v.set(D8.name,new q(!0,[Tn]));v.set(x8.systemInformation.name,new q(!0,[]));v.set(GM.getConfiguration.name,new q(!0,[]));v.set(xM.readTransactionLog.name,new q(!0,[]));v.set(xM.deleteTransactionLogsBefore.name,new q(!0,[]));v.set(kM.installModules.name,new q(!0,[]));v.set(kM.auditModules.name,new q(!0,[]));v.set(qM.createTokens.name,new q(!1,[]));v.set(qM.refreshOperationToken.name,new q(!1,[]));v.set(FM.login.name,new q(!1,[]));v.set(FM.logout.name,new q(!1,[]));v.set(wr.customFunctionsStatus.name,new q(!0,[]));v.set(wr.getCustomFunctions.name,new q(!0,[]));v.set(wr.getComponents.name,new q(!0,[]));v.set(wr.getComponentFile.name,new q(!0,[]));v.set(wr.setComponentFile.name,new q(!0,[]));v.set(wr.dropComponent.name,new q(!0,[]));v.set(wr.getCustomFunction.name,new q(!0,[]));v.set(wr.setCustomFunction.name,new q(!0,[]));v.set(wr.dropCustomFunction.name,new q(!0,[]));v.set(wr.addComponent.name,new q(!0,[]));v.set(wr.dropCustomFunctionProject.name,new q(!0,[]));v.set(wr.packageComponent.name,new q(!0,[]));v.set(wr.deployComponent.name,new q(!0,[]));v.set(ET.getRegistrationInfo.name,new q(!1,[]));v.set(du.userInfo.name,new q(!1,[]));v.set(_u.describeAll.name,new q(!1,[]));v.set($8,new q(!1,[]));v.set(Y8,new q(!0,[]));v.set(V8,new q(!0,[]));v.set(Gd.CSV_DATA_LOAD,new q(!1,[ni,Vi]));v.set(Gd.CSV_URL_LOAD,new q(!1,[ni,Vi]));v.set(Gd.CSV_FILE_LOAD,new q(!1,[ni,Vi]));v.set(Gd.IMPORT_FROM_S3,new q(!1,[ni,Vi]));v.set(WM.EXPORT_TO_S3,new q(!0,[]));v.set(WM.EXPORT_LOCAL,new q(!0,[]));v.set(Kr.VALID_SQL_OPS_ENUM.DELETE,new q(!1,[YM]));v.set(Kr.VALID_SQL_OPS_ENUM.SELECT,new q(!1,[Tn]));v.set(Kr.VALID_SQL_OPS_ENUM.INSERT,new q(!1,[ni]));v.set(Kr.VALID_SQL_OPS_ENUM.UPDATE,new q(!1,[Vi]));zM.exports={verifyPerms:Q8,verifyPermsAst:W8,verifyBulkLoadAttributePerms:J8};function W8(e,t,r){if(Sn.isEmptyOrZeroLength(e))throw dt.info("verify_perms_ast has an empty user parameter"),ar(new Error);if(Sn.isEmptyOrZeroLength(t))throw dt.info("verify_perms_ast has an empty user parameter"),ar(new Error);if(Sn.isEmptyOrZeroLength(r))throw dt.info("verify_perms_ast has a null operation parameter"),ar(new Error);try{let s=new VM,n=new G8(e),i=n.getSchemas(),o=new Map;if((!i||i.length===0)&&n.affected_attributes&&n.affected_attributes.size>0)throw dt.info("No schemas defined in verifyPermsAst(), will not continue."),ar(new Error);let c=!!t.role.permission.super_user,u=i.includes("system");if(u&&KM[r])throw ar(new Error,Lt.DROP_SYSTEM,uu.FORBIDDEN);if(c&&!u)return null;let _=HM.getRolePermissions(t.role);t.role.permission=_,!c&&e instanceof k8.yy.Select&&(e=n.updateAttributeWildcardsForRolePerms(_));for(let d=0;d<i.length;d++){let f=n.getTablesBySchemaName(i[d]);f&&o.set(i[d],f)}let l=QM(t,r,o,s);return l||(o.forEach((d,f)=>{for(let E=0;E<d.length;E++){let h=n.getAttributesBySchemaTableName(f,d[E]),S=mT(t.role.permission,f,d[E]);hT(h,S,r,d[E],f,s)}}),s.getPermsResponse())}catch(s){throw ar(s)}}a(W8,"verifyPermsAst");function Q8(e,t){if(e===null||t===null||e.hdb_user===void 0||e.hdb_user===null)throw dt.info("null required parameter in verifyPerms"),ar(new Error,Lt.DEFAULT_INVALID_REQUEST,uu.BAD_REQUEST);let r;t instanceof Function?r=t.name:r=t;let s=e.action,n=e.schema,i=e.table,o=new Map;n&&i&&o.set(n,[i]);let c=new VM;if(Sn.isEmptyOrZeroLength(e.hdb_user.role)||Sn.isEmptyOrZeroLength(e.hdb_user.role.permission))return dt.info(`User ${e.hdb_user.username} has no role or permissions.  Please assign the user a valid role.`),c.handleUnauthorizedItem(Lt.USER_HAS_NO_PERMS(e.hdb_user.username));let u=!!e.hdb_user.role.permission.super_user,_=e.hdb_user.role.permission.structure_user,l=o.has(Kr.SYSTEM_SCHEMA_NAME)||n===Kr.SYSTEM_SCHEMA_NAME;if(l&&KM[r])throw ar(new Error,Lt.DROP_SYSTEM,uu.FORBIDDEN);if(u&&!l||_===!0&&(r===Wr.createSchema.name||r===Wr.dropSchema.name))return null;if(K8.indexOf(r)>=0&&(_===!0||Array.isArray(_)))return _===!0||_.indexOf(n)>=0?null:c.handleUnauthorizedItem(`User does not have access to perform '${e.operation}' against schema '${n}'`);let d=HM.getRolePermissions(e.hdb_user.role);if(e.hdb_user.role.permission=d,r===PM||r===vM){if(n===Kr.SYSTEM_SCHEMA_NAME)return c.handleUnauthorizedItem(Lt.SCHEMA_PERM_ERROR(n));if(!d.super_user){if(r===PM&&(!d[n]||!d[n][lu]))return c.handleInvalidItem(Lt.SCHEMA_NOT_FOUND(n));if(r===vM&&(!d[n]||!d[n].tables[i]||!d[n].tables[i][lu]))return c.handleInvalidItem(Lt.TABLE_NOT_FOUND(n,i))}}let f=QM(e.hdb_user,r,o,c,s);if(f)return f;if(v.get(r)&&v.get(r).perms.length===0)return null;if(!u&&e.get_attributes&&Kr.SEARCH_WILDCARDS.includes(e.get_attributes[0])){let S=[],p=d[n].tables[i];p[Kr.PERMS_CRUD_ENUM.READ]&&(p.attribute_permissions.length>0?p.attribute_permissions.filter(b=>b[Kr.PERMS_CRUD_ENUM.READ]).forEach(b=>{S.push(b.attribute_name)}):S=global.hdb_schema[n][i].attributes.map(g=>g.attribute),e.get_attributes=S)}let E=z8(e),h=mT(e.hdb_user.role.permission,n,i);return hT(E,h,r,i,n,c,s),c.getPermsResponse()}a(Q8,"verifyPerms");function QM(e,t,r,s,n){if(Sn.arrayHasEmptyValues([e,t,r]))throw dt.info("hasPermissions has an invalid parameter"),ar(new Error);let i=r.has("system"),o=e.role.permission;if(o.super_user&&(!i||v.get(t).requires_su))return null;if(!v.get(t))throw dt.info(`operation ${t} not found.`),ar(new Error,Lt.OP_NOT_FOUND(t),uu.BAD_REQUEST);if(v.get(t)&&v.get(t).requires_su)return dt.info(`operation ${t} requires SU permissions.`),s.handleUnauthorizedItem(Lt.OP_IS_SU_ONLY(t));let c=r.keys();for(let u of c){try{if(u&&!o[u]||o[u][lu]===!1){s.addInvalidItem(Lt.SCHEMA_NOT_FOUND(u));continue}}catch{s.addInvalidItem(Lt.SCHEMA_NOT_FOUND(u));continue}let _=r.get(u);for(let l of _){let d=o[u].tables[l];if(!d||d[lu]===!1)s.addInvalidItem(Lt.TABLE_NOT_FOUND(u,l));else try{let f=[],E=v.get(t).perms;!Sn.isEmpty(n)&&E.includes(n)&&(E=[n]);for(let h=0;h<E.length;h++){let S=E[h],p=d[S];(p==null||p===!1)&&(dt.info(`Required ${S} permission not found for ${t} ${n?`${n} `:""}operation in role ${e.role.id}`),f.push(S))}f.length>0&&s.addUnauthorizedTable(u,l,f)}catch(f){let E=Lt.UNKNOWN_OP_AUTH_ERROR(t,u,l);throw dt.error(E),dt.error(f),ar($M.CHECK_LOGS_WRAPPER(E))}}}return r.size<2?s.getPermsResponse():null}a(QM,"hasPermissions");function hT(e,t,r,s,n,i,o){if(!e||!t)throw dt.info("no attributes specified in checkAttributePerms."),ar(new Error);let c=v.get(r).perms;if(!c||c==="")throw dt.info(`no permissions found for ${r} in checkAttributePerms().`),ar(new Error);if(Sn.isEmptyOrZeroLength(t))return dt.info("No role permissions set (this is OK)."),null;o&&c.includes(o)&&(c=[o]);let u={};for(let l of e){let d=t.get(l);if(d){if(d[lu]===!1){i.addInvalidItem(Lt.ATTR_NOT_FOUND(n,s,l),n,s);continue}if(c)for(let f of c){if(Kr.TIME_STAMP_NAMES.includes(d.attribute_name)&&f!==Tn)throw ar(new Error,Lt.SYSTEM_TIMESTAMP_PERMS_ERR,uu.FORBIDDEN);d[f]===!1&&(u[d.attribute_name]?u[d.attribute_name].push(f):u[d.attribute_name]=[f])}}else i.addInvalidItem(Lt.ATTR_NOT_FOUND(n,s,l),n,s)}let _=Object.keys(u);_.length>0&&i.addUnauthorizedAttributes(_,n,s,u)}a(hT,"checkAttributePerms");function z8(e){let t=new Set;try{if(e.action)return t;if(e.operation===Kr.OPERATIONS_ENUM.SEARCH_BY_CONDITIONS&&e.conditions.forEach(r=>{t.add(r.search_attribute)}),e&&e.search_attribute&&t.add(e.search_attribute),!e.records||e.records.length===0){if(!e.get_attributes||!e.get_attributes.length===0)return t;for(let r=0;r<e.get_attributes.length;r++)t.add(e.get_attributes[r])}else for(let r=0;r<e.records.length;r++){let s=Object.keys(e.records[r]);for(let n=0;n<s.length;n++)t.add(s[n])}}catch(r){dt.info(r)}return t}a(z8,"getRecordAttributes");function mT(e,t,r){let s=new Map;if(Sn.isEmpty(e))return dt.info("no hdb_user specified in getAttributePermissions"),s;if(e.super_user||!t||!r)return s;try{e[t].tables[r].attribute_permissions.forEach(n=>{s.has(n.attribute_name)||s.set(n.attribute_name,n)})}catch{dt.info(`No attribute permissions found for schema ${t} and table ${r}.`)}return s}a(mT,"getAttributePermissions");function J8(e,t,r,s,n,i,o){let c=new Set(i),u=mT(e,s,n);hT(c,u,t,n,s,o,r)}a(J8,"verifyBulkLoadAttributePerms")});var Vd=T((pde,eP)=>{"use strict";eP.exports={evaluateSQL:u6,processAST:ZM,convertSQLToAST:jM,checkASTPermissions:XM};var X8=Fr(),JM=require("util"),j8=JM.callbackify(X8.insert),Z8=qr().search,e6=Hw().update,t6=JM.callbackify(e6),r6=Fw().convertDelete,ii=require("alasql"),s6=xd(),kd=G(),n6=A_(),i6=$(),fu=y(),{hdb_errors:o6,handleHDBError:pT}=j(),{HTTP_STATUS_CODES:ST}=o6;n6(ii);var a6=403,c6="There was a problem performing this insert. Please check the logs and try again.",TT=class{static{a(this,"ParsedSQLObject")}constructor(){this.ast=void 0,this.variant=void 0,this.permissions_checked=!1}};function u6(e,t){let r=e.parsed_sql_object;if(!r){r=jM(e.sql);let s,n=r.ast.statements[0];if(n instanceof ii.yy.Insert?s=n.into.databaseid:n instanceof ii.yy.Select?s=n.from?n.from[0].databaseid:null:n instanceof ii.yy.Update||n instanceof ii.yy.Delete?s=n.table.databaseid:kd.error("AST in evaluateSQL is not a valid SQL type."),!(n instanceof ii.yy.Select)&&i6.isEmptyOrZeroLength(s))return t("No schema specified",null)}ZM(e,r,(s,n)=>{if(s)return t(s);t(null,n)})}a(u6,"evaluateSQL");function XM(e,t){let r;try{r=s6.verifyPermsAst(t.ast.statements[0],e.hdb_user,t.variant),t.permissions_checked=!0}catch(s){throw s}return r||null}a(XM,"checkASTPermissions");function jM(e){let t=new TT;if(!e)throw pT(new Error,"The 'sql' parameter is missing from the request body",ST.BAD_REQUEST);try{let r=e.trim(),s=ii.parse(r),n=r.split(" ")[0].toLowerCase();t.ast=s,t.variant=n}catch(r){let s=r.message.split(`
`);throw s[1]?pT(r,`Invalid SQL at: ${s[1]}. Please ensure your SQL is valid. Try adding backticks to reserved words and schema table references.`,ST.BAD_REQUEST):pT(r,"We had trouble parsing your request. Please ensure your SQL is valid. Try adding backticks to reserved words and schema table references.",ST.BAD_REQUEST)}return t}a(jM,"convertSQLToAST");function ZM(e,t,r){try{let s=l6;if(!e.bypass_auth&&!t.permissions_checked){let i=XM(e,t);if(i&&i.length>0)return r(a6,i)}let n={statement:t.ast.statements[0],hdb_user:e.hdb_user};switch(t.variant){case fu.VALID_SQL_OPS_ENUM.SELECT:s=Z8,n=t.ast.statements[0];break;case fu.VALID_SQL_OPS_ENUM.INSERT:s=_6;break;case fu.VALID_SQL_OPS_ENUM.UPDATE:s=t6;break;case fu.VALID_SQL_OPS_ENUM.DELETE:s=r6;break;default:throw new Error(`unsupported SQL type ${t.variant} in SQL: ${e}`)}s(n,(i,o)=>{if(i){r(i);return}r(null,o)})}catch(s){return r(s)}}a(ZM,"processAST");function l6(e,t){kd.info(e),t("unknown sql statement")}a(l6,"nullFunction");function _6({statement:e,hdb_user:t},r){let s=e.into,n={schema:s.databaseid,table:s.tableid,operation:"insert",hdb_user:t},i=e.columns.map(o=>o.columnid);try{n.records=d6(i,e.values)}catch(o){return r(o)}j8(n,(o,c)=>{if(o)return r(o);try{delete c.new_attributes,delete c.txn_time}catch(u){kd.error(`Error delete new_attributes from insert response: ${u}`)}r(null,c)})}a(_6,"convertInsert");function d6(e,t){try{return t.map(r=>{if(e.length!==r.length)throw"number of values do not match number of columns in insert";let s={};return r.forEach((n,i)=>{if(n.columnid)throw"cannot use a column in insert value";"value"in n?s[e[i]]=n.value:s[e[i]]=ii.compile(`SELECT ${n.toString()} AS [${fu.FUNC_VAL}] FROM ?`)}),s})}catch(r){throw kd.error(r),new Error(c6)}}a(d6,"createDataObjects")});var gT=T((Tde,rP)=>{"use strict";var{S3:f6,GetObjectCommand:E6}=require("@aws-sdk/client-s3");rP.exports={getFileStreamFromS3:h6,getS3AuthObj:tP};async function h6(e){let{s3:t}=e,r={Bucket:t.bucket,Key:t.key};return(await tP(t.aws_access_key_id,t.aws_secret_access_key,t.region).send(new E6(r))).Body}a(h6,"getFileStreamFromS3");function tP(e,t,r){return new f6({credentials:{accessKeyId:e,secretAccessKey:t},region:r})}a(tP,"getS3AuthObj")});var $d=T((Rde,dP)=>{"use strict";var iP=qr(),m6=Vd(),p6=gT(),{AsyncParser:S6,Transform:T6}=require("json2csv"),hu=require("stream"),Cr=$(),RT=require("fs-extra"),g6=require("path"),Qr=G(),{promisify:oP}=require("util"),Eu=$(),{handleHDBError:it,hdb_errors:R6}=j(),{HDB_ERROR_MSGS:cr,HTTP_STATUS_CODES:ot}=R6,{streamAsJSON:A6}=xE(),{Upload:O6}=require("@aws-sdk/lib-storage"),sP=["search_by_value","search_by_hash","sql"],nP=["json","csv"],aP="json",cP="csv",N6="Successfully exported JSON locally.",b6="Successfully exported CSV locally.",y6=1e3,I6=iP.searchByHash,w6=iP.searchByValue,C6=oP(m6.evaluateSQL),L6=oP(hu.finished);dP.exports={export_to_s3:P6,export_local:D6,toCsvStream:uP};async function D6(e){Qr.trace(`export_local request to path: ${e.path}, filename: ${e.filename}, format: ${e.format}`);let t=lP(e);if(!Cr.isEmpty(t))throw Qr.error(t),it(new Error,t,ot.BAD_REQUEST,void 0,void 0,!0);if(Cr.isEmpty(e.path))throw Qr.error(cr.MISSING_VALUE("path")),it(new Error,cr.MISSING_VALUE("path"),ot.BAD_REQUEST,void 0,void 0,!0);let r=(Cr.isEmpty(e.filename)?new Date().getTime():e.filename)+"."+e.format;e.path.endsWith(g6.sep)&&(e.path=e.path.substring(0,e.path.length-1));let s=Cr.buildFolderPath(e.path,r);await U6(e.path);let n=await _P(e);return await M6(s,e.format,n)}a(D6,"export_local");async function U6(e){if(Qr.trace("in confirmPath"),Cr.isEmptyOrZeroLength(e))throw it(new Error,`Invalid path: ${e}`,ot.BAD_REQUEST,void 0,void 0,!0);let t;try{t=await RT.stat(e)}catch(r){let s;throw r.code==="ENOENT"?s=`path '${e}' does not exist`:r.code==="EACCES"?s=`access to path '${e}' is denied`:s=r.message,Qr.error(s),it(new Error,s,ot.BAD_REQUEST,void 0,void 0,!0)}if(!t.isDirectory()){let r=`path '${e}' is not a directory, please supply a valid folder path`;throw Qr.error(r),it(new Error,r,ot.BAD_REQUEST,void 0,void 0,!0)}return!0}a(U6,"confirmPath");async function M6(e,t,r){if(Qr.trace("in saveToLocal"),Eu.isEmptyOrZeroLength(e))throw it(new Error,cr.INVALID_VALUE("file_path"),ot.BAD_REQUEST,void 0,void 0,!0);if(Eu.isEmptyOrZeroLength(t))throw it(new Error,cr.INVALID_VALUE("Source format"),ot.BAD_REQUEST,void 0,void 0,!0);if(Eu.isEmpty(r))throw it(new Error,cr.NOT_FOUND("Data"),ot.BAD_REQUEST,void 0,void 0,!0);if(t===aP){let s=RT.createWriteStream(e);return A6(r).pipe(s),await L6(s),{message:N6,path:e}}else if(t===cP){let s=RT.createWriteStream(e),n=hu.Readable.from(r),i={},o={objectMode:!0};return await new S6(i,o).fromInput(n).toOutput(s).promise(!1),{message:b6,path:e}}throw it(new Error,cr.INVALID_VALUE("format"),ot.BAD_REQUEST)}a(M6,"saveToLocal");async function P6(e){if(!e.s3||Object.keys(e.s3).length===0)throw it(new Error,cr.MISSING_VALUE("S3 object"),ot.BAD_REQUEST);if(Cr.isEmptyOrZeroLength(e.s3.aws_access_key_id))throw it(new Error,cr.MISSING_VALUE("aws_access_key_id"),ot.BAD_REQUEST);if(Cr.isEmptyOrZeroLength(e.s3.aws_secret_access_key))throw it(new Error,cr.MISSING_VALUE("aws_secret_access_key"),ot.BAD_REQUEST);if(Cr.isEmptyOrZeroLength(e.s3.bucket))throw it(new Error,cr.MISSING_VALUE("bucket"),ot.BAD_REQUEST);if(Cr.isEmptyOrZeroLength(e.s3.key))throw it(new Error,cr.MISSING_VALUE("key"),ot.BAD_REQUEST);if(Cr.isEmptyOrZeroLength(e.s3.region))throw it(new Error,cr.MISSING_VALUE("region"),ot.BAD_REQUEST);let t=lP(e);if(!Cr.isEmpty(t))throw it(new Error,t,ot.BAD_REQUEST);Qr.trace(`called export_to_s3 to bucket: ${e.s3.bucket} and query ${e.search_operation.sql}`);let r;try{r=await _P(e)}catch(u){throw Qr.error(u),u}let s,n=await p6.getS3AuthObj(e.s3.aws_access_key_id,e.s3.aws_secret_access_key,e.s3.region),i,o=new hu.PassThrough;if(e.format===cP){i=e.s3.key+".csv";let u=uP(r);u.on("error",_=>{throw _}),u.pipe(o)}else if(e.format===aP){i=e.s3.key+".json";let u=new hu.Readable;u.pipe(o),u.on("error",d=>{throw d}),u.push("[");let _=r.length,l="";for(let[d,f]of r.entries()){let E=d===_-1?JSON.stringify(f):JSON.stringify(f)+",";l+=E,d!==0&&d%y6===0&&(u.push(l),l="")}l.length!==0&&u.push(l),u.push("]"),u.push(null)}else throw it(new Error,cr.INVALID_VALUE("format"),ot.BAD_REQUEST);return new O6({client:n,params:{Bucket:e.s3.bucket,Key:i,Body:o}}).done()}a(P6,"export_to_s3");function uP(e){let t=hu.Readable.from(e?.[Symbol.iterator]||e?.[Symbol.asyncIterator]?e:[e]),r={},s={objectMode:!0},n=new T6(r,s);return t.pipe(n)}a(uP,"toCsvStream");function lP(e){if(Qr.trace("in exportCoreValidation"),Cr.isEmpty(e.format))return"format missing";if(nP.indexOf(e.format)<0)return`format invalid. must be one of the following values: ${nP.join(", ")}`;let t=e.search_operation.operation;if(Cr.isEmpty(t))return"search_operation.operation missing";if(sP.indexOf(t)<0)return`search_operation.operation must be one of the following values: ${sP.join(", ")}`}a(lP,"exportCoreValidation");async function _P(e){Qr.trace("in getRecords");let t,r;if(Eu.isEmpty(e.search_operation)||Eu.isEmptyOrZeroLength(e.search_operation.operation))throw it(new Error,cr.INVALID_VALUE("Search operation"),ot.BAD_REQUEST);switch(e.search_operation.operation){case"search_by_value":t=w6;break;case"search_by_hash":t=I6;break;case"sql":t=C6;break;default:throw r=`Operation ${e.search_operation.operation} is not support by export.`,Qr.error(r),it(new Error,r,ot.BAD_REQUEST)}return e.search_operation.hdb_user=e.hdb_user,t(e.search_operation)}a(_P,"getRecords")});var gP={};qe(gP,{contentTypes:()=>OT,findBestSerializer:()=>Wd,getDeserializer:()=>ra,registerContentHandlers:()=>NT,serialize:()=>Qd,serializeMessage:()=>si});function v6(e){try{return e?.[0]===123?JSON.parse(e):e}catch{return e}}function NT(e){e.register(H6,{serializers:[{regex:/^application\/json$/,serializer:Yd.streamAsJSON},{regex:/^application\/cbor$/,serializer:function(t){return new $i.EncoderStream(mu).end(t)}},{regex:/^application\/(x-)?msgpack$/,serializer:function(t){return(t?.[Symbol.iterator]||t?.[Symbol.asyncIterator])&&!Array.isArray(t)?Kd.Readable.from((0,Ys.encodeIter)(t,mu)):(0,Ys.pack)(t)}},{regex:/^text\/csv$/,serializer:function(t){return this.header("Content-Disposition",'attachment; filename="data.csv"'),(0,AT.toCsvStream)(t)}}]}),e.addContentTypeParser("application/x-msgpack",{parseAs:"buffer"},(t,r,s)=>{try{s(null,(0,Ys.unpack)(r))}catch(n){n.statusCode=400,s(n)}}),e.addContentTypeParser("application/cbor",{parseAs:"buffer"},(t,r,s)=>{try{s(null,(0,$i.decode)(r))}catch(n){n.statusCode=400,s(n)}})}function Wd(e){let r=(e.headers.asObject||e.headers).accept,s,n=0,i,o,c=r?r.toLowerCase().split(/\s*,\s*/):[];for(let u of c){let[_,...l]=u.split(/\s*;\s*/),d=1,f={q:1};for(let h of l){let S=h.indexOf("=");f[h.substring(0,S)]=h.substring(S+1)}d=+f.q;let E=Dt.get(_);if(E){let h=(E.q||1)*d;h>n&&(s=E,i=E.type||_,n=h,o=f)}}if(!s){if(r)return{serializer(){this.code(406).send("No supported content types found in Accept header, supported types include: "+Array.from(Dt.keys()).join(", "))}};s=Dt.get("application/json"),i="application/json"}return{serializer:s,type:i,parameters:o}}function Qd(e,t,r){let s=EP&&t.headers.asObject?.["accept-encoding"]?.includes("br"),n;if(e?.contentType!=null&&e.data!=null)r.headers.set("Content-Type",e.contentType),r.headers.set("Vary","Accept-Encoding"),n=e.data;else if(e instanceof Uint8Array)r.headers.set("Content-Type","application/octet-stream"),r.headers.set("Vary","Accept-Encoding"),n=e;else{let i=Wd(t);if(r.headers.set("Vary","Accept, Accept-Encoding"),r.headers.set("Content-Type",i.type),typeof e=="object"&&(e[Symbol.iterator]||e[Symbol.asyncIterator])&&i.serializer.serializeStream){let o=i.serializer.serializeStream(e);return s&&(r.headers.set("Content-Encoding","br"),o=o.pipe((0,gn.createBrotliCompress)({params:{[gn.constants.BROTLI_PARAM_MODE]:i.type.includes("json")||i.type.includes("text")?gn.constants.BROTLI_MODE_TEXT:gn.constants.BROTLI_MODE_GENERIC,[gn.constants.BROTLI_PARAM_QUALITY]:2}}))),o}n=i.serializer.serialize(e)}return s&&n?.length>EP?(r.headers.set("Content-Encoding","br"),new Promise((i,o)=>(0,gn.brotliCompress)(n,(c,u)=>{c?o(c):i(u)}))):n}function si(e,t){if(e?.contentType!=null&&e.data!=null)return e.data;if(!t)return JSON.stringify(e);let r=t.serialize;if(r)return r(e);let s=Wd(t);return r=t.serialize=s.serializer.serialize,r(e)}function q6(e){return new Promise((t,r)=>{let s=[];e.on("data",n=>s.push(n)),e.on("end",()=>t(Buffer.concat(s))),e.on("error",r)})}function ra(e,t){e||(e="");let r=e.indexOf(";"),s;r>-1&&(s=e.slice(r+1),e=e.slice(0,r));let n=Dt.get(e);if(t){if(n?.deserializeStream)return n.deserializeStream;let i=Dt.get(e)?.deserialize||hP(e,s);return o=>q6(o).then(i)}return e&&Dt.get(e)?.deserialize||hP(e,s)}function hP(e,t){if(e.startsWith("text/")){let r=t?.match(/charset=(.+)/)?.[1]||"utf-8";return s=>({contentType:e,data:s.toString(r)})}else return e==="application/octet-stream"?r=>r:r=>{if(!e)try{if(r?.[0]===123)return JSON.parse(r)}catch{}return{contentType:e||"application/octet-stream",data:r}}}function F6(e,t){return{[Symbol.asyncIterator](){let r=e[Symbol.asyncIterator]?e[Symbol.asyncIterator]():e[Symbol.iterator]();return{next(){let s=r.next();return s.then?s.then(n=>({value:t(n.value),done:n.done})):{value:t(s.value),done:s.done}},return(s){return r.return(s)},throw(s){return r.throw(s)}}}}}var Yd,AT,Ys,$i,gn,Kd,mP,pP,SP,mu,Dt,OT,fP,TP,B6,H6,EP,zo=Te(()=>{Yd=U(xE()),AT=U($d()),Ys=require("msgpackr"),$i=require("cbor-x"),gn=require("zlib"),Kd=require("stream");hr();mP=require("../../index"),pP=U(X()),SP=U(y()),mu={useRecords:!1,useToJSON:!0},Dt=new Map,OT=Dt;ut.contentTypes=OT;(0,mP._assignPackageExport)("contentTypes",OT);Dt.set("application/json",{serializeStream:Yd.streamAsJSON,serialize:JSON.stringify,deserialize:JSON.parse,q:.8});fP=new $i.Encoder(mu);Dt.set("application/cbor",{serializeStream(e){return e[Symbol.asyncIterator]&&(e[Symbol.iterator]=null),new $i.EncoderStream(mu).end(e)},serialize:fP.encode,deserialize:fP.decode,q:1});Dt.set("application/x-msgpack",{serializeStream(e){return(e?.[Symbol.iterator]||e?.[Symbol.asyncIterator])&&!Array.isArray(e)?Kd.Readable.from((0,Ys.encodeIter)(e,mu)):(0,Ys.pack)(e)},serialize:Ys.pack,deserialize:Ys.unpack,q:.9});Dt.set("text/csv",{serializeStream(e){return this.header("Content-Disposition",'attachment; filename="data.csv"'),(0,AT.toCsvStream)(e)},q:.1});Dt.set("text/plain",{serialize(e){return e.toString()},deserialize(e){return e.toString()},q:.01});Dt.set("text/event-stream",{serializeStream:function(e){return Kd.Readable.from(F6(e,this.serialize))},serialize:function(e){if(e.acknowledge&&e.acknowledge(),typeof e=="object"&&"value"in e&&e.timestamp&&(e={data:e.value,event:e.type,id:e.timestamp}),e.data||e.event){let t="";if(e.event&&(t+="event: "+e.event+`
`),e.data){let r=e.data;typeof r=="object"&&(r=JSON.stringify(r)),t+="data: "+r+`
`}return e.id&&(t+="id: "+e.id+`
`),e.retry&&(t+="retry: "+e.retry+`
`),t+`
`}else return typeof e=="object"?`data: ${JSON.stringify(e)}

`:`data: ${e}

`},q:.8});Dt.set("application/x-www-form-urlencoded",{deserialize(e){let t={};for(let[r,s]of new URLSearchParams(e))if(t.hasOwnProperty(r)){let n=t[r];Array.isArray(n)?n.push(s):t.key=[n,s]}else t[r]=s},serialize(e){let t=new URLSearchParams;for(let r in e)t.set(r,e);return t.toString()}});TP={type:"application/json",serializeStream:Yd.streamAsJSON,serialize:JSON.stringify,deserialize:v6,q:.8};Dt.set("*/*",TP);Dt.set("",TP);a(v6,"tryJSONParse");a(NT,"registerContentHandlers");B6=require("fastify-plugin"),H6=B6(function(e,t,r){e.addHook("preSerialization",async(s,n)=>{if(n.raw.getHeader("content-type"))return;let{serializer:o,type:c}=Wd(s.raw);n.type(c),n.serializer(o.serializeStream||o.serialize)}),r()},{name:"content-type-negotiation"});a(Wd,"findBestSerializer");EP=pP.default.get(SP.CONFIG_PARAMS.HTTP_COMPRESSIONTHRESHOLD);a(Qd,"serialize");a(si,"serializeMessage");a(q6,"streamToBuffer");a(ra,"getDeserializer");a(hP,"deserializerUnknownType");a(F6,"transformIterable")});var zd={};qe(zd,{start:()=>k6});async function x6(e,t){let r=e.headers.asObject,s=r.accept==="text/event-stream"?"CONNECT":e.method;e.search&&hl(e);let n=new ri;try{e.responseHeaders=n;let i=e.url.slice(1),o=yT.getMatch(i);if(!o)return t(e);e.handlerPath=o.path;let c={url:o.relativeURL,async:!0},u=o.Resource,_=r["cache-control"];if(_){_=_.toLowerCase();let S=_.match(/max-age=(\d+)/)?.[1];S&&(e.expiresAt=S*1e3+Date.now()),_.includes("only-if-cached")&&(e.onlyIfCached=!0),_.includes("no-cache")&&(e.noCache=!0),_.includes("no-store")&&(e.noCacheStore=!0),_.includes("stale-if-error")&&(e.staleIfError=!0),_.includes("must-revalidate")&&(e.mustRevalidate=!0)}let l=await Ge(e,()=>{if(s==="POST"||s==="PUT"||s==="PATCH"||s==="QUERY")try{e.data=ra(r["content-type"],!0)(e.body)}catch(S){throw new Su.ClientError(S,400)}switch(e.authorize=!0,s){case"GET":case"HEAD":return u.get(c,e);case"POST":return u.post(c,e.data,e);case"PUT":return u.put(c,e.data,e);case"DELETE":return u.delete(c,e);case"PATCH":return u.patch(c,e.data,e);case"OPTIONS":n.setIfNone("Allow","GET, HEAD, POST, PUT, DELETE, PATCH, OPTIONS, TRACE, QUERY, COPY, MOVE");return;case"CONNECT":return u.connect(c,null,e);case"TRACE":return"HarperDB is the terminating server";case"QUERY":return u.query(c,e.data,e);case"COPY":return u.copy(c,r.destination,e);case"MOVE":return u.move(c,r.destination,e);case"BREW":throw new Su.ClientError("HarperDB is short and stout and can't brew coffee",418);default:throw new Su.ServerError(`Method ${s} is not recognized`,501)}}),d=200,f;if(l==null)d=s==="GET"||s==="HEAD"?404:204,bT.lastModified&&e.lastModified&&n.setIfNone("Last-Modified",new Date(e.lastModified).toUTCString());else if(f=e.lastModified){G6[0]=f;let S=String.fromCharCode(34,(Ut[0]&63)+62,(Ut[0]>>6)+(Ut[1]<<2&63)+62,(Ut[1]>>4)+(Ut[2]<<4&63)+62,(Ut[2]>>2)+62,(Ut[3]&63)+62,(Ut[3]>>6)+(Ut[4]<<2&63)+62,(Ut[4]>>4)+(Ut[5]<<4&63)+62,(Ut[5]>>2)+62,(Ut[6]&63)+62,(Ut[6]>>6)+(Ut[7]<<2&63)+62,34),p=r["if-none-match"];p&&S==p?(l?.onDone&&l.onDone(),d=304,l=void 0):n.setIfNone("ETag",S),bT.lastModified&&n.setIfNone("Last-Modified",new Date(f).toUTCString())}e.createdResource&&(d=201),e.newLocation&&n.setIfNone("Location",e.newLocation);let E={status:d,headers:n,body:void 0},h=l?.wasLoadedFromSource?.();return h!==void 0&&(E.wasCacheMiss=h,!h&&f&&n.setIfNone("Age",Math.round((Date.now()-(e.lastRefreshed||f))/1e3))),l!==void 0&&(E.body=Qd(l,e,E),s==="HEAD"&&(E.body=void 0)),E}catch(i){i.statusCode?i.statusCode===500?Yi.warn(i):Yi.info(i):Yi.error(i),i.statusCode===405&&(i.method&&(i.message+=` to handle HTTP method ${i.method.toUpperCase()||""}`),i.allow&&(i.allow.push("trace","head","options"),n.setIfNone("Allow",i.allow.map(c=>c.toUpperCase()).join(", "))));let o={status:i.statusCode||500,headers:n,body:void 0};return o.body=Qd(i.contentType?i:i.toString(),e,o),o}}function k6(e){bT=e,!RP&&(RP=!0,yT=e.resources,e.server.http(async(t,r)=>{if(!t.isWebSocket)return x6(t,r)}),e.server.ws(async(t,r,s)=>{pu++;let n=new ts;AP||(AP=!0,yc(l=>{pu>0&&l.push({metric:"ws-connections",connections:pu,byThread:!0})}));let i;t.on("error",l=>{i=!0,Yi.warn(l)});let o;t.on("message",a(function(d){o||(o=ra(r.headers.asObject["content-type"]));let f=o(d);n.push(f)},"message"));let c;t.on("close",()=>{pu--,xr(!i,"connection","ws","disconnect"),n.emit("close"),c&&c.return()}),await s;let u=r.url.slice(1),_=yT.getMatch(u);if(xr(!!_,"connection","ws","connect"),!_)t.send(si(`No resource was found to handle ${r.pathname}`,r));else{r.handlerPath=_.path,br(h=>({count:h.count,total:pu}),"connections",r.handlerPath,"connect","ws");let l={url:_.relativeURL,async:!0},d=_.Resource;c=(await Ge(r,()=>d.connect(l,n,r)))[Symbol.asyncIterator]();let E;for(;!(E=await c.next()).done;){let h=si(E.value,r);t.send(h),br(h.length,"bytes-sent",r.handlerPath,"message","ws")}}t.close()}))}var Yi,Su,Ut,G6,bT,RP,yT,AP,pu,OP=Te(()=>{zo();_n();Yi=U(G()),Su=U(j());ml();Ba();Ei();Ad();Ut=new Uint8Array(8),G6=new Float64Array(Ut.buffer,0,1),bT={};a(x6,"http");pu=0;a(k6,"start")});var IT=T((Ude,NP)=>{var{recordAction:Jd,recordActionBinary:V6}=(_n(),Z(Ic)),$6=require("fastify-plugin"),Y6=200;NP.exports=$6(function(e,t,r){e.addHook("onResponse",async(s,n)=>{n.getResponseTime()}),e.addHook("onSend",async(s,n,i)=>{let o=n.getResponseTime(),c=performance.now(),u=n.context.config,_,l,d;u.isOperation?(_=s.body?.operation,l="operation"):(_=u.url,l="fastify-route",d=u.method),Jd(o,"duration",_,d,l),V6(n.raw.statusCode<400,"success",_,d,l);let f=Y6;i?.pipe?(i.on("data",h=>{f+=h.length}),i.on("end",()=>{Jd(performance.now()-c,"transfer",_,d,l),Jd(f,"bytes-sent",_,d,l)})):(f+=i?.length||0,Jd(f,"bytes-sent",_,d,l));let E=o.toFixed(3);n.header("Server-Timing",`db;dur=${E}`)}),r()},{name:"hdb-request-time"})});var DT=T((Mde,CP)=>{var tf=require("clone"),rf=ke(),K6=$(),Zd=y(),W6=G(),Xd=require("fs"),wT=require("joi"),{string:ef}=wT.types(),{hdb_errors:Q6,handleHDBError:Tu}=j(),{HDB_ERROR_MSGS:z6,HTTP_STATUS_CODES:jd}=Q6,{common_validators:sa}=Ds(),bP=1e9,yP=" is required",J6=["insert","update","upsert"],CT={database:{presence:!1,format:sa.schema_format,length:sa.schema_length},schema:{presence:!1,format:sa.schema_format,length:sa.schema_length},table:{presence:!0,format:sa.schema_format,length:sa.schema_length},action:{inclusion:{within:J6,message:"is required and must be either insert, update, or upsert"}},file_path:{},csv_url:{url:{allowLocal:!0}},data:{},passthrough_headers:{}},X6={schema:ef.required(),table:ef.required(),action:ef.valid("insert","update","upsert")},{AWS_ACCESS_KEY:j6,AWS_SECRET:Z6,AWS_BUCKET:e9,AWS_FILE_KEY:t9,REGION:r9}=Zd.S3_BUCKET_AUTH_KEYS,s9={s3:{presence:!0},[`s3.${j6}`]:{presence:!0,type:"String"},[`s3.${Z6}`]:{presence:!0,type:"String"},[`s3.${e9}`]:{presence:!0,type:"String"},[`s3.${t9}`]:{presence:!0,type:"String",hasValidFileExt:[".csv",".json"]},[`s3.${r9}`]:{presence:!0,type:"String"}},IP=tf(CT);IP.data.presence={message:yP};var wP=tf(CT);wP.file_path.presence={message:yP};var n9=Object.assign(tf(CT),s9),LT=tf(X6);LT.csv_url=ef.uri().messages({"string.uri":"'csv_url' must be a valid url"}).required();LT.passthrough_headers=wT.object();function i9(e){let t=rf.validateObject(e,IP);return sf(e,t)}a(i9,"dataObject");function o9(e){let t=rf.validateBySchema(e,wT.object(LT));return sf(e,t)}a(o9,"urlObject");function a9(e){let t=rf.validateObject(e,wP);return sf(e,t)}a(a9,"fileObject");function c9(e){let t=rf.validateObject(e,n9);return sf(e,t)}a(c9,"s3FileObject");function sf(e,t){if(!t){let r=K6.checkGlobalSchemaTable(e.schema,e.table);if(r)return Tu(new Error,r,jd.BAD_REQUEST);if(e.operation===Zd.OPERATIONS_ENUM.CSV_FILE_LOAD){try{Xd.accessSync(e.file_path,Xd.constants.R_OK|Xd.constants.F_OK)}catch(s){return s.code===Zd.NODE_ERROR_CODES.ENOENT?Tu(s,`No such file or directory ${s.path}`,jd.BAD_REQUEST):s.code===Zd.NODE_ERROR_CODES.EACCES?Tu(s,`Permission denied ${s.path}`,jd.BAD_REQUEST):Tu(s)}try{let s=Xd.statSync(e.file_path).size;if(s>bP)return Tu(new Error,z6.MAX_FILE_SIZE_ERR(s,bP),jd.BAD_REQUEST)}catch(s){W6.error(s),console.error(s)}}}return t}a(sf,"postValidateChecks");CP.exports={dataObject:i9,urlObject:o9,fileObject:a9,s3FileObject:c9}});var UT=T((vde,LP)=>{"use strict";var gu=G(),nf=y();async function u9(e,t,r,s=void 0){if(!e||typeof e!="function")throw new Error("Invalid function parameter");let n;try{return n=await e(t),r&&await r(t,n,s),t.operation===nf.OPERATIONS_ENUM.INSERT||t.operation===nf.OPERATIONS_ENUM.UPDATE||t.operation===nf.OPERATIONS_ENUM.UPSERT?(delete n.new_attributes,delete n.txn_time):t.operation===nf.OPERATIONS_ENUM.DELETE&&delete n.txn_time,n}catch(i){throw i.message&&typeof i.message=="string"&&i.message.includes("already exists")?(gu.info(i.message),i):i.http_resp_msg?(gu.error(`Error calling operation: ${e.name}`),gu.error(i.http_resp_msg),i):(gu.error(`Error calling operation: ${e.name}`),gu.error(i),i)}}a(u9,"callOperationFunctionAsAwait");LP.exports={callOperationFunctionAsAwait:u9}});var UP=T((Hde,DP)=>{"use strict";var MT=class{static{a(this,"BulkLoadFileObject")}constructor(t,r,s,n,i,o,c=null){this.op=t,this.action=r,this.schema=s,this.table=n,this.file_path=i,this.file_type=o,this.role_perms=c}},PT=class{static{a(this,"BulkLoadDataObject")}constructor(t,r,s,n){this.action=t,this.schema=r,this.table=s,this.data=n}};DP.exports={BulkLoadFileObject:MT,BulkLoadDataObject:PT}});var PP=T((Fde,MP)=>{"use strict";var vT=class{static{a(this,"ClusteringOriginObject")}constructor(t,r,s){this.timestamp=t,this.user=r,this.node_name=s}};MP.exports=vT});var xT=T((Yde,XP)=>{"use strict";var of=Fr(),cf=DT(),l9=require("needle"),ps=y(),xde=Ve(),na=$(),{handleHDBError:Ye,hdb_errors:VP}=j(),{HTTP_STATUS_CODES:Mt,HDB_ERROR_MSGS:ft,CHECK_LOGS_WRAPPER:Wi}=VP,ia=G(),BT=require("papaparse");na.promisifyPapaParse();var Ss=require("fs-extra"),_9=require("path"),{chain:vP}=require("stream-chain"),BP=require("stream-json/streamers/StreamArray"),HP=require("stream-json/utils/Batch"),qP=require("stream-chain/utils/comp"),{finished:FP}=require("stream"),d9=X(),$P=UT(),f9=gT(),{BulkLoadFileObject:qT,BulkLoadDataObject:E9}=UP(),FT=lT(),{verifyBulkLoadAttributePerms:YP}=xd(),kde=PP(),Vde=_t(),$de=nn(),{databases:h9}=(fe(),Z(Ce)),{coerceType:m9}=(uf(),Z(kT)),GP="No records parsed from csv file.",Ki=`${d9.get("HDB_ROOT")}/tmp`,{schema_regex:p9}=Ds(),xP=1024*1024*2,kP=5e3,S9={"text/csv":!0,"application/octet-stream":!0,"text/plain":!0,"application/vnd.ms-excel":!0};XP.exports={csvDataLoad:T9,csvURLLoad:g9,csvFileLoad:R9,importFromS3:A9};async function T9(e,t){let r=cf.dataObject(e);if(r)throw Ye(r,r.message,Mt.BAD_REQUEST,void 0,void 0,!0);let s={};try{let n=QP(e.schema,e.table),i=BT.parse(e.data,{header:!0,skipEmptyLines:!0,transform:HT.bind(null,n),dynamicTyping:!1}),o=new FT;e.hdb_user&&e.hdb_user.role&&e.hdb_user.role.permission&&e.hdb_user.role.permission.super_user!==!0&&YP(e.hdb_user.role.permission,this.job_operation_function.name,e.action,e.schema,e.table,i.meta.fields,o);let c=o.getPermsResponse();if(c)throw Ye(new Error,c,Mt.BAD_REQUEST,void 0,void 0,!0);let u=new E9(e.action,e.schema,e.table,i.data);return s=await $P.callOperationFunctionAsAwait(zP,u,null),s.message===GP?GP:JP(s.records,s.number_written)}catch(n){throw Qi(n)}}a(T9,"csvDataLoad");async function g9(e){let t=cf.urlObject(e);if(t)throw Ye(t,t.message,Mt.BAD_REQUEST,void 0,void 0,!0);let r=`${Date.now()}.csv`,s=`${Ki}/${r}`;try{await O9(e,r)}catch(n){throw ia.error(ft.DOWNLOAD_FILE_ERR(r)+" - "+n),Ye(n,Wi(ft.DOWNLOAD_FILE_ERR(r)))}try{let n=new qT(this.job_operation_function.name,e.action,e.schema,e.table,s,ps.VALID_S3_FILE_TYPES.CSV,e.hdb_user.role.permission),i=await GT(n);return await af(s),i}catch(n){throw await af(s),Qi(n)}}a(g9,"csvURLLoad");async function R9(e){let t=cf.fileObject(e);if(t)throw Ye(t,t.message,Mt.BAD_REQUEST,void 0,void 0,!0);let r=new qT(this.job_operation_function.name,e.action,e.schema,e.table,e.file_path,ps.VALID_S3_FILE_TYPES.CSV,e.hdb_user.role.permission);try{return await GT(r)}catch(s){throw Qi(s)}}a(R9,"csvFileLoad");async function A9(e){let t=cf.s3FileObject(e);if(t)throw Ye(t,t.message,Mt.BAD_REQUEST,void 0,void 0,!0);let r;try{let s=_9.extname(e.s3.key),n=`${Date.now()}${s}`;r=`${Ki}/${n}`;let i=new qT(this.job_operation_function.name,e.action,e.schema,e.table,r,s,e.hdb_user.role.permission);await N9(n,e);let o=await GT(i);return await af(r),o}catch(s){throw await af(r),Qi(s)}}a(A9,"importFromS3");async function O9(e,t){let r;try{let s=e.passthrough_headers?{headers:e.passthrough_headers}:void 0;r=await l9("get",e.csv_url,s)}catch(s){let n=`Error downloading CSV file from ${e.csv_url}, status code: ${s.statusCode}. Check the log for more information.`;throw Ye(s,n,s.statusCode,ps.LOG_LEVELS.ERROR,"Error downloading CSV file - "+s)}y9(r,e.csv_url),await b9(t,r.raw)}a(O9,"downloadCSVFile");async function N9(e,t){try{let r=`${Ki}/${e}`;await Ss.mkdirp(Ki),await Ss.writeFile(`${Ki}/${e}`,"",{flag:"a+"});let s=await Ss.createWriteStream(r),n=await f9.getFileStreamFromS3(t);await new Promise((i,o)=>{n.on("error",function(c){o(c)}),n.pipe(s).on("error",function(c){o(c)}).on("close",function(){ia.info(`${t.s3.key} successfully downloaded to ${r}`),i()})})}catch(r){throw ia.error(ft.S3_DOWNLOAD_ERR+" - "+r),Ye(r,Wi(ft.S3_DOWNLOAD_ERR))}}a(N9,"downloadFileFromS3");async function b9(e,t){try{await Ss.mkdirp(Ki),await Ss.writeFile(`${Ki}/${e}`,t)}catch(r){throw ia.error(ft.WRITE_TEMP_FILE_ERR),Ye(r,Wi(ft.DEFAULT_BULK_LOAD_ERR))}}a(b9,"writeFileToTempFolder");async function af(e){if(e)try{await Ss.access(e),await Ss.unlink(e)}catch{ia.warn(`could not delete temp csv file at ${e}, file does not exist`)}}a(af,"deleteTempFile");function y9(e,t){if(e.statusCode!==VP.HTTP_STATUS_CODES.OK)throw Ye(new Error,`CSV Load failed from URL: ${t}, status code: ${e.statusCode}, message: ${e.statusMessage}`,Mt.BAD_REQUEST);if(!S9[e.headers["content-type"]])throw Ye(new Error,`CSV Load failed from URL: ${t}, unsupported content type: ${e.headers["content-type"]}`,Mt.BAD_REQUEST);if(!e.raw)throw Ye(new Error,`CSV Load failed from URL: ${t}, no csv found at url`,Mt.BAD_REQUEST)}a(y9,"validateURLResponse");async function GT(e){try{let t;switch(e.file_type){case ps.VALID_S3_FILE_TYPES.CSV:t=await I9(e);break;case ps.VALID_S3_FILE_TYPES.JSON:t=await w9(e);break;default:throw Ye(new Error,ft.DEFAULT_BULK_LOAD_ERR,Mt.BAD_REQUEST,ps.LOG_LEVELS.ERROR,ft.INVALID_FILE_EXT_ERR(e))}return JP(t.records,t.number_written)}catch(t){throw Qi(t)}}a(GT,"fileLoad");async function KP(e,t,r,s,n){let i=s.data?s.data:s;if(i.length===0)return;n&&n.pause();let o={operation:e.action,schema:e.schema,table:e.table,records:i};try{let{attributes:c}=await of.validation(o);e.role_perms&&e.role_perms.super_user!==!0&&YP(e.role_perms,e.op,e.action,e.schema,e.table,c,t),n&&n.resume()}catch(c){let u=Ye(c);r(u)}}a(KP,"validateChunk");async function WP(e,t,r,s,n){let i=s.data?s.data:s;if(i.length===0)return;na.autoCastJSONDeep(i),n&&n.pause();let o=s.meta?s.meta.fields:null;if(o)i.forEach(c=>{!na.isEmpty(c)&&!na.isEmpty(c.__parsed_extra)&&delete c.__parsed_extra});else{let c=new Set;i.forEach(u=>{Object.keys(u).forEach(_=>c.add(_))}),o=[...c]}try{let c={schema:e.schema,table:e.table,action:e.action,data:i},u=await $P.callOperationFunctionAsAwait(zP,c,null);t.records+=u.records,t.number_written+=u.number_written,n&&n.resume()}catch(c){let u=Ye(c,Wi(ft.INSERT_CSV_ERR),Mt.INTERNAL_SERVER_ERROR,ps.LOG_LEVELS.ERROR,ft.INSERT_CSV_ERR+" - "+c);r(u)}}a(WP,"insertChunk");async function I9(e){let t={records:0,number_written:0},r=QP(e.schema,e.table);try{let s=new FT,n=Ss.createReadStream(e.file_path,{highWaterMark:xP});n.setEncoding("utf8"),await BT.parsePromise(n,KP.bind(null,e,s),HT.bind(null,r));let i=s.getPermsResponse();if(i)throw Ye(new Error,i,Mt.BAD_REQUEST);return n=Ss.createReadStream(e.file_path,{highWaterMark:xP}),n.setEncoding("utf8"),await BT.parsePromise(n,WP.bind(null,e,t),HT.bind(null,r)),n.destroy(),t}catch(s){throw Ye(s,Wi(ft.PAPA_PARSE_ERR),Mt.INTERNAL_SERVER_ERROR,ps.LOG_LEVELS.ERROR,ft.PAPA_PARSE_ERR+s)}}a(I9,"callPapaParse");function QP(e,t){let r=h9[e][t].attributes,s=new Map;for(let n of r)n.type&&s.set(n.name,i=>m9(i,n));return s}a(QP,"createTransformMap");function HT(e,t,r){let s=e.get(r);return s?s(t):na.autoCast(t)}a(HT,"typeFunction");async function w9(e){let t={records:0,number_written:0},r=a(s=>{throw s},"throwErr");try{let s=new FT,n=vP([Ss.createReadStream(e.file_path,{encoding:"utf-8"}),BP.withParser(),c=>c.value,new HP({batchSize:kP}),qP(async c=>{await KP(e,s,r,c)})]);await new Promise((c,u)=>{FP(n,_=>{_?u(_):c()}),n.resume()});let i=s.getPermsResponse();if(i)throw Ye(new Error,i,Mt.BAD_REQUEST);let o=vP([Ss.createReadStream(e.file_path,{encoding:"utf-8"}),BP.withParser(),c=>c.value,new HP({batchSize:kP}),qP(async c=>{await WP(e,t,r,c)})]);return await new Promise((c,u)=>{FP(o,_=>{_?u(_):c()}),o.resume()}),t}catch(s){throw Ye(s,Wi(ft.INSERT_JSON_ERR),Mt.INTERNAL_SERVER_ERROR,ps.LOG_LEVELS.ERROR,ft.INSERT_JSON_ERR+s)}}a(w9,"insertJson");async function zP(e){let t={};try{e.data&&e.data.length>0&&C9(e.data[0])?t=await L9(e.data,e.schema,e.table,e.action):(t.message="No records parsed from csv file.",ia.info(t.message))}catch(r){throw Qi(r)}return t}a(zP,"callBulkFileLoad");function C9(e){let t=Object.keys(e);for(let r of t)if(!p9.test(r))throw new Error(`Invalid column name '${r}', cancelling load operation`);return!0}a(C9,"validateColumnNames");async function L9(e,t,r,s){s||(s="insert");let n={operation:s,schema:t,table:r,records:e},i;switch(s){case"insert":i=of.insert;break;case"update":i=of.update;break;case"upsert":i=of.upsert;break;default:throw Ye(new Error,ft.INVALID_ACTION_PARAM_ERR(s),Mt.BAD_REQUEST,ps.LOG_LEVELS.ERROR,ft.INVALID_ACTION_PARAM_ERR(s))}try{let o=await i(n),c;switch(s){case"insert":c=o.inserted_hashes;break;case"update":c=o.update_hashes;break;case"upsert":c=o.upserted_hashes;break;default:break}if(Array.isArray(o.skipped_hashes)&&o.skipped_hashes.length>0){let l=global.hdb_schema[t][r].hash_attribute,d=e.length;for(;d--;)o.skipped_hashes.indexOf(e[d][l])>=0&&e.splice(d,1)}let u=na.isEmptyOrZeroLength(c)?0:c.length;return{records:e.length,number_written:u,new_attributes:o.new_attributes}}catch(o){throw Qi(o)}}a(L9,"bulkFileLoad");function JP(e,t){return`successfully loaded ${t} of ${e} records`}a(JP,"buildResponseMsg");function Qi(e){return Ye(e,Wi(ft.DEFAULT_BULK_LOAD_ERR),Mt.INTERNAL_SERVER_ERROR,ps.LOG_LEVELS.ERROR,ft.DEFAULT_BULK_LOAD_ERR+" - "+e)}a(Qi,"buildTopLevelErrMsg")});var ZP=T((Wde,jP)=>{"use strict";var VT=class{static{a(this,"SqlSearchObject")}constructor(t,r){this.operation="sql",this.sql=t,this.hdb_user=r}};jP.exports=VT});var rv=T((zde,tv)=>{"use strict";var D9=y(),ev=require("moment"),U9=require("uuid").v4,$T=class{static{a(this,"JobObject")}constructor(){this.id=U9(),this.type=void 0,this.start_datetime=ev().valueOf(),this.created_datetime=ev().valueOf(),this.end_datetime=void 0,this.status=D9.JOB_STATUS_ENUM.CREATED,this.message=void 0,this.user=void 0,this.request=void 0}};tv.exports=$T});var YT=T((Xde,cv)=>{"use strict";var M9=require("uuid").v4,iv=Fr(),ov=qr(),P9=Bs(),v9=yo(),B9=ZP(),Ke=y(),H9=rv(),q9=Gp(),zr=G(),F9=ja(),oa=$(),{promisify:G9}=require("util"),zi=require("moment"),x9=Vd(),lf=DT(),sv=qh(),{deleteTransactionLogsBeforeValidator:k9}=iT(),{handleHDBError:V9,hdb_errors:$9}=j(),{HTTP_STATUS_CODES:Y9}=$9,nv=ov.searchByValue,K9=ov.searchByHash,W9=iv.insert,Q9=G9(x9.evaluateSQL),z9=iv.update;cv.exports={addJob:j9,updateJob:e7,handleGetJob:J9,handleGetJobsByStartDate:X9,getJobById:av};async function J9(e){try{let t=await av(e.id);return oa.isEmptyOrZeroLength(t)||(t[0]={...t[0]},t[0].request!==void 0&&delete t[0].request,delete t[0].__createdtime__,delete t[0].__updatedtime__),t}catch(t){let r=`There was an error getting job: ${t}`;throw zr.error("There was an error getting job",t),new Error(r)}}a(J9,"handleGetJob");async function X9(e){try{let t=await Z9(e);if(zr.trace(`Searching for jobs from ${e.from_date} to ${e.to_date}`),t&&t.length>0)for(let r of t)r.start_datetime&&(r.start_datetime_converted=zi(r.start_datetime)),r.end_datetime&&(r.end_datetime_converted=zi(r.end_datetime)),r.request!==void 0&&delete r.request,delete r.__createdtime__,delete r.__updatedtime__;return t}catch(t){let r=`There was an error searching jobs by date: ${t}`;throw zr.error(r),new Error(r)}}a(X9,"handleGetJobsByStartDate");async function j9(e){let t={message:"",error:"",success:!1,createdJob:void 0};if(!e||Object.keys(e).length===0||oa.isEmptyOrZeroLength(e.operation)){let l="job parameter is invalid";return zr.info(l),t.error=l,t}if(!Ke.JOB_TYPE_ENUM[e.operation])return zr.info(`invalid job type specified: ${e.operation}.`),t;let r=e.operation,s;switch(r){case Ke.OPERATIONS_ENUM.CSV_FILE_LOAD:s=lf.fileObject(e);break;case Ke.OPERATIONS_ENUM.CSV_URL_LOAD:s=lf.urlObject(e);break;case Ke.OPERATIONS_ENUM.CSV_DATA_LOAD:s=lf.dataObject(e);break;case Ke.OPERATIONS_ENUM.IMPORT_FROM_S3:s=lf.s3FileObject(e);break;case Ke.OPERATIONS_ENUM.DELETE_FILES_BEFORE:case Ke.OPERATIONS_ENUM.DELETE_RECORDS_BEFORE:s=sv(e,"date");break;case Ke.OPERATIONS_ENUM.DELETE_AUDIT_LOGS_BEFORE:s=sv(e,"timestamp");break;case Ke.OPERATIONS_ENUM.DELETE_TRANSACTION_LOGS_BEFORE:s=k9(e);break;default:break}if(s)throw V9(s,s.message,Y9.BAD_REQUEST,void 0,void 0,!0);let n=new H9;n.type=e.operation===Ke.OPERATIONS_ENUM.DELETE_RECORDS_BEFORE?Ke.OPERATIONS_ENUM.DELETE_FILES_BEFORE:e.operation,n.type=e.operation,n.user=e.hdb_user.username;let i=new P9(Ke.SYSTEM_SCHEMA_NAME,Ke.SYSTEM_TABLE_NAMES.JOB_TABLE_NAME,"id",n.id,"id",["id"]),o;try{o=Array.from(await nv(i))}catch(l){let d=`There was an error inserting a new job: ${l}`;return zr.error(d),t}let c=Array.isArray(o)?o:Object.keys(o);if(c&&c.length>0){n.id=M9();try{o=await nv(i)}catch(l){let d=`There was an error inserting a new job: ${l}`;return zr.error(d),t}if(c=Array.isArray(o)?o:Object.keys(o),c&&c.length>0)return zr.error("Error creating a job, could not find a unique job id."),t}n.request=e;let u=new F9(Ke.SYSTEM_SCHEMA_NAME,Ke.SYSTEM_TABLE_NAMES.JOB_TABLE_NAME,"id",[n]),_;try{_=await W9(u)}catch(l){return zr.error(`There was an error inserting a job for job type: ${e.operation} -- ${l}`),t.success=!1,t}if(_.inserted_hashes.length===0)t.message=`Had a problem creating a job with type ${n.operation} and id ${n.id}`;else{let l=`Created a job with type ${n.type} and id ${n.id}`;t.message=l,t.createdJob=n,t.success=!0,zr.trace(l)}return t}a(j9,"addJob");async function Z9(e){let t=zi(e.from_date,zi.ISO_8601),r=zi(e.to_date,zi.ISO_8601);if(!t.isValid())throw new Error("Invalid 'from' date, must be in ISO-8601 format (YYYY-MM-DD).");if(!r.isValid())throw new Error("Invalid 'to' date, must be in ISO-8601 format (YYYY-MM-DD)");let s=`select * from system.hdb_job where start_datetime > '${t.valueOf()}' and start_datetime < '${r.valueOf()}'`,n=new B9(s,e.hdb_user);try{return await Q9(n)}catch(i){throw zr.error(`there was a problem searching for jobs from date ${e.from_date} to date ${e.to_date} ${i}`),new Error("there was an error searching for jobs.  Please check the log for details.")}}a(Z9,"getJobsInDateRange");async function av(e){if(oa.isEmptyOrZeroLength(e))return oa.errorizeMessage("Invalid job ID specified.");let t=new v9(Ke.SYSTEM_SCHEMA_NAME,Ke.SYSTEM_TABLE_NAMES.JOB_TABLE_NAME,[e],["*"]);try{return await K9(t)}catch(r){let s=`There was an error searching for a job by id: ${e} ${r}`;return zr.error(s),oa.errorizeMessage("there was an error searching for jobs.  Please check the log for details.")}}a(av,"getJobById");async function e7(e){if(Object.keys(e).length===0)throw new Error("invalid job object passed to updateJob");if(oa.isEmptyOrZeroLength(e.id))throw new Error("invalid ID passed to updateJob");(e.status===Ke.JOB_STATUS_ENUM.COMPLETE||e.status===Ke.JOB_STATUS_ENUM.ERROR)&&(e.end_datetime=zi().valueOf());let t=new q9(Ke.SYSTEM_SCHEMA_NAME,Ke.SYSTEM_TABLE_NAMES.JOB_TABLE_NAME,[e]),r;return r=await z9(t),r}a(e7,"updateJob")});var Ev=T((Zde,fv)=>{"use strict";var uv=$(),ur=y(),t7=require("moment"),_f=xT(),df=G(),lv=YT(),_v=$d(),dv=bi(),r7=Je(),s7=Hd(),KT=class{static{a(this,"RunnerMessage")}constructor(t,r){this.job=t,this.json=r}};async function n7(e){if(!e||Object.keys(e).length===0)throw new Error("Empty runner passed to parseMessage");if(!e.json||Object.keys(e.json).length===0)throw new Error("Empty JSON passed to parseMessage");if(!e.job||Object.keys(e.job).length===0)throw new Error("Empty job passed to parseMessage");if(uv.isEmptyOrZeroLength(e.json.operation))throw new Error("Invalid operation");if(uv.isEmptyOrZeroLength(e.job.id))throw new Error("Empty job id specified");switch(e.json.operation){case ur.JOB_TYPE_ENUM.csv_file_load:await Rn(e,_f.csvFileLoad);break;case ur.JOB_TYPE_ENUM.csv_url_load:await Rn(e,_f.csvURLLoad);break;case ur.JOB_TYPE_ENUM.csv_data_load:await Rn(e,_f.csvDataLoad);break;case ur.JOB_TYPE_ENUM.import_from_s3:await Rn(e,_f.importFromS3);break;case ur.JOB_TYPE_ENUM.empty_trash:break;case ur.JOB_TYPE_ENUM.export_local:await Rn(e,_v.export_local);break;case ur.JOB_TYPE_ENUM.export_to_s3:await Rn(e,_v.export_to_s3);break;case ur.JOB_TYPE_ENUM.delete_files_before:case ur.JOB_TYPE_ENUM.delete_records_before:await Rn(e,dv.deleteFilesBefore);break;case ur.JOB_TYPE_ENUM.delete_audit_logs_before:await Rn(e,dv.deleteAuditLogsBefore);break;case ur.JOB_TYPE_ENUM.delete_transaction_logs_before:await Rn(e,s7.deleteTransactionLogsBefore);break;default:return`Invalid operation ${e.json.operation} specified`}}a(n7,"parseMessage");async function Rn(e,t){try{e.job.status=ur.JOB_STATUS_ENUM.IN_PROGRESS,e.job.start_datetime=t7().valueOf(),await lv.updateJob(e.job),await i7(e.job.id)}catch(r){let s=r.message!==void 0?r.message:r;typeof s=="string"?(s=`There was an error running ${t.name} job with id ${e.job.id} - ${s}`,r.message=s):df.error(`There was an error running ${t.name} job with id ${e.job.id}`),df.error(s),e.job.message=s,e.job.status=ur.JOB_STATUS_ENUM.ERROR;try{await lv.updateJob(e.job)}catch(n){throw df.error(`Unable to update job with id ${e.job.id}`),n}throw r}}a(Rn,"runJob");async function i7(e){df.trace("launching job thread:",e),r7.startWorker("server/jobs/jobProcess.js",{autoRestart:!1,name:"job",env:Object.assign({},process.env,{[ur.PROCESS_NAME_ENV_PROP]:`JOB-${e}`})})}a(i7,"launchJobThread");fv.exports={parseMessage:n7,RunnerMessage:KT}});var mv=T((tfe,hv)=>{"use strict";var WT=class{static{a(this,"OperationFunctionObject")}constructor(t,r=void 0){this.operation_function=t,this.job_operation_function=r}};hv.exports=WT});var Uv=T((sfe,ZT)=>{"use strict";var mf=qr(),JT=Vd(),ff=xT(),An=v_(),Ef=gi(),Au=bi(),o7=bp(),Ru=Gr(),hf=Pp(),Pt=nT(),Et=G(),a7=Hp(),c7=Z_(),u7=SS(),l7=sd(),_7=TS(),d7=gS(),f7=OS(),E7=bS(),QT=wS(),pv=$d(),h7=xd(),XT=YT(),M=y(),{hdb_errors:Nu,handleHDBError:Ou}=j(),{HTTP_STATUS_CODES:Sv}=Nu,zT=MS(),Tv=gd(),wv=require("util"),aa=Fr(),m7=qn(),p7=xo(),gv=Ev(),Rv=Hc(),Av=(yd(),Z(su)),Ov=gr(),Nv=Hd(),bv=Dd(),{setServerUtilities:S7}=(uf(),Z(kT)),{CONTEXT:T7}=(ss(),Z(UE)),{_assignPackageExport:g7}=require("../../index"),{transformReq:R7}=$(),{server:A7}=(hr(),Z(hi)),O7=UT(),yv=mf.searchByHash,N7=mf.searchByValue,b7=wv.promisify(mf.search),y7=wv.promisify(JT.evaluateSQL),I7={[M.OPERATIONS_ENUM.CREATE_ATTRIBUTE]:!0,[M.OPERATIONS_ENUM.CREATE_TABLE]:!0,[M.OPERATIONS_ENUM.CREATE_SCHEMA]:!0,[M.OPERATIONS_ENUM.DROP_ATTRIBUTE]:!0,[M.OPERATIONS_ENUM.DROP_TABLE]:!0,[M.OPERATIONS_ENUM.DROP_SCHEMA]:!0},H=mv();async function Cv(e,t){try{if(e.body.operation!=="read_log"&&(Et.log_level===M.LOG_LEVELS.INFO||Et.log_level===M.LOG_LEVELS.DEBUG||Et.log_level===M.LOG_LEVELS.TRACE)){let{hdb_user:s,hdb_auth_header:n,password:i,...o}=e.body;Et.info(o)}}catch(s){Et.error(s)}let r=await O7.callOperationFunctionAsAwait(t,e.body,null);if(typeof r!="object"&&(r={message:r}),r instanceof Error)throw r;return I7[e.body.operation]&&m7.setSchemaDataToGlobal(s=>{s&&Et.error(s)}),r}a(Cv,"processLocalTransaction");var Iv=C7();ZT.exports={chooseOperation:Lv,getOperationFunction:Dv,operation:jT,processLocalTransaction:Cv};S7(ZT.exports);A7.operation=jT;function Lv(e){let t;try{t=Dv(e)}catch(n){throw Et.error(`Error when selecting operation function - ${n}`),n}let{operation_function:r,job_operation_function:s}=t;try{if(e.operation==="sql"||e.search_operation&&e.search_operation.operation==="sql"){let n=e.operation==="sql"?e.sql:e.search_operation.sql,i=JT.convertSQLToAST(n);if(e.parsed_sql_object=i,!e.bypass_auth){let o=JT.checkASTPermissions(e,i);if(o)throw Et.error(`${Sv.FORBIDDEN} from operation ${e.operation}`),Et.warn(`User '${e.hdb_user.username}' is not permitted to ${e.operation}`),Ou(new Error,o,Nu.HTTP_STATUS_CODES.FORBIDDEN,void 0,void 0,!0)}}else if(!e.bypass_auth&&e.operation!==M.OPERATIONS_ENUM.CREATE_AUTHENTICATION_TOKENS&&e.operation!==M.OPERATIONS_ENUM.LOGIN&&e.operation!==M.OPERATIONS_ENUM.LOGOUT){let n=s===void 0?r:s,i=e.search_operation?e.search_operation:e;i.hdb_user||(i.hdb_user=e.hdb_user);let o=h7.verifyPerms(i,n);if(o)throw Et.error(`${Sv.FORBIDDEN} from operation ${e.operation}`),Et.warn(`User '${i.hdb_user.username}' is not permitted to ${i.operation}`),Ou(new Error,o,Nu.HTTP_STATUS_CODES.FORBIDDEN,void 0,!1,!0)}}catch(n){throw Ou(n,"There was an error when trying to choose an operation path")}return r}a(Lv,"chooseOperation");function Dv(e){if(Et.trace(`getOperationFunction with operation: ${e.operation}`),Iv.has(e.operation))return Iv.get(e.operation);throw Ou(new Error,Nu.HDB_ERROR_MSGS.OP_NOT_FOUND(e.operation),Nu.HTTP_STATUS_CODES.BAD_REQUEST,void 0,void 0,!0)}a(Dv,"getOperationFunction");g7("operation",jT);function jT(e,t){e.hdb_user=this[T7]?.user,e.bypass_auth=!t;let r=Lv(e);return Cv({body:e},r)}a(jT,"operation");async function w7(e){Et.trace("In serverUtils.catchup");let t=e.transaction,r=t.channel.split(":"),s=r[0],n=r[1];for(let i of t.transactions)try{i.schema=s,i.table=n,i[M.CLUSTERING_FLAG]=!0;let o;switch(i.operation){case M.OPERATIONS_ENUM.INSERT:o=await aa.insert(i);break;case M.OPERATIONS_ENUM.UPDATE:o=await aa.update(i);break;case M.OPERATIONS_ENUM.UPSERT:o=await aa.upsert(i);break;case M.OPERATIONS_ENUM.DELETE:o=await Au.deleteRecord(i);break;default:Et.warn("invalid operation in catchup");break}await transact_to_clustering_utils.postOperationHandler(i,o,e)}catch(o){Et.info("Invalid operation in transaction"),Et.error(o)}}a(w7,"catchup");async function Ks(e){R7(e);let t,r;try{r=await XT.addJob(e),t=r.createdJob,Et.info("addJob result",r);let s=new gv.RunnerMessage(t,e);return await gv.parseMessage(s),{message:`Starting job with id ${t.id}`,job_id:t.id}}catch(s){let n=`There was an error executing job: ${s.http_resp_msg?s.http_resp_msg:s}`;throw Et.error(n),Ou(s,n)}}a(Ks,"executeJob");function C7(){let e=new Map;return e.set(M.OPERATIONS_ENUM.INSERT,new H(aa.insert)),e.set(M.OPERATIONS_ENUM.UPDATE,new H(aa.update)),e.set(M.OPERATIONS_ENUM.UPSERT,new H(aa.upsert)),e.set(M.OPERATIONS_ENUM.SEARCH_BY_CONDITIONS,new H(mf.searchByConditions)),e.set(M.OPERATIONS_ENUM.SEARCH_BY_HASH,new H(yv)),e.set(M.OPERATIONS_ENUM.SEARCH_BY_ID,new H(yv)),e.set(M.OPERATIONS_ENUM.SEARCH_BY_VALUE,new H(N7)),e.set(M.OPERATIONS_ENUM.SEARCH,new H(b7)),e.set(M.OPERATIONS_ENUM.SQL,new H(y7)),e.set(M.OPERATIONS_ENUM.CSV_DATA_LOAD,new H(Ks,ff.csvDataLoad)),e.set(M.OPERATIONS_ENUM.CSV_FILE_LOAD,new H(Ks,ff.csvFileLoad)),e.set(M.OPERATIONS_ENUM.CSV_URL_LOAD,new H(Ks,ff.csvURLLoad)),e.set(M.OPERATIONS_ENUM.IMPORT_FROM_S3,new H(Ks,ff.importFromS3)),e.set(M.OPERATIONS_ENUM.CREATE_SCHEMA,new H(An.createSchema)),e.set(M.OPERATIONS_ENUM.CREATE_DATABASE,new H(An.createSchema)),e.set(M.OPERATIONS_ENUM.CREATE_TABLE,new H(An.createTable)),e.set(M.OPERATIONS_ENUM.CREATE_ATTRIBUTE,new H(An.createAttribute)),e.set(M.OPERATIONS_ENUM.DROP_SCHEMA,new H(An.dropSchema)),e.set(M.OPERATIONS_ENUM.DROP_DATABASE,new H(An.dropSchema)),e.set(M.OPERATIONS_ENUM.DROP_TABLE,new H(An.dropTable)),e.set(M.OPERATIONS_ENUM.DROP_ATTRIBUTE,new H(An.dropAttribute)),e.set(M.OPERATIONS_ENUM.DESCRIBE_SCHEMA,new H(Ef.describeSchema)),e.set(M.OPERATIONS_ENUM.DESCRIBE_DATABASE,new H(Ef.describeSchema)),e.set(M.OPERATIONS_ENUM.DESCRIBE_TABLE,new H(Ef.describeTable)),e.set(M.OPERATIONS_ENUM.DESCRIBE_ALL,new H(Ef.describeAll)),e.set(M.OPERATIONS_ENUM.DELETE,new H(Au.deleteRecord)),e.set(M.OPERATIONS_ENUM.ADD_USER,new H(Ru.addUser)),e.set(M.OPERATIONS_ENUM.ALTER_USER,new H(Ru.alterUser)),e.set(M.OPERATIONS_ENUM.DROP_USER,new H(Ru.dropUser)),e.set(M.OPERATIONS_ENUM.LIST_USERS,new H(Ru.listUsersExternal)),e.set(M.OPERATIONS_ENUM.LIST_ROLES,new H(hf.listRoles)),e.set(M.OPERATIONS_ENUM.ADD_ROLE,new H(hf.addRole)),e.set(M.OPERATIONS_ENUM.ALTER_ROLE,new H(hf.alterRole)),e.set(M.OPERATIONS_ENUM.DROP_ROLE,new H(hf.dropRole)),e.set(M.OPERATIONS_ENUM.USER_INFO,new H(Ru.userInfo)),e.set(M.OPERATIONS_ENUM.READ_LOG,new H(a7)),e.set(M.OPERATIONS_ENUM.ADD_NODE,new H(c7)),e.set(M.OPERATIONS_ENUM.UPDATE_NODE,new H(u7)),e.set(M.OPERATIONS_ENUM.REMOVE_NODE,new H(l7)),e.set(M.OPERATIONS_ENUM.CONFIGURE_CLUSTER,new H(_7)),e.set(M.OPERATIONS_ENUM.PURGE_STREAM,new H(d7)),e.set(M.OPERATIONS_ENUM.SET_CONFIGURATION,new H(Ov.setConfiguration)),e.set(M.OPERATIONS_ENUM.CLUSTER_STATUS,new H(f7.clusterStatus)),e.set(M.OPERATIONS_ENUM.CLUSTER_NETWORK,new H(E7)),e.set(M.OPERATIONS_ENUM.CLUSTER_SET_ROUTES,new H(QT.setRoutes)),e.set(M.OPERATIONS_ENUM.CLUSTER_GET_ROUTES,new H(QT.getRoutes)),e.set(M.OPERATIONS_ENUM.CLUSTER_DELETE_ROUTES,new H(QT.deleteRoutes)),e.set(M.OPERATIONS_ENUM.EXPORT_TO_S3,new H(Ks,pv.export_to_s3)),e.set(M.OPERATIONS_ENUM.DELETE_FILES_BEFORE,new H(Ks,Au.deleteFilesBefore)),e.set(M.OPERATIONS_ENUM.DELETE_RECORDS_BEFORE,new H(Ks,Au.deleteFilesBefore)),e.set(M.OPERATIONS_ENUM.EXPORT_LOCAL,new H(Ks,pv.export_local)),e.set(M.OPERATIONS_ENUM.SEARCH_JOBS_BY_START_DATE,new H(XT.handleGetJobsByStartDate)),e.set(M.OPERATIONS_ENUM.GET_JOB,new H(XT.handleGetJob)),e.set(M.OPERATIONS_ENUM.GET_FINGERPRINT,new H(zT.getFingerprint)),e.set(M.OPERATIONS_ENUM.SET_LICENSE,new H(zT.setLicense)),e.set(M.OPERATIONS_ENUM.GET_REGISTRATION_INFO,new H(zT.getRegistrationInfo)),e.set(M.OPERATIONS_ENUM.RESTART,new H(Tv.restart)),e.set(M.OPERATIONS_ENUM.RESTART_SERVICE,new H(Tv.restartService)),e.set(M.OPERATIONS_ENUM.CATCHUP,new H(w7)),e.set(M.OPERATIONS_ENUM.SYSTEM_INFORMATION,new H(p7.systemInformation)),e.set(M.OPERATIONS_ENUM.DELETE_AUDIT_LOGS_BEFORE,new H(Ks,Au.deleteAuditLogsBefore)),e.set(M.OPERATIONS_ENUM.READ_AUDIT_LOG,new H(o7)),e.set(M.OPERATIONS_ENUM.CREATE_AUTHENTICATION_TOKENS,new H(Rv.createTokens)),e.set(M.OPERATIONS_ENUM.REFRESH_OPERATION_TOKEN,new H(Rv.refreshOperationToken)),e.set(M.OPERATIONS_ENUM.LOGIN,new H(Av.login)),e.set(M.OPERATIONS_ENUM.LOGOUT,new H(Av.logout)),e.set(M.OPERATIONS_ENUM.GET_CONFIGURATION,new H(Ov.getConfiguration)),e.set(M.OPERATIONS_ENUM.CUSTOM_FUNCTIONS_STATUS,new H(Pt.customFunctionsStatus)),e.set(M.OPERATIONS_ENUM.GET_CUSTOM_FUNCTIONS,new H(Pt.getCustomFunctions)),e.set(M.OPERATIONS_ENUM.GET_COMPONENT_FILE,new H(Pt.getComponentFile)),e.set(M.OPERATIONS_ENUM.GET_COMPONENTS,new H(Pt.getComponents)),e.set(M.OPERATIONS_ENUM.SET_COMPONENT_FILE,new H(Pt.setComponentFile)),e.set(M.OPERATIONS_ENUM.DROP_COMPONENT,new H(Pt.dropComponent)),e.set(M.OPERATIONS_ENUM.GET_CUSTOM_FUNCTION,new H(Pt.getCustomFunction)),e.set(M.OPERATIONS_ENUM.SET_CUSTOM_FUNCTION,new H(Pt.setCustomFunction)),e.set(M.OPERATIONS_ENUM.DROP_CUSTOM_FUNCTION,new H(Pt.dropCustomFunction)),e.set(M.OPERATIONS_ENUM.ADD_CUSTOM_FUNCTION_PROJECT,new H(Pt.addComponent)),e.set(M.OPERATIONS_ENUM.ADD_COMPONENT,new H(Pt.addComponent)),e.set(M.OPERATIONS_ENUM.DROP_CUSTOM_FUNCTION_PROJECT,new H(Pt.dropCustomFunctionProject)),e.set(M.OPERATIONS_ENUM.PACKAGE_CUSTOM_FUNCTION_PROJECT,new H(Pt.packageComponent)),e.set(M.OPERATIONS_ENUM.PACKAGE_COMPONENT,new H(Pt.packageComponent)),e.set(M.OPERATIONS_ENUM.DEPLOY_CUSTOM_FUNCTION_PROJECT,new H(Pt.deployComponent)),e.set(M.OPERATIONS_ENUM.DEPLOY_COMPONENT,new H(Pt.deployComponent)),e.set(M.OPERATIONS_ENUM.READ_TRANSACTION_LOG,new H(Nv.readTransactionLog)),e.set(M.OPERATIONS_ENUM.DELETE_TRANSACTION_LOGS_BEFORE,new H(Ks,Nv.deleteTransactionLogsBefore)),e.set(M.OPERATIONS_ENUM.INSTALL_NODE_MODULES,new H(bv.installModules)),e.set(M.OPERATIONS_ENUM.AUDIT_NODE_MODULES,new H(bv.auditModules)),e.set(M.OPERATIONS_ENUM.GET_BACKUP,new H(An.getBackup)),e}a(C7,"initializeOperationFunctionMap")});var Sf=T((ife,vv)=>{"use strict";var eg=y(),L7=$(),bu=G(),{handleHDBError:tg,hdb_errors:pf}=j(),{isMainThread:D7}=require("worker_threads"),{Readable:U7}=require("stream"),Mv=require("os"),M7=require("util"),P7=Qp(),v7=M7.promisify(P7.authorize),Pv=Uv(),{createGzip:B7,constants:H7}=require("zlib");function q7(e){let t=`Found an uncaught exception with message: ${e.message}. ${Mv.EOL}Stack: ${e.stack} ${Mv.EOL}Terminating ${D7?"HDB":"thread"}.`;console.error(t),bu.fatal(t),process.exit(1)}a(q7,"handleServerUncaughtException");function F7(e,t,r){if(bu[e.logLevel||"error"](e),e.statusCode)return typeof e.http_resp_msg!="object"?r.code(e.statusCode).send({error:e.http_resp_msg||e.message}):r.code(e.statusCode).send(e.http_resp_msg);let s=e.statusCode?e.statusCode:pf.HTTP_STATUS_CODES.INTERNAL_SERVER_ERROR;return typeof e=="string"?r.code(s).send({error:e}):r.code(s).send(e.message?{error:e.message}:e)}a(F7,"serverErrorHandler");function G7(e,t,r){if(!e.body||Object.keys(e.body).length===0||typeof e.body!="object"){let s=tg(new Error,"Invalid JSON.",pf.HTTP_STATUS_CODES.BAD_REQUEST);r(s,null)}if(L7.isEmpty(e.body.operation)){let s=tg(new Error,"Request body must include an 'operation' property.",pf.HTTP_STATUS_CODES.BAD_REQUEST);r(s,null)}r()}a(G7,"reqBodyValidationHandler");function x7(e,t,r){let s;e.body.operation!==eg.OPERATIONS_ENUM.CREATE_AUTHENTICATION_TOKENS&&e.body.operation!==eg.OPERATIONS_ENUM.LOGIN&&e.body.operation!==eg.OPERATIONS_ENUM.LOGOUT?v7(e,t).then(n=>{s=n,e.body.hdb_user=s,e.body.hdb_auth_header=e.headers.authorization,r()}).catch(n=>{bu.warn(n),bu.warn(`{"ip":"${e.socket.remoteAddress}", "error":"${n.stack}"`);let i=typeof n=="string"?{error:n}:{error:n.message};r(tg(n,i,pf.HTTP_STATUS_CODES.UNAUTHORIZED),null)}):(e.body.hdb_user=null,e.body.hdb_auth_header=e.headers.authorization,e.body.baseRequest=e.raw?.baseRequest,e.body.baseResponse=t.raw?.baseResponse,e.body.fastifyResponse=t,r())}a(x7,"authHandler");async function k7(e,t,r=!1){let s;try{r&&(e.body.operation!=="configure_cluster"||e.body.operation!=="set_configuration")&&(e.body.bypass_auth=r),s=Pv.chooseOperation(e.body);let n=await Pv.processLocalTransaction(e,s);if(n instanceof U7&&n.headers){for(let[i,o]of n.headers)t.header(i,o);e.headers["accept-encoding"]?.includes("gzip")&&(t.header("content-encoding","gzip"),n=n.pipe(B7({level:H7.Z_BEST_SPEED})))}return n}catch(n){throw bu.error(n),n}}a(k7,"handlePostRequest");vv.exports={authHandler:x7,handlePostRequest:k7,handleServerUncaughtException:q7,serverErrorHandler:F7,reqBodyValidationHandler:G7}});var Fv=T((afe,qv)=>{"use strict";var V7=require("fastify-plugin"),{handlePostRequest:Bv,authHandler:$7,reqBodyValidationHandler:Y7}=Sf();async function K7(e){e.decorate("hdbCore",{preValidation:[Y7,$7],request:t=>Hv(Bv(t,response)),requestWithoutAuthentication:(t,r)=>Hv(Bv(t,r,!0))})}a(K7,"hdbCore");async function Hv(e){if(e=await e,e?.[Symbol.asyncIterator]&&!e[Symbol.iterator]){let t=[];for await(let r of e)t.push(r);return t}return e}a(Hv,"convertAsyncIterators");qv.exports=V7(K7)});var xv=T((ufe,Gv)=>{"use strict";var rg=require("fs"),ca=X();ca.initSync();var{CONFIG_PARAMS:yu}=y(),W7=1024*1024*1024;function Q7(e){let t=ca.get(yu.HTTP_TIMEOUT),r=ca.get(yu.HTTP_KEEPALIVETIMEOUT),s={bodyLimit:W7,connectionTimeout:t,keepAliveTimeout:r,return503OnClosing:!1,forceCloseConnections:!0,ignoreTrailingSlash:!0};if(e){let n=ca.get(yu.TLS_PRIVATEKEY),i=ca.get(yu.TLS_CERTIFICATE),o=ca.get(yu.TLS_CERTIFICATEAUTHORITY);s.https={allowHTTP1:!0,key:rg.readFileSync(`${n}`),cert:rg.readFileSync(i)+(o?`

`+rg.readFileSync(o):"")},s.http2=!0}return s}a(Q7,"getServerOptions");Gv.exports=Q7});var $v=T((_fe,Vv)=>{"use strict";var sg=X();sg.initSync();var{CONFIG_PARAMS:kv}=y();function z7(){let e=sg.get(kv.HTTP_CORSACCESSLIST),t=sg.get(kv.HTTP_CORS),r;return t&&(r={origin:!0,allowedHeaders:["Content-Type","Authorization","Accept"],credentials:!1},e&&e.length>0&&e[0]!==null&&e[0]!=="*"&&(r.origin=(s,n)=>n(null,e.indexOf(s)!==-1))),r}a(z7,"getCORSOptions");Vv.exports=z7});var Wv=T((ffe,Kv)=>{"use strict";var Yv=X();Yv.initSync();var J7=y();function X7(){return Yv.get(J7.CONFIG_PARAMS.HTTP_HEADERSTIMEOUT)??6e4}a(X7,"getHeaderTimeoutConfig");Kv.exports=X7});var og={};qe(og,{customFunctionsServer:()=>eee,handleFile:()=>Z7,ready:()=>see});async function Z7(e,t,r,s){if(!On){let c=ng.get(ig.CONFIG_PARAMS.CUSTOMFUNCTIONS_NETWORK_HTTPS);On=o0(c),ut.http((await On).server)}let n=await On,i=(0,zv.dirname)(r),o=t.replace(/\/routes\/.*/g,"");if(o.startsWith("/")&&(o=o.slice(1)),!Qv.has(i)){Qv.add(i);try{n.register(ree(i,o))}catch(c){if(c.message==="Root plugin has already booted")Le.warn(`Could not load root fastify route for ${r}, this may require a restart to install properly`);else throw c}}}async function eee(){try{Le.info("In Custom Functions Fastify server"+process.cwd()),Le.info(`Custom Functions Running with NODE_ENV set as: ${process.env.NODE_ENV}`),Le.debug(`Custom Functions server process ${process.pid} starting up.`),await tee();let e=ng.get(ig.CONFIG_PARAMS.CUSTOMFUNCTIONS_NETWORK_HTTPS),t=e&&(e===!0||e.toUpperCase()===TRUE_COMPARE_VAL),r;try{r=On=await o0(t)}catch(s){throw Le.error(`Custom Functions buildServer error: ${s}`),s}try{await r.ready()}catch(s){throw Le.error(`Custom Functions server.ready() error: ${s}`),s}r.server.cantCleanupProperly=!0}catch(e){Le.error(`Custom Functions ${process.pid} Error: ${e}`),Le.error(e),process.exit(1)}}async function tee(){try{Le.info("Custom Functions starting configuration."),await t0.setUsersToGlobal(),Le.info("Custom Functions completed configuration.")}catch(e){Le.error(e)}}function ree(e,t){return async function(r){try{Le.info("Custom Functions starting buildRoutes"),Le.trace("Loading fastify routes folder "+e),(0,Jv.existsSync)(e)&&r.register(e0.default,n=>({dir:e,dirNameRoutePrefix:!1,options:{hdbCore:n.hdbCore,logger:Le.loggerWithTag("custom-function"),prefix:`/${t}`}})).after((n,i,o)=>{n?.message?Le.error(n.message):n&&Le.error(n),o()})}catch(s){Le.error(`Custom Functions errored buildRoutes: ${s}`)}}}async function o0(e){Le.info("Custom Functions starting buildServer.");let t=(0,r0.default)(e),r=(0,Xv.default)(t);r.server.headersTimeout=(0,n0.default)(),r.setErrorHandler(i0.serverErrorHandler);let s=(0,s0.default)();return s&&r.register(jv.default,s),r.register(function(n,i,o){n.setNotFoundHandler(function(c,u){r.server.emit("unhandled",c.raw,u.raw)}),o()}),r.register(Zv.default),await r.register(j7),await r.after(),NT(r),Le.info("Custom Functions completed buildServer."),r}function see(){if(On)return On.then?On.then(e=>e.ready()):On.ready()}var zv,Jv,Xv,jv,Zv,e0,ng,ig,Le,j7,t0,r0,s0,n0,i0,On,Qv,a0=Te(()=>{zv=require("path"),Jv=require("fs"),Xv=U(require("fastify")),jv=U(require("@fastify/cors")),Zv=U(IT()),e0=U(require("@fastify/autoload")),ng=U(X()),ig=U(y()),Le=U(G()),j7=U(Fv()),t0=U(Gr()),r0=U(xv()),s0=U($v()),n0=U(Wv()),i0=U(Sf());zo();hr();Qv=new Set;a(Z7,"handleFile");a(eee,"customFunctionsServer");a(tee,"setUp");a(ree,"buildRouteFolder");a(o0,"buildServer");a(see,"ready")});var ag={};qe(ag,{start:()=>nee});function nee(e){return{handleFile(t,r,s){u0||(u0=!0,e.server.http(async(n,i)=>{if(!n.isWebSocket){let o=c0.get(n.pathname);if(o)return{handlesHeaders:!0,body:(0,l0.default)(n,(0,_0.realpathSync)(o))}}return i(n)},{runFirst:!0})),c0.set(r,s)}}}var l0,_0,c0,u0,d0=Te(()=>{l0=U(require("send")),_0=require("fs"),c0=new Map;a(nee,"start")});function aee(e,t=1,r){if(cg++,(0,Ji.startWorker)("server/threads/threadServer.js",{name:Rf.THREAD_TYPES.HTTP,workerIndex:e,threadCount:t,async onStarted(s){let n=new Promise((o,c)=>{function u(_){_.type===Rf.CLUSTER_MESSAGE_TYPE_ENUM.CHILD_STARTED&&(s.removeListener("message",u),o(s))}a(u,"onMessage"),s.on("message",u),s.on("error",c)});oee.push(n),await n,ua.push(s),s.expectedIdle=1,s.lastIdle=0,s.requests=1,s.on("message",o=>{if(o.requestId){let c=gf.get(o.requestId);c&&c(o)}}),s.on("exit",i),s.on("shutdown",i);function i(){let o=ua.indexOf(s);o>-1&&ua.splice(o,1)}if(a(i,"removeWorker"),la){let o=la;la=[];for(let c of o)m0[c.localPort](null,c)}}}),r){let s=setInterval(()=>{ug?ug=!1:(clearInterval(s),console.log("shut down dynamic thread due to inactivity"),(0,Ji.shutdownWorkers)(),cg=0,setTimeout(()=>{global.gc?.()},5e3))},1e4)}}function p0(e=0,t){if(typeof e=="string")try{(0,Af.existsSync)(e)&&(0,Af.unlinkSync)(e)}catch{}let r;t?t==="ip"?r=cee:r=uee(t):r=lg;let s=(0,_a.createServer)({allowHalfOpen:!0,pauseOnConnect:!r.readsData}).listen(e);if(s._handle){s._handle.onconnection=m0[e]=function(i,o){r.readsData||(o.reading=!1,o.readStop()),ug=!0,r(o,(c,u)=>{if(!c){if(f0){let l=o._socket||new _a.Socket({handle:o,writable:!0,readable:!0});f0.deliverSocket(l,e,u),l.resume()}else cg>0?(la.length===0&&setTimeout(()=>{la.length>0&&console.warn("Incoming sockets/requests have been queued for workers to start, and no workers have handled them. Check to make sure an error is not preventing workers from starting")},1e4).unref(),o.localPort=e,la.push(o)):(console.log("start up a dynamic thread to handle request"),aee(0));br(!1,"socket-routed");return}c.requests++;let _=o.fd;if(_>=0)c.postMessage({port:e,fd:_,data:u});else{let l=o._socket||new _a.Socket({handle:o,writable:!0,readable:!0});fee(l,c,e)}br(!0,"socket-routed")})};let n=Oc();h0.info(`HarperDB ${n.version} Server running on port ${e}`)}return s.on("error",n=>{console.error("Error in socket server",n)}),process.env._UNREF_SERVER&&s.unref(),s}function lg(e,t){let r,s=0;for(let n of ua){if(n.threadId===-1)continue;let i=n.expectedIdle/n.requests;if(i>s)r=n;else if(s>=Tf)return Tf=i,t(r);s=i}Tf=0,t(r)}function cee(e,t){let r={};e.getpeername(r);let s=r.address,n=da.get(s),i=Date.now();if(n&&n.worker.threadId!==-1)return n.lastUsed=i,t(n.worker);lg(e,o=>{da.set(s,{worker:o,lastUsed:i}),t(o)})}function uee(e){let t=new RegExp(`${e}:\\s*(.+)`,"i");return r.readsData=!0,r;function r(s,n){let i=new _a.Socket({handle:s,readable:!0,writable:!0});s._socket=i,i.on("data",o=>{s.readStop();let u=o.toString("latin1").match(t)?.[1],_=da.get(u),l=Date.now();if(_&&_.worker.threadId!==-1)return _.lastUsed=l,n(_.worker);lg(s,d=>{da.set(u,{worker:d,lastUsed:l}),n(d,o)})})}a(r,"findByHeaderAffinity")}function _ee(){Tf=0;for(let e of ua)e.expectedIdle=e.recentELU.idle+lee,e.requests=1;ua.sort((e,t)=>e.expectedIdle>t.expectedIdle?-1:1)}function fee(e,t,r){let s=dee++;t.postMessage({port:r,requestId:s,event:"connection"}),e.on("data",n=>{let i=n.toString("latin1");t.postMessage({port:r,requestId:s,data:i,event:"data"})}).on("close",n=>{t.postMessage({port:r,requestId:s,event:"close",hadError:n})}).on("error",n=>{t.postMessage({port:r,requestId:s,event:"error",error:n})}).on("drain",n=>{t.postMessage({port:r,requestId:s,event:"drain",error:n})}).on("end",()=>{t.postMessage({port:r,requestId:s,event:"end"})}).resume(),gf.set(s,n=>{n.event=="data"&&e.write(Buffer.from(n.data,"latin1")),n.event=="end"&&(e.end(n.data&&Buffer.from(n.data,"latin1")),gf.delete(s)),n.event=="destroy"&&(e.destroy(),gf.delete(s))})}var Ji,_a,Rf,h0,Af,iee,ua,la,m0,f0,cg,oee,ug,Tf,E0,da,lee,gf,dee,S0=Te(()=>{Ji=U(Je()),_a=require("net"),Rf=U(y()),h0=U(G()),Af=require("fs");_n();({isMainThread:iee}=require("worker_threads")),ua=[],la=[],m0=[],cg=0,oee=[];iee&&process.on("uncaughtException",e=>{e.code!=="ECONNRESET"&&e.message!=="write EIO"&&console.error("uncaughtException",e)});a(aee,"startHTTPWorker");a(p0,"startSocketServer");Tf=0;a(lg,"findMostIdleWorker");E0=36e5,da=new Map;a(cee,"findByRemoteAddressAffinity");a(uee,"makeFindByHeaderAffinity");setInterval(()=>{let e=Date.now();for(let[t,r]of da)r.lastUsed+E0<e&&da.delete(t)},E0).unref();lee=1e3;a(_ee,"updateWorkerIdleness");(0,Ji.setMonitorListener)(_ee);gf=new Map,dee=1;a(fee,"proxySocket")});var A0=T((bfe,R0)=>{"use strict";var Eee=require("cluster"),Ts=X();Ts.initSync();var g0=y(),Afe=require("util"),Nn=G(),_g=require("fs"),hee=require("fastify"),Ofe=Oc(),mee=require("@fastify/cors"),pee=require("@fastify/compress"),See=require("@fastify/static"),Tee=IT(),gee=require("path"),{PACKAGE_ROOT:Ree}=y(),Aee=qn(),Oee=$(),Nee=Gr(),bee=ic(),{server:yee}=(hr(),Z(hi)),{authHandler:Iee,handlePostRequest:wee,serverErrorHandler:Cee,reqBodyValidationHandler:Lee}=Sf(),Nfe=require("net"),{registerContentHandlers:Dee}=(zo(),Z(gP)),Uee=6e4,Mee=1024*1024*1024,Pee="TRUE",{CONFIG_PARAMS:bn}=g0,Xi;R0.exports={hdbServer:T0,start:T0};async function T0(e){try{Nn.info("In Fastify server"+process.cwd()),Nn.info(`Running with NODE_ENV set as: ${process.env.NODE_ENV}`),Nn.debug(`HarperDB server process ${process.pid} starting up.`),global.clustering_on=!1,global.isMaster=Eee.isMaster,await vee();let t=Ts.get(bn.OPERATIONSAPI_NETWORK_SECUREPORT)!=null;Xi=Bee(t),await Xi.ready(),e||(e={}),e.isOperationsServer=!0,Xi.server.cantCleanupProperly=!0;try{yee.http(Xi.server,e),Xi.server.closeIdleConnections||await Xi.listen({port:0,host:"::"})}catch(r){throw Xi.close(),Nn.error(r),Nn.error("Error configuring operations server"),r}}catch(t){console.error(`Failed to build server on ${process.pid}`,t),Nn.fatal(t),process.exit(1)}}a(T0,"operationsServer");async function vee(){Nn.trace("Configuring HarperDB process."),Aee.setSchemaDataToGlobal(),await Nee.setUsersToGlobal(),await bee.getLicense()}a(vee,"setUp");function Bee(e){Nn.debug(`HarperDB process starting to build ${e?"HTTPS":"HTTP"} server.`);let t=Hee(e),r=hee(t);r.server.headersTimeout=Fee(),r.setErrorHandler(Cee);let s=qee();s&&r.register(mee,s),r.register(function(i,o,c){i.setNotFoundHandler(function(u,_){r.server.emit("unhandled",u.raw,_.raw)}),c()}),r.register(Tee),r.register(pee),r.register(See,{root:gee.join(Ree,"studio")}),Dee(r);let n=Ts.get(g0.HDB_SETTINGS_NAMES.LOCAL_STUDIO_ON);return r.get("/",function(i,o){return!Oee.isEmpty(n)&&n.toString().toLowerCase()==="true"?o.sendFile("index.html"):o.sendFile("running.html")}),r.post("/",{preValidation:[Lee,Iee],config:{isOperation:!0}},async function(i,o){return i.body?.operation?.startsWith("restart")&&o.header("Connection","close"),wee(i,o)}),r.get("/health",()=>"HarperDB is running."),Nn.debug(`HarperDB process starting up ${e?"HTTPS":"HTTP"} server listener.`),r}a(Bee,"buildServer");function Hee(e){let t=Ts.get(bn.OPERATIONSAPI_NETWORK_TIMEOUT),r=Ts.get(bn.OPERATIONSAPI_NETWORK_KEEPALIVETIMEOUT),s={bodyLimit:Mee,connectionTimeout:t,keepAliveTimeout:r,forceCloseConnections:!0,return503OnClosing:!1};if(e){let n=Ts.get(bn.OPERATIONSAPI_TLS_PRIVATEKEY),i=Ts.get(bn.OPERATIONSAPI_TLS_CERTIFICATE),o=Ts.get(bn.OPERATIONSAPI_TLS_CERTIFICATEAUTHORITY),c={allowHTTP1:!0,key:_g.readFileSync(n),cert:_g.readFileSync(i)+(o?`

`+_g.readFileSync(o):"")};s.http2=!0,s.https=c}return s}a(Hee,"getServerOptions");function qee(){let e=Ts.get(bn.OPERATIONSAPI_NETWORK_CORS),t=Ts.get(bn.OPERATIONSAPI_NETWORK_CORSACCESSLIST),r;return e&&(e===!0||e.toUpperCase()===Pee)&&(r={origin:!0,allowedHeaders:["Content-Type","Authorization","Accept"],credentials:!1},t&&t.length>0&&t[0]!==null&&t[0]!=="*"&&(r.origin=(s,n)=>n(null,t.indexOf(s)!==-1))),r}a(qee,"getCORSOpts");function Fee(){return Ts.get(bn.OPERATIONSAPI_NETWORK_HEADERSTIMEOUT)??Uee}a(Fee,"getHeaderTimeoutConfig")});var M0=T((Cfe,U0)=>{"use strict";var{decode:Gee}=require("msgpackr"),{isMainThread:xee,parentPort:kee,threadId:Ife}=require("worker_threads"),fg=_t(),yn=Ve(),Vee=y(),Iu=G(),O0=X(),b0=y();Je();var $ee=nn(),{recordAction:Yee,recordActionBinary:Kee}=(_n(),Z(Ic)),{publishToStream:Wee}=fg,wfe={durable:yn.WORK_QUEUE_CONSUMER_NAMES.durable_name,queue:yn.WORK_QUEUE_CONSUMER_NAMES.deliver_group},Qee,zee,Jee,y0,I0;U0.exports={initialize:w0,workQueueListener:D0,setSubscription:Xee,setIgnoreOrigin:Zee,getDatabaseSubscriptions:jee};async function w0(){I0=!0,Iu.notify("Starting clustering ingest service.");let{connection:e,jsm:t,js:r}=await fg.getNATSReferences();Qee=e,zee=e.info.server_name,Jee=t,y0=r}a(w0,"initialize");var Nf=new Map;function Xee(e,t,r){let s=Nf.get(e);s||Nf.set(e,s=new Map),s.set(t,r),I0||w0().then(D0)}a(Xee,"setSubscription");function jee(){return Nf}a(jee,"getDatabaseSubscriptions");var C0;function Zee(e){C0=e}a(Zee,"setIgnoreOrigin");var L0=100,N0=new Array(L0),Of=0;async function D0(){let t=await(await y0.consumers.get(yn.WORK_QUEUE_CONSUMER_NAMES.stream_name,yn.WORK_QUEUE_CONSUMER_NAMES.durable_name)).consume();for await(let r of t)await N0[Of],N0[Of]=ete(r).catch(s=>{Iu.error(s)}),++Of>=L0&&(Of=0)}a(D0,"workQueueListener");xee||kee.on("message",async e=>{let{type:t}=e;t===b0.ITC_EVENT_TYPES.SHUTDOWN&&fg.closeConnection()});async function ete(e){let t=Gee(e.data);Yee(e.data.length,"bytes-received",e.subject,t.operation,"ingest");let r=e.headers,s=!1,n=O0.get(Vee.CONFIG_PARAMS.CLUSTERING_NODENAME);r.has(yn.MSG_HEADERS.TRANSACTED_NODES)&&r.values(yn.MSG_HEADERS.TRANSACTED_NODES).indexOf(n)>-1&&(s=!0);let i=r.get(yn.MSG_HEADERS.ORIGIN);if(s||(s=i===n&&!C0),Kee(s,"echo",e.subject,t.operation,"ingest"),s){e.ack();return}r.append(yn.MSG_HEADERS.TRANSACTED_NODES,n);try{let{operation:o,schema:c,next:u,table:_,records:l,hash_values:d,__origin:f,expiresAt:E}=t;Iu.trace("processing message:",o,c,_,(l?"records: "+l.map(O=>O?.id):"")+(d?"ids: "+d:""),"with sequence:",e.seq),Iu.trace(`messageProcessor nats msg id: ${e.headers.get(yn.MSG_HEADERS.NATS_MSG_ID)}`);let h;l||(l=d);let{timestamp:S,user:p,node_name:g}=f||{},b=Nf.get(c)?.get(_);if(!b)throw new Error("Missing table for replication message",_);if(o==="define_schema")t.type=o,b.send(t);else if(l.length===1&&!u)b.send({type:dg(o),value:l[0],id:d?.[0],expiresAt:E,timestamp:S,table:_,onCommit:h,user:p,nodeName:g});else{let O=l.map((Y,W)=>({type:dg(o),value:Y,expiresAt:E,id:d?.[W],table:_}));for(;u;)O.push({type:dg(u.operation),value:u.record,expiresAt:u.expiresAt,id:u.id,table:u.table}),u=u.next;b.send({type:"transaction",writes:O,table:_,timestamp:S,onCommit:h,user:p,nodeName:g})}O0.get(b0.CONFIG_PARAMS.CLUSTERING_REPUBLISHMESSAGES)!==!1&&Wee(e.subject.split(".").slice(0,-1).join("."),$ee.createNatsTableStreamName(c,_),e.headers,e.data)}catch(o){Iu.error(o)}e.ack()}a(ete,"messageProcessor");function dg(e){switch(e){case"insert":case"upsert":case"update":return"put"}return e}a(dg,"convertOperation")});var Tg={};qe(Tg,{disableNATS:()=>rte,publishToStream:()=>wf,setNATSReplicator:()=>Eg,setPublishToStream:()=>ste,setSubscription:()=>Sg,start:()=>tte});function tte(){yf.default.get(If.default.CONFIG_PARAMS.CLUSTERING_ENABLED)&&ite()}function rte(e=!0){F0=e}function ste(e,t){wf=e,Sg=t}function ite(){if(F0||process.env._DISABLE_NATS)return;let e=_s(),t=Object.keys(e);t.push("system");for(let r of t){let s=e[r];for(let n in s){let i=s[n];Eg(n,r,i)}}gg((r,s)=>{Eg(r.tableName,r.databaseName,r),s&&x0(r)}),!P0&&(P0=!0)}function Eg(e,t,r){if(!r)return console.error(`Attempt to replicate non-existent table ${e} from database ${t}`);if(r.sources.some(n=>n?.isNATSReplicator))return;r.sourcedFrom(class extends Ot{static{a(this,"NATSReplicator")}put(i){return s(this.getContext()).addWrite(t,{operation:"put",table:e,id:this[Ie],record:i})}delete(){return s(this.getContext()).addWrite(t,{operation:"delete",table:e,id:this[Ie]})}publish(i){return s(this.getContext()).addWrite(t,{operation:"publish",table:e,id:this[Ie],record:i})}invalidate(){s(this.getContext()).addWrite(t,{operation:"invalidate",table:e,id:this[Ie]})}static defineSchema(i){x0(i)}static subscribe(){let i=new ts;return Sg(t,e,i),i}static subscribeOnThisThread(i){return i<nte}static isEqual(i){return i.isNATSReplicator}static isNATSReplicator=!0;static shouldReceiveInvalidations=!0},{intermediateSource:!0});function s(n){let i=n?.transaction?.nats;if(!i)if(n?.transaction){n.transaction.nats=i=new bf(n.transaction,n);let o=n.transaction;for(;o.next;)o=o.next;o.next=n.transaction.nats,i.user=n.user,i.context=n}else i=G0;return i}a(s,"getNATSTransaction")}function x0(e){let t=yf.default.get(If.default.CONFIG_PARAMS.CLUSTERING_NODENAME);wf(`${mg.SUBJECT_PREFIXES.TXN}.${e.databaseName}.${e.tableName}`,(0,pg.createNatsTableStreamName)(e.databaseName,e.tableName),void 0,{operation:"define_schema",schema:e.databaseName,table:e.tableName,attributes:e.attributes,__origin:{timestamp:Date.now(),node_name:t}})}var v0,mg,pg,B0,H0,yf,If,q0,F0,wf,Sg,nte,G0,P0,bf,hg,k0=Te(()=>{fe();ss();v0=U(_t()),mg=U(Ve()),pg=U(nn());Ba();B0=U(M0()),H0=U(Er()),yf=U(X()),If=U(y()),q0=U(G());a(tte,"start");a(rte,"disableNATS");wf=v0.publishToStream,Sg=B0.setSubscription;a(ste,"setPublishToStream");nte=2;a(ite,"assignReplicationSource");a(Eg,"setNATSReplicator");a(x0,"publishSchema");bf=class{constructor(t,r){this.transaction=t;this.options=r}static{a(this,"NATSTransaction")}user;writes_by_db=new Map;addWrite(t,r){r.expiresAt=this.context?.expiresAt;let s=this.writes_by_db.get(t);s||this.writes_by_db.set(t,s=[]),s.push(r)}commit({timestamp:t}){let r=yf.default.get(If.default.CONFIG_PARAMS.CLUSTERING_NODENAME),s=[];for(let[n,i]of this.writes_by_db){let o=[],c=[],u,_;for(let l of i){let d=l.table,f=l.operation=="put"?"upsert":l.operation;u||(q0.trace(`Sending transaction event ${f}`),_=u={operation:f,schema:n,table:d,__origin:{user:this.user?.username,timestamp:t,node_name:r}},u.hash_values=c,f!=="delete"&&f!=="invalidate"&&(u.records=o)),u.table===d&&u.operation===f?(o.push(l.record),c.push(l.id)):_=_.next={operation:f,table:d,id:l.id,record:l.record},l.expiresAt&&(_.expiresAt=l.expiresAt)}u&&s.push(wf(`${mg.SUBJECT_PREFIXES.TXN}.${n}.${u.table}`,(0,pg.createNatsTableStreamName)(n,u.table),void 0,u))}return Promise.all(s)}},hg=class extends bf{static{a(this,"ImmmediateNATSTransaction")}constructor(){super({get timestamp(){return(0,H0.getNextMonotonicTime)()}})}addWrite(t,r){super.addWrite(t,r),this.commit()}};G0=new hg});async function $0({clientId:e,user:t,listener:r,clean:s}){let n;if(e&&!s){let i=await Rg.getResource(e,{});n=new Og(e,t,i),i&&(n.sessionWasPresent=!0)}else{if(e){let i=await Rg.get(e);i&&i.delete()}n=new Lf(e,t)}return n}function Ag(){return Cf++,Cf>65500&&(Cf=1),Cf}var V0,fa,Rg,Cf,Lf,Og,Y0=Te(()=>{fe();ru();V0=U(Er()),fa=U(G());Ei();Rg=et({database:"system",table:"hdb_durable_session",attributes:[{name:"id",isPrimaryKey:!0},{name:"subscriptions",type:"array",elements:{attributes:[{name:"topic"},{name:"qos"},{name:"startTime"},{name:"acks"}]}}]});a($0,"getSession");Cf=1;a(Ag,"getNextMessageId");Lf=class{static{a(this,"SubscriptionsSession")}listener;sessionId;user;subscriptions=[];awaitingAcks;sessionWasPresent;constructor(t,r){this.sessionId=t,this.user=r}async addSubscription(t,r,s){let{topic:n,omitCurrent:i,startTime:o}=t,c=n.indexOf("?"),u,_;if(c>-1?(u=n.slice(c),_=n.slice(0,c)):_=n,!_)throw new Error("No topic provided");let l=!1,d;if((_.endsWith("+")||_.endsWith("#"))&&(l=!0,_.endsWith("+")&&(d=!0),_=_.slice(0,_.length-1)),_.indexOf(".")>-1)throw new Error("Dots are not allowed in topic names");if(_.indexOf("#")>-1||_.indexOf("+")>-1)throw new Error("Only trailing wildcards are supported");let f=this.subscriptions.find(b=>b.topic===n);f&&(f.end(),this.subscriptions.splice(this.subscriptions.indexOf(f),1));let E={search:u,async:!0,user:this.user,startTime:o,omitCurrent:i,isCollection:l,shallowWildcard:d,url:""};o&&(0,fa.trace)("Resuming subscription from",n,"from",o);let h=ti.getMatch(_);if(!h)throw new Error(`The topic ${n} does not exist, no resource has been defined to handle this topic`);E.url=h.relativeURL;let S=h.path,p=h.Resource,g=await Ge(E,async()=>{let b=await p.subscribe(E);if(!b)throw new Error(`No subscription was returned from subscribe for topic ${n}`);if(!b[Symbol.asyncIterator])throw new Error(`Subscription is not (async) iterable for topic ${n}`);return(async()=>{for await(let O of b)try{let Y;if(O.type&&O.type!=="put"&&O.type!=="delete"&&O.type!=="message"||s&&!s(O))continue;r?(O.topic=n,Y=this.needsAcknowledge(O)):(O.acknowledge?.(),Y=Ag());let W=O.id;Array.isArray(W)&&(W=Qo(W)),W==null&&(W=""),this.listener(S+"/"+W,O.value,Y,t)}catch(Y){(0,fa.warn)(Y)}})(),b});return g.topic=n,g.qos=t.qos,this.subscriptions.push(g),g}resume(){}needsAcknowledge(t){let r=Ag();return t.acknowledge&&(this.awaitingAcks||(this.awaitingAcks=new Map),this.awaitingAcks.set(r,t.acknowledge)),r}acknowledge(t){let r=this.awaitingAcks?.get(t);r&&(this.awaitingAcks.delete(t),r())}async removeSubscription(t){let r=this.subscriptions.find(s=>s.topic===t);r&&r.end()}async publish(t,r){let{topic:s,retain:n}=t;t.data=r,t.user=this.user,t.async=!0;let i=ti.getMatch(s);if(!i)throw new Error(`Can not publish to topic ${s} as it does not exist, no resource has been defined to handle this topic`);t.url=i.relativeURL;let o=i.Resource;return Ge(t,()=>n?r===void 0?o.delete(t,t):o.put(t,t.data,t):o.publish(t,t.data,t))}setListener(t){this.listener=t}disconnect(){for(let t of this.subscriptions)t.end();this.subscriptions=[]}},Og=class extends Lf{static{a(this,"DurableSubscriptionsSession")}sessionRecord;constructor(t,r,s){super(t,r),this.sessionRecord=s||{id:t,subscriptions:[]}}async resume(){for(let t of this.sessionRecord.subscriptions||[])await this.resumeSubscription({omitCurrent:!0,topic:t.topic,qos:t.qos,startTime:t.startTime},!0,t.acks?r=>!t.acks.includes(r.timestamp):null)}resumeSubscription(t,r,s){return super.addSubscription(t,r,s)}needsAcknowledge(t){this.awaitingAcks||(this.awaitingAcks=new Map);let r=Ag(),s={topic:t.topic,timestamp:t.timestamp};return t.acknowledge&&(s.acknowledge=t.acknowledge),this.awaitingAcks.set(r,s),r}acknowledge(t){let r=this.awaitingAcks.get(t);this.awaitingAcks.delete(t),r.acknowledge?.();let s=r.topic;for(let[,n]of this.awaitingAcks)if(n.topic===s&&n.timestamp<r.timestamp){for(let i of this.sessionRecord.subscriptions)if(i.topic===s){i.acks||(i.acks=[]),i.acks.push(r.timestamp),(0,fa.trace)("Received ack",s,r.timestamp),this.sessionRecord.update();return}}for(let n of this.sessionRecord.subscriptions)n.topic===s&&(n.startTime=r.timestamp);this.sessionRecord.update()}async addSubscription(t,r){await this.resumeSubscription(t,r);let{qos:s,startTime:n}=t;return s>0&&!n&&(this.sessionRecord.subscriptions=this.subscriptions.map(i=>{let o=i.startTime;return o||(o=i.startTime=(0,V0.getNextMonotonicTime)()),(0,fa.trace)("Added durable subscription",i.topic,o),{qos:i.qos,topic:i.topic,startTime:o}}),Rg.put(this.sessionRecord)),t.qos}}});var bg={};qe(bg,{start:()=>ate});async function ate({server:e,port:t,webSocket:r,securePort:s,requireAuthentication:n}){let i=e.mqtt={requireAuthentication:n};r&&e.ws((o,c,u)=>{if(o.protocol==="mqtt"){let{onMessage:_,onClose:l}=Q0(o,(d,f)=>{if(o.send(d),f&&o._socket.writableNeedDrain)return new Promise(E=>this._socket.once("drain",E))},c,Promise.resolve(u).then(()=>c?.user),i);o.on("message",_),o.on("close",l),o.on("error",d=>{(0,Jr.info)("WebSocket error",d)})}},{subProtocol:"mqtt"}),(t||s)&&e.socket(async o=>{let c;ote&&o.remoteAddress.includes("127.0.0.1")&&(c=await(0,z0.getSuperUser)());let{onMessage:u,onClose:_}=Q0(o,l=>o.write(l),null,c,i);o.on("data",u),o.on("close",_),o.on("error",l=>{(0,Jr.info)("Socket error",l)})},{port:t,securePort:s})}function Q0(e,t,r,s,n){W0||(W0=!0,yc(d=>{Df>0&&d.push({metric:"mqtt-connections",connections:Df,byThread:!0})}));let i;Df++;let o,c={protocolVersion:4},u=(0,Uf.parser)({protocolVersion:5});function _(d){u.parse(d)}a(_,"onMessage");function l(){Df--,i||(i=!0,o?.disconnect(),xr(!1,"connection","mqtt","disconnect"))}return a(l,"onClose"),u.on("packet",async d=>{s?.then&&(s=await s),o?.then&&await o;try{switch(d.cmd){case"connect":if(c.protocolVersion=d.protocolVersion,d.username)try{s=await ut.getUser(d.username,d.password.toString()),(0,Ng.get)(In.CONFIG_PARAMS.LOGGING_AUDITAUTHEVENTS_LOGSUCCESSFUL)&&K0.notify({username:s.username,status:In.AUTH_AUDIT_STATUS.SUCCESS,type:In.AUTH_AUDIT_TYPES.AUTHENTICATION,auth_strategy:"MQTT",remote_address:e.remoteAddress})}catch{return(0,Ng.get)(In.CONFIG_PARAMS.LOGGING_AUDITAUTHEVENTS_LOGFAILED)&&K0.error({username:s.username,status:In.AUTH_AUDIT_STATUS.FAILURE,type:In.AUTH_AUDIT_TYPES.AUTHENTICATION,auth_strategy:"mqtt",remote_address:e.remoteAddress}),f({cmd:"connack",reasonCode:4,returnCode:134})}if(!s&&n.requireAuthentication)return xr(!1,"connection","mqtt","connect"),f({cmd:"connack",reasonCode:4,returnCode:134});try{n.authorizeClient?.(d,s),o=$0({user:s,...d}),o=await o}catch(O){return(0,Jr.error)(O),xr(!1,"connection","mqtt","connect"),f({cmd:"connack",reasonCode:O.code||5,returnCode:O.code||128})}xr(!0,"connection","mqtt","connect"),f({cmd:"connack",sessionPresent:o.sessionWasPresent,reasonCode:0,returnCode:0}),o.setListener((O,Y,W,F)=>{try{let w=O.indexOf("/",1),K=w>0?O.slice(0,w):O;f({cmd:"publish",topic:O,payload:E(Y),messageId:W||Math.floor(Math.random()*1e8),qos:F.qos},K)}catch(w){(0,Jr.error)(w),o?.disconnect()}}),o.sessionWasPresent&&await o.resume();break;case"subscribe":let h=[];for(let O of d.subscriptions){let Y;try{Y=(await o.addSubscription(O,O.qos>=1)).qos||0}catch(W){(0,Jr.error)(W),Y=128}h.push(Y)}await o.committed,f({cmd:"suback",granted:h,messageId:d.messageId});break;case"unsubscribe":for(let O of d.unsubscriptions)o.removeSubscription(O);f({cmd:"unsuback",messageId:d.messageId});break;case"pubrel":f({cmd:"pubcomp",messageId:d.messageId,reasonCode:0});return;case"publish":let S=d.qos===2?"pubrec":"puback",p=e.deserialize||(e.deserialize=ra(r?.headers.get?.("content-type"))),g=d.payload?.length>0?p(d.payload):void 0,b;try{b=await o.publish(d,g)}catch(O){(0,Jr.warn)(O),d.qos>0&&f({cmd:S,messageId:d.messageId,reasonCode:128,returnCode:128},d.topic)}d.qos>0&&f({cmd:S,messageId:d.messageId,reasonCode:b===!1?144:0,returnCode:b===!1?144:0},d.topic);break;case"pubrec":f({cmd:"pubrel",messageId:d.messageId,reasonCode:0});break;case"pubcomp":case"puback":o.acknowledge(d.messageId);break;case"pingreq":f({cmd:"pingresp"});break;case"disconnect":i=!0,o?.disconnect(),xr(!0,"connection","mqtt","disconnect"),e.close?e.close():e.end();break}}catch(h){(0,Jr.error)(h),f({cmd:"disconnect"})}function f(h,S){let p=(0,Uf.generate)(h,c);t(p),br(p.length,"bytes-sent",S,h.cmd,"mqtt")}a(f,"sendPacket");function E(h){return si(h,r)}a(E,"serialize")}),{onMessage:_,onClose:l}}var Uf,z0,Ng,In,Jr,K0,ote,W0,Df,J0=Te(()=>{Uf=require("mqtt-packet");Y0();z0=U(Gr());zo();_n();hr();Ng=U(X()),In=U(y()),Jr=U(G()),K0=(0,Jr.loggerWithTag)("auth-event"),ote=!0;a(ate,"start");Df=0;a(Q0,"onSocket")});var j0={};qe(j0,{Request:()=>yg,createReuseportFd:()=>Mf});var X0,yg,Ig,wg,Mf,Cg=Te(()=>{X0=require("os"),yg=class{static{a(this,"Request")}#e;constructor(t,r){this.method=t.method;let s=t.url;this._nodeRequest=t,this._nodeResponse=r,this.url=s,this.headers=new wg(t.headers)}get absoluteURL(){return this.protocol+"://"+this.host+this.url}get pathname(){let t=this.url.indexOf("?");return t>-1?this.url.slice(0,t):this.url}set pathname(t){let r=this.url.indexOf("?");r>-1?this.url=t+this.url.slice(r):this.url=t}get protocol(){return this._nodeRequest.socket.encrypted?"https":"http"}get ip(){return this._nodeRequest.socket.remoteAddress}get body(){return this.#e||(this.#e=new Ig(this._nodeRequest))}get host(){return this._nodeRequest.authority||this._nodeRequest.headers.host}get isAborted(){return!1}},Ig=class{static{a(this,"RequestBody")}#e;constructor(t){this.#e=t}on(t,r){return this.#e.on(t,r),this}},wg=class{constructor(t){this.asObject=t}static{a(this,"Headers")}set(t,r){this.asObject[t.toLowerCase()]=r}get(t){return this.asObject[t.toLowerCase()]}has(t){return this.asObject.hasOwnProperty(t.toLowerCase())}[Symbol.iterator](){return Object.entries(this.asObject)[Symbol.iterator]()}keys(){return Object.keys(this.asObject)}values(){return Object.values(this.asObject)}forEach(t){for(let[r,s]of this)t(s,r,this)}};(0,X0.platform)()!="win32"&&(Mf=require("node-unix-socket").createReuseportFd)});var Pd={};qe(Pd,{component_errors:()=>Ea,loadComponent:()=>Pf,loadComponentDirectories:()=>aB,setErrorReporter:()=>_te});function aB(e,t){t&&(Dg=t),e&&(Ug=e);let r=[];if((0,gs.existsSync)(Lg)){let n=(0,gs.readdirSync)(Lg,{withFileTypes:!0});for(let i of n){if(!i.isDirectory()&&!i.isSymbolicLink())continue;let o=i.name,c=(0,gt.join)(Lg,o);r.push(Pf(c,Dg,"hdb",!1))}}let s=process.env.RUN_HDB_APP;return s&&r.push(Pf(s,Dg,s,!1,null,process.env.DEV_MODE)),Promise.all(r).then(()=>{oB=!0})}function _te(e){Lu=e}async function Pf(e,t,r,s,n,i){if(!eB.has(e)){eB.set(e,!0),n&&(Ug=n);try{let o;s&&(Ea=new Map);let c=(0,gt.join)(e,s?"harperdb-config.yaml":"config.yaml");(0,gs.existsSync)(c)?o=s?(0,iB.getConfigObj)():(0,tB.parseDocument)((0,gs.readFileSync)(c,"utf8"),{simpleKeys:!0}).toJSON():o=Mg;let u=[],_=s;for(let l in o){let d=o[l];if(Ea.set(s?l:(0,gt.basename)(e),!1),!d)continue;let f,E=d.package;try{if(E){let b=e,O;for(;!(0,gs.existsSync)(O=(0,gt.join)(b,"node_modules",l));)if(b=(0,gt.dirname)(b),b.length<(0,nB.getHdbBasePath)().length){O=null;break}if(O)f=await Pf(O,t,r,!1),_=!0;else throw new Error(`Unable to find package ${l}:${E}`)}else f=lte[l];if(!f)continue;u.push(f);let h=a(b=>(b.origin=r,et(b)),"ensureTable"),S=d.network||(d.port||d.securePort)&&d,p=S?.securePort||S?.https&&S.port,g=!S?.https&&S?.port;if(wu.isMainThread&&(f=await f.startOnMainThread?.({server:ut,ensureTable:h,port:g,securePort:p,resources:t,...d})||f,s&&S))for(let b of[g,p])try{if(+b&&!Z0.includes(b)){let O=Pg.get(vg.CONFIG_PARAMS.HTTP_SESSIONAFFINITY);O&&Cu.default.warn("Session affinity is not recommended and may cause memory leaks"),(O||!Mf)&&(Z0.push(b),p0(b,O))}}catch(O){console.error("Error listening on socket",b,O,l)}if(t.isWorker&&(f=await f.start?.({server:ut,ensureTable:h,port:g,securePort:p,resources:t,...d})||f),Ug.set(f,!0),f.handleFile&&d.files){if(d.files.includes(".."))throw(0,sB.handleHDBError)("Can not reference parent directories");let b=(0,gt.join)(e,d.files).replace(/\\/g,"/"),O=b.indexOf("/*");if(O>-1&&d.files!==Mg[l]?.files&&!(0,gs.existsSync)(b.slice(0,O)))throw new Error(`The path '${b.slice(0,O)}' does not exist and cannot be used as the base of the resolved 'files' path value '${d.files}'`);for(let Y of await(0,rB.default)(b,{onlyFiles:!1,objectMode:!0})){let{path:W,dirent:F}=Y;_=!0;let w=(0,gt.relative)(e,W).replace(/\\/g,"/");if(d.root){let x=d.root;if(x.startsWith("/")&&(x=x.slice(1)),x.endsWith("/")&&(x=x.slice(0,-1)),x+="/",w.startsWith(x))w=w.slice(x.length);else throw new Error(`The root path '${d.root}' does not reference a valid part of the file path '${w}'.The root path should be used to indicate the relative path/part of the file path for determining the exported web path.`)}let K=(0,gt.basename)(e),B=d.path||"/";B=B.startsWith("/")?B:B.startsWith("./")?"/"+K+B.slice(2):B==="."?"/"+K:"/"+K+"/"+B,B+=(B.endsWith("/")?"":"/")+w;try{if(F.isFile()){let x=await ute(W);wu.isMainThread&&await f.setupFile?.(x,B,W,t),t.isWorker&&await f.handleFile?.(x,B,W,t)}else wu.isMainThread&&await f.setupDirectory?.(B,W,t),t.isWorker&&await f.handleDirectory?.(B,W,t)}catch(x){x.message=`Could not load ${F.isFile()?"file":"directory"} '${W}'${d.module?" using '"+d.module+"'":""} for application '${e}' due to: ${x.message}`,Lu?.(x),((0,ha.getWorkerIndex)()===0?console:Cu.default).error(x),t.set(d.path||"/",new Du(x)),Ea.set(s?l:(0,gt.basename)(e),x.message)}}}}catch(h){h.message=`Could not load component '${l}' for application '${(0,gt.basename)(e)}' due to: ${h.message}`,Lu?.(h),((0,ha.getWorkerIndex)()===0?console:Cu.default).error(h),t.set(d.path||"/",new Du(h),null,!0),Ea.set(s?l:(0,gt.basename)(e),h.message)}}if(wu.isMainThread&&!oB&&i&&(0,ha.watchDir)(e,async()=>aB()),o.extensionModule)return await Tl((0,gt.join)(e,o.extensionModule));if(!_){let l=`${e} did not load any modules, resources, or files, is this a valid component?`;Lu?.(new Error(l)),((0,ha.getWorkerIndex)()===0?console:Cu.default).error(l),Ea.set((0,gt.basename)(e),l)}}catch(o){console.error(`Could not load application directory ${e}`,o),o.message=`Could not load application due to ${o.message}`,Lu?.(o),t.set("",new Du(o))}}}var gs,gt,wu,tB,Pg,vg,rB,ha,Cu,sB,nB,cte,iB,ute,Lg,Ug,oB,Dg,Ea,lte,Mg,Z0,eB,Lu,Du,vd=Te(()=>{gs=require("fs"),gt=require("path"),wu=require("worker_threads"),tB=require("yaml"),Pg=U(X()),vg=U(y());BA();GA();xA();OP();a0();d0();rB=U(require("fast-glob")),ha=U(Je()),Cu=U(G());vE();hr();sB=U(j());ss();fe();S0();nB=U(X()),cte=U(A0());yd();k0();J0();iB=U(gr());Cg();({readFile:ute}=gs.promises),Lg=Pg.get(vg.CONFIG_PARAMS.COMPONENTSROOT),Ug=new Map,Ea=new Map;a(aB,"loadComponentDirectories");lte={REST:zd,rest:zd,graphqlSchema:PE,jsResource:HE,fastifyRoutes:og,login:FE,static:ag,operationsApi:cte,customFunctions:{},http:{},clustering:Tg,authentication:su,mqtt:bg},Mg={rest:!0,graphqlSchema:{files:"*.graphql"},jsResource:{files:"resources.js"},fastifyRoutes:{files:"routes/*.js",path:"."}};Object.defineProperty(Mg,"static",{value:{files:"web/**"}});Z0=[],eB=new Map;a(_te,"setErrorReporter");a(Pf,"loadComponent");Du=class extends Ot{constructor(r){super();this.error=r}static{a(this,"ErrorResource")}get(){throw this.error}post(){throw this.error}put(){throw this.error}delete(){throw this.error}connect(){throw this.error}getResource(){return this}publish(){throw this.error}subscribe(){throw this.error}}});var Hg=T((iEe,uB)=>{var{isMainThread:cB}=require("worker_threads"),{getTables:dte}=(fe(),Z(Ce)),{loadComponentDirectories:fte,loadComponent:Ete}=(vd(),Z(Pd)),{resetResources:hte}=(ru(),Z(kU)),mte=tT(),pte=gr(),{dirname:Ste}=require("path"),{getConnection:Tte}=_t(),gte=X(),Rte=y(),Bg=new Map;async function Ate(e=!1){!cB&&gte.get(Rte.CONFIG_PARAMS.CLUSTERING_ENABLED)&&Tte();try{cB&&await mte()}catch(s){console.error(s)}let t=hte();dte(),t.isWorker=e,await Ete(Ste(pte.getConfigFilePath()),t,"hdb",!0,Bg),await fte(Bg,t);let r=[];for(let[s]of Bg)s.ready&&r.push(s.ready());r.length>0&&await Promise.all(r)}a(Ate,"loadRootComponents");uB.exports.loadRootComponents=Ate});var Je=T((aEe,ai)=>{"use strict";var{Worker:Ote,MessageChannel:Nte,parentPort:Ws,isMainThread:kg,threadId:bte,workerData:wn}=require("worker_threads"),{PACKAGE_ROOT:yte}=y(),{join:dB,isAbsolute:Ite,extname:wte}=require("path"),{server:fB}=(hr(),Z(hi)),{watch:Cte,readdir:Lte}=require("fs/promises"),{totalmem:lB}=require("os"),Hf=y(),Dte=X(),Cn=G(),{randomBytes:Ute}=require("crypto"),{_assignPackageExport:Mte}=require("../../index"),Pte=y(),vte=1024*1024,oi=[],Xr=[],Bte=50,Vg=1e4,Hte="restart",EB="request_thread_info",hB="resource_report",mB="thread_info",pB="added-port",qte="ack",qg;Mte("threads",Xr);ai.exports={startWorker:Fg,restartWorkers:Yg,shutdownWorkers:Vte,workers:oi,setMonitorListener:Xte,onMessageFromWorkers:$te,onMessageByType:OB,broadcast:Kte,broadcastWithAcknowledgement:Qte,setChildListenerByType:kte,getWorkerIndex:SB,getWorkerCount:TB,getTicketKeys:gB,setMainIsWorker:Gte,setTerminateTimeout:Fte,restartNumber:wn?.restartNumber||1};Xr.onMessageByType=OB;Xr.sendToThread=function(e,t){if(!t?.type)throw new Error("A message with a type must be provided");let r=Xr.find(s=>s.threadId===e);if(r)return r.postMessage(t),!0};var $g;function Fte(e){Vg=e}a(Fte,"setTerminateTimeout");function SB(){return wn?wn.workerIndex:$g?0:void 0}a(SB,"getWorkerIndex");function TB(){return wn?wn.workerCount:$g?1:void 0}a(TB,"getWorkerCount");function Gte(e){$g=e}a(Gte,"setMainIsWorker");var vf;function gB(){return vf||(vf=kg?Ute(48):wn.ticketKeys,vf)}a(gB,"getTicketKeys");Object.defineProperty(fB,"workerIndex",{get(){return SB()}});Object.defineProperty(fB,"workerCount",{get(){return TB()}});var RB={[EB](e,t){zte(t)},[hB](e,t){Jte(t,e)}};function Fg(e,t={}){let r=process.constrainedMemory?.()||lB();r=Math.min(r,lB());let s=Math.max(Math.floor(r/vte/(1+(t.threadCount||1)/4)),512),n=Math.min(Math.max(s>>7,16),64),i=[],o=[];for(let u of Xr){let _=new Nte;_.existingPort=u,i.push(_),o.push(_.port2)}wte(e)||(e+=".js");let c=new Ote(Ite(e)?e:dB(yte,e),Object.assign({resourceLimits:{maxOldGenerationSizeMb:s,maxYoungGenerationSizeMb:n},execArgv:["--enable-source-maps"],argv:process.argv.slice(2),workerData:{addPorts:o,addThreadIds:i.map(u=>u.existingPort.threadId),workerIndex:t.workerIndex,workerCount:t.threadCount,name:t.name,restartNumber:ai.exports.restartNumber,ticketKeys:gB()},transferList:o},t));for(let{port1:u,existingPort:_}of i)_.postMessage({type:pB,port:u,threadId:c.threadId},[u]);return qf(c,!0),c.unexpectedRestarts=t.unexpectedRestarts||0,c.startCopy=()=>Fg(e,t),c.on("error",u=>{console.error("Worker error:",u),Cn.error("Worker error:",u)}),c.on("exit",u=>{oi.splice(oi.indexOf(c),1),!c.wasShutdown&&t.autoRestart!==!1&&(c.unexpectedRestarts<Bte?(t.unexpectedRestarts=c.unexpectedRestarts+1,Fg(e,t)):Cn.error(`Thread has been restarted ${c.restarts} times and will not be restarted`))}),c.on("message",u=>{RB[u.type]?.(u,c)}),oi.push(c),Zte(),t.onStarted&&t.onStarted(c),c.name=t.name,c}a(Fg,"startWorker");var xte=[Hf.THREAD_TYPES.HTTP];async function Yg(e=null,t=2,r=!0){if(kg){if(r){let{loadRootComponents:o}=Hg();await o()}ai.exports.restartNumber++,t<1&&(t=t*oi.length);let s=[],n=[];for(let o of oi.slice(0)){if(e&&o.name!==e||o.wasShutdown)continue;Cn.trace("sending shutdown request to ",o.threadId),o.postMessage({restartNumber:ai.exports.restartNumber,type:Hf.ITC_EVENT_TYPES.SHUTDOWN}),o.wasShutdown=!0,o.emit("shutdown",{});let c=xte.indexOf(o.name)>-1,u=new Promise(_=>{let l=setTimeout(()=>o.terminate(),Vg*2).unref();o.on("exit",()=>{clearTimeout(l),s.splice(s.indexOf(u)),!c&&r&&o.startCopy(),_()})});if(s.push(u),c&&r){let _=o.startCopy(),l=new Promise(d=>{let f=a(E=>{E.type===Pte.ITC_EVENT_TYPES.CHILD_STARTED&&(Cn.trace("Worker has started",_.threadId),d(),n.splice(n.indexOf(l)),_.off("message",f))},"startListener");Cn.trace("Waiting for worker to start",_.threadId),_.on("message",f)});n.push(l),s.length>=t&&await Promise.race(s),n.length>=t&&await Promise.race(n)}}await Promise.all(s),await Promise.all(n);let{restartService:i}=gd();r&&(e==="http"||!e)&&Dte.get(Hf.CONFIG_PARAMS.CLUSTERING_ENABLED)&&await i({service:"clustering"})}else Ws.postMessage({type:Hte,workerType:e})}a(Yg,"restartWorkers");function kte(e,t){RB[e]=t}a(kte,"setChildListenerByType");function Vte(e){return Yg(e,1/0,!1)}a(Vte,"shutdownWorkers");var AB=[];function $te(e){AB.push(e)}a($te,"onMessageFromWorkers");var Gg=new Map;function OB(e,t){let r=Gg.get(e);r||Gg.set(e,r=[]),r.push(t)}a(OB,"onMessageByType");var Yte=10;async function Kte(e){let t=0;for(let r of Xr)try{r.postMessage(e),t++>Yte&&(t=0,await new Promise(setImmediate))}catch(s){Cn.error("Unable to send message to worker",s)}}a(Kte,"broadcast");var Bf=new Map,Wte=1;function Qte(e){return new Promise(t=>{let r=0;for(let s of Xr)try{let n=Wte++,i=a(()=>{Bf.delete(n),--r===0&&t(),s!==Ws&&--s.refCount===0&&s.unref()},"ack_handler");i.port=s,s.ref(),s.refCount=(s.refCount||0)+1,Bf.set(e.requestId=n,i),s.hasAckCloseListener||(s.hasAckCloseListener=!0,s.on(s.close?"close":"exit",()=>{for(let[,o]of Bf)o.port===s&&o()})),s.postMessage(e),r++}catch(n){Cn.error("Unable to send message to worker",n)}r===0&&t()})}a(Qte,"broadcastWithAcknowledgement");function zte(e){e.postMessage({type:mB,workers:NB()})}a(zte,"sendThreadInfo");function NB(){let e=Date.now();return oi.map(t=>({threadId:t.threadId,name:t.name,heapTotal:t.resources?.heapTotal,heapUsed:t.resources?.heapUsed,externalMemory:t.resources?.external,arrayBuffers:t.resources?.arrayBuffers,sinceLastUpdate:e-t.resources?.updated,...t.recentELU}))}a(NB,"getChildWorkerInfo");function Jte(e,t){e.resources=t,e.resources.updated=Date.now()}a(Jte,"recordResourceReport");var xg;function Xte(e){xg=e}a(Xte,"setMonitorListener");var jte=1e3,_B=!1;function Zte(){_B||(_B=!0,setInterval(()=>{for(let e of oi){let t=e.performance.eventLoopUtilization(),r;e.lastTotalELU?r=e.performance.eventLoopUtilization(t,e.lastTotalELU):r=t,e.lastTotalELU=t,e.recentELU=r}xg&&xg()},jte).unref())}a(Zte,"startMonitoring");var ere=1e3;if(Ws){qf(Ws);for(let e=0,t=wn.addPorts.length;e<t;e++){let r=wn.addPorts[e];r.threadId=wn.addThreadIds[e],qf(r)}setInterval(()=>{let e=process.memoryUsage();Ws.postMessage({type:hB,heapTotal:e.heapTotal,heapUsed:e.heapUsed,external:e.external,arrayBuffers:e.arrayBuffers})},ere).unref(),qg=a(()=>new Promise((e,t)=>{Ws.on("message",r),Ws.postMessage({type:EB});function r(s){s.type===mB&&(Ws.off("message",r),e(s.workers))}a(r,"receiveThreadInfo")}),"getThreadInfo")}else qg=NB;ai.exports.getThreadInfo=qg;function qf(e,t){Xr.push(e),e.on("message",r=>{if(r.type===pB)r.port.threadId=r.threadId,qf(r.port);else if(r.type===qte){let s=Bf.get(r.id);s&&s()}else{for(let n of AB)n(r,e);let s=Gg.get(r.type);if(s)for(let n of s)try{n(r,e)}catch(i){Cn.error(i)}}}).on("close",()=>{Xr.splice(Xr.indexOf(e),1)}).on("exit",()=>{Xr.splice(Xr.indexOf(e),1)}),t?e.refCount=100:e.unref()}a(qf,"addPort");if(kg){let e,t,r=a(async(s,n)=>{n&&(e=n);for(let i of await Lte(s,{withFileTypes:!0}))i.isDirectory()&&i.name!=="node_modules"&&r(dB(s,i.name));try{for await(let{filename:i}of Cte(s,{persistent:!1}))t&&clearTimeout(t),t=setTimeout(async()=>{e&&await e(),await Yg(),console.log("Reloaded HarperDB components")},100)}catch(i){console.warn("Error trying to watch component directory",s,i)}},"watch_dir");ai.exports.watchDir=r,process.env.WATCH_DIR&&r(process.env.WATCH_DIR)}else Ws.on("message",async e=>{let{type:t}=e;t===Hf.ITC_EVENT_TYPES.SHUTDOWN&&(ai.exports.restartNumber=e.restartNumber,Ws.unref(),setTimeout(()=>{Cn.warn("Thread did not voluntarily terminate",bte),process.exit(0)},Vg).unref())})});function yB(e,t,r,s,n){let i=e.primaryStore.env.path,o=e.primaryStore.tableId;ma||((0,Mu.onMessageByType)(bB,d=>{IB(d.path)}),(0,Mu.onMessageByType)(tre,d=>{(0,Uu.trace)("confirming to proceed with txn",d.txnId)}),ma=Object.create(null));let c=ma[i]||(ma[i]=[]);c.auditStore=e.auditStore;let u=c[o];u||(u=c[o]=new Map,u.envs=c,u.tableId=o,u.store=e.primaryStore),t=Qo(t);let _=new Wg(r);_.startTime=s,n&&(_.includeDescendants=n);let l=u.get(t);return l?l.push(_):(u.set(t,l=[_]),l.tables=u,l.key=t),_.subscriptions=l,_}function IB(e,t){if(!ma)return;let r=ma[e];if(!r)return;try{r.auditStore.resetReadTxn()}catch(n){throw n.message+=" in "+e,n}let s;for(let{key:n,value:i}of r.auditStore.getRange({start:Kg,exclusiveStart:!0})){Kg=n;let o=pr(i),c=r[o.tableId];if(!c)continue;let u=o.recordId,_,l=Qo(o.recordId),d;do{let f=c.get(l);if(f){for(let h of f)if(!(d&&!h.includeDescendants)){if(h.startTime>=n){(0,Uu.info)("omitting",u,h.startTime,n);continue}try{if(h.crossThreads===!1&&!t)continue;let S;h.supportsTransactions&&h.txnInProgress!==o.version&&(S=!0,h.txnInProgress||(s?s.push(h):s=[h]),h.txnInProgress=o.version),h.listener(u,o,n,S)}catch(S){console.error(S),(0,Uu.info)(S)}}}if(l==null)break;let E=l.lastIndexOf?.("/",l.length-2);E>-1?l=l.slice(0,E+1):l=null,d=!0}while(!0)}if(s)for(let n of s)n.txnInProgress=null,n.listener(null,{type:"end_txn"},Kg,!0)}function wB(e,t){let r=t||e,s=r.env;if(t&&!t.cache&&(t.cache=new Map),!s.hasBroadcastListener){s.hasBroadcastListener=!0;let n=s.path;r.on("aftercommit",()=>{(0,Mu.broadcast)({type:bB,path:n}),IB(n,!0)})}}var Uu,Mu,bB,tre,ma,fEe,Wg,Kg,CB=Te(()=>{Uu=U(G()),Mu=U(Je());Ba();ru();oo();bB="transaction",tre="transaction-await",fEe=Buffer.alloc(4096);a(yB,"addSubscription");Wg=class extends ts{static{a(this,"Subscription")}listener;subscriptions;startTime;constructor(t){super(),this.listener=t,this.on("close",()=>this.end())}end(){if(this.subscriptions){if(this.subscriptions.splice(this.subscriptions.indexOf(this),1),this.subscriptions.length===0){let t=this.subscriptions.tables,r=this.subscriptions.key;if(t.delete(r),t.size===0){let s=t.envs,n=t.dbi;delete s[n]}}this.subscriptions=null}}toJSON(){return{name:"subscription"}}},Kg=Date.now();a(IB,"notifyFromTransactionData");a(wB,"listenToCommits")});var kT={};qe(kT,{coerceType:()=>Vf,makeTable:()=>Yf,setServerUtilities:()=>cre,updateResource:()=>Hu});function Yf(e){let{primaryKey:t,indices:r,tableId:s,tableName:n,primaryStore:i,databasePath:o,databaseName:c,auditStore:u,schemaDefined:_,dbisDB:l}=e,{expirationMS:d,evictionMS:f,audit:E,trackDeletes:h}=e,{attributes:S}=e;S||(S=[]),wB(i,u);let p=oh(i,s,u),g=0,b,O,Y,W={},F=Promise.resolve(),w,K,B;for(let J of S)(J.assignCreatedTime||J.name==="__createdtime__")&&(w=J),(J.assignUpdatedTime||J.name==="__updatedtime__")&&(K=J),J.expiresAt&&(B=J),J.isPrimaryKey&&(W=J);let x,te=[],be=[],se=1,vt=2,Pe={},At={},Zr=864e5,fR,Qu,EH=10,hH=6;E&&mR();class at extends Ot{static name=n;static primaryStore=i;static auditStore=u;static primaryKey=t;static tableName=n;static indices=r;static audit=E;static databasePath=o;static databaseName=c;static attributes=S;static expirationTimer;static createdTimeProperty=w;static updatedTimeProperty=K;static sources=[];static get expirationMS(){return d}static dbisDB=l;static schemaDefined=_;static sourcedFrom(m,R){R&&(this.sourceOptions=R,(R.expiration||R.eviction||R.scanInterval)&&this.setTTLExpiration(R)),R?.intermediateSource?(m.intermediateSource=!0,this.sources.unshift(m)):this.sources.push(m),O=m.get&&(!m.get.reliesOnPrototype||m.prototype.get);let P=a(I=>{let L=this.sources.slice(0,-1);if(L=L.filter(D=>D[I]&&(!D[I].reliesOnPrototype||D.prototype[I])),L.length>0)if(L.length===1){let D=L[0];return(V,Q,oe)=>{if(V?.source!==D)return D[I](Q,oe,V)}}else return(D,V,Q)=>{let oe=[];for(let k of L){if(D?.source===k)break;oe.push(k[I](V,Q,D))}return Promise.all(oe)}},"getApplyToIntermediateSource"),A=this.sources[this.sources.length-1],C=a(I=>{if(A[I]&&(!A[I].reliesOnPrototype||A.prototype[I]))return(L,D,V)=>{if(!L?.source)return A[I](D,V,L)}},"getApplyToCanonicalSource");return Pe={put:C("put"),delete:C("delete"),publish:C("publish")},At={put:P("put"),delete:P("delete"),publish:P("publish"),invalidate:P("invalidate")},(async()=>{let I=!1,L=a(async(D,V)=>{let Q=D.value,oe=D.table?xe[c][D.table]:at;if(c===Rs.SYSTEM_SCHEMA_NAME&&(D.table===Rs.SYSTEM_TABLE_NAMES.ROLE_TABLE_NAME||D.table===Rs.SYSTEM_TABLE_NAMES.USER_TABLE_NAME)&&(I=!0),D.id===void 0&&(D.id=Q[oe.primaryKey],D.id===void 0))throw new Error("Replication message without an id "+JSON.stringify(D));D.source=m;let k=await oe.getResource(D.id,V,Pu);switch(D.type){case"put":return k._writeUpdate(Q,Pu);case"delete":return k._writeDelete(Pu);case"publish":return k._writePublish(Q,Pu);case"invalidate":return k.invalidate(Pu);default:We.error("Unknown operation",D.type,D.id)}},"writeUpdate");try{let D=m.subscribe;D&&h==null&&(h=!0);let V=m.subscribeOnThisThread?m.subscribeOnThisThread((0,ji.getWorkerIndex)()):(0,ji.getWorkerIndex)()===0,Q=D&&V&&await m.subscribe?.({crossThreads:!1,inTransactionUpdates:!0,supportsTransactions:!0,omitCurrent:!0});if(Q){let oe;for await(let k of Q)try{if(!(k.type==="transaction"?k.writes[0]:k)){We.error("Bad subscription event",k);continue}if(k.source=m,oe)if(k.beginTxn)oe.resolve();else{L(k,oe);continue}if(k.type==="end_txn")continue;let Ne=Ge(k,()=>{if(k.type==="transaction"){let ne=[];for(let Bt of k.writes)try{ne.push(L(Bt,k))}catch($t){throw $t.message+=" writing "+JSON.stringify(Bt)+" of event "+JSON.stringify(k),$t}return Promise.all(ne)}else if(k.type==="define_schema"){let ne=this.attributes.slice(0),Bt;for(let $t of k.attributes)ne.find(li=>li.name===$t.name)||(ne.push($t),Bt=!0);Bt&&(et({table:n,database:c,attributes:ne,origin:"cluster"}),Fu.signalSchemaChange(new Gu.SchemaEventMsg(process.pid,Rs.OPERATIONS_ENUM.CREATE_TABLE,c,n)))}else return k.beginTxn?(oe=k,L(k,k),new Promise(ne=>{oe.resolve=ne})):L(k,k)});I&&(await Ne,Fu.signalUserChange(new Gu.UserEventMsg(process.pid))),k.onCommit&&(Ne?.then?Ne.then(k.onCommit):k.onCommit())}catch(Ee){We.error("error in subscription handler",Ee)}}}catch(D){We.error(D)}})(),this}static getResource(m,R,P){let A=super.getResource(m,R,P);if(m!=null)try{if(A.hasOwnProperty(ge))return A;if(typeof m=="object"&&m&&!Array.isArray(m))throw new Error(`Invalid id ${JSON.stringify(m)}`);let C=!P?.async||i.cache?.get(m),I=Un(R),L=I.getReadTxn();if(L?.isDone)throw new Error("You can not read from a transaction that has already been committed/aborted");return ER(m,R,{transaction:L},C,D=>{if(D?Hu(A,D):A[ge]=null,R.onlyIfCached&&R.noCacheStore){if(!A.doesExist())throw new zs.ServerError("Entry is not cached",504)}else if(P?.ensureLoaded){let V=iE(m,D,R,A);if(V)return I?.disregardReadTxn(),A[zg]=!0,Xg(V,Q=>(Hu(A,Q),A))}return A})}catch(C){throw C.message.includes("Unable to serialize object")&&(C.message+=": "+JSON.stringify(m)),C}return A}ensureLoaded(){let m=iE(this[Ie],this[Qs],this[me]);if(m)return this[zg]=!0,Xg(m,R=>{this[Qs]=R,this[ge]=R.value,this[kf]=R.version})}static setTTLExpiration(m){if(typeof m=="number")d=m*1e3,f||(f=0);else if(m&&typeof m=="object")d=m.expiration*1e3,f=(m.eviction||0)*1e3,Zr=m.scanInterval*1e3;else throw new Error("Invalid expiration value type");if(d<0)throw new Error("Expiration can not be negative");Zr=Zr||(d+f)/4,oE()}static enableAuditing(m=!0){E=m,m&&mR(),at.audit=m}static coerceId(m){return m===""?null:Vf(m,W)}static async dropTable(){if(delete xe[c][n],c===o){for(let m of S)l.remove(at.tableName+"/"+m.name),r[m.name]?.drop();l.remove(at.tableName+"/"),i.drop(),await l.committed}else console.log("legacy dropTable"),await i.close(),await fs.remove(data_path),await fs.remove(data_path===standard_path?data_path+MDB_LOCK_FILE_SUFFIX:path.join(path.dirname(data_path),MDB_LEGACY_LOCK_FILE_NAME));Fu.signalSchemaChange(new Gu.SchemaEventMsg(process.pid,Rs.OPERATIONS_ENUM.DROP_TABLE,c,n))}static get(m,R){if(m&&typeof m=="object"&&!Array.isArray(m)&&m.url===""){let P=this.getRecordCount();return{recordCount:P.recordCount,estimatedRecordRange:P.estimatedRange,records:"./",name:n,database:c,attributes:S}}return super.get(m,R)}get(m){if(typeof m=="string")return this.getProperty(m);if(this[ws])return this.search(m);if(m?.property)return this.getProperty(m.property);if(this.doesExist()||m?.ensureLoaded===!1||this[me]?.returnNonexistent)return this}static allowRead(m,R){if(!m)return!1;let P=m.role.permission;if(P.super_user)return!0;if(P[n]?.read){let A=P[n].attribute_permissions;if(A){R||(R={});let C=R.select;if(C){let I=Jg(A,"read");R.select=C.filter(L=>I[L])}else R.select=A.filter(I=>I.read).map(I=>I.attribute_name);return R}else return!0}}allowUpdate(m,R,P){if(!m)return!1;let A=m.role.permission;if(A.super_user)return!0;if(A[n]?.update){let C=A[n].attribute_permissions;if(C){let I=Jg(C,"update");for(let L in R)if(!I[L])return!1;if(P)for(let L of C){let D=L.attribute_name;!L.update&&!(D in R)&&(R[D]=this.getProperty(D))}}else return!0}}allowCreate(m,R){return this.allowUpdate(m,{})}static allowCreate(m,R){if(!m)return!1;let P=m.role.permission;if(P.super_user)return!0;if(P[n]?.insert){let A=P[n].attribute_permissions;if(A){let C=Jg(A,"insert");for(let I in R)if(!C[I])return!1}else return!0}}static allowDelete(m){if(!m)return!1;let R=m.role.permission;if(R.super_user||R[n]?.delete)return!0}update(m,R){if(!Un(this[me]))throw new Error("Can not update a table resource outside of a transaction");if(m===!1)return this;let A;if(typeof m=="object"&&m)if(R){Object.isFrozen(m)&&(m=Object.assign({},m));for(let C in this[ge])m[C]===void 0&&(m[C]=void 0);this[Ht]=m}else A=this[Ht],A&&(m=Object.assign(A,m)),this[Ht]=A=m;return this._writeUpdate(this),this}invalidate(m){let R=this[me],P=this[Ie];Un(this[me]).addWrite({key:P,store:i,invalidated:!0,entry:this[Qs],nodeName:this[me]?.nodeName,before:Pe.invalidate?.bind(this,R,P),beforeIntermediate:At.invalidate?.bind(this,R,P),commit:(C,I)=>{if(I?.version>C)return;let L=null;for(let D in r)L||(L={}),L[D]=this.getProperty(D);p(P,L,this[Qs],C,Ff,E,this[me],0,"invalidate")}})}static evict(m,R,P){let A=this.Source,C;if(!((O||E)&&(!R||(C=i.getEntry(m),!C||!R)||C.version!==P))){if(O){if(i.hasLock(m,C.version))return;let I;for(let L in r)I||(I={}),I[L]=R[L];if(I){p(m,I,C,P,Gf,null,null,0,null,!0);return}}if(i.ifVersion(P,()=>{zu(m,R,null)}),E)p(m,null,C,P,Gf,null,null,0,null,!0);else return i.remove(m,P)}}lock(){throw new Error("Not yet implemented")}static operation(m,R){return m.table||=n,m.schema||=c,BB.operation(m,R)}async put(m){this.update(m,!0)}_writeUpdate(m,R){let P=this[me],A=Un(P),C=this[Ie];if(C===void 0)throw new Error("Can not save record without an id");let I=this[Qs];this[Qg]=!0;let L={key:C,store:i,entry:I,nodeName:P?.nodeName,validate:D=>{if(!m[DB]||ul(m)){if(this.validate(m),P?.source?m=Ha(m):(t&&m[t]!==C&&(m[t]=C),K&&(m[K.name]=K.type==="Date"?new Date(D):K.type==="String"?new Date(D).toISOString():D),w&&(I?.value?m[w.name]=I?.value[w.name]:m[w.name]=w.type==="Date"?new Date(D):w.type==="String"?new Date(D).toISOString():D),m=Ha(m)),m[ge])throw new Error("Can not assign a record with a record property");this[ge]=m}else A.removeWrite(L)},before:Pe.put&&(()=>Pe.put(P,C,m)),beforeIntermediate:At.put&&(()=>At.put(P,C,m)),commit:(D,V,Q)=>{Q&&(P&&V?.version>(P.lastModified||0)&&(P.lastModified=V.version),Hu(this,V));let oe=V?.value;this[Qg]=!1,We.trace("Checking timestamp for put",C,V?.version>D,V?.version,D),!(V?.version>D)&&(zu(C,oe,m),p(C,m,V,D,0,E,P,P.expiresAt||(d?d+Date.now():0)))}};A.addWrite(L)}async delete(m){if(typeof m=="string")return this.deleteProperty(m);if(this[ws]){for await(let R of this.search(m))(await at.getResource(R[t],this.getContext(),{ensureLoaded:!1}))._writeDelete(m);return}return this[ge]?this._writeDelete(m):!1}_writeDelete(m){let R=Un(this[me]),P,A=this[Ie],C=this[me];return R.addWrite({key:A,store:i,resource:this,nodeName:C?.nodeName,before:Pe.delete?.bind(this,C,A),beforeIntermediate:At.delete?.bind(this,C,A),commit:(I,L,D)=>{let V=L?.value;D&&(C&&L?.version>(C.lastModified||0)&&(C.lastModified=L.version),Hu(this,L)),!(L?.version>I)&&(zu(this[Ie],V),We.trace("Write delete entry",A,I),E||h?(p(A,null,this[Qs],I,0,E,this[me],0,"delete"),E||oE()):i.remove(this[Ie]))}}),!0}search(m){let R=Un(this[me]);if(!m)throw new Error("No query provided");let P=m.reverse===!0,A=m.conditions;A?A.length===void 0&&(A=Array.from(A)):A=Array.isArray(m)?m:m[Symbol.iterator]?Array.from(m):[],this[Ie]&&(A=[{attribute:null,comparator:"prefix",value:this[Ie]}].concat(A));for(let k of A){let Ee=k[0]??k.attribute,Ne=Ee==null?W:S.find(ne=>ne.name==Ee);if(Ne)Ne.type&&(k[1]===void 0?k.value=C(k.value,Ne):k[1]=C(k[1],Ne));else if(Ee!=null)throw(0,zs.handleHDBError)(new Error,`${Ee} is not a defined attribute`,404)}function C(k,Ee){return Array.isArray(k)?k.map(Ne=>Vf(Ne,Ee)):Vf(k,Ee)}a(C,"coerceTypedValues"),A.length>1&&(A=(0,PB.sortBy)(A,k=>{if(k.estimated_count===void 0){let Ee=k.comparator||k.search_type;if(Ee===Bu.SEARCH_TYPES.EQUALS){let Ne=k[0]??k.attribute;if(Ne==null||Ne===t)k.estimated_count=1;else{let ne=r[Ne];k.estimated_count=ne?ne.getValuesCount(k[1]??k.value):1/0}}else Ee===Bu.SEARCH_TYPES.CONTAINS||Ee===Bu.SEARCH_TYPES.ENDS_WITH||Ee==="ne"?k.estimated_count=1/0:Ee===Bu.SEARCH_TYPES.STARTS_WITH||Ee==="prefix"?k.estimated_count=nre:k.estimated_count=sre}return k.estimated_count}));let I=R.getReadTxn();I.use();let L=m.select,D=A[0],V;if(!D)V=i.getRange(P?{end:!1,reverse:!0,transaction:I,lazy:L?.length<4}:{start:!1,transaction:I,lazy:L?.length<4}).map(({value:k})=>k?new Promise(Ee=>setImmediate(()=>Ee(k))):xf.SKIP);else{let k=wE(D,I,P,at,m.allowFullScan);if(!m.operator||m.operator.toLowerCase()==="and"){let Ee=A.slice(1).map(CE);V=oe(k,Ee)}else{for(let Ne=1;Ne<A.length;Ne++){let ne=A[Ne],Bt=wE(ne,I,P,at,m.allowFullScan);k=k.concat(Bt)}let Ee=new Set;k=k.filter(Ne=>Ee.has(Ne)?!1:(Ee.add(Ne),!0)),V=oe(k)}}(m.offset||m.limit!==void 0)&&(V=V.slice(m.offset,m.limit!==void 0?(m.offset||0)+m.limit:void 0)),V.onDone=()=>{I.done()};let Q=this[me];function oe(k,Ee){let Ne=Ee?.length,ne={transaction:I,lazy:Ne>0||L?.length<4,alwaysPrefetch:!0},Bt=m.ensureLoaded!==!1;function $t(li,He){if(Bt&&He!==void 0){let _r=!Q.onlyIfCached&&iE(He,li,Q,this);if(_r)return _r.then(SH=>$t(SH))}let Ns=li?.value;if(!Ns)return xf.SKIP;for(let _r=0;_r<Ne;_r++)if(!Ee[_r](Ns))return xf.SKIP;return Ns}return a($t,"processEntry"),k.map(li=>ER(li,Q,ne,!1,$t))}return a(oe,"idsToRecords"),V}async subscribe(m){if(!u)throw new Error("Can not subscribe to a table without an audit log");E||et({table:n,database:c,schemaDefined:_,attributes:S,audit:!0}),m||(m={});let R=yB(at,this[Ie]??null,function(I,L,D,V){try{let Q=L.getValue?.(i);this.send({id:I,timestamp:D,value:Q,version:L.version,type:L.type,beginTxn:V})}catch(Q){We.error(Q)}},m.startTime,this[ws]);m.crossThreads===!1&&(R.crossThreads=!1),m.supportsTransactions&&(R.supportsTransactions=!0);let P=this[Ie],A=m.previousCount;A>1e3&&(A=1e3);let C=m.startTime;if(this[ws]){if(C){if(A)throw new zs.ClientError("startTime and previousCount can not be combined for a table level subscription");for(let{key:I,value:L}of u.getRange({start:C,exclusiveStart:!0})){let D=pr(L,i);if(D.tableId!==s)continue;let V=D.recordId;(P==null||MB(P,V))&&R.send({id:V,timestamp:I,...D}),R.startTime=I}}else if(A){let I=[];for(let{key:L,value:D}of u.getRange({start:"z",end:!1,reverse:!0}))try{let V=pr(D);if(V.tableId!==s)continue;let Q=V.recordId;if(P==null||MB(P,Q)){let oe=V.getValue(i);if(I.push({id:Q,timestamp:L,value:oe,version:V.version,type:V.type}),--A<=0)break}}catch(V){We.error("Error getting history entry",L,V)}for(let L=I.length;L>0;)R.send(I[--L]);I[0]&&(R.startTime=I[0].timestamp)}else if(!m.omitCurrent)for(let{key:I,value:L,version:D,localTime:V}of i.getRange({start:P??!1,end:P==null?void 0:[P,vB.MAXIMUM_KEY],versions:!0}))L&&R.send({id:I,version:D,timestamp:V,value:L})}else{A&&!C&&(C=0);let I=this[Qs]?.localTime;if(We.trace("Subscription from",C,"from",P),C<I){let L=[],D=I;do{let V=u.get(D);if(V){m.omitCurrent=!0;let Q=pr(V),oe=Q.getValue(i);L.push({id:P,value:oe,timestamp:D,...Q}),D=Q.previousLocalTime}else break;A&&A--}while(D>C&&A!==0);for(let V=L.length;V>0;)R.send(L[--V]);R.startTime=I}!m.omitCurrent&&this.doesExist()&&R.send({id:P,version:this[kf],timestamp:this[Qs]?.localTime,value:this})}return m.listener&&R.on("data",m.listener),R}doesExist(){return!!(this[ge]||this[Qg])}async publish(m,R){this._writePublish(m,R)}_writePublish(m,R){let P=Un(this[me]),A=this[Ie]||null,C=this[me];P.addWrite({key:A,store:i,entry:this[Qs],nodeName:C?.nodeName,validate:()=>{this.validate(m)},before:Pe.publish?.bind(this,C,A,m),beforeIntermediate:At.publish?.bind(this,C,A,m),commit:(I,L,D)=>{L===void 0&&h&&!E&&oE(),p(A,L?.value??null,L,L?.version||I,0,!0,C,L?.expiresAt,"message",!1,m)}})}validate(m){let R,P=a((A,C,I)=>{if(C.type&&A!=null)if(C.properties){typeof A!="object"&&(R||(R=[])).push(`Property ${I} must be an object${C.type?" ("+C.type+")":""}`);let L=C.properties;for(let D=0,V=L.length;D<V;D++){let Q=L[D],oe=P(A[Q.name],Q,I+"."+Q.name);oe&&(A[Q.name]=oe)}}else switch(C.type){case"Int":(typeof A!="number"||A>>0!==A)&&(R||(R=[])).push(`Property ${I} must be an integer (from -2147483648 to 2147483647)`);break;case"Long":(typeof A!="number"||!(Math.floor(A)===A&&Math.abs(A)<=9007199254740992))&&(R||(R=[])).push(`Property ${I} must be an integer (from -9007199254740992 to 9007199254740992)`);break;case"Float":typeof A!="number"&&(R||(R=[])).push(`Property ${I} must be a number`);break;case"ID":typeof A=="string"||A?.length>0&&A.every?.(L=>typeof L=="string")||(R||(R=[])).push(`Property ${I} must be a string, or an array of strings`);break;case"String":typeof A!="string"&&(R||(R=[])).push(`Property ${I} must be a string`);break;case"Boolean":typeof A!="boolean"&&(R||(R=[])).push(`Property ${I} must be a boolean`);break;case"Date":if(!(A instanceof Date)){if(typeof A=="string"||typeof A=="number")return new Date(A);(R||(R=[])).push(`Property ${I} must be a Date`)}break;case"Bytes":A instanceof Uint8Array||(R||(R=[])).push(`Property ${I} must be a Buffer or Uint8Array`);break;case"array":if(Array.isArray(A)){if(C.elements)for(let L=0,D=A.length;L<D;L++){let V=A[L],Q=P(V,C.elements,I+"[*]");Q&&(A[L]=Q)}}else(R||(R=[])).push(`Property ${I} must be a Buffer or Uint8Array`);break}C.nullable===!1&&A==null&&(R||(R=[])).push(`Property ${I} is required (and not does not allow null values)`)},"validateValue");for(let A=0,C=S.length;A<C;A++){let I=S[A],L=P(m[I.name],I,I.name);L&&(m[I.name]=L)}if(R)throw new zs.ClientError(R.join(". "))}getUpdatedTime(){return this[kf]}wasLoadedFromSource(){return O?!!this[zg]:void 0}static async addAttributes(m){let R=S.slice(0);for(let P of m){if(!P.name)throw new zs.ClientError("Attribute name is required");if(P.name.match(/[`/]/))throw new zs.ClientError("Attribute names cannot include backticks or forward slashes");R.push(P)}return et({table:n,database:c,schemaDefined:_,attributes:R}),at.indexingOperation}static async removeAttributes(m){let R=S.filter(P=>!m.includes(P.name));return et({table:n,database:c,schemaDefined:_,attributes:R}),at.indexingOperation}static getRecordCount(m){let R=i.getStats().entryCount,P=5e3,A=1e3,C;R>P&&!m?.exactCount&&(C=A);let I=0;for(let{value:L}of i.getRange({start:!0,lazy:!0,limit:C}))L!=null&&I++;if(C){let L=I;I=0;for(let{value:Bt}of i.getRange({start:"\uFFFF",reverse:!0,lazy:!0,limit:C}))Bt!=null&&I++;let D=C*2,V=(I+L)/D,Q=Math.pow((I-L+1)/C/2,2)+V*(1-V)/D,oe=Math.max(Math.sqrt(Q)*R,1),k=Math.round(V*R),Ee=Math.max(k-1.96*oe,0),Ne=Math.min(k+1.96*oe,R),ne=Math.pow(10,Math.round(Math.log10(oe)));return ne>k&&(ne=ne/10),I=Math.round(k/ne)*ne,{recordCount:I,estimatedRange:[Math.round(Ee),Math.round(Ne)]}}return{recordCount:I}}static updatedAttributes(){_l(this,this)}static async deleteHistory(m=0){let R;for(let{key:P,value:A}of u.getRange({start:0,end:m}))await vu(),pr(A).tableId===s&&(R=u.remove(P));await R}static async*getHistory(m=0,R=1/0){for(let{key:P,value:A}of u.getRange({start:m,end:R})){await vu();let C=pr(A);C.tableId===s&&(yield{id:C.recordId,localTime:P,version:C.version,type:C.type,value:C.getValue(i),user:C.user})}}static async getHistoryOfRecord(m){let R=[],P=i.getEntry(m);if(!P)return R;let A=P.localTime,C=0;do{await vu();let I=u.get(A);if(I){let L=pr(I);R.push({id:L.recordId,localTime:A,version:L.version,type:L.type,value:L.getValue(i),user:L.user}),A=L.previousLocalTime}else break}while(C<1e3&&A);return R.reverse()}static cleanup(){x?.remove()}}at.updatedAttributes();let mH=at.prototype;return mH[DB]=!0,d&&at.setTTLExpiration(d/1e3),B&&pH(),at;function zu(J,m,R){let P;for(let A in r){let C=r[A],I=C.isIndexing,L=R?.[A],D=m?.[A];if(L===D&&!I)continue;P=!0;let V=(0,qu.getIndexedValues)(D);if(V){LB&&C.prefetch(V.map(Q=>({key:Q,value:J})),UB);for(let Q=0,oe=V.length;Q<oe;Q++)C.remove(V[Q],J)}if(V=(0,qu.getIndexedValues)(L),V){LB&&C.prefetch(V.map(Q=>({key:Q,value:J})),UB);for(let Q=0,oe=V.length;Q<oe;Q++)C.put(V[Q],J)}}return P}a(zu,"updateIndices");function ER(J,m,R,P,A){let C=a(()=>{m?.transaction?.stale&&(m.transaction.stale=!1);let I=i.getEntry(J,R);return I&&m&&(I?.version>(m.lastModified||0)&&(m.lastModified=I.version),I?.localTime&&!m.lastRefreshed&&(m.lastRefreshed=I.localTime)),A(I,J)},"whenPrefetched");return P?C():se>0?(se--,C()):new Promise((I,L)=>{se===0?(se--,i.prefetch([J],()=>{D(),V()})):(te.push(J),be.push(V),te.length>hH&&(se--,D()));function D(){if(te.length>0){let Q=be;i.prefetch(te,()=>{se===-1?D():se++;for(let oe of Q)oe()}),te=[],be=[],vt>2&&vt--}else se=vt,vt<EH&&vt++}a(D,"prefetch");function V(){try{I(C())}catch(Q){L(Q)}}a(V,"load")})}a(ER,"loadLocalRecord");function iE(J,m,R,P){if(O){let A;if(R.noCache?A=!0:(m?(!m.value||m.metadataFlags&(Ff|Gf)||m.expiresAt&&m.expiresAt<Date.now())&&(A=!0):A=!0,xr(!A,"cache-hit",n)),A){let C=hR(J,m,R).then(I=>(I?.value?.[ge]&&We.error("Can not assign a record with a record property"),R&&(I?.version>(R.lastModified||0)&&(R.lastModified=I.version),R.lastRefreshed=Date.now()),I));if(R?.onlyIfCached||m?.value&&P?.allowStaleWhileRevalidate?.(m,J)){if(C.catch(I=>We.warn(I)),R?.onlyIfCached&&!P.doesExist())throw new zs.ServerError("Entry is not cached",504);return}else return C}}}a(iE,"ensureLoadedFromSource");function Un(J){let m=J?.transaction;if(m){if(!m.open)throw new Error("Can not use a transaction that is not open");if(!m.lmdbDb)return m.lmdbDb=i,m;do{if(m.lmdbDb?.path===i.path)return m;let R=m.next;if(!R)return m=m.next=new fi,m.lmdbDb=i,m;m=R}while(!0)}else return new El}a(Un,"txnForContext");async function hR(J,m,R){let P=m?.metadataFlags,A=m?.version,C,I;if(!i.attemptLock(J,A,()=>{clearTimeout(I);let Q=i.getEntry(J);!Q||!Q.value||Q.metadataFlags&(Ff|Gf)?C(hR(J,i.getEntry(J),R)):C(Q)}))return new Promise(Q=>{C=Q,I=setTimeout(()=>{i.unlock(J,A)},are)});let L=m?.value,D={requestContext:R,replacingRecord:L,replacingVersion:A,source:null,resourceCache:R?.resourceCache},V=R?.responseHeaders;return new Promise((Q,oe)=>{let k;Xg(Ge(D,async Ee=>{let Ne=performance.now(),ne,Bt,$t;try{for(let _r of at.sources)if(_r.get&&(!_r.get.reliesOnPrototype||_r.prototype.get)&&(D.source=_r,ne=await _r.get(J,D),ne))break;$t=P&Ff;let He=D.lastModified||$t&&A;Bt=$t||He>A||!L,He||(He=(0,qu.getNextMonotonicTime)());let Ns=performance.now()-Ne;if(br(Ns,"cache-resolution",n),V&&V.append("Server-Timing",`cache-resolve;dur=${Ns.toFixed(2)}`),Ee.timestamp=He,d&&!D.expiresAt&&(D.expiresAt=Date.now()+d),ne){if(typeof ne!="object")throw new Error("Only objects can be cached and stored in tables");typeof ne.toJSON=="function"&&(ne=ne.toJSON()),t&&ne[t]!==J&&(ne[t]=J)}k=!0,Q({version:He,value:ne})}catch(He){He.message+=` while resolving record ${J} for ${n}`,L&&((He.code==="ECONNRESET"||He.code==="ECONNREFUSED"||He.code==="EAI_AGAIN")&&!R?.mustRevalidate||R?.staleIfError&&(He.statusCode===500||He.statusCode===502||He.statusCode===503||He.statusCode===504))?(Q({version:A,value:L}),We.trace(He.message,"(returned stale record)")):oe(He),D.transaction.abort();return}if(R?.noCacheStore){D.transaction.abort();return}Un(D).addWrite({key:J,store:i,entry:m,nodeName:"source",commit:(He,Ns)=>{if(Ns?.version!==A)return;let _r=zu(J,L,ne);ne?(At.put?.(D,J,ne),p(J,ne,Ns,He,0,E&&Bt||null,D,D.expiresAt,"put",!!$t)):(At.delete?.(D,J),E||h?p(J,null,Ns,He,0,E&&Bt||null,D,0,"delete",!!$t):i.remove(J,A))}})}),()=>{i.unlock(J,A)},Ee=>{i.unlock(J,A),k&&We.error("Error committing cache update",Ee)})})}a(hR,"getFromSource");function oE(){if(Zr!==fR&&(fR=Zr,(0,ji.getWorkerIndex)()===(0,ji.getWorkerCount)()-1)){if(Qu&&clearTimeout(Qu),!Zr)return;let J=new Date;J.setMonth(0),J.setDate(1),J.setHours(0),J.setMinutes(0),J.setSeconds(0);let m=Math.ceil((Date.now()-J.getTime())/Zr)*Zr+J.getTime(),R=a(P=>{We.trace(`Scheduled next cleanup scan at ${new Date(P)}ms`),Qu=setTimeout(()=>F=F.then(async()=>{if(R(Math.max(P+Zr,Date.now())),i.rootStore.status!=="open"){clearTimeout(Qu);return}We.trace(`Starting cleanup scan for ${n}`);try{let A=0;for(let{key:C,value:I,version:L,expiresAt:D}of i.getRange({start:!1,snapshot:!1,versions:!0,lazy:!0}))I===null&&!E&&L+ore<Date.now()?i.remove(C,L):D&&D+f<Date.now()&&(at.evict(C,I,L),A++),await vu();We.trace(`Finished cleanup scan for ${n}, evicted ${A} entries`)}catch(A){We.trace(`Error in cleanup scan for ${n}:`,A)}}),Math.min(P-Date.now(),2147483647)).unref()},"startNextTimer");R(m)}}a(oE,"scheduleCleanup");function mR(){x=u?.addDeleteRemovalCallback(s,J=>{let m=i.getEntry(J);m?.value===null&&i.remove(J,m.version)})}a(mR,"addDeleteRemoval");function pH(){(0,ji.getWorkerIndex)()===0&&setInterval(async()=>{try{let J=B.name,m=r[J];if(!m)throw new Error(`expiresAt attribute ${B} must be indexed`);for(let{value:R}of m.getRange({start:!0,end:Date.now(),versions:!0,snapshot:!1})){let P=i.getEntry(R);P?.value?.[J]<Date.now()&&at.evict(R,P.value,P.version),await vu()}}catch(J){We.error("Error in evicting old records",J)}},ire).unref()}a(pH,"runRecordExpirationEviction")}function Jg(e,t){let r=e.attr_object||(e.attr_object={}),s=r[t];if(s)return s;s=r[t]=Object.create(null);for(let n of e)s[n.attribute_name]=n[t];return s}function UB(){}function cre(e){BB=e}function Vf(e,t){let r=t?.type;return e===null?e:r==="Int"||r==="Long"?parseInt(e):r==="Float"?parseFloat(e):r==="Date"?(typeof e!="number"&&!ure.test(e)&&(e+="Z"),new Date(e)):r?e:(0,$f.autoCast)(e)}function MB(e,t){if(e==null)return!0;if(!Array.isArray(t))return e===t;if(Array.isArray(e)){let r=e.length;if(e[r-1]===null&&r--,t.length>=r){for(let s=0;s<r;s++)if(t[s]!==e[s])return!1;return!0}return!1}else if(t[0]===e)return!0}function Xg(e,t,r){return e?.then?e.then(t,r):t(e)}function Hu(e,t){e[Qs]=t,e[ge]=t?.value??null,e[kf]=t?.version}var Rs,xf,qu,PB,Bu,xu,zs,Fu,Gu,We,vB,ji,$f,rre,BB,sre,nre,ire,ore,LB,are,kf,DB,Qs,Qg,zg,Pu,Ff,Gf,LEe,ure,vu,uf=Te(()=>{Rs=U(y()),xf=require("lmdb"),qu=U(Er()),PB=require("lodash");ss();bE();Bu=U(ze()),xu=U(X());CB();zs=U(j()),Fu=U(cn()),Gu=U(us());fe();ml();We=U(G());fl();Ei();vB=require("ordered-binary"),ji=U(Je());oo();$f=U($());Va();_n();rre=new Uint8Array(9);rre[8]=192;sre=1e8,nre=1e7,ire=6e4,ore=864e5;xu.initSync();LB=xu.get(Rs.CONFIG_PARAMS.STORAGE_PREFETCHWRITES),are=1e4,kf=Symbol.for("version"),DB=Symbol.for("incremental-update"),Qs=Symbol("entry"),Qg=Symbol("is-saving"),zg=Symbol("loaded-from-source"),Pu={isNotification:!0,ensureLoaded:!1},Ff=1,Gf=8,LEe=(0,$f.convertToMS)(xu.get(Rs.CONFIG_PARAMS.CLUSTERING_LEAFSERVER_STREAMS_MAXAGE))||864e5;a(Yf,"makeTable");a(Jg,"attributesAsObject");a(UB,"noop");a(cre,"setServerUtilities");ure=/[+-][0-9]{2}:[0-9]{2}|[a-zA-Z]$/;a(Vf,"coerceType");a(MB,"isDescendantId");vu=a(()=>new Promise(setImmediate),"rest");a(Xg,"when");a(Hu,"updateResource")});var Ce={};qe(Ce,{database:()=>Tc,databases:()=>xe,dropDatabase:()=>tp,dropTableMeta:()=>hre,getDatabases:()=>_s,getTables:()=>lre,onUpdatedTable:()=>gg,readMetaDb:()=>ku,resetDatabases:()=>_re,table:()=>et,tables:()=>mr});function lre(){return Jf||_s(),mr||{}}function _s(){if(Jf)return xe;Jf=!0,Ta=new Map;let e=(0,Vt.getHdbBasePath)()&&(0,Fe.join)((0,Vt.getHdbBasePath)(),Dr.DATABASES_DIR_NAME),t=(0,Vt.get)(Dr.CONFIG_PARAMS.DATABASES)||{};if(process.env.SCHEMAS_DATA_PATH&&(t.data={path:process.env.SCHEMAS_DATA_PATH}),e=process.env.STORAGE_PATH||(0,Vt.get)(Dr.CONFIG_PARAMS.STORAGE_PATH)||e&&((0,Lr.existsSync)(e)?e:(0,Fe.join)((0,Vt.getHdbBasePath)(),Dr.LEGACY_DATABASES_DIR_NAME)),!!e){if((0,Lr.existsSync)(e))for(let r of(0,Lr.readdirSync)(e,{withFileTypes:!0})){let s=(0,Fe.basename)(r.name,".mdb");r.isFile()&&(0,Fe.extname)(r.name).toLowerCase()===".mdb"&&!t[s]?.path&&ku((0,Fe.join)(e,r.name),null,s)}if((0,Lr.existsSync)((0,Sa.getBaseSchemaPath)())){for(let r of(0,Lr.readdirSync)((0,Sa.getBaseSchemaPath)(),{withFileTypes:!0}))if(!r.isFile()){let s=(0,Fe.join)((0,Sa.getBaseSchemaPath)(),r.name),n=(0,Fe.join)((0,Sa.getTransactionAuditStoreBasePath)(),r.name);for(let i of(0,Lr.readdirSync)(s,{withFileTypes:!0}))if(i.isFile()&&(0,Fe.extname)(i.name).toLowerCase()===".mdb"){let o=(0,Fe.join)(n,i.name);ku((0,Fe.join)(s,i.name),(0,Fe.basename)(i.name,".mdb"),r.name,o,!0)}}}if(t)for(let r in t){let s=t[r],n=s.path;if((0,Lr.existsSync)(n))for(let o of(0,Lr.readdirSync)(n,{withFileTypes:!0}))o.isFile()&&(0,Fe.extname)(o.name).toLowerCase()===".mdb"&&ku((0,Fe.join)(n,o.name),(0,Fe.basename)(o.name,".mdb"),r);let i=s.tables;if(i)for(let o in i){let c=i[o],u=(0,Fe.join)(c.path,(0,Fe.basename)(o+".mdb"));(0,Lr.existsSync)(u)&&ku(u,o,r,null,!0)}}for(let r in xe){let s=Ta.get(r);if(s){let n=xe[r];r.includes("delete")&&jr.trace(`defined tables ${Array.from(s.keys())}`);for(let i in n)s.has(i)||(jr.trace(`delete table class ${i}`),delete n[i])}else if(delete xe[r],r==="data"){for(let n in mr)delete mr[n];delete mr[Xf]}}return Ta=null,xe}}function _re(){Jf=!1;for(let[,e]of ci)e.needsDeletion=!0;_s();for(let[e,t]of ci)t.needsDeletion&&!e.endsWith("system.mdb")&&(t.close(),ci.delete(e));return xe}function ku(e,t,r=eR,s,n){let i=new jg.default(e,!1);try{let o=ci.get(e);o?o.needsDeletion=!1:(o=(0,Wf.open)(i),ci.set(e,o));let c=new Zi.default(!1),u=o.dbisDb||(o.dbisDb=o.openDB(Kf.INTERNAL_DBIS_NAME,c)),_=o.auditStore;_||(s?(0,Lr.existsSync)(s)&&(i.path=s,_=(0,Wf.open)(i),_.isLegacy=!0):_=Al(o));let l=GB(r),d=l[Xf],f=new Map;for(let{key:E,value:h}of u.getRange({start:!1})){let[S,p]=E.toString().split("/");p===""?p=h.name:p||(p=S,S=t,h.name||(h.name=p,h.indexed=!h.is_hash_attribute)),d?.add(S);let g=f.get(S);g||f.set(S,g={attributes:[]}),(p==null||h.is_hash_attribute)&&(g.primary=h),p!=null&&g.attributes.push(h),Object.defineProperty(h,"key",{value:E,configurable:!0})}for(let[E,h]of f){let{attributes:S,primary:p}=h;if(!p){for(let x of S)if(x.is_hash_attribute||x.isPrimaryKey){p=x;break}if(!p){jr.fatal(`Unable to find a primary key attribute on table ${E}, with attributes: ${JSON.stringify(S)}`);continue}}let g=l[E],b={},O=[],Y,W,F=typeof p.audit=="boolean"?p.audit:(0,Vt.get)(Dr.CONFIG_PARAMS.LOGGING_AUDITLOG),w=p.trackDeletes,K=p.expiration,B=p.eviction;if(g)b=g.indices,O=g.attributes,g.schemaVersion++;else{Y=p.tableId,Y?Y>=(u.get(pa)||0)&&u.putSync(pa,Y+1):(p.tableId=Y=u.get(pa),Y||(Y=1),u.putSync(pa,Y+1),u.putSync(p.key,p));let x=new Zi.default(!p.is_hash_attribute,p.is_hash_attribute);W=Il(o.openDB(p.key,x)),W.rootStore=o,W.tableId=Y}for(let x of S){x.attribute=x.name;try{if(!x.is_hash_attribute&&(x.indexed||x.attribute&&!x.name)){if(!b[x.name]){let be=new Zi.default(!x.is_hash_attribute,x.is_hash_attribute);b[x.name]=o.openDB(x.key,be)}let te=O.find(be=>be.name===x.name);te?O.splice(O.indexOf(te),1,x):O.push(x)}}catch(te){jr.error("Error trying to update attribute",x,O,b,te)}}if(!g){g=xB(l,E,Yf({primaryStore:W,auditStore:_,audit:F,expirationMS:K&&K*1e3,evictionMS:B&&B*1e3,trackDeletes:w,tableName:E,tableId:Y,primaryKey:p.name,databasePath:n?r+"/"+E:r,databaseName:r,indices:b,attributes:S,schemaDefined:p.schemaDefined,dbisDB:u})),g.schemaVersion=1;for(let x of tR)x(g)}}return o}catch(o){throw o.message+=` opening database ${e}`,o}}function GB(e){let t=xe[e];if(t||(e==="data"?t=xe[e]=mr:e==="system"?Object.defineProperty(xe,"system",{value:t=Object.create(null),configurable:!0}):t=xe[e]=Object.create(null)),Ta&&!Ta.has(e)){let r=new Set;t[Xf]=r,Ta.set(e,r)}return t}function xB(e,t,r){return e[t]=r,r}function Tc({database:e,table:t}){e||(e=eR),_s();let r=GB(e),s=(0,Fe.join)((0,Vt.getHdbBasePath)(),Dr.DATABASES_DIR_NAME),n=(0,Vt.get)(Dr.CONFIG_PARAMS.DATABASES)||{};process.env.SCHEMAS_DATA_PATH&&(n.data={path:process.env.SCHEMAS_DATA_PATH});let i=t&&n[e]?.tables?.[t]?.path;s=i||n[e]?.path||process.env.STORAGE_PATH||(0,Vt.get)(Dr.CONFIG_PARAMS.STORAGE_PATH)||((0,Lr.existsSync)(s)?s:(0,Fe.join)((0,Vt.getHdbBasePath)(),Dr.LEGACY_DATABASES_DIR_NAME));let o=(0,Fe.join)(s,(i?t:e)+".mdb"),c=ci.get(o);if(!c){let u=new jg.default(o,!1);c=(0,Wf.open)(u),ci.set(o,c)}return c}async function tp(e){if(!xe[e])throw new Error("Schema does not exist");let t=xe[e];for(let r in t){let n=t[r].primaryStore.rootStore;ci.delete(n.path),n.status==="open"&&(await n.close(),await HB.remove(n.path))}if(e==="data"){for(let r in mr)delete mr[r];delete mr[Xf]}delete xe[e]}function et({table:e,database:t,expiration:r,eviction:s,scanInterval:n,attributes:i,audit:o,trackDeletes:c,schemaDefined:u,origin:_}){t||(t=eR);let l=Tc({database:t,table:e}),d=xe[t],f=d?.[e];if(l.status==="closed")throw new Error(`Can not use a closed data store for ${e}`);let E,h,S,p;u==null&&(u=!0);let g=new Zi.default(!1);for(let w of i)w.attribute?(w.name=w.attribute,w.indexed=!0):w.attribute=w.name,w.expiresAt&&(w.indexed=!0);let b,O;if(f){if(E=f.primaryKey,f.primaryStore.rootStore.status==="closed")throw new Error(`Can not use a closed data store from ${e} class`);f.attributes.splice(0,f.attributes.length,...i)}else{let w=l.auditStore;w||(w=Al(l)),h=i.find(te=>te.isPrimaryKey)||{},E=h.name,h.is_hash_attribute=!0,h.schemaDefined=u,c&&(h.trackDeletes=!0),o=h.audit=typeof o=="boolean"?o:(0,Vt.get)(Dr.CONFIG_PARAMS.LOGGING_AUDITLOG),r&&(h.expiration=r),s&&(h.eviction=s),_&&(h.origins?h.origins.includes(_)||h.origins.push(_):h.origins=[_]),jr.trace(`${e} table loading, opening primary store`);let K=new Zi.default(!1,!0),B=e+"/",x=Il(l.openDB(B,K));x.rootStore=l,p=l.dbisDb=l.openDB(Kf.INTERNAL_DBIS_NAME,g),x.tableId=p.get(pa),x.tableId||(x.tableId=1),p.putSync(pa,x.tableId+1),h.tableId=x.tableId,f=xB(d,e,Yf({primaryStore:x,auditStore:w,audit:o,trackDeletes:c,expirationMS:r&&r*1e3,evictionMS:s&&s*1e3,primaryKey:E,tableName:e,tableId:x.tableId,databasePath:t,databaseName:t,indices:{},attributes:i,schemaDefined:u,dbisDB:p})),f.schemaVersion=1,b=!0,F(),p.put(B,h)}S=f.indices,p=p||(l.dbisDb=l.openDB(Kf.INTERNAL_DBIS_NAME,g)),f.dbisDB=p;let Y=[];for(let{key:w,value:K}of p.getRange({start:!0})){let[B,x]=w.toString().split("/");if(x===""&&(x=K.name),x){if(B!==e)continue}else x=B;if(!i.find(be=>be.name===x)?.indexed&&K.indexed&&!K.isPrimaryKey){F(),b=!0,p.remove(w);let be=f.indices[B];be&&Y.push(be)}}let W=[];try{for(let w of i||[]){let K=e+"/"+(w.name||"");Object.defineProperty(w,"key",{value:K,configurable:!0});let B=p.get(K);if(w.isPrimaryKey){if(B=B||p.get(K=e+"/")||{},o!==f.audit||(+r||void 0)!==(+B.expiration||void 0)||(+s||void 0)!==(+B.eviction||void 0)){let te=Object.assign({},B);typeof o=="boolean"&&(o&&f.enableAuditing(o),te.audit=o),r&&(te.expiration=+r),s&&(te.eviction=+s),b=!0,F(),p.put(K,te)}continue}B?.attribute&&!B.name&&(B.indexed=!0);let x=!B||B.type!==w.type||B.indexed!==w.indexed||JSON.stringify(B.attributes)!==JSON.stringify(w.attributes)||JSON.stringify(B.elements)!==JSON.stringify(w.elements);if(w.indexed){let te=new Zi.default(!0,!1),be=l.openDB(K,te);(x||B.indexingPID&&B.indexingPID!==process.pid||B.restartNumber<Vu.workerData?.restartNumber)&&(b=!0,F(),B=p.get(K),(x||B.indexingPID&&B.indexingPID!==process.pid||B.restartNumber<Vu.workerData?.restartNumber)&&(b=!0,w.lastIndexedKey=B?.lastIndexedKey||!1,w.indexingPID=process.pid,be.isIndexing=!0,Object.defineProperty(w,"dbi",{value:be}),W.push(w)),p.put(K,w)),S[w.name]=be}else x&&(b=!0,F(),p.put(K,w))}}finally{O&&O()}if(b&&(f.schemaVersion++,f.updatedAttributes()),jr.trace(`${e} table loading, running index`),W.length>0||Y.length>0?f.indexingOperation=Ere(f,W,Y):b&&Qf.signalSchemaChange(new zf.SchemaEventMsg(process.pid,"schema-change",f.databaseName,f.tableName)),f.origin=_,b)for(let w of tR)w(f,_!=="cluster");return(r||s||n)&&f.setTTLExpiration({expiration:r,eviction:s,scanInterval:n}),jr.trace(`${e} table loaded`),f;function F(){O||l.transactionSync(()=>({then(w){O=w}}))}a(F,"startTxn")}async function Ere(e,t,r){try{let s=e.schemaVersion;await Qf.signalSchemaChange(new zf.SchemaEventMsg(process.pid,"schema-change",e.databaseName,e.tableName));let n;for(let u of r)n=u.drop();let i,o=0,c=t.length;if(await new Promise(u=>setImmediate(u)),c>0){let u=0;for(let{key:_,value:l,version:d}of e.primaryStore.getRange({start:t[0].lastIndexedKey,lazy:c<4,versions:!0,snapshot:!1}))if(l){if(u++,n=e.primaryStore.ifVersion(_,d,()=>{for(let f=0;f<c;f++){let E=t[f],h=E.name,S=(0,qB.getIndexedValues)(l[h]);if(S)for(let p=0,g=S.length;p<g;p++)E.dbi.put(S[p],_)}}),n.then(()=>u--,f=>{u--,jr.error(f)}),Vu.workerData&&Vu.workerData.restartNumber!==FB.restartNumber&&(i=!0),++o%100===0||i){for(let f of t)f.lastIndexedKey=_,e.dbisDB.put(f.key,f);if(i)return}u>dre?await n:u>fre&&await new Promise(f=>setImmediate(f))}for(let _ of t)delete _.lastIndexedKey,delete _.indexingPID,_.dbi.isIndexing=!1,n=e.dbisDB.put(_.key,_)}await n,await Qf.signalSchemaChange(new zf.SchemaEventMsg(process.pid,"indexing-finished",e.databaseName,e.tableName))}catch(s){jr.error("Error in indexing",s)}}function hre({table:e,database:t}){let r=Tc({database:t,table:e}),s=[],n=r.dbisDb;for(let i of n.getKeys({start:e+"/",end:e+"0"}))s.push(n.remove(i));return Promise.all(s)}function gg(e){tR.push(e)}var Vt,Kf,Wf,Fe,Lr,Sa,Zi,jg,Dr,HB,Zg,qB,Qf,zf,Vu,jr,FB,eR,Xf,mr,xe,pa,tR,Jf,ci,Ta,dre,fre,fe=Te(()=>{Vt=U(X()),Kf=U(ze()),Wf=require("lmdb"),Fe=require("path"),Lr=require("fs"),Sa=U(ve());uf();Zi=U(wl()),jg=U(Ll()),Dr=U(y()),HB=U(require("fs-extra")),Zg=require("../../index"),qB=U(Er()),Qf=U(cn()),zf=U(us()),Vu=require("worker_threads"),jr=U(G()),FB=U(Je());oo();Va();eR="data",Xf=Symbol("defined-tables");(0,Vt.initSync)();mr=Object.create(null),xe=Object.create(null);(0,Zg._assignPackageExport)("databases",xe);(0,Zg._assignPackageExport)("tables",mr);pa=Symbol.for("next-table-id"),tR=[],ci=new Map;a(lre,"getTables");a(_s,"getDatabases");a(_re,"resetDatabases");a(ku,"readMetaDb");a(GB,"ensureDB");a(xB,"setTable");a(Tc,"database");a(tp,"dropDatabase");a(et,"table");dre=1e3,fre=10;a(Ere,"runIndexing");a(hre,"dropTableMeta");a(gg,"onUpdatedTable")});var $=T((FEe,tH)=>{"use strict";var ui=require("path"),KB=require("fs-extra"),lr=G(),kB=require("fs-extra"),jf=require("os"),mre=require("net"),pre=require("recursive-iterator"),Qe=y(),Sre=zR(),VB=require("papaparse"),Zf=require("moment"),{inspect:Tre}=require("util"),$B=require("is-number"),qEe=require("lodash"),gre=require("minimist"),Rre=require("https"),Are=require("http"),{hdb_errors:eE}=j(),Ore=/^((\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)))$/,WB=require("util").promisify(setTimeout),Nre=100,bre=5,yre="",Ire=4,YB={true:!0,TRUE:!0,FALSE:!1,false:!1,undefined:null,null:null,NULL:null,NaN:NaN};tH.exports={isEmpty:Ur,isEmptyOrZeroLength:Js,arrayHasEmptyValues:Lre,arrayHasEmptyOrZeroLengthValues:Dre,buildFolderPath:Ure,isBoolean:QB,errorizeMessage:wre,stripFileExtension:Pre,autoCast:vre,autoCastJSON:zB,autoCastJSONDeep:sR,removeDir:Bre,compareVersions:Hre,isCompatibleDataVersion:qre,escapeRawValue:Fre,unescapeValue:Gre,stringifyProps:xre,timeoutPromise:Vre,isClusterOperation:Yre,getClusterUser:Wre,checkGlobalSchemaTable:Kre,getHomeDir:XB,getPropsFilePath:kre,promisifyPapaParse:Qre,removeBOM:jB,createEventPromise:zre,checkProcessRunning:Jre,checkSchemaTableExist:Xre,checkSchemaExists:ZB,checkTableExists:eH,getStartOfTomorrowInSeconds:jre,getLimitKey:Zre,isObject:Mre,isNotEmptyAndHasValue:Cre,autoCasterIsNumberCheck:JB,backtickASTSchemaItems:ese,isPortTaken:$re,createForkArgs:tse,autoCastBoolean:rse,async_set_timeout:WB,getTableHashAttribute:sse,doesSchemaExist:nse,doesTableExist:ise,stringifyObj:ose,ms_to_time:ase,changeExtension:cse,getEnvCliRootPath:nR,noBootFile:use,httpRequest:lse,transformReq:_se,convertToMS:dse,PACKAGE_ROOT:Qe.PACKAGE_ROOT};function wre(e){return e instanceof Error?e:new Error(e)}a(wre,"errorizeMessage");function Ur(e){return e==null}a(Ur,"isEmpty");function Cre(e){return!Ur(e)&&(e||e===0||e===""||QB(e))}a(Cre,"isNotEmptyAndHasValue");function Js(e){return Ur(e)||e.length===0||e.size===0}a(Js,"isEmptyOrZeroLength");function Lre(e){if(Ur(e))return!0;for(let t=0;t<e.length;t++)if(Ur(e[t]))return!0;return!1}a(Lre,"arrayHasEmptyValues");function Dre(e){if(Js(e))return!0;for(let t=0;t<e.length;t++)if(Js(e[t]))return!0;return!1}a(Dre,"arrayHasEmptyOrZeroLengthValues");function Ure(...e){try{return e.join(ui.sep)}catch{console.error(e)}}a(Ure,"buildFolderPath");function QB(e){return Ur(e)?!1:e===!0||e===!1}a(QB,"isBoolean");function Mre(e){return Ur(e)?!1:typeof e=="object"}a(Mre,"isObject");function Pre(e){return Js(e)?yre:e.slice(0,-Ire)}a(Pre,"stripFileExtension");function vre(e){return Ur(e)||e===""||typeof e!="string"?e:YB[e]!==void 0?YB[e]:JB(e)===!0?Number(e):Ore.test(e)?new Date(e):e}a(vre,"autoCast");function zB(e){if(typeof e=="string"&&(e.startsWith("{")&&e.endsWith("}")||e.startsWith("[")&&e.endsWith("]")))try{return JSON.parse(e)}catch{}return e}a(zB,"autoCastJSON");function sR(e){if(e&&typeof e=="object"){if(Array.isArray(e))for(let t=0,r=e.length;t<r;t++){let s=e[t],n=sR(s);n!==s&&(e[t]=n)}else for(let t in e){let r=e[t],s=sR(r);s!==r&&(e[t]=s)}return e}else return zB(e)}a(sR,"autoCastJSONDeep");function JB(e){if(e.startsWith("0.")&&$B(e))return!0;let t=e.toUpperCase().includes("E");return!!((e!=="0"&&e.startsWith("0"))===!1&&t===!1&&$B(e))}a(JB,"autoCasterIsNumberCheck");async function Bre(e){if(Js(e))throw new Error(`Directory path: ${e} does not exist`);try{await kB.emptyDir(e),await kB.remove(e)}catch(t){throw lr.error(`Error removing files in ${e} -- ${t}`),t}}a(Bre,"removeDir");function Hre(e,t){if(Js(e)){lr.info("Invalid current version sent as parameter.");return}if(Js(t)){lr.info("Invalid upgrade version sent as parameter.");return}let r,s=/(\.0+)+$/,n=e.version?e.version:e,i=t.version?t.version:t,o=n.replace(s,"").split("."),c=i.replace(s,"").split("."),u=Math.min(o.length,c.length);for(let _=0;_<u;_++)if(r=parseInt(o[_],10)-parseInt(c[_],10),r)return r;return o.length-c.length}a(Hre,"compareVersions");function qre(e,t,r=!1){let s=e.toString().split("."),n=t.toString().split(".");return s[0]===n[0]&&(!r||s[1]===n[1])}a(qre,"isCompatibleDataVersion");function Fre(e){if(Ur(e))return e;let t=String(e);return t==="."?Qe.UNICODE_PERIOD:t===".."?Qe.UNICODE_PERIOD+Qe.UNICODE_PERIOD:t.replace(Qe.FORWARD_SLASH_REGEX,Qe.UNICODE_FORWARD_SLASH)}a(Fre,"escapeRawValue");function Gre(e){if(Ur(e))return e;let t=String(e);return t===Qe.UNICODE_PERIOD?".":t===Qe.UNICODE_PERIOD+Qe.UNICODE_PERIOD?"..":String(e).replace(Qe.ESCAPED_FORWARD_SLASH_REGEX,"/")}a(Gre,"unescapeValue");function xre(e,t){if(Ur(e))return lr.info("Properties object is null"),"";let r="";return e.each(function(s,n){try{if(t&&t[s]){let i=t[s];for(let o of i)r+=";"+o+jf.EOL}!Js(s)&&s[0]===";"?r+="	"+s+n+jf.EOL:Js(s)||(r+=s+"="+n+jf.EOL)}catch{lr.error(`Found bad property during upgrade with key ${s} and value: ${n}`)}}),r}a(xre,"stringifyProps");function XB(){let e;try{e=jf.homedir()}catch{e=process.env.HOME}return e||(e="~/"),e}a(XB,"getHomeDir");function kre(){let e=ui.join(XB(),Qe.HDB_HOME_DIR_NAME,Qe.BOOT_PROPS_FILE_NAME);return KB.existsSync(e)||(e=ui.join(__dirname,"../","hdb_boot_properties.file")),e}a(kre,"getPropsFilePath");function Vre(e,t){let r,s;return s=new Promise(function(n){r=setTimeout(function(){n(t)},e)}),{promise:s,cancel:function(){clearTimeout(r)}}}a(Vre,"timeoutPromise");async function $re(e){if(!e)throw new Error("Invalid port passed as parameter");return new Promise((t,r)=>{let s=mre.createServer().once("error",n=>{n.code==="EADDRINUSE"?t(!0):r(n)}).once("listening",()=>s.once("close",()=>t(!1)).close()).listen(e)})}a($re,"isPortTaken");function Yre(e){try{return Qe.CLUSTER_OPERATIONS[e.toLowerCase()]!==void 0}catch(t){lr.error(`Error checking operation against cluster ops ${t}`)}return!1}a(Yre,"isClusterOperation");function Kre(e,t){let r=(fe(),Z(Ce)).getDatabases();if(!r[e])return eE.HDB_ERROR_MSGS.SCHEMA_NOT_FOUND(e);if(!r[e][t])return eE.HDB_ERROR_MSGS.TABLE_NOT_FOUND(e,t)}a(Kre,"checkGlobalSchemaTable");function Wre(e,t){if(Ur(t)){lr.warn("No CLUSTERING_USER defined, clustering disabled");return}if(Ur(e)||Js(e)){lr.warn("No users to search.");return}let r;try{let s=e.get(t);s&&s.role.permission.cluster_user===!0&&s.active===!0&&(r=s)}catch(s){lr.error(`unable to find cluster_user due to: ${s.message}`);return}if(r===void 0){lr.warn(`CLUSTERING_USER: ${t} not found or is not active.`);return}return r}a(Wre,"getClusterUser");function Qre(){VB.parsePromise=function(e,t,r){return new Promise(function(s,n){VB.parse(e,{header:!0,transformHeader:jB,chunk:t.bind(null,n),skipEmptyLines:!0,transform:r,dynamicTyping:!1,error:n,complete:s})})}}a(Qre,"promisifyPapaParse");function jB(e){if(typeof e!="string")throw new TypeError(`Expected a string, got ${typeof e}`);return e.charCodeAt(0)===65279?e.slice(1):e}a(jB,"removeBOM");function zre(e,t,r){return new Promise(s=>{t.once(e,n=>{let i=r;lr.info(`Got cluster status event response: ${Tre(n)}`);try{i.cancel()}catch{lr.error("Error trying to cancel timeout.")}s(n)})})}a(zre,"createEventPromise");async function Jre(e){let t=!0,r=0;do await WB(Nre*r++),(await Sre.findPs(e)).length>0&&(t=!1);while(t&&r<bre);if(t)throw new Error(`process ${e} was not started`)}a(Jre,"checkProcessRunning");function Xre(e,t){let r=ZB(e);if(r)return r;let s=eH(e,t);if(s)return s}a(Xre,"checkSchemaTableExist");function ZB(e){let{getDatabases:t}=(fe(),Z(Ce));if(!t()[e])return eE.HDB_ERROR_MSGS.SCHEMA_NOT_FOUND(e)}a(ZB,"checkSchemaExists");function eH(e,t){let{getDatabases:r}=(fe(),Z(Ce));if(!r()[e][t])return eE.HDB_ERROR_MSGS.TABLE_NOT_FOUND(e,t)}a(eH,"checkTableExists");function jre(){let e=Zf().utc().add(1,Qe.MOMENT_DAYS_TAG).startOf(Qe.MOMENT_DAYS_TAG).unix(),t=Zf().utc().unix();return e-t}a(jre,"getStartOfTomorrowInSeconds");function Zre(){return Zf().utc().format("DD-MM-YYYY")}a(Zre,"getLimitKey");function ese(e){try{let t=new pre(e);for(let{node:r}of t)r&&(r.columnid&&typeof r.columnid!="string"&&(r.columnid=r.columnid.toString()),r.columnid&&!r.columnid.startsWith("`")&&(r.columnid_orig=r.columnid,r.columnid=`\`${r.columnid}\``),r.tableid&&!r.tableid.startsWith("`")&&(r.tableid_orig=r.tableid,r.tableid=`\`${r.tableid}\``),r.databaseid&&!r.databaseid.startsWith("`")&&(r.databaseid_orig=r.databaseid,r.databaseid=`\`${r.databaseid}\``),r.as&&typeof r.as=="string"&&!r.as.startsWith("[")&&(r.as_orig=r.as,r.as=`\`${r.as}\``))}catch(t){lr.error("Got an error back ticking items."),lr.error(t)}}a(ese,"backtickASTSchemaItems");function tse(e){return[e]}a(tse,"createForkArgs");function rse(e){return e===!0||typeof e=="string"&&e.toLowerCase()==="true"}a(rse,"autoCastBoolean");function sse(e,t){let{getDatabases:r}=(fe(),Z(Ce)),s=r()[e]?.[t];return s?.primaryKey||s?.hash_attribute}a(sse,"getTableHashAttribute");function nse(e){let{getDatabases:t}=(fe(),Z(Ce));return t()[e]!==void 0}a(nse,"doesSchemaExist");function ise(e,t){let{getDatabases:r}=(fe(),Z(Ce));return r()[e]?.[t]!==void 0}a(ise,"doesTableExist");function ose(e){try{return JSON.stringify(e)}catch{return e}}a(ose,"stringifyObj");function ase(e){let t=Zf.duration(e),r=t.seconds()>0?t.seconds()+"s":"",s=t.minutes()>0?t.minutes()+"m ":"",n=t.hours()>0?t.hours()+"h ":"",i=t.days()>0?t.days()+"d ":"";return(t.years()>0?t.years()+"y ":"")+i+n+s+r}a(ase,"ms_to_time");function cse(e,t){let r=ui.basename(e,ui.extname(e));return ui.join(ui.dirname(e),r+t)}a(cse,"changeExtension");function nR(){if(process.env[Qe.CONFIG_PARAMS.ROOTPATH.toUpperCase()])return process.env[Qe.CONFIG_PARAMS.ROOTPATH.toUpperCase()];let e=gre(process.argv);if(e[Qe.CONFIG_PARAMS.ROOTPATH.toUpperCase()])return e[Qe.CONFIG_PARAMS.ROOTPATH.toUpperCase()]}a(nR,"getEnvCliRootPath");var rR;function use(){if(rR)return rR;let e=nR();nR()&&KB.pathExistsSync(ui.join(e,Qe.HDB_CONFIG_FILE))&&(rR=!0)}a(use,"noBootFile");function lse(e,t){let r;return e.protocol==="http:"?r=Are:r=Rre,new Promise((s,n)=>{let i=r.request(e,o=>{o.setEncoding("utf8");let c={body:"",headers:o.headers};o.on("data",u=>{c.body+=u}),o.on("end",()=>{s(c)})});i.on("error",o=>{n(o)}),i.write(JSON.stringify(t)),i.end()})}a(lse,"httpRequest");function _se(e){if(!e.schema&&!e.database){e.schema=Qe.DEFAULT_DATABASE_NAME;return}e.database&&(e.schema=e.database)}a(_se,"transformReq");function dse(e){let t=0;if(typeof e=="number"&&(t=e),typeof e=="string")switch(t=parseFloat(e),e.slice(-1)){case"M":t*=86400*30;break;case"D":case"d":t*=86400;break;case"H":case"h":t*=3600;break;case"m":t*=60;break}return t*1e3}a(dse,"convertToMS")});var X=T((xEe,nH)=>{"use strict";var iR=require("fs-extra"),As=require("path"),rH=require("os"),fse=require("properties-reader"),$u=G(),eo=$(),ee=y(),tE=gr(),Ese="Error initializing environment manager",rE="BOOT_PROPS_FILE_PATH",sH=!1,hse={[ee.HDB_SETTINGS_NAMES.INSTALL_USER]:!0,[ee.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY]:!0,[ee.HDB_SETTINGS_NAMES.HDB_ROOT_KEY]:!0,BOOT_PROPS_FILE_PATH:!0},Ln={};nH.exports={BOOT_PROPS_FILE_PATH:rE,getHdbBasePath:mse,setHdbBasePath:pse,get:Sse,initSync:gse,setProperty:he,initTestEnvironment:Rse};function mse(){return Ln[ee.HDB_SETTINGS_NAMES.HDB_ROOT_KEY]}a(mse,"getHdbBasePath");function pse(e){Ln[ee.HDB_SETTINGS_NAMES.HDB_ROOT_KEY]=e}a(pse,"setHdbBasePath");function Sse(e){let t=tE.getConfigValue(e);return t===void 0?Ln[e]:t}a(Sse,"get");function he(e,t){hse[e]&&(Ln[e]=t),tE.updateConfigObject(e,t)}a(he,"setProperty");function Tse(){let e;try{e=eo.getPropsFilePath(),iR.accessSync(e,iR.constants.F_OK|iR.constants.R_OK),sH=!0;let t=fse(e);return Ln[ee.HDB_SETTINGS_NAMES.INSTALL_USER]=t.get(ee.HDB_SETTINGS_NAMES.INSTALL_USER),Ln[ee.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY]=t.get(ee.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY),Ln[rE]=e,!0}catch{return $u.trace(`Environment manager found no properties file at ${e}`),!1}}a(Tse,"doesPropFileExist");function gse(e=!1){try{(sH||Tse()||eo.noBootFile())&&(tE.initConfig(e),Ln[ee.HDB_SETTINGS_NAMES.HDB_ROOT_KEY]=tE.getConfigValue(ee.HDB_SETTINGS_NAMES.HDB_ROOT_KEY))}catch(t){$u.error(Ese),$u.error(t),console.error(t),process.exit(1)}}a(gse,"initSync");function Rse(e={}){try{let{keep_alive_timeout:t,headers_timeout:r,server_timeout:s,https_enabled:n,cors_enabled:i,cors_accesslist:o,local_studio_on:c}=e,u=As.join(__dirname,"../../","unitTests");Ln[rE]=As.join(u,"hdb_boot_properties.file"),he(ee.HDB_SETTINGS_NAMES.SETTINGS_PATH_KEY,As.join(u,"settings.test")),he(ee.HDB_SETTINGS_NAMES.INSTALL_USER,rH.userInfo()?rH.userInfo().username:void 0),he(ee.HDB_SETTINGS_NAMES.PRIVATE_KEY_KEY,As.join(u,"envDir","utility","keys","privateKey.pem")),he(ee.HDB_SETTINGS_NAMES.CERT_KEY,As.join(u,"envDir","utility","keys","certificate.pem")),he(ee.CONFIG_PARAMS.TLS_PRIVATEKEY,As.join(u,"envDir","utility","keys","privateKey.pem")),he(ee.CONFIG_PARAMS.TLS_CERTIFICATE,As.join(u,"envDir","utility","keys","certificate.pem")),he(ee.HDB_SETTINGS_NAMES.LOG_LEVEL_KEY,"debug"),he(ee.HDB_SETTINGS_NAMES.LOG_PATH_KEY,As.join(u,"envDir","log")),he(ee.HDB_SETTINGS_NAMES.LOG_DAILY_ROTATE_KEY,!1),he(ee.HDB_SETTINGS_NAMES.CLUSTERING_ENABLED_KEY,!0),he(ee.HDB_SETTINGS_NAMES.CLUSTERING_NODE_NAME_KEY,"1231412de213"),he(ee.HDB_SETTINGS_NAMES.HDB_ROOT_KEY,As.join(u,"envDir")),he(ee.CONFIG_PARAMS.STORAGE_PATH,As.join(u,"envDir")),he(ee.HDB_SETTINGS_NAMES.HTTP_SECURE_ENABLED_KEY,eo.isEmpty(n)?!0:n),he(ee.CONFIG_PARAMS.CUSTOMFUNCTIONS_NETWORK_HTTPS,eo.isEmpty(n)?!0:n),he(ee.HDB_SETTINGS_NAMES.SERVER_PORT_KEY,9925),he(ee.HDB_SETTINGS_NAMES.CORS_ENABLED_KEY,eo.isEmpty(i)?!1:i),he(ee.CONFIG_PARAMS.HTTP_CORS,eo.isEmpty(i)?!1:i),he(ee.HDB_SETTINGS_NAMES.MAX_CUSTOM_FUNCTION_PROCESSES,2),he(ee.HDB_SETTINGS_NAMES.MAX_HDB_PROCESSES,4),he(ee.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_PORT_KEY,9926),he(ee.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_ENABLED_KEY,!0),he(ee.HDB_SETTINGS_NAMES.CUSTOM_FUNCTIONS_DIRECTORY_KEY,As.resolve(__dirname,"../../unitTests/server/fastifyRoutes/custom_functions")),he(ee.HDB_SETTINGS_NAMES.LOCAL_STUDIO_ON,eo.isEmpty(c)?!1:c),o&&(he("CORS_ACCESSLIST",o),he(ee.CONFIG_PARAMS.HTTP_CORSACCESSLIST,o)),s&&(he(ee.HDB_SETTINGS_NAMES.SERVER_TIMEOUT_KEY,s),he(ee.CONFIG_PARAMS.HTTP_TIMEOUT,s)),t&&(he(ee.HDB_SETTINGS_NAMES.SERVER_KEEP_ALIVE_TIMEOUT_KEY,t),he(ee.CONFIG_PARAMS.HTTP_KEEPALIVETIMEOUT,t)),r&&(he(ee.HDB_SETTINGS_NAMES.SERVER_HEADERS_TIMEOUT_KEY,r),he(ee.CONFIG_PARAMS.HTTP_HEADERSTIMEOUT,r))}catch(t){let r=`Error reading in HDB environment variables from path ${rE}.  Please check your boot props and settings files`;$u.fatal(r),$u.error(t)}}a(Rse,"initTestEnvironment")});var xse=T(Wu=>{var{isMainThread:Ase,parentPort:Ku,threadId:ga}=require("worker_threads"),{Socket:Ose,createServer:Nse}=require("net"),{createServer:bse,IncomingMessage:yse}=require("http"),{createServer:Ise}=require("https"),{readFileSync:Ra}=require("fs"),Os=G(),Rt=X(),Dn=y(),{server:nE}=(hr(),Z(hi)),{WebSocketServer:wse}=require("ws"),{createServer:Cse}=require("tls"),{getTicketKeys:Lse,restartNumber:Dse}=Je(),{Headers:cH}=(Ad(),Z(VU)),{recordAction:Yu,recordActionBinary:Use}=(_n(),Z(Ic)),{Request:uH,node_request_key:VEe,createReuseportFd:iH}=(Cg(),Z(j0));if(process.env.DEV_MODE)try{require("inspector").open(9229)}catch(e){Dse<=1&&Os.trace("Could not start debugging on port 9229, you may already be debugging:",e.message)}process.on("uncaughtException",e=>{e.code!=="ECONNRESET"&&e.message!=="write EIO"&&console.error("uncaughtException",e)});var{HDB_SETTINGS_NAMES:$Ee,CONFIG_PARAMS:Mse}=Dn;Rt.initSync();var Pse=Rt.get(Mse.HTTP_SESSIONAFFINITY),Xs={};Wu.registerServer=_R;Wu.httpServer=dR;Wu.deliverSocket=lR;Wu.startServers=lH;nE.http=dR;nE.request=qse;nE.socket=Fse;nE.ws=Gse;var oR=[],aR=[],vse,to={},sE={},Bse=[],cR=[];function lH(){return Hg().loadRootComponents(!0).then(()=>{Ku?.on("message",t=>{let{port:r,fd:s,data:n}=t;if(s)lR(s,r,n);else if(t.requestId)Hse(t);else if(t.type===Dn.ITC_EVENT_TYPES.SHUTDOWN){Os.trace("received shutdown request",ga);for(let i in Xs){Os.trace("closing server",i,ga);let o=Xs[i],c;o.closeIdleConnections?.(),o.close?.(()=>{Os.trace("closed server",i,ga),clearInterval(c),setTimeout(()=>{console.log("forced close server",i,ga),o.cantCleanupProperly||Os.warn("Had to forcefully exit the thread",ga),process.exit(0)},o.cantCleanupProperly?2500:5e3).unref()}),c=setTimeout(()=>{o.closeAllConnections?.()},1500).unref()}if(process.env.DEV_MODE)try{require("inspector").close()}catch(i){console.error("Could not close debugger",i)}}}).ref();let e=[];if(iH&&!Pse)for(let t in Xs){let r=Xs[t],s;try{s=iH(+t,"::")}catch(n){console.error(`Unable to bind to port ${t}`,n);continue}e.push(new Promise((n,i)=>{r.listen({fd:s},()=>{n(),Os.trace("Listening on port "+t,ga)}).on("error",i)}))}Promise.all(e).then(()=>{Ku?.postMessage({type:Dn.ITC_EVENT_TYPES.CHILD_STARTED})})})}a(lH,"startServers");Ase||lH();function lR(e,t,r){let s=e?.read?e:new Ose({fd:e,readable:!0,writable:!0,allowHalfOpen:!0}),n=Xs[t];if(n.isSecure&&(s.startTime=performance.now()),n)typeof n=="function"?n(s):n.emit("connection",s),r&&s.emit("data",r);else{let i=a(o=>{setTimeout(()=>{let c=Xs[t];c?(typeof c=="function"?c(s):c.emit("connection",s),r&&s.emit("data",r)):o<5?i(o+1):(Os.error(`Server on port ${t} was not registered`),s.destroy())},1e3)},"retry");i(1)}return s}a(lR,"deliverSocket");var oH=new Map;function Hse(e){let{port:t,event:r,data:s,requestId:n}=e,i;switch(i=oH.get(n),r){case"connection":i=lR(void 0,t),oH.set(n,i),i.write=(c,u,_)=>(Ku.postMessage({requestId:n,event:"data",data:c.toString("latin1")}),_&&_(),!0),i.end=(c,u,_)=>(Ku.postMessage({requestId:n,event:"end",data:c?.toString("latin1")}),_&&_(),!0);let o=i.destroy;i.destroy=()=>{o.call(i),Ku.postMessage({requestId:n,event:"destroy"})};break;case"data":i._readableState.destroyed||i.emit("data",Buffer.from(s,"latin1"));break;case"drain":i._readableState.destroyed||i.emit("drain",{});break;case"end":i._readableState.destroyed||i.emit("end",{});break;case"error":i._readableState.destroyed||i.emit("error",{});break}}a(Hse,"proxyRequest");function _R(e,t){+t||(t=parseInt(Rt.get(Dn.CONFIG_PARAMS.HTTP_PORT),10));let r=Xs[t];if(r){let s=r.lastServer||r;s.off("unhandled",aH),s.on("unhandled",(n,i)=>{e.cantCleanupProperly&&(r.cantCleanupProperly=!0),e.emit("request",n,i)}),r.lastServer=e}else Xs[t]=e;e.on("unhandled",aH)}a(_R,"registerServer");function _H(e){let t=[],r=parseInt(e?.securePort);return r&&t.push({port:r,secure:!0}),r=parseInt(e?.port),r&&t.push({port:r,secure:!1}),t.length===0&&(t=[],Rt.get(Dn.CONFIG_PARAMS.HTTP_PORT)!=null&&t.push({port:Rt.get(Dn.CONFIG_PARAMS.HTTP_PORT),secure:Rt.get(Dn.CONFIG_PARAMS.CUSTOMFUNCTIONS_NETWORK_HTTPS)}),Rt.get(Dn.CONFIG_PARAMS.HTTP_SECUREPORT)!=null&&t.push({port:Rt.get(Dn.CONFIG_PARAMS.HTTP_SECUREPORT),secure:!0})),t}a(_H,"getPorts");function dR(e,t){for(let{port:r,secure:s}of _H(t))dH(r,s,t?.isOperationsServer),typeof e=="function"?cR[t?.runFirst?"unshift":"push"]({listener:e,port:t?.port||r}):_R(e,r),sE[r]=uR(cR,r),vse=uR(Bse,r)}a(dR,"httpServer");function dH(e,t,r){if(!to[e]){let s=r?"operationsApi_network":"http",n={keepAliveTimeout:Rt.get(s+"_keepAliveTimeout"),headersTimeout:Rt.get(s+"_headersTimeout"),requestTimeout:Rt.get(s+"_timeout")};if(t){s=r?"operationsApi_":"";let i=Rt.get(s+"tls_privateKey"),o=Rt.get(s+"tls_certificate"),c=Rt.get(s+"tls_certificateAuthority");Object.assign(n,{key:Ra(i),cert:Ra(o)+(c?`

`+Ra(c):""),ticketKeys:Lse()})}to[e]=(t?Ise:bse)(n,async(i,o)=>{try{let u=performance.now(),_=new uH(i,o);r&&(_.isOperationsServer=!0);let l=await sE[e](_);if(!l){if(_._nodeResponse.statusCode)return;l=fH(_)}if(l.headers?.set?.("Server","HarperDB"),l.status===-1){for(let b of l.headers||[])o.setHeader(b[0],b[1]);return i.baseRequest=_,o.baseResponse=l,to[e].emit("unhandled",i,o)}let d=l.status||200,f=performance.now(),E=f-u,h=l.body,S;if(!l.handlesHeaders){let b=l.headers||new cH;if(h?h.length>=0&&(typeof h=="string"?b.set("Content-Length",Buffer.byteLength(h)):b.set("Content-Length",h.length),S=!0):(b.set("Content-Length","0"),S=!0),b.append){let O=`hdb;dur=${E.toFixed(2)}`;l.wasCacheMiss&&(O+=", miss"),b.append("Server-Timing",O,!0)}o.writeHead(d,b&&(b[Symbol.iterator]?Array.from(b):b)),S&&o.end(h)}let p=_.handlerPath,g=_.method;if(Yu(E,"duration",p,g,l.wasCacheMiss==null?void 0:l.wasCacheMiss?"cache-miss":"cache-hit"),Use(d<400,"success",p,g),!S)if(h?.pipe){h.pipe(o),h.destroy&&o.on("close",()=>{h.destroy()});let b=0;h.on("data",O=>{b+=O.length}),h.on("end",()=>{Yu(performance.now()-f,"transfer",p,g),Yu(b,"bytes-sent",p,g)})}else h?.then?h.then(b=>{o.end(b)},c):o.end(h)}catch(u){c(u)}function c(u){o.writeHead(u.statusCode||500),o.end(u.toString()),u.statusCode?u.statusCode===500?Os.warn(u):Os.info(u):Os.error(u)}a(c,"onError")}),t&&(to[e].on("secureConnection",i=>{i._parent.startTime&&Yu(performance.now()-i._parent.startTime,"tls-handshake",e),Yu(i.isSessionReused(),"tls-reused",e)}),to[e].isSecure=!0),_R(to[e],e)}return to[e]}a(dH,"getHTTPServer");function uR(e,t){let r=fH;for(let s=e.length;s>0;){let{listener:n,port:i}=e[--s];if(i===t||i==="all"){let o=r;r=a(c=>n(c,o),"next_callback")}}return r}a(uR,"makeCallbackChain");function fH(e){return e.user&&(e._nodeRequest.user=e.user),{status:-1,body:"Not found",headers:new cH}}a(fH,"unhandled");function qse(e,t){dR(e,{requestOnly:!0,...t})}a(qse,"onRequest");function Fse(e,t){if(t.securePort){let r=Rt.get("tls_privateKey"),s=Rt.get("tls_certificate"),n=Rt.get("tls_certificateAuthority"),i=Cse({key:Ra(r),cert:Ra(s)+(n?`

`+Ra(n):"")},e);Xs[t.securePort]=i}if(t.port){let r=Nse(e);Xs[t.port]=r}}a(Fse,"onSocket");Object.defineProperty(yse.prototype,"upgrade",{get(){return"connection"in this.headers&&"upgrade"in this.headers&&this.headers.connection.startsWith("Upgrade")&&this.headers.upgrade.toLowerCase()=="websocket"},set(e){}});function Gse(e,t){for(let{port:r,secure:s}of _H(t)){aR[r]||(aR[r]=new wse({server:dH(r,s)}),aR[r].on("connection",async(i,o)=>{try{let c=new uH(o);c.isWebSocket=!0;let u=sE[r](c),_=o.headers["sec-websocket-protocol"]||"";for(let l=0;l<oR.length;l++){let d=oR[l];if(d.protocol){if(d.protocol===_){d.listener(i,c,u);break}}else d.listener(i,c,u)}}catch(c){Os.warn("Error handling WebSocket connection",c)}}));let n=t?.subProtocol||"";oR.push({listener:e,protocol:n}),sE[r]=uR(cR,r)}}a(Gse,"onWebSocket");function aH(e,t){t.writeHead(404),t.end(`Not found
`)}a(aH,"defaultNotFound")});module.exports=xse();
